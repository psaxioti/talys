      subroutine ecis03t(ecisinp,ecisout,ecis03cs,ecis03in,ecis03tr,    ak000000
     +  ecis03ang,ecis03leg)                                            ak000000
c 29/02/04                                                      ecis03  ecis-000
c use character*4 if the type of argument is controlled by compiler     ecis-001
c the fujitsu compiler gives an "information" diagnostic for the        ecis-002
c equivalence statement mixing character type with other types.         ecis-003
      parameter (idmx=3000000)                                          ecis-004
      dimension nw(2,idmx)                                              ecis-005
      character*4 cw(2,idmx)                                            ecis-006
      character*13 ecisinp,ecisout,ecis03cs,ecis03in,ecis03tr,          ak000000
     +  ecis03ang,ecis03leg                                             ak000000
      real*8 dw(idmx)                                                   ecis-007
      equivalence (dw,nw,cw,w)                                          ecis-008
      common dw                                                         ecis-009
c the common /inout/ allows to change the input file "mr", the output   ecis-010
c file "mw" and save file "ms" without modification of the subroutines. ecis-011
c inpa, inpb and inpc write still write "description of input" on file  ecis-012
c 6. theses values are not saved on tape ms.                            ecis-013
      common /inout/ mr,mw,ms                                           ecis-014
      mr=1                                                              ecis-015
      mw=2                                                              ecis-016
      ms=8                                                              ecis-017
      open(unit=1,status='unknown',file=ecisinp)                        ak000000
      open(unit=2,status='unknown',file=ecisout)                        ak000000
      if (ecis03cs.ne.'null         ')                                  ak000000
     +  open(unit=58,status='unknown',file=ecis03cs)                    ak000000
      if (ecis03in.ne.'null         ')                                  ak000000
     +  open(unit=59,status='unknown',file=ecis03in)                    ak000000
      if (ecis03tr.ne.'null         ')                                  ak000000
     +  open(unit=63,status='unknown',file=ecis03tr)                    ak000000
      if (ecis03ang.ne.'null         ')                                 ak000000
     +  open(unit=66,status='unknown',file=ecis03ang)                   ak000000
      if (ecis03leg.ne.'null         ')                                 ak000000
     +  open(unit=65,status='unknown',file=ecis03leg)                   ak000000
      call calc(nw,cw,dw,idmx)                                          ecis-018
      close (unit=1)                                                    ak000000
      close (unit=2)                                                    ak000000
      if (ecis03cs.ne.'null         ') close (unit=58)                  ak000000
      if (ecis03in.ne.'null         ') close (unit=59)                  ak000000
      if (ecis03tr.ne.'null         ') close (unit=63)                  ak000000
      if (ecis03ang.ne.'null         ') close (unit=66)                 ak000000
      if (ecis03leg.ne.'null         ') close (unit=65)                 ak000000
      return                                                            ak000000
      stop                                                              ecis-019
      end                                                               ecis-020
c 12/04/04                                                      ecis03  hora-000
      subroutine hora                                                   hora-001
c gives the time elapsed since the first call and since the last call   hora-002
c it uses a function which returns in milliseconds the time left for a  hora-003
c run of "msec" seconds (default value 3600).                           hora-004
c***********************************************************************hora-005
      common /inout/ mr,mw,ms                                           hora-006
      data nx,m0,m2 /0,0,0/                                             hora-007
      save  nx,m0,m2                                                    hora-008
      if (nx.ne.0) go to 1                                              hora-009
      call stim(m0)                                                     hora-010
      m2=m0                                                             hora-011
      nx=1                                                              hora-012
      write (mw,1000) m0                                                hora-013
      return                                                            hora-014
    1 call stim(m1)                                                     hora-015
      n5=m2-m1                                                          hora-016
      nt=m0-m1                                                          hora-017
      m2=m1                                                             hora-018
      ns=nt/1000                                                        hora-019
      nt=nt-1000*ns                                                     hora-020
      nm=ns/60                                                          hora-021
      ns=ns-60*nm                                                       hora-022
      nh=nm/60                                                          hora-023
      nm=nm-60*nh                                                       hora-024
      write (mw,1001) nh,nm,ns,nt,n5                                    hora-025
      return                                                            hora-026
 1000 format (' first call to hora',10x,i10,' milliseconds')            hora-027
 1001 format (' *** total time ***',i3,'h',i3,'mn',i3,'s',i4,' ms',10x,'hora-028
     1difference since last call',i9,' milliseconds')                   hora-029
      end                                                               hora-030
c 29/02/04                                                      ecis03  stim-000
      subroutine stim(i)                                                stim-001
c returns integer value of cpu time left for a job of "msec" seconds    stim-002
c in milliseconds.                                                      stim-003
c***********************************************************************stim-004
      common /cnsec/ msec                                               stim-005
      dimension a(2)                                                    stim-006
      b=etime(a)                                                        stim-007
      i=int(1000.*(float(msec)-b))                                      stim-008
      return                                                            stim-009
      end                                                               stim-010
c 29/02/04                                                      ecis03  memo-000
      subroutine memo(name,idmt,nplace,ix)                              memo-001
c control of memory array                                               memo-002
c input:   name     name of calling subroutine                          memo-003
c          idmt     previous space                                      memo-004
c          nplace   requested space                                     memo-005
c ix: control number ix=1     absolute values of idmt and nplace        memo-006
c                    ix=2     relative values of idmt and nplace        memo-007
c***********************************************************************memo-008
      character*4 name                                                  memo-009
      common /inout/ mr,mw,ms                                           memo-010
      if (idmt.ge.nplace) return                                        memo-011
      if (ix.ne.1) go to 1                                              memo-012
      write (mw,1000) idmt,nplace                                       memo-013
      go to 2                                                           memo-014
    1 if (ix.ne.2) write (mw,1001) ix                                   memo-015
      i=nplace-idmt                                                     memo-016
      write (mw,1002) i                                                 memo-017
    2 write (mw,1003) name                                              memo-018
      stop                                                              memo-019
 1000 format (' not enough place .....   ',i10,' memories allowed',i10,'memo-020
     1 memories requested'/)                                            memo-021
 1001 format (' ix = ',i4,' not allowed. using ix=2'//)                 memo-022
 1002 format (' working space too small':,i6,' memories missing'/)      memo-023
 1003 format (' in ',a4,'  ... stop ...')                               memo-024
      end                                                               memo-025
c 12/04/04                                                      ecis03  calc-000
      subroutine calc(nw,cw,dw,idmx)                                    calc-001
c main subroutine of the program                                        calc-002
c w,nw,dw are the working space in equivalence by call,starting as      calc-003
c real*8. they are respectively real, integer and double precision.     calc-004
c idmx is the length of dw.                                             calc-005
c                                                                       calc-006
c addresses in the working field defined here (for others, see calx)    calc-007
c in common /decou/                                                     calc-008
c 34- nt       here, also reduced nuclear matrix elements               calc-009
c 35- nivq     table of multipoles                                      calc-010
c 36- nivy     table of form factor identification ivy (for computation)calc-011
c 37- nivz     table of form factor identification ivz (for use)        calc-012
c 38- ncoi     address of the table for discretisation of continuum     calc-013
c 39- mipi     same as nipi for the discretisation of continuum         calc-014
c 40- nxd      address of weights and steps of continuum                calc-015
c 41- mwv      same as nwv for the discretisation of continuum          calc-016
c 42- nixt     transmission coefficients of uncoupled states            calc-017
c 43- nty      temporary results of compound nucleus for interpolation  calc-018
c 44- ntx      partial reaction cross sections and compound nucleus     calc-019
c 45- nry      compound nucleus coefficients                            calc-020
c 46- nrco     strength of coulomb central potentials for corrections   calc-021
c 47- nrdo     strength of coulomb transition potentials for correctionscalc-022
c 48- nvc1     real potentials                                          calc-023
c 49- nvc2     imaginary potentials                                     calc-024
c 50- nnc      first free address after computation of potentials       calc-025
c 51- ncx      first free address for computation of potentials         calc-026
c other integer data of common /decou/                                  calc-027
c 52- idmt     total working field length as single precision           calc-028
c 53-98          see calx                                               calc-029
c 99- kxt      number of penetrabilities for uncoupled states           calc-030
c100- nrz      number of results to save for minimum chi2               calc-031
c101- ntz      number of memories to initialise to zero for scattering  calc-032
c              matrix and compound nucleus results                      calc-033
c102- lmax3    effective number of coulomb functions                    calc-034
c103- ipm      number pf j values used for scattering matrix (in cal1)  calc-035
c105- ipk      number pf j values used for compound nucleus (in cal1)   calc-036
c106-111         see calx                                               calc-037
c                                                                       calc-038
c in common /titr/   title:        comment card reproduced in the outputcalc-039
c in common /dchi/   chi2,chi2m:   chi-square and minimum chi-square    calc-040
c                    yy(3):        indications for search   see fite    calc-041
c in common /dcons/  cm,chb:       nuclear mass and h bar               calc-042
c                    ck,cmb,ccz:   derived constants                    calc-043
c for commons /pote1/ and /pote2/ see redm                              calc-044
c for common /ncomp/ see calx, lect and colf                            calc-045
c                                                                       calc-046
c ******** meaning of the logical controls lo ********                  calc-047
c                                                                       calc-048
c lo(i+100)=.not.lo(i) for i=1,100                                      calc-049
c lo(235+i)=lo(50+i) for i=1,15 during search if lo(51) to lo(65) are   calc-050
c used only for complete output                                         calc-051
c the values of the first 100 lo are read in calx on two data cards     calc-052
c the first data card is for 1-50,the second for 51-100                 calc-053
c only,the values listed on the input description are used              calc-054
c *** for their meaning, see this description *****                     calc-055
c exception if lo(36)=.true.: only the first card is read, the program  calc-056
c does not take them into account but continue a search saved on tape nscalc-057
c *** meaning of lo(i) for i greater than 200 ****                      calc-058
c lo(201) is true if there is no real spin-orbit potential              calc-059
c lo(202) is true if there is no imaginary spin-orbit potential         calc-060
c lo(203) is true if there is no coulomb spin-orbit potential           calc-061
c lo(204) is true if convergence is obtained in the iteration           calc-062
c lo(205) is true if convergence is obtained for this equation          calc-063
c lo(206) is true when the iteration is not the last one permitted      calc-064
c lo(207) is true if all the couplings have to be calculated beforehand calc-065
c lo(208) is true if the diagonal coulomb corrections are needed        calc-066
c lo(209) is true for dirac potentials                                  calc-067
c lo(210) is true if derivatives are needed                             calc-068
c lo(211) is true if nuclear parameters are changed in search           calc-069
c lo(212) is true if sp.-orb. or comp. nucl. param. is changed in searchcalc-070
c lo(213) is true if dispersion relation is changed in search           calc-071
c lo(215) is true if it is the first computation for this energy        calc-072
c lo(216) is true for no output                                         calc-073
c lo(217) is true for all the calculations except the first             calc-074
c lo(218) is true for last results                                      calc-075
c lo(219) is true for results without doing the calculation again       calc-076
c lo(220) is true for output and last calculation is the best one       calc-077
c lo(221) is true for optical model without coupling                    calc-078
c lo(222) is not used                                                   calc-079
c lo(223) is true if lo(18) is .true. and no spin in the initial state  calc-080
c lo(224) is true for compound nucleus or punch of transmission coeff.  calc-081
c lo(225) is true in cal1 for a call to usual coupled equations subr.   calc-082
c lo(226) is true if there are observables in the laboratory system     calc-083
c lo(227) is true for coulomb corrections with pure regular functions   calc-084
c lo(228) is true for no copy of uncoupled functions and phase-shift    calc-085
c lo(229) is true for real spin-orbit or dirac equation                 calc-086
c lo(230) is true for imaginary spin-orbit or dirac equation            calc-087
c lo(231) is true if lo(18)=.true. with non zero spins for ground state calc-088
c lo(232) is true if the total spin is too large to compute comp. nuc.  calc-089
c lo(233) is true store fiss. and gamma trans. coeff. for interpolation calc-090
c lo(234) is free                                                       calc-091
c lo(235) is free                                                       calc-092
c lo(211) to lo(220) are initialised to .false. in calx                 calc-093
c lo(216) to lo(220) are initialised to .false. in eval                 calc-094
c***********************************************************************calc-095
      implicit real*8 (a-h,o-z)                                         calc-096
      logical lo(250)                                                   calc-097
      dimension nw(2,idmx),dw(idmx)                                     calc-098
      character*4 fin,title,cw(2*idmx)                                  calc-099
      common /decou/ njit,nipp,npaa,nwv,niph,nscn,npar,nniv,nfis,ngam,npcalc-100
     1ot,nbeta,nfm,ntgx,ndonn,nrc,niw,nde,nise,nnvi,nnwi,ncc,mcc,nxa,namcalc-101
     21,nfac,nfam,npad,nfg,nxg,nsm,nres,nxx,nt,nivq,nivy,nivz,ncoi,mipi,calc-102
     3nxd,mwv,nixt,nty,ntx,nry,nrco,nrdo,nvc1,nvc2,nnc,ncx,idmt,ncoll,njcalc-103
     4max,iterm,npp,jdm,jit,nsec,lmd,mcm(2),ncols,ncolt,kmax,kmin,nva,nbcalc-104
     5et,nbt1,lmx,lmax1,nlt,ism,iqm,iqmax,ms1,ms2,nct(6),kba,kab,kbc,kcccalc-105
     6,njc,jtx,jth,ncolr,nrec,ntot,nfa,lmax2,ke,itemm,nplace,kxt,nrz,ntzcalc-106
     7,lmax3,ipm,ipk,bjm,eiter,aconv,conj,h,nspin                       calc-107
      common /titr/ title(18)                                           calc-108
      common /dchi/ chi2,chi2m,yy(3)                                    calc-109
      common /dcons/ cm,ck,chb,cmb,ccz                                  calc-110
      common /pote1/ itx(16),imax,intc,inls,invc,invd,itxm              calc-111
      common /pote2/ ity(8),invt,intv,insl,npx                          calc-112
      common /ncomp/ nsp(3),nfiss,nrd,ncont,ncoj,ncons,nie,ncolx,ndp,ndqcalc-113
     1,acn(20)                                                          calc-114
      common /inout/ mr,mw,ms                                           calc-115
      data fin /'fin '/                                                 calc-116
      idmt=idmx                                                         calc-117
c constants computed from the fundamental constants, atomic mass, hbar*ccalc-118
c and alpha, as given in the european physical journal, page 73, volume calc-119
c 15 (2000) referring for these values to the 1998 codata set which may calc-120
c be found at http://physics.nist.gov/constants                         calc-121
c     cm=931.494013 +/- 0.000037 mev                                    calc-122
      cm=931.494013d0                                                   calc-123
c     chb=197.3269601 +/- 0.0000078 (*1.0e-9 ev*cm)                     calc-124
      chb=197.3269601d0                                                 calc-125
c     cz=137.03599976 +/- 0.00000050 without dimension                  calc-126
      cz=137.03599976d0                                                 calc-127
      cmb=cm/chb                                                        calc-128
      ck=2.d0*cm/chb**2                                                 calc-129
      ccz=chb/cz                                                        calc-130
c main input                                                            calc-131
    1 chi2m=1.d35                                                       calc-132
      icheck=0                                                          ak000000
      call calx(nw,cw,dw,lo)                                            calc-133
      if (icheck.eq.1) return                                           ak000000
      if (title(1).eq.fin) return                                       calc-134
      nsp1d=nsp(1)                                                      calc-135
      if (lo(36)) go to 17                                              calc-136
    2 nsp(1)=nsp1d                                                      calc-137
      nsp(3)=nsp(1)-nsp(2)                                              calc-138
      call colf(ncolx,ncoll,nw,dw(nwv),dw(nfg),dw(nxg),ism,lmax1,lmax2,hcalc-139
     1,nw(1,nt),dw(nt),idmt-nt,lmax3,nw(1,nniv),kxt,lo)                 calc-140
c computation of nuclear matrix elements and space for form factors     calc-141
    3 if (lo(61)) write (61,1000) dw(nwv),dw(nwv+11),dw(nwv+1),nw(2,2),ncalc-142
     1coll                                                              calc-143
      call redm(nw(1,nniv),nw(1,nt),dw(nt),nw,ncoll,it,nw(1,nbeta),dw(nbcalc-144
     1eta),nbt1,nw(1,niph),nw(1,npar),dw(npaa),nva,iqmax,nspin,dw(nfac),calc-145
     2nfa,npp,im,idmt-nt,lo)                                            calc-146
      nivq=nt+3*it                                                      calc-147
      nivy=nivq+(3*im+1)/2                                              calc-148
      nivz=nivy+(7*intc+1)/2                                            calc-149
      ncoi=nivz+2*intv                                                  calc-150
      if (lo(107).or.lo(217)) go to 6                                   calc-151
      npot=ncoi                                                         calc-152
      call extp(npp,ncols,ncolx,dw(nwv),nw(1,nniv),nw(1,nt),nw(1,nivy),ncalc-153
     1w(1,nivq),nw,dw(nfac),nfa,dw(npot),nw(1,npot),nw(1,npot+2),nw(1,nicalc-154
     2pp),dw(nipp),idmt-npot,lo)                                        calc-155
c permutation of potentials and informations on transitions             calc-156
      n=npot-nt                                                         calc-157
      m=npot+nw(2,npot+1)                                               calc-158
      if (n+m.gt.idmt) call memo('calc',idmt,n+m,1)                     calc-159
      nn=2*n                                                            calc-160
      n1=2*nt-2                                                         calc-161
      n2=2*m-2                                                          calc-162
      do 4 i=1,nn                                                       calc-163
    4 cw(n2+i)=cw(n1+i)                                                 calc-164
      nn=nn+2*nw(2,npot+1)                                              calc-165
      n2=n2-2*nw(2,npot+1)                                              calc-166
      do 5 i=1,nn                                                       calc-167
    5 cw(n1+i)=cw(n2+i)                                                 calc-168
      npot=nt                                                           calc-169
      nt=npot+nw(2,npot+1)                                              calc-170
      nivq=nt+3*it                                                      calc-171
      nivy=nivq+(3*im+1)/2                                              calc-172
      nivz=nivy+(7*intc+1)/2                                            calc-173
    6 ncoi=nivz+2*intv                                                  calc-174
      mipi=ncoi+2*ncont                                                 calc-175
      nxd=mipi                                                          calc-176
      mwv=nxd                                                           calc-177
      nie=0                                                             calc-178
      nixt=mwv+18*nie                                                   calc-179
    7 call disp(nw,dw(nwv),nw(1,nipp),dw(nipp),nw(1,npot),dw(npot),ncolxcalc-180
     1-ncont,lo)                                                        calc-181
      if (ncont.eq.0) go to 10                                          calc-182
      if (.not.(lo(214).or.lo(215))) go to 9                            calc-183
      call conu(0,nw,dw(nwv),nw(1,mipi),dw(mwv),nw(1,ncoi),dw(nxd),dw(nscalc-184
     1cn),kxt,lo)                                                       calc-185
      nxd=mipi+(11*nie+1)/2                                             calc-186
      mwv=nxd+3*nie                                                     calc-187
      nixt=mwv+18*nie                                                   calc-188
      if (nixt.gt.idmt) call memo('calc',idmt,nixt,1)                   calc-189
      ncolt=ncolx+nie-ncont                                             calc-190
      nsp(1)=nsp(1)+ncolt-ncolx                                         calc-191
      nsp(3)=nsp(3)+ncolt-ncolx                                         calc-192
    8 call conu(1,nw,dw(nwv),nw(1,mipi),dw(mwv),nw(1,ncoi),dw(nxd),dw(nscalc-193
     1cn),kxt,lo)                                                       calc-194
    9 call disp(nw(1,mipi),dw(mwv),nw(1,nipp),dw(nipp),nw(1,npot),dw(npocalc-195
     1t),nie,lo)                                                        calc-196
   10 ndp=2*ncoll+nsp(1)+1                                              calc-197
      ndq=kba+nsp(3)-nsp(1)                                             calc-198
      nty=nixt+kxt                                                      calc-199
      nsm=nty                                                           calc-200
      if (lo(81).and.lo(233)) nsm=nsm+kmax*(kcc+2+ncolt-ncols)          calc-201
      ntx=nsm+2*njmax*kba                                               calc-202
      nry=ntx+ncols+1                                                   calc-203
      if (lo(81)) nry=ntx+ncoll+ncolt+3                                 calc-204
      nrco=nry                                                          calc-205
      if (lo(81)) nrco=nrco+kmax*ncols                                  calc-206
      nrz=nrco-nsm                                                      calc-207
      ntz=nrco-nty                                                      calc-208
      if (lo(32)) nrco=2*nrco-nsm                                       calc-209
      nrdo=nrco+2*npx                                                   calc-210
      if (lo(100)) nrdo=nrco+2*ncolt                                    calc-211
      nvc1=nrdo+2*intv                                                  calc-212
      nvc2=nvc1+ity(2)*ism                                              calc-213
      nnc=nvc1+itx(1)*ism                                               calc-214
      if (lo(100)) nnc=nvc1+itx(7)*ism                                  calc-215
      ncx=nvc1+itxm*ism                                                 calc-216
      nplace=max0(nplace,ncx,nnc+((nrec+1)*(2*ntot+2+nrec)/2+1)/2)      calc-217
   11 call ggdr(nw,dw(nwv),dw(nscn),lo)                                 calc-218
      if (lo(213)) go to 12                                             calc-219
      if (lo(54)) write (mw,1001) nplace                                calc-220
      if (nplace.gt.idmt) call memo('calc',idmt,nplace,1)               calc-221
      call stim(k1)                                                     calc-222
c main computation                                                      calc-223
   12 call cal1(nw,cw,dw,lo)                                            calc-224
      if (lo(177)) call hora                                            calc-225
      if (lo(218).or.lo(132)) go to 18                                  calc-226
c automatic search                                                      calc-227
      call stim(k2)                                                     calc-228
      if (lo(34)) nw(2,niw)=-1+nw(1,niw+1)+(k1-10*nsec)/(k1-k2)         calc-229
      k1=k2                                                             calc-230
      if (nw(1,niw+1).gt.1.or.lo(76).or.lo(75)) go to 14                calc-231
c change of controls if full output was not requested at the first run  calc-232
      do 13 i=51,58                                                     calc-233
      lo(i+185)=lo(i)                                                   calc-234
      lo(i)=.false.                                                     calc-235
   13 lo(i+100)=.true.                                                  calc-236
      lo(216)=.true.                                                    calc-237
c identification of variables                                           calc-238
   14 call vari(1,nw,dw,lo)                                             calc-239
c save the search on tape ns.                                           calc-240
      if (lo(35).and.nw(1,niw+1).ge.nw(2,niw)) call rest(0,nw,dw,lo,idmtcalc-241
     1)                                                                 calc-242
c handling of variables                                                 calc-243
   15 call fite(ke,ntot,nrec,dw(nres),dw(nxx),dw(nde),dw(nrc),nw(1,nrc),calc-244
     1nw(1,niw),dw(nnc))                                                calc-245
c transformation of variables into parameters                           calc-246
   16 call vari(0,nw,dw,lo)                                             calc-247
      if (ke.eq.1) go to 19                                             calc-248
      lo(211)=lo(52).or.lo(61).or.lo(211)                               calc-249
      lo(212)=lo(212).or.lo(10)                                         calc-250
      go to 19                                                          calc-251
c continuation of a previous search                                     calc-252
   17 call rest(1,nw,dw,lo,idmt)                                        calc-253
      if (lo(177)) call hora                                            calc-254
      call stim(k1)                                                     calc-255
      if ((ke.ne.1).and.(nw(1,niw+1).ne.1)) go to 16                    calc-256
      go to 15                                                          calc-257
   18 n=idmt-nplace                                                     calc-258
      write (mw,1002) nplace,n                                          calc-259
      if (lo(35).and.lo(32).and.(ke.eq.0)) call rest(0,nw,dw,lo,idmt)   calc-260
      if (lo(137)) go to 1                                              calc-261
      call eval(nw,dw,cm,lo)                                            calc-262
      ke=0                                                              calc-263
      if (lo(215)) go to 2                                              calc-264
   19 if (lo(211)) go to 3                                              calc-265
      if (lo(213)) go to 7                                              calc-266
      if (lo(214)) go to 8                                              calc-267
      if (lo(212)) go to 11                                             calc-268
      go to 12                                                          calc-269
 1000 format ('<red.mat.>',f10.2,f10.5,f10.2,2i5)                       calc-270
 1001 format (10x,'required working field',i10)                         calc-271
 1002 format (//' *** workspace used in this computation',i10,'  ***',  calc-272
     110x,i10,18h memories not used)                                    calc-273
      end                                                               calc-274
c 29/02/04                                                      ecis03  calx-000
      subroutine calx(nw,cw,dw,lo)                                      calx-001
c calx and the subroutines called by it read all the input except for   calx-002
c reduced nuclear matrix elements and external form factors.            calx-003
c nw,cw,dw are the working field in equivalence by call.                calx-004
c lo is the table of logical controls (see calc) .                      calx-005
c                                                                       calx-006
c use of some parts of the working array (w,nw,dw):                     calx-007
c  1:   ipi(11,ncolx) integer values for the description of channels.   calx-008
c           first index:                                                calx-009
c       1 - parity (0 for + and 1 for -)                                calx-010
c       2 - multiplicity of incident particle                           calx-011
c       3 - multiplicity of the target                                  calx-012
c       4 - product of charges                                          calx-013
c       5 - index of potential                                          calx-014
c       6,7,8,9 - beginning and end in the two parts of table mf-fm     calx-015
c                           (see deph)                                  calx-016
c      10 - maximum angular momentum                                    calx-017
c      11 - index of potential energy dependent by dispersion relations calx-018
c  nipp:    ipp(2,15,npp)/pip(15,npp) dispersion parameters             calx-019
c     1,1 - first level using this potential before input of parameters calx-020
c           replaced by address of reference energy in wv (3 or 12)     calx-021
c     2,1 - n2 - power for large negative energy corrections            calx-022
c     1,2 - nv - |nv| power for volume potential                        calx-023
c     2,2 - ns - |ns| power for surface potential                       calx-024
c             sum of two terms if nv or ns are negative                 calx-025
c             absence of volume or surface term if nv or ns are 0.      calx-026
c       3 - energy corresponding to the depths read                     calx-027
c       4 - fermi energy ef                                             calx-028
c       5 - threshold energy ep                                         calx-029
c       6 - large energy starting value above fermi energy ea           calx-030
c       7 - exponential variation of real spin-orbit                    calx-031
c       8 - linear variation of imaginary spin-orbit                    calx-032
c       9 - bv parameter for volume potentials                          calx-033
c      10 - strength of large positive energy term in volume potential  calx-034
c           second bv' parameter for volume potentials if nv<0          calx-035
c      11 - exponential decrease in sqrt|e| for large energy terms of   calx-036
c           volume potentials or fraction in the first term if nv<0     calx-037
c      12 - bs parameter for surface potentials                         calx-038
c      13 - exponential decrease of a surface potential or second bs'   calx-039
c           parameter for surface potentials if ns<0                    calx-040
c      14 - non-locality range parameter of surface potential or        calx-041
c           fraction in the first term if ns<0                          calx-042
c      15 - exponential variation of h.f. real volume potential         calx-043
c  nwv:     wv(18,ncolx) ibm-double precision values for the channels   calx-044
c       1 - mass of incident particle                                   calx-045
c       2 - mass of the target                                          calx-046
c       3 - energy in the center of mass in mev                         calx-047
c       4 - k wave number                                               calx-048
c       5 - coulomb parameter                                           calx-049
c       6 - square root of kf/ki (modified by ratio of step sizes)      calx-050
c       7 - energy in the center of mass in mev ( for dirac equation )  calx-051
c       8 - square root of ratio to reduced units                       calx-052
c       9 - k wave number multiplied by ratio of step sizes             calx-053
c      10 - reduced energy term                                         calx-054
c      11 - step size for this level                                    calx-055
c      12 - energy in the laboratory system in mev                      calx-056
c      13,14,15,16,17,18 - dispersion corrections (see disp)            calx-057
c                                                                       calx-058
c addresses in the working field defined here ( common /decou/ )        calx-059
c  3- nipi=1   integer values for the channel description (see above)   calx-060
c  5- niph     number of phonons for the harmonic vibrational model     calx-061
c  1- njit     data for interpolation on total spin (limit/step)        calx-062
c  4- nwv      ibm-double precision values for the channels (see above) calx-063
c  2- nipp     dispersion parameters (see above)                        calx-064
c  7- npar     indications for nuclear parameters                       calx-065
c  3- npaa     values of nuclear parameters                             calx-066
c  6- nscn     level density description                                calx-067
c  8- nniv     addresses of reduced nuclear matrix elements and coulomb calx-068
c              integrals in niv(ncoll,ncoll,3)                          calx-069
c  9- nfis     fission data for compound nucleus                        calx-070
c 10- ngam     gamma data for compound nucleus                          calx-071
c 11- npot     optical potential parameters                             calx-072
c 12- nbeta    deformation parameters                                   calx-073
c 13- nfm      helicities and observables (see deph,lecd and obse)      calx-074
c 14- ntgx     beginning of chi2 and normalisation of data              calx-075
c 15- ndonn    experimental data                                        calx-076
c 16- nrc      permanent working field for the search                   calx-077
c 17- niw      integer working field for the search                     calx-078
c 18- nde      search accuracies                                        calx-079
c 19- nise     indexes of the variable parameters                       calx-080
c 20- nnvi     table of addresses of coupling coefficients              calx-081
c 21- nnwi     same as nnvi for symmetrised equations                   calx-082
c 22- ncc      table of energies, l*(l+1) and l*s  (see quan)           calx-083
c 23- mcc      same as ncc for symmetrised equations                    calx-084
c 24- nxa      table of coefficients of symmetrisation                  calx-085
c 25- nam1     computation of observables (see obse)                    calx-086
c 26- nfac     table of log of factorials for geometric coefficients    calx-087
c 27- nfam     matching values (see mtch)                               calx-088
c 28- npad     pade approximants                                        calx-089
c 29- nfg      coulomb functions and finite integrals                   calx-090
c 30- nxg      coulomb phases and infinite integrals                    calx-091
c 31- nsm      standard and helicity scattering matrix elements         calx-092
c 32- nres     functions for the search                                 calx-093
c 33- nxx      variables for the search                                 calx-094
c 34- nt       first free address                                       calx-095
c 35-52          see calc                                               calx-096
c other integer data of common /decou/                                  calx-097
c 53- ncoll    number of coupled channels                               calx-098
c 54- njmax    maximum number of j-values                               calx-099
c 55- iterm    maximum number of iterations                             calx-100
c 56- npp      number of optical potentials                             calx-101
c 57- jdm      minimum number of total spin                             calx-102
c 58- jit      number of rates of interpolation on total spin           calx-103
c 59- nsec     maximum number of seconds for a job                      calx-104
c 60- lmd      dimension of a table of coefficients: 2 but 3 for dirac  calx-105
c 61- mcm(1)   maximum angular momentum for central coulomb corrections calx-106
c 62- mcm(2)   maximum angular momentum for spin-orbit coulomb correct. calx-107
c 63- ncols    number of channels with angular distributions            calx-108
c 64- ncolt    number of channels including uncoupled states            calx-109
c 65- kmax     maximum number of j values for compound nucleus          calx-110
c 66- kmin     minimum number of j values for compound nucleus          calx-111
c 67- nva      number of nuclear parameters                             calx-112
c 68- nbet     number of different deformations (vibrations+rotations)  calx-113
c 69- nbt1     number of phonons (vibrations)                           calx-114
c 70- lmx      difference between number of j-values and of coul. funct.calx-115
c 71- lmax1    number of l-values for coulomb functions                 calx-116
c 72- nlt      memories needed for legendre polynomials                 calx-117
c 73- ism      number of integration steps                              calx-118
c 74- iqm      maximum l-value of deformation in rotational model       calx-119
c 75- iqmax    maximum l-expansion in rotational model                  calx-120
c 76- ms1      largest particle multiplicity                            calx-121
c 77- ms2      largest target multiplicity                              calx-122
c 78- nct(6)   number of equations for each parity in 1 and 2           calx-123
c              number of solutions for each parity in 3 and 4           calx-124
c              number of comp. nucl. coeff. for each parity in 5 and 6  calx-125
c 84- kba      number of independent amplitudes without uncoupled statescalx-126
c 85- kab      maximum number of equations                              calx-127
c 86- kbc      maximum number of solutions                              calx-128
c 87- kcc      number of independent amplitudes with uncoupled states   calx-129
c 88- njc      maximum number of observables at equidistant angles      calx-130
c 89- jtx      maximum number of calculated values for a plot           calx-131
c 90- jth      maximum number of angles for a plot                      calx-132
c 91- ncolr    number of experimental angular distributions             calx-133
c 92- nrec     number of variables in search                            calx-134
c 93- ntot     number of experimental data                              calx-135
c 94- nfa      number of logarithms of factorials                       calx-136
c 95- lmax2    number of l values for coulomb phases                    calx-137
c 96- ke       control of search (see fite)                             calx-138
c 97- itemm    maximum number of iterations at the beginning of a run   calx-139
c 98- nplace   maximum working field used                               calx-140
c 99-104          see calc                                              calx-141
c other non integer data of common /decou/                              calx-142
c105- h        step size for integration                                calx-143
c106- bjm      convergence coefficient of imaginary potential           calx-144
c107- eiter    convergence criterion for s-matrix                       calx-145
c108- aconv    convergence criterion for potential and function         calx-146
c109- conj     convergence criterion for the scattering amplitudes      calx-147
c110- nspin    twice the k-value of the rotational band                 calx-148
c                                                                       calx-149
c common /ncomp/nsp(1) number of uncoupled levels for compound nucleus  calx-150
c                      including discretisation of continuum            calx-151
c               nsp(2) number of these levels with angular distribution calx-152
c               nsp(3) number of these levels without angular distrib.  calx-153
c               nfiss  number of fission transmission coefficients      calx-154
c               nrd    number of gamma transmission coefficients        calx-155
c               ncont: number of continuum for compound nucleus         calx-156
c               ncoj:  number of spins of the target for a continuum    calx-157
c               ncons: number of level densities needed                 calx-158
c               nie:   number of uncoupled states added for discret.    calx-159
c               ncolx: total number of levels without discretisation    calx-160
c               ndp:   address of fission and gamma final results       calx-161
c               ndq:   address of fission and gamma intermediate resultscalx-162
c               acn1:  ratio size/step for discretisation of a continuumcalx-163
c               acn2:  maximum number of steps by mev for a continuum   calx-164
c               az, ....: see lect and colf                             calx-165
c common /titr/ title: comment card reproduced in the output            calx-166
c common /angl/ theta1,theta2,dtheta,dthe    see lect                   calx-167
c common /ncjl/ ncj:   number of factorisations of 1/(1-cos)            calx-168
c               nl:   directives for expansion with legendre polynomialscalx-169
c common /dchi/ see calc and fite                                       calx-170
c***********************************************************************calx-171
      implicit real*8 (a-h,o-z)                                         calx-172
      logical lo(250)                                                   calx-173
      dimension nw(2,5),ngr(2),npr(2),desc(3),dw(1)                     calx-174
      character*4 fin,desc,title,cw(2,1)                                calx-175
      common /decou/ njit,nipp,npaa,nwv,niph,nscn,npar,nniv,nfis,ngam,npcalx-176
     1ot,nbeta,nfm,ntgx,ndonn,nrc,niw,nde,nise,nnvi,nnwi,ncc,mcc,nxa,namcalx-177
     21,nfac,nfam,npad,nfg,nxg,nsm,nres,nxx,nt,nivq,nivy,nivz,ncoi,mipi,calx-178
     3nxd,mwv,nixt,nty,ntx,nry,nrco,nrdo,nvc1,nvc2,nnc,ncx,idmt,ncoll,njcalx-179
     4max,iterm,npp,jdm,jit,nsec,lmd,mcm(2),ncols,ncolt,kmax,kmin,nva,nbcalx-180
     5et,nbt1,lmx,lmax1,nlt,ism,iqm,iqmax,ms1,ms2,nct(6),kba,kab,kbc,kcccalx-181
     6,njc,jtx,jth,ncolr,nrec,ntot,nfa,lmax2,ke,itemm,nplace,kxt,nrz,ntzcalx-182
     7,lmax3,ipm,ipk,bjm,eiter,aconv,conj,h,nspin                       calx-183
      common /ncomp/ nsp(3),nfiss,nrd,ncont,ncoj,ncons,nie,ncolx,ndp,ndqcalx-184
     1,acn1,acn2,az(18)                                                 calx-185
      common /titr/ title(18)                                           calx-186
      common /angl/ theta1,theta2,dtheta,dthe                           calx-187
      common /dchi/ chi2,chi2m,yy(3)                                    calx-188
      common /ncjl/ ncj,nl(3)                                           calx-189
      common /dcons/ cm,ck,chb,cmb,ccz                                  calx-190
      common /cnsec/ msec                                               calx-191
      common /inout/ mr,mw,ms                                           calx-192
      data fin,desc /'fin ','desc','ript','ion '/                       calx-193
    1 read (mr,1000) title                                              calx-194
      do 2 j=1,3                                                        calx-195
      if (title(j).ne.desc(j)) go to 3                                  calx-196
    2 continue                                                          calx-197
      call inpa                                                         calx-198
      call inpb                                                         calx-199
      call inpc                                                         calx-200
      go to 1                                                           calx-201
    3 if (title(1).eq.fin) then                                         ak000000
        icheck=1                                                        ak000000
        return                                                          ak000000
      endif                                                             ak000000
c   3 if (title(1).eq.fin) return                                       calx-202
      do 4 i=1,100                                                      calx-203
    4 lo(i)=.false.                                                     calx-204
      read (mr,1001) (lo(i),i=1,50)                                     calx-205
      if (lo(7).and.lo(10)) go to 20                                    calx-206
c if lo(36)=.true. return to restart a search saved on tape 8           calx-207
      if (lo(36)) return                                                calx-208
      read (mr,1001) (lo(i),i=51,100)                                   calx-209
      read (mr,1002) ncoll,njmax,iterm,npp,ncj,ngr,npr,lmz,jdm,lml,jit,mcalx-210
     1n                                                                 calx-211
c elimination of contradictions between logical controls                calx-212
      if (ncoll.le.1) lo(28)=.true.                                     calx-213
      if (.not.lo(31)) lo(32)=.false.                                   calx-214
      if (lo(14)) lo(13)=.true.                                         calx-215
      if (lo(19)) lo(11)=.true.                                         calx-216
      if (lo(92)) iterm=1                                               calx-217
      if (lo(18)) lo(29)=.true.                                         calx-218
      if (lo(100)) lo(29)=.false.                                       calx-219
      lo(209)=lo(99).or.lo(100)                                         calx-220
      if (lo(82)) lo(84)=.false.                                        calx-221
      if (lo(82)) lo(85)=.false.                                        calx-222
      if (lo(82)) lo(86)=.false.                                        calx-223
      if (lo(82).or.lo(84).or.lo(85).or.lo(86)) lo(81)=.true.           calx-224
      lo(44)=lo(44).and.lo(11)                                          calx-225
      if (.not.lo(99)) go to 5                                          calx-226
      lo(11)=.false.                                                    calx-227
      lo(19)=.false.                                                    calx-228
      if (lo(1)) lo(3)=.false.                                          calx-229
      if (.not.lo(1)) lo(2)=.false.                                     calx-230
      if ((.not.lo(10)).or.(.not.lo(12))) lo(20)=.false.                calx-231
    5 lmd=2                                                             calx-232
      lo(224)=lo(81).or.lo(63)                                          calx-233
      if (lo(100)) lmd=3                                                calx-234
      write (mw,1003) idmt                                              calx-235
      do 6 i=1,100                                                      calx-236
    6 lo(100+i)=.not.lo(i)                                              calx-237
c output of logical controls                                            calx-238
      if (lo(171)) go to 7                                              calx-239
      write (mw,1004) (lo(i),lo(50+i),i=1,2),lo(53),lo(3),lo(54),lo(55),calx-240
     1lo(4),(lo(i),lo(51+i),i=5,7),lo(8),lo(9)                          calx-241
      write (mw,1005) lo(10),lo(59),(lo(i),lo(49+i),i=11,15),lo(16),lo(1calx-242
     17),lo(65),lo(18),(lo(i),lo(47+i),i=19,20)                         calx-243
      write (mw,1006) (lo(47+i),lo(i),i=21,22),(lo(i),lo(48+i),i=23,25),calx-244
     1lo(74),(lo(i),lo(49+i),i=26,28),lo(78)                            calx-245
      write (mw,1007) lo(29),(lo(i),lo(50+i),i=31,37),lo(91),(lo(i),lo(5calx-246
     11+i),i=41,42)                                                     calx-247
      write (mw,1008) lo(43),lo(94),lo(44),lo(98),(lo(i),lo(54+i),i=45,4calx-248
     16)                                                                calx-249
    7 if (lo(171)) write (mw,1009) (lo(i),i=1,100)                      calx-250
      write (mw,1010) title                                             calx-251
      read (mr,1011) h,rm,bjm,eiter,aconv,conj                          calx-252
c defect values of njmax,iterm,npp,ncj,npr,ngr,eiter,aconv,conj         calx-253
c for npr and ngr, see deph                                             calx-254
      if (njmax.eq.0) njmax=20                                          calx-255
      if (iterm.eq.0) iterm=20                                          calx-256
      if (npp.eq.0) npp=1                                               calx-257
      if (npr(1).eq.0) npr(1)=1                                         calx-258
      if (npr(2).eq.0) npr(2)=1                                         calx-259
      if (ngr(1).eq.0) ngr(1)=2                                         calx-260
      if (ngr(2).eq.0) ngr(2)=2                                         calx-261
      if (ncj.le.0) ncj=1                                               calx-262
      if (jit.eq.0) jit=1                                               calx-263
      if (lo(143)) jit=0                                                calx-264
      if (mn.le.0) mn=1                                                 calx-265
      njmax=mn*njmax                                                    calx-266
      if (eiter.eq.0.d0) eiter=1.d-5                                    calx-267
      if (aconv.eq.0.d0) aconv=1.d-5                                    calx-268
      if (conj.eq.0.d0) conj=1.d-5                                      calx-269
      msec=3600                                                         calx-270
      nsec=100                                                          calx-271
      if (lo(34)) read (mr,1002) msec,nsec                              calx-272
      if (msec.eq.0) msec=3600                                          calx-273
      if (nsec.eq.0) nsec=100                                           calx-274
      call hora                                                         calx-275
c output of title, masses, etc..                                        calx-276
      write (mw,1012) njmax,jdm,conj,ngr,npr                            calx-277
      if (lo(41)) write (mw,1013) ncj                                   calx-278
      if (lml.ne.0) write (mw,1014) lml                                 calx-279
      if (lo(121)) write (mw,1015) iterm,eiter,aconv                    calx-280
      lo(228)=lo(21).or.lo(29).or.bjm.ne.0.d0                           calx-281
      if (bjm.ne.0.d0) write (mw,1016) bjm                              calx-282
      if (lo(21)) write (mw,1017)                                       calx-283
      if (lo(21).and.lo(42)) write (mw,1018) iterm                      calx-284
      if (lo(32).and.lo(34)) write (mw,1019) msec,nsec                  calx-285
c initialisation of a search or a single run                            calx-286
      do 8 i=211,220                                                    calx-287
    8 lo(i)=.false.                                                     calx-288
      lo(215)=.true.                                                    calx-289
c limitation on angular momentum for coulomb corrections                calx-290
      mcm(1)=3                                                          calx-291
      mcm(2)=2                                                          calx-292
      if (lo(145)) go to 9                                              calx-293
      read (mr,1002) mc1,mc2                                            calx-294
      if (mc1.gt.0) mcm(1)=min0(mc1,5)                                  calx-295
      if (mc2.gt.0) mcm(2)=min0(mc2,4)                                  calx-296
      if (mc1.lt.0) mcm(1)=0                                            calx-297
      if (mc2.lt.0) mcm(2)=0                                            calx-298
      write (mw,1020) mcm                                               calx-299
    9 nl2=3*njmax                                                       calx-300
      nl3=2*njmax                                                       calx-301
c legendre polynomials data                                             calx-302
      if (lo(165)) go to 10                                             calx-303
      read (mr,1002) nl                                                 calx-304
      if (nl(1).eq.0) nl(1)=2                                           calx-305
      if (nl(2).ne.0) nl2=nl(2)                                         calx-306
      if (nl(3).ne.0) nl3=nl(3)                                         calx-307
      if (lo(65)) write (mw,1021) nl                                    calx-308
c compound nucleus data                                                 calx-309
   10 nsp(1)=0                                                          calx-310
      nsp(2)=0                                                          calx-311
      nsp(3)=0                                                          calx-312
      nfiss=0                                                           calx-313
      nrd=0                                                             calx-314
      ncont=0                                                           calx-315
      ncons=0                                                           calx-316
      if (lo(184).and.lo(185).and.lo(186)) go to 11                     calx-317
      read (mr,1022) nsp(1),nsp(2),nfiss,nrd,ncont,ncoj,kmin,kmax,acn1,acalx-318
     1cn2                                                               calx-319
      if (lo(184)) nsp(1)=0                                             calx-320
      nsp(2)=min0(nsp(1),nsp(2))                                        calx-321
      nsp(3)=nsp(1)-nsp(2)                                              calx-322
      if (nsp(3).lt.ncont) go to 21                                     calx-323
      if (lo(185)) nfiss=0                                              calx-324
      if (lo(186)) nrd=0                                                calx-325
      if (nfiss.eq.0) lo(85)=.false.                                    calx-326
      lo(185)=.not.lo(85)                                               calx-327
      if (lo(84).or.lo(85).or.lo(86)) write (mw,1023) nsp,nfiss,nrd,nconcalx-328
     1t                                                                 calx-329
      ncons=ncont                                                       calx-330
      if (lo(86).and.nrd.eq.0) ncons=ncons+1                            calx-331
      if (ncont.eq.0) go to 11                                          calx-332
      if (ncoj.le.0) ncoj=30                                            calx-333
      if (acn1.le.1.d0) acn1=8.d0                                       calx-334
      if (acn2.le.1.d0) acn2=8.d0                                       calx-335
      write (mw,1024) ncoj,acn1,acn2                                    calx-336
   11 ncolx=ncoll+nsp(1)                                                calx-337
      ncols=ncoll+nsp(2)                                                calx-338
      ncolt=ncolx                                                       calx-339
      niph=(11*ncolx+1)/2+1                                             calx-340
      njit=niph+ncoll                                                   calx-341
      if (lo(7)) njit=niph                                              calx-342
      nwv=njit+jit                                                      calx-343
      nipp=nwv+18*ncolx                                                 calx-344
      npar=nipp+15*npp                                                  calx-345
      nplace=npar                                                       calx-346
      call memo('calx',idmt,nplace,1)                                   calx-347
c interpolation data                                                    calx-348
      if (lo(143)) go to 13                                             calx-349
      k=njit                                                            calx-350
      read (mr,1002) (nw(1,njit+i-1),nw(2,njit+i-1),i=1,jit)            calx-351
      write (mw,1025) (nw(1,njit+i-1),nw(2,njit+i-1),i=1,jit)           calx-352
      m=0                                                               calx-353
      l=-1                                                              calx-354
      do 12 i=1,jit                                                     calx-355
      if (nw(1,njit+i-1).lt.l) go to 22                                 calx-356
      l=nw(1,njit+i-1)                                                  calx-357
      nw(2,njit+i-1)=nw(2,njit+i-1)-m                                   calx-358
      m=m+nw(2,njit+i-1)                                                calx-359
   12 k=k+2                                                             calx-360
      write (mw,1026) (nw(2,njit+i-1),i=1,jit)                          calx-361
c input of level descriptions                                           calx-362
   13 call lecl(ncolx,ncoll,npp,ncont,nw,nw(1,niph),dw(nwv),nw(1,nipp),ncalx-363
     1w(1,npar),dw(npar),nva,na,nb,nimax,nbet,cm,idmt-npar,lo)          calx-364
      npaa=npar+na                                                      calx-365
      nscn=npaa+nva+nb                                                  calx-366
      if (kmin.eq.0) kmin=iabs(nw(2,1)-nw(1,2))/2+nw(1,1)               calx-367
      if (kmax.eq.0) kmax=njmax                                         calx-368
      lo(233)=lo(43).and.((nw(1,njit).lt.kmax).or.(nw(2,njit).ne.0))    calx-369
c input of potentials, deformations ......                              calx-370
      nbt1=nbet                                                         calx-371
      lmx=nimax/2+2                                                     calx-372
      lmax1=njmax+lmx                                                   calx-373
      if (lml.eq.0) lml=lmax1                                           calx-374
      nw(2,5)=lml                                                       calx-375
      nfis=nscn+7*ncons                                                 calx-376
      ngam=nfis+2*nfiss                                                 calx-377
      nniv=ngam+nrd                                                     calx-378
      npot=nniv+(3*ncoll*ncoll+1)/2                                     calx-379
      nbeta=npot+34*npp                                                 calx-380
      if (lo(7)) nbeta=npot                                             calx-381
      if (nbeta+9*nbet.gt.idmt) call memo('calx',idmt,nbeta+9*nbet,1)   calx-382
      if (dw(nwv+4).eq.0.) nl2=nl3                                      calx-383
      nlt=max0(nl2,nl3)                                                 calx-384
      if (lo(165)) nlt=0                                                calx-385
      call lect(nbet,nw,nw(1,nipp),dw(nipp),dw(nwv),nw(1,nbeta),dw(nbetacalx-386
     1),dw(npot),dw(nfis),dw(ngam),npp,rm,aconv,idmt-nbeta,h,nspin,ism,icalx-387
     2qm,iqmax,dw(nscn),ck,cm,lo)                                       calx-388
      nfm=nbeta+9*nbet                                                  calx-389
      if (lo(74)) call hora                                             calx-390
c helicity amplitudes and observables                                   calx-391
      njx=ncoll                                                         calx-392
      call deph(ncoll,ncols,dw(nwv),nw,nw(1,nfm),ms1,ms2,nct,kcc,kba,kabcalx-393
     1,kbc,ktgr,ngr,npr,jtx,nw(1,nniv),njc,njx,njy,idmt-nfm,lo)         calx-394
      jth=0                                                             calx-395
      if (lo(166)) jth=idint((theta2-theta1)/dtheta+1.5d0)              calx-396
      jtx=jtx*jth                                                       calx-397
      ngrm=nfm+5*kcc                                                    calx-398
      nnvi=nfm+5*ktgr                                                   calx-399
      nrec=0                                                            calx-400
      ntot=0                                                            calx-401
      if (lo(131)) go to 17                                             calx-402
c number of parameters in search and experimental data                  calx-403
      read (mr,1027) ncolr,nrec,nfit,nessai,yy(1),yy(2)                 calx-404
c search conditions                                                     calx-405
c defect values for nessai (maximum number of evaluations) and ech      calx-406
c nfit is the number of functions stored for search beyond nrec+1       calx-407
      if (nessai.eq.0) nessai=100                                       calx-408
      kfit=nrec+nfit+1                                                  calx-409
      if (yy(1).eq.0.d0) yy(1)=20.d0                                    calx-410
      if (yy(2).lt.1.d0) yy(2)=1.d0                                     calx-411
      yy(3)=0.d0                                                        calx-412
      write (mw,1028) ncolr                                             calx-413
      if (ncolr.le.0) go to 15                                          calx-414
      ktgr=ktgr+ncolr                                                   calx-415
      ntgx=nfm+5*ktgr                                                   calx-416
      ndonn=ntgx+7*ncolr                                                calx-417
c experimental data                                                     calx-418
      if (ndonn.gt.idmt) call memo('calx',idmt,ndonn,1)                 calx-419
      call lecd(ncols,ncolt,ncolr,dw(nwv),nw(1,nnvi),nw(1,ntgx),dw(ntgx)calx-420
     1,dw(ndonn),ngr,ntot,nrec,dw(ndonn),nw(1,ndonn),nmx,kfit,nessai,yy,calx-421
     2jth,njy,idmt-ndonn,lo)                                            calx-422
      jtx=max0(jth,jtx)                                                 calx-423
      nnvi=ndonn+6*ntot                                                 calx-424
      if (lo(132)) go to 17                                             calx-425
      if (nrec.le.0) go to 16                                           calx-426
      nde=nnvi                                                          calx-427
      nise=nde+nrec                                                     calx-428
      nrc=nise+nmx/2                                                    calx-429
      niw=nrc+max0(14+nrec+kfit*(ntot+nrec+1),(nrec*(nrec+5))/2)        calx-430
      if (niw.gt.idmt) call memo('calx',idmt,niw,1)                     calx-431
      nw(1,niw)=kfit                                                    calx-432
      nw(2,niw)=nessai                                                  calx-433
      nw(1,niw+1)=1                                                     calx-434
      nnvi=niw+(kfit+5)/2                                               calx-435
      i1=51                                                             calx-436
      if (lo(76).or.lo(175)) i1=59                                      calx-437
      do 14 i=i1,65                                                     calx-438
      lo(i+185)=lo(i)                                                   calx-439
      lo(i)=.false.                                                     calx-440
   14 lo(i+100)=.true.                                                  calx-441
      lo(216)=lo(75)                                                    calx-442
      go to 17                                                          calx-443
   15 write (mw,1029)                                                   calx-444
      lo(31)=.false.                                                    calx-445
      lo(131)=.true.                                                    calx-446
   16 if (lo(32)) write (mw,1030)                                       calx-447
      lo(32)=.false.                                                    calx-448
      lo(132)=.true.                                                    calx-449
   17 if (lo(74)) call hora                                             calx-450
      nnwi=nnvi                                                         calx-451
      if (lo(231)) nnwi=nnwi+(3*kab*kab+1)/2                            calx-452
      ncc=nnwi+2*kab*kab                                                calx-453
      mcc=ncc                                                           calx-454
      if (lo(231)) mcc=mcc+3*kab                                        calx-455
      nxa=mcc+3*kab                                                     calx-456
      nam1=nxa                                                          calx-457
      if (lo(231)) nam1=nam1+kbc*kbc                                    calx-458
      nam2=nam1+4*(njy+16)                                              calx-459
      if (nam2.gt.idmt) call memo('calx',idmt,nam2,1)                   calx-460
c do loops and cg-coefficients for observables                          calx-461
      call obse(nw(1,ngrm),cw(1,ngrm),ktgr-kcc,ncolr,nw,cw(1,nam1),nw(1,calx-462
     1nam1),cw(1,nam1),dw(nam2),cw(1,nam2),nw(1,nam2),jcal,idmt-nam2,lo)calx-463
      nfa=4*lmax1+10-2*njmax                                            calx-464
      nfac=nam1+jcal                                                    calx-465
      nfam=nfac+nfa+1                                                   calx-466
      npad=nfam+kab*(2*kbc+8)                                           calx-467
      if (lo(224)) npad=nfam+kab*(2*kab+8)                              calx-468
      nfg=npad+2*iterm*(kab+2)                                          calx-469
      if (lo(21).or.lo(22)) nfg=npad                                    calx-470
      lmax2=lmax1                                                       calx-471
      if (.not.lo(208)) go to 18                                        calx-472
      lmax1=lmz+lmx                                                     calx-473
      if (lmz.eq.0) lmax1=lmax2-njmax/2                                 calx-474
      if (lmz.lt.0) lmax1=lmax2                                         calx-475
      write (mw,1031) lmax2,lmax1                                       calx-476
   18 nxg=nfg+4*njx*lmax1                                               calx-477
      nres=nxg+njx*lmax2                                                calx-478
      ke=0                                                              calx-479
      nxx=nres+ntot                                                     calx-480
      nt=nxx+nrec                                                       calx-481
      itemm=iterm                                                       calx-482
      nplace=nt                                                         calx-483
      if (nplace.gt.idmt) call memo('calx',idmt,nplace,1)               calx-484
      dw(nfac)=0.d0                                                     calx-485
      do 19 i=1,nfa                                                     calx-486
   19 dw(nfac+i)=dw(nfac+i-1)+dlog(dfloat(i))                           calx-487
      return                                                            calx-488
   20 write (mw,1032)                                                   calx-489
      go to 23                                                          calx-490
   21 write (mw,1033) nsp(3),ncont                                      calx-491
      go to 23                                                          calx-492
   22 write (mw,1034) i,nw(k,1),l                                       calx-493
   23 write (mw,1035)                                                   calx-494
      stop                                                              calx-495
 1000 format (18a4)                                                     calx-496
 1001 format (50l1)                                                     calx-497
 1002 format (14i5)                                                     calx-498
 1003 format ('1',20x,'e. c. i. s. code for coupled channels calculationcalx-499
     1s ( 2003 ) working field length =',i10//24x,'to obtain the input dcalx-500
     2escription, punch ''description '' in columns 1-12 of the first cacalx-501
     3rd'//)                                                            calx-502
 1004 format ('  1-',l2,' - rotational model-(.f.: vibrational model).',calx-503
     18x,'| 51-',l2,' - output of potentials.'/'  2-',l2,' - second ordecalx-504
     2r vibrational model-(.f.: first order) | 52-',l2,' - output of redcalx-505
     3uced nuclear matrix elements.'/9x,'or constrained asymmetric rotatcalx-506
     4ional model.',7x,'| 53-',l2,' - output of the number of iterationscalx-507
     5.'/'  3-',l2,' - anharmonic vibrational model-(.f.: harmonic) or  calx-508
     6 | 54-',l2,' - output of the length used in the working field.'/9xcalx-509
     7,'asymmetric rotational model-(.f.: symmetric).',5x,'| 55-',l2,' -calx-510
     8 output of c-matrix elements and compound nucleus'/'  4-',l2,' - pcalx-511
     9arametrised spin-orbit deformation-(.f.:standard)|',9x,'intermediacalx-512
     ate results.'/'  5-',l2,' - different deformation for each potentiacalx-513
     bl(.f.:same)| 56-',l2,' - output of s-matrix elements.'/'  6-',l2,'calx-514
     c - use of deformation lengths.',23x,'| 57-',l2,' - output of phasecalx-515
     d-shifts at each e.c.i.s. iteration.'/'  7-',l2,' - nuclear matrix calx-516
     eelements and form factors on cards.| 58-',l2,' - output of the coecalx-517
     ffficients of each form factor.'/'  8-',l2,' - relativistic kinematcalx-518
     gics.',26x,'|',9x,'for all sets of equations.'/'  9-',l2,' - symmetcalx-519
     hrised woods-saxon form for negative radii.  |')                   calx-520
 1005 format (' 10-',l2,' - dispersion relations for potentials.',9x,5x,calx-521
     1'| 59-',l2,' - total elastic reaction cross-sections written on ficalx-522
     2le 58'/ 59x,'|',9x,'and total inelastic reaction cross-sections oncalx-523
     3 file 59.'/' 11-',l2,' - deformed coulomb potential.',23x,'| 60-',calx-524
     4l2,' - s-matrix elements written on file 60.'/' 12-',l2,' - deformcalx-525
     5ed imaginary potential.',21x,'| 61-',l2,' - reduced nuclear matrixcalx-526
     6 elements written on file 61.'/' 13-',l2,' - deformed real spin-orcalx-527
     7bit/tensor potential.',8x,'| 62-',l2,' - potentials written on filcalx-528
     8e 62.'/' 14-',l2,' - deformed imaginary spin-orbit/tensor potentiacalx-529
     9l.   | 63-',l2,' - penetrabilities written on file 63.'/' 15-',l2,calx-530
     a' - reduced nuclear matrix elements read from cards.  | 64-',l2,' calx-531
     b- results for experimental data on file 64'/' 16-',l2,' - heavy-iocalx-532
     cn definition of radii and deformations.   |',9x,'and at equidistancalx-533
     dt angles written on file 66.'/' 17-',l2,' - folding model.',36x,'|calx-534
     e 65-',l2,' - legendre expansion for cross-sections written on filecalx-535
     f 65.'/' 18-',l2,' - projectile-target antisymmetrisation.',13x,'|'calx-536
     g/' 19-',l2,' - deformed coulomb spin-orbit potential.',12x,'| 66-'calx-537
     h,l2,' - no calculation at equidistant angles.'/' 20-',l2,' - dispecalx-538
     irsion relations for transition form-factors. | 67-',l2,' - no plotcalx-539
     j of experimental data.')                                          calx-540
 1006 format (59x,'| 68-',l2,' - no plot of cross-sections at equidistancalx-541
     1t angles.'/' 21-',l2,' - usual coupled equations-(.f.: iterations)calx-542
     2.',8x,'| 69-',l2,' - no plot of polarisations at equidistant anglecalx-543
     3s.'/' 22-',l2,' - no use of pade for convergence of the iterationscalx-544
     4. |'/' 23-',l2,' - no use of pade without convergence.',15x,'| 71-calx-545
     5',l2,' - detailed output of logical controls.'/' 24-',l2,' - couplcalx-546
     6ing potentials computed at each iteration.   | 72-',l2,' - no outpcalx-547
     7ut of experimental data as they are read.'/' 25-',l2,' - complete calx-548
     8calculation up to the end-(.f.: one ite- | 73-',l2,' - no output ocalx-549
     9f external potentials as they are read.'/9x,'ration only as soon acalx-550
     as two iterations are enough).| 74-',l2,' - output of variations incalx-551
     b storage.'/' 26-',l2,' - integration stabilised for long range potcalx-552
     cential.  | 75-',l2,' - no complete output at the first run of a secalx-553
     darch.'/' 27-',l2,' - numerov''s method for single equations-(.f.: calx-554
     emodi- | 76-',l2,' - lo(51) to lo(65) are alway used-(.f.: only forcalx-555
     f'/9x,'fied numerov''s method).',27x,'|',9x,'complete output)'/' 28calx-556
     g-',l2,' - computation up to j-convergence-(f.: stop when    | 77-'calx-557
     h,l2,' - no output of time differences during the search.'/9x,'all calx-558
     ithe inhomogeneous terms are negligible).',6x,'| 78-',l2,' - no outcalx-559
     jput of differences between experimental')                         calx-560
 1007 format (' 29-',l2,' - no diagonal term in second members.',15x,'|'calx-561
     1,9x,'and calculated values.'/59x,'|'/' 31-',l2,' - input of expericalx-562
     2mental data and chi2 calculation.  | 81-',l2,' - hauser-feshbach ccalx-563
     3orrections to cross-sections.'/' 32-',l2,' - automatic search on scalx-564
     4ome parameters.',14x,'| 82-',l2,' - simplest compound nucleus formcalx-565
     5alism.'/' 33-',l2,' - symmetrised chi2 for cross-sections.',14x,'|calx-566
     6 83-',l2,' - no engelbretch-weidenmuller transf. in c.-n.'/' 34-',calx-567
     7l2,' - number of evaluations limited by the job card.    | 84-',l2calx-568
     8,' - uncoupled levels for compound nucleus.'/' 35-',l2,' - search calx-569
     9saved on tape 8 if ended by lack of time.  | 85-',l2,' - fission dcalx-570
     aata in compound nucleus.'/' 36-',l2,' - restart a search from tapecalx-571
     b 8.',21x,'| 86-',l2,' - gamma emission data in compound nucleus.'/calx-572
     c' 37-',l2,' - next calculation changing energy and/or some',6x,'| calx-573
     d87-',l2,' - no width fluctuations.'/9x,'parameters.',39x,'|'/59x,'calx-574
     e| 91-',l2,' - equidistant angles in the laboratory system.'/' 41-'calx-575
     f,l2,' - factorisation of 1/(1-cos(theta)) in amplitudes.  | 92-',lcalx-576
     g2,' - pure dwba calculation.'/' 42-',l2,' - schmidt''s orthogonal.calx-577
     h in usual coupled equations. | 93-',l2,' - no recoil correction focalx-578
     ir reactions.')                                                    calx-579
 1008 format (' 43-',l2,' - interpolation on total spin.',22x,'| 94-',l2calx-580
     1,' - non standard observables at equidistant angles.'/' 44-',l2,' calx-581
     2- coulomb corrections.',30x,'| 98-',l2,' - use of rest mass in dircalx-582
     3ac equations.'/' 46-',l2,' - angular momentum limit for coulomb cocalx-583
     4rrections.   | 99-',l2,' - schroedinger equivalent to dirac equaticalx-584
     5on.'/' 46-',l2,' - restricted coulomb corrections.',19x,'|100-',l2calx-585
     6,' - complete dirac equation.'/'1')                               calx-586
 1009 format (//' **** first control card ****',2x,'1 ',9(' 1'),' 2 ',9(calx-587
     1' 2'),' 3 ',9(' 3'),' 4 ',9(' 4'),' 5'/ 11x,5('  1 2 3 4 5 6 7 8 9calx-588
     2 0')/11x,5(1x,10l2)//' *** second control card ****',2x,'1 ',9(' 1calx-589
     3'),' 2 ',9(' 2'),' 3 ',9(' 3'),' 4 ',9(' 4'),' 5'/11x,5('  1 2 3 4calx-590
     4 5 6 7 8 9 0')/11x,5(1x,10l2)/)                                   calx-591
 1010 format (10x,82('*')/10x,'*',80x,'*'/10x,'*',4x,18a4,4x,'*'/10x,'*'calx-592
     1,80x,'*'/10x,82('*')/)                                            calx-593
 1011 format (7f10.3)                                                   calx-594
 1012 format (' maximum number of j',i6,'  (min',i3,') stop when maximumcalx-595
     1 s-matrix element is less than',d18.4//' plot conditions for crosscalx-596
     2-sections',2i5,5x,'for polarisations',2i5/)                       calx-597
 1013 format (4x,i3,' factorisation of 1/(1-cos(theta)) in the amplitudecalx-598
     1s')                                                               calx-599
 1014 format (' angular momenta limited to',i5)                         calx-600
 1015 format (10x,'iteration method:  maximum number of iterations',i10/calx-601
     110x,'convergence criterion:',d15.2,' for s-matrix',d15.2,' for potcalx-602
     2entials and functions'/)                                          calx-603
 1016 format (' imaginary potential increased with a factor',f10.5,' forcalx-604
     1 better convergence')                                             calx-605
 1017 format (' usual coupled equations')                               calx-606
 1018 format (' schmidt''s orthogonalisation every',i5,'  steps')       calx-607
 1019 format (5x,i5,' maximum number of seconds for a job'/5x,i5,' hundrcalx-608
     1edths of second to print final output')                           calx-609
 1020 format (' coulomb corrections limited to angular momenta',i2,' forcalx-610
     1 central term and',i2,' for spin-orbit term')                     calx-611
 1021 format (/' indications for expansion of cross-sections in legendrecalx-612
     1 polynomials:',3i5)                                               calx-613
 1022 format (8i5,2f10.5)                                               calx-614
 1023 format (/' compound nucleus input:',i5,' uncoupled states',i4,' wicalx-615
     1th angular distribution and',i4,' without angular distribution'/24calx-616
     2x,i5,' fission transm. coeff.'/24x,i5,' gamma transm. coeff.'/24x,calx-617
     3i5,' continua')                                                   calx-618
 1024 format (' maximum number of spin values in the continuum:',i5/' dicalx-619
     1scretisation with:',2f10.5)                                       calx-620
 1025 format (' interpolation of s-matrix',3(2x,'from',i6,'  by steps ofcalx-621
     1',i4,'+1')/(26x,3(2x,'from',i6,'  by steps of',i4,'+1')))         calx-622
 1026 format (' uncumulated increases  ',3(27x,i4)/(24x,3(27x,i4)))     calx-623
 1027 format (4i5,2f10.5)                                               calx-624
 1028 format (//5x,i5,'  experimental angular distributions'/)          calx-625
 1029 format (' there are no experimental data   ...  no search')       calx-626
 1030 format (' no parameter in search')                                calx-627
 1031 format (2x,i10,' coulomb phases and indefinite integrals'/2x,i10,'calx-628
     1 coulomb functions and finite integrals')                         calx-629
 1032 format (' dispersion relations not allowed with external potentialcalx-630
     1s'/)                                                              calx-631
 1033 format (' number of uncoupled states without angular distribution'calx-632
     1,i5,' less than the number of continua:',i5)                      calx-633
 1034 format (2x,i3,'th limit of interpolation',i6,' smaller than previocalx-634
     1us one',i6)                                                       calx-635
 1035 format (' in calx  ... stop ...')                                 calx-636
      end                                                               calx-637
c 29/02/04                                                      ecis03  inpa-000
      subroutine inpa                                                   inpa-001
      write (2,1000)                                                    inpa-002
 1000 format ('29/02/04',64x,'ecis-000'/15x,'description of input of eciinpa-003
     1s03',27x,'ecis-001'/15x,'******************************',27x,'ecisinpa-004
     2-002'/72x,'ecis-003'/72x,'ecis-004'/72x,'ecis-005'/'cards read in inpa-005
     3subroutine calx',43x,'ecis-006'/'*****************************',43inpa-006
     4x,'ecis-007'/72x,'ecis-008'/'card 1',34x,'format (18a4)',19x,'ecisinpa-007
     5-009'/'******',66x,'ecis-010'/6x,'title of the run which will be pinpa-008
     6rinted as heading of results.',5x,'ecis-011'/72x,'ecis-012'/6x,'ifinpa-009
     7 title=''description '' this input description is listed.',9x,'eciinpa-010
     8s-013'/9x,'(1829 lines correctly printed in 31 pages)',21x,'ecis-0inpa-011
     914'/10x,'after this listing, go back to card 1.',24x,'ecis-015'/72inpa-012
     ax,'ecis-016'/6x,'if title=''fin '' the calculation is stopped.',23inpa-013
     bx,'ecis-017'/72x,'ecis-018'/11x,'these control words must be punchinpa-014
     ced from column 1.',11x,'ecis-019'/72x,'ecis-020'/'card 2',34x,'forinpa-015
     dmat (50l1)',19x,'ecis-021'/'******',66x,'ecis-022'/6x,'50 first loinpa-016
     egical controls lo. enter ''t'' in the corresponding',6x,'ecis-023'inpa-017
     f/6x,'column for .true. and nothing for .false..',24x,'ecis-024'/72inpa-018
     gx,'ecis-025'/' model',66x,'ecis-026'/7x,'1- lo(1)  rotational modeinpa-019
     hl-(inverse: vibrational model).',9x,'ecis-027'/7x,'2- lo(2)  seconinpa-020
     id order vibrational model-(inverse: first order). ecis-028'/17x,'oinpa-021
     jr constrained asymmetric rotational model (band mixingecis-029')  inpa-022
      write (2,1001)                                                    inpa-023
 1001 format (17x,'parameters of the first two 2+ computed from the',7x,inpa-024
     1'ecis-030'/17x,'quadrupole ''gamma'' in the davydov-filippov modelinpa-025
     2).',5x,'ecis-031'/7x,'3- lo(3)  anharmonic vibrational model-(inveinpa-026
     3rse: harmonic) or',4x,'ecis-032'/17x,'asymmetric rotational model-inpa-027
     4(inverse: symmetric).',6x,'ecis-033'/7x,'4- lo(4)  parametrised spinpa-028
     5in-orbit deformation-(inverse: standard)ecis-034'/7x,'5- lo(5)  diinpa-029
     6fferent deformation for each potential-(inverse: sameecis-035'/17xinpa-030
     7,'deformation).',42x,'ecis-036'/7x,'6- lo(6)  deformation lengths inpa-031
     8read instead of deformations for   ecis-037'/17x,'woods-saxon forminpa-032
     9 factors.',30x,'ecis-038'/7x,'7- lo(7)  nuclear matrix element andinpa-033
     a form factors read on cards. ecis-039'/17x,'this is not allowed foinpa-034
     br schroedinger equivalent of',5x,'ecis-040'/17x,'dirac equation. winpa-035
     cith spin in some channel and no',7x,'ecis-041'/17x,'coulomb spin-oinpa-036
     drbit, use also lo(46)=.true..',12x,'ecis-042'/7x,'8- lo(8)  relatiinpa-037
     evistic kinematics (reduced mass replaced by',6x,'ecis-043'/17x,'siinpa-038
     fmilar formula with relativistic energies).',11x,'ecis-044'/7x,'9- inpa-039
     glo(9)  symmetric woods-saxon form factors when the radius is  ecisinpa-040
     h-045'/17x,'negative.',46x,'ecis-046'/6x,'10- lo(10) energy dependeinpa-041
     int potentials by dispersion relations.   ecis-047'/17x,'not alloweinpa-042
     jd with external potentials (lo(7)=.true.).   ecis-048'/72x,'ecis-0inpa-043
     k49'/' interaction',60x,'ecis-050')                                inpa-044
      write (2,1002)                                                    inpa-045
 1002 format (6x,'11- lo(11) deformed coulomb potential. with lo(7)=.falinpa-046
     1se., it is  ecis-051'/17x,'set .false. by the code if no charge isinpa-047
     2 read.',10x,'ecis-052'/6x,'12- lo(12) deformed imaginary potentialinpa-048
     3 (volume and surface or',4x,'ecis-053'/17x,'scalar and vector).',3inpa-049
     46x,'ecis-054'/6x,'13- lo(13) deformed real spin-orbit or tensor poinpa-050
     5tential. with',5x,'ecis-055'/17x,'lo(7)=.false., it is set .false.inpa-051
     6 by the code if no',5x,'ecis-056'/17x,'non zero spin and no relateinpa-052
     7d potential are read.',7x,'ecis-057'/6x,'14- lo(14) deformed imagiinpa-053
     8nary spin-orbit or tensor potential. if  ecis-058'/17x,'.true., loinpa-054
     9(13) is set .true.. with lo(7)=.false., it isecis-059'/17x,'set .finpa-055
     aalse. by the code as for lo(13).',17x,'ecis-060'/''/6x,'15- lo(15inpa-056
     b) reduced nuclear matrix elements read from cards.',7x,'ecis-061'/inpa-057
     c17x,'it is necessary for the anharmonic vibrational model.  ecis-0inpa-058
     d62'/6x,'16- lo(16) heavy-ion definition of reduced radii and deforinpa-059
     emations.ecis-063'/17x,'when there are different masses in differeninpa-060
     ft channels, ecis-064'/17x,'the masses to be used can be indicated inpa-061
     gby the first',4x,'ecis-065'/17x,'input, but only the masses of theinpa-062
     h first level can be   ecis-066'/17x,'used for the back transformatinpa-063
     iion of the results of a   ecis-067'/17x,'search or in the subroutiinpa-064
     jne eval (lo(37)=.true.).',6x,'ecis-068'/17x,'if lo(6)=.true., onlyinpa-065
     k coulomb deformation lengths are  ecis-069')                      inpa-066
      write (2,1003)                                                    inpa-067
 1003 format (17x,'changed.',47x,'ecis-070'/6x,'17- lo(17) folding modelinpa-068
     1. with external form factors the folding  ecis-071'/17x,'parameterinpa-069
     2s are used independently of this logical.',5x,'ecis-072'/6x,'18- linpa-070
     3o(18) projectile-target antisymmetrisation, valid only for   ecis-inpa-071
     4073'/17x,'same spin of the particle and the target and positive  einpa-072
     5cis-074'/17x,'parity in the schroedinger formalism. for spin 0,',6inpa-073
     6x,'ecis-075'/17x,'the s-matrix is computed only for even total spiinpa-074
     7ns.',4x,'ecis-076'/17x,'for spin non 0., the amplitudes are symmetinpa-075
     8rised but',4x,'ecis-077'/17x,'this do not correct the lack of symminpa-076
     9etry of the',8x,'ecis-078'/17x,'interaction between particle and tinpa-077
     aarget.',15x,'ecis-079'/6x,'19- lo(19) deformed coulomb spin-orbit inpa-078
     bpotential. if .true.,',6x,'ecis-080'/17x,'lo(11) is set .true.. wiinpa-079
     cth lo(7)=.false., it is set',4x,'ecis-081'/17x,'.false. by the codinpa-080
     de as for lo(13). (needs lo(13)=.true.ecis-082'/17x,'with a real spinpa-081
     ein-orbit potential, even very small)',5x,'ecis-083'/6x,'20- lo(20)inpa-082
     f energy dependence of transition form-factors when',6x,'ecis-084'/inpa-083
     g17x,'lo(10)=.true. . this dependence is the geometric mean  ecis-0inpa-084
     h85'/17x,'value of the dependence of the levels between which',4x,'inpa-085
     iecis-086'/17x,'the transition form-factor occurs. it cannot be useinpa-086
     jd   ecis-087'/17x,'with lo(12)=.false. .',34x,'ecis-088')         inpa-087
      write (2,1004)                                                    inpa-088
 1004 format ('  note:  in the rotational models, the optical potentialsinpa-089
     1 (for elastic  ecis-089'/'  ****  scattering) are always deformed.inpa-090
     2 to avoid this, when lo(11),',4x,'ecis-090'/8x,'lo(12),lo(13),lo(1inpa-091
     34) or lo(19) is .false., use lo(5)=.true.',5x,'ecis-091'/8x,'and einpa-092
     4nter 0. for the corresponding deformations.',16x,'ecis-092'/72x,'einpa-093
     5cis-093'/' integration',60x,'ecis-094'/6x,'21- lo(21) usual coupleinpa-094
     6d equations-(inverse: iterations).',9x,'ecis-095'/17x,'not allowedinpa-095
     7 with dirac equation. when it is used with  ecis-096'/17x,'deformeinpa-096
     8d spin-orbit, the derivative terms are not takenecis-097'/17x,'intinpa-097
     9o account and the computation is incorrect.',9x,'ecis-098'/6x,'22-inpa-098
     a lo(22) no use of pade approximants for convergence of the',5x,'ecinpa-099
     bis-099'/17x,'iterations.',44x,'ecis-100'/6x,'23- lo(23) no use of inpa-100
     cpade approximant results and shift to usual  ecis-101'/17x,'coupleinpa-101
     dd equations when convergence is not obtained.',4x,'ecis-102'/6x,'2inpa-102
     e4- lo(24) computation of coupling potentials at each iteration.  einpa-103
     fcis-103'/17x,'(saves space but loses time, chiefly in rotational',inpa-104
     g5x,'ecis-104'/17x,'model).',48x,'ecis-105'/6x,'25- lo(25) completeinpa-105
     h calculation up to the end-(inverse: one',7x,'ecis-106'/17x,'iterainpa-106
     ition only as soon as two iterations are enough).  ecis-107'/6x,'26inpa-107
     j- lo(26) stabilisation of integration for long range constant   ecinpa-108
     kis-108')                                                          inpa-109
      write (2,1005)                                                    inpa-110
 1005 format (17x,'potentials. an additional term in h**6 is introduced inpa-111
     1inecis-109'/17x,'the truncation in such a way that the term in h**inpa-112
     26 of  ecis-110'/17x,'the total truncation error cancels out for a inpa-113
     3constant  ecis-111'/17x,'potential.',45x,'ecis-112'/6x,'27- lo(27)inpa-114
     4 numerov''s method for single equations-(inverse:',8x,'ecis-113'/1inpa-115
     57x,'modified numerov''s method). for single equation and',4x,'ecisinpa-116
     6-114'/17x,'constant potential, truncation errors are of opposite  inpa-117
     7ecis-115'/17x,'sign.',50x,'ecis-116'/6x,'28- lo(28) computation upinpa-118
     8 to j-convergence-(inverse: stop when allecis-117'/17x,'the inhomoinpa-119
     9geneous terms are negligible). for elastic   ecis-118'/17x,'scatteinpa-120
     aring (only one channel) lo(21) or lo(28) must be ecis-119'/17x,'.tinpa-121
     brue.. in this case lo(28) is set .true. by the code. ecis-120'/''inpa-122
     c/6x,'29- lo(29) no diagonal terms in second members for iterationsinpa-123
     d of  ecis-121'/17x,'schroedinger equations. (inverse: all couplinginpa-124
     es are in ecis-122'/17x,'second members. the uncoupled solutions doinpa-125
     f not depend  ecis-123'/17x,'on the channel spin but convergence cainpa-126
     gn be slower in   ecis-124'/17x,'some problems. no effect in first inpa-127
     horder vibrational',4x,'ecis-125'/17x,'model, no use in dirac equatinpa-128
     iions: if lo(100)=.true.,   ecis-126'/17x,'lo(29) is set .false.). inpa-129
     jfor convenience, lo(29) is set ecis-127'/17x,'.false. if lo(18)=.tinpa-130
     krue. .',29x,'ecis-128'/72x,'ecis-129'/' search',65x,'ecis-130')   inpa-131
      write (2,1006)                                                    inpa-132
 1006 format (6x,'31- lo(31) input of experimental data and calculation inpa-133
     1of a chi2.  ecis-131'/17x,'it is set .false. if no experimental dainpa-134
     2ta are read.',4x,'ecis-132'/6x,'32- lo(32) automatic search on sominpa-135
     3e parameters. it is set .false. ecis-133'/17x,'if no parameters arinpa-136
     4e in search.',24x,'ecis-134'/6x,'33- lo(33) symmetrised chi2 for cinpa-137
     5ross-sections with fixed',9x,'ecis-135'/17x,'normalisation-(inversinpa-138
     6e: usual chi2). the chi2',10x,'ecis-136'/17x,'contribution is multinpa-139
     7iplied by the ratio of',13x,'ecis-137'/17x,'experimental to calculinpa-140
     8ated value.',22x,'ecis-138'/6x,'34- lo(34) number of evaluations iinpa-141
     9n the search limited by the job ecis-139'/17x,'card. this option cinpa-142
     aan be used only if the remaining',4x,'ecis-140'/17x,'cpu time is ainpa-143
     bvailable to the code on your computer.',4x,'ecis-141'/17x,'a maximinpa-144
     cum running time must be read.',19x,'ecis-142'/6x,'35- lo(35) searcinpa-145
     dh saved on tape 8 if correctly ended or stopped byecis-143'/17x,'tinpa-146
     ehe number of evaluations.',29x,'ecis-144'/6x,'36- lo(36) restart ainpa-147
     f search from tape 8.',26x,'ecis-145'/6x,'37- lo(37) next calculatiinpa-148
     gon changing only energy and some optical ecis-146'/17x,'parametersinpa-149
     h.',44x,'ecis-147'/72x,'ecis-148'/' long range interaction',49x,'ecinpa-150
     iis-149'/6x,'41- lo(41) factorisation of 1/(1-cos(theta)) in the aminpa-151
     jplitudes. itecis-150'/17x,'is needed for dirac equation or with spinpa-152
     kin-orbit coulombecis-151'/17x,'potential.',45x,'ecis-152')        inpa-153
      write (2,1007)                                                    inpa-154
 1007 format (6x,'42- lo(42) schmidt''s orthogonalisation of solutions iinpa-155
     1n usual',6x,'ecis-153'/17x,'coupled equations.',37x,'ecis-154'/6x,inpa-156
     2'43- lo(43) interpolation on total spin.',27x,'ecis-155'/6x,'44- linpa-157
     3o(44) coulomb corrections. lo(44) is set .false. if lo(11) isecis-inpa-158
     4156'/17x,'.false. . outside the dirac formalism it is better to  einpa-159
     5cis-157'/17x,'use also lo(29)=.true..',32x,'ecis-158'/6x,'45- lo(4inpa-160
     65) limitation on the angular momenta for coulomb',10x,'ecis-159'/1inpa-161
     77x,'corrections. default options are 3 for central term',4x,'ecis-inpa-162
     8160'/17x,'and 2 for spin-orbit term. maximum values are',10x,'ecisinpa-163
     9-161'/17x,'respectively 5 and 4.',34x,'ecis-162'/6x,'46- lo(46) reinpa-164
     astricted coulomb corrections. (saves storage).',7x,'ecis-163'/17x,inpa-165
     b'if lo(44)=.false. the diagonal corrections used in',5x,'ecis-164'inpa-166
     c/17x,'dirac formalism or for the coulomb spin-orbit are',6x,'ecis-inpa-167
     d165'/17x,'suppressed. if lo(44)=.true. indications for these',5x,'inpa-168
     eecis-166'/17x,'restrictions between channels will be read.',12x,'einpa-169
     fcis-167'/'  note:  if lo(36)=.true. a search saved on tape 8 is reinpa-170
     gstarted;',8x,'ecis-168'/'  ****  no other logical control from thiinpa-171
     hs card is taken into account.  ecis-169'/8x,'instead of the followinpa-172
     iing cards, go to ''restart input: cards',5x,'ecis-170'/8x,'read ininpa-173
     j subroutine rest''.',39x,'ecis-171'/72x,'ecis-172'/'card 3',34x,'finpa-174
     kormat (50l1)',19x,'ecis-173'/'******',66x,'ecis-174')             inpa-175
      write (2,1008)                                                    inpa-176
 1008 format (6x,'logical controls from 51 to 100 (as for previous card)inpa-177
     1.',11x,'ecis-175'/72x,'ecis-176'/' printing in complete output',44inpa-178
     2x,'ecis-177'/7x,'1- lo(51) output of potentials.',34x,'ecis-178'/7inpa-179
     3x,'2- lo(52) output of reduced nuclear matrix elements.',13x,'ecisinpa-180
     4-179'/7x,'3- lo(53) output of the number of iterations.',20x,'ecisinpa-181
     5-180'/''/7x,'4- lo(54) output of the length used in the working finpa-182
     6ield.',8x,'ecis-181'/7x,'5- lo(55) output of c-matrix elements andinpa-183
     7 of compound nucleus',4x,'ecis-182'/17x,'intermediate results.',34inpa-184
     8x,'ecis-183'/7x,'6- lo(56) output of s-matrix elements',28x,'ecis-inpa-185
     9184'/7x,'7- lo(57) output of phase-shifts at each e.c.i.s. iteratiinpa-186
     aon.',5x,'ecis-185'/7x,'8- lo(58) output of the coefficients of eacinpa-187
     bh form factor for all ecis-186'/17x,'sets of equations.',37x,'ecisinpa-188
     c-187'/'  note:  in a search, lo(51) to lo(58) are used for the cominpa-189
     dplete resultsecis-188'/'  ****  (at the first calculation if lo(75inpa-190
     e)=.false. and at the end of   ecis-189'/8x,'the search).',52x,'eciinpa-191
     fs-190'/72x,'ecis-191'/' punch and results in last output',39x,'eciinpa-192
     gs-192'/7x,'9- lo(59) for neutron scattering, total reaction, elastinpa-193
     hic and',4x,'ecis-193'/17x,'reaction cross-section written on file inpa-194
     i58. for charged ecis-194'/17x,'particles, reaction cross-section winpa-195
     jritten on file 58.  ecis-195'/17x,'inelastic cross-sections writteinpa-196
     kn on file 59.',11x,'ecis-196')                                    inpa-197
      write (2,1009)                                                    inpa-198
 1009 format (6x,'10- lo(60) s-matrix elements written on file 60.',18x,inpa-199
     1'ecis-197'/6x,'11- lo(61) reduced nuclear matrix elements written inpa-200
     2on file 61.',4x,'ecis-198'/6x,'12- lo(62) potentials written on fiinpa-201
     3le 62.',25x,'ecis-199'/6x,'13- lo(63) penetrabilities written on finpa-202
     4ile 63. with iterations,   ecis-200'/17x,'the code computes all thinpa-203
     5e solutions.',19x,'ecis-201'/6x,'14- lo(64) results for experimentinpa-204
     6al data on file 64 and at',8x,'ecis-202'/17x,'equidistant angles winpa-205
     7ritten on file 66.',17x,'ecis-203'/6x,'15- lo(65) coefficients of inpa-206
     8the expansion in legendre polynomials  ecis-204'/17x,'written on finpa-207
     9ile 65.',36x,'ecis-205'/'  note:  in a search,lo(59) to lo(65) areinpa-208
     a used only in the last result. ecis-206'/'  ****  there are introdinpa-209
     buced for neutron scattering, in peculiar, on theecis-207'/8x,'sugginpa-210
     cestion of e. bauge, r. capote and a. koning. foe each run,  ecis-2inpa-211
     d08'/8x,'the first line (format a10,,f10.2,f10.5,f10.2,2i5) with thinpa-212
     ee',5x,'ecis-209'/4x,'1-10  identification <cross-s.>, <ine.c.s.>, inpa-213
     f<s-matrix>, <red.mat.>,ecis-210'/10x,'<potenti.>, <tlj',5x,'>, <exinpa-214
     gp.dat.>, <legendre>, <ang.dis.> forecis-211'/10x,'files 58 to 66.'inpa-215
     h,47x,'ecis-212'/3x,'11-20 the mass of the incident particle.',29x,inpa-216
     i'ecis-213'/3x,'21-30 the energy in the laboratory system.',27x,'ecinpa-217
     jis-214'/3x,'31-40 the mass of the target.',40x,'ecis-215'/3x,'41-4inpa-218
     k5 the product of charges.',40x,'ecis-216')                        inpa-219
      write (2,1010)                                                    inpa-220
 1010 format (3x,'46-50 the number of lines or the number of subsets whiinpa-221
     1ch are headed  ecis-217'/9x,'by some indications including their oinpa-222
     2wn number of lines, exceptecis-218'/9x,'for 61 and 62. for 61, it inpa-223
     3is the number of coupled states and  ecis-219'/9x,'the remaining oinpa-224
     4f the output can be used by the program.',8x,'ecis-220'/9x,'for 62inpa-225
     5, it is the number of form-factors and the remaining of  ecis-221'inpa-226
     6/9x,'the output can also be used by the program, replacing the',6xinpa-227
     7,'ecis-222'/9x,'identifications by the suitable input.',25x,'ecis-inpa-228
     8223'/72x,'ecis-224'/' printing in the last result',44x,'ecis-225'/inpa-229
     96x,'16- lo(66) no calculation at equidistant angles.',18x,'ecis-22inpa-230
     a6'/6x,'17- lo(67) no plot of experimental data.',26x,'ecis-227'/6xinpa-231
     b,'18- lo(68) no plot of cross-sections at equidistant angles.',7x,inpa-232
     c'ecis-228'/6x,'19- lo(69) no plot of polarisations at equidistant inpa-233
     dangles.',8x,'ecis-229'/72x,'ecis-230'/' printing at the beginning inpa-234
     eand in a search',30x,'ecis-231'/6x,'21- lo(71) detailed output of inpa-235
     flogical controls.',19x,'ecis-232'/6x,'22- lo(72) no output of expeinpa-236
     grimental data when they are read.',5x,'ecis-233'/6x,'23- lo(73) noinpa-237
     h output of external potentials when they are read.   ecis-234'/6x,inpa-238
     i'24- lo(74) output of time in different steps of computation.',6x,inpa-239
     j'ecis-235'/6x,'25- lo(75) no complete output at the first run of ainpa-240
     k search.',7x,'ecis-236')                                          inpa-241
      write (2,1011)                                                    inpa-242
 1011 format (6x,'26- lo(76) lo(51) to lo(65) are always used-(inverse: inpa-243
     1only for',4x,'ecis-237'/17x,'complete output).',38x,'ecis-238'/6x,inpa-244
     2'27- lo(77) no output of time differences during the search.',7x,'inpa-245
     3ecis-239'/6x,'28- lo(78) no output of differences between experimeinpa-246
     4ntal and',6x,'ecis-240'/17x,'calculated values.',37x,'ecis-241'/72inpa-247
     5x,'ecis-242'/''/' compound nucleus',55x,'ecis-243'/6x,'31- lo(81)inpa-248
     6 hauser-feshbach corrections to cross-sections.',9x,'ecis-244'/17xinpa-249
     7,'with iterations, the code computes all the solutions.  ecis-245'inpa-250
     8/17x,'if lo(82), lo(84), lo(85) or lo(86) is .true., lo(81)  ecis-inpa-251
     9246'/17x,'is set .true..',41x,'ecis-247'/6x,'32- lo(82) old simpliinpa-252
     afied compound nucleus (excludes uncoupled',4x,'ecis-248'/17x,'statinpa-253
     bes, fission and gammas; lo(84), lo(85), lo(86) are ecis-249'/17x,'inpa-254
     cset .false.).',42x,'ecis-250'/6x,'33- lo(83) no engelbretch-weideninpa-255
     dmuller transformation in compound ecis-251'/17x,'nucleus.',47x,'ecinpa-256
     eis-252'/6x,'34- lo(84) uncoupled levels for compound nucleus. it iinpa-257
     fs set',7x,'ecis-253'/17x,'.false. if none are read.',30x,'ecis-254inpa-258
     g'/6x,'35- lo(85) fission transmission coefficients (to be read froinpa-259
     hm',5x,'ecis-255'/17x,'cards) for compound nucleus. it is set .falsinpa-260
     ie. if none ecis-256'/17x,'are read.',46x,'ecis-257'/6x,'36- lo(86)inpa-261
     j gamma emission in compound nucleus.',20x,'ecis-258'/6x,'37- lo(87inpa-262
     k) no width fluctuations.',33x,'ecis-259'/72x,'ecis-260')          inpa-263
      write (2,1012)                                                    inpa-264
 1012 format (' miscellaneous',58x,'ecis-261'/6x,'41- lo(91) angular disinpa-265
     1tribution at equidistant angles in the',6x,'ecis-262'/17x,'laboratinpa-266
     2ory system',38x,'ecis-263'/6x,'42- lo(92) pure dwba calculation.',inpa-267
     333x,'ecis-264'/6x,'43- lo(93) no recoil correction for reactions.'inpa-268
     4,20x,'ecis-265'/6x,'44- lo(94) non standard observables at equidisinpa-269
     5tant angles.',8x,'ecis-266'/6x,'48- lo(98) use of rest mass in dirinpa-270
     6ac equation.',20x,'ecis-267'/6x,'49- lo(99) schroedinger equivaleninpa-271
     7t to dirac equation. diffuseness ecis-268'/17x,'of coulomb potentiinpa-272
     8als must be 0. lo(11) and lo(19) are ecis-269'/17x,'set .false.. ninpa-273
     9o asymmetric rotational model and no',5x,'ecis-270'/17x,'second orinpa-274
     ader vibrational model: the corresponding',6x,'ecis-271'/17x,'logicinpa-275
     bal are set .false..',31x,'ecis-272'/6x,'50- lo(100) complete diracinpa-276
     c equation.',30x,'ecis-273'/72x,'ecis-274'/'card 4',34x,'format (14inpa-277
     di5)',19x,'ecis-275'/'******',66x,'ecis-276'/7x,'1- 5   ncoll  numbinpa-278
     eer of nuclear states. it does not include the  ecis-277'/21x,'numbinpa-279
     fer of uncoupled states for compound nucleus.   ecis-278'/7x,'6-10 inpa-280
     g  njmax  maximum number of channel spin. (default option 20)ecis-2inpa-281
     h79'/21x,'the maximum value of the total angular momentum j  ecis-2inpa-282
     i80'/21x,'will be njmax-1 when it is integer or njmax-.5 whenecis-2inpa-283
     j81'/21x,'it is half-integer.',32x,'ecis-282'/6x,'11-15   iterm  mainpa-284
     kximum number of ecis iterations. (default option ecis-283')       inpa-285
      write (2,1013)                                                    inpa-286
 1013 format (21x,'20). must be 1 for dwba calculations.',14x,'ecis-284'inpa-287
     1/6x,'16-20   npp',4x,'number of optical potentials. (default optioinpa-288
     2n 1).  ecis-285'/21x,'the first one is deformed when the form factinpa-289
     3ors',4x,'ecis-286'/21x,'are not read on cards.',29x,'ecis-287'/6x,inpa-290
     4'21-25   ncj',4x,'number of factorisations of 1/(1-cos(theta)) in'inpa-291
     5,4x,'ecis-288'/21x,'the amplitudes. (default option 1).',16x,'ecisinpa-292
     6-289'/6x,'26-30   ngr(1) number of decades in logarithmic scale ininpa-293
     7 plots of ecis-290'/21x,'elastic cross-sections in the standard opinpa-294
     8tion',6x,'ecis-291'/21x,'(default option 2). for charged particlesinpa-295
     9, the',5x,'ecis-292'/21x,'cross-section divided by rutherford''s cinpa-296
     aross-sectionecis-293'/21x,'is plotted.',40x,'ecis-294'/6x,'31-35  inpa-297
     b ngr(2) as ngr(1),for inelastic channels.(default option 2)ecis-29inpa-298
     c5'/6x,'36-40   npr(1) plot indications for elastic polarisations ainpa-299
     dt',6x,'ecis-296'/21x,'equidistant angles. if there are n differentinpa-300
     e',7x,'ecis-297'/21x,'angular distributions of polarisations, npr(1inpa-301
     f) is  ecis-298'/21x,'the sum for i=1 to n of k(i)*(2**(i-1)) whereinpa-302
     g',6x,'ecis-299'/21x,'k(i)=1 for a plot and 0 for no plot of the i-inpa-303
     hth',4x,'ecis-300'/21x,'distribution.(default option 1)',20x,'ecis-inpa-304
     i301'/14x,'standard options: spin 0 - no polarisation.',15x,'ecis-3inpa-305
     j02'/32x,'spin 1/2 - vector polarisation.',9x,'ecis-303'/32x,'spin inpa-306
     k>1/2 - it11, t20, t21, t22.',8x,'ecis-304'/'')                    inpa-307
      write (2,1014)                                                    inpa-308
 1014 format (6x,'41-45   npr(2) as npr(1),for inelastic channels.(defauinpa-309
     1lt option 1)ecis-305'/14x,'standard options: spin 0 - no polarisatinpa-310
     2ion.',15x,'ecis-306'/22x,'spin 1/2 - vect. ana. power, vect. pol.,inpa-311
     3 spin-flipecis-307'/22x,'spin >1/2 - it11, vect. pol., t20, t21, tinpa-312
     422.',6x,'ecis-308'/6x,'46-50   lmz',4x,'number of j values for whiinpa-313
     5ch the radial equations  ecis-309'/21x,'are solved when coulomb coinpa-314
     6rrections are used. this ecis-310'/21x,'number can be automaticallinpa-315
     7y decreased if the',7x,'ecis-311'/21x,'irregular functions are tooinpa-316
     8 large. the asymptotic  ecis-312'/21x,'region where the phase-shifinpa-317
     9ts are computed',9x,'ecis-313'/21x,'analytically is above this valinpa-318
     aue. the best value ofecis-314'/21x,'lmz is the maximum value of j inpa-319
     bneeded by the same   ecis-315'/21x,'computation without charge andinpa-320
     c without anomalous   ecis-316'/21x,'magnetic moment. (default optiinpa-321
     don njmax/2, but enterecis-317'/21x,'a negative value if you want tinpa-322
     eo use njmax).',8x,'ecis-318'/6x,'51-55   jdm',4x,'total spin aboveinpa-323
     f which stop or reduction to one',4x,'ecis-319'/21x,'iteration can inpa-324
     goccur. (limits lo(25),lo(28)=.false.)ecis-320'/6x,'56-60   lml',4xinpa-325
     h,'maximum angular momentum (default option maximum). ecis-321'/21xinpa-326
     i,'without long range interaction, a limit is given   ecis-322'/21xinpa-327
     j,'for each level such that the regular coulomb',7x,'ecis-323'/21x,inpa-328
     k'function is larger than 1.d-30 at matching radius. ecis-324')    inpa-329
      write (2,1015)                                                    inpa-330
 1015 format (6x,'61-65   jit',4x,'number of rates of interpolation for inpa-331
     1total spin.   ecis-325'/21x,'(default value 1).',33x,'ecis-326'/6xinpa-332
     2,'66-70   mn',5x,'multiplicative factor for njmax read in columns'inpa-333
     3,4x,'ecis-327'/21x,'6-10 allowing to use more than njmax>10**5.',8inpa-334
     4x,'ecis-328'/21x,'(default value 1)',34x,'ecis-329'/'  note:  if linpa-335
     5o(94)=.true. ngr and npr are not taken into account in',5x,'ecis-3inpa-336
     630'/'  ****  computations at equidistant angles because such indicinpa-337
     7ations willecis-331'/8x,'be read again, but ngr is always used forinpa-338
     8 plots of experimental ecis-332'/8x,'cross-sections.',49x,'ecis-33inpa-339
     93'/72x,'ecis-334'/'card 5',34x,'format (7f10.5)',17x,'ecis-335'/'*inpa-340
     a*****',66x,'ecis-336'/8x,'1-10   h',5x,'integration step size in finpa-341
     bermis. (default option   ecis-337'/21x,'min(0.5/wave number, 0.5*minpa-342
     cin(diffusenesses)),',6x,'ecis-338'/21x,'without the diffusenesses inpa-343
     dif lo(7)=.true.).',8x,'ecis-339'/7x,'11-20   rm',4x,'matching radiinpa-344
     eus.(if lo(7)=.true. default option 20.ecis-340'/21x,'if lo(7)=.falinpa-345
     fse., for each non zero potential, the ecis-341'/21x,'radius where inpa-346
     gits absolute value is (aconv*ecm/wave ecis-342'/21x,'number) is coinpa-347
     hmputed and rm is the largest of them. ecis-343'/21x,'for coulomb finpa-348
     iorm factors, radius+10*diffuseness is ecis-344'/21x,'used)',46x,'einpa-349
     jcis-345'/7x,'21-30   bjm   coefficient of the imaginary potential inpa-350
     kto be added ecis-346')                                            inpa-351
      write (2,1016)                                                    inpa-352
 1016 format (21x,'to the uncoupled equations and removed in the',6x,'ecinpa-353
     1is-347'/21x,'second member to accelerate convergence for',8x,'ecisinpa-354
     2-348'/21x,'schroedinger equations.',28x,'ecis-349'/7x,'31-40   eitinpa-355
     3er convergence criterion for s-matrix in the iterationecis-350'/21inpa-356
     4x,'(default option 1.d-5).',28x,'ecis-351'/7x,'41-50   aconv valueinpa-357
     5 below which functions and potentials are',5x,'ecis-352'/21x,'neglinpa-358
     6ected in iterations.(default option 1.d-5).',4x,'ecis-353'/21x,'acinpa-359
     7onv is also used in the default value of rm.',5x,'ecis-354'/7x,'51inpa-360
     8-60   conj  convergence criterion for j values.',16x,'ecis-355'/21inpa-361
     9x,'(default option 1.d-5).',28x,'ecis-356'/72x,'ecis-357'/'limitatinpa-362
     aion of job time',18x,'format (14i5)',19x,'ecis-358'/'*************inpa-363
     b*********',50x,'ecis-359'/'  if lo(34) is .true., otherwise go to inpa-364
     c''limitation to coulomb corr... '' ecis-360'/7x,'1- 5   msec   timinpa-365
     de allowed for the job in seconds, used only for ecis-361'/21x,'a sinpa-366
     eearch limited by this time. (default value 3600)ecis-362'/7x,'6-10inpa-367
     f   nsec   time needed at the end of a search to print final  ecis-inpa-368
     g363'/21x,'results in hundredths of second.(default value 100)ecis-inpa-369
     h364'/72x,'ecis-365'/''/'limitation to coulomb corrections',7x,'foinpa-370
     irmat (14i5)',19x,'ecis-366'/'*********************************',39inpa-371
     jx,'ecis-367'/'  if lo(45) is .true., otherwise go to ''legendre exinpa-372
     kpansion data''',8x,'ecis-368')                                    inpa-373
      write (2,1017)                                                    inpa-374
 1017 format (7x,'1- 5   mcm(1)  maximum angular momentum for the computinpa-375
     1ation of   ecis-369'/22x,'the corrections due to the coulomb poteninpa-376
     2tial.',5x,'ecis-370'/22x,'(default option 3, value limited to 5).'inpa-377
     3,11x,'ecis-371'/7x,'6-10   mcm(2)  same for the spin-orbit coulombinpa-378
     4 potential.',8x,'ecis-372'/22x,'(default option 2, value limited tinpa-379
     5o 4).',11x,'ecis-373'/' note:  enter a negative value to use 0. a inpa-380
     6blank or 0 is replaced by',4x,'ecis-374'/' *****  the default optiinpa-381
     7ons described above.',28x,'ecis-375'/72x,'ecis-376'/'legendre expainpa-382
     8nsion data',17x,'format (14i5)',19x,'ecis-377'/'******************inpa-383
     9*****',49x,'ecis-378'/'  if lo(65) is .true., otherwise go to ''coinpa-384
     ampound nucleus data''.',9x,'ecis-379'/7x,'1- 5   nl(1)  power of (inpa-385
     b1-cos(theta)) for the expansion in',7x,'ecis-380'/21x,'legendre poinpa-386
     clynomials of the interference between   ecis-381'/21x,'coulomb andinpa-387
     d nuclear elastic scattering. power of   ecis-382'/21x,'(1-cos(thetinpa-388
     ea)**2) if lo(18) is .true..',13x,'ecis-383'/21x,'(default option 2inpa-389
     f).',32x,'ecis-384'/7x,'6-10   nl(2)  number of legendre polynomialinpa-390
     gs for elastic',9x,'ecis-385'/21x,'scattering of charged particles.inpa-391
     h (default option   ecis-386'/21x,'1.5 number obtained without coulinpa-392
     iomb amplitude).',4x,'ecis-387'/6x,'11-15   nl(3)  number of legendinpa-393
     jre polynomials for elastic',9x,'ecis-388'/21x,'scattering of unchainpa-394
     krged particles, inelastic',7x,'ecis-389')                         inpa-395
      write (2,1018)                                                    inpa-396
 1018 format (21x,'scattering and compound nucleus. (default option   ecinpa-397
     1is-390'/21x,'maximum number).',35x,'ecis-391'/72x,'ecis-392'/'compinpa-398
     2ound nucleus data',19x,'format (8i5,2f10.5)',13x,'ecis-393'/'*****inpa-399
     3****************',51x,'ecis-394'/'  if lo(84) or lo(85) or lo(86) inpa-400
     4is .true., otherwise go to',14x,'ecis-395'/'  ''interpolation on tinpa-401
     5otal spin''.',40x,'ecis-396'/7x,'1- 5   nsp(1) number of uncoupledinpa-402
     6 states and continua. if is',5x,'ecis-397'/21x,'replaced by min(nsinpa-403
     7p(1),nsp(2)). if it is zero,',5x,'ecis-398'/21x,'lo(84)=.false.',3inpa-404
     87x,'ecis-399'/7x,'6-10   nsp(2) number of uncoupled states with aninpa-405
     9gular',12x,'ecis-400'/21x,'distribution. they must be the first giinpa-406
     aven.',8x,'ecis-401'/6x,'11-15   nfiss  number of fission data. if inpa-407
     bnfiss=0, lo(85)=.false. ecis-402'/6x,'16-20   nrd',4x,'number of ginpa-408
     camma transmission factors. if it is 0,  ecis-403'/21x,'these coeffinpa-409
     dicients are computed.',19x,'ecis-404'/6x,'21-25   ncont  number ofinpa-410
     e continua. they must be the last given,   ecis-405'/21x,'no angulainpa-411
     fr distribution can be requested for them. ecis-406'/6x,'26-30   ncinpa-412
     goj   number of values of the spin of the residual',7x,'ecis-407'/2inpa-413
     h1x,'nucleus for the continua. (default option 30).',5x,'ecis-408'/inpa-414
     i6x,'31-35   kmin   minimum number of j values for compound nucleusinpa-415
     j',4x,'ecis-409'/21x,'(default option: minimum value for s waves ininpa-416
     k',6x,'ecis-410'/21x,'entrance channel).',33x,'ecis-411')          inpa-417
      write (2,1019)                                                    inpa-418
 1019 format (6x,'36-40   kmax   maximum number of j values for compoundinpa-419
     1 nucleus',4x,'ecis-412'/21x,'(default option njmax).',28x,'ecis-41inpa-420
     23'/6x,'41-50   acn1   ratio energy/step for the discretisation of inpa-421
     3the',4x,'ecis-414'/21x,'continua at large energy . (default optioninpa-422
     4 8.).',4x,'ecis-415'/6x,'51-60   acn2   number of steps per mev foinpa-423
     5r the discretisation of  ecis-416'/21x,'the continua at low energyinpa-424
     6. (default option 8.).   ecis-417'/'  note:  the shift from the usinpa-425
     7e of acn1 to acn2 occurs below the energy ecis-418'/'  ****  acn1/inpa-426
     8acn2. below this energy, the interval is divided in equal  ecis-41inpa-427
     99'/4x,'steps with a minimum of two steps. calculations are done wiinpa-428
     ath the   ecis-420'/4x,'energy of the middle of the step.',35x,'eciinpa-429
     bs-421'/9x,'without kmin the calculation can stop before any signifinpa-430
     cicant   ecis-422'/4x,'result. with interpolation on total spin belinpa-431
     dow kmax, a huge storage ecis-423'/4x,'array, proportional to kmax,inpa-432
     e is needed for uncoupled states with',4x,'ecis-424'/4x,'angular diinpa-433
     fstribution.',47x,'ecis-425'/''/9x,'compound nucleus calculation iinpa-434
     gs stopped at the j value larger  ecis-426'/4x,'than kmin one for winpa-435
     hhich the largest compound nucleus contribution isecis-427'/4x,'lesinpa-436
     is than conj**2. the code cannot deal with very large j values.   einpa-437
     jcis-428'/72x,'ecis-429'/'interpolation on total spin',13x,'format inpa-438
     k(14i5)',19x,'ecis-430')                                           inpa-439
      write (2,1020)                                                    inpa-440
 1020 format ('***************************',45x,'ecis-431'/'  if lo(43) inpa-441
     1is .true., otherwise go to  ''cards read in subroutine lect''.ecisinpa-442
     2-432'/8x,'1- 5   ls(1) first limit.',39x,'ecis-433'/8x,'6-10   ld(inpa-443
     31) number of values skipped.',26x,'ecis-434'/7x,'11-15   ls(2) secinpa-444
     4ond limit.',38x,'ecis-435'/7x,'16-20   ld(2) number of values skipinpa-445
     5ped.',26x,'ecis-436'/3x,'....................  up to ls(jit) and linpa-446
     6d(jit)   ...................ecis-437'/7x,'the calculation is stoppinpa-447
     7ed if values ls decrease. the values ld  ecis-438'/' are changed tinpa-448
     8o be used cumulatively in the program. if lo(18)=.true.,  ecis-439inpa-449
     9'/' and the spins in the ground state are both zero, the values ldinpa-450
     a read areecis-440'/' multiplied by 2.',55x,'ecis-441'/72x,'ecis-44inpa-451
     b2'/72x,'ecis-443'/'cards read in subroutine lecl',43x,'ecis-444'/'inpa-452
     c*****************************',43x,'ecis-445'/72x,'ecis-446'/'for inpa-453
     deach nuclear state:',49x,'ecis-447'/'***********************',49x,inpa-454
     e'ecis-448'/6x,'beginning with the ground-state and including uncouinpa-455
     fpled states forecis-449'/6x,'compound nucleus calculation which muinpa-456
     gst be at the end.',12x,'ecis-450'/6x,'the best order is the one ofinpa-457
     h decreasing coupling strength.',8x,'ecis-451'/72x,'ecis-452'/'nuclinpa-458
     iear states -spins and masses -',6x,'format (f5.2,2i2,a1,5f10.5)',5inpa-459
     jx,'ecis-453'/'***********************************',37x,'ecis-454')inpa-460
      write (2,1021)                                                    inpa-461
 1021 format (7x,'1- 5   sp2: spin of the target (2*sp2+1 kept in ipi(3,inpa-462
     1i)).',7x,'ecis-455'/7x,'6- 7   n:   further description of the stainpa-463
     2te.',20x,'ecis-456'/14x,'in the rotational model, must be non-zeroinpa-464
     3 for the member  ecis-457'/22x,'of a vibrational band.',28x,'ecis-inpa-465
     4458'/14x,'in the vibrational model, can be non-zero for the groundinpa-466
     5  ecis-459'/22x,'state to avoid the input of next card.',12x,'ecisinpa-467
     6-460'/14x,'not used if lo(3) = .true. (anharmonic vibrational  modinpa-468
     7el ecis-461'/22x,'or asymmetric rotational model), if lo(7) = .truinpa-469
     8e.ecis-462'/22x,'(external potentials) and uncoupled states.',7x,'inpa-470
     9ecis-463'/7x,'8- 9   k:   optical potential. (default option,1 forinpa-471
     a ground-stateecis-464'/19x,'and same as last one for excited stateinpa-472
     b).',13x,'ecis-465'/9x,'10   spi: parity of the nuclear state: ''+'inpa-473
     c' or ''-'' but only ''-'' ecis-466'/19x,'is needed (''+'' for a blinpa-474
     dank or any other character).  ecis-467'/19x,'this data is kept as inpa-475
     e0 or 1 in ipi(1,i).',13x,'ecis-468'/6x,'11-20   energy of the projinpa-476
     fectile in the laboratory system in mev  ecis-469'/14x,'for the groinpa-477
     gund state. excitation energy for the others.   ecis-470'/6x,'21-30inpa-478
     h   sp1: spin of the particle (2*sp1+1 kept in ipi(2,i)).',5x,'ecisinpa-479
     i-471'/6x,'31-40   wv(1,i):   mass of the projectile in a.m.u.  .',inpa-480
     j12x,'ecis-472'/19x,'if this value is not zero for an excited stateinpa-481
     k, the  ecis-473')                                                 inpa-482
      write (2,1022)                                                    inpa-483
 1022 format (19x,'spin of the projectile, its mass and the product of  inpa-484
     1ecis-474'/19x,'charges read on this card are taken into account. iinpa-485
     2f ecis-475'/19x,'this mass is zero, values of sp1, sp2, sp3, wv(1,inpa-486
     3i)  ecis-476'/19x,'and wv(2,i) are taken from the preceding level.inpa-487
     4',6x,'ecis-477'/6x,'41-50   wv(2,i):   mass of the target in a.m.uinpa-488
     5.  .',16x,'ecis-478'/6x,'51-60   sp3: product of the charges of thinpa-489
     6e target and of the',6x,'ecis-479'/19x,'particle (sp3 kept in ipi(inpa-490
     74,iv)).',20x,'ecis-480'/'  note:  only this card is read for uncouinpa-491
     8pled states and continua',7x,'ecis-481'/'  ****  used for compoundinpa-492
     9 nucleus calculation.',26x,'ecis-482'/72x,'ecis-483'/''/'descriptinpa-493
     aion of vibrations  (if n is not 0 in rotational model or n is 0 ecinpa-494
     bis-484'/'*************************  in vibrational model and lo(3)inpa-495
     c=lo(7)=.false.)ecis-485'/72x,'ecis-486'/'number of phonons',23x,'finpa-496
     dormat (14i5)',19x,'ecis-487'/'*****************',55x,'ecis-488'/7xinpa-497
     e,'1- 5   iph(i)  description of the state.',25x,'ecis-489'/14x,'ininpa-498
     f the vibrational model: 0 for ground state',14x,'ecis-490'/22x,'1 inpa-499
     gor 2 for pure 1 or 2-phonons state',14x,'ecis-491'/22x,'3 for a miinpa-500
     hxture of 1 and 2-phonons states.',8x,'ecis-492'/14x,'in the rotatiinpa-501
     ional model: 0 for ground-state band',10x,'ecis-493'/39x,'1 for vibinpa-502
     jrational band',11x,'ecis-494'/39x,'2 for a mixture of them',10x,'einpa-503
     kcis-495')                                                         inpa-504
      write (2,1023)                                                    inpa-505
 1023 format (7x,'6-10   rotational model: number of the vibration in thinpa-506
     1e order of ecis-496'/14x,'input. (see ''cards read in lect'')',25xinpa-507
     2,'ecis-497'/14x,'vibrational model: number of the phonon of the oninpa-508
     3e-phonon ecis-498'/14x,'state or of the first phonon of the two-phinpa-509
     4onons state.',4x,'ecis-499'/6x,'11-15   vibrational model: number inpa-510
     5of the second phonon of the',5x,'ecis-500'/14x,'two-phonons state.inpa-511
     6',40x,'ecis-501'/6x,'16-20   vibrational model: number of the one-inpa-512
     7phonon component of  ecis-502'/14x,'a mixed state.',44x,'ecis-503'inpa-513
     8/'  note:  the total number of phonons will be the largest number inpa-514
     9read',4x,'ecis-504'/'  ****  in the columns 6 to 20.',41x,'ecis-50inpa-515
     a5'/72x,'ecis-506'/'phonons mixing parameter',16x,'format (7f10.5)'inpa-516
     b,17x,'ecis-507'/'************************',48x,'ecis-508'/'  if ipinpa-517
     ch is 3 (vibrational model) or iph is 2 (rotational model)',8x,'eciinpa-518
     ds-509'/7x,'1-10   bt in degrees.',44x,'ecis-510'/6x,'the nuclear sinpa-519
     etate is:  cos(bt)*(1 phonon) + sin(bt)*(2 phonons).  ecis-511'/14xinpa-520
     f,'or:  cos(bt)*(vibr. band) + sin(bt)*(ground band).',8x,'ecis-512inpa-521
     g'/72x,'ecis-513'/'for asymmetric rotational model',41x,'ecis-514'/inpa-522
     h'*******************************',41x,'ecis-515'/' if lo(1)=lo(3)=inpa-523
     i.true.',50x,'ecis-516'/5x,'there are n=sp(*,4)/2 band mixing paraminpa-524
     jeters between the n+1 bands ecis-517'/'  defined as atan(a(2*i)/a(inpa-525
     k2*i-2)) where a(i) is the amplitude of band iecis-518')           inpa-526
      write (2,1024)                                                    inpa-527
 1024 format (5x,'if n is not 0 and the reduced matrix elements are not inpa-528
     1read on cardsecis-519'/72x,'ecis-520'/'mixing parameters',23x,'forinpa-529
     2mat (7f10.5)',17x,'ecis-521'/'*****************',55x,'ecis-522'/7xinpa-530
     3,'1-10   bt(1)  in degrees.',40x,'ecis-523'/6x,'11-20   bt(2)  in inpa-531
     4degrees.',40x,'ecis-524'/6x,'21-30   bt(3)  in degrees.',40x,'ecisinpa-532
     5-525'/6x,'31-40   bt(4)  in degrees.',40x,'ecis-526'/6x,'41-50   binpa-533
     6t(5)  in degrees.',40x,'ecis-527'/6x,'51-60   .................',4inpa-534
     71x,'ecis-528'/6x,'the nuclear state is:   cos(bt(1))*y(ai,0) + sininpa-535
     8(bt(1))*cos(bt(2))ecis-529'/6x,'*(y(ai,2)+s*y(ai,-2))*sqrt(0.5) + inpa-536
     9sin(bt(1))*sin(bt(2))*cos(bt(3))ecis-530'/6x,'*(y(ai,4)+s*y(ai,-4)inpa-537
     a)*sqrt(0.5) + ....... where s=(-)**(ai+spi).  ecis-531'/'  note: finpa-538
     bor unnatural parity states (spi=-), bt(1) will be ignored in   eciinpa-539
     cs-532'/'  **** the calculation and replaced by 90. degrees.',21x,'inpa-540
     decis-533'/8x,'if lo(15)=.true., all the nuclear parameters (quantiinpa-541
     eties given  ecis-534'/4x,'in degrees) have to be read in order to inpa-542
     favoid a change in this part ecis-535'/4x,'of input when shifting linpa-543
     go(15) from .false. to .true..  they are not ecis-536'/4x,'used andinpa-544
     h cannot be in search.',39x,'ecis-537'/72x,'ecis-538'/72x,'ecis-539inpa-545
     i'/'cards read in subroutine lect',43x,'ecis-540'/'****************inpa-546
     j*************',43x,'ecis-541'/72x,'ecis-542'/''/'phonon descriptiinpa-547
     kons',21x,'format (2i5,f10.5,i5)',11x,'ecis-543')                  inpa-548
      write (2,1025)                                                    inpa-549
 1025 format ('*******************',53x,'ecis-544'/'for every phonon invinpa-550
     1olved',47x,'ecis-545'/7x,'1- 5   nbta(9,*) = l angular momentum usinpa-551
     2ed also for heavy ion',4x,'ecis-546'/7x,'6-10   nbta(10,*) = k maginpa-552
     3netic quantum number of the vibration inecis-547'/21x,'rotational inpa-553
     4model. in the vibrational model, must beecis-548'/21x,'zero to useinpa-554
     5 this phonon in l=0 second order terms. ecis-549'/6x,'11-20   betainpa-555
     6(1,*)   phonon amplitude for the real potential.',6x,'ecis-550'/6xinpa-556
     7,'21-25   ik   level of which the masses are used for heavy-ion',5inpa-557
     8x,'ecis-551'/21x,'corrections. (default option ik=1).',16x,'ecis-5inpa-558
     952'/72x,'ecis-553'/'phonon amplitudes of other potentials   formatinpa-559
     a (7f10.5)',17x,'ecis-554'/'*************************************',inpa-560
     b35x,'ecis-555'/6x,'if deformations are not the same for all potentinpa-561
     cials (lo(5)=.true.)ecis-556'/7x,'1-10   beta(2,*) for volume imagiinpa-562
     dnary potential.',17x,'ecis-557'/6x,'11-20   beta(3,*) for surface inpa-563
     ereal potential.',21x,'ecis-558'/6x,'21-30   beta(4,*) for surface inpa-564
     fimaginary potential.',16x,'ecis-559'/6x,'31-40   beta(5,*) for reainpa-565
     gl spin-orbit.',28x,'ecis-560'/6x,'41-50   beta(6,*) for imaginary inpa-566
     hspin-orbit.',23x,'ecis-561'/6x,'51-60   beta(7,*) for coulomb poteinpa-567
     intial.',26x,'ecis-562'/6x,'61-70   beta(8,*) for coulomb spin-orbiinpa-568
     jt potential.',15x,'ecis-563'/'  note:  if lo(5)=.false., beta(i,*)inpa-569
     k=beta(1,*) for i=2,8.',15x,'ecis-564'/'  ****',66x,'ecis-565')    inpa-570
      write (2,1026)                                                    inpa-571
 1026 format (72x,'ecis-566'/'deformations of rotational model',8x,'forminpa-572
     1at (2i5,f10.5,i5)',11x,'ecis-567'/'*******************************inpa-573
     2*',40x,'ecis-568'/' only if lo(1)=.true. and lo(7)=.false., otherwinpa-574
     3ise go to ''optical model ecis-569'/' parameters''.',59x,'ecis-570inpa-575
     4'/7x,'1- 5   iqm',4x,'largest order of deformation.',22x,'ecis-571inpa-576
     5'/7x,'6-10   iqmax  maximum l-value of multipole expansion.',12x,'inpa-577
     6ecis-572'/6x,'11-20   aspin, the k-value of the band, used only ininpa-578
     7 symmetric',4x,'ecis-573'/21x,'rotational model.',34x,'ecis-574'/6inpa-579
     8x,'21-25   ik',5x,'level of which the masses are used for heavy-ioinpa-580
     9n   ecis-575'/21x,'corrections. (default option ik=1).',16x,'ecis-inpa-581
     a576'/'  note:  in the asymmetric rotational model iqm is limited tinpa-582
     bo 35',8x,'ecis-577'/'  ****  and iqmax is limited to 8.',38x,'ecisinpa-583
     c-578'/72x,'ecis-579'/'deformations of real volume potential   forminpa-584
     dat (7f10.5)',17x,'ecis-580'/'*************************************inpa-585
     e',35x,'ecis-581'/4x,'iq = iqm/2 values for symmetric rotational moinpa-586
     fdel',20x,'ecis-582'/4x,'iq = iqm-1 values for asymmetric rotationainpa-587
     gl model',19x,'ecis-583'/7x,'1-10   beta(1,1)  deformation of the rinpa-588
     heal potential.',13x,'ecis-584'/6x,'11-20   beta(1,2)  deformation inpa-589
     iof the real potential.',13x,'ecis-585'/6x,'21-30   beta(1,3)  defoinpa-590
     jrmation of the real potential.',13x,'ecis-586'/6x,'31-40   beta(1,inpa-591
     k4)  deformation of the real potential.',13x,'ecis-587')           inpa-592
      write (2,1027)                                                    inpa-593
 1027 format (6x,'41-50   beta(1,5)  deformation of the real potential.'inpa-594
     1,13x,'ecis-588'/'...............................',41x,'ecis-589'/6inpa-595
     2x,'eventually, on next card:',9x,'format (7f10.5)',17x,'ecis-590'/inpa-596
     37x,'1-10   beta(1,8)  deformation of the real potential.',13x,'eciinpa-597
     4s-591'/6x,'11-20   beta(1,9)  deformation of the real potential. .inpa-598
     5...',8x,'ecis-592'/6x,'..... and so on up to beta(1,iq).',33x,'eciinpa-599
     6s-593'/72x,'ecis-594'/'deformations for other potentials',7x,'forminpa-600
     7at (7f10.5)',17x,'ecis-595'/'*********************************',39inpa-601
     8x,'ecis-596'/6x,'if deformations are not the same for all potentiainpa-602
     9ls (lo(5)=.true.)ecis-597'/7x,'1-10   beta(2,i) deformation of theinpa-603
     a volume imaginary potential.  ecis-598'/6x,'11-20   beta(3,i) defoinpa-604
     brmation of the surface real potential.',6x,'ecis-599'/6x,'21-30   inpa-605
     cbeta(4,i) deformation of the surface imaginary potential. ecis-600inpa-606
     d'/6x,'31-40   beta(5,i) deformation for the real spin-orbit.',12x,inpa-607
     e'ecis-601'/''/6x,'41-50   beta(6,i) deformation for the imaginaryinpa-608
     f spin-orbit.',7x,'ecis-602'/6x,'51-60   beta(7,i) deformation for inpa-609
     gthe coulomb potential.',10x,'ecis-603'/6x,'61-70   beta(8,i) deforinpa-610
     hmation for the coulomb spin-orbit.',9x,'ecis-604'/' there are iq sinpa-611
     iuch cards',48x,'ecis-605'/'  note:  if lo(5)=.false., beta(i,j)=beinpa-612
     jta(1,j) for i=2,6 and j=1,iq.',4x,'ecis-606'/'  ****',66x,'ecis-60inpa-613
     k7'/72x,'ecis-608')                                                inpa-614
      return                                                            inpa-615
      end                                                               inpa-616
c 29/02/04                                                      ecis03  inpb-000
      subroutine inpb                                                   inpb-001
      write (2,1028)                                                    inpb-002
 1028 format ('explanation of deformations of the rotational model:',20xinpb-003
     1,'ecis-609'/'****************************************************'inpb-004
     2,20x,'ecis-610'/'for symmetric rotational model  (lo(3)=.false.)',inpb-005
     325x,'ecis-611'/7x,'the order of deformation is l=2, 4, 6, ... and inpb-006
     4so on.',12x,'ecis-612'/7x,'the radial dependence of potentials is:inpb-007
     5',26x,'ecis-613'/10x,'r = r0*(1 + beta(*,1)*y(2,0).+ beta(*,2)*y(4inpb-008
     6,0) + .....)',6x,'ecis-614'/10x,'odd order deformations are not reinpb-009
     7ad.',26x,'ecis-615'/72x,'ecis-616'/'for the asymmetric rotational inpb-010
     8model (lo(3)=.true.)',22x,'ecis-617'/7x,'the order of deformationsinpb-011
     9 are (l,k)=(2,0), (2,2), (4,0), (4,2),  ecis-618'/10x,'(4,4), (6,0inpb-012
     a) .... and so on. there are limited to (8,8).',6x,'ecis-619'/7x,'tinpb-013
     bhe radial dependence of potentials is:',26x,'ecis-620'/10x,'r = r0inpb-014
     c*(1 + beta(*,1)*(cos(beta(*,2))*y(2,0)+sin(beta(*,2))*  ecis-621'/inpb-015
     d10x,'(y(2,2)+y(2,-2))*sqrt(0.5)) + beta(*,3)*(cos(beta(*,4))*y(4,0inpb-016
     e)ecis-622'/10x,'+sin(beta(*,4)*(cos(beta(*,5))*(y(4,2)+y(4,-2))*sqinpb-017
     frt(0.5))',4x,'ecis-623'/10x,'+sin(beta(*,5))*(y(4,4)+y(4,-4))*sqrtinpb-018
     g(0.5)) + ..............  ecis-624'/3x,'the ''gamma'' type betas asinpb-019
     h beta(*,i) for i=2,4,5,7... are in degrees. ecis-625'/3x,'********inpb-020
     i************************************************************ ecis-inpb-021
     j626'/'for the constrained asymmetric rotational model, when lo(2)=inpb-022
     k.true., the ecis-627')                                            inpb-023
      write (2,1029)                                                    inpb-024
 1029 format (7x,'band mixing coefficients are calculated from ''gamma''inpb-025
     1=beta(*,2)   ecis-628'/7x,'in the davydov-filippov model. the sequinpb-026
     2ence of states must be',4x,'ecis-629'/7x,'the ground state, the fiinpb-027
     3rst 2+, the second 2+,the other states   ecis-630'/7x,'described ainpb-028
     4s in the general case (there can be only the ground   ecis-631'/7xinpb-029
     5,'state and the first 2+). the mixing parameter of the first 2+',4inpb-030
     6x,'ecis-632'/7x,'state is used as ''gamma'' value instead of beta(inpb-031
     71,2), but the',5x,'ecis-633'/7x,'differences between beta(i,3) areinpb-032
     8 kept. the mixing parameter',5x,'ecis-634'/7x,'of the second 2+ stinpb-033
     9ate is ignored. in a search, the index 4001   ecis-635'/7x,'shouldinpb-034
     a be used instead of 2002 or 3011 for ''gamma''.',14x,'ecis-636'/72inpb-035
     bx,'ecis-637'/'deformations of anharmonic vibrational model',28x,'einpb-036
     ccis-638'/'********************************************',28x,'ecis-inpb-037
     d639'/'  note:  in this model, there is an unique ratio 1/sqrt(4*piinpb-038
     e) for any   ecis-640'/'  ****  order of deformation. to be consistinpb-039
     fent with the harmonic',8x,'ecis-641'/8x,'vibrational model, the deinpb-040
     gformations indicated below should be   ecis-642'/8x,'beta, beta**2inpb-041
     h/sqrt(4*pi) and beta**3/(4*pi) respectively.',7x,'ecis-643'/72x,'einpb-042
     icis-644'/'deformations',28x,'format (7f10.5)',17x,'ecis-645'/'****inpb-043
     j********',60x,'ecis-646'/' only if lo(1)=.false. and .lo(3)=.true.inpb-044
     k, lo(5) or lo(16)=.true.,',7x,'ecis-647')                         inpb-045
      write (2,1030)                                                    inpb-046
 1030 format (' otherwise go to ''optical model parameters''.',28x,'ecisinpb-047
     1-648'/7x,'1-10   beta(1,*) for central potential.',26x,'ecis-649'/inpb-048
     26x,'11-20   beta(2,*) for volume imaginary potential.',17x,'ecis-6inpb-049
     350'/6x,'21-30   beta(3,*) for surface real potential.',21x,'ecis-6inpb-050
     451'/6x,'31-40   beta(4,*) for surface imaginary potential.',16x,'einpb-051
     5cis-652'/6x,'41-50   beta(5,*) for real spin-orbit.',28x,'ecis-653inpb-052
     6'/6x,'51-60   beta(6,*) for imaginary spin-orbit.',23x,'ecis-654'/inpb-053
     76x,'61-70   beta(7,*) for coulomb potential.',26x,'ecis-655'/72x,'inpb-054
     8ecis-656'/'  next card:',28x,'format (7f10.5)',17x,'ecis-657'/'  *inpb-055
     9*********',60x,'ecis-658'/7x,'1-10   beta(8,*) for coulomb spin-orinpb-056
     abit potential.',15x,'ecis-659'/'there are four sets of such cards,inpb-057
     b one for each order of deformation.   ecis-660'/72x,'ecis-661'/''inpb-058
     c/'angular momenta',25x,'format (14i5)',19x,'ecis-662'/'***********inpb-059
     d****',57x,'ecis-663'/' only if lo(16)=.true., otherwise go to ''deinpb-060
     eformations''.(if lo(6)=.true.,ecis-664'/'heavy-ion definition do ninpb-061
     fot change non coulomb deformation lengths).',4x,'ecis-665'/8x,'1- inpb-062
     g5  for zeroth order (default 2). (not used)',18x,'ecis-666'/8x,'6-inpb-063
     h10  for first order (default 2).',30x,'ecis-667'/7x,'11-15  for seinpb-064
     icond order (default 2).',29x,'ecis-668'/7x,'16-20  for third orderinpb-065
     j (default 2).',30x,'ecis-669'/7x,'21-25  ik   level of which the minpb-066
     kasses are used for heavy-ion',5x,'ecis-670')                      inpb-067
      write (2,1031)                                                    inpb-068
 1031 format (14x,'corrections. (default option ik=1).',23x,'ecis-671'/9inpb-069
     1x,'enter a negative value if you want 0.',26x,'ecis-672'/72x,'ecisinpb-070
     2-673'/'optical potential parameters',44x,'ecis-674'/'*************inpb-071
     3***************',44x,'ecis-675'/'npp loops to ''equidistant anglesinpb-072
     4'' if lo(7)=.false. and lo(10)=.false.   ecis-676'/'  if lo(7)=.trinpb-073
     5ue. and lo(10)=.true. go to ''dispersion parameters'' in',4x,'ecisinpb-074
     6-677'/'  this loop, if lo(7)=.true. and lo(10)=.false. skip them.'inpb-075
     7,14x,'ecis-678'/72x,'ecis-679'/'the program searches to which nuclinpb-076
     8ear level the potential belongs. if   ecis-680'/'  none is found, inpb-077
     9a warning is printed and the first one is chosen.',6x,'ecis-681'/7inpb-078
     a2x,'ecis-682'/'volume or scalar real potential',9x,'format (3f10.5inpb-079
     b)',17x,'ecis-683'/'*******************************',41x,'ecis-684'inpb-080
     c/7x,'1-10   val(1)   depth in mev.',36x,'ecis-685'/6x,'11-20   valinpb-081
     d(2)   reduced radius in fermis.',24x,'ecis-686'/6x,'21-30   val(3)inpb-082
     e   diffuseness in fermis.',27x,'ecis-687'/72x,'ecis-688'/'volume oinpb-083
     fr scalar imaginary potential',4x,'format (3f10.5)',17x,'ecis-689'/inpb-084
     g'************************************',36x,'ecis-690'/7x,'1-10   vinpb-085
     hal(4)   depth in mev.',36x,'ecis-691'/6x,'11-20   val(5)   reducedinpb-086
     i radius in fermis.',24x,'ecis-692'/6x,'21-30   val(6)   diffusenesinpb-087
     js in fermis.',27x,'ecis-693'/72x,'ecis-694'/'surface or vector reainpb-088
     kl potential',8x,'format (3f10.5)',17x,'ecis-695')                 inpb-089
      write (2,1032)                                                    inpb-090
 1032 format ('********************************',40x,'ecis-696'/7x,'1-10inpb-091
     1   val(7)   depth in mev.',36x,'ecis-697'/6x,'11-20   val(8)   redinpb-092
     2uced radius in fermis.',24x,'ecis-698'/6x,'21-30   val(9)   diffusinpb-093
     3eness in fermis.',27x,'ecis-699'/72x,'ecis-700'/'surface or vectorinpb-094
     4 imaginary potential   format (3f10.5)',17x,'ecis-701'/'**********inpb-095
     5***************************',35x,'ecis-702'/7x,'1-10   val(10)  deinpb-096
     6pth in mev.',36x,'ecis-703'/6x,'11-20   val(11)  reduced radius ininpb-097
     7 fermis.',24x,'ecis-704'/6x,'21-30   val(12)  diffuseness in fermiinpb-098
     8s.',27x,'ecis-705'/72x,'ecis-706'/'spin-orbit or tensor real poteninpb-099
     9tial',5x,'format (3f10.5)',17x,'ecis-707'/'***********************inpb-100
     a************',37x,'ecis-708'/7x,'1-10   val(13)  depth in mev.',36inpb-101
     bx,'ecis-709'/6x,'11-20   val(14)  reduced radius in fermis.',24x,'inpb-102
     cecis-710'/6x,'21-30   val(15)  diffuseness in fermis.',27x,'ecis-7inpb-103
     d11'/72x,'ecis-712'/'spin-orbit/tensor imaginary potential   formatinpb-104
     e (3f10.5)',17x,'ecis-713'/'*************************************',inpb-105
     f35x,'ecis-714'/7x,'1-10   val(16)  depth in mev.',36x,'ecis-715'/6inpb-106
     gx,'11-20   val(17)  reduced radius in fermis.',24x,'ecis-716'/6x,'inpb-107
     h21-30   val(18)  diffuseness in fermis.',27x,'ecis-717'/'  note:  inpb-108
     ithe spin-orbit operator is always 2*(l.s)',22x,'ecis-718'/'  **** inpb-109
     j for spin 1/2 particle, the depth is the usual value.',12x,'ecis-7inpb-110
     k19')                                                              inpb-111
      write (2,1033)                                                    inpb-112
 1033 format (8x,'for spin 1 particle, the depth is the half of the usuainpb-113
     1l value.  ecis-720'/72x,'ecis-721'/''/'coulomb potential',23x,'foinpb-114
     2rmat (3f10.5)',17x,'ecis-722'/'*****************',55x,'ecis-723'/7inpb-115
     3x,'1-10   val(20)  reduced coulomb radius in fermis.',16x,'ecis-72inpb-116
     44'/6x,'11-20   val(21)  diffuseness of a woods-saxon charge distriinpb-117
     5bution.ecis-725'/6x,'21-30   val(25)  third parameter of a fermi cinpb-118
     6harge distribution.  ecis-726'/72x,'ecis-727'/'spin-orbit coulomb inpb-119
     7potential',12x,'format (3f10.5)',17x,'ecis-728'/'*****************inpb-120
     8***********',44x,'ecis-729'/7x,'1-10   val(22)  anomalous magneticinpb-121
     9 moment (less half charge in   ecis-730'/14x,'dirac formalism) mulinpb-122
     atiplied by the charge of the target.  ecis-731'/6x,'11-20   val(23inpb-123
     b)  reduced radius in fermis.',24x,'ecis-732'/6x,'21-30   val(24)  inpb-124
     cdiffuseness in fermis.',27x,'ecis-733'/'  note:  if val(21)=0. or inpb-125
     dval(24)=0. a homogeneous charge distribution  ecis-734'/'  ****  iinpb-126
     es used. the product of charges is copied into val(19).',9x,'ecis-7inpb-127
     f35'/9x,'when the diffuseness of the charge is not zero, the woods-inpb-128
     gsaxonecis-736'/8x,'form factor is multiplied by 1+val(25)*r**2. thinpb-129
     he same parameter ecis-737'/8x,'val(25) is used for these two last inpb-130
     ipotentials, if their',9x,'ecis-738'/8x,'diffuseness is not zero.',inpb-131
     j40x,'ecis-739'/9x,'if lo(9)=.true., enter a negative radius to useinpb-132
     k a symmetric',4x,'ecis-740')                                      inpb-133
      write (2,1034)                                                    inpb-134
 1034 format (8x,'woods-saxon form factor.',40x,'ecis-741'/9x,'if a diffinpb-135
     1useness or the radius of a coulomb potential without  ecis-742'/8xinpb-136
     2,'diffuseness is negative, its absolute value is taken into',7x,'einpb-137
     3cis-743'/8x,'account in subroutine rotp and a message printed.',15inpb-138
     4x,'ecis-744'/72x,'ecis-745'/'*** end of do-loop for potentials witinpb-139
     5hout folding and dispersion ***',4x,'ecis-746'/'*** relations (lo(inpb-140
     610)=.false. and lo(17)=.false.) ***',19x,'ecis-747'/72x,'ecis-748'inpb-141
     7/'folding for real potentials',13x,'format (3f10.5)',17x,'ecis-749inpb-142
     8'/'***************************',45x,'ecis-750'/' only if lo(17)=.tinpb-143
     9rue., otherwise go to ''dispersion parameters''.',8x,'ecis-751'/7xinpb-144
     a,'1-10   val(26) ''v'' parameter',37x,'ecis-752'/6x,'11-20   val(2inpb-145
     b7) ''r'' parameter',37x,'ecis-753'/6x,'21-30   val(28) ''a'' paraminpb-146
     ceter',37x,'ecis-754'/72x,'ecis-755'/'folding for imaginary potentiinpb-147
     dals',8x,'format (3f10.5)',17x,'ecis-756'/'************************inpb-148
     e********',40x,'ecis-757'/7x,'1-10   val(29) ''v'' parameter.',36x,inpb-149
     f'ecis-758'/6x,'11-20   val(30) ''r'' parameter.',36x,'ecis-759'/6xinpb-150
     g,'21-30   val(31) ''a'' parameter.',36x,'ecis-760'/72x,'ecis-761'/inpb-151
     h'folding for coulomb potentials',10x,'format (3f10.5)',17x,'ecis-7inpb-152
     i62'/'******************************',42x,'ecis-763'/7x,'1-10   valinpb-153
     j(32) ''v'' parameter.',36x,'ecis-764'/6x,'11-20   val(33) ''r'' painpb-154
     krameter.',36x,'ecis-765')                                         inpb-155
      write (2,1035)                                                    inpb-156
 1035 format (6x,'21-30   val(34) ''a'' parameter.',36x,'ecis-766'/72x,'inpb-157
     1ecis-767'/'explanation of folding parameters:  the folding functioinpb-158
     2ns are normalisedecis-768'/'**********************************  toinpb-159
     3 1.  to fold an optical potential,ecis-769'/4x,'enter the true chainpb-160
     4rge, the depth of central potential equal to the  ecis-770'/4x,'deinpb-161
     5pth of the nucleon potential multiplied by the number of nucleons inpb-162
     6ecis-771'/4x,'in the projectile, and the depth of of spin-orbit poinpb-163
     7tential equal toecis-772'/4x,'the depth of the nucleon spin-orbit inpb-164
     8potential divided by the number ecis-773'/4x,'of nucleons in the pinpb-165
     9rojectile.',38x,'ecis-774'/6x,'''v''=0',4x,'no folding.',46x,'ecisinpb-166
     a-775'/6x,'''a''=0',4x,'gaussian form factor with the range ''r''.'inpb-167
     b,17x,'ecis-776'/6x,'''r''=0',4x,'hulthen form factor (exp(-r/''v''inpb-168
     c)-exp(-r/''a''))/r.',9x,'ecis-777'/15x,'reduced to yukawa form facinpb-169
     dtor exp(-r/''v'')/r if ''a''=0.',4x,'ecis-778'/6x,'otherwise  saxoinpb-170
     en form factor 1/(1+exp((r-''r'')/''a'').',15x,'ecis-779'/6x,'if a inpb-171
     ffolding parameter is negative, the absolute value is taken   ecis-inpb-172
     g780'/4x,'into account in subroutine fold and a message printed.',1inpb-173
     h4x,'ecis-781'/6x,'all the derivatives of potentials needed are obtinpb-174
     iained by numericalecis-782'/4x,'derivation after folding.',43x,'ecinpb-175
     jis-783'/72x,'ecis-784'/''/'dispersion parameters',19x,'format (2iinpb-176
     k5,6f10.5)',13x,'ecis-785'/'*********************',51x,'ecis-786') inpb-177
      write (2,1036)                                                    inpb-178
 1036 format (' only if lo(10)=.true., otherwise go to ''end of do-loop inpb-179
     1for potentials''.ecis-787'/4x,'1- 5   ipp(1,1)  1 energies in laboinpb-180
     2ratory system, anything for',6x,'ecis-788'/21x,'center of mass eneinpb-181
     3rgy.',29x,'ecis-789'/4x,'6-10   ipp(2,1)  n2 power in large negatiinpb-182
     4ve energy correction term. ecis-790'/21x,'must be even and positivinpb-183
     5e. if 0, term not used.',4x,'ecis-791'/3x,'11-20   pip(3)',4x,'eneinpb-184
     6rgy for which the imaginary depths are read.',4x,'ecis-792'/21x,'(inpb-185
     7default option: energy of the first level using   ecis-793'/21x,'tinpb-186
     8his potential).',35x,'ecis-794'/3x,'21-30   pip(4)',4x,'ef fermi einpb-187
     9nergy. (default option -6.8 mev).',8x,'ecis-795'/3x,'31-40   pip(5inpb-188
     a)',4x,'ep threshold energy. (default option fermi energy).ecis-796inpb-189
     b'/3x,'41-50   pip(6)',4x,'ea large energy starting value above ferinpb-190
     cmi energy. ecis-797'/21x,'(default option 60 mev).',27x,'ecis-798'inpb-191
     d/3x,'51-60   pip(7)',4x,'avso exponential decrease of real spin-orinpb-192
     ebit.',6x,'ecis-799'/3x,'61-70   pip(8)',4x,'awso linear decrease oinpb-193
     ff imaginary spin-orbit.',6x,'ecis-800'/72x,'ecis-801'/'next card',inpb-194
     g31x,'format (2i5,6f10.5)',13x,'ecis-802'/'*********',63x,'ecis-803inpb-195
     h'/4x,'1- 5   ipp(1,2)  nv with |nv| power for volume or scalar potinpb-196
     iential. ecis-804'/4x,'6-10   ipp(2,2)  ns with |ns| power for surfinpb-197
     jace or vector potential.ecis-805'/3x,'11-20   pip(9)',4x,'bv constinpb-198
     kant for volume or scalar potential.',8x,'ecis-806')               inpb-199
      write (2,1037)                                                    inpb-200
 1037 format (3x,'21-30   pip(10)   alp coefficient of large positive eninpb-201
     1ergy term in   ecis-807'/21x,'volume potential. (default option 1.inpb-202
     265).',11x,'ecis-808'/21x,'second bv'' parameter for volume potentiinpb-203
     3als if nv<0 ecis-809'/21x,'(default option 2*bv).',29x,'ecis-810'/inpb-204
     43x,'31-40   pip(11)   cv exponential decrease in sqrt|e| for largeinpb-205
     5',7x,'ecis-811'/21x,'energy terms of volume potentials or',15x,'ecinpb-206
     6is-812'/21x,'fv fraction of the first term if nv<0.',13x,'ecis-813inpb-207
     7'/3x,'41-50   pip(12)   bs constant for surface or vector potentiainpb-208
     8l.',7x,'ecis-814'/3x,'51-60   pip(13)   cs exponential decrease ofinpb-209
     9 a surface potential.',4x,'ecis-815'/21x,'(default option 0.0036).inpb-210
     a if ns is negative',9x,'ecis-816'/21x,'bs'' second constant for suinpb-211
     brface or vector',10x,'ecis-817'/21x,'potential for ns<0 (default oinpb-212
     cption 2*bw).',10x,'ecis-818'/3x,'61-70   pip(14)   cr non-localityinpb-213
     d range parameter of surface',9x,'ecis-819'/21x,'potential or fractinpb-214
     eion in the first term if ns<0.   ecis-820'/72x,'ecis-821'/'next cainpb-215
     frd',31x,'format (7f10.5)',17x,'ecis-822'/'*********',63x,'ecis-823inpb-216
     g'/4x,'1-10   pip(15)   ahf exponential decrease of h.f. real voluminpb-217
     he',7x,'ecis-824'/21x,'potential which needs the same geometry for inpb-218
     ireal   ecis-825'/21x,'and imaginary volume potential.',20x,'ecis-8inpb-219
     j26'/72x,'ecis-827'/'explanation of dispersion parameters:',35x,'ecinpb-220
     kis-828'/'*************************************',35x,'ecis-829')   inpb-221
      write (2,1038)                                                    inpb-222
 1038 format ('for positive values of nv: the volume imaginary potentialinpb-223
     1 at the energy ecis-830'/'************************** e is assumed inpb-224
     2to be such that ''v(2*ef-e)=v(e)''ecis-831'/4x,'with ''v(e)=v*(e-einpb-225
     3f)**nv/((e-ef)**nv+bv**nv)'' with addition for',6x,'ecis-832'/4x,'inpb-226
     4e>ef+ea of ''alp*[sqrt(e)+.5*(ef+ea)**(3/2)/e-1.5*sqrt(ef+ea)]'' ainpb-227
     5nd  ecis-833'/4x,'for e<ef-ea of ''-v(e)*(ef-e-ea)**n2/((ef-e-ea)*inpb-228
     6*n2+ea**n2)'' where   ecis-834'/4x,'v(e) was given above; these exinpb-229
     7pression can be damped by a factor',4x,'ecis-835'/4x,'''exp[-cv*sqinpb-230
     8rt(e-ef-ea)]'' and ''exp[-cv*sqrt(ef-ea-e)]'' respectively. ecis-8inpb-231
     936'/4x,'the value of ''v'' is such that this gives the strength reinpb-232
     aad at the   ecis-837'/4x,'energy pip(3). the real volume potentialinpb-233
     b with the same geometry,',4x,'ecis-838'/4x,'obtained by dispersioninpb-234
     c relation (as described by c. mahaux and',6x,'ecis-839'/4x,'r. sarinpb-235
     dtor in nucl. phys a528 (1991) 253), is added to the real',6x,'ecisinpb-236
     e-840'/4x,'potential.',58x,'ecis-841'/'for positive values of ns: tinpb-237
     fhe surface imaginary potential ''w(e)'' in theecis-842'/'*********inpb-238
     g***************** schroedinger formalism is assumed to have theeciinpb-239
     hs-843'/4x,'same energy dependence as ''v(e)'' given above multipliinpb-240
     ied by',10x,'ecis-844'/4x,'''exp[-cs*|e-ef|-cr*(e-ef)]''. the non-linpb-241
     jocality range parameter ''cr''  ecis-845'/4x,'is the inverse of ''inpb-242
     keb'' given by equations (3.17) and (3.18) of',6x,'ecis-846')      inpb-243
      write (2,1039)                                                    inpb-244
 1039 format (4x,'c. mahaux and r. sartor in nucl. phys a458 (1986) 25. inpb-245
     1the real',6x,'ecis-847'/''/4x,'surface potential with the same geinpb-246
     2ometry, obtained by dispersion',4x,'ecis-848'/4x,'relation is addeinpb-247
     3d to the real potential. there is not the default   ecis-849'/4x,'inpb-248
     4option cr=.0125 to allow to use 0.',34x,'ecis-850'/'for negative vinpb-249
     5alues of nv: the volume imaginary potential is assumed to ecis-851inpb-250
     6'/'************************** be the sum of two terms similar to 'inpb-251
     7'v(e)''',4x,'ecis-852'/4x,'used for positive values, with the poweinpb-252
     8r |nv| and the parameters bv ecis-853'/4x,'and bv'' respectively. inpb-253
     9the strengths are such that the first term is ecis-854'/4x,'fv timinpb-254
     aes the value read at the energy pip(3).',23x,'ecis-855'/'for negatinpb-255
     bive values of ns: the surface imaginary potential is the',7x,'ecisinpb-256
     c-856'/'************************** difference of two terms similar inpb-257
     dto those usedecis-857'/4x,'for positive values of nv, with the powinpb-258
     eer |ns|, the parameters bs,  ecis-858'/4x,'bs'' respectively and tinpb-259
     fhe same strength.',29x,'ecis-859'/6x,'the vector dispersive potentinpb-260
     gial of the dirac formalism is treated ecis-860'/4x,'as the scalar inpb-261
     hone without large energy terms.',23x,'ecis-861'/6x,'the powers nv,inpb-262
     i ns and n2 must be even. input of 0 suppresses the  ecis-862'/4x,'inpb-263
     juse of dispersion relation for the corresponding potential.',9x,'einpb-264
     kcis-863'/72x,'ecis-864')                                          inpb-265
      write (2,1040)                                                    inpb-266
 1040 format (6x,'******  end of do-loop for potentials ******',22x,'eciinpb-267
     1s-865'/72x,'ecis-866'/'equidistant angles',22x,'format (7f10.5)',1inpb-268
     27x,'ecis-867'/'******************',54x,'ecis-868'/' only if lo(66)inpb-269
     3=.false., otherwise go to ''spin-orbit parametrisation''.  ecis-86inpb-270
     49'/7x,'1-10   theta1   first angle.',37x,'ecis-870'/6x,'11-20   dtinpb-271
     5heta   step. (default option 1.)',24x,'ecis-871'/6x,'21-30   thetainpb-272
     62   last angle.',38x,'ecis-872'/6x,'31-40   dthe',5x,'averaging aninpb-273
     7gle. values listed are 1/3 of the sumecis-873'/23x,'of values at tinpb-274
     8heta and theta+/-dthe.',13x,'ecis-874'/72x,'ecis-875'/'spin-orbit inpb-275
     9parametrisation',14x,'format (7f10.5)',17x,'ecis-876'/'***********inpb-276
     a***************',46x,'ecis-877'/' only if lo(4)=.true., otherwise inpb-277
     bgo to ''hauser-feshbach corrections''.   ecis-878'/7x,'1-10   az1.inpb-278
     c',54x,'ecis-879'/6x,'11-20   az2.',8x,'(these parameters are in aninpb-279
     d array',13x,'ecis-880'/6x,'21-30   az3.',54x,'ecis-881'/6x,'31-40 inpb-280
     e  az4.',8x,'az(16) from az(1) to az(6) for the search)',4x,'ecis-8inpb-281
     f82'/6x,'41-50   az5.',54x,'ecis-883'/6x,'51-60   az6.',54x,'ecis-8inpb-282
     g84'/'  note: the unparametrised spin-orbit deformation is:',19x,'einpb-283
     hcis-885'/'  ****   az1=az4=0.,  az2=az3=az5=az6=1.',32x,'ecis-886'inpb-284
     i/8x,'the spin-orbit deformation multiplied by x is:',18x,'ecis-887inpb-285
     j'/10x,'az1=az4=0., az2=1., az3=az5=az6=x .',27x,'ecis-888'/8x,'theinpb-286
     k ''incorrect'' spin-orbit deformation is:',22x,'ecis-889')        inpb-287
      write (2,1041)                                                    inpb-288
 1041 format (10x,'az1=az2=az5=az6=0., az3=az4=0.5 .',29x,'ecis-890'/8x,inpb-289
     1'for the most general parametrisation of deformed spin-orbit see einpb-290
     2cis-891'/7x,'comment cards in subroutine quan.',32x,'ecis-892'/72xinpb-291
     3,'ecis-893'/'hauser-feshbach corrections',13x,'format (7f10.5)',17inpb-292
     4x,'ecis-894'/'***************************',45x,'ecis-895'/' only iinpb-293
     5f lo(81)=.true., otherwise go to ''cards read in subroutine deph''inpb-294
     6.ecis-896'/6x,'1-10   bz1.   square root of elastic enhancement.',inpb-295
     717x,'ecis-897'/20x,'(default option 1.4142).',28x,'ecis-898'/5x,'1inpb-296
     81-20   bz2.   if lo(82)=.true., spin cut-off parameter (default   inpb-297
     9ecis-899'/20x,'option 3.5). if lo(82)=.false., particle degrees ofinpb-298
     a ecis-900'/20x,'freedom.',44x,'ecis-901'/5x,'21-30   bz3.   squareinpb-299
     b root of level density parameter.',13x,'ecis-902'/20x,'(default opinpb-300
     ction 100.). if lo(82)=lo(87)=.false.,',4x,'ecis-903'/20x,'parameteinpb-301
     dr bz3 in moldauer''s formula given below.',4x,'ecis-904'/20x,'(definpb-302
     eault option 1.212).',29x,'ecis-905'/''/5x,'31-40   bz4.   if lo(8inpb-303
     f2)=lo(87)=.false., parameter bz4 in mol-',5x,'ecis-906'/20x,'dauerinpb-304
     g''s formula given below. (default option 0.78). ecis-907'/5x,'41-5inpb-305
     h0   bz5.   if lo(82)=lo(87)=.false., parameter bz5 in mol-',5x,'ecinpb-306
     iis-908'/20x,'dauer''s formula given below. (default option 0.228).inpb-307
     jecis-909'/'  note:  the penetrabilities, which are probabilities oinpb-308
     kf compound',7x,'ecis-910')                                        inpb-309
      write (2,1042)                                                    inpb-310
 1042 format ('  ****  nucleus formation, are related to partial cross-sinpb-311
     1ections minus  ecis-911'/8x,'the reaction cross-section to the chainpb-312
     2nnels taken into account.  ecis-912'/9x,'if lo(82)=.true., denotininpb-313
     3g by ti and tf the penetrabilities',4x,'ecis-913'/8x,'defined abovinpb-314
     4e for the incoming and the outgoing channels, the   ecis-914'/8x,'inpb-315
     5hauser-feshbach correction is: ti*tf/(4*(sum on all the t)+',5x,'einpb-316
     6cis-915'/8x,'+bz3**2*(2*j+1)*exp(-(j*j+j)/(2*bz2**2)) for inelastiinpb-317
     7c channels,ecis-916'/8x,'multiplied by bz1**2 for the elastic one.inpb-318
     8',23x,'ecis-917'/8x,'for the search, these quantities are in az frinpb-319
     9om az(7) to az(9). ecis-918'/9x,'for lo(82)=.false.: without fluctinpb-320
     auations (lo(87)=.true.), bz1  ecis-919'/8x,'is used and can be in inpb-321
     bsearch; with fluctuations (lo(87)=.false.)ecis-920'/8x,'the given inpb-322
     cvalue of bz2 is used if bz2 is not 0; if bz2=0., the  ecis-921'/8xinpb-323
     d,'channel degree of freedom parameter, formula (1) in p.a.',8x,'ecinpb-324
     eis-922'/8x,'moldauer, nuclear physics a344 (1980), page 185-195, winpb-325
     fhich is:  ecis-923'/12x,'1.78d0+(tl**1.212d0-0.78d0)*dexp(-0.228d0inpb-326
     g*sum on tl)',8x,'ecis-924'/8x,'is generalised by the expression:',inpb-327
     h31x,'ecis-925'/12x,'1.d0+bz4+(tl**bz3-bz4)*dexp(-bz5*sum on tl)',1inpb-328
     i7x,'ecis-926'/8x,'if lo(82)=.true. bz1 and bz2 can be in search; iinpb-329
     jf lo(82)=.false.ecis-927'/8x,'and lo(87)=.true. bz3 can be in searinpb-330
     kch; if lo(82)=lo(87)=.false.ecis-928')                            inpb-331
      write (2,1043)                                                    inpb-332
 1043 format (8x,'bz2 can be in search, but if bz2=0., bz3, bz4 and bz5 inpb-333
     1can also  ecis-929'/8x,'be in search.',51x,'ecis-930'/72x,'ecis-93inpb-334
     21'/'fission data',28x,'format (7f10.5)',17x,'ecis-932'/'**********inpb-335
     3**',60x,'ecis-933'/'if lo(82)=.true., go to ''cards read in subrouinpb-336
     4tine deph''.',16x,'ecis-934'/'if lo(85)=.false., go to ''giant dipinpb-337
     5ole resonance description''.',10x,'ecis-935'/6x,'1-10   fiss(1,*) inpb-338
     6 transmission coefficient',24x,'ecis-936'/5x,'11-20   fiss(2,*)  dinpb-339
     7egrees of freedom. if <.5, it is replaced by 0.ecis-937'/'  there inpb-340
     8are nfiss such cards. the first coefficient is for the smallest ecinpb-341
     9is-938'/'total j value of the system and the same parity of the grinpb-342
     aound state. theecis-939'/'second one is for the opposite parity. tinpb-343
     bhe following ones are for higherecis-940'/'j values, with the sameinpb-344
     c order for parities.',29x,'ecis-941'/72x,'ecis-942'/'giant dipole inpb-345
     dresonance description',6x,'format (7f10.5)',17x,'ecis-943'/'******inpb-346
     e****************************',38x,'ecis-944'/'  only if lo(86)=.trinpb-347
     fue., otherwise go to ''level density for continuum''. ecis-945'/3xinpb-348
     g,'if nrd is not 0, go to ''gamma transmission factors''.',17x,'eciinpb-349
     hs-946'/7x,'data to compute the (neutron, gamma) cross-section wheninpb-350
     i the giantecis-947'/3x,'dipole resonance model is used (see e. lyninpb-351
     jn, ''the theory of neutron  ecis-948'/3x,'resonance reactions'', pinpb-352
     kages 321/326 and a. gilbert and a.g.w.',8x,'ecis-949')            inpb-353
      write (2,1044)                                                    inpb-354
 1044 format (3x,'cameron, can. jour. of physics 43, 1446, 1965, pages 1inpb-355
     1475/1476).',5x,'ecis-950'/6x,'1-10   tgo   slow s-wave neutron gaminpb-356
     2ma widths/spacing for',9x,'ecis-951'/19x,'normalisation. if tgo=0,inpb-357
     3 lo(86) is set .false.',7x,'ecis-952'/5x,'11-20   bn',4x,'neutron inpb-358
     4separation energy.(default option 8.).',7x,'ecis-953'/5x,'21-30   inpb-359
     5fnug  radiative degrees of freedom.',24x,'ecis-954'/19x,'if less tinpb-360
     6han 1., it is replaced by fnug=20.',10x,'ecis-955'/5x,'31-40   egdinpb-361
     7   energy of the giant dipole resonance.',16x,'ecis-956'/19x,'(definpb-362
     8ault option 163*(n*z)**2/(n+z)**(4/3).).',9x,'ecis-957'/19x,'the sinpb-363
     9trong absorption model id used if egd < 0.',6x,'ecis-958'/19x,'(siinpb-364
     ample behaviour as e**3 instead of resonance',7x,'ecis-959'/19x,'wiinpb-365
     bth a factor e**4)',34x,'ecis-960'/5x,'41-50   ggd   resonance widtinpb-366
     ch. (default option 5.).',16x,'ecis-961'/4x,'for the search, these inpb-367
     dquantities are in az from az(12) to az(16).   ecis-962'/72x,'ecis-inpb-368
     e963'/''/'gamma transmission factors',14x,'format (7f10.5)',17x,'einpb-369
     fcis-964'/'**************************',46x,'ecis-965'/' only if lo(inpb-370
     g86)=.true. and nrd is not 0.',32x,'ecis-966'/6x,'1-10   gam(1) forinpb-371
     h l=0.',44x,'ecis-967'/5x,'11-20   gam(2) for l=1.',44x,'ecis-968'/inpb-372
     i5x,'.......................',44x,'ecis-969'/5x,'61-70   gam(7) forinpb-373
     j l=6.',44x,'ecis-970'/'  up to gam(nrd), eventually on others cardinpb-374
     ks.',27x,'ecis-971'/72x,'ecis-972')                                inpb-375
      write (2,1045)                                                    inpb-376
 1045 format ('level density of compound nucleus',7x,'format (7f10.5)',1inpb-377
     17x,'ecis-973'/'*********************************',39x,'ecis-974'/3inpb-378
     2x,'if there are gamma transmission parameters computed with the giinpb-379
     3ant   ecis-975'/'dipole resonance model (lo(86)=.true. and nrd=0 iinpb-380
     4n ''compound nucleus',4x,'ecis-976'/'data''),  or continua (ncont inpb-381
     5not 0 in ''compound nucleus data''), otherwiseecis-977'/'go to ''cinpb-382
     6ards read in subroutine deph''.',34x,'ecis-978'/3x,'for the total inpb-383
     7residual nucleus needed for the gamma giant resonance, ecis-979'/'inpb-384
     8followed by the residual nucleus of each continuum:',21x,'ecis-980inpb-385
     9'/6x,'1-10   scn(7,i) z:   charge of the compound nucleus',15x,'ecinpb-386
     ais-981'/5x,'11-20   scn(1,i) sa:  level density parameter for s-wainpb-387
     bve resonance ecis-982'/27x,'spacing. (default option (.0091*(shellinpb-388
     c corr. ecis-983'/27x,'-.23*nd)+.143)*na where na is the total',6x,inpb-389
     d'ecis-984'/27x,'number of nucleons, nd the minimum distance  ecis-inpb-390
     e985'/27x,'to a magic number for protons or neutrons andecis-986'/2inpb-391
     f7x,'shell corrections are given by cook: see',5x,'ecis-987'/27x,'tinpb-392
     gables and references in subroutine lden).   ecis-988'/5x,'21-30   inpb-393
     hscn(2,i) ux:  matching energy for the two density formula  ecis-98inpb-394
     i9'/27x,'shifted by pairing energy. (default value',4x,'ecis-990'/2inpb-395
     j7x,'2.5+150/na).',33x,'ecis-991'/5x,'31-40   scn(3,i) tau: nuclearinpb-396
     k temperature. (default option',9x,'ecis-992')                     inpb-397
      write (2,1046)                                                    inpb-398
 1046 format (27x,'1/tau=sqrt(sa/ux)-1.5/ux).',19x,'ecis-993'/5x,'41-50 inpb-399
     1  scn(4,i) sg:  spin cut off parameter. (default option',6x,'ecis-inpb-400
     2994'/27x,'formula (11) of gilbert and cameron).',8x,'ecis-995'/5x,inpb-401
     3'51-60   scn(5,i) e0:  energy shift. (default option formula (28) inpb-402
     4ofecis-996'/27x,'gilbert and cameron).',24x,'ecis-997'/5x,'61-70  inpb-403
     5 scn(6,i) ex:  matching energy between the two density',6x,'ecis-9inpb-404
     698'/27x,'formulae. (default option ux+pairing with',4x,'ecis-999'/inpb-405
     727x,'pairing given by cook)',23x,'ecis1000'/'  note:  the dimensioinpb-406
     8ns of the array scn are 7 and ncons. scn(j,i)',6x,'ecis1001'/'  **inpb-407
     9**  can be searched for j=1 to 6. if scn(j,i) is 0., it is replaceinpb-408
     ad ecis1002'/8x,'by the default option computed with the scn(j,k) finpb-409
     bor k<i. if',4x,'ecis1003'/8x,'scn(3,i) is negative, it is replacedinpb-410
     c by the default option',6x,'ecis1004'/8x,'computed with default opinpb-411
     dtions for sa and ux. after replacement, ecis1005'/8x,'density parainpb-412
     emeters used, which must be taken into account for a ecis1006'/8x,'inpb-413
     fsearch or a change using lo(37)=.true. are listed at the end.   ecinpb-414
     gis1007'/72x,'ecis1008'/72x,'ecis1009'/'cards read in subroutine deinpb-415
     hph',43x,'ecis1010'/'*****************************',43x,'ecis1011'/inpb-416
     i72x,'ecis1012'/'number of observables by channel',8x,'format (14i5inpb-417
     j)',19x,'ecis1013'/'********************************',40x,'ecis1014inpb-418
     k')                                                                inpb-419
      write (2,1047)                                                    inpb-420
 1047 format (4x,'(non-standard observables) only if lo(94)=.true. and linpb-421
     1o(66)=.false.,ecis1015'/4x,'otherwise go to ''restricted coulomb cinpb-422
     2orrections''.',19x,'ecis1016'/7x,'1- 5   number of observables forinpb-423
     3 the elastic scattering.',9x,'ecis1017'/7x,'6-10   number of obserinpb-424
     4vables for the first excited state.',8x,'ecis1018'/6x,'11-15   numinpb-425
     5ber of observables for the second excited state.',7x,'ecis1019'/6xinpb-426
     6,'16-20   number of observables for the third excited state.',8x,'inpb-427
     7ecis1020'/6x,'21-25   ...........',47x,'ecis1021'/14x,'up to the linpb-428
     8ast coupled channel (ncoll values).',12x,'ecis1022'/72x,'ecis1023'inpb-429
     9/''/'for each coupled state',50x,'ecis1024'/'********************inpb-430
     a**',50x,'ecis1025'/72x,'ecis1026'/'observable identifications',14xinpb-431
     b,'format (14i5)',19x,'ecis1027'/'**************************',46x,'inpb-432
     cecis1028'/7x,'1- 5   first observable which must be the cross-sectinpb-433
     dion (enter a ecis1029'/14x,'blank or 0) .',45x,'ecis1030'/7x,'6-10inpb-434
     e   second observable.',40x,'ecis1031'/6x,'11-15   third observableinpb-435
     f.',41x,'ecis1032'/6x,'16-20   fourth observable.',40x,'ecis1033'/6inpb-436
     gx,'21-25   fifth observable.',41x,'ecis1034'/6x,'26-30   .........inpb-437
     h..',47x,'ecis1035'/14x,'up to the last observable.',32x,'ecis1036'inpb-438
     i/72x,'ecis1037'/3x,'standard description  0   cross-section.',29x,inpb-439
     j'ecis1038'/3x,'********************  1   cross-section / rutherforinpb-440
     kd''s cross-section.ecis1039')                                     inpb-441
      write (2,1048)                                                    inpb-442
 1048 format (25x,'2   vector analysing power.',20x,'ecis1040'/6x,'3',5xinpb-443
     1,'vector polarisation.',40x,'ecis1041'/12x,'(note a ratio sqrt(2.)inpb-444
     2 with it11 for spin 1/2 for 2 and 3). ecis1042'/6x,'4',5x,'t20 .',inpb-445
     355x,'ecis1043'/6x,'5',5x,'t21 .',55x,'ecis1044'/6x,'6',5x,'t22 .',inpb-446
     455x,'ecis1045'/6x,'7',5x,'kyy or d  defined as -a(1100 1100)-a(110inpb-447
     50 1-100)',12x,'ecis1046'/6x,'8',5x,'kxx or r  defined as  a(1100 1inpb-448
     6100)-a(1100 1-100)',12x,'ecis1047'/6x,'9',5x,'kzz or a'' defined ainpb-449
     7s  a(1000 1000)',26x,'ecis1048'/5x,'10',5x,'kxz or r'' defined as inpb-450
     8-sqrt(2.) a(1100 1000)',17x,'ecis1049'/5x,'11',5x,'kzx or a  defininpb-451
     9ed as -sqrt(2.) a(1000 1100)',17x,'ecis1050'/5x,'12',5x,'spin-flipinpb-452
     a :  (a(0000,0000)+a(1100,1100)+a(1100,1-100))/2',4x,'ecis1051'/5x,inpb-453
     b'13',5x,'vector analysing power of the target',24x,'ecis1052'/10x,inpb-454
     c'(note a ratio sqrt(2.) with it11 for spin 1/2 for 2, 3 and 13)eciinpb-455
     ds1053'/5x,'14',5x,'ayy  defined as -a(1111 0000)-a(111-1 0000)',17inpb-456
     ex,'ecis1054'/5x,'15',5x,'axx  defined as  a(1111 0000)-a(111-1 000inpb-457
     f0)',17x,'ecis1055'/5x,'16',5x,'azz  defined as  a(1010 0000)',31x,inpb-458
     g'ecis1056'/5x,'17',5x,'axz  defined as -sqrt(2.) a(1110 0000)',22xinpb-459
     h,'ecis1057'/5x,'18',5x,'azx  defined as -sqrt(2.) a(1011 0000)',22inpb-460
     ix,'ecis1058'/5x,'19',5x,'reserved for a set of experimental data winpb-461
     jhich are reaction  ecis1059'/17x,'cross-sections. see ''cards readinpb-462
     k in subroutine lecd''',4x,'ecis1060')                             inpb-463
      write (2,1049)                                                    inpb-464
 1049 format (12x,'note that 12 and 19 were previously 7 and 8.',16x,'ecinpb-465
     1is1061'/72x,'ecis1062'/4x,'non standard description',4x,'enter a ninpb-466
     2egative value, different for   ecis1063'/4x,'*********************inpb-467
     3***',4x,'different observables. the description  ecis1064'/32x,'wiinpb-468
     4ll be read in subroutine obse.',8x,'ecis1065'/10x,'cross-sections inpb-469
     5must be before polarisations.',18x,'ecis1066'/72x,'ecis1067'/'plotinpb-470
     6 indications',24x,'format (14i5)',19x,'ecis1068'/'****************inpb-471
     7',56x,'ecis1069'/7x,'1- 5   number of decades in logarithmic scaleinpb-472
     8s for cross-section.ecis1070'/7x,'6-10   indication for second obsinpb-473
     9ervable.',25x,'ecis1071'/6x,'11-15   indication for third observabinpb-474
     ale.',26x,'ecis1072'/6x,'16-20   ...................',39x,'ecis1073inpb-475
     b'/14x,'up to the last observable.',32x,'ecis1074'/6x,'indications inpb-476
     cfor polarisations are ''1'' for plot and ''0'' for no plotecis1075inpb-477
     d'/72x,'ecis1076'/6x,'******  end of do-loop for nuclear states ***inpb-478
     e***',18x,'ecis1077'/72x,'ecis1078'/'restricted coulomb correctionsinpb-479
     f',10x,'format (14i5)',19x,'ecis1079'/'****************************inpb-480
     g**',42x,'ecis1080'/4x,'if lo(44) and lo(46)=.true., otherwise go tinpb-481
     ho ''cards read in',9x,'ecis1081'/'  subroutine calx''.  for each ninpb-482
     iuclear level:',28x,'ecis1082'/''/10x,'1- 5   niv(i,j,3) between linpb-483
     jevel i and level j for j=1.',8x,'ecis1083'/10x,'6-10   niv(i,j,3) inpb-484
     kbetween level i and level j for j=2.',8x,'ecis1084')              inpb-485
      write (2,1050)                                                    inpb-486
 1050 format (9x,'11-15   .........................',30x,'ecis1085'/17x,inpb-487
     1'enter ''1'' for coulomb correction and ''0'' for none.',5x,'ecis1inpb-488
     2086'/4x,'only values for j smaller than or equal to i are taken ininpb-489
     3to account.ecis1087'/9x,'there are ncoll such cards.',36x,'ecis108inpb-490
     48'/72x,'ecis1089'/72x,'ecis1090'/'cards read in subroutine calx',4inpb-491
     53x,'ecis1091'/'*****************************',43x,'ecis1092'/' onlinpb-492
     6y if lo(31)=.true., otherwise go to ''cards read in subroutine obsinpb-493
     7e''.ecis1093'/72x,'ecis1094'/'chi2 conditions',25x,'format (4i5,2finpb-494
     810.5)',13x,'ecis1095'/'***************',57x,'ecis1096'/7x,'1- 5   inpb-495
     9ncolr  number of angular distributions. if some of them   ecis1097inpb-496
     a'/21x,'are sums on several levels, they account for their ecis1098inpb-497
     b'/21x,'number of levels in ncolr.',25x,'ecis1099'/7x,'6-10   nrec inpb-498
     c  number of parameters in search.',20x,'ecis1100'/6x,'11-15   nfitinpb-499
     d   number of functions kept in the search beyond the  ecis1101'/21inpb-500
     ex,'minimum number which is nrec+1 .',19x,'ecis1102'/6x,'16-20   neinpb-501
     fssai maximum number of evaluations. (default option 100)ecis1103'/inpb-502
     g21x,'this value is not used when lo(34)=.true..',9x,'ecis1104'/6x,inpb-503
     h'21-30   ech',4x,'search scale. (default option 20.).',16x,'ecis11inpb-504
     i05'/21x,'in the preliminary runs, variables are changed by  ecis11inpb-505
     j06'/21x,'the product of this number with their accuracy. in ecis11inpb-506
     k07')                                                              inpb-507
      write (2,1051)                                                    inpb-508
 1051 format (21x,'the others runs, the change of any variable is',5x,'einpb-509
     1cis1108'/21x,'limited by twice this value.',23x,'ecis1109'/6x,'31-inpb-510
     240   rap',4x,'ratio of increase for the search scale after a run einpb-511
     3cis1110'/21x,'for which the chi2 decreased. (default option 1.)  einpb-512
     4cis1111'/21x,'the value of ech is the product by rap of the last einpb-513
     5cis1112'/21x,'maximum change of parameter which gave a lower chi2einpb-514
     6cis1113'/21x,'the value 1 leads safely to the minimum. a value   einpb-515
     7cis1114'/21x,'larger than 1. leads quicker towards the minimum.  einpb-516
     8cis1115'/21x,'a value less than 1. is replaced by 1.',13x,'ecis111inpb-517
     96'/72x,'ecis1117'/72x,'ecis1118'/'cards read in subroutine lecd',4inpb-518
     a3x,'ecis1119'/'*****************************',43x,'ecis1120'/' onlinpb-519
     by if ncolr is not 0, otherwise go to ''cards read in subroutine obinpb-520
     cse''ecis1121'/'the angular distributions can be read in any order.inpb-521
     d',21x,'ecis1122'/72x,'ecis1123'/'for each angular distribution',43inpb-522
     ex,'ecis1124'/'*****************************',43x,'ecis1125'/72x,'einpb-523
     fcis1126'/'identification',26x,'format (l1,i1,i3,2i5,5x,3f10.5) eciinpb-524
     gs1127'/'**************',58x,'ecis1128'/10x,'1   lx logical. if lx=inpb-525
     h.true. the experimental errors are',6x,'ecis1129'/14x,'percentagesinpb-526
     i. lx is set .false. if the observable',10x,'ecis1130'/14x,'identifinpb-527
     jication is not 0, 1 or 19.',25x,'ecis1131'/10x,'2   1 if the angleinpb-528
     ks are in the laboratory system, 0 otherwise.ecis1132')            inpb-529
      write (2,1052)                                                    inpb-530
 1052 format (7x,'3- 5   nt   number of angles.',36x,'ecis1133'/7x,'6-10inpb-531
     1   number of the nuclear state.',30x,'ecis1134'/6x,'11-15   observinpb-532
     2able identification. (see comments on ''observable   ecis1135'/14xinpb-533
     3,'identification'' in ''cards read in subroutine deph'').',6x,'eciinpb-534
     4s1136'/6x,'21-30   weight of this observable in chi2. (default optinpb-535
     5ion 1.)',4x,'ecis1137'/6x,'31-40   experimental normalisation of dinpb-536
     6ata. (default option 1.)   ecis1138'/6x,'41-50   error on experimeinpb-537
     7ntal normalisation. (if 0., the',10x,'ecis1139'/14x,'normalisationinpb-538
     8 is fixed).',34x,'ecis1140'/''/16x,'the experimental values and tinpb-539
     9heir errors are divided by ecis1141'/14x,'the ''renormalisation painpb-540
     arameter''. if the normalisation is  ecis1142'/14x,'fixed, this parinpb-541
     bameter is the ''experimental normalisation''.ecis1143'/14x,'if theinpb-542
     c normalisation is not fixed, the square of the',6x,'ecis1144'/14x,inpb-543
     d'difference between the ''experimental normalisation'' and   ecis1inpb-544
     e145'/14x,'this parameter divided by the ''error on experimental',6inpb-545
     fx,'ecis1146'/14x,'normalisation'' is added to the chi2 for this obinpb-546
     gservable   ecis1147'/14x,'following the definition of the chi2. thinpb-547
     he ''calculated',5x,'ecis1148'/14x,'normalisation'' is the value ofinpb-548
     i the ''renormalisation',7x,'ecis1149'/14x,'parameter'' which miniminpb-549
     jises the chi2. experimental values  ecis1150'/14x,'and errors are inpb-550
     kdivided by it.',29x,'ecis1151')                                   inpb-551
      write (2,1053)                                                    inpb-552
 1053 format (16x,'if for two successive angular distributions, both',7xinpb-553
     1,'ecis1152'/14x,'cross-sections or polarisations, the ''errors on'inpb-554
     2,11x,'ecis1153'/14x,'experimental normalisations'' are non-0 and tinpb-555
     3he same and   ecis1154'/14x,'the two ''experimental normalisation'inpb-556
     4' are identical, the   ecis1155'/14x,'renormalisation parameters ainpb-557
     5re the same for these two',5x,'ecis1156'/14x,'angular distributioninpb-558
     6s and one value is added to the chi2  ecis1157'/14x,'for each one.inpb-559
     7',45x,'ecis1158'/'  note:  if nt=0, the angular distribution descrinpb-560
     8ibed here is not',8x,'ecis1159'/'  ****  experimentally separated inpb-561
     9from the following one. it cannot',6x,'ecis1160'/8x,'happen for thinpb-562
     ae last angular distribution and the observables',4x,'ecis1161'/8x,inpb-563
     b'must be of the same kind (if not, the program stops).',11x,'ecis1inpb-564
     c162'/8x,'angular distribution is attributed to the level read withinpb-565
     dout',4x,'ecis1163'/8x,'nt=0 which can be any of them.',34x,'ecis11inpb-566
     e64'/12x,'the program stops also if the channel number is too largeinpb-567
     f   ecis1165'/8x,'or if the observable identification is larger thainpb-568
     gn 19.',10x,'ecis1166'/72x,'ecis1167'/'data card for each angle',16inpb-569
     hx,'format (6f10.5)',17x,'ecis1168'/'************************',48x,inpb-570
     i'ecis1169'/7x,'1-10   angle in degrees.',41x,'ecis1170'/6x,'11-20 inpb-571
     j  experimental value.',39x,'ecis1171'/6x,'21-30   experimental errinpb-572
     kor.',39x,'ecis1172')                                              inpb-573
      write (2,1054)                                                    inpb-574
 1054 format (6x,'31-40   width of detector. (if non 0.,three calculatioinpb-575
     1ns are done ecis1173'/14x,'at the experimental angle and at plus ainpb-576
     2nd minus this',6x,'ecis1174'/14x,'width, the calculated value willinpb-577
     3 be the mean value).',6x,'ecis1175'/6x,'41-50   angular error. (ifinpb-578
     4 non 0. and the width of detector non 0.ecis1176'/14x,'the experiminpb-579
     5ental error is increased to take into account  ecis1177'/14x,'the inpb-580
     6slope of the calculated curve).',23x,'ecis1178'/'  note:  if the oinpb-581
     7bservable identification is 19, the set of experimentalecis1179'/'inpb-582
     8  ****  values are total cross-sections of which the channel is reinpb-583
     9ad in ecis1180'/8x,'floating value instead of the angle. for channinpb-584
     ael 0., it is the  ecis1181'/8x,'total reaction cross-section, not inpb-585
     btaking into account the',7x,'ecis1182'/8x,'coulomb scattering. forinpb-586
     c channel -1., it is the total',12x,'ecis1183'/8x,'cross-section asinpb-587
     d defined for neutrons. weight and experimental  ecis1184'/8x,'norminpb-588
     ealisation are taken into account. for compound nucleus,',5x,'ecis1inpb-589
     f185'/8x,'uncoupled levels, continua, fission and gamma cross-sectiinpb-590
     gons',4x,'ecis1186'/8x,'follow the coupled states.',38x,'ecis1187'/inpb-591
     h72x,'ecis1188'/72x,'ecis1189'/'cards read in subroutine calx',43x,inpb-592
     i'ecis1190'/'*****************************',43x,'ecis1191'/' only iinpb-593
     jf lo(31)=.true., otherwise go to ''cards read in subroutine obse''inpb-594
     k.ecis1192'/72x,'ecis1193')                                        inpb-595
      write (2,1055)                                                    inpb-596
 1055 format ('search accuracies',23x,'format (7f10.3)',17x,'ecis1194'/'inpb-597
     1*****************',55x,'ecis1195'/' only if lo(32)=.true. and neitinpb-598
     2her ncolr and nrec is 0, otherwise go to ecis1196'/' ''cards read inpb-599
     3in subroutine obse''.',39x,'ecis1197'/''/7x,'1-10   search accurainpb-600
     4cy for the first variable.',19x,'ecis1198'/6x,'11-20   search accuinpb-601
     5racy for the second variable.',18x,'ecis1199'/6x,'21-30   search ainpb-602
     6ccuracy for the third variable.',19x,'ecis1200'/6x,'31-40   ......inpb-603
     7..............',38x,'ecis1201'/14x,'up to nrec values.',40x,'ecis1inpb-604
     8202'/6x,'the search accuracies cannot be 0..there is no default opinpb-605
     9tion.',4x,'ecis1203'/'  they refer to values used in the program ainpb-606
     as real radii or',13x,'ecis1204'/'  deformations changed for heavy inpb-607
     bions.',34x,'ecis1205'/72x,'ecis1206'/'indices of variables',20x,'finpb-608
     cormat (14i5)',19x,'ecis1207'/'********************',52x,'ecis1208'inpb-609
     d/7x,'1- 5   index of the first variable.',30x,'ecis1209'/7x,'6-10 inpb-610
     e  index of the second variable.',29x,'ecis1210'/6x,'11-15   index inpb-611
     fof the third variable.',30x,'ecis1211'/6x,'16-20   ...............inpb-612
     g.....',38x,'ecis1212'/14x,'up to nrec values.',40x,'ecis1213'/72x,inpb-613
     h'ecis1214'/4x,'index specifications:',47x,'ecis1215'/4x,'*********inpb-614
     i************',47x,'ecis1216'/7x,'1-1000   optical model and foldininpb-615
     jg parameters val(i).(see, above,ecis1217'/16x,'optical potential pinpb-616
     karameters). possible values 1 to',5x,'ecis1218')                  inpb-617
      return                                                            inpb-618
      end                                                               inpb-619
c 29/02/04                                                      ecis03  inpc-000
      subroutine inpc                                                   inpc-001
      write (2,1056)                                                    inpc-002
 1056 format (16x,'34*npp. parameters of external form factors in the orinpc-003
     1derecis1219'/16x,'defined when they are read. only floating valuesinpc-004
     2 can be ecis1220'/16x,'in search possible values 1 to 1000. above,inpc-005
     3 add 9000.   ecis1221'/16x,'choosing search accuracies, note that inpc-006
     4reduced radii are ecis1222'/16x,'not used but only radii.',32x,'ecinpc-007
     5is1223'/4x,'1001-2000   deformations for a given potential. possibinpc-008
     6le values 1001ecis1224'/16x,'to 1008.(not the angles of asymmetricinpc-009
     7 rotational model) ecis1225'/4x,'2001-3000   deformations for a giinpc-010
     8ven multipole. possible values 2001ecis1226'/16x,'to 2000+nbet wheinpc-011
     9re nbet is the total number of phonons  ecis1227'/16x,'and deformainpc-012
     ations as listed in the output.',15x,'ecis1228'/4x,'3001-4000   indinpc-013
     bividual deformation. (the unit of the index is the   ecis1229'/16xinpc-014
     c,'potential, the tenth is the deformation). to simplify   ecis1230inpc-015
     d'/16x,'notations, possible value are 3001 to 3000+10*nbet with eciinpc-016
     es1231'/16x,'nbet defined above. values 3xx9 and 3xx0 are excluded.inpc-017
     f  ecis1232'/16x,'note that deformation lengths are used in the seainpc-018
     grch if ecis1233'/16x,'lo(6)=.true..',43x,'ecis1234'/4x,'4001-5000 inpc-019
     h  nuclear model parameters. (in the order of input).',6x,'ecis1235inpc-020
     i'/4x,'5001-6000   reduced nuclear matrix elements. (order of inputinpc-021
     j if theyecis1236'/16x,'are read on cards, or order of computation inpc-022
     kas listed).  ecis1237')                                           inpc-023
      write (2,1057)                                                    inpc-024
 1057 format (4x,'6001-7000   spin-orbit parametrisation, hauser-feshbacinpc-025
     1h corrections.ecis1238'/16x,'and compound nucleus parameters. possinpc-026
     2ible values are:   ecis1239'/16x,'6001-6006 for spin-orbit parametinpc-027
     3risation,',15x,'ecis1240'/16x,'6007-6011 for hauser-feshbach correinpc-028
     4ctions,',14x,'ecis1241'/16x,'6012-6016 for giant dipole resonance inpc-029
     5parameters,',8x,'ecis1242'/16x,'(in a test, 6015 was useless for linpc-030
     6o(87)=.false., 6014   ecis1243'/16x,'and 6015 if lo(97=.true.)',31inpc-031
     7x,'ecis1244'/16x,'6017-6016+6*ncons for level density parameters iinpc-032
     8n order ecis1245'/16x,'given by scn(6,ncons), skipping the charge.inpc-033
     9 only values ecis1246'/16x,'printed as used values can be changed.inpc-034
     a',18x,'ecis1247'/16x,'(in a test, scn(5,i) was useless for gamma, inpc-035
     bscn(1,i),   ecis1248'/16x,'scn(2,i) and scn(6,i) for a continuum)'inpc-036
     c,18x,'ecis1249'/16x,'6016+6*ncons-6016+6*ncons+nrd gamma transmissinpc-037
     dion coeff. ecis1250'/16x,'6016+6*ncons+nrd-6016+6*ncons+nrd+2*nfisinpc-038
     es fission',7x,'ecis1251'/16x,'transmission coefficients.',30x,'eciinpc-039
     fs1252'/4x,'7001-8000   dispersion parameter from pip(4,*) to pip(1inpc-040
     g5,*) without ecis1253'/16x,'possibility to change the description inpc-041
     hinduced by the',4x,'ecis1254'/16x,'integer values ipp(*,1,*), ipp(inpc-042
     i*,2,*) an energy',9x,'ecis1255'/16x,'reference pip(3,*). possible inpc-043
     jvalues from 7001 to',8x,'ecis1256'/16x,'7000+12*npp.',44x,'ecis125inpc-044
     k7'/'')                                                            inpc-045
      write (2,1058)                                                    inpc-046
 1058 format (3x,'10001-99999  to continue 1-1000 when there are more thinpc-047
     1an 1000 values ecis1258'/16x,'with external form factors. use the inpc-048
     2number of the',7x,'ecis1259'/16x,'listing increased by 9000.',30x,inpc-049
     3'ecis1260'/'  note:  any negative number -k in the card above meaninpc-050
     4s that k variablesecis1261'/'  ****  will be kept proportional in inpc-051
     5the search. this value is replaced ecis1262'/8x,'by -*address wherinpc-052
     6e k followed by k indices of parameters is',5x,'ecis1263'/8x,'storinpc-053
     7ed',58x,'ecis1264'/72x,'ecis1265'/'links between variables',17x,'finpc-054
     8ormat (14i5)',19x,'ecis1266'/'***********************',49x,'ecis12inpc-055
     967'/4x,'for every negative value -k in the preceding card:',18x,'einpc-056
     acis1268'/7x,'1- 5   index of the first variable.',30x,'ecis1269'/7inpc-057
     bx,'6-10   index of the second variable.',29x,'ecis1270'/6x,'11-15 inpc-058
     c  index of the third variable.',30x,'ecis1271'/6x,'16-20   .......inpc-059
     d...........',40x,'ecis1272'/14x,'up to k indices.',42x,'ecis1273'/inpc-060
     e72x,'ecis1274'/72x,'ecis1275'/'cards read in subroutine obse',43x,inpc-061
     f'ecis1276'/'*****************************',43x,'ecis1277'/' only iinpc-062
     gf there is any non standard observable (identified by a negative einpc-063
     hcis1278'/' number), otherwise go to ''cards read in subroutine redinpc-064
     im''.',14x,'ecis1279'/72x,'ecis1280'/'for each non standard observainpc-065
     jble',40x,'ecis1281'/'********************************',40x,'ecis12inpc-066
     k82'/72x,'ecis1283')                                               inpc-067
      write (2,1059)                                                    inpc-068
 1059 format ('definition and name',21x,'format (2l1,i1,i2,i5,5a4)',7x,'inpc-069
     1ecis1284'/'*******************',53x,'ecis1285'/10x,'1   lt1  ''t''inpc-070
     2 for an observable defined with an axis',11x,'ecis1286'/19x,'perpeinpc-071
     3ndicular to the reaction plane. the description ecis1287'/19x,'is inpc-072
     4changed by a rotation r(pi/2,pi/2,pi/2) to the',4x,'ecis1288'/19x,inpc-073
     5'definition with respect to the direction of particle ecis1289'/19inpc-074
     6x,'(helicity). use a blank for the usual helicity',7x,'ecis1290'/1inpc-075
     79x,'description.',41x,'ecis1291'/10x,'2   lt2  ''t'' if the observinpc-076
     8able is not completely defined by   ecis1292'/19x,'tensors. see noinpc-077
     9te below ''quantum numbers''.',11x,'ecis1293'/10x,'3   blank or 0 inpc-078
     afor observable in the center of mass system.   ecis1294'/14x,'1',1inpc-079
     b0x,'for observable in the laboratory system.',7x,'ecis1295'/14x,'2inpc-080
     c',10x,'for observable defined with respect to the',5x,'ecis1296'/3inpc-081
     d0x,'incident beam.',28x,'ecis1297'/7x,'4- 5   kx   positive numberinpc-082
     e, identification of the observable',4x,'ecis1298'/19x,'read with -inpc-083
     fkx.',39x,'ecis1299'/7x,'6-10   k',4x,'number of components of the inpc-084
     gdescription.',13x,'ecis1300'/6x,'11-30   name of the observable whinpc-085
     hich will be used in the output.  ecis1301'/72x,'ecis1302'/'quantuminpc-086
     i numbers',25x,'format (8i5)',20x,'ecis1303'/'***************',57x,inpc-087
     j'ecis1304'/7x,'1- 5   tensor order of the incoming particle.',20x,inpc-088
     k'ecis1305')                                                       inpc-089
      write (2,1060)                                                    inpc-090
 1060 format (7x,'6-10   related magnetic quantum number.',26x,'ecis1306inpc-091
     1'/6x,'11-15   tensor order of the initial nucleus.',22x,'ecis1307'inpc-092
     2/6x,'16-20   related magnetic quantum number.',26x,'ecis1308'/6x,'inpc-093
     321-25   tensor order of the outgoing particle.',20x,'ecis1309'/6x,inpc-094
     4'26-30   related quantum number.',35x,'ecis1310'/6x,'31-35   tensoinpc-095
     5r order of the final nucleus.',24x,'ecis1311'/6x,'36-40   related inpc-096
     6quantum number.',35x,'ecis1312'/4x,'there are k such cards.',45x,'inpc-097
     7ecis1313'/'  note:  if lt2=.true., some couples (tensor order, maginpc-098
     8netic quantum',4x,'ecis1314'/'  ****  number) can be replaced by ninpc-099
     9on tensor notation (mi, mf). in thisecis1315'/8x,'case, use (mi-s-inpc-100
     a1) and (mf-s-1) where s is the spin of particle ecis1316'/8x,'or tinpc-101
     barget.',54x,'ecis1317'/72x,'ecis1318'/''/'coefficients of componeinpc-102
     cnts',14x,'format (6f10.5)',17x,'ecis1319'/'***********************inpc-103
     d***',46x,'ecis1320'/7x,'1-10   coefficient of the first component.inpc-104
     e',23x,'ecis1321'/6x,'11-20   coefficient of the second component.'inpc-105
     f,22x,'ecis1322'/6x,'21-30   ...................',39x,'ecis1323'/14inpc-106
     gx,'up to k values.',43x,'ecis1324'/72x,'ecis1325'/'imaginary part inpc-107
     hof coefficients',10x,'format (6f10.5)',17x,'ecis1326'/'***********inpc-108
     i*******************',42x,'ecis1327'/' only if lt1=.true. or lt2=.tinpc-109
     jrue., otherwise go to next observable.',5x,'ecis1328'/7x,'1-10   iinpc-110
     kmaginary part for the first component.',19x,'ecis1329')           inpc-111
      write (2,1061)                                                    inpc-112
 1061 format (6x,'11-20   imaginary part for the second component.',18x,inpc-113
     1'ecis1330'/6x,'21-30   ....................',38x,'ecis1331'/14x,'uinpc-114
     2p to k values.',43x,'ecis1332'/'  note:  the quantum numbers are cinpc-115
     3hecked and errors can stop the',8x,'ecis1333'/'  ****  program (toinpc-116
     4o large magnetic quantum numbers, negative tensor',4x,'ecis1334'/8inpc-117
     5x,'order, odd sum of magnetic quantum numbers for observable',7x,'inpc-118
     6ecis1335'/8x,'defined with the axis perpendicular to the reaction inpc-119
     7plane).',5x,'ecis1336'/9x,'the observables can be read in any ordeinpc-120
     8r.',22x,'ecis1337'/9x,'polarisation of the target is described in inpc-121
     9the system of the   ecis1338'/8x,'particle.',55x,'ecis1339'/72x,'einpc-122
     acis1340'/72x,'ecis1341'/'cards read in subroutine redm',43x,'ecis1inpc-123
     b342'/'******************************',42x,'ecis1343'/6x,'if lo(7)=inpc-124
     c.true. or lo(15)=.true.. otherwise go to ''cards read in  ecis1344inpc-125
     d'/3x,'subroutine eval''.',52x,'ecis1345'/72x,'ecis1346'/6x,'in theinpc-126
     e subroutine redm, there is the following do loop:',11x,'ecis1347'/inpc-127
     f10x,'do 16 i1=1,ncoll',46x,'ecis1348'/10x,'do 15 i2=i1,ncoll',45x,inpc-128
     g'ecis1349'/10x,'.........',53x,'ecis1350'/7x,'15 continue',54x,'ecinpc-129
     his1351'/7x,'16 continue',54x,'ecis1352'/6x,'inside which must be rinpc-130
     iead:',40x,'ecis1353'/72x,'ecis1354'/'loop control and number card'inpc-131
     j,12x,'format (3i5)',20x,'ecis1355'/'****************************',inpc-132
     k44x,'ecis1356')                                                   inpc-133
      write (2,1062)                                                    inpc-134
 1062 format (7x,'1- 5   j1 which must be equal to i1. (if not the run iinpc-135
     1s stopped).ecis1357'/7x,'6-10   j2 which must be equal to i2. (if inpc-136
     2not the run is stopped).ecis1358'/6x,'11-15   k  number of reducedinpc-137
     3 nuclear matrix elements.',13x,'ecis1359'/72x,'ecis1360'/'reduced inpc-138
     4nuclear matrix elements',9x,'format (4i5,f20.12)',13x,'ecis1361'/'inpc-139
     5*******************************',41x,'ecis1362'/'if k is not 0:',5inpc-140
     68x,'ecis1363'/7x,'1- 5   form factor identification.',31x,'ecis136inpc-141
     74'/7x,'6-10   multipolarity. (if triangular relation  or parity isinpc-142
     8',6x,'ecis1365'/18x,'transgressed the run is stopped). enter l forinpc-143
     9 a',7x,'ecis1366'/18x,'magnetic multipole transition bm(l-1).',16xinpc-144
     a,'ecis1367'/6x,'11-15   2*s where s is the transfer of spin. s caninpc-145
     b be not 0 even  ecis1368'/18x,'if lo(7)=.false. (if lo(7)=.true. tinpc-146
     che run is stopped  ecis1369'/18x,'when triangular relation is not inpc-147
     dfulfilled).',11x,'ecis1370'/14x,'indication for existence of magneinpc-148
     etic multipole coulomb',4x,'ecis1371'/18x,'form factor for the targinpc-149
     fet, with s=0: enter ''-1''.',5x,'ecis1372'/18x,'this form factor iinpc-150
     gncludes no central and no',11x,'ecis1373'/18x,'spin-orbit contribuinpc-151
     htion.',30x,'ecis1374'/6x,'16-20   2*j where j is the transfer of tinpc-152
     iotal spin if the value',4x,'ecis1375'/18x,'given for 2*s is not ''inpc-153
     j0'' or ''-1''. in this case the',4x,'ecis1376'/18x,'calculation isinpc-154
     k stopped if there is not a triangular   ecis1377')                inpc-155
      write (2,1063)                                                    inpc-156
 1063 format (18x,'relation between l, s and j.',26x,'ecis1378'/''/14x,inpc-157
     1'indication for existence of an associated spin-orbit form ecis137inpc-158
     29'/18x,'factor when 2*s is ''0'': enter ''1'' if there is one,',4xinpc-159
     3,'ecis1380'/18x,'''0'' or a blank if there is none.',22x,'ecis1381inpc-160
     4'/6x,'21-40   value. the ratio between a magnetic multipole coulominpc-161
     5b',5x,'ecis1382'/18x,'excitation bm(l-1) and an electric one be(l)inpc-162
     6 is',7x,'ecis1383'/18x,'sqrt(bm(l-1)/be(l)) (sqrt(.01106*bm(l-1)/binpc-163
     7e(l)) if',4x,'ecis1384'/18x,'bm(l-1) is expressed in nuclear magneinpc-164
     8tons squares.',4x,'ecis1385'/8x,'there are k such cards.',41x,'eciinpc-165
     9s1386'/72x,'ecis1387'/4x,'form factor identification',42x,'ecis138inpc-166
     a8'/4x,'**************************',42x,'ecis1389'/6x,'for anharmoninpc-167
     bic vibrational model: the order of derivative.',8x,'ecis1390'/13x,inpc-168
     c'(from 0 to 3).',45x,'ecis1391'/6x,'for harmonic vibrational modelinpc-169
     d:',35x,'ecis1392'/13x,'first order:  k1, number of the phonon is oinpc-170
     erder of input.  ecis1393'/13x,'second order: k1+k2*(nbt1+1)  whereinpc-171
     f k1 and k2 are the',6x,'ecis1394'/17x,'number of the phonons in thinpc-172
     ge order of input, with k2   ecis1395'/17x,'larger than k1 and nbt1inpc-173
     h the total number of phonons.   ecis1396'/72x,'ecis1397'/6x,'for sinpc-174
     iymmetric rotational model: 1+l where l is the multipolarity  ecis1inpc-175
     j398'/13x,'multiplied by 1000 plus the identification of the',10x,'inpc-176
     kecis1399')                                                        inpc-177
      write (2,1064)                                                    inpc-178
 1064 format (13x,'vibrational band as in harmonic vibrational model.',9inpc-179
     1x,'ecis1400'/13x,'a l=0 or l=1 vibration term generate a monopole inpc-180
     2or dipole  ecis1401'/13x,'correction term.',43x,'ecis1402'/6x,'forinpc-181
     3 asymmetric rotational model: defined as 1000* the ''order of   ecinpc-182
     4is1403'/13x,'deformation''. (see ''deformations of rotational modeinpc-183
     5ls'').   ecis1404'/72x,'ecis1405'/6x,'for external form factor modinpc-184
     6el: if the form factor identification ecis1406'/13x,'is blank or zinpc-185
     7ero, an identification is defined in sequence ecis1407'/13x,'a neginpc-186
     8ative value indicates that there is a correction term ecis1408'/13inpc-187
     9x,'to be added in such a way that the integral of the sum withecisinpc-188
     a1409'/13x,'r**(l+2) vanishes (l being the angular momentum relatedinpc-189
     b to ecis1410'/13x,'this form factor). if the form factor identificinpc-190
     cation is nonecis1411'/13x,'zero, its absolute value must be in seqinpc-191
     duence or refer to a ecis1412'/13x,'form factor already defined witinpc-192
     eh the same sign.',12x,'ecis1413'/72x,'ecis1414'/'  note on reducedinpc-193
     f matrix elements:  the spin angular description for a  ecis1415'/'inpc-194
     g  ********************************  partial wave with total spin jinpc-195
     hj and ecis1416'/'  with quantum numbers l1 and j1 for the particleinpc-196
     i, i1 for the target is ecis1417'/'  ((i**l1*y(l1) , s1)j1 ,i1)jj. inpc-197
     jthe interaction for the transfer of',5x,'ecis1418')               inpc-198
      write (2,1065)                                                    inpc-199
 1065 format ('  angular momentum l, of spin s and of total spin j, is tinpc-200
     1he scalar',6x,'ecis1419'/'  product of a tensor operator q(j)nucleinpc-201
     2ar for the target by the tensor ecis1420'/'  product of (i**l*y(l)inpc-202
     3 , q(s)par)j for the particle.',19x,'ecis1421'/4x,'(((l2,s2)j2,i2)inpc-203
     4jj|(q(l),q(s))j.q(j)|((l1,s1)j1,i1)jj) =',13x,'ecis1422'/'  (-)**(inpc-204
     5jj+i2+j1+(l1+l2+l)/2)) * c9j(l2,l1,l,s2,s1,s,j2,j1,j) *',9x,'ecis1inpc-205
     6423'/'  c6j(j2,j,j1,i1,jj,i2) * c3j(l1,l,l2,0,0,0) * sqrt((2j+1)*(inpc-206
     72l+1)*',6x,'ecis1424'/'  (2s+1)(2l1+1)*(2l2+1)*(2j1+1)*(2j2+1)) /cinpc-207
     8omputed in subroutine quan/  ecis1425'/'  * (s2||q(s)||s1)/(2s+1) inpc-208
     9* (i2||q(j)||i1) * (4*pi)**(-1/2) /which is   ecis1426'/'  the redinpc-209
     auced nuclear matrix element read here, except for the square   eciinpc-210
     bs1427'/'  root which is included in form factors/.',30x,'ecis1428'inpc-211
     c/72x,'ecis1429'/4x,'this matrix element is real and symmetric wheninpc-212
     d the ''reduced nuclear ecis1430'/'  matrix element'' is such that inpc-213
     e (s2,i2 || q(s) q(j) ||s1,i1) =',10x,'ecis1431'/'  (-)**(i2+s2-i1-inpc-214
     fs1+s+j) * (s1,i1 || q(s) q(j) ||s2,i2). in macroscopic ecis1432'/'inpc-215
     g  models, s=0 and the phase becomes (-)**(i2-i1)*(product of paritinpc-216
     hies). ecis1433'/4x,'a factor i**(-l) must be taken into account ininpc-217
     i the definition of',4x,'ecis1434'/'  q(j)nuclear and a phase i intinpc-218
     jroduced for negative parity states.',6x,'ecis1435')               inpc-219
      write (2,1066)                                                    inpc-220
 1066 format (4x,'when s=0, (s2|| ||s1) = sqrt(2*s1+1) is computed in suinpc-221
     1broutine quan ecis1436'/4x,'the factor (2s+1) introduced in quan tinpc-222
     2o use the same reduced matrix ecis1437'/'  element when target andinpc-223
     3 particle are exchanged.',23x,'ecis1438'/''/4x,'for a magnetic muinpc-224
     4ltipole coulomb transition bm(l-1), the form factorecis1439'/'  isinpc-225
     5 the one of an electric multipole transition be(l) divided by',7x,inpc-226
     6'ecis1440'/'  mr(m*c/hbar)**2, where m and mr and mp are atomic aninpc-227
     7d reduced masses  ecis1441'/'  respectively.',57x,'ecis1442'/72x,'inpc-228
     8ecis1443'/72x,'ecis1444'/'cards read in subroutine extp',43x,'ecisinpc-229
     91445'/'*****************************',43x,'ecis1446'/'  if (lo(7)=inpc-230
     a.true., otherwise go to ''cards read in subroutine eval''.',4x,'ecinpc-231
     bis1447'/72x,'ecis1448'/'identification',26x,'format (12i5)',19x,'einpc-232
     ccis1449'/'**************',58x,'ecis1450'/7x,'1- 5   l1',4x,'level inpc-233
     di.',44x,'ecis1451'/7x,'6-10   l2',4x,'level ip.',43x,'ecis1452'/6xinpc-234
     e,'11-15   ml',4x,'sequence number of the form factor in the table inpc-235
     fof  ecis1453'/20x,'reduced nuclear matrix elements between level iinpc-236
     g and ecis1454'/20x,'level ip. it must be 0 for potentials. use theinpc-237
     h',6x,'ecis1455'/20x,'value -ml to enter the correction term to theinpc-238
     i form  ecis1456'/20x,'factor read with ml.',32x,'ecis1457'/6x,'16-inpc-239
     j20   ityp =  1 real volume or scalar potential',17x,'ecis1458'/22xinpc-240
     k,'2 imaginary volume or scalar potential',12x,'ecis1459')         inpc-241
      write (2,1067)                                                    inpc-242
 1067 format (22x,'3 real surface or vector potential',16x,'ecis1460'/22inpc-243
     1x,'4 imaginary surface or vector potential',11x,'ecis1461'/22x,'5 inpc-244
     2real spin-orbit or tensor potential',13x,'ecis1462'/22x,'6 imaginainpc-245
     3ry spin-orbit or tensor potential',8x,'ecis1463'/22x,'7 coulomb poinpc-246
     4tential',31x,'ecis1464'/22x,'8 coulomb spin-orbit potential',20x,'inpc-247
     5ecis1465'/6x,'21-25   l1x   non positive or l1 of the form factor inpc-248
     6to be copied  ecis1466'/20x,'into the new one.',35x,'ecis1467'/6x,inpc-249
     7'26-30   l2x   l2 of the form factor to be copied if l1x is not',4inpc-250
     8x,'ecis1468'/20x,'positive.',43x,'ecis1469'/6x,'31-35   mlx   sameinpc-251
     9 for ml if l1x is not positive.',17x,'ecis1470'/6x,'36-40   itypx inpc-252
     asame for ityp if l1x is not positive, must be equal ecis1471'/20x,inpc-253
     b'to ityp.',44x,'ecis1472'/20x,'negative number for standard form finpc-254
     cactors with non  ecis1473'/20x,'positive value of l1x in columns 2inpc-255
     d1-30:',13x,'ecis1474'/24x,'-1  woods-saxon potential.',22x,'ecis14inpc-256
     e75'/24x,'-2  first derivative of woods-saxon potential.  ecis1476'inpc-257
     f/24x,'-3  second derivative of woods-saxon potential. ecis1477'/24inpc-258
     gx,'-4  third derivative of woods-saxon potential.  ecis1478'/12x,'inpc-259
     h(the n th derivative is always divided by fact(n)*sqrt(4*pi)ecis14inpc-260
     i79'/17x,'and multiplied by r**n only if lo(6)=.false.)',10x,'ecis1inpc-261
     j480'/24x,'-5  deformed woods-saxon potential.',13x,'ecis1481'/24x,inpc-262
     k'-6  derivative of deformed woods-saxon potentialecis1482')       inpc-263
      write (2,1068)                                                    inpc-264
 1068 format (24x,'-7  laguerre polynomial.',24x,'ecis1483'/24x,'-8  solinpc-265
     1ution in real woods-saxon potential.',5x,'ecis1484'/24x,'-9  besseinpc-266
     2l expansion.',27x,'ecis1485'/24x,'-10 expansion with laguerre polyinpc-267
     3nomials.',8x,'ecis1486'/20x,'(see below ''special meaning of l1x, inpc-268
     4l2x and mlx ..'')ecis1487'/6x,'41-45   nst   channel of which the inpc-269
     5step size is used (default',5x,'ecis1488'/20x,'value: the channel inpc-270
     6which uses it for a central',6x,'ecis1489'/20x,'potential, 1 for ainpc-271
     7 transition potential). if nst is ecis1490'/20x,'negative for a stinpc-272
     8andard form factor with itypx=-1 toecis1491'/20x,'itypx=-6, use ofinpc-273
     9 a reduced radius, taking into',6x,'ecis1492'/20x,'account lo(16) inpc-274
     a(heavy-ion definition) and lo(6)',5x,'ecis1493'/20x,'(use of deforinpc-275
     bmation lengths).',23x,'ecis1494'/6x,'46-50   nfold 0 for no foldininpc-276
     cg or address of folding parameters   ecis1495'/20x,'in their list inpc-277
     dread below. nfold can be different forecis1496'/''/20x,'a copied inpc-278
     eform factor and allows the folding with a  ecis1497'/20x,'differeninpc-279
     ft multipolarity. it can be used with a',6x,'ecis1498'/20x,'form fainpc-280
     gctor given by points.',24x,'ecis1499'/6x,'51-55   nint  if not 0, inpc-281
     hthe strength is the integral of this form ecis1500'/20x,'factor wiinpc-282
     ith r**(l+2) where l is the relevant angularecis1501'/20x,'momentuminpc-283
     j. when nint, is a positive number, the',6x,'ecis1502'/20x,'integrainpc-284
     kl with r**(l+1) has to be given; with a',6x,'ecis1503')           inpc-285
      write (2,1069)                                                    inpc-286
 1069 format (20x,'negative integer, the usual strength has to be giveneinpc-287
     1cis1504'/20x,'and is replaced by this integral at its first',7x,'einpc-288
     2cis1505'/20x,'calculation. for spin-orbit potentials, it is the   inpc-289
     3ecis1506'/20x,'integral of the form factor without derivation. thiinpc-290
     4secis1507'/20x,'strength is of the same sign as the depth of the',inpc-291
     54x,'ecis1508'/20x,'standard description. for coulomb potentials, tinpc-292
     6his  ecis1509'/20x,'strength is the last value multiplied by',12x,inpc-293
     7'ecis1510'/20x,'(2*l+1)*r**(l+1)/1.43998 . if nst is negative for inpc-294
     8a ecis1511'/20x,'form factor copied, input of a multiplication facinpc-295
     9torecis1512'/20x,'in next card.',39x,'ecis1513'/72x,'ecis1514'/'meinpc-296
     aaning of l1x, l2x and mlx for negative values of itypx (columns 36inpc-297
     b-40)ecis1515'/'***************************************************inpc-298
     c*********************ecis1516'/6x,'21-25   l1x   -l1x is the magneinpc-299
     dtic quantum number of the vibrationecis1517'/20x,'when itypx=-6.',inpc-300
     e38x,'ecis1518'/20x,'-l1x is the number of nodes when itypx=-7 or -inpc-301
     f8',5x,'ecis1519'/20x,'(used only when mlx=0 or mlx=1).',20x,'ecis1inpc-302
     g520'/20x,'-l1x is the order of derivation of bessel functions ecisinpc-303
     h1521'/20x,'or laguerre polynomials when itypx=-9 or -10.',7x,'ecisinpc-304
     i1522'/6x,'26-30   l2x   number of deformations when itypx=-5 or -6inpc-305
     j.',9x,'ecis1523'/20x,'a division factor for the steps in computinginpc-306
     k bound  ecis1524')                                                inpc-307
      write (2,1070)                                                    inpc-308
 1070 format (20x,'function (default value 4) when itypx=-8.',11x,'ecis1inpc-309
     1525'/20x,'number of bessel functions or laguerre polynomials  ecisinpc-310
     21526'/20x,'when itypx=-9 or -10.',31x,'ecis1527'/6x,'31-35   mlx  inpc-311
     3 angular momentum of the vibration when itypx=-6.',4x,'ecis1528'/2inpc-312
     40x,'number of bound functions when itypx=-7 or -8:',6x,'ecis1529'/inpc-313
     520x,'=0 or 1 for one function with the quantum numbers ofecis1530'inpc-314
     6/31x,'the transition,',26x,'ecis1531'/20x,'=2 for two functions wiinpc-315
     7th the same itypx,',11x,'ecis1532'/20x,'=3 when itypx=-8 for a laginpc-316
     8uerre polynomial for the  ecis1533'/31x,'second function.',25x,'ecinpc-317
     9is1534'/20x,'l-value of bessel functions or laguerre polynomials einpc-318
     acis1535'/20x,'when itypx=-9 or -10 (default option: angular',7x,'einpc-319
     bcis1536'/20x,'momentum of the form factor, enter a negative value inpc-320
     cecis1537'/20x,'to use 0).',42x,'ecis1538'/'  errors in this card sinpc-321
     dtop the program.',33x,'ecis1539'/72x,'ecis1540'/'  note:  if thereinpc-322
     e is no spin for the particle in all the channels, the  ecis1541'/'inpc-323
     f  ****  spin-orbit potentials (ityp = 5 , 6 and 8) are not read, binpc-324
     gut',4x,'ecis1542'/8x,'they are required as soon as there is at leainpc-325
     hst a non spin-0',5x,'ecis1543'/8x,'particle at least for one levelinpc-326
     i. for the transitions with a',5x,'ecis1544'/8x,'transfer of spin sinpc-327
     j which is not zero there are no spin-orbit',4x,'ecis1545')        inpc-328
      write (2,1071)                                                    inpc-329
 1071 format (8x,'potentials (no tensor term in dirac formalism). there inpc-330
     1is a',6x,'ecis1546'/8x,'coulomb potential for integral spin transfinpc-331
     2er even for l=0.',6x,'ecis1547'/9x,'volume and surface potentials inpc-332
     3are read separately except for   ecis1548'/8x,'itypx=-7 and -8. ininpc-333
     4 the dirac formalism itypx=-7 and itypx=-8   ecis1549'/8x,'cannot inpc-334
     5be used. for magnetic coulomb interaction, only the',6x,'ecis1550'inpc-335
     6/8x,'coulomb potential is read. the form factors with itypx=-5 to inpc-336
     7-9 ecis1551'/8x,'can be copied only if they involve the same multiinpc-337
     8polarity. thereecis1552'/8x,'is no limitation for itypx=-7 and -8 inpc-338
     9if they involve two bound  ecis1553'/8x,'functions. the copied forinpc-339
     am factors can be folded differently.   ecis1554'/72x,'ecis1555'/'inpc-340
     b'/' allowed values of itypx for standard potentials',24x,'ecis1556inpc-341
     c'/' ***********************************************',24x,'ecis1557inpc-342
     d'/' *** ml = 0 ******',54x,'ecis1558'/' itypx =',4x,'-1',4x,'-2',4inpc-343
     ex,'-3',4x,'-4',4x,'-5',4x,'-6',4x,'-7',4x,'-8  -9,-10',8x,'ecis155inpc-344
     f9'/' ityp = 1   yes   no',4x,'no',4x,'no',4x,'yes   no',4x,'no',4xinpc-345
     g,'no   yes',10x,'ecis1560'/' ityp = 2   yes   no',4x,'no',4x,'no',inpc-346
     h4x,'yes   no',4x,'no',4x,'no   yes',10x,'ecis1561'/' ityp = 3   yeinpc-347
     is   no',4x,'no',4x,'no',4x,'yes   no',4x,'no',4x,'no   yes',10x,'einpc-348
     jcis1562'/' ityp = 4   yes   no',4x,'no',4x,'no',4x,'yes   no',4x,'inpc-349
     kno',4x,'no   yes',10x,'ecis1563')                                 inpc-350
      write (2,1072)                                                    inpc-351
 1072 format (' ityp = 5   yes   no',4x,'no',4x,'no',4x,'yes   no',4x,'ninpc-352
     1o',4x,'no   yes',10x,'ecis1564'/' ityp = 6   yes   no',4x,'no',4x,inpc-353
     2'no',4x,'yes   no',4x,'no',4x,'no   yes',10x,'ecis1565'/' ityp = 7inpc-354
     3   yes   no',4x,'no',4x,'no',4x,'yes   no',4x,'no',4x,'no   yes',1inpc-355
     40x,'ecis1566'/' ityp = 8   yes   no',4x,'no',4x,'no',4x,'yes   no'inpc-356
     5,4x,'no',4x,'no   yes',10x,'ecis1567'/' **** ml is not 0 ****',50xinpc-357
     6,'ecis1568'/' itypx =',4x,'-1',4x,'-2',4x,'-3',4x,'-4',4x,'-5',4x,inpc-358
     7'-6',4x,'-7',4x,'-8  -9,-10',8x,'ecis1569'/' ityp = 1   yes   yes inpc-359
     8  yes   yes   yes   yes   yes   yes  yes',10x,'ecis1570'/' ityp = inpc-360
     92   yes   yes   yes   yes   yes   yes   yes   yes  yes',10x,'ecis1inpc-361
     a571'/' ityp = 3   yes   yes   yes   yes   yes   yes   no',4x,'no  inpc-362
     b yes',10x,'ecis1572'/' ityp = 4   yes   yes   yes   yes   yes   yeinpc-363
     cs   no',4x,'no   yes',10x,'ecis1573'/' ityp = 5   yes   yes   yes inpc-364
     d  yes   yes   yes   no',4x,'no   yes',10x,'ecis1574'/' ityp = 6   inpc-365
     eyes   yes   yes   yes   yes   yes   no',4x,'no   yes',10x,'ecis157inpc-366
     f5'/' ityp = 7   no',4x,'yes   yes   yes   yes   yes   no',4x,'no  inpc-367
     g yes',10x,'ecis1576'/' ityp = 8   no',4x,'yes   yes   yes   yes   inpc-368
     hyes   no',4x,'no   yes',10x,'ecis1577'/72x,'ecis1578'/' number of inpc-369
     iparameters to store:',41x,'ecis1579'/12x,'10',4x,'10',4x,'10',4x,'inpc-370
     j10  11+l2x 13+l2x 11',4x,'22   13+l2x',7x,'ecis1580'/' there is oninpc-371
     ke more for coulomb potentials and itypx=-1 to -6.',11x,'ecis1581')inpc-372
      write (2,1073)                                                    inpc-373
 1073 format (' there are 5 more parameters for itypx=-7 and mlx=2.',20xinpc-374
     1,'ecis1582'/' there are 16 or 6 more parameters for itypx=-8 and minpc-375
     2lx=2 or mlx=3.',5x,'ecis1583'/72x,'ecis1584'/'strength and scalinginpc-376
     3 factor',13x,'format (7f10.5)',17x,'ecis1585'/'*******************inpc-377
     4********',45x,'ecis1586'/'  if itypx is negative go to ''parameterinpc-378
     5s of standard form factors''.',5x,'ecis1587'/'  then if l1x is posinpc-379
     6itive go back to ''identification'' card.',13x,'ecis1588'/10x,'1  inpc-380
     7 .true. to allow extrapolation beyond the last point. if itecis158inpc-381
     89'/14x,'is .false., values beyond the last point will be 0.',7x,'einpc-382
     9cis1590'/7x,'2-10   multiplicative factor for the strength (defaulinpc-383
     at value 1.).ecis1591'/6x,'11-20   multiplicative factor for the stinpc-384
     bep size (default value 1.)ecis1592'/72x,'ecis1593'/'numerical valuinpc-385
     ces of the potentials',6x,'format (2(f10.5,f20.10),a4)',5x,'ecis159inpc-386
     d4'/'**********************************',38x,'ecis1595'/7x,'1-10   inpc-387
     erext  radius.',45x,'ecis1596'/6x,'11-30   fext  value at rext.',38inpc-388
     fx,'ecis1597'/6x,'31-40   rext  radius.',45x,'ecis1598'/6x,'41-60  inpc-389
     g fext  value at rext.',38x,'ecis1599'/6x,'61-64   last  control woinpc-390
     hrd which must be ''last'' for the last pointecis1600'/7x,'if this inpc-391
     icontrol word is not ''last'' go to next such card.',9x,'ecis1601'/inpc-392
     j'  note:  the given radii must be in increasing order and their nuinpc-393
     kmber   ecis1602')                                                 inpc-394
      write (2,1074)                                                    inpc-395
 1074 format ('  ***** even. many points are needed for coulomb potentiainpc-396
     1l for which theecis1603'/8x,'extrapolation does not work well. if inpc-397
     2its depth is given by the  ecis1604'/8x,'integral, (nint not 0), tinpc-398
     3hese values describe the charge',8x,'ecis1605'/8x,'distribution.',inpc-399
     451x,'ecis1606'/9x,'the sign of the potentials is the one of their inpc-400
     5depth when',6x,'ecis1607'/8x,'woods-saxon form factors are used foinpc-401
     6r schroedinger equations andecis1608'/8x,'for dirac equation.',45xinpc-402
     7,'ecis1609'/9x,'the spin-orbit ''central'' have to be given as 1/rinpc-403
     8 d/dr(v(r))',4x,'ecis1610'/8x,'except if its strength is defined binpc-404
     9y its integral or is folded. ecis1611'/9x,'the spin-orbit transitiinpc-405
     aon potentials have to be given as v(r), ecis1612'/8x,'from which 1inpc-406
     b/r d/dr(v(r)) and v(r)/r**2 are internally computed.ecis1613'/72x,inpc-407
     c'ecis1614'/''/'multiplicative factor',19x,'format (7f10.5)',17x,'inpc-408
     decis1615'/'*********************',51x,'ecis1616'/'  if nint is notinpc-409
     e negative for a copied form factor go back to',11x,'ecis1617'/'''iinpc-410
     fdentification'' card.',50x,'ecis1618'/7x,'1-10   multiplicative fainpc-411
     gctor for the strength (must not be 0.).  ecis1619'/72x,'ecis1620'/inpc-412
     h'parameters of standard form factors',37x,'ecis1621'/'************inpc-413
     i***********************',37x,'ecis1622'/' only if l1x is not positinpc-414
     jive and itypx is negative, otherwise go to',5x,'ecis1623'/' next 'inpc-415
     k'identification card''.',44x,'ecis1624'/72x,'ecis1625')           inpc-416
      write (2,1075)                                                    inpc-417
 1075 format ('if itypx=-1 to -6:',54x,'ecis1626'/'******************',5inpc-418
     14x,'ecis1627'/72x,'ecis1628'/'parameters of the potential',13x,'foinpc-419
     2rmat (7f10.5)',17x,'ecis1629'/'***************************',45x,'einpc-420
     3cis1630'/7x,'1-10   depth of potential.',39x,'ecis1631'/14x,'produinpc-421
     4ct of depth and deformation for a transition form',4x,'ecis1632'/1inpc-422
     58x,'factor.',47x,'ecis1633'/14x,'product of charges for coulomb poinpc-423
     6tential.',17x,'ecis1634'/14x,'product of charges and deformation finpc-424
     7or coulomb transition ecis1635'/18x,'form factor.',42x,'ecis1636'/inpc-425
     86x,'11-20   radius of volume potential.',31x,'ecis1637'/6x,'21-30 inpc-426
     9  diffuseness of volume potential.',26x,'ecis1638'/6x,'31-40   expinpc-427
     aonentiation factor (the form factor is at the power',4x,'ecis1639'inpc-428
     b/18x,'1+this value).',40x,'ecis1640'/6x,'41-50   third parameter oinpc-429
     cf a fermi charge distribution for a',6x,'ecis1641'/14x,'coulomb poinpc-430
     dtential.',40x,'ecis1642'/72x,'ecis1643'/'deformations for itypx=-5inpc-431
     e or -6',9x,'format (7f10.5)',17x,'ecis1644'/'*********************inpc-432
     f**********',41x,'ecis1645'/7x,'1-10   deformation for l=1.',38x,'einpc-433
     gcis1646'/6x,'11-20   deformation for l=2.',38x,'ecis1647'/6x,'21-3inpc-434
     h0   deformation for l=3.',38x,'ecis1648'/6x,'31-40   deformation finpc-435
     ior l=4.',38x,'ecis1649'/6x,'41-50   .......... and so on up to l2xinpc-436
     j ....',23x,'ecis1650'/'  note:  odd and even deformations are usedinpc-437
     k, starting by l=1.',11x,'ecis1651')                               inpc-438
      write (2,1076)                                                    inpc-439
 1076 format ('  ****  the radii must be values already multiplied by a*inpc-440
     1*(1/3).',8x,'ecis1652'/8x,'no check is done on product of charges inpc-441
     2when they are read or to ecis1653'/8x,'prevent a search on them.',inpc-442
     339x,'ecis1654'/72x,'ecis1655'/'if itypx=-7 or -8:',54x,'ecis1656'/inpc-443
     4'******************',54x,'ecis1657'/72x,'ecis1658'/'quantum numberinpc-444
     5s',25x,'format (12i5)',19x,'ecis1659'/'***************',57x,'ecis1inpc-445
     6660'/'if mlx=0 or mlx=1, the number of nodes is l2x and the quantuinpc-446
     7m numbers   ecis1661'/'are those of the transition. in this case, inpc-447
     8go to next card.',13x,'ecis1662'/'if mlx=2 or mlx=3:',54x,'ecis166inpc-448
     93'/7x,'1- 5   np: number of nodes of the first bound function.',10inpc-449
     ax,'ecis1664'/7x,'6-10   lp: angular momentum of the first bound fuinpc-450
     bnction.',9x,'ecis1665'/6x,'11-15   sp: value of 2*s for the first inpc-451
     cbound function.',12x,'ecis1666'/6x,'16-20   jp: value of 2*j for tinpc-452
     dhe first bound function.',12x,'ecis1667'/6x,'21-25   nh: number ofinpc-453
     e nodes of the second bound function.',9x,'ecis1668'/6x,'26-30   lhinpc-454
     f: angular momentum of the second bound function.',8x,'ecis1669'/6xinpc-455
     g,'31-35   sh: value of 2*s for the second bound function.',11x,'ecinpc-456
     his1670'/6x,'36-40   jh: value of 2*j for the second bound functioninpc-457
     i.',11x,'ecis1671'/6x,'41-45   nvc not 0 to take into account partiinpc-458
     jcle-hole coupling',5x,'ecis1672'/18x,'(used only with sp=1 and sh=inpc-459
     k1).',23x,'ecis1673'/72x,'ecis1674'/'')                            inpc-460
      write (2,1077)                                                    inpc-461
 1077 format ('for itypx=-7:',27x,'format (7f10.5)',17x,'ecis1675'/'****inpc-462
     1*********',59x,'ecis1676'/7x,'1-10   oscillator parameter for the inpc-463
     2first bound function.',8x,'ecis1677'/6x,'11-20   oscillator parameinpc-464
     3ter for the second bound function.',7x,'ecis1678'/'for mlx=0 or 1 inpc-465
     4or itypx=-8 with mlx=3, only the first parameter is read.ecis1679'inpc-466
     5/'for mlx=2, if the second parameter is 0., the first one is copieinpc-467
     6d.',6x,'ecis1680'/72x,'ecis1681'/'for itypx=-8:',27x,'format (7f10inpc-468
     7.5)',17x,'ecis1682'/'*************',59x,'ecis1683'/7x,'1-10   bindinpc-469
     8ing energy. if this value is negative, the bound stateecis1684'/14inpc-470
     9x,'is replaced by a scattering state normalised to',11x,'ecis1685'inpc-471
     a/14x,'sin(kr+delta) at infinity.',32x,'ecis1686'/6x,'11-20   totalinpc-472
     b mass.',47x,'ecis1687'/6x,'21-30   mass of bound particle (defaultinpc-473
     c value 1.).',16x,'ecis1688'/6x,'31-40   product of charges.',39x,'inpc-474
     decis1689'/6x,'41-50   real potential for unbound states or startininpc-475
     eg value for   ecis1690'/14x,'the search on bound state (default vainpc-476
     flues 35 mev).',8x,'ecis1691'/6x,'51-60   reduced radius of real poinpc-477
     gtential.',25x,'ecis1692'/6x,'61-70   diffuseness of real potentialinpc-478
     h.',28x,'ecis1693'/72x,'ecis1694'/'on next card:',27x,'format (7f10inpc-479
     i.5)',17x,'ecis1695'/'*************',59x,'ecis1696'/7x,'1-10   deptinpc-480
     jh of spin-orbit potential.',28x,'ecis1697'/6x,'11-20   reduced radinpc-481
     kius of spin-orbit potential.',19x,'ecis1698')                     inpc-482
      write (2,1078)                                                    inpc-483
 1078 format (6x,'21-30   diffuseness of spin-orbit potential.',22x,'eciinpc-484
     1s1699'/6x,'31-40   reduced radius of coulomb potential.',22x,'ecisinpc-485
     21700'/'for mlx=2, go back to ''for itypx=-8:''.',34x,'ecis1701'/'finpc-486
     3or mlx=3, go back to ''for itypx=-7:'' to read one oscillator parainpc-487
     4meter. ecis1702'/'  note:  reduced radii are used for itypx=-8.',2inpc-488
     57x,'ecis1703'/'  ****  using the product of two bound functions, tinpc-489
     6heir coupling to the ecis1704'/8x,'angular momentum of the transitinpc-490
     7ion is computed by the code only ecis1705'/8x,'if their spins are inpc-491
     8both 1/2 and the nuclear matrix element',6x,'ecis1706'/8x,'should inpc-492
     9be the strength of the interaction. for spins not 1/2,   ecis1707'inpc-493
     a/8x,'this coupling should be included in the nuclear matrix elemeninpc-494
     bt. ecis1708'/72x,'ecis1709'/'if itypx=-9 or -10:',53x,'ecis1710'/'inpc-495
     c*******************',53x,'ecis1711'/72x,'ecis1712'/'strengths',31xinpc-496
     d,'format (7f10.5)',17x,'ecis1713'/'*********',63x,'ecis1714'/8x,'1inpc-497
     e-10   strength of the integral with r**(l+2). (for coulomb',5x,'ecinpc-498
     fis1715'/15x,'potentials and couplings, give the description of',8xinpc-499
     g,'ecis1716'/15x,'charge density or transition. the strength must binpc-500
     he',7x,'ecis1717'/15x,'given. for potentials, it is the product of inpc-501
     icharges).',4x,'ecis1718'/7x,'11-20   for itypx=-9, radial extensioinpc-502
     jn of bessel function',8x,'ecis1719'/15x,'(default value matching rinpc-503
     kadius).',25x,'ecis1720')                                          inpc-504
      write (2,1079)                                                    inpc-505
 1079 format (15x,'for itypx=-10, parameter b of laguerre polynomial',8xinpc-506
     1,'ecis1721'/15x,'(default value 1). the potential is sum on n of',inpc-507
     210x,'ecis1722'/15x,'x**l l(l+1/2,n,x**2) exp(-x**2/2) where x=r/b.inpc-508
     3',11x,'ecis1723'/7x,'21-30   strength of first bessel function/laginpc-509
     4uerre polynomial.   ecis1724'/7x,'31-40   strength of second besseinpc-510
     5l function/laguerre polynomial.  ecis1725'/7x,'41-50   strength ofinpc-511
     6 third bessel function/laguerre polynomial.   ecis1726'/7x,'51-60 inpc-512
     7  strength of fourth bessel function/laguerre polynomial.  ecis172inpc-513
     87'/7x,'61-70   strength of fifth bessel function/laguerre polynomiinpc-514
     9al.   ecis1728'/72x,'ecis1729'/' eventually, on next card:',14x,'finpc-515
     aormat (7f10.5)',17x,'ecis1730'/' *************************',46x,'einpc-516
     bcis1731'/8x,'1-10   strength of sixth bessel function/laguerre polinpc-517
     cynomial.   ecis1732'/7x,'11-20   strength of seventh bessel functiinpc-518
     don/laguerre polynomial. ecis1733'/7x,'21-30   .......... and so oninpc-519
     e up to l2x ....',22x,'ecis1734'/''/'  note:  with bessel functioninpc-520
     f or laguerre polynomial or laguerre',8x,'ecis1735'/'  ****  polynoinpc-521
     gmials, give the spin-orbit v(r) and never 1/r d/dr v(r).  ecis1736inpc-522
     h'/'  the laguerre polynomials are x**l exp(-x**2) l^(l+1/2)_n(2x**inpc-523
     i2) where ecis1737'/'  x=r/b (unnormalised polynomials as defined iinpc-524
     jn bateman or abramowitz,  ecis1738'/'  with a parameter b inverse inpc-525
     kof the harmonic oscillator parameter).',5x,'ecis1739')            inpc-526
      write (2,1080)                                                    inpc-527
 1080 format (5x,'the program stops if form factors are missing.',21x,'einpc-528
     1cis1740'/72x,'ecis1741'/'folding parameters',22x,'format (7e10.5)'inpc-529
     2,17x,'ecis1742'/'******************',54x,'ecis1743'/'  if the maxiinpc-530
     3mum positive value of ''nfold'' read in columns 46-50 of the ecis1inpc-531
     4744'/'identification cards is n, read n times:',32x,'ecis1745'/8x,inpc-532
     5'1-10   val(25) ''v'' parameter',36x,'ecis1746'/7x,'11-20   val(26inpc-533
     6) ''r'' parameter',36x,'ecis1747'/7x,'21-30   val(27) ''a'' parameinpc-534
     7ter',36x,'ecis1748'/'for explanations, see ''cards read in subroutinpc-535
     8ine lect''.',18x,'ecis1749'/72x,'ecis1750'/72x,'ecis1751'/'cards rinpc-536
     9ead in subroutine eval',43x,'ecis1752'/'**************************inpc-537
     a***',43x,'ecis1753'/3x,'if lo(37)=.true., otherwise go to the begiinpc-538
     bnning of another data set. ecis1754'/72x,'ecis1755'/'number of chainpc-539
     cnges',23x,'format (2l1,i3,i5,f10.5)',8x,'ecis1756'/'**************inpc-540
     d***',55x,'ecis1757'/10x,'1   lo(37)',5x,'.true. for other calls toinpc-541
     e this subroutine',6x,'ecis1758'/25x,'.false. for the last call.',2inpc-542
     f1x,'ecis1759'/10x,'2   lx',9x,'.true. to read another title',19x,'inpc-543
     gecis1760'/7x,'3- 5   nin',8x,'number of parameters to change.',16xinpc-544
     h,'ecis1761'/7x,'6-10   nex',8x,'indication for the use of the valuinpc-545
     ies to be readecis1762'/27x,'>0  increments',31x,'ecis1763'/27x,'=0inpc-546
     j  new values',31x,'ecis1764'/27x,'<0  percentage of increase',19x,inpc-547
     k'ecis1765')                                                       inpc-548
      write (2,1081)                                                    inpc-549
 1081 format (6x,'11-20   ech',8x,'new search scale. (default option 20.inpc-550
     1)',9x,'ecis1766'/72x,'ecis1767'/'card 1',34x,'format (18a4)',19x,'inpc-551
     2ecis1768'/'******',66x,'ecis1769'/'if lx=.true.  new title which winpc-552
     3ill be printed as heading of results.',4x,'ecis1770'/72x,'ecis1771inpc-553
     4'/'identifications',25x,'format (14i5)',19x,'ecis1772'/'**********inpc-554
     5*****',57x,'ecis1773'/7x,'1- 5   index of first parameter.',33x,'einpc-555
     6cis1774'/7x,'6-10   index of second parameter.',32x,'ecis1775'/6x,inpc-556
     7'11-15   ........................',34x,'ecis1776'/10x,'up to nin vinpc-557
     8alues, eventually on other cards, starting in 1-5. ecis1777'/3x,'ninpc-558
     9ote:  a negative value is replaced by zero.',25x,'ecis1778'/3x,'**inpc-559
     a**   index zero is the total energy.',31x,'ecis1779'/10x,'the otheinpc-560
     br indices are the same as the ones used for search,   ecis1780'/9xinpc-561
     c,'with the limitations already described.',24x,'ecis1781'/72x,'eciinpc-562
     ds1782'/'new values',30x,'format (7f10.5)',17x,'ecis1783'/'********inpc-563
     e**',62x,'ecis1784'/7x,'1-10   first new parameter.',38x,'ecis1785'inpc-564
     f/6x,'11-20   second new parameter.',37x,'ecis1786'/6x,'21-30   ...inpc-565
     g.................',38x,'ecis1787'/'  if lo(37)=.true. go again to inpc-566
     h''cards read in subroutine eval''.',9x,'ecis1788'/'  if lo(37)=.fainpc-567
     ilse. go to the beginning of next data set.',15x,'ecis1789'/'  noteinpc-568
     j:  there are different uses of this possibility:',18x,'ecis1790') inpc-569
      write (2,1082)                                                    inpc-570
 1082 format ('  *****  1) as a search stops usually before the minimum,inpc-571
     1 it can be',5x,'ecis1791'/8x,'refined by using nex positive and ininpc-572
     2troducing an increment ''0.'' ecis1792'/8x,'for any parameter, in inpc-573
     3search or not in search.',18x,'ecis1793'/''/9x,'2) when searchinginpc-574
     4 the minimum of the chi2 as a function of someecis1794'/8x,'fixed inpc-575
     5parameter. the next search starts with the values of the  ecis1795inpc-576
     6'/8x,'parameters in search obtained in the last search.',15x,'ecisinpc-577
     71796'/9x,'3) when some result must be obtained for different valueinpc-578
     8s of   ecis1797'/8x,'the parameters.',49x,'ecis1798'/72x,'ecis1799inpc-579
     9'/72x,'ecis1800'/'restart input: cards read in subroutine rest',28inpc-580
     ax,'ecis1801'/'********************************************',28x,'einpc-581
     bcis1802'/72x,'ecis1803'/'restart conditions',22x,'format (l1,i4,i5inpc-582
     c,2f10.5)',8x,'ecis1804'/'******************',54x,'ecis1805'/10x,'1inpc-583
     d   lo(35)  the only control which can be changed, all the',4x,'eciinpc-584
     es1806'/14x,'others being those of last run.',27x,'ecis1807'/7x,'2-inpc-585
     f 5   new maximum number of evaluations.',24x,'ecis1808'/7x,'6-10  inpc-586
     g new value of nsec. (default value: the old one).',10x,'ecis1809'/inpc-587
     h6x,'11-20   new value of ech.',41x,'ecis1810'/6x,'11-20   new valuinpc-588
     ie of rap.',41x,'ecis1811'/14x,'if they are less than 1., ech or rainpc-589
     jp are not changed.',5x,'ecis1812'/72x,'ecis1813'/72x,'ecis1814')  inpc-590
      write (2,1083)                                                    inpc-591
 1083 format ('*********************************************************inpc-592
     1***************ecis1815'/72x,'ecis1816'/30x,'*******************',inpc-593
     223x,'ecis1817'/30x,'*  next data set  *',23x,'ecis1818'/30x,'*****inpc-594
     3**************',23x,'ecis1819'/72x,'ecis1820'/6x,'''fin'' in columinpc-595
     4ns 1-3 to stop the job without diagnostic.',10x,'ecis1821'/72x,'ecinpc-596
     5is1822'/7x,'for any trouble, write (and even send listings) to',15inpc-597
     6x,'ecis1823'/5x,'jacques raynal/service de physique theorique/c.e.inpc-598
     7-saclay',11x,'ecis1824'/15x,'91191 gif-sur-yvette cedex/france',24inpc-599
     8x,'ecis1825'/72x,'ecis1826'/5x,'fax: (33)(1) 69.08-81-20',43x,'eciinpc-600
     9s1827'/5x,'e-mail: raynal@spht.saclay.cea.fr',34x,'ecis1828'/72x,'inpc-601
     aecis1829')                                                        inpc-602
      return                                                            inpc-603
      end                                                               inpc-604
c 29/02/04                                                      ecis03  lecl-000
      subroutine lecl(ncolx,ncoll,npp,ncont,ipi,iph,wv,ipp,npa,pa,nva,n lecl-001
     1a,nb,nimax,nbet,cm,idt,lo)                                        lecl-002
c input of level descriptions.                                          lecl-003
c input variables:   ncolx:  total number of nuclear states             lecl-004
c                    ncoll:  number of coupled nuclear states           lecl-005
c                    npp:    number of optical potentials               lecl-006
c                    ncont:  number of continuum for compound nucleus   lecl-007
c                    cm:     nuclear mass in mev                        lecl-008
c                    idt:    free space in npa,pa                       lecl-009
c                    lo:     logical controls. for 1, 2, 3, 7, 8, 15,   lecl-010
c                            18 and 100 see description of input.       lecl-011
c             101, 102, 103 and 115 are opposite of 1, 2, 3 and 15      lecl-012
c             lo(209)=.true.  for dirac potentials                      lecl-013
c output variables:  ipi(j,*) for j = 1, 2, 3, 4, 5 and 11:  see calx   lecl-014
c                    iph(2,j):  for vibrational model, number of phononslecl-015
c                        for i=1, j=1,ncoll. if iph(1,j) is 3, the statelecl-016
c                        is a mixture of 1 and 2-phonons states.        lecl-017
c                               for rotational model, iph(1,j) is 1 for lecl-018
c                        a vibrational band and 2 for a mixture with    lecl-019
c                        the ground state band.                         lecl-020
c                               address of the description of mixed     lecl-021
c                        mixed states in iph(2,j).                      lecl-022
c                    wv(j,*) for j = 1, 2, 3 and 12:  see calx          lecl-023
c                    npa,pa: storage of nuclear parameters equivalent   lecl-024
c                            by call                                    lecl-025
c                    ipp(1,j): first level using potential j (temporary)lecl-026
c                    nva:    number of nuclear parameters               lecl-027
c                    na:     number of integer parameter informations   lecl-028
c                    nb:     storage in roam for asymmetric rotation    lecl-029
c                    nimax:  twice maximum sum of spins target+particle lecl-030
c                    nbet:   number of different phonons                lecl-031
c                    lo:     logical controls: defined for identical    lecl-032
c                            particle and target, lo(223)=.true. for no lecl-033
c                            spin in the ground state and lo(231)=.true.lecl-034
c                            for non zero spins in the ground state     lecl-035
c in common /pote2/  npx:    number of pot. with disp. (temporary)      lecl-036
c***********************************************************************lecl-037
      implicit real*8 (a-h,o-z)                                         lecl-038
      logical lo(250)                                                   lecl-039
      character*1 sigm,spi                                              lecl-040
      dimension ipi(11,ncolx),ipp(30,npp),iph(2,ncoll),wv(18,ncolx),npa(lecl-041
     12,1),pa(1)                                                        lecl-042
      common /pote2/ ity(8),invt,intv,insl,npx                          lecl-043
      common /inout/ mr,mw,ms                                           lecl-044
      data sigm /'-'/                                                   lecl-045
c output of nuclear model                                               lecl-046
      if (lo(7)) go to 3                                                lecl-047
      if (lo(1)) go to 2                                                lecl-048
      if (lo(3)) go to 1                                                lecl-049
      if (lo(102)) write (mw,1000)                                      lecl-050
      if (lo(2)) write (mw,1001)                                        lecl-051
      go to 4                                                           lecl-052
    1 write (mw,1002)                                                   lecl-053
      if (lo(115)) go to 28                                             lecl-054
      go to 4                                                           lecl-055
    2 if (lo(103)) write (mw,1003)                                      lecl-056
      if (lo(3)) write (mw,1004)                                        lecl-057
      go to 4                                                           lecl-058
    3 write (mw,1005)                                                   lecl-059
c input of channel description                                          lecl-060
    4 nva=0                                                             lecl-061
      na=0                                                              lecl-062
      nb=0                                                              lecl-063
      nbet=0                                                            lecl-064
      nimax=0                                                           lecl-065
      do 5 iv=1,npp                                                     lecl-066
    5 ipp(1,iv)=-1                                                      lecl-067
      do 26 iv=1,ncolx                                                  lecl-068
      read (mr,1006) sp2,n,k,spi,e,sp1,wv(1,iv),wv(2,iv),sp3            lecl-069
      ipi(2,iv)=1+idint(2.00001d0*sp1)                                  lecl-070
      ipi(3,iv)=1+idint(2.00001d0*sp2)                                  lecl-071
      ipi(4,iv)=idint(sp3)                                              lecl-072
      if (iv.ne.1) go to 8                                              lecl-073
      wv(12,1)=e                                                        lecl-074
      if (k.eq.0) k=1                                                   lecl-075
      if (lo(18).and.((ipi(3,1).ne.ipi(2,1)).or.(spi.eq.sigm).or.lo(100)lecl-076
     1)) go to 29                                                       lecl-077
      lo(223)=lo(18).and.ipi(2,1)*ipi(3,1).eq.1                         lecl-078
      lo(231)=lo(18).and.ipi(2,1)*ipi(3,1).ne.1                         lecl-079
      amred=wv(1,1)*wv(2,1)/(wv(1,1)+wv(2,1))                           lecl-080
      if (lo(8)) go to 6                                                lecl-081
      wv(3,1)=e*wv(2,1)/(wv(1,1)+wv(2,1))                               lecl-082
      go to 7                                                           lecl-083
c relativistic c.-m. energy ecm=sqrt((m1+m2)**2+2*m2*elab))-m1-m2       lecl-084
    6 wv(3,1)=cm*(dsqrt((wv(1,1)+wv(2,1))**2+2.d0*wv(2,1)*e/cm)-wv(1,1)-lecl-085
     1wv(2,1))                                                          lecl-086
    7 am3=wv(2,1)**.33333333333333d0                                    lecl-087
      bm3=wv(1,1)**.33333333333333d0                                    lecl-088
      write (mw,1007) wv(2,1),sp3,am3,wv(1,1),amred,sp1,bm3             lecl-089
      write (mw,1008) e,wv(3,1)                                         lecl-090
      e=0.d0                                                            lecl-091
      go to 12                                                          lecl-092
    8 if (wv(1,iv).eq.0.d0) go to 9                                     lecl-093
      amred=wv(1,iv)*wv(2,iv)/(wv(1,iv)+wv(2,iv))                       lecl-094
      am3=wv(2,iv)**.33333333333333d0                                   lecl-095
      bm3=wv(1,iv)**.33333333333333d0                                   lecl-096
      write (mw,1007) wv(2,iv),sp3,am3,wv(1,iv),amred,sp1,bm3           lecl-097
      go to 10                                                          lecl-098
    9 wv(1,iv)=wv(1,iv-1)                                               lecl-099
      wv(2,iv)=wv(2,iv-1)                                               lecl-100
      ipi(2,iv)=ipi(2,iv-1)                                             lecl-101
      ipi(4,iv)=ipi(4,iv-1)                                             lecl-102
      sp2=0.5d0*dfloat(ipi(3,iv)-1)                                     lecl-103
      sp3=ipi(4,iv)                                                     lecl-104
   10 wv(3,iv)=wv(3,1)-e                                                lecl-105
      if((ncont+iv.le.ncolx).and.lo(8)) wv(2,iv)=wv(1,1)+wv(2,1)-wv(1,ivlecl-106
     1)+e/cm                                                            lecl-107
      if (k.eq.0) k=ipi(5,iv-1)                                         lecl-108
      if (lo(8)) go to 11                                               lecl-109
      wv(12,iv)=wv(3,iv)*(wv(1,iv)+wv(2,iv))/wv(2,iv)                   lecl-110
      go to 12                                                          lecl-111
   11 wv(12,iv)=wv(3,iv)*(wv(3,iv)/(2.d0*cm)+wv(1,iv)+wv(2,iv))/wv(2,iv)lecl-112
   12 if (lo(209).and.ipi(2,iv).ne.2) go to 30                          lecl-113
      if (k.gt.npp.or.k.le.0) go to 31                                  lecl-114
      ipi(5,iv)=k                                                       lecl-115
      if (ipp(1,k).eq.-1) ipp(1,k)=iv                                   lecl-116
      nimax=max0(nimax,ipi(2,iv)+ipi(3,iv))                             lecl-117
      ipi(1,iv)=0                                                       lecl-118
      if (spi.eq.sigm) ipi(1,iv)=1                                      lecl-119
      if (iv.le.ncoll) go to 14                                         lecl-120
c uncoupled states for compound nucleus                                 lecl-121
      if (ncont+iv.gt.ncolx) go to 13                                   lecl-122
      write (mw,1009) iv,sp2,spi,e,k                                    lecl-123
      go to 26                                                          lecl-124
c continuum for compound nucleus                                        lecl-125
   13 write (mw,1010) iv,sp2,spi,e,k                                    lecl-126
      go to 26                                                          lecl-127
   14 if (lo(7)) go to 16                                               lecl-128
      nnpa=0                                                            lecl-129
      nnva=0                                                            lecl-130
      if (lo(1).and.n.eq.0.or.(lo(101).and.(n.ne.0.or.lo(3)))) go to 15 lecl-131
c input of phonons in harmonic vibrational or symmetric rotational modellecl-132
      read (mr,1011) iph(1,iv),iph(2,iv),i2,i3                          lecl-133
      nbet=max0(nbet,iph(2,iv),i2,i3)                                   lecl-134
      m=iph(1,iv)+1                                                     lecl-135
      go to ( 16 , 18 , 19 , 19 ) , m                                   lecl-136
c ground state                                                          lecl-137
   15 iph(1,iv)=0                                                       lecl-138
      if (lo(1)) go to 17                                               lecl-139
   16 write (mw,1012) iv,sp2,spi,e,k                                    lecl-140
      go to 26                                                          lecl-141
   17 write (mw,1013) iv,sp2,spi,e,k                                    lecl-142
      if (lo(103)) go to 26                                             lecl-143
      nnva=(ipi(3,iv)-1)/4                                              lecl-144
      go to 20                                                          lecl-145
c 1 phonon state                                                        lecl-146
   18 if (lo(101)) write (mw,1014) iv,sp2,spi,e,k,iph(2,iv)             lecl-147
      if (lo(1)) write (mw,1015) iv,sp2,spi,e,k,iph(2,iv)               lecl-148
      go to 26                                                          lecl-149
   19 nnpa=iph(1,iv)-1                                                  lecl-150
      nnva=m-2                                                          lecl-151
      if (lo(103)) nnva=nnva+1                                          lecl-152
   20 if (na+nva+nnpa+2.gt.idt) call memo('lecl',na+nva+nnpa+2,idt,2)   lecl-153
      if ((nva.eq.0).or.(nnpa.eq.0)) go to 22                           lecl-154
      do 21 i=nva,1,-1                                                  lecl-155
   21 pa(nnpa+na+i)=pa(na+i)                                            lecl-156
   22 if (lo(3)) go to 25                                               lecl-157
      write (mw,1012) iv,sp2,spi,e,k                                    lecl-158
c 2 phonon state                                                        lecl-159
      na=na+1                                                           lecl-160
      npa(1,na)=iph(2,iv)                                               lecl-161
      if (lo(1)) go to 24                                               lecl-162
      iph(2,iv)=na                                                      lecl-163
      npa(2,na)=i2                                                      lecl-164
      if (m.eq.4) go to 23                                              lecl-165
      write (mw,1016) npa(1,na),npa(2,na)                               lecl-166
      go to 26                                                          lecl-167
c mixture of 1 phonon and 2 phonon state - input of mixing parameter    lecl-168
   23 na=na+1                                                           lecl-169
      npa(1,na)=i3                                                      lecl-170
   24 nva=nva+1                                                         lecl-171
      npa(2,na)=nva                                                     lecl-172
      read (mr,1017) pa(na+nva)                                         lecl-173
      b1=0.0174532925199433d0*pa(na+nva)                                lecl-174
      c1=dcos(b1)                                                       lecl-175
      c3=dsin(b1)                                                       lecl-176
      if (lo(101)) write (mw,1018) pa(na+nva),c3,npa(1,na-1),i2,c1,i3   lecl-177
      if (lo(1)) write (mw,1019) pa(na+nva),c3,npa(1,na),c1             lecl-178
      go to 26                                                          lecl-179
c asymmetric rotational model - input of mixing parameters              lecl-180
   25 if (lo(101)) go to 26                                             lecl-181
      iph(1,iv)=nnva                                                    lecl-182
      iph(2,iv)=nva                                                     lecl-183
      nb=nb+nnva+1                                                      lecl-184
      if (nnva.eq.0) go to 26                                           lecl-185
      read (mr,1017) (pa(na+nva+j),j=1,nnva)                            lecl-186
      write (mw,1020) (pa(na+nva+j),j=1,nnva)                           lecl-187
      nva=nva+nnva                                                      lecl-188
   26 continue                                                          lecl-189
      if (lo(1).and.lo(2).and.lo(3)) nva=max0(nva,5)                    lecl-190
      npx=0                                                             lecl-191
      do 27 i=1,ncoll                                                   lecl-192
      ipi(11,i)=ipi(5,i)                                                lecl-193
      if (lo(10)) ipi(11,i)=i                                           lecl-194
   27 npx=max0(npx,ipi(11,i))                                           lecl-195
      return                                                            lecl-196
   28 write (mw,1021)                                                   lecl-197
      go to 33                                                          lecl-198
   29 write (mw,1022)                                                   lecl-199
      go to 33                                                          lecl-200
   30 sp1=0.5d0*dfloat(ipi(2,iv))                                       lecl-201
      write (mw,1023) sp1                                               lecl-202
      go to 32                                                          lecl-203
   31 write (mw,1024) k,npp                                             lecl-204
   32 write (mw,1012) iv,sp2,spi,e,k                                    lecl-205
   33 write (mw,1025)                                                   lecl-206
      stop                                                              lecl-207
 1000 format (/' first order vibrational model'/)                       lecl-208
 1001 format (/' second order vibrational model'/)                      lecl-209
 1002 format (/' anharmonic vibrational model'/)                        lecl-210
 1003 format (/' symmetric rotational model'/)                          lecl-211
 1004 format (/' asymmetric rotational model'/)                         lecl-212
 1005 format (/' external form factor model'/)                          lecl-213
 1006 format (f5.2,2i2,a1,5f10.5)                                       lecl-214
 1007 format (/' target',14x,'mass =',f10.5,11x,'product of charges =',flecl-215
     16.0,11x,'at**1/3 =',d15.6/' incident particle',3x,'mass =',f10.5,3lecl-216
     2x,'reduced mass =',d15.6,3x,'spin =',f4.1,3x,'ap**1/3 =',d15.6)   lecl-217
 1008 format (10x,'energy(lab) =',d15.6,' mev',10x,'energy(c. m.) =',d15lecl-218
     1.6,' mev'/)                                                       lecl-219
 1009 format (' n =',i3,' -   spin =',f4.1,a1,' excitation energy =',f8.lecl-220
     14,' mev',10x,'potential',i5,6x,'***** uncoupled state *****')     lecl-221
 1010 format (' n =',i3,' -   spin =',f4.1,a1,' excitation energy =',f8.lecl-222
     14,' mev',10x,'potential',i5,6x,'***** start of a continuum *****')lecl-223
 1011 format (14i5)                                                     lecl-224
 1012 format (' n =',i3,' -   spin =',f4.1,a1,' excitation energy =',f8.lecl-225
     14,' mev',10x,'potential',i5)                                      lecl-226
 1013 format (' n =',i3,' -   spin =',f4.1,a1,' excitation energy =',f8.lecl-227
     14,' mev',10x,'potential',i5,6x,'ground state band')               lecl-228
 1014 format (' n =',i3,' -   spin =',f4.1,a1,' excitation energy =',f8.lecl-229
     14,' mev',10x,'potential',i5,6x,' phonon state with phonon',i3)    lecl-230
 1015 format (' n =',i3,' -   spin =',f4.1,a1,' excitation energy =',f8.lecl-231
     14,' mev',10x,'potential',i5,6x,'vibrational band of phonon',i3)   lecl-232
 1016 format (23x,'2 phonons state, with phonons',i3,' and',i3)         lecl-233
 1017 format (7f10.5)                                                   lecl-234
 1018 format (23x,'mixing of 1 and 2 phonon states with',f9.3,' degrees'lecl-235
     1/23x,f10.5,' 2 phonons state, with phonons',i3,' and',i3,'  + ',f1lecl-236
     20.5,' 1 phonon state with phonon',i3)                             lecl-237
 1019 format (23x,'mixing of vibrational and ground bands with',f9.3,' dlecl-238
     1egrees'/23x,f10.5,' vibrational band of phonon',i3,' and',f10.5,' lecl-239
     2ground state band')                                               lecl-240
 1020 format (23x,'band mixing coeff.',5f10.5)                          lecl-241
 1021 format (' the nuclear reduced matrix elements must be read in thislecl-242
     1 model')                                                          lecl-243
 1022 format (' projectile-target antisymmetrisation valid only for spinlecl-244
     1 of particle equal to spin of target and positive parity'/49x,'andlecl-245
     2 schroedinger formalism')                                         lecl-246
 1023 format (' particle spin',f5.1,' not allowed for dirac equation')  lecl-247
 1024 format (' potential',i3,' will not be read.total number is:',i3)  lecl-248
 1025 format (/' in lecl  ... stop ...')                                lecl-249
      end                                                               lecl-250
c 29/02/04                                                      ecis03  lect-000
      subroutine lect(nbet,ipi,ipp,pip,wv,nbta,beta,val,fiss,gam,npp,rm,lect-001
     1aconv,idt,h,nspin,ism,iqm,iqmax,scn,ck,cm,lo)                     lect-002
c lect reads all input except the 5 first data cards,the levels, the    lect-003
c experimental data,the search conditions,the nuclear reduced matrix    lect-004
c elements and the form factors.                                        lect-005
c input variables:  nbet:     number of phonons                         lect-006
c                   ipi(j,*): multiplicity of particle for j=2          lect-007
c                             product of charges for j=4                lect-008
c                   ipp(1,*): first level using a potential             lect-009
c                   wv(j,*):  for j = 1, 2, 3, 12: see calx             lect-010
c                   npp:      number of optical potentials              lect-011
c                   rm:       matching radius (value read)              lect-012
c                   aconv:    convergence parameter for potentials.     lect-013
c                   idt:      length free for beta                      lect-014
c                   h:        integration step (value read)             lect-015
c                   ck:       2*cm/(h bar)**2                           lect-016
c                   cm:       nuclear mass in mev                       lect-017
c                   lo:       logical controls. for 1, 3, 4, 5, 6, 7, 8,lect-018
c                             10, 11, 12, 13, 14, 16, 17, 19, 44, 46,   lect-019
c                             66, 81, 82, 85, 86 and 99, see descriptionlect-020
c                             of input. 101-200, are opposite to 1-100. lect-021
c                   lo(209)=.true. dirac potentials                     lect-022
c input variable by common                                              lect-023
c /ncomp/           nfiss:    number of fission transm. coefficients    lect-024
c                   nrd:      number of gamma transmission coefficients lect-025
c                   ncont:    number of continuum for compound nucleus  lect-026
c                   ncons:    number of level densities needed          lect-027
c                   ncolx:    total number of discrete levels           lect-028
c output variables: nbet:     number of phonons plus deformations       lect-029
c                   ipp,pip:  equivalent by call: dispersion parameters lect-030
c                   nbta(j,i) quantum numbers of deform. for j=17,18    lect-031
c                   beta(j,i) nuclear deformation for potential j=1,8   lect-032
c                   val(i,n)  (25 optical +9 folding parameters)* npp   lect-033
c                   fiss:     fission data for compound nucleus         lect-034
c                   gam:      gamma data for compound nucleus           lect-035
c                   rm:       matching radius (default option)          lect-036
c                   h:        integration step (default option)         lect-037
c                   nspin:    twice the k-value of the rotational band  lect-038
c                   ism:      number of integration steps               lect-039
c                   iqm:      maximum l-value of def. in rotat. model   lect-040
c                   iqmax:    maximum l-expansion in rotational model   lect-041
c                   scn:      descriptions of level densities           lect-042
c                   lo(201)=.true. no real spin-orbit potential         lect-043
c                   lo(202)=.true. no imaginary spin-orbit potential    lect-044
c                   lo(203)=.true. no coulomb spin-orbit potential      lect-045
c                   lo(208)=.true. diagonal coulomb correct. are needed lect-046
c                   lo(229)=.true. real spin-orbit or dirac equation    lect-047
c                   lo(230)=.true. imag. spin-orbit or dirac equation   lect-048
c output variable by common   (see input description for most of them)  lect-049
c /angl/            theta1,theta2,dtheta,dthe: indications for output atlect-050
c                             equidistant angles.                       lect-051
c /ncomp/           az(6):    deformed spin-orbit parameters            lect-052
c                             see also comment in subroutine quan       lect-053
c                   bz(5):    hauser-feshbach and moldauer's parameters lect-054
c                   tg0,bn,fnug,egd,ggd:  moldauer's data for giant     lect-055
c                                         resonance                     lect-056
c***********************************************************************lect-057
      implicit real*8 (a-h,o-z)                                         lect-058
      dimension val(34,1),ipp(2,15,1),pip(15,1),beta(9,1),ro(6),gam(1),flect-059
     1iss(2,1),nbta(18,1),scn(7,1),wv(18,1),ipi(11,3)                   lect-060
      character*4 aleg(6),bleg(2),cleg(6)                               lect-061
      logical lo(250),lt(6)                                             lect-062
      common /angl/ theta1,theta2,dtheta,dthe                           lect-063
      common /ncomp/ nsp(3),nfiss,nrd,ncont,ncoj,ncons,nie,ncolx,ndp,ndqlect-064
     1,acn1,acn2,az(6),bz(5),tg0,bn,fnug,egd,ggd,tg1,sgsq               lect-065
      common /inout/ mr,mw,ms                                           lect-066
      data bleg,cleg /'not ','    ',' vol','ume ',' sca','lar ',' vec','lect-067
     1tor '/                                                            lect-068
      if (lo(8)) go to 1                                                lect-069
      x2=dsqrt(ck*wv(3,1)*wv(1,1)*wv(2,1)/(wv(1,1)+wv(2,1)))            lect-070
      go to 2                                                           lect-071
    1 x2=dsqrt(0.125d0*ck*wv(3,1)*(wv(3,1)/cm+2.d0*wv(1,1)+2.d0*wv(2,1))lect-072
     1*(wv(3,1)/cm+2.d0*wv(1,1))*(wv(3,1)/cm+2.d0*wv(2,1)))/(wv(3,1)/cm+lect-073
     2wv(1,1)+wv(2,1))                                                  lect-074
    2 iqm=0                                                             lect-075
      if (nbet.eq.0) go to 6                                            lect-076
c input of phonon deformations in vibrational and rotational models     lect-077
      do 5 i=1,nbet                                                     lect-078
      read (mr,1000) nbta(17,i),nbta(18,i),beta(1,i),k                  lect-079
      do 3 j=2,8                                                        lect-080
    3 beta(j,i)=beta(1,i)                                               lect-081
      if (lo(5)) read (mr,1001) (beta(j,i),j=2,8)                       lect-082
      write (mw,1002) i,nbta(17,i),nbta(18,i),(beta(j,i),j=1,8)         lect-083
      if (lo(116)) go to 5                                              lect-084
      if (k.eq.0) k=1                                                   lect-085
      k=min0(k,ncolx)                                                   lect-086
      am3=wv(2,k)**.33333333333333d0                                    lect-087
      bm3=wv(1,k)**.33333333333333d0                                    lect-088
      cm3=am3/(am3+bm3)                                                 lect-089
      dm3=1.d0                                                          lect-090
      if (lo(6)) dm3=cm3                                                lect-091
      do 4 j=1,6                                                        lect-092
    4 beta(j,i)=beta(j,i)*cm3/dm3                                       lect-093
      beta(7,i)=beta(7,i)*cm3**nbta(17,i)/dm3                           lect-094
      beta(8,i)=beta(8,i)*cm3**nbta(17,i)/dm3                           lect-095
      write (mw,1003) k,(beta(j,i),j=1,8)                               lect-096
    5 continue                                                          lect-097
    6 if (lo(7)) go to 20                                               lect-098
      if (lo(101)) go to 15                                             lect-099
c input of deformations for the rotational model                        lect-100
      read (mr,1000) iqm,iqmax,aspin,k                                  lect-101
      nspin=idint(2.d0*aspin+0.1d0)                                     lect-102
      iq=nbet+1                                                         lect-103
      jq=nbet+iqm/2                                                     lect-104
      if (lo(103)) go to 7                                              lect-105
      jq=nbet+iqm                                                       lect-106
      if ((iqm.gt.35).or.(iqmax.gt.8)) go to 43                         lect-107
    7 if (9*jq.gt.idt) call memo('lect',idt,9*jq,2)                     lect-108
      read (mr,1001) (beta(1,i),i=iq,jq)                                lect-109
      m=0                                                               lect-110
      l=0                                                               lect-111
      do 11 i=iq,jq                                                     lect-112
      if (lo(3)) go to 8                                                lect-113
      l=2*(i-nbet)                                                      lect-114
      go to 9                                                           lect-115
    8 m=m+2                                                             lect-116
      if (m.le.l) go to 9                                               lect-117
      l=l+2                                                             lect-118
      m=0                                                               lect-119
    9 nbta(17,i)=l                                                      lect-120
      nbta(18,i)=m                                                      lect-121
      do 10 j=2,8                                                       lect-122
   10 beta(j,i)=beta(1,i)                                               lect-123
   11 continue                                                          lect-124
      if (lo(5)) read (mr,1001) ((beta(j,i),j=2,8),i=iq,jq)             lect-125
      write (mw,1004) iqmax,aspin                                       lect-126
      write (mw,1005) (i,nbta(17,i),nbta(18,i),(beta(j,i),j=1,8),i=iq,jqlect-127
     1)                                                                 lect-128
      if (lo(116)) go to 14                                             lect-129
      if (k.eq.0) k=1                                                   lect-130
      k=min0(k,ncolx)                                                   lect-131
      am3=wv(2,k)**.33333333333333d0                                    lect-132
      bm3=wv(1,k)**.33333333333333d0                                    lect-133
      cm3=am3/(am3+bm3)                                                 lect-134
      dm3=1.d0                                                          lect-135
      if (lo(6)) dm3=cm3                                                lect-136
      do 13 i=iq,jq                                                     lect-137
      if (nbta(18,i).ne.0) go to 13                                     lect-138
      do 12 k=1,6                                                       lect-139
   12 beta(k,i)=beta(k,i)*cm3/dm3                                       lect-140
      beta(7,i)=beta(7,i)*cm3**nbta(17,i)/dm3                           lect-141
      beta(8,i)=beta(8,i)*cm3**nbta(17,i)/dm3                           lect-142
   13 continue                                                          lect-143
      write (mw,1006) k                                                 lect-144
      write (mw,1005) (i,nbta(17,i),nbta(18,i),(beta(j,i),j=1,8),i=iq,jqlect-145
     1)                                                                 lect-146
   14 nbet=jq                                                           lect-147
      go to 20                                                          lect-148
c anharmonic vibrational model with different deformations              lect-149
   15 if (lo(103)) go to 20                                             lect-150
      if (36.gt.idt) call memo('lect',idt,36,2)                         lect-151
      write (mw,1007)                                                   lect-152
      do 17 i=1,4                                                       lect-153
      do 16 j=1,8                                                       lect-154
   16 beta(j,i)=1.d0                                                    lect-155
      nbta(17,i)=0                                                      lect-156
      nbta(18,i)=0                                                      lect-157
      if (lo(5)) read (mr,1001) (beta(j,i),j=1,8)                       lect-158
   17 write (mw,1008) i,nbta(17,i),(beta(j,i),j=1,8)                    lect-159
      nbet=4                                                            lect-160
      if (lo(116)) go to 20                                             lect-161
      read (mr,1009) (nbta(17,j),j=1,4),k                               lect-162
      if (k.eq.0) k=1                                                   lect-163
      k=min0(k,ncolx)                                                   lect-164
      am3=wv(2,k)**.33333333333333d0                                    lect-165
      bm3=wv(1,k)**.33333333333333d0                                    lect-166
      cm3=am3/(am3+bm3)                                                 lect-167
      dm3=1.d0                                                          lect-168
      if (lo(6)) dm3=cm3                                                lect-169
      write (mw,1006) k                                                 lect-170
      do 19 i=2,4                                                       lect-171
      if (nbta(17,i).eq.0) nbta(17,i)=2                                 lect-172
      if (nbta(17,i).lt.0) nbta(17,i)=0                                 lect-173
      do 18 j=1,6                                                       lect-174
   18 beta(j,i)=beta(j,i)*(cm3/dm3)**(i-1)                              lect-175
      beta(7,i)=beta(7,i)*(cm3**nbta(17,i)/dm3)**(i-1)                  lect-176
      beta(8,i)=beta(8,i)*(cm3**nbta(17,i)/dm3)**(i-1)                  lect-177
   19 write (mw,1010) i,nbta(17,i),(beta(j,i),j=1,8)                    lect-178
c input of optical model parameters                                     lect-179
   20 w2=10.d20                                                         lect-180
      lo(201)=.true.                                                    lect-181
      lo(202)=.true.                                                    lect-182
      lo(203)=.true.                                                    lect-183
      lo(208)=.false.                                                   lect-184
      lt(4)=.true.                                                      lect-185
      lt(6)=.true.                                                      lect-186
      w1=0.d0                                                           lect-187
      w3=x2/(aconv*wv(3,1))                                             lect-188
      do 30 ip=1,npp                                                    lect-189
      ij=ipp(1,1,ip)                                                    lect-190
      if (ij.ne.-1) go to 21                                            lect-191
      ipp(1,1,ip)=1                                                     lect-192
      write (mw,1011) ip                                                lect-193
      ij=1                                                              lect-194
   21 if (lo(7)) go to 23                                               lect-195
      am3=wv(2,ij)**.33333333333333d0                                   lect-196
      if (lo(16)) am3=am3+wv(1,ij)**.33333333333333d0                   lect-197
      write (mw,1012) ip,am3                                            lect-198
      do 22 i=1,6                                                       lect-199
      aleg(i)=bleg(2)                                                   lect-200
      read (mr,1013) val(3*i-2,ip),ro(i),val(3*i,ip)                    lect-201
      val(3*i-1,ip)=am3*ro(i)                                           lect-202
      if (val(3*i-2,ip).eq.0.d0) go to 22                               lect-203
      w1=dmax1(w1,val(3*i-1,ip)+dlog(w3*dabs(val(3*i-2,ip)))*val(3*i,ip)lect-204
     1)                                                                 lect-205
      w2=dmin1(w2,val(3*i,ip))                                          lect-206
   22 continue                                                          lect-207
      lt(1)=ipi(2,ij).eq.1.or.val(13,ip).eq.0.d0                        lect-208
      lt(2)=ipi(2,ij).eq.1.or.val(16,ip).eq.0.d0                        lect-209
      lo(201)=lo(201).and.lt(1)                                         lect-210
      lo(202)=lo(202).and.lt(2)                                         lect-211
c output of optical parameters                                          lect-212
      if (lo(112)) aleg(2)=bleg(1)                                      lect-213
      if (lt(1).or.lo(113)) aleg(5)=bleg(1)                             lect-214
      if (lt(2).or.lo(114)) aleg(6)=bleg(1)                             lect-215
      aleg(4)=aleg(2)                                                   lect-216
      write (mw,1014) (aleg(i),val(3*i-2,ip),val(3*i-1,ip),ro(i),val(3*ilect-217
     1,ip),i=1,6)                                                       lect-218
      read (mr,1013) ro(1),val(21,ip),val(25,ip)                        lect-219
      read (mr,1013) val(22,ip),ro(2),val(24,ip)                        lect-220
      if (lo(99)) val(21,ip)=0.d0                                       lect-221
      if (lo(99)) val(24,ip)=0.d0                                       lect-222
      val(19,ip)=ipi(4,ij)                                              lect-223
      val(20,ip)=am3*ro(1)                                              lect-224
      lt(3)=val(19,ip).eq.0.d0                                          lect-225
      lt(4)=lt(3).and.lt(4)                                             lect-226
      aleg(1)=bleg(2)                                                   lect-227
      if (lt(3).or.lo(111)) aleg(1)=bleg(1)                             lect-228
      val(23,ip)=am3*ro(2)                                              lect-229
      lt(5)=val(22,ip).eq.0.or.ipi(2,ij).eq.1                           lect-230
      lo(203)=lo(203).and.lt(5)                                         lect-231
      lt(6)=lt(5).and.lt(6)                                             lect-232
      aleg(2)=bleg(2)                                                   lect-233
      if (lt(5).or.lo(119)) aleg(2)=bleg(1)                             lect-234
      write (mw,1015) (aleg(i),val(3*i+16,ip),val(3*i+17,ip),ro(i),val(3lect-235
     1*i+18,ip),i=1,2),val(25,ip)                                       lect-236
      lo(208)=lo(208).or.val(22,ip).ne.0.d0.or.(lo(209).and.val(19,ip).nlect-237
     1e.0.d0)                                                           lect-238
      w1=dmax1(w1,val(20,ip)+10.d0*val(21,ip),val(23,ip)+10.d0*val(24,iplect-239
     1))                                                                lect-240
      if (val(21,ip).ne.0.d0) w2=dmin1(w2,val(21,ip))                   lect-241
      if (val(24,ip).ne.0.d0) w2=dmin1(w2,val(24,ip))                   lect-242
      if (lo(117)) go to 23                                             lect-243
c input of folding parameters                                           lect-244
      read (mr,1013) (val(i,ip),i=26,34)                                lect-245
      write (mw,1016) (val(i,ip),i=26,34)                               lect-246
   23 if (lo(110)) go to 30                                             lect-247
c input of dispersion parameters                                        lect-248
      read (mr,1017) ippip,ipp(2,1,ip),(pip(j,ip),j=3,8)                lect-249
      read (mr,1017) ipp(1,2,ip),ipp(2,2,ip),(pip(j,ip),j=9,14)         lect-250
      read (mr,1013) pip(15,ip)                                         lect-251
      if (mod(ipp(2,1,ip),2).ne.0.or.mod(ipp(1,2,ip),2).ne.0.or.mod(ipp(lect-252
     12,2,ip),2).ne.0) go to 44                                         lect-253
      if ((ipp(1,2,ip).ne.0.and.val(4,ip).eq.0.d0).or.(ipp(2,2,ip).ne.0.lect-254
     1and.val(10,ip).eq.0.d0)) go to 45                                 lect-255
      if (pip(7,ip).ne.0.d0.and.val(13,ip).eq.0.d0) go to 46            lect-256
      if (pip(8,ip).ne.0.d0.and.val(16,ip).eq.0.d0) go to 47            lect-257
      if (pip(15,ip).ne.0.d0.and.val(1,ip).eq.0.d0) go to 48            lect-258
      if (ippip.eq.1) go to 24                                          lect-259
      ippip=0                                                           lect-260
      write (mw,1018)                                                   lect-261
      go to 25                                                          lect-262
   24 ipp(1,1,ip)=-ipp(1,1,ip)                                          lect-263
      write (mw,1019)                                                   lect-264
   25 if (pip(3,ip).eq.0.d0) pip(3,ip)=wv(9*ippip+3,ij)                 lect-265
      if (pip(4,ip).eq.0.d0) pip(4,ip)=-6.8d0                           lect-266
      if (pip(5,ip).eq.0.d0) pip(5,ip)=pip(4,ip)                        lect-267
      write (mw,1020) (pip(i,ip),i=3,5)                                 lect-268
      if (pip(7,ip).ne.0.d0) write (mw,1021) val(13,ip),pip(7,ip),pip(3,lect-269
     1ip)                                                               lect-270
      if (pip(8,ip).ne.0.d0) write (mw,1022) val(16,ip),pip(8,ip),pip(3,lect-271
     1ip)                                                               lect-272
      if (pip(15,ip).ne.0.d0) write (mw,1023) val(1,ip),pip(15,ip),pip(3lect-273
     1,ip)                                                              lect-274
      i1=1                                                              lect-275
      if (lo(209)) i1=3                                                 lect-276
      if (ipp(1,2,ip).lt.0) go to 26                                    lect-277
      write (mw,1024) cleg(i1),cleg(i1+1),ipp(1,2,ip),pip(9,ip)         lect-278
      if (ipp(2,1,ip).ne.0.or.pip(10,ip).ne.0.d0) write (mw,1025) pip(4,lect-279
     1ip),pip(6,ip),ipp(2,1,ip),pip(10,ip),pip(11,ip)                   lect-280
      go to 27                                                          lect-281
   26 write (mw,1026) cleg(i1),cleg(i1+1),ipp(1,2,ip),pip(9,ip),pip(10,ilect-282
     1p),pip(11,ip)                                                     lect-283
   27 if (lo(209)) go to 29                                             lect-284
      if (ipp(2,2,ip).lt.0) go to 28                                    lect-285
      write (mw,1027) ipp(2,2,ip),pip(12,ip),pip(13,ip),pip(14,ip)      lect-286
      go to 30                                                          lect-287
   28 if (pip(13,ip).eq.0.d0) pip(13,ip)=2.d0*pip(12,ip)                lect-288
      write (mw,1028) ipp(2,2,ip),pip(12,ip),pip(13,ip)                 lect-289
      go to 30                                                          lect-290
   29 if (ipp(2,2,ip).ge.0) write (mw,1024) cleg(5),cleg(6),ipp(2,2,ip),lect-291
     1pip(12,ip)                                                        lect-292
      if (ipp(2,2,ip).lt.0) write (mw,1026) cleg(5),cleg(6),ipp(2,2,ip),lect-293
     1pip(12,ip),pip(13,ip),pip(14,ip)                                  lect-294
   30 continue                                                          lect-295
      if (lo(99)) lo(202)=.false.                                       lect-296
      if (lo(107)) go to 32                                             lect-297
      do 31 ij=1,ncolx                                                  lect-298
      lt(4)=lt(4).and.ipi(4,ij).eq.0                                    lect-299
      lt(6)=lt(6).and.ipi(2,ij).eq.1                                    lect-300
   31 lo(202)=lo(202).and.ipi(2,ij).eq.1                                lect-301
      w1=20.d0                                                          lect-302
      lo(201)=lo(202)                                                   lect-303
      lo(203)=lo(202).or.lt(6)                                          lect-304
      lo(208)=lo(209).or.(.not.lo(203))                                 lect-305
   32 lo(201)=lo(201).and.lo(202)                                       lect-306
      lo(229)=(.not.lo(201)).or.lo(209)                                 lect-307
      lo(230)=(.not.lo(202)).or.lo(209)                                 lect-308
      lo(13)=.not.(lo(113).or.lo(201))                                  lect-309
      lo(14)=.not.(lo(114).or.lo(202))                                  lect-310
      lo(11)=.not.(lo(111).or.lt(4))                                    lect-311
      lo(19)=.not.(lo(119).or.lt(6))                                    lect-312
      if (lo(19)) lo(11)=.true.                                         lect-313
      lo(208)=lo(208).or.lo(44)                                         lect-314
      if (lo(144).and.lo(46)) lo(208)=.false.                           lect-315
c default value of matching radius: max(r*a**1/3+10*a)                  lect-316
c default value for integration step: min(min(a)/2,1/(2*k))             lect-317
      if (rm.le.0.d0) rm=w1                                             lect-318
      if (h.le.0.d0) h=dmin1(w2/2.d0,0.5d0/x2)                          lect-319
      ism=idint(rm/h+0.5d0)                                             lect-320
      h=dfloat(ism)                                                     lect-321
      h=rm/h                                                            lect-322
      rm=h*ism                                                          lect-323
      write (mw,1029) h,rm                                              lect-324
      if (lo(66)) go to 33                                              lect-325
c input of limits for calculation at equidistant angles                 lect-326
      read (mr,1001) theta1,dtheta,theta2,dthe                          lect-327
      if (dtheta.eq.0.d0) dtheta=1.d0                                   lect-328
      if ((theta2-theta1)*dtheta.lt.0.d0) dtheta=-dtheta                lect-329
      write (mw,1030) theta1,dtheta,theta2,dthe                         lect-330
c input of deformed spin-orbit parameters                               lect-331
   33 az(1)=0.d0                                                        lect-332
      az(2)=1.d0                                                        lect-333
      az(3)=1.d0                                                        lect-334
      az(4)=0.d0                                                        lect-335
      az(5)=1.d0                                                        lect-336
      az(6)=1.d0                                                        lect-337
      if (lo(104)) go to 34                                             lect-338
      read (mr,1001) az                                                 lect-339
      write (mw,1031) az                                                lect-340
   34 if (lo(181)) go to 41                                             lect-341
      read (mr,1001) bz                                                 lect-342
      if (bz(1).eq.0.d0) bz(1)=1.4142d0                                 lect-343
      if (lo(182)) go to 35                                             lect-344
      if (bz(2).eq.0.d0) bz(2)=3.5d0                                    lect-345
      if (bz(3).eq.0.d0) bz(3)=100.d0                                   lect-346
      write (mw,1032) (bz(i),i=1,3)                                     lect-347
      go to 41                                                          lect-348
   35 if (bz(3).eq.0.d0) bz(3)=1.212d0                                  lect-349
      if (bz(4).eq.0.d0) bz(4)=0.78d0                                   lect-350
      if (bz(5).eq.0.d0) bz(5)=0.228d0                                  lect-351
      write (mw,1033) (bz(i),i=1,5)                                     lect-352
      if (lo(185)) go to 37                                             lect-353
      write (mw,1034) nfiss                                             lect-354
      do 36 i=1,nfiss                                                   lect-355
      read (mr,1001) fiss(1,i),fiss(2,i)                                lect-356
      if (fiss(2,i).lt.0.5d0) fiss(2,i)=0.d0                            lect-357
   36 write (mw,1035) fiss(1,i),fiss(2,i)                               lect-358
   37 if (lo(186)) go to 39                                             lect-359
      write (mw,1036)                                                   lect-360
      if (nrd.gt.0) go to 38                                            lect-361
      read (mr,1001) tg0,bn,fnug,egd,ggd                                lect-362
      read (mr,1001) scn(7,1),(scn(i,1),i=1,6)                          lect-363
      if (bn.eq.0.d0) bn=8.d0                                           lect-364
      if (fnug.lt.1.d0) fnug=20.d0                                      lect-365
      if (tg0.eq.0.d0) lo(86)=.false.                                   lect-366
      write (mw,1037) tg0,bn,fnug,egd,ggd                               lect-367
      write (mw,1038)                                                   lect-368
      j=1                                                               lect-369
      write (mw,1039) j,(scn(i,j),i=1,7)                                lect-370
      na=idint(wv(2,1)+wv(1,1)+.5d0)                                    lect-371
      call lden(na,scn(1,1))                                            lect-372
      go to 39                                                          lect-373
   38 read (mr,1001) (gam(i),i=1,nrd)                                   lect-374
      write (mw,1040) (gam(i),i=1,nrd)                                  lect-375
   39 if (ncont.eq.0) go to 41                                          lect-376
      write (mw,1041)                                                   lect-377
      j1=1+ncons-ncont                                                  lect-378
      do 40 j=j1,ncons                                                  lect-379
      read (mr,1001) scn(7,j),(scn(i,j),i=1,6)                          lect-380
      write (mw,1039) j,(scn(i,j),i=1,7)                                lect-381
      na=idint(wv(2,ncolx+j-ncons)+.5d0)                                lect-382
   40 call lden(na,scn(1,j))                                            lect-383
   41 do 42 i=1,100                                                     lect-384
   42 lo(i+100)=.not.lo(i)                                              lect-385
      return                                                            lect-386
   43 write (mw,1042) iqm,iqmax                                         lect-387
      go to 50                                                          lect-388
   44 write (mw,1043) ip,ipp(1,2,ip),ipp(2,2,ip),ipp(2,1,ip)            lect-389
      go to 50                                                          lect-390
   45 write (mw,1044) ip,(ipp(i,2,ip),val(6*i-2,ip),i=1,2)              lect-391
      go to 49                                                          lect-392
   46 write (mw,1045) ip,ip,pip(7,ip),val(13,ip)                        lect-393
      go to 49                                                          lect-394
   47 write (mw,1046) ip,ip,pip(8,ip),val(16,ip)                        lect-395
      go to 49                                                          lect-396
   48 write (mw,1047) ip,ip,pip(15,ip),val(1,ip)                        lect-397
   49 write (mw,1048)                                                   lect-398
   50 write (mw,1049)                                                   lect-399
      stop                                                              lect-400
 1000 format (2i5,f10.5,i5)                                             lect-401
 1001 format (7f10.5)                                                   lect-402
 1002 format (10x,'phonon',i3,5x,'l =',i3,5x,'k =',i3,5x,'beta =',8f8.5)lect-403
 1003 format (12x,'after heavy ion correction i =',i2,'  beta =',8f8.5) lect-404
 1004 format (/10x,'multipole expansion up to iqmax =',i3,20x,'k =',f7.2lect-405
     1,' band')                                                         lect-406
 1005 format (/' beta(i,j) for  l   k ',8x,'v',9x,'w',8x,'vs',8x,'ws',7xlect-407
     1,'vso',7x,'wso',6x,'coul s.o. coul'/(5x,i5,5x,i2,2x,i2,2x,8f10.5))lect-408
 1006 format (/10x,'after heavy ion correction i =',i3/)                lect-409
 1007 format (/10x,'ratios of anharmonic deformations'/25x,'v',9x,'w',8xlect-410
     1,'vs',8x,'ws',7x,'vso',7x,'wso',6x,'coul s.o. coul')              lect-411
 1008 format (' order',i3,6x,i3,2x,8f10.5)                              lect-412
 1009 format (14i5)                                                     lect-413
 1010 format (' order',i3,'  iq =',i3,2x,8f10.5)                        lect-414
 1011 format (/' ***** no state for the potential',i3,' *** we use the glect-415
     1round state'/)                                                    lect-416
 1012 format (//' optical potentials  **',i3,' **     reduced radius mullect-417
     1tiplied by  ',d15.6/)                                             lect-418
 1013 format (3f10.5)                                                   lect-419
 1014 format (2x,a4,'deformed  volume/scalar real potential'/14x,'depth'lect-420
     1,f12.6,' mev   radius',f10.6,' fermi (reduced value',f9.6,')    dilect-421
     2ffuseness',f9.6,' fermi'//2x,a4,'deformed  volume/scalar imaginarylect-422
     3 potential'/14x,'depth',f12.6,' mev   radius',f10.6,' fermi (reduclect-423
     4ed value',f9.6,')    diffuseness',f9.6,' fermi'//  2x,a4,'deformedlect-424
     5  surface/vector real potential'/14x,'depth',f12.6,' mev   radius'lect-425
     6,f10.6,' fermi (reduced value',f9.6,')    diffuseness',f9.6,' fermlect-426
     7i'//2x,a4,'deformed  surface/vector imaginary potential'/14x,'deptlect-427
     8h',f12.6,' mev   radius',f10.6,' fermi (reduced value',f9.6,')    lect-428
     9diffuseness',f9.6,' fermi'//2x,a4,'deformed  real spin-orbit/tensolect-429
     ar potential'/14x,'depth',f12.6,' mev   radius',f10.6,' fermi (redulect-430
     bced value',f9.6,')    diffuseness',f9.6,' fermi'//2x,a4,'deformed lect-431
     c imaginary spin-orbit/tensor potential'/14x,'depth',f12.6,' mev   lect-432
     dradius',f10.6,' fermi (reduced value',f9.6,')    diffuseness',f9.6lect-433
     e,' fermi')                                                        lect-434
 1015 format (/2x,a4,'deformed  coulomb potential'/' product of charges'lect-435
     1,f9.0,10x,'radius',f10.6,' fermi (reduced value',f9.6,')    diffuslect-436
     2eness',f9.6,' fermi'//2x,a4,'deformed  spin-orbit coulomb potentialect-437
     3l'/14x,'depth',f12.6,' mev   radius',f10.6,' fermi (reduced value'lect-438
     4,f9.6,')    diffuseness',f9.6,' fermi'/14x,'third charge parameterlect-439
     5',f9.6)                                                           lect-440
 1016 format (/' *** folding model ***'/' real part      v =',f10.4,6x,'lect-441
     1r =',f10.4,6x,'a =',f10.4/' imaginary part v =',f10.4,6x,'r =',f10lect-442
     2.4,6x,'a =',f10.4/' coulomb part   v =',f10.4,6x,'r =',f10.4,6x,'alect-443
     3 =',f10.4/)                                                       lect-444
 1017 format (2i5,6f10.5)                                               lect-445
 1018 format (' use of center of mass energies')                        lect-446
 1019 format (' use of laboratory energies')                            lect-447
 1020 format (' imaginary depths read for',f12.6,' mev   fermi energy:',lect-448
     1f12.6,' mev   treshold energy:',f12.6)                            lect-449
 1021 format (' exponential decrease of real spin-orbit potential:',3x,flect-450
     112.6,'*exp(-',f10.6,'(e-',f10.6,')) mev')                         lect-451
 1022 format (' linear decrease of imaginary spin-orbit potential:',3x,flect-452
     112.6,'-',f10.6,'*(e-',f10.6,') mev')                              lect-453
 1023 format (' exponential decrease of hartree-fock potential:',6x,f12.lect-454
     16,'*exp(-',f10.6,'(e-',f10.6,')) mev')                            lect-455
 1024 format (2a4,':   power =',i3,5x,'b =',f10.4)                      lect-456
 1025 format (' for energies ''e'' such that |',f12.6,'-''e''| >',f12.6,lect-457
     1' mev'/' corrections with power',i3,' for negatives energies and clect-458
     2oefficient',f12.6,' for positive energies'/15x,'damping factor',f1lect-459
     32.6)                                                              lect-460
 1026 format (2a4,':   power =',i3,5x,'sum of b1 =',f10.4,5x,'and b2 =',lect-461
     1f10.4,5x,'contribution of b1 =',f10.5)                            lect-462
 1027 format (' surface:   power =',i3,5x,'b =',f10.4,5x,' decreasing ralect-463
     1te =',f10.6,5x,' non locality parameter =',f10.4)                 lect-464
 1028 format (' surface:   power =',i3,5x,'difference of b1 =',f10.4,5x,lect-465
     1'and b2 =',f10.4)                                                 lect-466
 1029 format (/' integration step size =',f8.5,10x,'matching radius =',flect-467
     18.3,' fermi')                                                     lect-468
 1030 format (/' scattering angles from',f7.3,' in steps of',f7.3,' up tlect-469
     1o',f8.3,' degrees   averaged with +/-',f8.3,' degrees'/)          lect-470
 1031 format (10x,'****** az ******',d15.8)                             lect-471
 1032 format (/' square root of elastic enhancement factor',8x,d15.8/' slect-472
     1pin cut-off parameter',27x,d15.8/' square root of level density palect-473
     2rameter',11x,d15.8)                                               lect-474
 1033 format (/' square root of elastic enhancement factor without fluctlect-475
     1uations',7x,d15.8/' particle width fluctuation degree of freedom',lect-476
     225x,d15.8/' parameters of moldauer''s formula',22x,3d15.8)        lect-477
 1034 format (/i5,' fission data')                                      lect-478
 1035 format (10x,2d15.8)                                               lect-479
 1036 format (/' gamma data')                                           lect-480
 1037 format (5x,'tg0:',d13.6,6x,'bn:',d13.6,4x,'fnug:',d13.6,5x,'egd:',lect-481
     1d13.6,5x,'ggd:',d13.6)                                            lect-482
 1038 format (' density of states given by')                            lect-483
 1039 format (' read values'/(1x,i3,'  sa:',d13.6,6x,'ux:',d13.6,5x,'taulect-484
     1:',d13.6,6x,'sg:',d13.6/28x,'e0:',d13.6,6x,'ex:',d13.6,7x,'z:',f5.lect-485
     20))                                                               lect-486
 1040 format (8d15.8)                                                   lect-487
 1041 format (' density of states for continuum given by')              lect-488
 1042 format (' iqm =',i3,' or iqmax =',i3,' are larger than the maximumlect-489
     1 values 35 or 8 of the asymmetric rotational model')              lect-490
 1043 format (' for dispersion relations of potential',i3,' all the folllect-491
     1owing integers must be even'/10x,'nv =',i4,10x,'ns =',i4,10x,'n2 =lect-492
     2',i4)                                                             lect-493
 1044 format (' the potential',i4,' cannot be used for dispersion relatilect-494
     1ons because an imaginary strength is 0:'/10x,'nv =',i3,'  wv =',d1lect-495
     23.6,10x,'ns =',i3,'  ws =',d13.6)                                 lect-496
 1045 format (' the potential',i4,' cannot be used with variation of thelect-497
     1 real spin-orbit of which the strength is 0':/10x,'pip(7,',i2,') =lect-498
     2',d13.6,'  vls =',d13.6)                                          lect-499
 1046 format (' the potential',i4,' cannot be used with variation of thelect-500
     1 imaginary spin-orbit of which the strength is 0':/10x,'pip(8,',i2lect-501
     2,') =',d13.6,'  wls =',d13.6)                                     lect-502
 1047 format (' the potential',i4,' cannot be used with variation of thelect-503
     1 hartree-fock potential of which the strength is 0':/10x,'pip(15,'lect-504
     2,i2,') =',d13.6,'  v =',d13.6)                                    lect-505
 1048 format (' give values for another energy'/)                       lect-506
 1049 format (//' in lect  ... stop ...')                               lect-507
      end                                                               lect-508
c 29/02/04                                                      ecis03  lden-000
      subroutine lden(na,scn)                                           lden-001
c compound nucleus preparatory computations added by moldauer with prsl lden-002
c input variables: na:      total mass of the compound nucleus          lden-003
c                  scn:     descriptions of level densities             lden-004
c output variables:                                                     lden-005
c in scn:  1-sa  2-ux   3-tau  4-sg   5-e0   6-ex   7-nz                lden-006
c data pz, pn, sz and sn are the one used by the code gnash             lden-007
c***********************************************************************lden-008
      implicit real*8 (a-h,o-z)                                         lden-009
      dimension scn(7)                                                  lden-010
      real*4 pz(100),pn(150),sz(100),sn(150)                            lden-011
      common /inout/ mr,mw,ms                                           lden-012
      data pz /0.,5.05,0.,4.50,0.,3.95,0.,3.40,0.,2.90,0.,2.46,0.,2.09,0lden-013
     1.,1.62,0.,1.62,0.,1.83,0.,1.73,0.,1.35,0.,1.54,0.,1.28,0.26,0.88,0lden-014
     2.19,1.35,-.05,1.52,-.09,1.17,.04,1.24,0.29,1.09,.26,1.17,.23,1.15,lden-015
     3-.08,1.35,0.34,1.05,.28,1.27,0.,1.05,0.,1.,.09,1.2,.2,1.4,.93,1.,-lden-016
     4.2,1.19,.09,.97,0.,.92,.11,.68,.05,.68,-.22,.79,.09,.69,.01,.72,0.lden-017
     5,.4,.16,.73,0.,.46,.17,.89,0.,.79,0.,.89,0.,.81,-.06,.69,-.2,.71,-lden-018
     6.12,.72,0.,.77,2*0./                                              lden-019
      data pn /0.,5.25,0.,4.70,0.,4.15,0.,3.58,0.,3.05,0.,2.67,0.,1.8,0.lden-020
     1,1.67,0.,1.86,0.,2.04,0.,1.64,0.,1.44,0.,1.54,0.,1.3,0.,1.27,0.,1.lden-021
     229,.08,1.41,-.08,1.5,-.05,2.24,-.47,1.43,-.15,1.44,.06,1.56,.25,1.lden-022
     357,-.16,1.46,0.,.93,.01,.62,-.5,1.42,.13,1.52,-.65,.8,-.08,1.29,-.lden-023
     447,1.25,-.44,.97,.08,1.65,-.11,1.26,-.46,1.06,0.22,1.55,-.07,1.37,lden-024
     50.1,1.2,-.27,.92,-.35,1.19,0.,1.05,-.25,1.61,-.21,.9,-.21,.74,-.38lden-025
     6,.72,-.34,.92,-.26,.94,.01,.65,-.36,.83,.11,.67,.05,1.,.51,1.04,.3lden-026
     73,.68,-.27,.81,.09,.75,.17,.86,.14,1.1,-.22,.84,-.47,.48,.02,.88,.lden-027
     824,.52,.27,.41,-.05,.38,.15,.67,0.,.61,0.,.78,0.,.67,0.,.67,0.,.79lden-028
     9,0.,.6,.04,.64,-.06,.45,.05,.26,-.22,.39,0.,.39/                  lden-029
      data sz /.19,.38,.57,.75,.94,1.13,1.32,1.51,1.70,2.10,2.91,4.17,5.lden-030
     172,7.8,8.97,9.7,10.1,10.7,11.38,12.07,12.55,13.24,13.93,14.71,15.5lden-031
     23,16.37,17.36,18.6,18.7,18.01,17.87,17.08,16.6,16.75,16.5,16.35,16lden-032
     3.22,16.41,16.89,16.43,16.68,16.73,17.45,17.29,17.44,17.82,18.62,18lden-033
     4.27,19.39,19.91,19.14,18.26,17.4,16.42,15.77,14.37,13.91,13.1,13.1lden-034
     51,11.43,10.89,10.75,10.62,10.41,10.21,9.85,9.47,9.03,8.61,8.13,7.4lden-035
     66,7.48,7.2,7.13,7.06,6.78,6.64,6.64,7.68,7.89,8.41,8.49,7.88,6.3,5lden-036
     7.47,4.78,4.37,4.17,4.13,4.32,4.55,5.04,5.28,6.06,6.28,6.87,7.20,7.lden-037
     874,2*0./                                                          lden-038
      data sn /0.62,1.24,1.85,2.47,3.09,3.71,4.33,4.95,5.56,6.18,6.8,7.5lden-039
     13,7.55,7.21,7.44,8.07,8.94,9.81,10.6,11.39,12.54,13.68,14.34,14.19lden-040
     2,13.83,13.5,13.,12.13,12.6,13.26,14.13,14.92,15.52,16.38,17.16,17.lden-041
     355,18.03,17.59,19.03,18.71,18.8,18.99,18.46,18.25,17.76,17.38,16.7lden-042
     42,15.62,14.38,12.88,13.23,13.81,14.9,14.86,15.76,16.2,17.62,17.73,lden-043
     518.16,18.67,19.69,19.51,20.17,19.48,19.98,19.83,20.2,19.72,19.87,1lden-044
     69.24,18.44,17.61,17.1,16.16,15.9,15.33,14.76,13.54,12.63,10.65,10.lden-045
     71,8.89,10.25,9.79,11.39,11.72,12.43,12.96,13.43,13.37,12.96,12.11,lden-046
     811.92,11.,10.8,10.42,10.39,9.69,9.27,8.93,8.57,8.02,7.59,7.33,7.23lden-047
     9,7.05,7.42,6.75,6.6,6.38,6.36,6.49,6.25,5.85,5.48,4.53,4.3,3.39,2.lden-048
     a35,1.66,.81,0.46,-.96,-1.69,-2.53,-3.16,-1.87,-.41,.71,1.66,2.62,3lden-049
     b.22,3.76,4.1,4.46,4.83,5.09,5.18,5.17,5.1,5.01,4.97,5.09,5.03,4.93lden-050
     c,5.28,5.49,5.50,5.37,5.30/                                        lden-051
      nz=idint(scn(7)+.1d0)                                             lden-052
      if (nz.le.0) nz=na/2                                              lden-053
      nn=na-nz                                                          lden-054
      aa=na                                                             lden-055
      sc=0.d0                                                           lden-056
      pr=0.d0                                                           lden-057
c sa given by p. j. brancazio and a. g. w. cameron, canadian journal of lden-058
c physics 47 (1969) 1029.                                               lden-059
      if (nz.gt.100.or.nn.gt.150) go to 1                               lden-060
      sc=dble(sn(nn)-sz(nz))                                            lden-061
      pr=dble(pn(nn)+pz(nz))                                            lden-062
      nd=min0(iabs(nz-2),iabs(nz-8),iabs(nz-20),iabs(nz-28),iabs(nz-50),lden-063
     1iabs(nz-82),iabs(nz-126),iabs(nn-2),iabs(nn-8),iabs(nn-20),iabs(nnlden-064
     2-28),iabs(nn-50),iabs(nn-82),iabs(nn-126),iabs(nn-184))           lden-065
    1 sa=dabs((.0091d0*(sc-.23d0*dfloat(nd))+.143d0)*aa)                lden-066
      if (scn(1).eq.0.d0) scn(1)=sa                                     lden-067
      ux=2.5d0+150.d0/aa                                                lden-068
      if (scn(2).eq.0.d0) scn(2)=ux                                     lden-069
      tau=1.d0/(dsqrt(scn(1)/scn(2))-1.5d0/scn(2))                      lden-070
      if (tau.gt.0.d0) go to 2                                          lden-071
      scn(3)=1.d0/(dsqrt(sa/ux)-1.5d0/ux)                               lden-072
      write (mw,1000) tau,scn(3)                                        lden-073
    2 if (scn(3).eq.0.d0) scn(3)=tau                                    lden-074
      sg=dsqrt(0.0888d0*dsqrt(scn(1)*scn(2))*aa**0.666666667d0)         lden-075
      if (scn(4).eq.0.d0) scn(4)=sg                                     lden-076
      ex=dabs(scn(2)+pr)                                                lden-077
      e0=ex-scn(3)*(2.d0*dsqrt(scn(1)*scn(2))+dlog(scn(3)/(16.9705627d0*lden-078
     1scn(1)**.25d0*scn(2)**1.25d0*scn(4))))                            lden-079
      if (scn(5).eq.0.d0) scn(5)=e0                                     lden-080
      if (scn(6).eq.0.d0) scn(6)=ex                                     lden-081
      write (mw,1001) (scn(j),j=1,7)                                    lden-082
      return                                                            lden-083
 1000 format (5x,'temperature',f10.5,' replaced by',f10.5)              lden-084
 1001 format (' used values'/(4x,'  sa:',d13.6,6x,'ux:',d13.6,5x,'tau:',lden-085
     1d13.6,6x,'sg:',d13.6/28x,'e0:',d13.6,6x,'ex:',d13.6,7x,'z:',f5.0))lden-086
      end                                                               lden-087
c 29/02/04                                                      ecis03  deph-000
      subroutine deph(ncoll,ncols,wv,ipi,mf,ms1,ms2,nct,kcc,kba,kab,kbc,deph-001
     1ktgr,ngr,npr,jtx,niv,njc,njx,njy,nmax,lo)                         deph-002
c helicity quantum numbers and choice of observables for the output     deph-003
c input variables: ncoll:  number of coupled nuclear levels             deph-004
c                  ncols:  number of levels with angular distribution   deph-005
c                  wv,ipi:     see calx                                 deph-006
c                  ngr:    indication for plots of cross-section: numberdeph-007
c                          of powers of 10 by 100 points                deph-008
c                  npr:    indications for plots of polarisations:      deph-009
c                          1 first one,2 second,3 first and second ..etcdeph-010
c          on a binary basis. the first value of ngr and npr is for the deph-011
c          ground state and the second one for the excited states       deph-012
c                  nmax:   maximum number of amplitudes                 deph-013
c                  lo:     logical controls                             deph-014
c output variables:mf:     table of quantum numbers and observables     deph-015
c                  ipi(j=5 to 8,i): beginning and end for each level in deph-016
c                       the two parts of the table mf                   deph-017
c                  ms1,ms2:   largest particle and target multiplicitiesdeph-018
c                  nct:   number of equations for each parity in 1 and 2deph-019
c                         number of solutions for each parity in 3 and 4deph-020
c                         number of comp. nucl. coeff. in 5 and 6       deph-021
c                  kcc:   number of independent compound nucleus coeff. deph-022
c                  kba:   number of independent coupled amplitudes      deph-023
c                  kab:   maximum number of coupled equations           deph-024
c                  kbc:   maximum number of solutions needed            deph-025
c                  ktgr:  length of the table mf                        deph-026
c                  jtx:   maximum number of kinds of polarisation       deph-027
c                  niv(*,*,3): address of coulomb integrals             deph-028
c                  njc:    1+maximum number of observ. at equid. angles deph-029
c                  njx:    number of sets of coulomb funct. and integraldeph-030
c                  njy:    maximum label of non standard observable     deph-031
c                                                                       deph-032
c   **** table mf **** first part                                       deph-033
c for each independent amplitude (with respect to parity only)          deph-034
c  mf(1,*)  helicity of the outgoing particle                           deph-035
c  mf(2,*)  helicity of the residual target                             deph-036
c  mf(3,*)  helicity of the incoming particle                           deph-037
c  mf(4,*)  helicity of the target                                      deph-038
c    these helicities are numbered from the lowest value                deph-039
c  mf(5,*)  twice the magnetic quantum number of the rotation matrix    deph-040
c    elements related to the initial state                              deph-041
c  mf(6,*)  twice the magnetic quantum number of the rotation matrix    deph-042
c    elements for the final state; however, with absolute value 99999 itdeph-043
c    indicates that the last computed matrix elements can be used with  deph-044
c    the sign of mf(10,*). a re-ordering of the helicities has been donedeph-045
c  mf(7,*)  direct address of the amplitude in an one-row matrix        deph-046
c  mf(8,*)  direct address of parity related amplitude or 0 if there is deph-047
c    none                                                               deph-048
c  mf(9,*)  relative sign between the amplitudes mf(7,*) and mf(8,*)    deph-049
c  mf(10,*) relative sign for rotation matrix elements for mf(6,*)=99999deph-050
c***********************************************************************deph-051
      implicit real*8 (a-h,o-z)                                         deph-052
      logical lo(250)                                                   deph-053
      dimension ipi(11,3),mf(10,1),ngr(2),npr(2),niv(ncoll,ncoll,3),wv(1deph-054
     18,1),nct(6)                                                       deph-055
      common /inout/ mr,mw,ms                                           deph-056
      njc=2                                                             deph-057
      njy=0                                                             deph-058
      jtx=0                                                             deph-059
      nct(5)=0                                                          deph-060
      nct(6)=0                                                          deph-061
      kcc=0                                                             deph-062
      ms1=0                                                             deph-063
      ms2=0                                                             deph-064
      ni=ipi(2,1)                                                       deph-065
      mi=ipi(3,1)                                                       deph-066
c loop on the nuclear levels                                            deph-067
      do 13 i=1,ncols                                                   deph-068
      ip=mod(ipi(1,i)+ipi(1,1),2)                                       deph-069
      ki=kcc+1                                                          deph-070
      ipi(6,i)=ki                                                       deph-071
      nj=ipi(2,i)                                                       deph-072
      mj=ipi(3,i)                                                       deph-073
      ms1=max0(ms1,nj)                                                  deph-074
      ms2=max0(ms2,mj)                                                  deph-075
      do 10 i1=1,nj                                                     deph-076
      j1=nj+1-i1                                                        deph-077
      do 9 i2=1,mj                                                      deph-078
      j2=mj+1-i2                                                        deph-079
      do 8 i3=1,ni                                                      deph-080
      j3=ni+1-i3                                                        deph-081
      do 7 i4=1,mi                                                      deph-082
      j4=mi+1-i4                                                        deph-083
      if (kcc.lt.ki) go to 3                                            deph-084
c search for parity conjugate among the amplitudes already obtained     deph-085
      do 1 j=ki,kcc                                                     deph-086
      if ((mf(1,j).eq.j1).and.(mf(2,j).eq.j2).and.(mf(3,j).eq.j3).and.(mdeph-087
     1f(4,j).eq.j4)) go to 2                                            deph-088
    1 continue                                                          deph-089
      go to 3                                                           deph-090
    2 mf(8,j)=i1+nj*(i2-1+mj*(i4-1+mi*(i3-1)))                          deph-091
      mf(9,j)=1-2*mod(ip+j1+i2+j3+i4,2)                                 deph-092
      go to 7                                                           deph-093
c new amplitude                                                         deph-094
    3 kcc=kcc+1                                                         deph-095
      if (5*kcc.ge.nmax) call memo('deph',nmax,5*kcc,2)                 deph-096
      mf(1,kcc)=i1                                                      deph-097
      mf(2,kcc)=i2                                                      deph-098
      mf(3,kcc)=i3                                                      deph-099
      mf(4,kcc)=i4                                                      deph-100
      mf(5,kcc)=2*(mf(3,kcc)-mf(4,kcc))-ipi(2,1)+ipi(3,1)               deph-101
      mf(6,kcc)=2*(mf(1,kcc)-mf(2,kcc))-ipi(2,i)+ipi(3,i)               deph-102
      mf(7,kcc)=i1+nj*(i2-1+mj*(i4-1+mi*(i3-1)))                        deph-103
      mf(8,kcc)=0                                                       deph-104
      mf(9,kcc)=0                                                       deph-105
      mf(10,kcc)=0                                                      deph-106
      if (kcc.le.ki) go to 7                                            deph-107
c search for related rotation matrix elements                           deph-108
      kk=kcc-1                                                          deph-109
      m1=iabs(mf(5,kcc)+mf(6,kcc))/2                                    deph-110
      m2=iabs(mf(5,kcc)-mf(6,kcc))/2                                    deph-111
      do 6 j=ki,kk                                                      deph-112
      if (mf(6,j).eq.99999) go to 6                                     deph-113
      m3=iabs(mf(5,j)+mf(6,j))/2                                        deph-114
      m4=iabs(mf(5,j)-mf(6,j))/2                                        deph-115
      if (m1.ne.m3.or.m2.ne.m4) go to 6                                 deph-116
      mf(10,kcc)=1-mod(iabs(mf(5,j)-mf(5,kcc)+mf(6,kcc)-mf(6,j))/2,4)   deph-117
      mf(6,kcc)=99999                                                   deph-118
      ja=j+1                                                            deph-119
      if (ja.eq.kcc) go to 7                                            deph-120
c permutation of amplitudes                                             deph-121
      do 5 m1=1,10                                                      deph-122
      m2=mf(m1,kcc)                                                     deph-123
      do 4 m3=ja,kcc                                                    deph-124
      m4=kcc+ja-m3                                                      deph-125
    4 mf(m1,m4)=mf(m1,m4-1)                                             deph-126
    5 mf(m1,ja)=m2                                                      deph-127
      go to 7                                                           deph-128
    6 continue                                                          deph-129
    7 continue                                                          deph-130
    8 continue                                                          deph-131
    9 continue                                                          deph-132
   10 continue                                                          deph-133
      ipi(7,i)=kcc                                                      deph-134
c computation of the number of coupled equations                        deph-135
      l=nj*mj                                                           deph-136
      kk1=l/2                                                           deph-137
      kk2=l-kk1                                                         deph-138
      if (kk1.eq.kk2) go to 11                                          deph-139
      n=mj/2+nj/2+ipi(1,i)                                              deph-140
      if (2*(n/2).eq.n) go to 11                                        deph-141
      kk1=kk1+1                                                         deph-142
      kk2=kk1-1                                                         deph-143
   11 nct(5)=nct(5)+kk2                                                 deph-144
      nct(6)=nct(6)+kk1                                                 deph-145
      if (i.ne.1) go to 12                                              deph-146
      nct(3)=nct(5)                                                     deph-147
      nct(4)=nct(6)                                                     deph-148
   12 if (i.ne.ncoll) go to 13                                          deph-149
      nct(1)=nct(5)                                                     deph-150
      nct(2)=nct(6)                                                     deph-151
      kab=max0(nct(1),nct(2))                                           deph-152
      kbc=max0(nct(3),nct(4))                                           deph-153
      if (nct(4).eq.0) kab=nct(1)                                       deph-154
      if (nct(3).eq.0) kab=nct(2)                                       deph-155
      kba=kcc                                                           deph-156
   13 continue                                                          deph-157
      if (kba.eq.kcc) write (mw,1000) kbc,kab,kba                       deph-158
      if (kba.ne.kcc) write (mw,1001) kbc,kab,kba,kcc                   deph-159
      ktgr=kcc                                                          deph-160
      ipi(9,ncols)=ipi(7,ncols)                                         deph-161
      if (lo(66)) go to 25                                              deph-162
c***********************************************************************deph-163
c   **** table mf-fm **** second part                                   deph-164
c  this part of the table is prolongated in lecd for each angular       deph-165
c  distribution and will be updated by obse      - for each observable  deph-166
c  mf(1,*)             level                                            deph-167
c  mf(2,*)             kind of observable: 0 for cross-section, 1 for   deph-168
c                      c.-s./ruth.,-2 and -3 for vector analysing power deph-169
c                      and polarisation for spins not greater than 1    deph-170
c  mf(3,i), mf(4,i)    beginning and end of the description in am (obse)deph-171
c  mf(5,*)             indication for plots                             deph-172
c  mf(6,*) to m(10,*)  contains the legend   (in obse)                  deph-173
c  ****standard options****                                             deph-174
c for all states : cross section                                        deph-175
c for ground state with charged particles: cross section divided by     deph-176
c       rutherford's cross-section                                      deph-177
c for spin 1/2 - ground state  polarisation                             deph-178
c for spin 1/2 excited states  vect. ana. power,polar. and spin-flip    deph-179
c for spin larger than 1/2  ground state it11,t20,t21 and t22           deph-180
c for excited states,it11,vect. polar.,t20,t21,t22                      deph-181
c  *** non-standard options ***                                         deph-182
c  the first one must be the cross-section                              deph-183
c any observable not described below is identified by a negative number deph-184
c  of which the positive value must be found by obse                    deph-185
c  followed by the description of the observable                        deph-186
c **** standard descriptions ****                                       deph-187
c 0  cross section                                                      deph-188
c  1  cross section divided by rutherford's cross section               deph-189
c  2  vector analysing power                                            deph-190
c  3  vector polarisation                                               deph-191
c  4  t20     5  t21     6  t22                                         deph-192
c  7  kyy or d  defined as -a(1100 1100)-a(1100 1-100)                  deph-193
c  8  kxx or r  defined as  a(1100 1100)-a(1100 1-100)                  deph-194
c  9  kzz or a' defined as  a(1000 1000)                                deph-195
c 10  kxz or r' defined as -sqrt(2.) a(1100 1000)                       deph-196
c 11  kzx or a  defined as -sqrt(2.) a(1000 1100)                       deph-197
c 12  spin-flip :  (a(0000,0000)+a(1100,1100)+a(1100,1-100))/2          deph-198
c 13  vector analysing power of the target                              deph-199
c   (note a ratio sqrt(2.) with it11 for spin 1/2 for 2, 3 and 13)      deph-200
c 14  ayy  defined as -a(1111 0000)-a(111-1 0000)                       deph-201
c 15  axx  defined as  a(1111 0000)-a(111-1 0000)                       deph-202
c 16  azz  defined as  a(1010 0000)                                     deph-203
c 17  axz  defined as -sqrt(2.) a(1110 0000)                            deph-204
c 18  azx  defined as -sqrt(2.) a(1011 0000)                            deph-205
c 19  reserved for a set of experimental data which are reaction        deph-206
c          cross-sections. see "cards read in subroutine lecd"          deph-207
c***********************************************************************deph-208
      kx=kcc                                                            deph-209
      iy=1                                                              deph-210
      if (lo(194)) go to 14                                             deph-211
      read (mr,1002) (ipi(9,i),i=1,ncoll)                               deph-212
      write (mw,1003) (i,ipi(9,i),i=1,ncoll)                            deph-213
   14 do 24 i=1,ncoll                                                   deph-214
      if (lo(94)) go to 19                                              deph-215
c there must be at least place to store six observables                 deph-216
      if (5*kx+30.ge.nmax) call memo('deph',nmax,5*kx+30,2)             deph-217
      kx=kx+1                                                           deph-218
      ipi(9,i)=1                                                        deph-219
      mf(2,kx)=0                                                        deph-220
      if ((i.ne.1).or.(ipi(4,1).eq.0)) go to 15                         deph-221
      ipi(9,1)=2                                                        deph-222
      kx=kx+1                                                           deph-223
      mf(2,kx)=1                                                        deph-224
   15 mf(5,kx)=ngr(iy)                                                  deph-225
      if (ni.eq.1) go to 19                                             deph-226
      ipi(9,i)=ipi(9,i)+1                                               deph-227
      kx=kx+1                                                           deph-228
      mf(2,kx)=2                                                        deph-229
      ix=npr(iy)/2                                                      deph-230
      mf(5,kx)=npr(1)-2*ix                                              deph-231
      if (ni.gt.2) go to 17                                             deph-232
      if (i.eq.1) go to 19                                              deph-233
      if (ipi(2,i).gt.3) go to 16                                       deph-234
      if (ipi(2,i).eq.1) go to 19                                       deph-235
      ipi(9,i)=ipi(9,i)+1                                               deph-236
      kx=kx+1                                                           deph-237
      mf(2,kx)=3                                                        deph-238
      mf(5,kx)=mod(ix,2)                                                deph-239
      ix=ix/2                                                           deph-240
   16 kx=kx+1                                                           deph-241
      mf(2,kx)=12                                                       deph-242
      mf(5,kx)=mod(ix,2)                                                deph-243
      ipi(9,i)=ipi(9,i)+1                                               deph-244
      go to 19                                                          deph-245
   17 ipi(9,i)=ipi(9,i)+3                                               deph-246
      do 18 l=4,6                                                       deph-247
      kx=kx+1                                                           deph-248
      mf(2,kx)=l                                                        deph-249
      mf(5,kx)=mod(ix,2)                                                deph-250
   18 ix=ix/2                                                           deph-251
   19 k1=ktgr+1                                                         deph-252
      ipi(8,i)=k1                                                       deph-253
      ktgr=ktgr+ipi(9,i)                                                deph-254
      ipi(9,i)=ktgr                                                     deph-255
      if (5*ktgr.ge.nmax) call memo('deph',nmax,5*ktgr,2)               deph-256
      do 20 j=k1,ktgr                                                   deph-257
   20 mf(1,j)=i                                                         deph-258
      if (lo(194)) go to 22                                             deph-259
      read (mr,1002) (mf(2,j),j=k1,ktgr)                                deph-260
      if (mf(2,k1).ne.0) write (mw,1004)                                deph-261
      read (mr,1002) (mf(5,j),j=k1,ktgr)                                deph-262
      mf(2,k1)=0                                                        deph-263
      write (mw,1005) i,(mf(2,j),j=k1,ktgr)                             deph-264
      write (mw,1006) (mf(5,j),j=k1,ktgr)                               deph-265
      do 21 j=k1,ktgr                                                   deph-266
      if (mf(2,j).gt.18) go to 32                                       deph-267
   21 continue                                                          deph-268
   22 jt=0                                                              deph-269
      do 23 j=k1,ktgr                                                   deph-270
      njy=max0(njy,-mf(2,j))                                            deph-271
      if (mf(2,j).eq.0.or.mf(2,j).eq.1) go to 23                        deph-272
      jt=jt+1                                                           deph-273
   23 continue                                                          deph-274
      jtx=max0(jtx,jt)                                                  deph-275
      njc=max0(njc,ktgr-k1+2)                                           deph-276
   24 iy=2                                                              deph-277
      if (lo(81)) njc=max0(njc+2,6)                                     deph-278
   25 iy=0                                                              deph-279
      if (lo(44)) iy=1                                                  deph-280
      if (lo(46).and.lo(44)) write (mw,1007)                            deph-281
      do 28 i=1,ncoll                                                   deph-282
      if (lo(46).and.lo(44)) go to 27                                   deph-283
      do 26 j=1,ncoll                                                   deph-284
   26 niv(i,j,3)=iy                                                     deph-285
      if (lo(208)) niv(i,i,3)=1                                         deph-286
      go to 28                                                          deph-287
   27 read (mr,1002) (niv(i,j,3),j=1,ncoll)                             deph-288
      write (mw,1008) i,(j,niv(i,j,3),j=1,ncoll)                        deph-289
   28 continue                                                          deph-290
      nj=njx                                                            deph-291
      do 30 i=1,ncoll                                                   deph-292
      do 29 j=1,i                                                       deph-293
      l=niv(i,j,3)                                                      deph-294
      niv(i,j,3)=0                                                      deph-295
c no coul. corr. with diff. particle mass, charges or a closed channel  deph-296
      if (l.eq.0.or.ipi(4,i).ne.ipi(4,j).or.wv(1,i).ne.wv(1,j).or.wv(3,ideph-297
     1).lt.0..or.wv(3,j).lt.0.) go to 29                                deph-298
      njx=njx+1                                                         deph-299
      niv(i,j,3)=njx                                                    deph-300
   29 niv(j,i,3)=niv(i,j,3)                                             deph-301
   30 continue                                                          deph-302
      if (nj.eq.njx) return                                             deph-303
      write (mw,1009)                                                   deph-304
      do 31 i=1,ncoll                                                   deph-305
   31 write (mw,1010) i,(niv(i,j,3),j,j=1,ncoll)                        deph-306
      return                                                            deph-307
   32 write (mw,1011)                                                   deph-308
      stop                                                              deph-309
 1000 format (/5x,i3,' solutions',i10,' coupled equations',i10,' independeph-310
     1dent amplitudes'/)                                                deph-311
 1001 format (/5x,i3,' solutions',i10,' coupled equations',i10,' independeph-312
     1dent amplitudes',i10,' sets of compound coeff.'/)                 deph-313
 1002 format (14i5)                                                     deph-314
 1003 format (/' equidistant angles output'//(10x,'channel',i3,5x,i3,' odeph-315
     1bservables'))                                                     deph-316
 1004 format (' the first observable must be the cross section: label 0'deph-317
     1)                                                                 deph-318
 1005 format (' observables for channel',i3,'  : ',18i5/(24x,18i5))     deph-319
 1006 format (12x,'graph information: ',18i5/(24x,18i5))                deph-320
 1007 format (/' coulomb corrections ( 1=yes, 0=no)')                   deph-321
 1008 format (' i =',i2,4x,10(' j =',i2,':',i1,2x)/(10x,10(' j =',i2,':'deph-322
     1,i1,2x)))                                                         deph-323
 1009 format (/' storage of coulomb corrections')                       deph-324
 1010 format (' i =',i2,2x,6(i6,' for j =',i2)/(10x,6(i6,' for j =',i2))deph-325
     1)                                                                 deph-326
 1011 format (//' the standard observables are only 19 for any other givdeph-327
     1e a negative integer'///' in deph  ... stop ...')                 deph-328
      end                                                               deph-329
c 29/02/04                                                      ecis03  lecd-000
      subroutine lecd(ncoll,ncolt,ncolr,wv,mf,mfm,fm,donn,np,ntot,nrec,dlecd-001
     1w,nw,nmx,kfit,nessai,yy,jtx,njy,nmax,lo)                          lecd-002
c input of experimental data and search informations                    lecd-003
c input variables: ncoll: number of nuclear levels with angular distrib.lecd-004
c                  ncolt: number of total cross-sections                lecd-005
c                  ncolr: number of angular distributions               lecd-006
c                  wv(3,*):  energy in the center of mass in mev        lecd-007
c                  np:    indications for plots of cross-section        lecd-008
c                  nrec:  number of parameters in search                lecd-009
c                  jtx:   maximum number of angles for a graph          lecd-010
c                  nmax:  maximum number of data for the working space  lecd-011
c                  lo:    logical controls. if lo(72)=.true. no output olecd-012
c                         experimental data                             lecd-013
c output variables:jtx:   maximum number of angles for a graph          lecd-014
c                  njy:   maximum index of non standard observable      lecd-015
c                  mf:    continuation of the second part of mf as      lecd-016
c                         described in deph                             lecd-017
c                  mfm,fm:in equivalence by call: mfm(1,*) channel,     lecd-018
c                         mfm(2,*), mfm(3,*) beginning and end of data, lecd-019
c                         mfm(4,*) indication c.m./lab as 0/1,          lecd-020
c                         fm(3,*) weight,                               lecd-021
c                         fm(4,*) and fm(5,*) norm and its error,       lecd-022
c                         fm(6,*) place for calculated normalisation,   lecd-023
c                         fm(7,*) place for calculated chi2.            lecd-024
c                  donn:  experimental data: angle, value, error,       lecd-025
c                         angular width and place for corrected error   lecd-026
c                  ntot:  number of experimental data                   lecd-027
c                  dw:    accuracy of parameters in search              lecd-028
c                  nw:    indexes of parameters in search               lecd-029
c                  nmx:   number of indexes                             lecd-030
c      if the number of data for an observable is 0,it is summed        lecd-031
c      with the next observable which must be of the same kind          lecd-032
c***********************************************************************lecd-033
      implicit real*8 (a-h,o-z)                                         lecd-034
      logical lo(250),lt,lx                                             lecd-035
      dimension donn(6,1),fm(7,ncolr),mfm(14,ncolr),mf(10,ncolr),np(2),dlecd-036
     1w(nmax),nw(2*nmax),yy(3),wv(18,1)                                 lecd-037
      common /inout/ mr,mw,ms                                           lecd-038
      lt=.true.                                                         lecd-039
      ntot=0                                                            lecd-040
      nclr=0                                                            lecd-041
      nmx=nrec+1                                                        lecd-042
      do 4 iv=1,ncolr                                                   lecd-043
c input of the definition of the angular distribution                   lecd-044
      lx=.false.                                                        lecd-045
      read (mr,1000) lx,mfm(4,iv),nt,mfm(1,iv),mf(2,iv),(fm(j,iv),j=3,5)lecd-046
      if (mfm(1,iv).gt.ncoll) go to 7                                   lecd-047
      if (wv(3,mfm(1,iv)).le.0.d0) go to 8                              lecd-048
      if (mf(2,iv).gt.19) go to 9                                       lecd-049
      if (fm(3,iv).eq.0.d0) fm(3,iv)=1.d0                               lecd-050
      if (fm(4,iv).eq.0.d0) fm(4,iv)=1.d0                               lecd-051
      fm(6,iv)=1.d0                                                     lecd-052
      fm(7,iv)=0.d0                                                     lecd-053
      mf(1,iv)=mfm(1,iv)                                                lecd-054
      jtx=max0(jtx,nt)                                                  lecd-055
      njy=max0(njy,-mf(2,iv))                                           lecd-056
      mf(5,iv)=1                                                        lecd-057
      mf2=min0(2,mfm(1,iv))                                             lecd-058
      if (mf(2,iv).eq.0.or.mf(2,iv).eq.1) mf(5,iv)=np(mf2)              lecd-059
      if (lo(172).and.nt.eq.0) write (mw,1001) iv,nt,mfm(1,iv),mf(2,iv) lecd-060
      if (.not.lt.and.(mf(2,iv).ne.mf(2,iv-1))) go to 10                lecd-061
      lt=nt.ne.0                                                        lecd-062
      ns=ntot+1                                                         lecd-063
      ntot=ntot+nt                                                      lecd-064
      mfm(2,iv)=ns                                                      lecd-065
      mfm(3,iv)=ntot                                                    lecd-066
      if (.not.lt) go to 4                                              lecd-067
      nclr=nclr+1                                                       lecd-068
      if (lo(172)) write (mw,1002) iv,nt,mfm(1,iv),mf(2,iv),(fm(i,iv),i=lecd-069
     13,5)                                                              lecd-070
      if (lo(172).and.(mf(2,iv).eq.19)) write (mw,1003)                 lecd-071
      lx=lx.and.(mf(2,iv).eq.0.or.mf(2,iv).eq.1.or.mf(2,iv).eq.19)      lecd-072
      if (lo(172).and.lx) write (mw,1004)                               lecd-073
      if (lo(172).and.mfm(4,iv).eq.1) write (mw,1005)                   lecd-074
      if (3*ntot+3.ge.nmax) call memo('lecd',nmax,3*ntot+3,2)           lecd-075
c input of the angular distribution data                                lecd-076
      do 1 i=ns,ntot                                                    lecd-077
      read (mr,1006) (donn(j,i),j=1,5)                                  lecd-078
      if (lx) donn(3,i)=donn(2,i)*donn(3,i)*.01d0                       lecd-079
      donn(6,i)=donn(3,i)                                               lecd-080
      if (lo(172)) write (mw,1007) i,(donn(j,i),j=1,5)                  lecd-081
    1 continue                                                          lecd-082
      if (mf(2,iv).lt.19) go to 3                                       lecd-083
c check of total cross-section data                                     lecd-084
      do 2 i=ns,ntot                                                    lecd-085
      j=idint(donn(1,i)+.1d0)                                           lecd-086
      if (j.lt.0.or.j.gt.ncolt+2) go to 11                              lecd-087
      if (j.gt.0.and.j.le.ncolt.and.wv(3,j).le.0.d0) go to 12           lecd-088
      if (lo(181)) go to 11                                             lecd-089
      if (lo(185).and.j.eq.ncolt+1) go to 11                            lecd-090
      if (lo(186).and.j.eq.ncolt+2) go to 11                            lecd-091
    2 continue                                                          lecd-092
    3 if (fm(5,iv).eq.0.d0) go to 4                                     lecd-093
      ntot=ntot+1                                                       lecd-094
c normalisation as a data for the search                                lecd-095
      donn(2,ntot)=fm(4,iv)                                             lecd-096
      donn(3,ntot)=fm(5,iv)                                             lecd-097
      if (lo(172)) write (mw,1008) ntot,donn(2,ntot),donn(3,ntot)       lecd-098
    4 continue                                                          lecd-099
      if (lo(172).and.(ncolr.ne.nclr)) write (mw,1009) nclr,ncolr       lecd-100
      if (lo(132).or.(nrec.eq.0)) go to 6                               lecd-101
      write (mw,1010) nrec,kfit,nessai,yy(1),yy(2)                      lecd-102
      nise=12*ntot+2*nrec                                               lecd-103
      if (nise+nmx.ge.2*nmax) call memo('lecd',nmax,(nise+nmx)/2,2)     lecd-104
      read (mr,1006) (dw(6*ntot+i),i=1,nrec)                            lecd-105
      read (mr,1011) (nw(nise+i),i=1,nrec)                              lecd-106
      write (mw,1012) (i,nw(nise+i),dw(6*ntot+i),i=1,nrec)              lecd-107
      do 5 i=1,nrec                                                     lecd-108
c a negative value -k instead of indexes of parameters means that k     lecd-109
c parameters will be kept proportional - input of their indexes         lecd-110
      k=-nw(nise+i)                                                     lecd-111
      if (k.lt.0) go to 5                                               lecd-112
      nw(nise+nmx)=k                                                    lecd-113
      if (nise+nmx+k.ge.2*nmax) call memo('lecd',nmax,(nise+nmx+k)/2,2) lecd-114
      read (mr,1011) (nw(nise+nmx+j),j=1,k)                             lecd-115
      write (mw,1013) i,(nw(nise+nmx+j),j=1,k)                          lecd-116
      nw(nise+i)=-nmx                                                   lecd-117
      nmx=nmx+k+1                                                       lecd-118
    5 continue                                                          lecd-119
    6 if (lt) return                                                    lecd-120
      write (mw,1014)                                                   lecd-121
      go to 13                                                          lecd-122
    7 write (mw,1015) mfm(1,iv)                                         lecd-123
      go to 13                                                          lecd-124
    8 write (mw,1016) mfm(1,iv)                                         lecd-125
      go to 13                                                          lecd-126
    9 write (mw,1017)                                                   lecd-127
      go to 13                                                          lecd-128
   10 write (mw,1018) mf(2,iv),mf(2,iv-1)                               lecd-129
      go to 13                                                          lecd-130
   11 write (mw,1019) donn(1,i),i                                       lecd-131
      go to 13                                                          lecd-132
   12 write (mw,1020) donn(1,i),i                                       lecd-133
   13 write (mw,1021)                                                   lecd-134
      stop                                                              lecd-135
 1000 format (l1,i1,i3,2i5,5x,3f10.5)                                   lecd-136
 1001 format (/'  ang. distr.',i3,i9,' data   level =',i3,5x,'kind =',i3lecd-137
     1,' unresolved with the following one'/)                           lecd-138
 1002 format (/'  ang. distr.',i3,i9,' data   level =',i3,5x,'kind =',i3lecd-139
     1//5x,'weight',d12.4,5x,'norm',d12.4,'  with error',d12.4//23x,'anglecd-140
     2le',14x,'value',15x,'error',12x,'ang. width',10x,'ang. error'/)   lecd-141
 1003 format (' these data are total cross-sections')                   lecd-142
 1004 format (' input of percentage errors')                            lecd-143
 1005 format (' angles in the laboratory system')                       lecd-144
 1006 format (7f10.5)                                                   lecd-145
 1007 format (5x,i5,5d20.6)                                             lecd-146
 1008 format (5x,i5,' data which is a normalisation',d20.6,' with error'lecd-147
     1,d20.6)                                                           lecd-148
 1009 format (/5x,i5,' different angular distributions instead of',i5/) lecd-149
 1010 format (//5x,i5,' parameters in search'/5x,i5,' results stored'/5xlecd-150
     1,i5,' runs    starting scale',f10.2/12x,'multiplication factor',f1lecd-151
     20.2/)                                                             lecd-152
 1011 format (14i5)                                                     lecd-153
 1012 format (5x,i5,5x,i5,5x,f15.8)                                     lecd-154
 1013 format (5x,i5,' variable defined as',20i5/(18x,20i5))             lecd-155
 1014 format (//'  the last angular distribution include no data')      lecd-156
 1015 format (//' level number',i4,' too large')                        lecd-157
 1016 format (//' level',i4,' closed')                                  lecd-158
 1017 format (//' there are only 20 kind of programmed observables'//'  lecd-159
     1for other kinds, introduce a negative number  and,later,their desclecd-160
     2ription')                                                         lecd-161
 1018 format (//' the kind =',i3,' of this observable is not the same aslecd-162
     1 the kind =',i3,' of the previous one which was empty')           lecd-163
 1019 format (' angular data',f10.5,' for',i4,' data not allowed for totlecd-164
     1al cross-section')                                                lecd-165
 1020 format (' angular data',f10.5,' for',i4,' data not allowed for clolecd-166
     1sed channel')                                                     lecd-167
 1021 format (//' in lecd  ... stop ...')                               lecd-168
      end                                                               lecd-169
c 29/02/04                                                      ecis03  obse-000
      subroutine obse(mf,cmf,nt,ncolr,ipi,am,itx,itz,bm,cbm,nx,jcal,jtn,obse-001
     1lo)                                                               obse-002
c computes for each observable all the indications for do loops and the obse-003
c geometrical coefficients needed in scat                               obse-004
c input variables: mf,cmf: informations coming from deph and lecd       obse-005
c                  nt:     number of rows of mf                         obse-006
c                  ncolr:  number of experimental angular distributions obse-007
c                  ipi(j=2,3,i): multiplicity of particle and target    obse-008
c                  jtn:    length available in am                       obse-009
c                  lo:     logical controls                             obse-010
c      the subroutine returns lo(226)=.true. if there is an observable  obse-011
c  not in the center of mass system.                                    obse-012
c output variables:am:   character*4 for transfer, see description belowobse-013
c                  jcal:   length of am                                 obse-014
c                  mf,cmf: equ. by call, second part updated (see deph) obse-015
c working fields:  bm(9,*), cbm and nx(18,*) in equivalence by call     obse-016
c                  the results are stored after the working field       obse-017
c                  and copied in am before return.                      obse-018
c                  itx(6,*) and itz(6,*) to store legends,              obse-019
c                           in equivalence with am                      obse-020
c***********************************************************************obse-021
c  the first part of the am table is sets of 10 d. p. indications,each  obse-022
c     of them related to a single "a" - the 8 first are indications for obse-023
c     the 4 do loops, 9 is a set of 6 logical in a binary code and indi-obse-024
c     cation for change of frame for the particle and the target under  obse-025
c     the form n1+1000*n2, 10 is the amplitude.                         obse-026
c  the second part are tensor operator matrix elements.                 obse-027
c       indications for a do loop are 4 integer                         obse-028
c        im: lower bound                                                obse-029
c        ip: upper bound                                                obse-030
c        nm: difference of magnetic quantum numbers                     obse-031
c        il: when added to the index of the do loop,address of the      obse-032
c             matrix element from the top of table am                   obse-033
c       the 4 first logicals  are .true. if there is a tensor operator  obse-034
c        for the related do loop,.false. for identity operator.         obse-035
c        the fifth is .true. for no tensor operator at all              obse-036
c        the sixth is .true. for pure imaginary coefficient             obse-037
c       indication for change of frame are                              obse-038
c            1 for laboratory system                                    obse-039
c            2 for axis along the incident direction                    obse-040
c***********************************************************************obse-041
      implicit real*8 (a-h,o-z)                                         obse-042
      logical lt1,lt2,lz(6),lo(250)                                     obse-043
      dimension iy(2,20),itx(7,21),mt(4),ipi(11,3),mf(10,nt),nx(18,12),mobse-044
     1x(8,24),nz(2),bm(9,12),cx(24)                                     obse-045
      character*4 itz(7,21),iz(5,20),cmf(10,nt),am(2,1),cbm(2,9,1)      obse-046
      common /inout/ mr,mw,ms                                           obse-047
      data iy /4*1,2*2,2*3,2*4,2*5,2*6,7,8,9,10,2*11,2*12,2*13,14,16,2*1obse-048
     17,18,19,20,21,2*22,2*23,2*24,2*1/                                 obse-049
      data cx /6*1.d0,2*-1.d0,1.d0,-1.d0,1.d0,2*-1.4142136573791504d0,3*obse-050
     1.5d0,1.4142136999999999d0,2*-1.d0,1.d0,-1.d0,1.d0,2*-1.41421365737obse-051
     291504d0/                                                          obse-052
      data mx,jts /8*0,2*1,10*0,2*1,2*0,2,7*0,2,1,6*0,2*2,6*0,2*1,2*0,2*obse-053
     11,2*0,2*1,2*0,1,-1,2*0,2*1,2*0,2*1,2*0,2*1,2*0,1,-1,2*0,1,3*0,1,3*obse-054
     20,2*1,2*0,1,3*0,1,3*0,2*1,10*0,2*1,2*0,2*1,2*0,2*1,2*0,1,-1,4*0,2*obse-055
     31,4*0,4*1,4*0,3*1,-1,4*0,4*1,4*0,3*1,-1,4*0,1,0,1,5*0,3*1,5*0,1,0,obse-056
     42*1,5*0/                                                          obse-057
      data iz /'   c','ross','-sec','tion','    ','   c','. s.','/rut','obse-058
     1her.','    ','   a','sym.',' or ','it11',2*'    ','vect','. po','lobse-059
     2ar.',4*'    ',' t20',4*'    ',' t21',4*'    ',' t22',3*'    ','kyyobse-060
     3 ','or d',3*'    ','kxx ','or r',2*'    ','   k','zz o','r a''',3*obse-061
     4'    ','kzx ','or a',2*'    ','   k','xz o','r r''',2*'    ','   sobse-062
     5','pin-','flip',2*'    ','targ','et a','sym.',4*'    ',' ayy',4*' obse-063
     6   ',' axx',4*'    ' ,' azz',4*'    ',' axz',4*'    ',' azx',2*'  obse-064
     7  ',' tot','al c','.-s.','    '/                                  obse-065
      if (jtn.lt.270) call memo('obse',jtn,270,2)                       obse-066
c transfer of standard descriptions                                     obse-067
      do 2 i=1,24                                                       obse-068
      do 1 j=1,8                                                        obse-069
    1 nx(j+6,i)=mx(j,i)                                                 obse-070
    2 bm(3,i)=cx(i)                                                     obse-071
      do 4 i=1,20                                                       obse-072
      itx(1,i)=iy(1,i)                                                  obse-073
      itx(2,i)=iy(2,i)                                                  obse-074
      do 3 j=3,7                                                        obse-075
    3 itz(j,i)=iz(j-2,i)                                                obse-076
    4 continue                                                          obse-077
      lo(226)=.false.                                                   obse-078
      kit=20                                                            obse-079
      knx=24                                                            obse-080
      jcal=0                                                            obse-081
      mt(1)=ipi(2,1)                                                    obse-082
      mt(2)=ipi(3,1)                                                    obse-083
c verification of indications already in mf(1,i)                        obse-084
      do 5 i=1,nt                                                       obse-085
      if (mf(2,i).le.18) go to 5                                        obse-086
      if (mf(2,i).eq.19.and.nt-i.ge.ncolr) go to 83                     obse-087
      if (mf(2,i).gt.19) go to 84                                       obse-088
    5 mf(6,i)=0                                                         obse-089
      if (lo(194).and.lo(131)) go to 56                                 obse-090
c search for non standard observables                                   obse-091
    6 do 7 l=1,nt                                                       obse-092
      if (mf(2,l).lt.0) go to 8                                         obse-093
    7 continue                                                          obse-094
      go to 56                                                          obse-095
    8 kz=kit                                                            obse-096
      kit=kit+1                                                         obse-097
c input of the description of non standard observables                  obse-098
      lt1=.false.                                                       obse-099
      lt2=.false.                                                       obse-100
      read (mr,1000) lt1,lt2,lt3,kx,k,(itz(j,kit),j=3,7)                obse-101
      k1=knx+1                                                          obse-102
      knx=knx+k                                                         obse-103
      if (9*knx.gt.jtn) call memo('obse',jtn,9*knx,2)                   obse-104
      read (mr,1001) ((nx(j,i),j=7,14),i=k1,knx)                        obse-105
      read (mr,1002) (bm(3,i),i=k1,knx)                                 obse-106
      if (lt1.or.lt2) read (mr,1002) (bm(1,i),i=k1,knx)                 obse-107
    9 k2=k1                                                             obse-108
      write (mw,1003) kx,(itz(j,kit),j=3,7),k                           obse-109
      if (lt1) write (mw,1004)                                          obse-110
      if (lt3.eq.1) write (mw,1005)                                     obse-111
      if (lt3.eq.2) write (mw,1006)                                     obse-112
      if (.not.lt2) go to 22                                            obse-113
c output of the description not completely in tensor notation           obse-114
c if lt2=.true. , observables can be defined as matrix elements         obse-115
c (mi,mf). in this case,the values read are (mi-s-1,mf-s-1) instead of  obse-116
c the quantum numbers of tensor operator.                               obse-117
      write (mw,1007)                                                   obse-118
   10 k3=min0(k2+5,knx)                                                 obse-119
      write (mw,1008) ((nx(i,j),i=11,14),j=k2,k3)                       obse-120
      write (mw,1009) (bm(3,i),i=k2,k3)                                 obse-121
      write (mw,1010) ((nx(i,j),i=7,10),j=k2,k3)                        obse-122
      write (mw,1011) (bm(1,i),i=k2,k3)                                 obse-123
      k2=k3+1                                                           obse-124
      if (k2.le.knx) go to 10                                           obse-125
      iv=mf(1,l)                                                        obse-126
      mt(3)=ipi(2,iv)                                                   obse-127
      mt(4)=ipi(3,iv)                                                   obse-128
      klt=1                                                             obse-129
c search for non tensor description - pseudo-loop for ij                obse-130
      ij=1                                                              obse-131
   11 k2=k1                                                             obse-132
      k6=knx                                                            obse-133
   12 if (k2.gt.k6) go to 14                                            obse-134
      do 13 k=k2,k6                                                     obse-135
      if (nx(2*ij+5,k).lt.0) go to 15                                   obse-136
   13 continue                                                          obse-137
   14 if (k6.ne.knx) go to 27                                           obse-138
      go to 20                                                          obse-139
c recurrence computation of (-)**(s-mf)*<s s mi -mf|l m>/sqrt(2*s+1)    obse-140
c starting with the minimum value of l                                  obse-141
   15 m1=mt(ij)+nx(2*ij+5,k)                                            obse-142
      m2=mt(ij)+nx(2*ij+6,k)                                            obse-143
      if (m1.lt.0.or.m2.lt.0) go to 85                                  obse-144
      m4=m1-m2                                                          obse-145
      m3=iabs(m4)+1                                                     obse-146
      m5=mt(ij)                                                         obse-147
      e2=0.d0                                                           obse-148
      e3=1.d0                                                           obse-149
      c1=dfloat(m1+m2-mt(ij)+1)                                         obse-150
      d2=0.d0                                                           obse-151
      c2=0.d0                                                           obse-152
      do 18 m=m3,m5                                                     obse-153
      if (m.eq.m3) go to 16                                             obse-154
      e1=e2                                                             obse-155
      e2=e3                                                             obse-156
      d1=d2                                                             obse-157
      f1=dfloat(((m-1)**2-m4**2)*(mt(ij)**2-(m-1)**2))                  obse-158
      f2=dfloat((2*m-1)*(2*m-3))                                        obse-159
      d2=dsqrt(f1/f2)                                                   obse-160
      e3=(c1*e2-d1*e1)/d2                                               obse-161
   16 knx=knx+1                                                         obse-162
      do 17 ji=7,14                                                     obse-163
   17 nx(ji,knx)=nx(ji,k)                                               obse-164
      nx(2*ij+5,knx)=m-1                                                obse-165
      nx(2*ij+6,knx)=m4                                                 obse-166
      c2=c2+e3*e3                                                       obse-167
   18 bm(1,knx)=e3                                                      obse-168
c normalisation and sign given by coefficient for maximum value of l    obse-169
      c2=c2*dfloat(mt(ij))                                              obse-170
      c2=1.d0/dsqrt(c2)                                                 obse-171
      if (e3.lt.0.d0) c2=-c2                                            obse-172
      if (mod(nx(2*ij+6,k),2).eq.0) c2=-c2                              obse-173
      do 19 m=m3,m5                                                     obse-174
      ji=knx+m-m5                                                       obse-175
      bm(3,ji)=bm(3,k)*bm(1,ji)*c2                                      obse-176
   19 bm(1,ji)=bm(1,k)*bm(1,ji)*c2                                      obse-177
      bm(3,k)=0.d0                                                      obse-178
      bm(1,k)=0.d0                                                      obse-179
      k2=k+1                                                            obse-180
      go to 12                                                          obse-181
   20 ij=ij+1                                                           obse-182
      if (ij.le.4) go to 11                                             obse-183
      k2=k1                                                             obse-184
      lt2=.false.                                                       obse-185
      if (lt1) go to 22                                                 obse-186
c if axis of quantification not in vertical plane, take imaginary       obse-187
c amplitude for pure imaginary tensors                                  obse-188
      do 21 k=k1,knx                                                    obse-189
      m1=nx(7,k)+nx(9,k)+nx(11,k)+nx(13,k)                              obse-190
      if (mod(m1,2).ne.0) bm(3,k)=bm(1,k)                               obse-191
   21 continue                                                          obse-192
   22 if (lt1) go to 35                                                 obse-193
c the first non zero magnetic quantum number must be positive           obse-194
      do 26 k4=k1,knx                                                   obse-195
      bm(1,k4)=0.d0                                                     obse-196
      do 23 j=8,14,2                                                    obse-197
      if (nx(j,k4)) 24 , 23 , 26                                        obse-198
   23 continue                                                          obse-199
      go to 26                                                          obse-200
   24 ik=0                                                              obse-201
      do 25 j=8,14,2                                                    obse-202
      ik=ik+nx(j-1,k4)+nx(j,k4)                                         obse-203
   25 nx(j,k4)=-nx(j,k4)                                                obse-204
      if (2*(ik/2).ne.ik) bm(3,k4)=-bm(3,k4)                            obse-205
   26 continue                                                          obse-206
      klt=2                                                             obse-207
c reduction of the description                                          obse-208
c for change into tensors if klt=1, for here if klt=2                   obse-209
c for change to axis in the reaction plane if klt=3                     obse-210
   27 if (k1.gt.knx) go to 86                                           obse-211
      do 30 k4=k1,knx                                                   obse-212
      if (dabs(bm(3,k4))+dabs(bm(1,k4)).lt..1d-6) go to 32              obse-213
      k5=k4-1                                                           obse-214
      if (k1.gt.k5) go to 30                                            obse-215
      do 29 j=k1,k5                                                     obse-216
      do 28 i=7,14                                                      obse-217
      if (nx(i,j).ne.nx(i,k4)) go to 29                                 obse-218
   28 continue                                                          obse-219
      go to 31                                                          obse-220
   29 continue                                                          obse-221
   30 continue                                                          obse-222
      go to ( 20 , 35 , 50 ),klt                                        obse-223
   31 bm(3,j)=bm(3,j)+bm(3,k4)                                          obse-224
      bm(1,j)=bm(1,j)+bm(1,k4)                                          obse-225
   32 knx=knx-1                                                         obse-226
      if (knx.lt.k4) go to 27                                           obse-227
      do 34 k=k4,knx                                                    obse-228
      do 33 j=7,14                                                      obse-229
   33 nx(j,k)=nx(j,k+1)                                                 obse-230
      bm(1,k)=bm(1,k+1)                                                 obse-231
   34 bm(3,k)=bm(3,k+1)                                                 obse-232
      go to 27                                                          obse-233
c output of the description                                             obse-234
   35 k3=min0(k2+5,knx)                                                 obse-235
      write (mw,1008) ((nx(i,j),i=11,14),j=k2,k3)                       obse-236
      write (mw,1012) (bm(3,i),i=k2,k3)                                 obse-237
      write (mw,1010) ((nx(i,j),i=7,10),j=k2,k3)                        obse-238
      if (lt1) write (mw,1011) (bm(1,i),i=k2,k3)                        obse-239
      k2=k3+1                                                           obse-240
      if (k2.le.knx) go to 35                                           obse-241
      do 37 k=k1,knx                                                    obse-242
      do 36 i=8,14,2                                                    obse-243
      if (iabs(nx(i,k)).gt.nx(i-1,k).or.nx(i-1,k).lt.0) go to 87        obse-244
   36 continue                                                          obse-245
   37 continue                                                          obse-246
      if (.not.lt1) go to 54                                            obse-247
c change from vertical axis of quantification to helicity description   obse-248
c by the rotation r(pi/2,pi/2,pi/2)                                     obse-249
      do 39 i=k1,knx                                                    obse-250
      m1=iabs(nx(8,i))+iabs(nx(10,i))+iabs(nx(12,i))+iabs(nx(14,i))     obse-251
      m2=m1/2                                                           obse-252
      if (2*m2.ne.m1) go to 88                                          obse-253
      if (2*(m2/2).eq.m2) go to 38                                      obse-254
      bm(3,i)=-bm(3,i)                                                  obse-255
      bm(1,i)=-bm(1,i)                                                  obse-256
   38 if (m1.eq.0) bm(1,i)=0.d0                                         obse-257
   39 continue                                                          obse-258
      klt=3                                                             obse-259
c pseudo-loop on ij to 50                                               obse-260
      ij=7                                                              obse-261
   40 j1=knx                                                            obse-262
      do 47 k3=k1,knx                                                   obse-263
      k=nx(ij,k3)                                                       obse-264
      n1=k+nx(ij+1,k3)+1                                                obse-265
      n=2*k+1                                                           obse-266
      e3=1.d0                                                           obse-267
      if (k.eq.0) go to 42                                              obse-268
c rotation matrix elements for pi/2                                     obse-269
      do 41 i=1,k                                                       obse-270
   41 e3=e3*.5d0                                                        obse-271
   42 c1=0.d0                                                           obse-272
      e2=0.d0                                                           obse-273
      fj=dfloat(k)                                                      obse-274
      fs=-fj                                                            obse-275
      do 43 i=1,n1                                                      obse-276
      if (i.eq.1) go to 43                                              obse-277
      c2=c1                                                             obse-278
      c1=dsqrt(dfloat((i-1)*(1+n-i)))                                   obse-279
      e1=e2                                                             obse-280
      e2=e3                                                             obse-281
      e3=(2.d0*fj*e2-e1*c2)/c1                                          obse-282
      fs=fs+1.d0                                                        obse-283
   43 f2=0.d0                                                           obse-284
      f3=e3                                                             obse-285
      d1=0.d0                                                           obse-286
      do 46 j=1,n                                                       obse-287
      if (j.eq.1) go to 44                                              obse-288
      d2=d1                                                             obse-289
      d1=dsqrt(dfloat((j-1)*(1+n-j)))                                   obse-290
      f1=f2                                                             obse-291
      f2=f3                                                             obse-292
      f3=(2.d0*fs*f2-f1*d2)/d1                                          obse-293
   44 j1=j1+1                                                           obse-294
      if (9*j1.gt.jtn) call memo('obse',jtn,9*j1,2)                     obse-295
      do 45 l=7,14                                                      obse-296
   45 nx(l,j1)=nx(l,k3)                                                 obse-297
      bm(3,j1)=f3*bm(3,k3)                                              obse-298
      bm(1,j1)=f3*bm(1,k3)                                              obse-299
   46 nx(ij+1,j1)=j-1-k                                                 obse-300
   47 continue                                                          obse-301
c reduction of the description                                          obse-302
      j2=k1-1                                                           obse-303
      j3=knx+1                                                          obse-304
      do 49 j4=j3,j1                                                    obse-305
      j2=j2+1                                                           obse-306
      do 48 l=7,14                                                      obse-307
   48 nx(l,j2)=nx(l,j4)                                                 obse-308
      bm(3,j2)=bm(3,j4)                                                 obse-309
   49 bm(1,j2)=bm(1,j4)                                                 obse-310
      knx=j2                                                            obse-311
      go to 27                                                          obse-312
   50 ij=ij+2                                                           obse-313
      if (ij.le.13) go to 40                                            obse-314
      do 53 j1=k1,knx                                                   obse-315
      m1=nx(7,j1)+nx(9,j1)+nx(11,j1)+nx(13,j1)                          obse-316
      m2=nx(8,j1)+nx(10,j1)+nx(12,j1)+nx(14,j1)+4*m1                    obse-317
      m3=m2/2                                                           obse-318
      if (2*(m1/2).eq.m1) go to 51                                      obse-319
      if (2*m3.ne.m2) go to 52                                          obse-320
      bm(3,j1)=bm(1,j1)                                                 obse-321
      go to 52                                                          obse-322
   51 if (2*m3.eq.m2) go to 52                                          obse-323
      bm(3,j1)=-bm(1,j1)                                                obse-324
   52 if (2*(m3/2).ne.m3) bm(3,j1)=-bm(3,j1)                            obse-325
   53 continue                                                          obse-326
      lt1=.false.                                                       obse-327
      write (mw,1013)                                                   obse-328
      k=knx+1-k1                                                        obse-329
      go to 9                                                           obse-330
c storage of the description                                            obse-331
   54 l1=0                                                              obse-332
      itx(1,kit)=k1                                                     obse-333
      itx(2,kit)=knx                                                    obse-334
      do 55 i=1,nt                                                      obse-335
      if (mf(2,i).ne.-kx) go to 55                                      obse-336
      mf(2,i)=kz                                                        obse-337
      mf(6,i)=lt3                                                       obse-338
      l1=l1+1                                                           obse-339
   55 continue                                                          obse-340
      if (l1.eq.0) write (mw,1014) kx                                   obse-341
      go to 6                                                           obse-342
c computation of all the indications needed for the observables         obse-343
c (beginning and end of do loops,geometrical coefficients ...)          obse-344
   56 do 57 i=1,nt                                                      obse-345
      i1=mf(2,i)+1                                                      obse-346
      mf(3,i)=itx(1,i1)                                                 obse-347
   57 mf(4,i)=itx(2,i1)                                                 obse-348
      lt1=.false.                                                       obse-349
   58 lt1=.not.lt1                                                      obse-350
c lt1=.true.  first passage: number of informations needed for do loops obse-351
c lt1=.false. second one: computation of geometrical coefficients which obse-352
c are stored after the indications for do loops                         obse-353
      ical=0                                                            obse-354
      ncal=0                                                            obse-355
      do 78 i=1,nt                                                      obse-356
      iv=mf(1,i)                                                        obse-357
      mt(3)=ipi(2,iv)                                                   obse-358
      mt(4)=ipi(3,iv)                                                   obse-359
      if (mf(2,i).le.0.or.mf(2,i).eq.19) go to 78                       obse-360
      if (mf(2,i).ne.1) go to 59                                        obse-361
      if (iv.ne.1) go to 89                                             obse-362
      go to 78                                                          obse-363
   59 if ((mf(2,i).eq.2.and.mt(1).le.3).or.(mf(2,i).eq.3.and.mt(3).le.3)obse-364
     1) go to 62                                                        obse-365
      if (i.eq.1) go to 63                                              obse-366
      i1=i-1                                                            obse-367
      do 60 j=1,i1                                                      obse-368
      if (mf(1,i).eq.mf(1,j).and.mf(2,i).eq.mf(2,j)) go to 61           obse-369
   60 continue                                                          obse-370
      go to 63                                                          obse-371
   61 mf(3,i)=mf(3,j)                                                   obse-372
      mf(4,i)=mf(4,j)                                                   obse-373
      go to 78                                                          obse-374
   62 mf(2,i)=-mf(2,i)                                                  obse-375
      if ((mf(2,i).eq.-2.and.mt(1).eq.0).or.(mf(2,i).eq.-3.and.mt(3).eq.obse-376
     10)) go to 90                                                      obse-377
      go to 78                                                          obse-378
   63 i1=mf(3,i)                                                        obse-379
      i2=mf(4,i)                                                        obse-380
      do 77 ki=i1,i2                                                    obse-381
      kt=0                                                              obse-382
      do 73 l=1,4                                                       obse-383
      k=nx(2*l+5,ki)                                                    obse-384
      nm=nx(2*l+6,ki)                                                   obse-385
      kt=kt+k                                                           obse-386
      if (k.gt.mt(l)) go to 91                                          obse-387
      if (ical.eq.0) go to 65                                           obse-388
      do 64 n=1,ical                                                    obse-389
      if (mt(l).eq.nx(15,n).and.k.eq.nx(16,n).and.nm.eq.nx(17,n)) go to obse-390
     1 71                                                               obse-391
   64 continue                                                          obse-392
   65 ical=ical+1                                                       obse-393
      if (9*ical.gt.jtn) call memo('obse',jtn,9*ical,2)                 obse-394
      nx(15,ical)=mt(l)                                                 obse-395
      nx(16,ical)=k                                                     obse-396
      nx(17,ical)=nm                                                    obse-397
      nx(18,ical)=jcal                                                  obse-398
      if (lt1) go to 73                                                 obse-399
      il=mt(l)                                                          obse-400
      nx(1,ical)=max0(1,1+nm)                                           obse-401
      nx(2,ical)=min0(il,il+nm)                                         obse-402
      nx(3,ical)=nm                                                     obse-403
      nx(4,ical)=jcal-nx(1,ical)+1                                      obse-404
      if (nx(16,ical).eq.0) go to 70                                    obse-405
c recurrence computation of geometrical coefficients                    obse-406
      f3=dsqrt(dfloat(2*k+1))                                           obse-407
      do 66 j=1,k                                                       obse-408
   66 f3=-f3*dsqrt(dfloat(il-j)/dfloat(il+j))                           obse-409
      jnm=nm                                                            obse-410
      inm=iabs(jnm)                                                     obse-411
      if (jnm.eq.0) go to 68                                            obse-412
      if (inm.ne.jnm.and.2*(inm/2).ne.inm) f3=-f3                       obse-413
      do 67 j=1,inm                                                     obse-414
   67 f3=f3*dsqrt(dfloat((k+j)*(k-j+1))/dfloat(j*(il-j)))               obse-415
   68 jcal=jcal+1                                                       obse-416
      is=nx(2,ical)-nx(1,ical)                                          obse-417
      if (jcal+is.gt.jts) call memo('obse',jts,jcal+is,2)               obse-418
      bm(jcal,kx)=f3                                                    obse-419
      if (is.lt.1) go to 70                                             obse-420
      f2=0.d0                                                           obse-421
      d1=k*(k+1)-(il+1)*(inm-1)                                         obse-422
      c2=0.d0                                                           obse-423
      do 69 j=1,is                                                      obse-424
      c1=c2                                                             obse-425
      c2=dsqrt(dfloat(j*(il-j)*(j+inm)*(il-j-inm)))                     obse-426
      d1=d1+dfloat(2*(2*j-2-il+inm))                                    obse-427
      f1=f2                                                             obse-428
      f2=f3                                                             obse-429
      f3=-(d1*f2+c1*f1)/c2                                              obse-430
      jcal=jcal+1                                                       obse-431
      bm(jcal,kx)=f3                                                    obse-432
   69 continue                                                          obse-433
   70 n=ical                                                            obse-434
   71 if (lt1) go to 73                                                 obse-435
      do 72 ma=1,4                                                      obse-436
      mc=20*ncal+4*l+ma-4                                               obse-437
   72 nx(mc,kx)=nx(ma,n)                                                obse-438
      lz(l)=nx(16,n).ne.0                                               obse-439
   73 continue                                                          obse-440
      if (lt1) go to 76                                                 obse-441
      lz(5)=kt.eq.0                                                     obse-442
      lz(6)=2*(kt/2).ne.kt                                              obse-443
      nz(1)=0                                                           obse-444
      nz(2)=0                                                           obse-445
      if (lz(4)) nz(2)=mf(6,i)                                          obse-446
      if (lz(3).or.lz(4)) nz(1)=mf(6,i)                                 obse-447
      lo(226)=lo(226).or.nz(1).ne.0                                     obse-448
      ia1=0                                                             obse-449
      ia2=1                                                             obse-450
      do 74 li=1,6                                                      obse-451
      if (lz(li)) ia1=ia1+ia2                                           obse-452
   74 ia2=2*ia2                                                         obse-453
      nx(20*ncal+17,kx)=ia1                                             obse-454
      nx(20*ncal+18,kx)=nz(1)+1000*nz(2)                                obse-455
      bm(10*ncal+10,kx)=bm(3,ki)                                        obse-456
      do 75 li=2,4,2                                                    obse-457
      if (.not.lz(li)) go to 75                                         obse-458
      im=nx(20*ncal+4*li-3,kx)                                          obse-459
      nx(20*ncal+4*li-3,kx)=mt(li)-nx(20*ncal+4*li-2,kx)+1              obse-460
      nx(20*ncal+4*li-2,kx)=mt(li)-im+1                                 obse-461
      nx(20*ncal+4*li-1,kx)=-nx(20*ncal+4*li-1,kx)                      obse-462
      nx(20*ncal+4*li,kx)=nx(20*ncal+4*li,kx)+im+nx(20*ncal+4*li-2,kx)  obse-463
   75 continue                                                          obse-464
   76 ncal=ncal+1                                                       obse-465
   77 continue                                                          obse-466
      if (lt1) go to 78                                                 obse-467
      mf(4,i)=ncal                                                      obse-468
      mf(3,i)=ncal+i1-i2                                                obse-469
   78 continue                                                          obse-470
      if (.not.lt1) go to 79                                            obse-471
      kx=max0(knx,ical)+1                                               obse-472
      jcal=10*ncal                                                      obse-473
      jts=jtn-18*(kx-1)                                                 obse-474
      if (jcal.gt.jts) call memo('obse',jts,jcal,2)                     obse-475
      go to 58                                                          obse-476
c storage of legends and copy of results                                obse-477
   79 do 81 i=1,nt                                                      obse-478
      i5=iabs(mf(2,i))+1                                                obse-479
      do 80 j=3,7                                                       obse-480
   80 cmf(j+3,i)=itz(j,i5)                                              obse-481
   81 continue                                                          obse-482
      do 82 i=1,jcal                                                    obse-483
      am(1,i)=cbm(1,i,kx)                                               obse-484
   82 am(2,i)=cbm(2,i,kx)                                               obse-485
      return                                                            obse-486
   83 write (mw,1015) i,mf(2,i)                                         obse-487
      go to 92                                                          obse-488
   84 write (mw,1016) i,mf(2,i)                                         obse-489
      go to 92                                                          obse-490
   85 write (mw,1017) nx(2*ij+5,k),nx(2*ij+6,k),mt(ij)                  obse-491
      go to 92                                                          obse-492
   86 write (mw,1018)                                                   obse-493
      go to 92                                                          obse-494
   87 write (mw,1019) nx(2*i-1,k1),nx(2*i,k1)                           obse-495
      go to 92                                                          obse-496
   88 write (mw,1020)                                                   obse-497
      go to 92                                                          obse-498
   89 write (mw,1021) mf(1,i)                                           obse-499
      go to 92                                                          obse-500
   90 write (mw,1022) mf(1,i)                                           obse-501
      go to 92                                                          obse-502
   91 write (mw,1023) mt(l),mf(2,i),l,k                                 obse-503
   92 write (mw,1024)                                                   obse-504
      stop                                                              obse-505
 1000 format (2l1,i1,i2,i5,5a4)                                         obse-506
 1001 format (8i5)                                                      obse-507
 1002 format (6f10.5)                                                   obse-508
 1003 format (/' observable',i3,' labelled',5x,5a4,10x,i3,' components')obse-509
 1004 format (' defined with an axis perpendicular to the reaction planeobse-510
     1')                                                                obse-511
 1005 format (' defined in the laboratory system')                      obse-512
 1006 format (' defined with respect to the incident beam')             obse-513
 1007 format (' not completely defined by tensors')                     obse-514
 1008 format (/6(11x,4i2,2x))                                           obse-515
 1009 format (6(' +',f8.4,'*m',9x))                                     obse-516
 1010 format (6(11x,4i2,2x))                                            obse-517
 1011 format (' imaginary parts'/6(1x,f8.5,12x))                        obse-518
 1012 format (6(' +',f8.4,'*a',9x))                                     obse-519
 1013 format (//' after transformation'/)                               obse-520
 1014 format (' the observable read with number',i4,' is not used')     obse-521
 1015 format (' the',i4,'th observable, of kind',i2,' must be for experiobse-522
     1mental data')                                                     obse-523
 1016 format (' the',i4,'th observable, of kind',i2,' is not defined')  obse-524
 1017 format (' non tensor indications',i4,' and',i4,' incorrect for (2*obse-525
     1s+1) =',i3)                                                       obse-526
 1018 format (' zero observable')                                       obse-527
 1019 format (/' too large magnetic quantum number or negative multipolaobse-528
     1rity',2i6)                                                        obse-529
 1020 format (' the sum of magnetic quantum numbers is odd for one compoobse-530
     1nent')                                                            obse-531
 1021 format (' no cross section divided by rutherford''s for the inelasobse-532
     1tic channel',i3)                                                  obse-533
 1022 format (' no polarisation for a zero spin in the channel',i3)     obse-534
 1023 format (5x,i5,' is a too small spin in channel',i4,' and particle'obse-535
     1,i4,' for a polarisation of tensor order',i4)                     obse-536
 1024 format (//' in obse  ... stop ...')                               obse-537
      end                                                               obse-538
c 29/02/04                                                      ecis03  colf-000
      subroutine colf(ncolt,ncoll,ipi,wv,fg,xg,ism,lmax1,lmax2,h,iexp,z,colf-001
     1lm,lmax3,niv,kxt,lo)                                              colf-002
c coulomb functions at the matching point rm=ism*h                      colf-003
c input variables: ncolt:   number of nuclear states (coupled or not)   colf-004
c                           and continua for compound nucleus           colf-005
c                  ncoll:   number of coupled states                    colf-006
c                  ipi(j,*):product of charges for j=4                  colf-007
c                  wv(j,*): mass of particle and target for j=1,2       colf-008
c                           center of mass energy in mev for j=3        colf-009
c                  ism:     number of points for integration            colf-010
c                  lmax1:   maximum number of coulomb functions         colf-011
c                  lmax2:   maximum number of coulomb phase shifts      colf-012
c                  h:       integration step size in fermis             colf-013
c                  lm:      length of working space as single precision colf-014
c                  niv(*,*,3): addresses of coulomb integrals           colf-015
c                  lo:      logical controls                            colf-016
c for common /ncomp/ see calx, lect and colf                            colf-017
c in common /ncomp/nrd,nfiss: number of gamma and fission transmission  colf-018
c                             coefficients read in lect                 colf-019
c                  tg0,bn,fnug,egd,ggd:  neutron binding energy         colf-020
c                           giant dipole resonance energy and width ....colf-021
c in common /dcont/  xe,xm,xn:      relativistic energy and mass (colf) colf-022
c                    xz:            conversion factor to millibarns     colf-023
c output variables:wv(4,*): wave number in 1/fermi                      colf-024
c                  wv(5,*): coulomb parameter                           colf-025
c                  wv(6,*): square root of ratios of wave numbers       colf-026
c                           (modified by step sizes)                    colf-027
c                  wv(7,*): relativistic energy                         colf-028
c                  wv(8,*): step size times ratio of wave number to     colf-029
c                                square root of non relativistic energy colf-030
c                  wv(9,*): wave number multiplies by ratio of steps    colf-031
c                  wv(10,*):square of the product of wave number by the colf-032
c                                step size                              colf-033
c                  wv(11,*):step size for the level                     colf-034
c to take into account recoil when the masses are not the same in all   colf-035
c the channels, the wv(8,*) and wv(9,*) are multiplied by a scale factorcolf-036
c x=(initial target mass)/(target mass) and wv(10,*) is multiplied by   colf-037
c its square. always wv(10,*)=(h*wv(9,*))**2.                           colf-038
c                  fg(m,i=1 to 4,iv): f,fp,g,gp for l=m-1 and iv=1,ncollcolf-039
c                   and integrals of f*f,f*g,g*f and g*g/r**2 from rm tocolf-040
c                   infinity if lo(44)=.true. for iv greater than ncoll colf-041
c                  xg(m,iv): sigma(m-1)-sigma(0) for iv=1,ncoll         colf-042
c                   and integrals of f*f/r**2 from zero to infinity     colf-043
c                   if lo(44)=.true. for iv greater than ncoll          colf-044
c                  kxt:   total number of penetrabilities               colf-045
c                  kxt:   number of penetrabilities for uncoupled statescolf-046
c                  lmax3: effective maximum number of coulomb functions colf-047
c                  ipi(j,i): for i=ncoll+1 to ncolt, maximum l+1 and    colf-048
c                   starting address of penetrabilities in 7 and 9      colf-049
c working field in fcou: iexp(i), i=1,lmax1  powers of 10 for large     colf-050
c                    values of functions (multiples of 10**30)          colf-051
c working field in cori:  z  see in cori                                colf-052
c***********************************************************************colf-053
      implicit real*8 (a-h,o-z)                                         colf-054
      logical lo(250)                                                   colf-055
      dimension wv(18,1),fg(lmax1,4,1),xg(lmax2,1),z(1),iexp(1),niv(ncolcolf-056
     1l,ncoll,3),ipi(11,3)                                              colf-057
      common /dcons/ cm,ck,chb,cmb,ccz                                  colf-058
      common /dcont/ xe,xm,xn,xz                                        colf-059
      common /inout/ mr,mw,ms                                           colf-060
      kxt=0                                                             colf-061
      xm=cm*wv(1,1)*wv(2,1)/(wv(1,1)+wv(2,1))                           colf-062
      if (lo(98)) xm=cm*wv(1,1)                                         colf-063
      if (.not.lo(209)) write (mw,1000)                                 colf-064
      if (lo(209)) write (mw,1001) xm                                   colf-065
      xn=chb**2/(2.d0*xm)                                               colf-066
c check of the length of working field for iexp                         colf-067
      if (lm.lt.lmax1) call memo('colf',lm,lmax1,2)                     colf-068
      amrd=xm/cm                                                        colf-069
      amr=wv(3,1)/cm+wv(1,1)+wv(2,1)                                    colf-070
      lmax3=lmax1                                                       colf-071
c wave number,coulomb parameter and call to coulomb subroutines         colf-072
      do 11 i=1,ncolt                                                   colf-073
      rec=1.d0                                                          colf-074
      if (lo(193).and.wv(1,1).ne.wv(1,i)) rec=wv(2,1)/wv(2,i)           colf-075
      hrec=h*rec                                                        colf-076
      rm=ism*h                                                          colf-077
      wv(11,i)=hrec                                                     colf-078
      if (lo(8)) go to 1                                                colf-079
      amrd=wv(1,i)*wv(2,i)/(wv(1,i)+wv(2,i))                            colf-080
      wsk2=ck*wv(3,i)*amrd                                              colf-081
      go to 3                                                           colf-082
    1 amt=wv(2,i)                                                       colf-083
      if (lo(209)) go to 2                                              colf-084
c reduced mass replaced by reduced energy (h.v. geramb's suggestion)    colf-085
c for relativistic conventional schroedinger equation                   colf-086
      if (lo(44)) amt=wv(2,1)                                           colf-087
      amrd=(amr**4-(wv(1,i)**2-amt**2)**2)/(4.d0*amr**3)                colf-088
    2 wsk2=0.125d0*ck*wv(3,i)*(wv(3,i)/cm+2.d0*wv(1,i)+2.d0*amt)*(wv(3,icolf-089
     1)/cm+2.d0*wv(1,i))*(wv(3,i)/cm+2.d0*amt)/amr**2                   colf-090
    3 wv(4,i)=dsqrt(dabs(wsk2))                                         colf-091
      wv(9,i)=wv(4,i)*rec                                               colf-092
      wv(6,i)=dsqrt(wv(9,i)/wv(9,1))                                    colf-093
      wv(8,i)=hrec*dsqrt(ck*amrd)                                       colf-094
      wv(10,i)=hrec*hrec*wsk2                                           colf-095
      if (lo(209)) go to 4                                              colf-096
      wv(5,i)=0.5d0*ck*ccz*amrd*ipi(4,i)/wv(4,i)                        colf-097
      g=amrd*(wv(1,i)+wv(2,i))/(wv(1,i)*wv(2,i))                        colf-098
      if (i.le.ncoll) write (mw,1002) i,(wv(j,i),j=4,6),g,amrd,hrec     colf-099
      go to 5                                                           colf-100
    4 hpc=chb*wv(4,i)                                                   colf-101
      wv(7,i)=dsqrt(hpc**2+xm**2)                                       colf-102
      wv(5,i)=ccz*ipi(4,i)/wv(4,i)*wv(7,i)/chb**2                       colf-103
      if (i.le.ncoll) write (mw,1002) i,(wv(j,i),j=4,7),hrec            colf-104
    5 if (dabs(wv(5,i)).gt.400.d0) wv(5,i)=400.d0*wv(5,i)/dabs(wv(5,i)) colf-105
      if (i.gt.ncoll) go to 7                                           colf-106
      rau=rm*wv(9,i)                                                    colf-107
      eta=wv(5,i)                                                       colf-108
      if (wv(3,i).gt.0.d0) go to 6                                      colf-109
      call cocl(fg(1,1,i),fg(1,2,i),fg(1,3,i),fg(1,4,i),xg(1,i),eta,rau,colf-110
     1lmax1-1)                                                          colf-111
      go to 8                                                           colf-112
    6 lx=lmax1                                                          colf-113
      call fcou(lx-1,eta,rau,fg(1,1,i),fg(1,2,i),fg(1,3,i),fg(1,4,i),iexcolf-114
     1p,xg(1,i))                                                        colf-115
      go to 8                                                           colf-116
    7 ly=0                                                              colf-117
      if (wv(3,i).gt.0.d0) ly=min0(idint(4.d0+3.3d0*dsqrt(wv(3,i))),lmaxcolf-118
     11)                                                                colf-119
      ipi(10,i)=ly-1                                                    colf-120
      ipi(8,i)=kxt                                                      colf-121
      kxt=kxt+ly*ipi(2,i)                                               colf-122
      go to 11                                                          colf-123
    8 ipi(10,i)=ipi(10,1)                                               colf-124
      if (wsk2.lt.0.d0) go to 11                                        colf-125
c computation of coulomb phase-shifts                                   colf-126
      lmx1=lmax3                                                        colf-127
c correction of large value and search for maximum effective number     colf-128
c of coulomb functions                                                  colf-129
      do 9 j=1,lmx1                                                     colf-130
      if (iexp(j).eq.0) go to 9                                         colf-131
      if (lo(208).or.iexp(j).gt.15) lmax3=min0(lmax3,j)                 colf-132
      fg(j,1,i)=fg(j,1,i)*1.d-15                                        colf-133
      fg(j,2,i)=fg(j,2,i)*1.d-15                                        colf-134
      fg(j,3,i)=fg(j,3,i)*1.d15                                         colf-135
      fg(j,4,i)=fg(j,4,i)*1.d15                                         colf-136
    9 continue                                                          colf-137
      if (lmx1.ne.lmax3) write (mw,1003) lmx1,lmax3                     colf-138
      if (.not.lo(208)) ipi(10,i)=min0(lmax3-1,ipi(10,1))               colf-139
c computation of coulomb integrals                                      colf-140
      xi=xg(1,i)                                                        colf-141
      si=wv(9,i)                                                        colf-142
      do 10 j=1,i                                                       colf-143
      k=niv(i,j,3)                                                      colf-144
      if (k.eq.0) go to 10                                              colf-145
      xj=xg(1,j)                                                        colf-146
      ej=wv(5,j)                                                        colf-147
      sj=wv(9,j)                                                        colf-148
      call cori(eta,ej,si,sj,rm,xg(1,k),xi,xj,fg(1,1,i),fg(1,1,j),z,lmaxcolf-149
     11,lmax2,lm,lmax3,fg(1,1,k))                                       colf-150
   10 continue                                                          colf-151
   11 continue                                                          colf-152
      xz=10.d0/dfloat(ipi(2,1)*ipi(3,1))/wv(4,1)**2                     colf-153
      do 13 i=1,ncoll                                                   colf-154
      xg(1,i)=0.d0                                                      colf-155
      do 12 j=2,lmax2                                                   colf-156
   12 xg(j,i)=xg(j-1,i)+datan2(wv(5,i),dfloat(j-1))                     colf-157
   13 continue                                                          colf-158
      xe=wv(7,1)                                                        colf-159
      return                                                            colf-160
 1000 format (/' level       wave number  coulomb parameter   sqrt(k outcolf-161
     1/k in)   rel. enhanc.      reduced mass       step size')         colf-162
 1001 format (/' level       wave number  coulomb parameter   sqrt(k outcolf-163
     1/k in)   rel. energy        step size  ** mass =',f15.8,' **')    colf-164
 1002 format (1x,i5,6f18.10)                                            colf-165
 1003 format (' number of finite coulomb integrals reduced from',i6,' tocolf-166
     1',i6)                                                             colf-167
      end                                                               colf-168
c 29/02/04                                                      ecis03  cocl-000
      subroutine cocl(g,gd,f,fd,sigma,eta,r,l)                          cocl-001
c computation of logarithmic derivative at the matching radius of       cocl-002
c increasing and decreasing solutions with wronskian equal to unity     cocl-003
c for closed channels.                                                  cocl-004
c for negative values of eta, the logarithmic derivative of the         cocl-005
c decreasing solution is computed, the logarithmic derivative of the    cocl-006
c increasing function is assumed opposite. if a negative eta differs    cocl-007
c by less than 1/4 percent of an integer the next integer value is      cocl-008
c used (laguerre polynomial); in other cases, c backwards integration   cocl-009
c starting beyond the oscillations estimated up to 2*|eta|.             cocl-010
c                                                                       cocl-011
c input variables: eta: coulomb parameter; eta >= 0                     cocl-012
c                  r:   |k|*r value                                     cocl-013
c                  l:   maximum l value                                 cocl-014
c output variables: sigma(i)=0 for i = 1 to l+1                         cocl-015
c       f(i):  decreasing solution at (eta,rho) for i = 1 to l+1        cocl-016
c       fd(i): derivative of f(i) for i = 1 to l+1                      cocl-017
c       g(i):  increasing solution for i = 1 to l+1                     cocl-018
c       gd(i): derivative of f(i) for i = 1 to l+1                      cocl-019
c       sigma(i) retirns 0.                                             cocl-020
c the functions are renormalised to f=g and such that  f*gd-g*fd=1      cocl-021
c***********************************************************************cocl-022
      implicit real*8 (a-h,o-z)                                         cocl-023
      dimension g(1),gd(1),f(1),fd(1),sigma(1),s(7)                     cocl-024
      data gama /0.577215664901533d0/                                   cocl-025
c for l=0                                                               cocl-026
      if (eta.le.-1.d-6) go to 17                                       cocl-027
      if (eta.gt.1.d-6) go to 1                                         cocl-028
c no coulomb potential                                                  cocl-029
      fp=-1.d0                                                          cocl-030
      gp=1.d0                                                           cocl-031
      go to 14                                                          cocl-032
    1 if ((eta+1.d0)*r.gt.8.d0) go to 9                                 cocl-033
c series expansion                                                      cocl-034
      r2=-r*r                                                           cocl-035
      et2=eta+eta                                                       cocl-036
      u0=0.d0                                                           cocl-037
      u1=r                                                              cocl-038
      v0=1.d0                                                           cocl-039
      v1=0.d0                                                           cocl-040
      u=u0+u1                                                           cocl-041
      v=v0+v1                                                           cocl-042
      up=1.d0                                                           cocl-043
      vp=0.d0                                                           cocl-044
      do 3 n=2,10000                                                    cocl-045
      xn=dfloat(n)                                                      cocl-046
      xn1=xn*(xn-1.d0)                                                  cocl-047
      u2=(et2*r*u1-r2*u0)/xn1                                           cocl-048
      u=u+u2                                                            cocl-049
      v2=(et2*r*v1-r2*v0-et2*(2.d0*xn-1.d0)*u2)/xn1                     cocl-050
      v=v+v2                                                            cocl-051
      up=up+xn*u2/r                                                     cocl-052
      vp=vp+xn*v2/r                                                     cocl-053
      if (dabs(u2).gt.1.d-16*dabs(u)) go to 2                           cocl-054
      if (dabs(v2).le.1.d-16*dabs(v)) go to 4                           cocl-055
    2 u0=u1                                                             cocl-056
      u1=u2                                                             cocl-057
      v0=v1                                                             cocl-058
    3 v1=v2                                                             cocl-059
    4 xx=dabs(eta)                                                      cocl-060
      if (xx.lt.1.d-8) go to 7                                          cocl-061
      y=xx                                                              cocl-062
      k=0                                                               cocl-063
      if (xx.le.7.5d0) k=idint(8.5d0-xx)                                cocl-064
      x=1.d0+xx+dfloat(k)                                               cocl-065
      uu=1.d0/x**2                                                      cocl-066
      psr=dlog(x)-.5d0/x-uu/12.d0+uu**2/120.d0-uu**3/252.d0+uu**4/240.d0cocl-067
     1-uu**5/132.d0+uu**6*691.d0/32760.d0                               cocl-068
      if (k.eq.0) go to 6                                               cocl-069
      do 5 i=1,k                                                        cocl-070
    5 psr=psr-1.d0/(x-dfloat(i))                                        cocl-071
    6 psr=psr-.5d0/y+2.d0*gama-1.d0                                     cocl-072
      go to 8                                                           cocl-073
    7 psr=gama-1.d0                                                     cocl-074
    8 ce=et2*(psr+dlog(2.d0*r))                                         cocl-075
      fp=(vp+up*ce+et2*u/r)/(v+u*ce)                                    cocl-076
      go to 14                                                          cocl-077
    9 if (r.lt.10.d0*(eta+1.d0)) go to 11                               cocl-078
c asymptotic expansion                                                  cocl-079
      c=1.d0/r                                                          cocl-080
      a=1.d0                                                            cocl-081
      b=a                                                               cocl-082
      d=0.d0                                                            cocl-083
      do 10 m=1,26                                                      cocl-084
      am=dfloat(m)                                                      cocl-085
      a=-a*0.5d0*(eta+am-1.d0)*(eta+am)*c/am                            cocl-086
      b=b+a                                                             cocl-087
   10 d=d-a*am*c                                                        cocl-088
      fp=d/b-1.d0-eta/r                                                 cocl-089
      go to 14                                                          cocl-090
c long range integration                                                cocl-091
   11 h=dmin1(.001953125d0,.25d0*r)                                     cocl-092
      n=1+idint(10.d0/h)                                                cocl-093
      s(6)=dexp(-h)                                                     cocl-094
      s(7)=1.d0                                                         cocl-095
      v2=h**2*(1.d0+2.d0*eta/(r+h*dfloat(n)))/12.d0                     cocl-096
      v3=h**2*(1.d0+2.d0*eta/(r+h*dfloat(n-1)))/12.d0                   cocl-097
      do 13 i=n-2,-3,-1                                                 cocl-098
      do 12 j=1,6                                                       cocl-099
   12 s(j)=s(j+1)/s(7)                                                  cocl-100
      v1=v2                                                             cocl-101
      v2=v3                                                             cocl-102
      v3=h**2*(1.d0+2.d0*eta/(r+h*dfloat(i)))/12.d0                     cocl-103
   13 s(7)=(s(6)*(2.d0+10.d0*v2)-s(5)*(1.d0-v1))/(1.d0-v3)              cocl-104
      fp=((s(1)-s(7))/60.d0+.15d0*(s(6)-s(2))+.75d0*(s(3)-s(5)))/h/s(4) cocl-105
   14 xx=1.d0                                                           cocl-106
      mp=l+25+idint(5.d0*dabs(eta))                                     cocl-107
      do 15 m=mp,1,-1                                                   cocl-108
      xm=dfloat(m)                                                      cocl-109
      a=eta/xm                                                          cocl-110
      b=a+xm/r                                                          cocl-111
      xx=-(a*a-1.d0)/(b+xx)+b                                           cocl-112
      if (m.le.l) gd(m)=xx                                              cocl-113
   15 continue                                                          cocl-114
      do 16 m=1,l+1                                                     cocl-115
      x=dsqrt(dabs(gd(m)-fp))                                           cocl-116
      xm=dfloat(m)                                                      cocl-117
      f(m)=1.d0/x                                                       cocl-118
      fd(m)=fp/x                                                        cocl-119
      g(m)=1.d0/x                                                       cocl-120
      gd(m)=gd(m)/x                                                     cocl-121
      a=eta/xm                                                          cocl-122
      b=a+xm/r                                                          cocl-123
   16 fp=(a*a-1.d0)/(b-fd(m)/f(m))-b                                    cocl-124
      go to 25                                                          cocl-125
   17 lp=idint(-eta+.5d0)                                               cocl-126
      if (dabs((dfloat(lp)+eta)/eta).lt..0025d0) go to 22               cocl-127
      ll=min0(l,idint(-eta))                                            cocl-128
      rp=dmax1(-2.d0*eta-r,0.d0)                                        cocl-129
      do 20 m=0,ll                                                      cocl-130
      al=m*(m+1)                                                        cocl-131
      h=dmin1(.001953125d0,r/dfloat(4+m))                               cocl-132
      n=idint(1.d0+(40.d0+rp)/h)                                        cocl-133
      rr=r+dfloat(n)*h                                                  cocl-134
      v2=h**2*(1.d0+al/rr**2+2.d0*eta/rr)/12.d0                         cocl-135
      rr=r+dfloat(n-1)*h                                                cocl-136
      v3=h**2*(1.d0+al/rr**2+2.d0*eta/rr)/12.d0                         cocl-137
      s(6)=dexp(-h)                                                     cocl-138
      s(7)=1.d0                                                         cocl-139
      do 19 i=n-2,-3,-1                                                 cocl-140
      do 18 j=1,6                                                       cocl-141
   18 s(j)=s(j+1)/s(7)                                                  cocl-142
      v1=v2                                                             cocl-143
      v2=v3                                                             cocl-144
      rr=r+dfloat(i)*h                                                  cocl-145
      v3=h**2*(1.d0+al/rr**2+2.d0*eta/rr)/12.d0                         cocl-146
   19 s(7)=(s(6)*(2.d0+10.d0*v2)-s(5)*(1.d0-v1))/(1.d0-v3)              cocl-147
      fp=((s(1)-s(7))/60.d0+.15d0*(s(6)-s(2))+.75d0*(s(3)-s(5)))/h      cocl-148
      ff=s(4)                                                           cocl-149
      gp=1.d0                                                           cocl-150
      if (fp.ne.0.d0) gp=-fp                                            cocl-151
      gg=1.d0                                                           cocl-152
      if (ff.ne.0.d0) gg=ff                                             cocl-153
      x=dsqrt(dabs(gp*ff-gg*fp))                                        cocl-154
      f(m+1)=ff/x                                                       cocl-155
      fd(m+1)=fp/x                                                      cocl-156
      g(m+1)=gg/x                                                       cocl-157
      gd(m+1)=gp/x                                                      cocl-158
   20 continue                                                          cocl-159
      if (ll.eq.l) go to 25                                             cocl-160
      fp=fd(ll+1)/f(ll+1)                                               cocl-161
      do 21 m=ll+1,l                                                    cocl-162
      xm=dfloat(m)                                                      cocl-163
      a=eta/xm                                                          cocl-164
      b=a+xm/r                                                          cocl-165
      fp=(a*a-1.d0)/(b-fd(m)/f(m))-b                                    cocl-166
      x=dsqrt(dabs(2.d0*fp))                                            cocl-167
      f(m+1)=1.d0/x                                                     cocl-168
      fd(m+1)=fp/x                                                      cocl-169
      g(m+1)=1.d0/x                                                     cocl-170
   21 gd(m+1)=-fp/x                                                     cocl-171
      go to 25                                                          cocl-172
   22 ff=1.d0                                                           cocl-173
      fp=1.d0                                                           cocl-174
      mp=l+50-idint(5.d0*eta)                                           cocl-175
      do 24 m=mp,1,-1                                                   cocl-176
      ffm=dfloat(m)                                                     cocl-177
      a=eta/ffm                                                         cocl-178
      b=a+ffm/r                                                         cocl-179
      z=fp+b*ff                                                         cocl-180
      fp=b*z-(a*a-1.d0)*ff                                              cocl-181
      ff=z                                                              cocl-182
      if (dabs(ff).lt.1.d0) go to 23                                    cocl-183
      fp=fp/ff                                                          cocl-184
      ff=1.d0                                                           cocl-185
   23 if (m.gt.l+1) go to 24                                            cocl-186
      gp=1.d0                                                           cocl-187
      if (fp.ne.0.d0) gp=-fp                                            cocl-188
      gg=1.d0                                                           cocl-189
      if (ff.ne.0.d0) gg=ff                                             cocl-190
      x=dsqrt(dabs(gp*ff-gg*fp))                                        cocl-191
      f(m)=ff/x                                                         cocl-192
      fd(m)=fp/x                                                        cocl-193
      g(m)=gg/x                                                         cocl-194
      gd(m)=gp/x                                                        cocl-195
   24 continue                                                          cocl-196
   25 do 26 m=0,l                                                       cocl-197
   26 sigma(m+1)=0.d0                                                   cocl-198
      return                                                            cocl-199
      end                                                               cocl-200
c 29/02/04                                                      ecis03  fcou-000
      subroutine fcou(l,eta,ro,f,fp,g,gp,iexp,sigma)                    fcou-001
coulomb functions for rho > 0 and -500 < eta < 500   ex - dfcoul        fcou-002
c  for the mathematical description see chr. bardin et. al. cea-n-906   fcou-003
c  or bardin et al. comp. physics comm. vol 3 (1972) pages 73-87        fcou-004
c  numerical accuracy: at least 8 significant digits, an exception is   fcou-005
c  the region -8 < eta < -6 and ro < 125/6                              fcou-006
c the calculation of phase-shifts has been suppressed except for l=0    fcou-007
      implicit real*8 (a-h,o-z)                                         fcou-008
      dimension f(1),fp(1),g(1),gp(1),iexp(1),sigma(1)                  fcou-009
      common /inout/ mr,mw,ms                                           fcou-010
      if (ro.gt.0.d0.and.dabs(eta).le.500.d0) go to 1                   fcou-011
      write (mw,1000) eta,ro                                            fcou-012
      stop                                                              fcou-013
    1 call fcz0(eta,ro,f1,fp1,g1,gp1,iexp1,sigma1)                      fcou-014
      f(1)=f1                                                           fcou-015
      fp(1)=fp1                                                         fcou-016
      g(1)=g1                                                           fcou-017
      gp(1)=gp1                                                         fcou-018
      iexp(1)=iexp1                                                     fcou-019
      sigma(1)=sigma1                                                   fcou-020
      if (l.le.0) return                                                fcou-021
      linf=0                                                            fcou-022
      lin=1                                                             fcou-023
      ind=0                                                             fcou-024
      l1=l+1                                                            fcou-025
      etac=eta*eta                                                      fcou-026
      if ((eta.gt.0.d0.and.ro.lt.eta+eta.or.ro.lt.eta+dsqrt(etac+1.d0)))fcou-027
     1 go to 7                                                          fcou-028
      if (ro.ge.eta+dsqrt(etac+dfloat(l*(l+1)))) go to 5                fcou-029
    2 roinf=eta+dsqrt(etac+dfloat(linf*(linf+1)))                       fcou-030
      if (ro.lt.roinf) go to 3                                          fcou-031
      if (linf.ge.l) go to 4                                            fcou-032
      linf=linf+1                                                       fcou-033
      go to 2                                                           fcou-034
    3 ind=1                                                             fcou-035
    4 lin=linf+1                                                        fcou-036
    5 xm=1.d0                                                           fcou-037
      if (ind.eq.0) lin=l1                                              fcou-038
      do 6 j=2,lin                                                      fcou-039
      zig=(dsqrt(etac+xm*xm))/xm                                        fcou-040
      zag=eta/xm+xm/ro                                                  fcou-041
      f(j)=(zag*f(j-1)-fp(j-1))/zig                                     fcou-042
      fp(j)=zig*f(j-1)-zag*f(j)                                         fcou-043
      g(j)=(zag*g(j-1)-gp(j-1))/zig                                     fcou-044
      gp(j)=zig*g(j-1)-zag*g(j)                                         fcou-045
      iexp(j)=iexp(1)                                                   fcou-046
    6 xm=xm+1.d0                                                        fcou-047
      if (ind.eq.0) return                                              fcou-048
    7 ftest=f(lin)                                                      fcou-049
      fptest=fp(lin)                                                    fcou-050
      lmax=linf+25+idint(5.d0*dabs(eta))                                fcou-051
      if (lmax.lt.l) lmax=l                                             fcou-052
      fi=1.d0                                                           fcou-053
      fpi=1.d0                                                          fcou-054
    8 xm=dfloat(lmax+1)                                                 fcou-055
      zig=(dsqrt(etac+xm*xm))/xm                                        fcou-056
      zag=eta/xm+xm/ro                                                  fcou-057
      fl=(zag*fi+fpi)/zig                                               fcou-058
      fpl=zag*fl-zig*fi                                                 fcou-059
      if (dabs(fl).lt.1.d15.and.dabs(fpl).lt.1.d15) go to 9             fcou-060
      fl=fl*1.d-15                                                      fcou-061
      fpl=fpl*1.d-15                                                    fcou-062
    9 fi=fl                                                             fcou-063
      fpi=fpl                                                           fcou-064
      if (lmax.le.l) go to 11                                           fcou-065
   10 lmax=lmax-1                                                       fcou-066
      go to 8                                                           fcou-067
   11 f(lmax+1)=fl                                                      fcou-068
      fp(lmax+1)=fpl                                                    fcou-069
      if (lmax.gt.linf) go to 10                                        fcou-070
      fact=ftest/f(lin)                                                 fcou-071
      factp=fptest/fp(lin)                                              fcou-072
      indice=iexp(1)/15                                                 fcou-073
      xm=dfloat(linf)                                                   fcou-074
      do 13 j=lin,l1                                                    fcou-075
      f(j)=f(j)*fact                                                    fcou-076
      fp(j)=fp(j)*factp                                                 fcou-077
      if (j.eq.1) go to 13                                              fcou-078
      zig=(dsqrt(etac+xm*xm))/xm                                        fcou-079
      zag=eta/xm+xm/ro                                                  fcou-080
      g(j)=(zag*g(j-1)-gp(j-1))/zig                                     fcou-081
      gp(j)=zig*g(j-1)-zag*g(j)                                         fcou-082
      if (dabs(g(j)).lt.1.d15.and.dabs(gp(j)).lt.1.d15) go to 12        fcou-083
      g(j)=g(j)/1.d15                                                   fcou-084
      gp(j)=gp(j)/1.d15                                                 fcou-085
      indice=indice+1                                                   fcou-086
   12 iexp(j)=indice*15                                                 fcou-087
      a=dlog10(dabs(fp(j)))+dlog10(dabs(g(j)))                          fcou-088
      b=0.d0                                                            fcou-089
      if (a.ge.0.d0) b=1.d0                                             fcou-090
      i1=idint(b+a)                                                     fcou-091
      i2=idint(b+dlog10(dabs(gp(j)))+dlog10(dabs(f(j))))                fcou-092
      f(j)=f(j)*1.d1**(-i2)                                             fcou-093
      fp(j)=fp(j)*1.d1**(-i1)                                           fcou-094
   13 xm=xm+1.d0                                                        fcou-095
      return                                                            fcou-096
 1000 format ('  fcou   ***  eta =',1p,d13.5,',  rho =',d13.5,'   argumefcou-097
     1nt out off range')                                                fcou-098
      end                                                               fcou-099
c 29/02/04                                                      ecis03  fcz0-000
      subroutine fcz0(eta,ro,f0,fp0,g0,gp0,iexp,sigma)                  fcz0-001
c the lower limit of riccati method for positive eta has been changed   fcz0-002
c from 30. to 28. to avoid an overflow in the normalisation             fcz0-003
      implicit real*8 (a-h,o-z)                                         fcz0-004
      sigma=sigm(eta)                                                   fcz0-005
      iexp=0                                                            fcz0-006
      if (eta.le.28.d0.and.eta.ge.-8.d0) go to 1                        fcz0-007
      call yfri(eta,ro,f0,fp0,g0,gp0,iexp,sigma)                        fcz0-008
      return                                                            fcz0-009
    1 if (eta.ne.0.d0) go to 2                                          fcz0-010
      f0=dsin(ro)                                                       fcz0-011
      g0=dcos(ro)                                                       fcz0-012
      fp0=g0                                                            fcz0-013
      gp0=-f0                                                           fcz0-014
      return                                                            fcz0-015
    2 borne=1.666666666666667d0*dabs(eta)+7.5d0                         fcz0-016
      if (ro.lt.borne) go to 3                                          fcz0-017
      call yfas(eta,ro,f0,fp0,g0,gp0,sigma)                             fcz0-018
      return                                                            fcz0-019
    3 if (eta.ge.10.d0) go to 4                                         fcz0-020
      if (eta.le.0.d0) go to 5                                          fcz0-021
      if (ro-2.d0) 15 , 5 , 5                                           fcz0-022
    4 if (eta.gt.(5.d0*ro+6.d1)/7.d0) go to 15                          fcz0-023
c rs=-1 for normalisation at the origin,rs=1 a ro=end                   fcz0-024
    5 if (eta.lt.2.5) go to 6                                           fcz0-025
      rs=1.d0                                                           fcz0-026
      call yfas(eta,borne,f0,fp0,g0,gp0,sigma)                          fcz0-027
      go to 8                                                           fcz0-028
    6 rs=-1.d0                                                          fcz0-029
c          clenshaw at the origin                                       fcz0-030
      if (eta) 7,8,8                                                    fcz0-031
    7 n=idint(-0.5d0*eta+5.d0)                                          fcz0-032
      go to 9                                                           fcz0-033
    8 n=idint(eta/5.d0+5.d0)                                            fcz0-034
    9 n=10*(n/2+1)                                                      fcz0-035
      tm1=1.d0                                                          fcz0-036
      t=2.d0*ro/borne-1.d0                                              fcz0-037
      x=t+t                                                             fcz0-038
      do 10 i=1,n                                                       fcz0-039
      tp1=x*t-tm1                                                       fcz0-040
      tm1=t                                                             fcz0-041
   10 t=tp1                                                             fcz0-042
      t=tm1                                                             fcz0-043
      a1=1.d-30                                                         fcz0-044
      a2=0.d0                                                           fcz0-045
      b1=0.d0                                                           fcz0-046
      b2=a1                                                             fcz0-047
      s=1.d0                                                            fcz0-048
      sa=0.d0                                                           fcz0-049
      sb=0.d0                                                           fcz0-050
      z1=0.d0                                                           fcz0-051
      z1p=0.d0                                                          fcz0-052
      ap12=0.d0                                                         fcz0-053
      ap11=0.d0                                                         fcz0-054
      bp11=0.d0                                                         fcz0-055
      z2=0.d0                                                           fcz0-056
      z2p=0.d0                                                          fcz0-057
      ap22=0.d0                                                         fcz0-058
      ap21=0.d0                                                         fcz0-059
      bp21=0.d0                                                         fcz0-060
      a0=8.d0*eta/borne-1.d0                                            fcz0-061
      bd=4.d0/(borne*borne)                                             fcz0-062
      b0=bd*dfloat(n+2)                                                 fcz0-063
      b4=bd*dfloat(n-1)                                                 fcz0-064
      r4=4.d0*dfloat(n)                                                 fcz0-065
c          backwards recurrence                                         fcz0-066
   11 am11=a0*(a1-ap11)+ap12-b0*b1-b4*bp11                              fcz0-067
      am21=a0*(a2-ap21)+ap22-b0*b2-b4*bp21                              fcz0-068
      sa=sa+s*a1                                                        fcz0-069
      sb=sb+s*a2                                                        fcz0-070
      z1=z1+a1*t                                                        fcz0-071
      z1p=z1p+b1*t                                                      fcz0-072
      z2=z2+a2*t                                                        fcz0-073
      z2p=z2p+b2*t                                                      fcz0-074
      if (r4.eq.0.d0) go to 12                                          fcz0-075
      bm11=r4*a1+bp11                                                   fcz0-076
      ap12=ap11                                                         fcz0-077
      ap11=a1                                                           fcz0-078
      a1=am11                                                           fcz0-079
      bp11=b1                                                           fcz0-080
      b1=bm11                                                           fcz0-081
      bm21=r4*a2+bp21                                                   fcz0-082
      ap22=ap21                                                         fcz0-083
      ap21=a2                                                           fcz0-084
      a2=am21                                                           fcz0-085
      bp21=b2                                                           fcz0-086
      b2=bm21                                                           fcz0-087
      b4=b4-bd                                                          fcz0-088
      b0=b0-bd                                                          fcz0-089
      r4=r4-4.d0                                                        fcz0-090
      s=s*rs                                                            fcz0-091
      tm1=x*t-tp1                                                       fcz0-092
      tp1=t                                                             fcz0-093
      t=tm1                                                             fcz0-094
      go to 11                                                          fcz0-095
   12 a=ap21-am21                                                       fcz0-096
      b=am11-ap11                                                       fcz0-097
      sa=a*sa+b*sb                                                      fcz0-098
      a1=a*a1+b*a2                                                      fcz0-099
      b1=a*b1+b*b2                                                      fcz0-100
      z1=a*z1+b*z2                                                      fcz0-101
      z1p=a*z1p+b*z2p                                                   fcz0-102
      sa=(sa-0.5d0*a1)/t                                                fcz0-103
      z1=z1-0.5d0*a1                                                    fcz0-104
      z1p=z1p-0.5d0*b1                                                  fcz0-105
      if (rs.lt.0.d0) go to 13                                          fcz0-106
      s=f0/(borne*sa)                                                   fcz0-107
      go to 14                                                          fcz0-108
   13 pieta=3.141592653589793d0*eta                                     fcz0-109
      s=dexp(pieta)                                                     fcz0-110
      s=dexp(-pieta/2.d0)*dsqrt(2.d0*pieta/(s-1.d0/s))/sa               fcz0-111
   14 f0=s*ro*z1                                                        fcz0-112
      fp0=s*(z1+ro*z1p/borne)                                           fcz0-113
      go to 18                                                          fcz0-114
c   regular series at the origin                                        fcz0-115
   15 pi=3.141592653589793d0                                            fcz0-116
      ro2=ro*ro                                                         fcz0-117
      etap=eta+eta                                                      fcz0-118
      pieta=pi*eta                                                      fcz0-119
      b=dexp(pieta)                                                     fcz0-120
      b=dexp(0.5d0*pieta)*dsqrt((b-1.d0/b)/(2.d0*pieta))                fcz0-121
      u0=0.d0                                                           fcz0-122
      u1=ro                                                             fcz0-123
      u=u0+u1                                                           fcz0-124
      up=1.d0                                                           fcz0-125
      xn=2.d0                                                           fcz0-126
      do 16 n=2,10000                                                   fcz0-127
      xn1=xn*(xn-1.d0)                                                  fcz0-128
      u2=(etap*ro*u1-ro2*u0)/xn1                                        fcz0-129
      u=u+u2                                                            fcz0-130
      up=up+xn*u2/ro                                                    fcz0-131
      if (dabs(u1)+dabs(u2).lt.1.d-10*dabs(u)) go to 17                 fcz0-132
      u0=u1                                                             fcz0-133
      u1=u2                                                             fcz0-134
   16 xn=xn+1.d0                                                        fcz0-135
   17 f0=u/b                                                            fcz0-136
      fp0=up/b                                                          fcz0-137
   18 call yfir(eta,ro,g0,gp0,sigma)                                    fcz0-138
      return                                                            fcz0-139
      end                                                               fcz0-140
c 29/02/04                                                      ecis03  yfri-000
      subroutine yfri(eta,rau,fo,fpo,go,gpo,idiv,sigma)                 yfri-001
      implicit real*8 (a-h,o-z)                                         yfri-002
      dimension q(5),qp(5)                                              yfri-003
c        coefficients riccati                                           yfri-004
      data g61,g62,g63,g64,g65,g66,g67,g68,g69,g610,g611/ 1.159057617187yfri-005
     15d-2,3.863525390625d-2,4.6600341796875d-2,4.8583984375d-2,1.156514yfri-006
     248567708d0,5.6874755859375d0,1.323888288225445d1,1.713083224826384yfri-007
     3d1,1.269003295898436d1,5.05523681640625d0,8.42539464010415d-1/    yfri-008
      data g81,g82,g83,g84,g85,g86,g87,g88,g89,g810,g811,g812,g813,g814,yfri-009
     1g815/ 1.851092066083633d-2,8.63842964172363d-2,1.564757823944092d-yfri-010
     21,1.430139541625977d-1,1.924622058868408d-1,8.500803152720129d0,7.yfri-011
     3265429720878595d1,3.057942376817972d2,7.699689544836672d2,1.254157yfri-012
     4054424285d3,1.361719536066055d3,9.831831171035763d2,4.547869927883yfri-013
     5148d2,1.222640538215636d2,1.455524450256709d1/                    yfri-014
      data gp61,gp62,gp63,gp64,gp65,gp66/ 0.289764404296875d-1,0.2318115yfri-015
     1234375d0,0.8056640625d0,1.6015625d0,0.3046875d0,5.625d0/          yfri-016
      data gp81,gp82,gp83,gp84,gp85,gp86,gp87,gp88/ 0.647882223129272d-1yfri-017
     1,0.6910743713378906d0,0.3322952270507811d1,0.94830322265625d1,17.6yfri-018
     296533203125d0,34.787109375d0,50.203125d0,78.75d0/                 yfri-019
      data q/ 0.4959570165d-1,0.8888888889d-2,0.2455199181d-2,0.91089580yfri-020
     161d-3,0.2534684115d-3/                                            yfri-021
      data qp,ho,hpo/ 0.1728260369d0,0.3174603174d-3,0.3581214850d-2,0.3yfri-022
     1117824680d-3,0.9073966427d-3,2*0.d0/                              yfri-023
      etac=eta*eta                                                      yfri-024
      eta2=eta+eta                                                      yfri-025
      etaro=eta*rau                                                     yfri-026
      ind=0                                                             yfri-027
      jnd=0                                                             yfri-028
      ig=0                                                              yfri-029
      idiv=0                                                            yfri-030
      if (eta.gt.0.d0) go to 1                                          yfri-031
      if (-etaro-14.0625d0) 3 , 15 , 15                                 yfri-032
    1 if (dabs(rau-eta2).le.1.d-9) go to 14                             yfri-033
      if (rau-eta2) 6 , 14 , 2                                          yfri-034
    2 if (rau-eta2-2.d1*(eta**0.25d0)) 4 , 15 , 15                      yfri-035
    3 nn=1                                                              yfri-036
      go to 5                                                           yfri-037
    4 nn=0                                                              yfri-038
    5 call yfcl(eta,rau,fo,fpo,go,gpo,sigma,idiv,nn)                    yfri-039
      return                                                            yfri-040
    6 if (etaro.le.12.d0) go to 3                                       yfri-041
      tra=eta2-6.75d0*(eta**0.4d0)                                      yfri-042
      if (rau.le.tra) go to 7                                           yfri-043
      ind=1                                                             yfri-044
      jnd=1                                                             yfri-045
      ro=rau                                                            yfri-046
      rau=tra                                                           yfri-047
      rau0=tra                                                          yfri-048
c             riccati   1                                               yfri-049
    7 x=rau/eta2                                                        yfri-050
      u=(1.d0-x)/x                                                      yfri-051
      x2=x*x                                                            yfri-052
      ru=dsqrt(u)                                                       yfri-053
      rx=dsqrt(x)                                                       yfri-054
      tre=1.d0/(u*ru*eta2)                                              yfri-055
      trb=tre*tre                                                       yfri-056
      fi=(dsqrt((1.d0-x)*x)+datan2(rx,dsqrt(1.d0-rx*rx))-1.5707963267948yfri-057
     197d0)*eta2                                                        yfri-058
      tr1=-0.25d0*dlog(u)                                               yfri-059
      tr2=-((9.d0*u+6.d0)*u+5.d0)/48.d0                                 yfri-060
      tr3=((((-3.d0*u-4.d0)*u+6.d0)*u+12.d0)*u+5.d0)/64.d0              yfri-061
      tr4=-((((((u+2.d0)*945.d0*u+1395.d0)*u+12300.d0)*u+25191.d0)*u+198yfri-062
     190.d0)*u+5525.d0)/46080.d0                                        yfri-063
      tr5=((((((((-27.d0*u-72.d0)*u-68.d0)*u+360.d0)*u+2190.d0)*u+4808.dyfri-064
     10)*u+5148.d0)*u+2712.d0)*u+565.d0)/2048.d0                        yfri-065
      tr6=-((((((((((g61*u+g62)*u+g63)*u+g64)*u+g65)*u+g66)*u+g67)*u+g68yfri-066
     1)*u+g69)*u+g610)*u+g611)                                          yfri-067
      tr7=((((((((((((-81.d0*u-324.d0)*u-486.d0)*u-404.d0)*u+4509.d0)*u+yfri-068
     152344.d0)*u+233436.d0)*u+567864.d0)*u+838521.d0)*u+775884.d0)*u+44yfri-069
     21450.d0)*u+141660.d0)*u+19675.d0)/6144.d0                         yfri-070
      tr8=(((((((((((((g81*u+g82)*u+g83)*u+g84)*u+g85)*u+g86)*u+g87)*u+gyfri-071
     188)*u+g89)*u+g810)*u+g811)*u+g812)*u+g813)*u+g814)*u+g815         yfri-072
      fi=fi+tre*(tr2+trb*(tr4+trb*(tr6+trb*tr8)))                       yfri-073
      psi=-fi                                                           yfri-074
      tra=tr1+trb*(tr3+trb*(tr5+trb*tr7))                               yfri-075
      fi=fi+tra                                                         yfri-076
      psi=psi+tra                                                       yfri-077
      fip=ru*eta2                                                       yfri-078
      tra=1.d0/(x2*u)                                                   yfri-079
      tr1=0.25d0                                                        yfri-080
      tre=tre/(x2*x2*u)                                                 yfri-081
      trb=trb/(x2*x2)                                                   yfri-082
      tr2=-(8.d0*x-3.d0)/32.d0                                          yfri-083
      tr3=((24.d0*x-12.d0)*x+3.d0)/64.d0                                yfri-084
      tr4=(((-1536.d0*x+704.d0)*x-336.d0)*x+63.d0)/2048.d0              yfri-085
      tr5=((((1920.d0*x-576.d0)*x+504.d0)*x-180.d0)*x+27.d0)/1024.d0    yfri-086
      tr6=((((-gp66*x+gp65)*x-gp64)*x+gp63)*x-gp62)*x+gp61              yfri-087
      tr7=-((((((-40320.d0*x-10560.d0)*x-13248.d0)*x+7560.d0)*x-3132.d0)yfri-088
     1*x+756.d0)*x-81.d0)/2048.d0                                       yfri-089
      tr8=-(((((((gp88*x+gp87)*x+gp86)*x-gp85)*x+gp84)*x-gp83)*x+gp82)*xyfri-090
     1-gp81)                                                            yfri-091
      fip=fip+tre*(tr2+trb*(tr4+trb*(tr6+trb*tr8)))                     yfri-092
      psip=-fip                                                         yfri-093
      tra=tra*(tr1+trb*(tr3+trb*(tr5+trb*tr7)))                         yfri-094
      fip=fip+tra                                                       yfri-095
      psip=psip+tra                                                     yfri-096
      xxx=34.588776394910686d0                                          yfri-097
      indg=idint(psi/xxx)                                               yfri-098
      idiv=15*indg                                                      yfri-099
      if (indg.eq.0) go to 8                                            yfri-100
      psi=psi-xxx*indg                                                  yfri-101
      fi=fi+xxx*indg                                                    yfri-102
    8 fo=0.5d0*dexp(fi)                                                 yfri-103
      go=dexp(psi)                                                      yfri-104
      fpo=fo*fip/eta2                                                   yfri-105
      gpo=go*psip/eta2                                                  yfri-106
      if (jnd.eq.0) return                                              yfri-107
      rau=ro                                                            yfri-108
      go=fo                                                             yfri-109
      gpo=fpo                                                           yfri-110
    9 x=rau0-ro                                                         yfri-111
      x2=x*x                                                            yfri-112
      x3=x*x2                                                           yfri-113
      unr=1.d0/rau0                                                     yfri-114
      etr0=1.d0-2.d0*eta*unr                                            yfri-115
      u0=go                                                             yfri-116
      u1=-x*gpo                                                         yfri-117
      u2=-0.5d0*etr0*x2*u0                                              yfri-118
      s=u0+u1+u2                                                        yfri-119
      v1=u1/x                                                           yfri-120
      v2=2.d0*u2/x                                                      yfri-121
      t=v1+v2                                                           yfri-122
      xn=3.d0                                                           yfri-123
      do 11 n=3,10000                                                   yfri-124
      xn1=xn-1.d0                                                       yfri-125
      xn1=xn*xn1                                                        yfri-126
      u3=x*u2*unr*(1.d0-2.d0/xn)-etr0*u1*x2/xn1+x3*u0*unr/xn1           yfri-127
      s=s+u3                                                            yfri-128
      v3=xn*u3/x                                                        yfri-129
      t=t+v3                                                            yfri-130
      if (dabs(u3).gt.1.d-10*dabs(s)) go to 10                          yfri-131
      if (dabs(v3).le.1.d-10*dabs(t)) go to 12                          yfri-132
   10 u0=u1                                                             yfri-133
      u1=u2                                                             yfri-134
      u2=u3                                                             yfri-135
   11 xn=xn+1.d0                                                        yfri-136
   12 if (ig.eq.0) go to 13                                             yfri-137
      go=s                                                              yfri-138
      gpo=-t                                                            yfri-139
      fo=ho                                                             yfri-140
      fpo=hpo                                                           yfri-141
      return                                                            yfri-142
   13 ho=s                                                              yfri-143
      hpo=-t                                                            yfri-144
   14 et0=eta**(0.1666666666666667d0)                                   yfri-145
      etad=etac*etac                                                    yfri-146
      et=eta**(0.6666666666666667d0)                                    yfri-147
      et1=et*et                                                         yfri-148
      et2=et1*et1                                                       yfri-149
      et3=et2*et                                                        yfri-150
      et4=etad*et                                                       yfri-151
      et5=et4*et                                                        yfri-152
      fo=1.d0-q(1)/et1-q(2)/etac-q(3)/et3-q(4)/etad-q(5)/et5            yfri-153
      go=1.d0+q(1)/et1-q(2)/etac+q(3)/et3-q(4)/etad+q(5)/et5            yfri-154
      fpo=1.d0+qp(1)/et+qp(2)/etac+qp(3)/et2+qp(4)/etad+qp(5)/et4       yfri-155
      gpo=1.d0-qp(1)/et+qp(2)/etac-qp(3)/et2+qp(4)/etad-qp(5)/et4       yfri-156
      fo=0.7063326373d0*et0*fo                                          yfri-157
      go=1.223404016d0*et0*go                                           yfri-158
      fpo=0.4086957323d0*fpo/et0                                        yfri-159
      gpo=-0.7078817734d0*gpo/et0                                       yfri-160
      idiv=0                                                            yfri-161
      if (ind.eq.0) return                                              yfri-162
      ig=1                                                              yfri-163
      rau0=eta2                                                         yfri-164
      go to 9                                                           yfri-165
c        riccati 2 et 3                                                 yfri-166
   15 x=eta2/rau                                                        yfri-167
      x2=x*x                                                            yfri-168
      u=1.d0-x                                                          yfri-169
      ru=dsqrt(u)                                                       yfri-170
      u3=u*u*u                                                          yfri-171
      trd=1.d0/(u3*eta2*eta2)                                           yfri-172
      trc=x2*trd                                                        yfri-173
      tre=1.d0/(u*ru*eta2)                                              yfri-174
      fi=-0.25d0*dlog(u)                                                yfri-175
      trb=trd/64.d0                                                     yfri-176
      tr3=(((3.d0*u-4.d0)*u-6.d0)*u+12.d0)*u-5.d0                       yfri-177
      tr5=((((((((-27.d0*u+72.d0)*u-68.d0)*u-360.d0)*u+2190.d0)*u-4808.dyfri-178
     10)*u+5148.d0)*u-2712.d0)*u+565.d0)/32.d0                          yfri-179
      tr7=((((((((((((81.d0*u-324.d0)*u+486.d0)*u-404.d0)*u-4509.d0)*u+5yfri-180
     12344.d0)*u-233436.d0)*u+567864.d0)*u-838521.d0)*u+775884.d0)*u-441yfri-181
     2450.d0)*u+141660.d0)*u-19675.d0)/96.d0                            yfri-182
      fi=fi+trb*(tr3+trd*(tr5+trd*tr7))                                 yfri-183
      fip=0.25d0/u                                                      yfri-184
      trb=3.d0*trc/(64.d0*u)                                            yfri-185
      tr3=(4.d0-x)*x-8.d0                                               yfri-186
      tr5=((((9.d0*x-60.d0)*x+168.d0)*x-192.d0)*x+640.d0)/16.d0         yfri-187
      tr7=((((((-27.d0*x+252.d0)*x-1044.d0)*x+2520.d0)*x-4416.d0)*x-3520yfri-188
     1.d0)*x-13440.d0)/32.d0                                            yfri-189
      fip=fip+trb*(tr3+trc*(tr5+trc*tr7))                               yfri-190
      tra=dabs((ru-1.d0)/(ru+1.d0))                                     yfri-191
      psi=(0.5d0*dlog(tra)+ru/x)*eta2+0.785398163397448d0               yfri-192
      tr2=-((9.d0*u-6.d0)*u+5.d0)/48.d0                                 yfri-193
      tr4=((((((u-2.d0)*945.d0*u+1395.d0)*u-12300.d0)*u+25191.d0)*u-1989yfri-194
     10.d0)*u+5525.d0)/46080.d0                                         yfri-195
      tr6=(((((((((-g61*u+g62)*u-g63)*u+g64)*u-g65)*u+g66)*u-g67)*u+g68)yfri-196
     1*u-g69)*u+g610)*u-g611                                            yfri-197
      tr8=(((((((((((((g81*u-g82)*u+g83)*u-g84)*u+g85)*u-g86)*u+g87)*u-gyfri-198
     188)*u+g89)*u-g810)*u+g811)*u-g812)*u+g813)*u-g814)*u+g815         yfri-199
      psi=psi+tre*(tr2+trd*(tr4+trd*(tr6+trd*tr8)))                     yfri-200
      psip=-ru*eta2/x2                                                  yfri-201
      trb=tre*x/u                                                       yfri-202
      tr2=(3.d0*x-8.d0)/32.d0                                           yfri-203
      tr4=-(((63.d0*x-336.d0)*x+704.d0)*x-1536.d0)/2048.d0              yfri-204
      tr6=((((gp61*x-gp62)*x+gp63)*x-gp64)*x+gp65)*x-gp66               yfri-205
      tr8=((((((-gp81*x+gp82)*x-gp83)*x+gp84)*x-gp85)*x+gp86)*x+gp87)*x+yfri-206
     1gp88                                                              yfri-207
      psip=psip+trb*(tr2+trc*(tr4+trc*(tr6+trc*tr8)))                   yfri-208
      tra=dexp(fi)                                                      yfri-209
      fo=tra*dsin(psi)                                                  yfri-210
      go=tra*dcos(psi)                                                  yfri-211
      if (eta.gt.0.d0) go to 16                                         yfri-212
      tra=fo                                                            yfri-213
      fo=-go                                                            yfri-214
      go=tra                                                            yfri-215
   16 tra=-eta2/(rau*rau)                                               yfri-216
      fpo=(fip*fo+psip*go)*tra                                          yfri-217
      gpo=(fip*go-psip*fo)*tra                                          yfri-218
      return                                                            yfri-219
      end                                                               yfri-220
c 29/02/04                                                      ecis03  yfcl-000
      subroutine yfcl(eta,ro,u,up,v,vp,sigma,idiv,nn)                   yfcl-001
      implicit real*8 (a-h,o-z)                                         yfcl-002
      idiv=0                                                            yfcl-003
      etap=eta+eta                                                      yfcl-004
      ro2=ro*ro                                                         yfcl-005
      if (nn.eq.1) go to 4                                              yfcl-006
c          clenshaw asymptotic                                          yfcl-007
      e2=eta*eta                                                        yfcl-008
      m=idint(40.d0+eta/4.d0)                                           yfcl-009
      m=2*(m/2)                                                         yfcl-010
      i=1                                                               yfcl-011
      r=dfloat(m)                                                       yfcl-012
      d4=4.d0*r                                                         yfcl-013
      tm1=1.d0                                                          yfcl-014
      t=4.d0*eta/ro-1.d0                                                yfcl-015
      z=t+t                                                             yfcl-016
      do 1 j=1,m                                                        yfcl-017
      tp1=z*t-tm1                                                       yfcl-018
      tm1=t                                                             yfcl-019
    1 t=tp1                                                             yfcl-020
      t=tm1                                                             yfcl-021
      gr=0.d0                                                           yfcl-022
      gpr=0.d0                                                          yfcl-023
      scr=0.d0                                                          yfcl-024
      ep1r=0.d0                                                         yfcl-025
      er=0.d0                                                           yfcl-026
      dp1r=0.d0                                                         yfcl-027
      dr=1.d-25                                                         yfcl-028
      c1r=r+1.d0                                                        yfcl-029
      c0r=e2-r*(r+1.d0)                                                 yfcl-030
      gi=0.d0                                                           yfcl-031
      gpi=0.d0                                                          yfcl-032
      sci=0.d0                                                          yfcl-033
      ep1i=0.d0                                                         yfcl-034
      ei=0.d0                                                           yfcl-035
      dp1i=0.d0                                                         yfcl-036
      di=0.d0                                                           yfcl-037
      c1i=-3.d0*eta                                                     yfcl-038
      c0i=-(r+r+1.d0)*eta                                               yfcl-039
c          backwards recurrence                                         yfcl-040
    2 scz=c0r*c0r+c0i*c0i                                               yfcl-041
      c2r=c1r*dr-c1i*di+0.5d0*(dp1r+er+ep1r)-eta*dp1i                   yfcl-042
      c2i=c1r*di+c1i*dr+0.5d0*(dp1i+ei+ep1i)+eta*dp1r                   yfcl-043
      cr=(c2r*c0r+c2i*c0i)/scz                                          yfcl-044
      ci=(c0r*c2i-c0i*c2r)/scz                                          yfcl-045
      gr=gr+cr*t                                                        yfcl-046
      gpr=gpr+dr*t                                                      yfcl-047
      scr=scr+i*cr                                                      yfcl-048
      gi=gi+ci*t                                                        yfcl-049
      gpi=gpi+di*t                                                      yfcl-050
      sci=sci+i*ci                                                      yfcl-051
      if (r.eq.0.d0) go to 3                                            yfcl-052
      em1r=d4*dr+ep1r                                                   yfcl-053
      dm1r=d4*cr+dp1r                                                   yfcl-054
      ep1r=er                                                           yfcl-055
      er=em1r                                                           yfcl-056
      dp1r=dr                                                           yfcl-057
      dr=dm1r                                                           yfcl-058
      em1i=d4*di+ep1i                                                   yfcl-059
      dm1i=d4*ci+dp1i                                                   yfcl-060
      ep1i=ei                                                           yfcl-061
      ei=em1i                                                           yfcl-062
      dp1i=di                                                           yfcl-063
      di=dm1i                                                           yfcl-064
      tm1=z*t-tp1                                                       yfcl-065
      tp1=t                                                             yfcl-066
      t=tm1                                                             yfcl-067
      c0r=c0r+r+r                                                       yfcl-068
      c0i=c0i+etap                                                      yfcl-069
      c1r=c1r-1.d0                                                      yfcl-070
      i=-i                                                              yfcl-071
      d4=d4-4.d0                                                        yfcl-072
      r=r-1.d0                                                          yfcl-073
      go to 2                                                           yfcl-074
    3 scr=scr-0.5d0*cr                                                  yfcl-075
      gr=gr-0.5d0*cr                                                    yfcl-076
      gpr=gpr-0.5d0*dr                                                  yfcl-077
      sci=sci-0.5d0*ci                                                  yfcl-078
      gi=gi-0.5d0*ci                                                    yfcl-079
      gpi=gpi-0.5d0*di                                                  yfcl-080
      z=sigma+ro-eta*dlog(ro+ro)                                        yfcl-081
      scz=scr*scr+sci*sci                                               yfcl-082
      cr=dcos(z)                                                        yfcl-083
      ci=dsin(z)                                                        yfcl-084
      dr=(cr*scr+ci*sci)/scz                                            yfcl-085
      di=(ci*scr-cr*sci)/scz                                            yfcl-086
      sci=1.d0-eta/ro                                                   yfcl-087
      scr=etap/ro2                                                      yfcl-088
      cr=-gi*sci-gpr*scr                                                yfcl-089
      ci=gr*sci-gpi*scr                                                 yfcl-090
      vp=dr*cr-di*ci                                                    yfcl-091
      up=dr*ci+di*cr                                                    yfcl-092
      v=dr*gr-di*gi                                                     yfcl-093
      u=dr*gi+di*gr                                                     yfcl-094
      return                                                            yfcl-095
c          series at the origin                                         yfcl-096
    4 pi=3.141592653589793d0                                            yfcl-097
      pieta=pi*eta                                                      yfcl-098
      if (dabs(pieta).gt.36.d0) go to 5                                 yfcl-099
      p=dsqrt((dexp(2.d0*pieta)-1.d0)/(2.d0*pieta))                     yfcl-100
      go to 7                                                           yfcl-101
    5 if (pieta.gt.0.d0) go to 6                                        yfcl-102
      p=1.d0/dsqrt(-pieta-pieta)                                        yfcl-103
      go to 7                                                           yfcl-104
    6 z=34.588776394910686d0                                            yfcl-105
      idiv=idint(pieta/z)                                               yfcl-106
      p=dexp(pieta-idiv*z)/dsqrt(pieta+pieta)                           yfcl-107
      idiv=15*idiv                                                      yfcl-108
    7 z1=etap*(psi(eta)+.6931471805599453d0)                            yfcl-109
      u0=0.d0                                                           yfcl-110
      u1=ro                                                             yfcl-111
      v0=1.d0                                                           yfcl-112
      v1=z1*ro                                                          yfcl-113
      u=u0+u1                                                           yfcl-114
      v=v0+v1                                                           yfcl-115
      up=1.d0                                                           yfcl-116
      vp=z1                                                             yfcl-117
      xn=2.d0                                                           yfcl-118
      do 9 n=2,10000                                                    yfcl-119
      xn1=xn*(xn-1.d0)                                                  yfcl-120
      u2=(etap*ro*u1-ro2*u0)/xn1                                        yfcl-121
      u=u+u2                                                            yfcl-122
      v2=(etap*ro*v1-ro2*v0-etap*(xn+xn-1.d0)*u2)/xn1                   yfcl-123
      v=v+v2                                                            yfcl-124
      up=up+xn*u2/ro                                                    yfcl-125
      vp=vp+xn*v2/ro                                                    yfcl-126
      if (dabs(u2).gt.1.d-14*dabs(u)) go to 8                           yfcl-127
      if (dabs(v2).le.1.d-14*dabs(v)) go to 10                          yfcl-128
    8 u0=u1                                                             yfcl-129
      u1=u2                                                             yfcl-130
      v0=v1                                                             yfcl-131
      v1=v2                                                             yfcl-132
    9 xn=xn+1.d0                                                        yfcl-133
   10 pp=v+etap*u*dlog(ro)                                              yfcl-134
      w=u/p                                                             yfcl-135
      wp=up/p                                                           yfcl-136
      v=p*pp                                                            yfcl-137
      vp=p*(vp+etap*(up*dlog(ro)+u/ro))                                 yfcl-138
      u=w                                                               yfcl-139
      up=wp                                                             yfcl-140
      return                                                            yfcl-141
      end                                                               yfcl-142
c 29/02/04                                                      ecis03  yfas-000
      subroutine yfas(eta,rau,fo,fpo,go,gpo,sigo)                       yfas-001
      implicit real*8 (a-h,o-z)                                         yfas-002
c          asymptotic expansions                                        yfas-003
      trb=0.d0                                                          yfas-004
      rau2=rau+rau                                                      yfas-005
      etac=eta*eta                                                      yfas-006
      n=0                                                               yfas-007
      ps=1.d0                                                           yfas-008
      gs=0.d0                                                           yfas-009
      pt=0.d0                                                           yfas-010
      gt=1.d0-eta/rau                                                   yfas-011
      sf=ps                                                             yfas-012
      sg=gs                                                             yfas-013
      spf=pt                                                            yfas-014
      spg=gt                                                            yfas-015
    1 denom=dfloat(n+1)*rau2                                            yfas-016
      an=dfloat(n+n+1)*eta/denom                                        yfas-017
      bn=(etac-dfloat(n*(n+1)))/denom                                   yfas-018
      ps1=an*ps-bn*pt                                                   yfas-019
      gs1=an*gs-bn*gt-ps1/rau                                           yfas-020
      pt1=an*pt+bn*ps                                                   yfas-021
      gt1=an*gt+bn*gs-pt1/rau                                           yfas-022
      sf=sf+ps1                                                         yfas-023
      sg=sg+gs1                                                         yfas-024
      spf=spf+pt1                                                       yfas-025
      spg=spg+gt1                                                       yfas-026
      n=n+1                                                             yfas-027
      if (dabs(ps1).gt.trb) trb=dabs(ps1)                               yfas-028
      if (dabs(ps1).lt.1.d-10*trb.or.bn.lt.-1.d0) go to 2               yfas-029
      ps=ps1                                                            yfas-030
      gs=gs1                                                            yfas-031
      pt=pt1                                                            yfas-032
      gt=gt1                                                            yfas-033
      go to 1                                                           yfas-034
    2 tetao=rau-eta*dlog(rau2)+sigo                                     yfas-035
      tra=dsin(tetao)                                                   yfas-036
      trb=dcos(tetao)                                                   yfas-037
      go=sf*trb-spf*tra                                                 yfas-038
      gpo=sg*trb-spg*tra                                                yfas-039
      fo=spf*trb+sf*tra                                                 yfas-040
      fpo=spg*trb+sg*tra                                                yfas-041
      return                                                            yfas-042
      end                                                               yfas-043
c 29/02/04                                                      ecis03  yfir-000
      subroutine yfir(eta,ro,g0,gp0,sigma)                              yfir-001
c  irregular coulomb function                                           yfir-002
      implicit real*8(a-h,o-z)                                          yfir-003
      if (eta.le.0.d0) go to 9                                          yfir-004
      if ((ro.le.(54.d0-eta)/80.d0).or.(eta.le.22.d0.and.ro.le.(30.d0-etyfir-005
     1a)/20.d0).or.(eta.le.18.d0.and.ro.le.0.075d0*(26.d0-eta)).or.(eta.yfir-006
     2le.10.d0.and.ro.le..15d0*(18.d0-eta)).or.(eta.le.3.d0.and.ro.le.2.yfir-007
     325d0+7.35d0*(3.d0-eta))) go to 5                                  yfir-008
c   taylor series starting from rau0                                    yfir-009
    1 rau0=1.666666666666667d0*dabs(eta)+7.5d0                          yfir-010
      call yfas(eta,rau0,f0,fp0,g0,gp0,sigma)                           yfir-011
      x=rau0-ro                                                         yfir-012
      x2=x*x                                                            yfir-013
      x3=x*x2                                                           yfir-014
      unr=1.d0/rau0                                                     yfir-015
      etr0=1.d0-2.d0*eta*unr                                            yfir-016
      u0=g0                                                             yfir-017
      u1=-x*gp0                                                         yfir-018
      u2=-0.5d0*etr0*x2*u0                                              yfir-019
      s=u0+u1+u2                                                        yfir-020
      v1=u1/x                                                           yfir-021
      v2=2.d0*u2/x                                                      yfir-022
      t=v1+v2                                                           yfir-023
      xn=3.d0                                                           yfir-024
      do 3 n=3,10000                                                    yfir-025
      xn1=xn-1.d0                                                       yfir-026
      xn1=xn*xn1                                                        yfir-027
      u3=x*u2*unr*(1.d0-2.d0/xn)-etr0*u1*x2/xn1+x3*u0*unr/xn1           yfir-028
      s=s+u3                                                            yfir-029
      v3=xn*u3/x                                                        yfir-030
      t=t+v3                                                            yfir-031
      if (dabs(u3).gt.1.d-11*dabs(s)) go to 2                           yfir-032
      if (dabs(v3).le.1.d-11*dabs(t)) go to 4                           yfir-033
    2 u0=u1                                                             yfir-034
      u1=u2                                                             yfir-035
      u2=u3                                                             yfir-036
    3 xn=xn+1.d0                                                        yfir-037
    4 g0=s                                                              yfir-038
      gp0=-t                                                            yfir-039
      return                                                            yfir-040
c   series at the origin                                                yfir-041
    5 pi=3.141592653589793d0                                            yfir-042
      ro2=ro*ro                                                         yfir-043
      etap=eta+eta                                                      yfir-044
      pieta=pi*eta                                                      yfir-045
      pieta2=0.5d0*pieta                                                yfir-046
      b=dexp(pieta)                                                     yfir-047
      b=dexp(pieta2)*dsqrt((b-1.d0/b)/(2.d0*pieta))                     yfir-048
      c1=etap*(psi(eta)+.6931471805599453d0)                            yfir-049
      u0=0.d0                                                           yfir-050
      u1=ro                                                             yfir-051
      v0=1.d0                                                           yfir-052
      v1=c1*ro                                                          yfir-053
      u=u0+u1                                                           yfir-054
      v=v0+v1                                                           yfir-055
      up=1.d0                                                           yfir-056
      vp=c1                                                             yfir-057
      xn=2.d0                                                           yfir-058
      do 7 n=2,10000                                                    yfir-059
      xn1=xn*(xn-1.d0)                                                  yfir-060
      u2=(etap*ro*u1-ro2*u0)/xn1                                        yfir-061
      u=u+u2                                                            yfir-062
      v2=(etap*ro*v1-ro2*v0-etap*(xn+xn-1.d0)*u2)/xn1                   yfir-063
      v=v+v2                                                            yfir-064
      up=up+xn*u2/ro                                                    yfir-065
      vp=vp+xn*v2/ro                                                    yfir-066
      if (dabs(u2).gt.1.d-14*dabs(u)) go to 6                           yfir-067
      if (dabs(v2).le.1.d-14*dabs(v)) go to 8                           yfir-068
    6 u0=u1                                                             yfir-069
      u1=u2                                                             yfir-070
      v0=v1                                                             yfir-071
      v1=v2                                                             yfir-072
    7 xn=xn+1.d0                                                        yfir-073
    8 gp=v+etap*u*dlog(ro)                                              yfir-074
      g0=b*gp                                                           yfir-075
      gp0=b*(vp+etap*(up*dlog(ro)+u/ro))                                yfir-076
      return                                                            yfir-077
    9 if (ro.le.0.5d0*eta+9.d0) go to 5                                 yfir-078
      go to 1                                                           yfir-079
      end                                                               yfir-080
c 29/02/04                                                      ecis03  sigm-000
      function sigm(eta)                                                sigm-001
c  coulomb phase shift sigma0                                           sigm-002
      implicit real*8 (a-h,o-z)                                         sigm-003
      dimension c(2,13)                                                 sigm-004
      data c1,c2,c3,c4,c5,c6,c7,c /8.333333333333333d-2,-2.7777777777777sigm-005
     178d-3,7.936507936507937d-4,-5.952380952380952d-4,8.417508417508417sigm-006
     2d-4,-1.917526917526918d-3,6.41025641025641d-3,1.d-16,1.4d-15,-5.4dsigm-007
     3-15,-2.07d-14,5.1d-13,-3.6968d-12,7.7823d-12,1.043427d-10,-1.18127sigm-008
     446d-9,5.0020075d-9,6.116095d-9,-2.056338417d-7,1.133027232d-6,-1.2sigm-009
     5504934821d-6,-2.01348547807d-5,1.280502823882d-4,-2.152416741149d-sigm-010
     64,-1.1651675918591d-3,7.218943246663d-3,-9.621971527877d-3,-4.2197sigm-011
     77345555443d-2,.1665386113822915d0,-4.20026350340952d-2,-.655878071sigm-012
     85202538d0,.5772156649015329d0,1.d0/                               sigm-013
      if (dabs(eta).gt.1.d-16) go to 1                                  sigm-014
      sigm=-c(1,13)*eta                                                 sigm-015
      go to 5                                                           sigm-016
    1 e=eta*eta                                                         sigm-017
      if (e.gt.1.d0) go to 3                                            sigm-018
      x=c(1,1)                                                          sigm-019
      y=c(2,1)                                                          sigm-020
      do 2 i=2,13                                                       sigm-021
      x=c(1,i)-e*x                                                      sigm-022
    2 y=c(2,i)-e*y                                                      sigm-023
      sigm=-datan2(eta*x,y)                                             sigm-024
      go to 5                                                           sigm-025
    3 l=1                                                               sigm-026
      if (e.lt.64.d0) l=2.d0+dsqrt(64.d0-e)                             sigm-027
      z=l                                                               sigm-028
      x=dsqrt(z*z+e)                                                    sigm-029
      y=datan2(eta,z)                                                   sigm-030
      e=1.d0/(z*z+e)                                                    sigm-031
      sigm=eta*(dlog(x)-1.d0)+(z-.5d0)*y-(c1*dsin(y)+e*(c2*dsin(3.d0*y)+sigm-032
     1e*(c3*dsin(5.d0*y)+e*(c4*dsin(7.d0*y)+e*(c5*dsin(9.d0*y)+e*(c6*dsisigm-033
     2n(11.d0*y)+e*c7*dsin(13.d0*y)))))))/x                             sigm-034
      if (l.eq.1) go to 5                                               sigm-035
      j=l-1                                                             sigm-036
      do 4 i=1,j                                                        sigm-037
      z=z-1.d0                                                          sigm-038
    4 sigm=sigm-datan2(eta,z)                                           sigm-039
    5 return                                                            sigm-040
      end                                                               sigm-041
c 29/02/04                                                      ecis03  psi_-000
      function psi(eta)                                                 psi_-001
c  real part of psi(1-i*eta)-psi(1)-psi(i)                              psi_-002
c  with psi(z) = logarithmic derivative of the gamma function           psi_-003
      implicit real*8 (a-h,o-z)                                         psi_-004
      dimension b(13)                                                   psi_-005
      data c/.5772156649015329d0/,c1/8.333333333333333d-2/,c2/-8.3333333psi_-006
     133333333d-3/,c3/3.968253968253968d-3/,c4/-4.166666666666667d-3/,c5psi_-007
     2/7.575757575757576d-3/,c6/-2.109279609279609d-2/,b/7.4507117898354psi_-008
     328d-9,2.980350351465228d-8,1.192199259653110d-7,4.769329867878064dpsi_-009
     4-7,1.908212716553938d-6,7.637197637899762d-6,3.058823630702049d-5,psi_-010
     51.227133475784893d-4,4.941886041194665d-4,2.008392826082234d-3,8.3psi_-011
     649277381922945d-3,3.692775514337036d-2,2.020569031595948d-1/      psi_-012
      if (dabs(eta).gt.1.d-8) go to 1                                   psi_-013
      psi=c-1.d0                                                        psi_-014
      go to 5                                                           psi_-015
    1 e=eta*eta                                                         psi_-016
      if (e.gt..25d0) go to 3                                           psi_-017
      x=b(1)                                                            psi_-018
      do 2 i=2,13                                                       psi_-019
    2 x=b(i)-e*x                                                        psi_-020
      psi=c-1.d0/(1.d0+e)+e*x                                           psi_-021
      go to 5                                                           psi_-022
    3 l=1                                                               psi_-023
      if (e.lt.64.d0) l=2+idint(dsqrt(64.d0-e))                         psi_-024
      x=dsqrt(l*l+e)                                                    psi_-025
      y=datan(eta/l)                                                    psi_-026
      e=1.d0/(l*l+e)                                                    psi_-027
      psi=dlog(x)-.5d0*l*e-e*(c1*dcos(2.d0*y)+e*(c2*dcos(4.d0*y)+e*(c3*dpsi_-028
     1cos(6.d0*y)+e*(c4*dcos(8.d0*y)+e*(c5*dcos(10.d0*y)+e*(c6*dcos(12.dpsi_-029
     20*y)+e*c1*dcos(14.d0*y)))))))+c+c-1.d0                            psi_-030
      if (l.eq.1) go to 5                                               psi_-031
      j=l-1                                                             psi_-032
      e=eta*eta                                                         psi_-033
      do 4 i=1,j                                                        psi_-034
    4 psi=psi-1.d0/(dfloat(i)+e/dfloat(i))                              psi_-035
    5 return                                                            psi_-036
      end                                                               psi_-037
c 29/02/04                                                      ecis03  cori-000
      subroutine cori(ei,ef,s1,s2,rr,t,ssi,ssf,fgi,fgf,z,lm1,lm2,lm3,lm,cori-001
     1w)                                                                cori-002
c    computation of the integrals from rs to infinity of products of    cori-003
c regular or irregular coulomb functions of same l-value divided by r**2cori-004
c for l=0 to l=lm-1 and of regular functions of same l divided by r**2  cori-005
c l=0 to l=lm2-1.calls corz if there is no charge.                      cori-006
c input variables:  ei,ef:  coulomb parameters.                         cori-007
c                   s1,s2:  wave numbers.                               cori-008
c                   rr:     matching radius.                            cori-009
c                   ssi,ssf:coulomb phase-shifts for l=0.               cori-010
c                   fgi,fgf:regular and irregular coulomb functions.    cori-011
c                   lm1:    maximum number of integrals from rs to inf. cori-012
c                   lm2:    number of integrals from 0 to infinity      cori-013
c                   lm3:    dimension of working space(single precision)cori-014
c                   lm:     actual number of integrals from rs to inf.  cori-015
c output:variables: t:      integrals from 0 to infinity for products ofcori-016
c                           regular functions.                          cori-017
c                   w:      integrals from rs to infinity.              cori-018
c working space:    z:      for the computation of hypergeometric f3.   cori-019
c***********************************************************************cori-020
      implicit real*8 (a-h,o-z)                                         cori-021
      logical ll(4)                                                     cori-022
      dimension w(lm1,4),x1(4),x2(4),x3(4),x4(4),fgi(lm1,2),fgf(lm1,2),zcori-023
     1(4,2),t(4),y(4,4),az(2),cc(4,4)                                   cori-024
      common /inout/ mr,mw,ms                                           cori-025
      data pi /3.141592653589793d0/                                     cori-026
      si=s1*rr                                                          cori-027
      sf=s2*rr                                                          cori-028
      if (ei.eq.0.d0) go to 36                                          cori-029
c computation of some constants                                         cori-030
      if (si.gt.2.2d0*sf) go to 38                                      cori-031
      rs=dsqrt(si*sf)                                                   cori-032
      fs=dsqrt(sf/si)                                                   cori-033
      fi=ei**2                                                          cori-034
      ff=ef**2                                                          cori-035
      eif=ei*ef                                                         cori-036
      ex=ef-ei                                                          cori-037
      sif=si/sf+sf/si                                                   cori-038
      cx=fi*si**2+ff*sf**2                                              cori-039
      dx=fi*si**2-ff*sf**2                                              cori-040
      if (dabs(dx).gt.1.d-10) go to 1                                   cori-041
      dt=1.d0                                                           cori-042
      dx=0.d0                                                           cori-043
      dy=eif                                                            cori-044
      go to 2                                                           cori-045
    1 dt=si**2-sf**2                                                    cori-046
      dy=(fi*si**4-ff*sf**4)/(si*sf)                                    cori-047
      if (dabs(dt).lt.1.d-10) go to 2                                   cori-048
      dx=dx/dt                                                          cori-049
      dy=dy/dt                                                          cori-050
      dt=1.d0                                                           cori-051
    2 rm=dmax1((5.d0*dabs(ei)+22.5d0)*fs,(5.d0*dabs(ef)+22.5d0)/fs,.18d0cori-052
     1*eif)/3.d0                                                        cori-053
      if (rm.lt.rs) rm=rs                                               cori-054
c computation of integrals from rs to infinity for l=0 and l=1          cori-055
      call cor0(ei,ef,ssi,ssf,zr,zi,z,lm3,rm,rs,fs,fi,ff,ex,cc)         cori-056
c computation of integrals from 0 to infinity for l=0 and l=1           cori-057
      a1=dsqrt(1.d0+fi)                                                 cori-058
      b1=dsqrt(1.d0+ff)                                                 cori-059
      if (ei.ne.ef.or.si.ne.sf) go to 4                                 cori-060
c when ei=ef=e   i(l,l,2)=(pi-pi*coth(pi*e)-1/e+sum on n from 0 to l of cori-061
c                2*e/(n**2+e**2))/2/(2*l+1)                             cori-062
      a2=pi*.5d0                                                        cori-063
      b2=dexp(-2.d0*pi*ei)                                              cori-064
      if (ei.ne.0.d0) a2=a2-.5d0*pi*(b2+1.d0)/(1.d0-b2)+.5d0/ei         cori-065
      b3=0.d0                                                           cori-066
      do 3 i=1,lm2                                                      cori-067
      b2=b3                                                             cori-068
      b3=b3+1.d0                                                        cori-069
      t(i)=a2/(b2+b3)                                                   cori-070
    3 a2=a2+ei/(b3**2+fi)                                               cori-071
      ll(1)=.true.                                                      cori-072
      ll(2)=.true.                                                      cori-073
      go to 11                                                          cori-074
c computation of i(0,0,1) and i(1,1,1)                                  cori-075
c  i(l,l,1) = 2*(si*sf)**(1/2)/(si+sf)**2 * exp( pi*sign(sf-si)*ex/2) * cori-076
c real part of (|sf-si|/(sf+si))**(i*ex)*gamma(-i*ex)*exp(i*(xef-xei))* cori-077
c   2f1(l+1-i*ei,l+1+i*ef;1+i*ef-i*ei;((sf-si)/(sf+si))**2)             cori-078
c  where ex=ef-ei.                                                      cori-079
    4 a2=ex**2                                                          cori-080
      b2=((si-sf)/(si+sf))**2                                           cori-081
      a3=2.d0*dexp(zr-pi*.5d0*ex)/(si+sf)**2*rs                         cori-082
      if (sf.gt.si) a3=a3*dexp(pi*ex)                                   cori-083
      a4=zi+ssf-ssi+.5d0*dlog(b2)*ex                                    cori-084
      a5=a3*dcos(a4)                                                    cori-085
      a6=a3*dsin(a4)                                                    cori-086
      a3=a5                                                             cori-087
      a4=a6                                                             cori-088
      a7=0.d0                                                           cori-089
      do 7 l=1,2                                                        cori-090
      az(l)=a3                                                          cori-091
      a8=0.d0                                                           cori-092
      do 5 n=1,500                                                      cori-093
      a8=a8+1.d0                                                        cori-094
      b3=(a7+a8)**2+eif                                                 cori-095
      b4=(a7+a8)*ex                                                     cori-096
      b7=b2/(a8*(a8**2+a2))                                             cori-097
      b5=(b3*a8+b4*ex)*b7                                               cori-098
      b6=(a8*b4-ex*b3)*b7                                               cori-099
      a9=a3*b5-a4*b6                                                    cori-100
      a4=a3*b6+a4*b5                                                    cori-101
      a3=a9                                                             cori-102
      az(l)=az(l)+a3                                                    cori-103
      if (dabs(a3)+dabs(a4).lt.dabs(az(l))*1.d-16) go to 6              cori-104
    5 continue                                                          cori-105
      li=l-1                                                            cori-106
      write (mw,1000) li,li,ei,ef,az(l),a3,a4                           cori-107
    6 b3=1.d0+eif                                                       cori-108
      b5=(1.d0-b2)/dsqrt(b3*b3+ex*ex)                                   cori-109
      a7=1.d0                                                           cori-110
      a3=b5*(a5*b3-a6*ex)                                               cori-111
    7 a4=b5*(a6*b3+a5*ex)                                               cori-112
c computation of i(0,0,2) and i(1,1,2) . only the first is needed       cori-113
c   for backward recurrence                                             cori-114
c i(l,l,2) = pi/(2*sh(pi*ex)*( (y/si-1/(y*sf))/(2*l+1)+((si-sf)/(sf*si))cori-115
c  *exp(-pi*ex/2) * real part of exp(i*(xei-xef))*((si-sf)/2)**(-i*ex)  cori-116
c  *sf**(i*ef)*si**(-i*ei)*f3(-l+i*ei,-l-i*ef,l+1+i*ei,l+1-i*ef,2-i*ex; cori-117
c  (si-sf)/(2*si),(sf-si)/(2*sf))                                       cori-118
c    where  y=exp(pi*ex/2)*(si/sf)**l*|gamma(l+1+i*ef)/gamma(l+1+i*ei)| cori-119
      a2=ex/(2.d0*ef)                                                   cori-120
      a3=-a2*(si-sf)/(2.d0*sf)                                          cori-121
      a4=a2*(si-sf)/(2.d0*si)                                           cori-122
      ll(1)=dfloat(lm2)*dabs(ex).gt.3.d0*dabs(ei+ef)                    cori-123
      ll(2)=.not.ll(1)                                                  cori-124
      b3=dexp(-zr)/ex/dsqrt(1.d0+ex**2)                                 cori-125
      b4=ssi-ssf-zi+datan(ex)-.5d0*pi+ef*dlog(sf)-ei*dlog(si)-ex*dlog(.5cori-126
     1d0*dabs(si-sf))                                                   cori-127
      if (sf.gt.si) b3=b3*dexp(ex*pi)                                   cori-128
      a5=b3*dcos(b4)                                                    cori-129
      a6=b3*dsin(b4)                                                    cori-130
      b5=a5                                                             cori-131
      b6=a6                                                             cori-132
      b2=dsqrt(ef/ei*(dexp(-2.d0*pi*ei)-1.d0)/(dexp(-2.d0*pi*ef)-1.d0)) cori-133
      a7=dexp(-.5d0*pi*ex)                                              cori-134
      a8=pi*a7**2/(1.d0-a7**4)*rs                                       cori-135
      a7=a7*(sf-si)/(sf*si)                                             cori-136
      a9=0.d0                                                           cori-137
      z(1,1)=1.d0                                                       cori-138
      z(2,1)=0.d0                                                       cori-139
      z(3,1)=1.d0                                                       cori-140
      z(4,1)=0.d0                                                       cori-141
      do 10 l=1,2                                                       cori-142
      li=l-1                                                            cori-143
      t(l)=b5                                                           cori-144
      c1=0.d0                                                           cori-145
      n=0                                                               cori-146
    8 n=n+1                                                             cori-147
      if (4*n.gt.lm3) call memo('cori',lm3,4*n,2)                       cori-148
      c1=c1+1.d0                                                        cori-149
      b3=c1+1.d0                                                        cori-150
      b4=b3**2+ex**2                                                    cori-151
      b9=(b5*b3-ex*b6)/(b4*a2)                                          cori-152
      b6=(b5*ex+b6*b3)/(b4*a2)                                          cori-153
      b5=b9                                                             cori-154
      b3=(a9+c1)*(c1-a9-1.d0)-fi                                        cori-155
      b4=ei*(2.d0*c1-1.d0)                                              cori-156
      z(1,n+1)=(z(1,n)*b3-z(2,n)*b4)*a4/c1                              cori-157
      z(2,n+1)=(z(1,n)*b4+z(2,n)*b3)*a4/c1                              cori-158
      b3=(a9+c1)*(c1-a9-1.d0)-ff                                        cori-159
      b4=-ef*(2.d0*c1-1.d0)                                             cori-160
      z(3,n+1)=(z(3,n)*b3-z(4,n)*b4)*a3/c1                              cori-161
      z(4,n+1)=(z(3,n)*b4+z(4,n)*b3)*a3/c1                              cori-162
      b7=z(1,n+1)                                                       cori-163
      b8=z(2,n+1)                                                       cori-164
      do 9 j=1,n                                                        cori-165
      m=n+2-j                                                           cori-166
      b7=b7+z(1,j)*z(3,m)-z(2,j)*z(4,m)                                 cori-167
    9 b8=b8+z(2,j)*z(3,m)+z(1,j)*z(4,m)                                 cori-168
      if (dabs(b7)+dabs(b8).gt.1.d30) go to 39                          cori-169
      b7=b7*b5-b8*b6                                                    cori-170
      t(l)=t(l)+b7                                                      cori-171
      if (dabs(b7).gt.dabs(t(l))*1.d-16) go to 8                        cori-172
      t(l)=a8*(a7*t(l)+(b2/si-1.d0/(b2*sf))/(2.d0*a9+1.d0))             cori-173
      if (ll(1)) go to 11                                               cori-174
      a9=1.d0                                                           cori-175
      b2=b2*sf/si*b1/a1                                                 cori-176
      b4=b1*a1                                                          cori-177
      b3=(1.d0+eif)/b4                                                  cori-178
      b4=-ex/b4                                                         cori-179
      b5=b3*a5-b4*a6                                                    cori-180
   10 b6=b3*a6+b4*a5                                                    cori-181
c comp. of the integrals from 0 to infinity                             cori-182
c upwards recurrences for the other integrals:  starting values         cori-183
   11 do 12 j=1,4                                                       cori-184
      w(1,j)=cc(j,3)                                                    cori-185
      w(2,j)=cc(j,4)                                                    cori-186
      x2(j)=cc(j,1)/rs                                                  cori-187
   12 x3(j)=cc(j,2)/rs                                                  cori-188
      rm=rs**2                                                          cori-189
      in=1                                                              cori-190
      lx=lm                                                             cori-191
      if (.not.ll(1)) lx=max0(lx,lm2)                                   cori-192
      ll(3)=ll(1)                                                       cori-193
      i=2                                                               cori-194
      if (ll(1)) go to 13                                               cori-195
      c4=az(1)                                                          cori-196
      c5=az(2)                                                          cori-197
   13 i=i+1                                                             cori-198
      a2=a1                                                             cori-199
      b2=b1                                                             cori-200
      a=dfloat(i-1)                                                     cori-201
      a1=dsqrt(a**2+fi)                                                 cori-202
      b1=dsqrt(a**2+ff)                                                 cori-203
      ll(4)=i.gt.lm                                                     cori-204
   14 a9=(a-1.d0)**2*dt+dx                                              cori-205
      a3=(2.d0*a-3.d0)*(a**2*dt+dx)*a2*b2                               cori-206
      a4=-(2.d0*a-1.d0)*(dx*cx/rm+dy*((a-1.d0)**2+a**2)+dt*(a*a-a)**2*sicori-207
     1f)                                                                cori-208
      a5=(2.d0*a+1.d0)*a9*a1*b1                                         cori-209
      c1=dt*(2.d0*a-1.d0)*(ei*si+ef*sf)*a2*b2/(a-1.d0)                  cori-210
      c2=dt*(a-.5d0)*(b2**2*((a-1.d0)*ef*sf-(a+1.d0)*ei*si)*sf/si+a2**2*cori-211
     1((a-1.d0)*ei*si-(a+1.d0)*ef*sf)*si/sf)/(a-1.d0)                   cori-212
      a6=a*a2*b2                                                        cori-213
      a7=-(2.d0*a-1.d0)*(eif+(a-1.d0)*a*sif*.5d0)                       cori-214
      a8=(a-1.d0)*a1*b1                                                 cori-215
      if (ll(4)) go to 15                                               cori-216
      b6=(a-.5d0)/(rm*rs*(a-1.d0)**2)                                   cori-217
      b3=-2.d0*rm*dx*b6*a2*b2                                           cori-218
      b4=b6*a9*sf*(2.d0*(a*a-a)*a+(a+1.d0)*ei*si-(a-1.d0)*ef*sf)*b2     cori-219
      b5=b6*a9*si*(2.d0*(a*a-a)*a+(a+1.d0)*ef*sf-(a-1.d0)*ei*si)*a2     cori-220
      b6=-b6*(a9*(2.d0*(a*a-a)**2*(2.d0*a-1.d0)+(ei*si+ef*sf)*(a-1.d0)*(cori-221
     1a+1.d0)*(2.d0*a-1.d0)+2.d0*eif*rm*a)-(a-1.d0)*(cx*dx+(a-1.d0)*((a+cori-222
     21.d0)*cx*dt-2.d0*rm*dy)))                                         cori-223
      b9=(a-.5d0)*a/rs                                                  cori-224
      b7=b9*b2/si                                                       cori-225
      b8=b9*a2/sf                                                       cori-226
      b9=b9*(-(2.d0*a-1.d0)*(a-1.d0)-(ei*si+ef*sf))/rm                  cori-227
   15 if (in.ne.1) go to 24                                             cori-228
      if (ll(3)) go to 16                                               cori-229
      t(i)=-(a3*t(i-2)+a4*t(i-1)+c1*c4+c2*c5)/a5                        cori-230
      c3=c4                                                             cori-231
      c4=c5                                                             cori-232
      c5=-(a6*c3+a7*c4)/a8                                              cori-233
   16 if (ll(4)) go to 21                                               cori-234
      do 18 j=1,4                                                       cori-235
      j1=mod(j+1,2)+i-2                                                 cori-236
      j2=(j+1)/2+i-3                                                    cori-237
      do 17 k=1,4                                                       cori-238
      k1=mod(k+1,2)*2+1                                                 cori-239
      k2=2*((k+1)/2)-1                                                  cori-240
   17 y(k,j)=fgi(j1,k1)*fgf(j2,k2)                                      cori-241
   18 continue                                                          cori-242
c recurrence for (0,2;l)                                                cori-243
      do 19 j=1,4                                                       cori-244
      x1(j)=x2(j)                                                       cori-245
      x2(j)=x3(j)                                                       cori-246
   19 w(i,j)=-(b3*y(j,1)+b4*y(j,2)+b5*y(j,3)+b6*y(j,4)+a3*w(i-2,j)+a4*w(cori-247
     1i-1,j)+c1*x1(j)+c2*x2(j))/a5                                      cori-248
      do 20 j=1,4                                                       cori-249
   20 x3(j)=-(b7*y(j,2)+b8*y(j,3)+b9*y(j,4)+a6*x1(j)+a7*x2(j))/a8       cori-250
   21 if (i.lt.lx) go to 13                                             cori-251
      ln=max0(lm,idint(rs))+50                                          cori-252
      lx=ln                                                             cori-253
      if (.not.ll(2)) lx=max0(lx,lm2+6*min0(idint((si+sf)/dabs(si-sf)),5cori-254
     100))                                                              cori-255
      ll(3)=ll(2)                                                       cori-256
      in=2                                                              cori-257
      x4(1)=1.d0                                                        cori-258
      x4(2)=0.d0                                                        cori-259
      x4(3)=0.d0                                                        cori-260
      x4(4)=0.d0                                                        cori-261
      a1=lx-1                                                           cori-262
      a2=dsqrt(a1**2+fi)                                                cori-263
      b2=dsqrt(a1**2+ff)                                                cori-264
      do 22 j=1,4                                                       cori-265
      x2(j)=0.d0                                                        cori-266
   22 x3(j)=0.d0                                                        cori-267
      x3(1)=1.d-20                                                      cori-268
      x3(2)=1.d-20                                                      cori-269
   23 lx=lx-1                                                           cori-270
      a=lx                                                              cori-271
      a1=a2                                                             cori-272
      b1=b2                                                             cori-273
      a3=dfloat(lx-1)                                                   cori-274
      ll(4)=lx.gt.ln                                                    cori-275
      a2=dsqrt(a3**2+fi)                                                cori-276
      b2=dsqrt(a3**2+ff)                                                cori-277
      go to 14                                                          cori-278
   24 if (ll(3)) go to 25                                               cori-279
      x4(1)=-a6/(a7+a8*x4(1))                                           cori-280
      x4(3)=x4(1)*x4(2)                                                 cori-281
      x4(2)=-(a4*x4(3)+a5*x4(4)*x4(1)+c1+c2*x4(1))/a3                   cori-282
      x4(4)=x4(3)                                                       cori-283
      if (lx.le.lm2) t(lx)=x4(3)/x4(2)                                  cori-284
   25 if (ll(4)) go to 31                                               cori-285
c downward recurrence for f(ei) and f(ef)                               cori-286
      do 26 j=1,4                                                       cori-287
      x1(j)=x2(j)                                                       cori-288
   26 x2(j)=x3(j)                                                       cori-289
      x3(1)=((2.d0*a-1.d0)*(ei+(a-1.d0)*a/si)*x2(1)-(a-1.d0)*a1*x1(1))/(cori-290
     1a*a2)                                                             cori-291
      x3(2)=((2.d0*a-1.d0)*(ef+(a-1.d0)*a/sf)*x2(2)-(a-1.d0)*b1*x1(2))/(cori-292
     1a*b2)                                                             cori-293
c downwards recurrence for (1,2;l)                                      cori-294
      x3(4)=-(a7*x2(4)+a8*x1(4)+b7*x2(1)*x3(2)+b8*x3(1)*x2(2)+b9*x2(1)*xcori-295
     12(2))/a6                                                          cori-296
c downward recurrence for (0,2;l)                                       cori-297
      x3(3)=-(a4*x2(3)+a5*x1(3)+c1*x3(4)+c2*x2(4)+b3*x3(1)*x3(2)+b4*x2(1cori-298
     1)*x3(2)+b5*x3(1)*x2(2)+b6*x2(1)*x2(2))/a3                         cori-299
      i=lx-1                                                            cori-300
      if (i.le.lm) w(i,1)=x3(3)                                         cori-301
      if (dabs(x3(1)).lt.1.d10) go to 27                                cori-302
      x3(1)=x3(1)*1.d-20                                                cori-303
      x2(1)=x2(1)*1.d-20                                                cori-304
      go to 28                                                          cori-305
   27 if (dabs(x3(2)).lt.1.d10) go to 31                                cori-306
      x2(2)=x2(2)*1.d-20                                                cori-307
      x3(2)=x3(2)*1.d-20                                                cori-308
   28 do 29 j=3,4                                                       cori-309
      x3(j)=x3(j)*1.d-20                                                cori-310
   29 x2(j)=x2(j)*1.d-20                                                cori-311
      if (i.gt.lm) go to 31                                             cori-312
      do 30 j=i,lm                                                      cori-313
   30 w(j,1)=w(j,1)*1.d-20                                              cori-314
   31 if (lx.gt.2) go to 23                                             cori-315
      if (ll(2)) go to 34                                               cori-316
c computation of the mixture of the decreasing solution of homogeneous  cori-317
c equation  (s2/s1)**l * |gamma(l+1+i*e2)/gamma(l+1+i*e1)|/(2*l+1)      cori-318
c where s2 is the smaller of the two values si and sf.                  cori-319
      a1=x4(2)*az(1)                                                    cori-320
      a2=t(1)-a1                                                        cori-321
      a3=0.d0                                                           cori-322
      do 33 i=2,lm2                                                     cori-323
      a3=a3+1.d0                                                        cori-324
      a1=t(i)*a1                                                        cori-325
      a4=sf*dsqrt((a3**2+ff)/(a3**2+fi))/si                             cori-326
      if (si.gt.sf) go to 32                                            cori-327
      a2=a2/a4                                                          cori-328
      go to 33                                                          cori-329
   32 a2=a2*a4                                                          cori-330
   33 t(i)=a1+a2/(2.d0*a3+1.d0)                                         cori-331
c the values obtained are unnormalised integrals from rs to 0.          cori-332
c normalisation and transformation to integral from rs to infinity      cori-333
   34 a1=fgi(1,1)*fgf(1,1)/(x3(1)*x3(2))                                cori-334
      do 35 j=1,lm                                                      cori-335
   35 w(j,1)=a1*w(j,1)+t(j)                                             cori-336
      if (s1.ne.s2) write (mw,1001) cc(1,3),w(1,1),cc(1,4),w(2,1)       cori-337
c upwards recurrences for the other integrals:  starting values         cori-338
      return                                                            cori-339
   36 call corz(si,sf,t,fgi,fgf,lm1,lm2,lm,w)                           cori-340
      return                                                            cori-341
   37 write (mw,1002)                                                   cori-342
      stop                                                              cori-343
   38 write (mw,1003) ef,ei                                             cori-344
      go to 37                                                          cori-345
   39 write (mw,1004) n,li,li,ei,ef,t(l),b5,b6                          cori-346
      go to 37                                                          cori-347
 1000 format (' no convergence with 500 terms for i(',i1,',',i1,') with cori-348
     1ei =',f15.6,31x,'and ef =',f15.6,5x,'in corh'/5x,'value =',d15.8,5cori-349
     2x,'last term =',2d16.8/' ... continue ...')                       cori-350
 1001 format (' integrals with regular functions: (l+1)       direct    cori-351
     1   backwards recurrence'/37x,'1',2d20.10/37x,'2',2d20.10)         cori-352
 1002 format (//' in cori  ... stop ...')                               cori-353
 1003 format (' too large ratio ef/ei =',f15.6,1h/,f15.6,5x,'in cori')  cori-354
 1004 format (' the',i4,' term is too large in the computation of i(',i1cori-355
     1,',',i1,',2)    with ei =',f15.6,5x,'and ef =',f15.6,5x,'in corh'/cori-356
     25x,'value =',d15.8,5x,'last term =',2d16.8)                       cori-357
      end                                                               cori-358
c 29/02/04                                                      ecis03  cor0-000
      subroutine cor0(ei,ef,ssi,ssf,zr,zi,z,lm3,rm,rs,fs,fi,ff,ex,cc)   cor0-001
c    computation of the integrals from rs to infinity of products of    cor0-002
c regular or irregular coulomb functions of l=0 and l=1 divided by r**2 cor0-003
c input variables: ei,ef:  coulomb parameters.                          cor0-004
c                  ssi,ssf:coulomb phase-shifts for l=0.                cor0-005
c                  lm3:    dimension of working space(single precision) cor0-006
c                  lm:     actual number of integrals from rs to inf.   cor0-007
c                  rm:     actual matching radius for integrals.        cor0-008
c                  rs:     needed matching radius for integrals.        cor0-009
c                  fs:     square root of ratio of wave numbers.        cor0-010
c                  fi,ff:  squares of coulomb parameters.               cor0-011
c                  ex:     difference of coulomb parameters.            cor0-012
c output variables:cc:     integrals from rs to infinity.               cor0-013
c                  zr,zi:  real, imaginary part of log(gamma(0.,ei-ef)) cor0-014
c working space:   z:      for the computation of f and g.              cor0-015
c***********************************************************************cor0-016
      implicit real*8 (a-h,o-z)                                         cor0-017
      dimension x1(4),x2(4),x3(4),x4(4),x5(4),z(4,2),c(2,2,2),y(4,4),ie(cor0-018
     12),absc(20),p(20),b(7),cc(4,4)                                    cor0-019
      data pi /3.141592653589793d0/                                     cor0-020
      data b /.8333333333333333d-01,-.2777777777777778d-2,.7936507936507cor0-021
     19365d-3,-.5952380952380952d-3,.84175084175d-3,-.19175269d-2,.641d-cor0-022
     202/                                                               cor0-023
      data absc( 1),p( 1) / 0.88114514472040d-03, 0.22606385492666d-02/ cor0-024
      data absc( 2),p( 2) / 0.46368806502715d-02, 0.52491422655764d-02/ cor0-025
      data absc( 3),p( 3) / 0.11370025008113d-01, 0.82105291909539d-02/ cor0-026
      data absc( 4),p( 4) / 0.21041590393104d-01, 0.11122924597084d-01/ cor0-027
      data absc( 5),p( 5) / 0.33593595860662d-01, 0.13968503490012d-01/ cor0-028
      data absc( 6),p( 6) / 0.48950596515563d-01, 0.16730097641274d-01/ cor0-029
      data absc( 7),p( 7) / 0.67020248393870d-01, 0.19391083987236d-01/ cor0-030
      data absc( 8),p( 8) / 0.87693884583344d-01, 0.21935454092836d-01/ cor0-031
      data absc( 9),p( 9) / 0.11084717428674d+00, 0.24347903817536d-01/ cor0-032
      data absc(10),p(10) / 0.13634087240504d+00, 0.26613923491968d-01/ cor0-033
      data absc(11),p(11) / 0.16402165769291d+00, 0.28719884549696d-01/ cor0-034
      data absc(12),p(12) / 0.19372305516601d+00, 0.30653121246465d-01/ cor0-035
      data absc(13),p(13) / 0.22526643745244d+00, 0.32402006728300d-01/ cor0-036
      data absc(14),p(14) / 0.25846209915691d+00, 0.33956022907617d-01/ cor0-037
      data absc(15),p(15) / 0.29311039781420d+00, 0.35305823695643d-01/ cor0-038
      data absc(16),p(16) / 0.32900295458712d+00, 0.36443291197902d-01/ cor0-039
      data absc(17),p(17) / 0.36592390749637d+00, 0.37361584528984d-01/ cor0-040
      data absc(18),p(18) / 0.40365120964931d+00, 0.38055180950313d-01/ cor0-041
      data absc(19),p(19) / 0.44195796466237d+00, 0.38519909082124d-01/ cor0-042
      data absc(20),p(20) / 0.48061379124697d+00, 0.38752973989212d-01/ cor0-043
c computation of the integrals from rm to infinity for l=0,1 by         cor0-044
c rawitscher's method. (comp. physics comm., vol.11,183,1976)           cor0-045
c expansions of coulomb wave functions are z(n,2*m-1)+i*z(n,2*m)=g+i*f  cor0-046
c   n=1: l=0,e=ei     n=2: l=0,e=ef     n=3: l=1,e=ei     n=4: l=1,e=ef cor0-047
      a1=rm/fs                                                          cor0-048
      b1=rm*fs                                                          cor0-049
      x1(1)=a1-ei*dlog(2.d0*a1)+ssi                                     cor0-050
      x1(3)=b1-ef*dlog(2.d0*b1)+ssf                                     cor0-051
      x1(2)=x1(1)+datan(ei)-.5d0*pi                                     cor0-052
      x1(4)=x1(3)+datan(ef)-.5d0*pi                                     cor0-053
c first term of asymptotic expansion of h(+/-) for l=0,1                cor0-054
      do 1 i=1,4                                                        cor0-055
      x5(i)=0.d0                                                        cor0-056
      z(i,1)=dcos(x1(i))                                                cor0-057
    1 z(i,2)=dsin(x1(i))                                                cor0-058
      x1(1)=-a1-b1                                                      cor0-059
      x2(1)=ei+ef                                                       cor0-060
      x1(2)=b1-a1                                                       cor0-061
      x2(2)=-ex                                                         cor0-062
      if (dabs(x1(2)).lt.1.d-8) x1(2)=0.d0                              cor0-063
      if (x1(2).eq.0.d0) go to 4                                        cor0-064
c computation of log(gamma(0.,ei-ef))                                   cor0-065
      b2=-datan(ex/11.d0)                                               cor0-066
      b3=121.d0+ex**2                                                   cor0-067
      a2=.5d0*dlog(b3)                                                  cor0-068
      zr=.91893853320467274d0+10.5d0*a2+ex*b2-11.d0-dlog(dabs(ex))      cor0-069
      zi=10.5d0*b2+ex-ex*a2+0.5d0*pi                                    cor0-070
      if (ex.lt.0.d0) zi=zi-pi                                          cor0-071
      a2=11.d0/b3                                                       cor0-072
      b2=ex/b3                                                          cor0-073
      a3=a2**2-b2**2                                                    cor0-074
      b3=2.d0*a2*b2                                                     cor0-075
      do 2 i=1,7                                                        cor0-076
      zr=zr+b(i)*a2                                                     cor0-077
      zi=zi+b(i)*b2                                                     cor0-078
      c1=a2*a3-b2*b3                                                    cor0-079
      b2=a2*b3+b2*a3                                                    cor0-080
    2 a2=c1                                                             cor0-081
      do 3 i=1,10                                                       cor0-082
      a2=dfloat(i)                                                      cor0-083
      zr=zr-.5d0*dlog(a2**2+ex**2)                                      cor0-084
    3 zi=zi+datan(ex/a2)                                                cor0-085
    4 if (dabs(x1(2)).gt.2.d0) go to 9                                  cor0-086
c computation of the first confluent hypergeometric function            cor0-087
      if (x1(2).eq.0.d0) go to 8                                        cor0-088
      if (dabs(x2(2)).lt.1.d-3) go to 5                                 cor0-089
      a2=dexp(-dsign(0.5d0*pi,x1(2))*x2(2)+zr)                          cor0-090
      b2=dsign(zi,x2(2))+x2(2)*dlog(dabs(x1(2)))                        cor0-091
      x5(2)=a2*dcos(b2)                                                 cor0-092
      x5(4)=a2*dsin(b2)-1.d0/x2(2)                                      cor0-093
      go to 6                                                           cor0-094
c expansion for small ex                                                cor0-095
    5 a2=dlog(dabs(x1(2)))                                              cor0-096
      b2=pi*.5d0                                                        cor0-097
      if (x1(2).lt.0.d0) b2=-b2                                         cor0-098
      a3=a2*(1.d0+ex*(b2-ex*((a2**2-3.d0*b2**2)/6.d0+ex*b2*(a2**2-b2**2)cor0-099
     1/6.d0)))                                                          cor0-100
      b3=b2-ex*((a2**2-b2**2)/2.d0+ex*(b2*(3.d0*a2**2-b2**2)/6.d0-ex*(a2cor0-101
     1**4-6.d0*a2**2*b2**2+b2**4)/24.d0))                               cor0-102
      a2=.5772156649015329d0-.400685634386331d0*ex**2                   cor0-103
      b2=-ex*(.822467033424113d0-0.270580808427784d0*ex**2)             cor0-104
      a4=a2*(1.d0+ex*(b2-ex*((a2**2-3.d0*b2**2)/6.d0+ex*b2*(a2**2-b2**2)cor0-105
     1/6.d0)))                                                          cor0-106
      b4=b2-ex*((a2**2-b2**2)/2.d0+ex*(b2*(3.d0*a2**2-b2**2)/6.d0-ex*(a2cor0-107
     1**4-6.d0*a2**2*b2**2+b2**4)/24.d0))                               cor0-108
      x5(2)=-a3-a4-ex*(a3*b4+b3*a4)                                     cor0-109
      x5(4)=-b3-b4+ex*(a3*a4-b3*b4)                                     cor0-110
    6 a2=x5(2)                                                          cor0-111
      b2=x5(4)                                                          cor0-112
      a3=1.d0                                                           cor0-113
      b3=0.d0                                                           cor0-114
      do 7 j=1,1000                                                     cor0-115
      b4=j                                                              cor0-116
      c1=-x1(2)*(b4*b3-ex*a3)/(b4**2+ex**2)                             cor0-117
      b3=x1(2)*(b4*a3+ex*b3)/(b4**2+ex**2)                              cor0-118
      a3=c1                                                             cor0-119
      c2=(-x1(2)*b2+a3)/b4                                              cor0-120
      b2=(x1(2)*a2+b3)/b4                                               cor0-121
      a2=c2                                                             cor0-122
      x5(2)=x5(2)+a2                                                    cor0-123
      x5(4)=x5(4)+b2                                                    cor0-124
      if (dabs(a2)+dabs(b2).lt.1.d-12*(dabs(x5(2))+dabs(x5(4)))) go to 9cor0-125
    7 continue                                                          cor0-126
      go to 9                                                           cor0-127
    8 x5(4)=-.5d0*pi                                                    cor0-128
      x5(2)=0.d0                                                        cor0-129
    9 do 10 j=1,16                                                      cor0-130
   10 y(j,1)=0.d0                                                       cor0-131
      n=idint(dmin1(a1+dsqrt(a1**2-fi),b1+dsqrt(b1**2-ff))+2.d0)        cor0-132
      a3=0.d0                                                           cor0-133
      b3=0.d0                                                           cor0-134
c loop of the asymptotic expansion                                      cor0-135
      do 24 i=1,n                                                       cor0-136
      if (8*i.gt.lm3) call memo('cor0',lm3,8*i,2)                       cor0-137
      a4=dfloat(i)-2                                                    cor0-138
      if (i.eq.1) go to 16                                              cor0-139
      if (i.eq.2) go to 12                                              cor0-140
      b4=1.d0-.5d0/a4                                                   cor0-141
      x3(1)=ei*b4/a1                                                    cor0-142
      x3(2)=x3(1)                                                       cor0-143
      x3(3)=ef*b4/b1                                                    cor0-144
      x3(4)=x3(3)                                                       cor0-145
      x4(1)=(fi-a4*(a4-1.d0))/(2.d0*a4*a1)                              cor0-146
      x4(2)=(fi-(a4+1.d0)*(a4-2.d0))/(2.d0*a4*a1)                       cor0-147
      x4(3)=(ff-a4*(a4-1.d0))/(2.d0*a4*b1)                              cor0-148
      x4(4)=(ff-(a4+1.d0)*(a4-2.d0))/(2.d0*a4*b1)                       cor0-149
c new term of asymptotic expansion                                      cor0-150
      do 11 j=1,4                                                       cor0-151
      z(j,2*i-3)=z(j,2*i-5)*x3(j)-z(j,2*i-4)*x4(j)                      cor0-152
   11 z(j,2*i-2)=z(j,2*i-5)*x4(j)+z(j,2*i-4)*x3(j)                      cor0-153
   12 do 13 j=1,8                                                       cor0-154
   13 c(j,1,1)=0.d0                                                     cor0-155
c product of the asymptotic expansions in c(1,n,m)+i*c(2,n,m)           cor0-156
c  n=1: h0(+)(ei)*h0(+)(ef)     n=2: h1(+)(ei)*h1(+)(ef)                cor0-157
c  m=1: hl(+)(ei)*hl(+)(ef)     m=2: hl(+)(ei)*hl(+)(ef)*               cor0-158
      i1=i-1                                                            cor0-159
      do 15 j=1,i1                                                      cor0-160
      m=i-j                                                             cor0-161
      do 14 l=1,2                                                       cor0-162
      c(1,l,1)=c(1,l,1)+z(l,2*j-1)*z(l+2,2*m-1)-z(l,2*j)*z(l+2,2*m)     cor0-163
      c(2,l,1)=c(2,l,1)+z(l,2*j-1)*z(l+2,2*m)+z(l,2*j)*z(l+2,2*m-1)     cor0-164
      c(1,l,2)=c(1,l,2)+z(l,2*j-1)*z(l+2,2*m-1)+z(l,2*j)*z(l+2,2*m)     cor0-165
   14 c(2,l,2)=c(2,l,2)-z(l,2*j-1)*z(l+2,2*m)+z(l,2*j)*z(l+2,2*m-1)     cor0-166
   15 continue                                                          cor0-167
   16 b4=a4+2.d0                                                        cor0-168
      a5=0.d0                                                           cor0-169
      b5=0.d0                                                           cor0-170
c integration from rs to infinity                                       cor0-171
      do 23 m=1,2                                                       cor0-172
c transfer of previous integrals                                        cor0-173
      x4(m)=x5(m)*rm                                                    cor0-174
      x4(m+2)=x5(m+2)*rm                                                cor0-175
      if (dabs(x1(m)).le.2.d0.and.m.eq.2) go to 20                      cor0-176
c pade method for omega function                                        cor0-177
c instead of formula (44), we compute i*k*r*omega in terms of i*k*r     cor0-178
      a9=b4**2+(x2(m)+x1(m))**2                                         cor0-179
      a6=b4/a9                                                          cor0-180
      b6=-(x2(m)+x1(m))/a9                                              cor0-181
      a7=-b6*x1(m)                                                      cor0-182
      b7=a6*x1(m)                                                       cor0-183
      a8=a6                                                             cor0-184
      b8=b6+1.d0/x1(m)                                                  cor0-185
      b9=1.d0                                                           cor0-186
c steed's algorithm                                                     cor0-187
      do 17 j=1,1000                                                    cor0-188
      c2=b7+x1(m)/b9                                                    cor0-189
      a9=(a7**2+c2**2)*b9                                               cor0-190
      c1=a7/a9                                                          cor0-191
      c2=-c2/a9                                                         cor0-192
      c3=-(c2*x1(m)+1.d0)*a8-c1*x1(m)*b8                                cor0-193
      c4=c1*x1(m)*a8-b8*(c2*x1(m)+1.d0)                                 cor0-194
      a7=1.d0+c1*(b4+b9)-c2*x2(m)                                       cor0-195
      b7=c1*x2(m)+(b4+b9)*c2                                            cor0-196
      a9=a7**2+b7**2                                                    cor0-197
      a7=a7/a9                                                          cor0-198
      b7=-b7/a9                                                         cor0-199
      a8=(a7-1.d0)*c3-b7*c4                                             cor0-200
      b8=(a7-1.d0)*c4+b7*c3                                             cor0-201
      b9=b9+1.d0                                                        cor0-202
      if (dabs(c3)+dabs(c4)+dabs(a8)+dabs(b8).lt.1.d-12*(dabs(b6)+dabs(acor0-203
     16))) go to 18                                                     cor0-204
      a6=a6+a8+c3                                                       cor0-205
   17 b6=b6+b8+c4                                                       cor0-206
   18 x5(m)=0.d0                                                        cor0-207
      x5(m+2)=0.d0                                                      cor0-208
      j=j+1                                                             cor0-209
c direct computation of pade approximant for more precision             cor0-210
      do 19 k=1,j                                                       cor0-211
      c1=1.d0+b9*x5(m)                                                  cor0-212
      c2=b9*x5(m+2)                                                     cor0-213
      a9=c1**2+c2**2                                                    cor0-214
      b9=b9-1.d0                                                        cor0-215
      a7=((b4+b9)*c1+x2(m)*c2)/a9                                       cor0-216
      b7=x1(m)+(c1*x2(m)-c2*(b4+b9))/a9                                 cor0-217
      a9=a7**2+b7**2                                                    cor0-218
      x5(m)=a7/a9                                                       cor0-219
   19 x5(m+2)=-b7/a9                                                    cor0-220
      go to 21                                                          cor0-221
c taylor expansion of confluent hypergeometric function                 cor0-222
   20 if (i.eq.1) go to 23                                              cor0-223
      a7=1.d0+x1(m)*x5(m+2)                                             cor0-224
      b7=-x1(m)*x5(m)                                                   cor0-225
      a9=((b4-1.d0)**2+x2(m)**2)                                        cor0-226
      x5(m)=(a7*(b4-1.d0)+x2(m)*b7)/a9                                  cor0-227
      x5(m+2)=(b7*(b4-1.d0)-x2(m)*a7)/a9                                cor0-228
   21 if (i.eq.1) go to 23                                              cor0-229
c storage of integrals to a factor r in y(j,m)                          cor0-230
c  j=1 and j=2  real and imaginary parts of integral of h0(ei)*h0(ef)   cor0-231
c  j=3 and j=4  real and imaginary parts of integral of h1(ei)*h1(ef)   cor0-232
c  m=1 and m=2 for h*h   m=3 and m=4 for h*h*                           cor0-233
c  m=1 and m=3 for 1/r   m=2 and m=4 for 1/r**2                         cor0-234
      do 22 j=1,2                                                       cor0-235
      a6=c(1,j,m)*x4(m)-c(2,j,m)*x4(m+2)                                cor0-236
      b6=c(1,j,m)*x4(m+2)+c(2,j,m)*x4(m)                                cor0-237
      a5=dmax1(a5,a6**2+b6**2)                                          cor0-238
      y(2*j-1,2*m-1)=y(2*j-1,2*m-1)+a6                                  cor0-239
      y(2*j,2*m-1)=y(2*j,2*m-1)+b6                                      cor0-240
      a3=dmax1(a3,y(2*j-1,2*m-1)**2+y(2*j,2*m-1)**2)                    cor0-241
      a6=c(1,j,m)*x5(m)-c(2,j,m)*x5(m+2)                                cor0-242
      b6=c(1,j,m)*x5(m+2)+c(2,j,m)*x5(m)                                cor0-243
      b5=dmax1(b5,a6**2+b6**2)                                          cor0-244
      y(2*j-1,2*m)=y(2*j-1,2*m)+a6                                      cor0-245
      y(2*j,2*m)=y(2*j,2*m)+b6                                          cor0-246
   22 b3=dmax1(b3,y(2*j-1,2*m)**2+y(2*j,2*m)**2)                        cor0-247
   23 continue                                                          cor0-248
      if (i.ne.1.and.a5.lt.a3*1.d-30.and.b5.lt.b3*1.d-30) go to 25      cor0-249
   24 continue                                                          cor0-250
   25 a1=2.d0*rm                                                        cor0-251
c transformation from h(+/-) to f and g                                 cor0-252
      do 26 i=1,4                                                       cor0-253
      cc(1,i)=(y(2*i-1,3)-y(2*i-1,1))/a1                                cor0-254
      cc(4,i)=(y(2*i-1,3)+y(2*i-1,1))/a1                                cor0-255
      cc(3,i)=(y(2*i,1)+y(2*i,3))/a1                                    cor0-256
   26 cc(2,i)=(y(2*i,1)-y(2*i,3))/a1                                    cor0-257
      if (rm.eq.rs) go to 32                                            cor0-258
c if rm is not rs, 40 points gauss integration from rs to rm            cor0-259
c each gauss integration is for variation of r less than 20.            cor0-260
      il=1+idint(dabs(rm-rs)*.05d0)                                     cor0-261
      a1=dfloat(il)                                                     cor0-262
      a1=(rm-rs)/a1                                                     cor0-263
      a2=rm                                                             cor0-264
      do 31 it=1,il                                                     cor0-265
      a3=a2-a1                                                          cor0-266
      do 30 ii=1,40                                                     cor0-267
      i=min0(ii,41-ii)                                                  cor0-268
      a4=absc(i)                                                        cor0-269
      if (i.ne.ii) a4=1.d0-a4                                           cor0-270
      a5=a3+a1*a4                                                       cor0-271
      call fcou(1,ei,a5/fs,y,y(1,3),y(3,1),y(3,3),ie,x1)                cor0-272
      call fcou(1,ef,a5*fs,y(1,2),y(1,4),y(3,2),y(3,4),ie,x1)           cor0-273
      do 29 m=1,2                                                       cor0-274
      do 28 j=1,2                                                       cor0-275
      do 27 l=1,2                                                       cor0-276
      a6=p(i)*y(2*j+m-2,1)*y(2*l+m-2,2)/a5*a1                           cor0-277
      cc(2*l+j-2,m)=cc(2*l+j-2,m)+a6                                    cor0-278
   27 cc(2*l+j-2,m+2)=cc(2*l+j-2,m+2)+a6/a5                             cor0-279
   28 continue                                                          cor0-280
   29 continue                                                          cor0-281
   30 continue                                                          cor0-282
   31 a2=a3                                                             cor0-283
   32 return                                                            cor0-284
      end                                                               cor0-285
c 29/02/04                                                      ecis03  corz-000
      subroutine corz(xi,xf,t,fgi,fgf,lm1,lm2,lm,w)                     corz-001
c    computation of the integrals from 1 to infinity of products of     corz-002
c regular or irregular bessel functions of same l-value and argument    corz-003
c xi*r and xf*r respectively, divided by r**3 for l=1 to lm, and of     corz-004
c integrals from 0 to infinity of regular functions of these arguments  corz-005
c divided by r**3.                                                      corz-006
c    the limit of stability of the upwards recurrence has               corz-007
c     been found to be   lm2*(1-xi/xf) < 3 .                            corz-008
c input variables:                                                      corz-009
c     xi,xf   wave numbers multiplied by the matching radius            corz-010
c     fgi,fgf regular and irregular bessel functions.                   corz-011
c     lm1     maximum number of integrals from 1 to infinity.           corz-012
c     lm2     number of integrals from 0 to infinity.                   corz-013
c     lm      actual number of integrals from 1 to infinity.            corz-014
c output variables:                                                     corz-015
c     w       integrals from 1 to infinity.                             corz-016
c     t       integrals from 0 to infinity.                             corz-017
c***********************************************************************corz-018
      implicit real*8 (a-h,o-z)                                         corz-019
      dimension w(lm1,4),fgi(lm1,3),fgf(lm1,3),t(3),b(4),c(2),d(2)      corz-020
c integrals from 0 to infinity.                                         corz-021
c the recurrence relation starts from l=0 with l*(0,3;l)=1/3 for l=0    corz-022
      t(1)=1.d0/3.d0                                                    corz-023
      if (xi.ne.xf) go to 2                                             corz-024
c when ki=kf   (0,3;l)=1/(2*l*(l+1))                                    corz-025
      a1=0.d0                                                           corz-026
      do 1 i=2,lm2                                                      corz-027
      a1=a1+1.d0                                                        corz-028
    1 t(i)=.5d0/(a1*(a1+1.d0))                                          corz-029
      go to 11                                                          corz-030
    2 x=xi/xf                                                           corz-031
      if (x.gt.1.d0) x=1.d0/x                                           corz-032
c (0,3;l) = x**l gt(1/2) gt(l+1)/2/gt(l+3/2) 2f1(l,-1/2;l+3/2;x**2)     corz-033
      if (x.ge..9d0) go to 4                                            corz-034
c direct expansion of the 2f1 function                                  corz-035
      a1=x**2                                                           corz-036
      t(2)=x/3.d0                                                       corz-037
      a2=t(2)                                                           corz-038
      a3=0.d0                                                           corz-039
      do 3 j=1,2000                                                     corz-040
      a3=a3+1.d0                                                        corz-041
      a2=a2*a1*(a3-1.5d0)/(a3+1.5d0)                                    corz-042
      t(2)=t(2)+a2                                                      corz-043
      if (dabs(a2).lt.1.d-15*dabs(t(2))) go to 6                        corz-044
    3 continue                                                          corz-045
      go to 6                                                           corz-046
c analytic continuation of the 2f1 function - erdelyi,.... 15.3.11      corz-047
    4 a1=1.d0-x**2                                                      corz-048
      a2=x*a1**2/16.d0                                                  corz-049
      a3=dlog(a1/4.d0)+2.d0                                             corz-050
      t(2)=x*(2.d0+a1)/8.d0+a2*a3                                       corz-051
      a4=0.d0                                                           corz-052
      do 5 j=1,2000                                                     corz-053
      a4=a4+1.d0                                                        corz-054
      a3=a3-.5d0/((a4+.5d0)*a4)                                         corz-055
      a2=a2*a1*(a4+.5d0)/a4                                             corz-056
      a5=a2*a3                                                          corz-057
      t(2)=t(2)+a5                                                      corz-058
      if (dabs(a5).lt.1.d-15*dabs(t(2))) go to 6                        corz-059
    5 continue                                                          corz-060
c recurrence relation for  (0,3;l) :                                    corz-061
c  2*(l-1)*(0,3;l-1)-(2*l+1)*(x+1/x)*(0,3;l)+2*(l+2)*(0,3;l+1)=0        corz-062
c upwards recurrence                                                    corz-063
    6 a1=x+1.d0/x                                                       corz-064
      xx=lm2*(1-x)                                                      corz-065
      if (xx.gt.3.d0) go to 8                                           corz-066
      t(3)=.5d0*(a1*t(2)-t(1))                                          corz-067
      a2=0.d0                                                           corz-068
      do 7 i=4,lm2                                                      corz-069
      a2=a2+1.d0                                                        corz-070
    7 t(i)=((a2+1.5d0)*a1*t(i-1)-a2*t(i-2))/(a2+3.d0)                   corz-071
      go to 11                                                          corz-072
c downwards recurrence                                                  corz-073
    8 lk=4*lm2                                                          corz-074
      a2=dfloat(lk-1)                                                   corz-075
      a3=a2/(a2+2.d0)                                                   corz-076
      do 9 i=3,lk                                                       corz-077
      j=lk-i+3                                                          corz-078
      a2=a2-1.d0                                                        corz-079
      a3=a2/((a2+1.5d0)*a1-(a2+3.d0)*a3)                                corz-080
      if (j.le.lm2) t(j)=a3                                             corz-081
    9 continue                                                          corz-082
      do 10 i=3,lm2                                                     corz-083
   10 t(i)=t(i)*t(i-1)                                                  corz-084
   11 b(1)=xi+xf                                                        corz-085
      b(2)=xi-xf                                                        corz-086
c computation of the integrals from 1 to infinity of exp(i*b*r)/r**3 dr corz-087
      do 17 i=1,2                                                       corz-088
      if (b(i).lt.5.d0) go to 13                                        corz-089
c use of pade approximant                                               corz-090
      a1=0.d0                                                           corz-091
      a2=0.d0                                                           corz-092
      a3=21.d0                                                          corz-093
      do 12 j=1,20                                                      corz-094
      a3=a3-1.d0                                                        corz-095
      a2=a2-b(i)                                                        corz-096
      b1=a1**2+a2**2                                                    corz-097
      b2=a1*a3/b1+1.d0                                                  corz-098
      b3=-a2*a3/b1                                                      corz-099
      b1=b2**2+b3**2                                                    corz-100
      a1=b2*(a3+2.d0)/b1                                                corz-101
   12 a2=-b3*(a3+2.d0)/b1                                               corz-102
      a2=a2-b(i)                                                        corz-103
      b1=a1**2+a2**2                                                    corz-104
      c(i)=(dcos(b(i))*a1+dsin(b(i))*a2)/b1                             corz-105
      d(i)=(dsin(b(i))*a1-dcos(b(i))*a2)/b1                             corz-106
      go to 17                                                          corz-107
   13 if (b(i).eq.0.d0) go to 16                                        corz-108
c use of the taylor expansion                                           corz-109
      a1=dabs(b(i))                                                     corz-110
      c(i)=.5d0*(1.d0-a1**2*(.922784335098467d0-dlog(a1)))              corz-111
      d(i)=a1*(1.d0-.78539816339744831d0*a1)                            corz-112
      a2=a1**2/2.d0                                                     corz-113
      a3=0.d0                                                           corz-114
      do 14 j=2,20                                                      corz-115
      a3=a3+1.d0                                                        corz-116
      a2=a2*a1/(2.d0*a3+1.d0)                                           corz-117
      d(i)=d(i)+a2/(2.d0*a3-1.d0)                                       corz-118
      a2=-a2*a1/(2.d0*a3+2.d0)                                          corz-119
      c(i)=c(i)+a2/(2.d0*a3)                                            corz-120
      if (dabs(a2).lt.1.d-16) go to 15                                  corz-121
   14 continue                                                          corz-122
   15 if (a1.ne.b(i)) d(i)=-d(i)                                        corz-123
      go to 17                                                          corz-124
   16 c(i)=.5d0                                                         corz-125
      d(i)=0.d0                                                         corz-126
   17 continue                                                          corz-127
c storage of the two first integrals                                    corz-128
      a1=2.d0*xi*xf                                                     corz-129
      do 18 i=1,2                                                       corz-130
      w(i,1)=(c(2)-c(1))/a1                                             corz-131
      w(i,2)=(d(1)-d(2))/a1                                             corz-132
      w(i,3)=(d(1)+d(2))/a1                                             corz-133
      w(i,4)=(c(2)+c(1))/a1                                             corz-134
      if (i.eq.2) go to 18                                              corz-135
      c(1)=c(1)*b(2)**2+dcos(b(1))+b(1)*dsin(b(1))                      corz-136
      d(1)=d(1)*b(2)**2+dsin(b(1))-b(1)*dcos(b(1))                      corz-137
      c(2)=c(2)*b(1)**2+dcos(b(2))+b(2)*dsin(b(2))                      corz-138
      d(2)=d(2)*b(1)**2+dsin(b(2))-b(2)*dcos(b(2))                      corz-139
      a1=2.d0*a1**2                                                     corz-140
   18 continue                                                          corz-141
c upwards recurrence                                                    corz-142
      a1=xi/xf+xf/xi                                                    corz-143
      a2=2.d0*xi*xf                                                     corz-144
      a3=2.d0                                                           corz-145
      do 20 j=3,lm                                                      corz-146
      a3=a3+1.d0                                                        corz-147
      b(2)=(fgi(j-2,3)*fgf(j-2,1)-fgi(j,3)*fgf(j,1))/a2                 corz-148
      b(3)=(fgi(j-2,1)*fgf(j-2,3)-fgi(j,1)*fgf(j,3))/a2                 corz-149
      b(4)=(fgi(j-2,3)*fgf(j-2,3)-fgi(j,3)*fgf(j,3))/a2                 corz-150
      do 19 i=2,4                                                       corz-151
   19 w(j,i)=((a3-1.5d0)*a1*w(j-1,i)-(a3-3.d0)*w(j-2,i)-b(i))/a3        corz-152
   20 continue                                                          corz-153
      ln=max0(lm,idint(dmax1(xi,xf)))+50                                corz-154
      b2=0.d0                                                           corz-155
      b3=0.d0                                                           corz-156
      c2=0.d0                                                           corz-157
      c3=1.d-15                                                         corz-158
      d2=0.d0                                                           corz-159
      d3=1.d-15                                                         corz-160
      a3=ln                                                             corz-161
      do 24 i=2,ln                                                      corz-162
      j=ln-i+2                                                          corz-163
      a3=a3-1.d0                                                        corz-164
      b1=b2                                                             corz-165
      b2=b3                                                             corz-166
      c1=c2                                                             corz-167
      c2=c3                                                             corz-168
      d1=d2                                                             corz-169
      d2=d3                                                             corz-170
      c3=(2.d0*a3+3.d0)*c2/xi-c1                                        corz-171
      d3=(2.d0*a3+3.d0)*d2/xf-d1                                        corz-172
      b3=((a3+1.5d0)*a1*b2-(a3+3.d0)*b1-(c3*d3-c1*d1)/a2)/a3            corz-173
      if (j.le.lm) w(j,1)=b3                                            corz-174
      if (d3.lt.1.d15) go to 21                                         corz-175
      d2=d2*1.d-30                                                      corz-176
      d3=d3*1.d-30                                                      corz-177
      go to 22                                                          corz-178
   21 if (c3.lt.1.d15) go to 24                                         corz-179
      c2=c2*1.d-30                                                      corz-180
      c3=c3*1.d-30                                                      corz-181
   22 b2=b2*1.d-30                                                      corz-182
      b3=b3*1.d-30                                                      corz-183
      if (j.gt.lm) go to 24                                             corz-184
      do 23 k=j,lm                                                      corz-185
   23 w(k,1)=w(k,1)*1.d-30                                              corz-186
   24 continue                                                          corz-187
      a1=fgi(2,1)*fgf(2,1)/(c3*d3)                                      corz-188
      do 25 i=2,lm                                                      corz-189
   25 w(i,1)=w(i,1)*a1+t(i)                                             corz-190
      return                                                            corz-191
      end                                                               corz-192
c 29/02/04                                                      ecis03  redm-000
      subroutine redm(niv,iq,t,ipi,ncoll,it,nbeta,beta,nbt1,iph,nvar,varredm-001
     1,nva,iqmax,nspin,fac,nfa,npp,im,idt,lo)                           redm-002
c reduced nuclear matrix elements                                       redm-003
c input variables: ipi(i,j):parity of nuclear states for j=1            redm-004
c                          multiplicity of the part. and target for j=2,redm-005
c                  ncoll:  number of coupled states                     redm-006
c                  nbeta,beta:  deformations, equivalent by call        redm-007
c                  nbt1:   number of phonons                            redm-008
c                  iph:    used for vibrational model    see vibm       redm-009
c                  nvar,var:    parameters for some models              redm-010
c                  nva:    number of these parameters                   redm-011
c                  iqmax,nspin: see rotm                                redm-012
c                  fac,nfa: table of log of factorials and their number redm-013
c                  npp:    number of optical potentials                 redm-014
c                  idt:    length available in this subroutine          redm-015
c                  lo:     logical controls                             redm-016
c output variables:im:     number of nuclear multipoles                 redm-017
c                  niv(i1,i2,k): first i of t(3,i) for the pair of      redm-018
c             nuclear states i1,i2 for k=1 and last one for k=2         redm-019
c                  iq(6,i),t(3,i) are equivalent by call                redm-020
c             - the first 6*"it" data (for a given i) are               redm-021
c               1) reference to table of form factors                   redm-022
c               2) reference to table of angular momenta                redm-023
c               3) address of the associated spin-orbit form factor or 0redm-024
c               4) unused                                               redm-025
c               5-6) the reduced nuclear matrix element multiplied by   redm-026
c                (-)**(l/2) where l is the transferred angular momentum redm-027
c             - the next 3*"im" data are table of angular momenta       redm-028
c               1) l  transferred angular momentum                      redm-029
c               2) 2*s where s is the transfer of spin                  redm-030
c               3) 2*j where j is the transfer of total spin or 0 if s=0redm-031
c             - the following 7*"intc" are the table ivy of form factor redm-032
c                     independent of dispersion relations.              redm-033
c               1) form factor control number                           redm-034
c               2) reference to the table of multipoles                 redm-035
c               3) 0 or address of the first spin-orbit form factor     redm-036
c               4) 0 or address of temporary coulomb form factor        redm-037
c               5) 0 or address of temporary coulomb spin-orbit         redm-038
c               6) 0 or address of correction term (positive for        redm-039
c                       corrected term, negative for correction term)   redm-040
c               7) angular momentum                                     redm-041
c             - the following 4*"intv" are the table ivz of form factor redm-042
c                     dependent of dispersion relations.                redm-043
c               1) address of computation (without dispersion relations)redm-044
c               2) form factor control number with respect to dispersionredm-045
c               3) 0 or address of the first spin-orbit form factor     redm-046
c               4) angular momentum                                     redm-047
c in common /pote1/ related to computation of potentials and table ivy  redm-048
c                  itx(16):starting address of different form factors.  redm-049
c                      for schroed. equation, itx(i)+1 is the starting  redm-050
c                      address of the potential read in extp with ityp=iredm-051
c                      for dirac equations, itx(1)=0                    redm-052
c                      itx(2)+1=address off first transition form factorredm-053
c                      itx(7)=address of last transition form factor    redm-054
c                      itx(3)=address of last temporary central poten.  redm-055
c                      itx(4)=itx(7)-24,itx(5)=itx(3)-11,itx(6)=itx(2)-4redm-056
c       all are used for schroedinger, the first 8 for dirac            redm-057
c                  imax:   maximum angular momentum                     redm-058
c                  intc:   number of form factors without deformed      redm-059
c                             spin-orbit including correction terms     redm-060
c                  inls:   number of spin-orbit form factors not taking redm-061
c                             into account multiplication by 2.         redm-062
c                  invc:   number of coulomb transition form factors    redm-063
c                  invd:   idem for coulomb spin-orbit                  redm-064
c                  itxm:   total number of form factors                 redm-065
c in common /pote2/ related to use of potentials and table ivz          redm-066
c                  ity(8):starting address of real and imaginary,       redm-067
c                      central and spin-orbit, potential and transition redm-068
c                      form factors for schroedinger equations.         redm-069
c       all are used for schroedinger, ity(2) and ity(5) only for dirac redm-070
c                  invt:   number of form factors without deformed      redm-071
c                             spin-orbit and correction terms           redm-072
c                  intv:   same as invt, taking into account dispersion redm-073
c                  insl:   same as inls, without correction terms       redm-074
c                  npx:    same as npp, taking into account dispersion  redm-075
c if lo(15)=.true. the reduced matrix elements are read at the first    redm-076
c call and the parameters "var" are not used - in any case where "var"  redm-077
c are not used,the subroutine is skipped.                               redm-078
c if lo(61)=.true. the matrix elements are punched at the last call     redm-079
c of a search in this subroutine.                                       redm-080
c***********************************************************************redm-081
      implicit real*8 (a-h,o-z)                                         redm-082
      logical lo(250),lt                                                redm-083
      dimension iph(2,ncoll),niv(ncoll,ncoll,2),beta(9,nbt1),nbeta(18,nbredm-084
     1t1),fac(nfa),var(nva),nvar(2,1),ipi(11,1),iq(6,1),t(3,1)          redm-085
      common /pote1/ itx(16),imax,intc,inls,invc,invd,itxm              redm-086
      common /pote2/ ity(8),invt,intv,insl,npx                          redm-087
      common /inout/ mr,mw,ms                                           redm-088
      if (lo(220)) go to 42                                             redm-089
      if (lo(7).or.lo(15)) go to 3                                      redm-090
c standard computation of the reduced matrix elements in t(3,i)         redm-091
c with form factor identification in iq(1,i), multipole in iq(2,i)      redm-092
c and 0 or 1 in iq(3,i) if spin-orbit is not or is deformed.            redm-093
c they are called at the first run or if "var" has been changed         redm-094
      if (lo(1)) go to 1                                                redm-095
      call vibm(niv,iq,t,ipi,ncoll,it,iph,nvar,var,nva,nbeta,nbt1,fac,nfredm-096
     1a,idt,lo)                                                         redm-097
      go to 17                                                          redm-098
    1 if (lo(3)) go to 2                                                redm-099
      call rotm(niv,iq,t,ipi,ncoll,iph,nbeta,nvar,var,nva,it,iqmax,nspinredm-100
     1,fac,nfa,idt,lo)                                                  redm-101
      go to 17                                                          redm-102
    2 call roam(niv,iq,t,ipi,ncoll,it,beta,iph,var,var(nva+1),iqmax,fac,redm-103
     1nfa,idt,lo)                                                       redm-104
      go to 17                                                          redm-105
c input of nuclear matrix elements from cards                           redm-106
    3 if (lo(217)) go to 42                                             redm-107
      it=0                                                              redm-108
      i=0                                                               redm-109
      nps=1                                                             redm-110
      if ((lo(201).and.lo(203)).or.lo(113)) nps=0                       redm-111
      do 16 i1=1,ncoll                                                  redm-112
      do 15 i2=i1,ncoll                                                 redm-113
      niv(i1,i2,1)=it+1                                                 redm-114
      read (mr,1000) j1,j2,k                                            redm-115
      write (mw,1001) j1,j2,k                                           redm-116
      if ((j1.ne.i1).or.(j2.ne.i2)) go to 46                            redm-117
      if (k.eq.0) go to 15                                              redm-118
      ijl=iabs(ipi(3,i1)-ipi(3,i2))                                     redm-119
      jil=(ipi(3,i1)+ipi(3,i2))                                         redm-120
      ijs=iabs(ipi(2,i1)-ipi(2,i2))                                     redm-121
      jis=ipi(2,i1)+ipi(2,i2)                                           redm-122
      if (2*(it+k).gt.idt) call memo('redm',idt,2*(it+k),2)             redm-123
      do 14 k1=1,k                                                      redm-124
      it=it+1                                                           redm-125
      read (mr,1002) j,iq(2,it),nn,m,t(3,it)                            redm-126
      if (nn.eq.-1.and.lo(111)) go to 47                                redm-127
      n=nn                                                              redm-128
      if (nn.eq.-1) n=0                                                 redm-129
      if (mod(iq(2,it)+ipi(1,i1)+ipi(1,i2),2).ne.0) go to 48            redm-130
      if ((n.gt.jis).or.(n.lt.ijs).or.(mod(jis+n,2).ne.0)) go to 49     redm-131
      if (lo(7)) go to 7                                                redm-132
      if (lo(1)) go to 5                                                redm-133
      if (lo(3)) go to 4                                                redm-134
      iqp=j/(nbt1+1)                                                    redm-135
      ipq=mod(j,nbt1+1)                                                 redm-136
      if ((ipq.le.0).or.(max0(ipq,iqp).gt.nbt1).or.(iqp.lt.0)) go to 50 redm-137
      go to 11                                                          redm-138
    4 if (j.lt.0.or.j.gt.3) go to 51                                    redm-139
      go to 11                                                          redm-140
    5 iqp=j/1000                                                        redm-141
      if (lo(3)) go to 6                                                redm-142
      if (iqp.ne.1+iq(2,it)) go to 52                                   redm-143
      go to 11                                                          redm-144
    6 iqy=iq(2,it)/2+1                                                  redm-145
      iqz=(iqy*(iqy-1))/2                                               redm-146
      if (iqp.le.iqz.or.iqp.gt.iqz+iqy) go to 53                        redm-147
      go to 11                                                          redm-148
    7 if (j.eq.0) go to 10                                              redm-149
      if (iabs(j)-i-1) 8 , 10 , 54                                      redm-150
    8 if (it.eq.1) go to 11                                             redm-151
      do 9 ii=2,it                                                      redm-152
      if (j.eq.iq(1,ii-1)) go to 11                                     redm-153
    9 continue                                                          redm-154
      go to 55                                                          redm-155
   10 i=i+1                                                             redm-156
      if (j.eq.0) j=i                                                   redm-157
   11 iq(1,it)=j                                                        redm-158
      if (n.eq.0) go to 12                                              redm-159
      if (2*iq(2,it).lt.iabs(n-m).or.2*iq(2,it).gt.n+m.or.mod(n+m,2).ne.redm-160
     10) go to 56                                                       redm-161
      nm=m                                                              redm-162
      iq(3,it)=10*m+10000*n                                             redm-163
      go to 13                                                          redm-164
   12 if ((m.lt.0).or.(m.gt.nps)) go to 57                              redm-165
      iq(3,it)=10*m                                                     redm-166
      nm=2*iq(2,it)                                                     redm-167
   13 if (nm.lt.ijl.or.nm.gt.jil) go to 58                              redm-168
      if (nn.eq.-1) iq(3,it)=iq(3,it)+1                                 redm-169
   14 write (mw,1003) iq(1,it),iq(2,it),nn,m,t(3,it)                    redm-170
   15 niv(i1,i2,2)=it                                                   redm-171
   16 continue                                                          redm-172
   17 k=niv(ncoll,ncoll,2)                                              redm-173
      do 19 i1=1,ncoll                                                  redm-174
      do 18 i2=i1,ncoll                                                 redm-175
      niv(i2,i1,1)=niv(i1,i2,1)                                         redm-176
      niv(i2,i1,2)=niv(i1,i2,2)                                         redm-177
   18 continue                                                          redm-178
   19 continue                                                          redm-179
c check that there is enough place                                      redm-180
      if (7*it.gt.idt) call memo('redm',idt,7*it,2)                     redm-181
      im=0                                                              redm-182
      invt=0                                                            redm-183
      intv=0                                                            redm-184
      inls=0                                                            redm-185
      insl=0                                                            redm-186
      invc=0                                                            redm-187
      invd=0                                                            redm-188
      intc=0                                                            redm-189
      imax=0                                                            redm-190
c table of multipoles                                                   redm-191
      if (it.eq.0) go to 40                                             redm-192
      itn=6*it                                                          redm-193
      do 23 j=1,it                                                      redm-194
      is=iq(3,j)/10000                                                  redm-195
      ij=mod(iq(3,j),1000)/10                                           redm-196
      il=mod(iq(3,j),10)                                                redm-197
      if (is.eq.0) ij=2*iq(2,j)                                         redm-198
      if (ij.eq.0) is=2*iq(2,j)                                         redm-199
      if (il.eq.1) is=-2                                                redm-200
      if (is.ne.0) iq(3,j)=0                                            redm-201
      if (im.eq.0) go to 21                                             redm-202
      do 20 k=1,im,3                                                    redm-203
      if ((iq(itn+k,1).eq.iq(2,j)).and.(iq(itn+k+1,1).eq.is).and.(iq(itnredm-204
     1+k+2,1).eq.ij)) go to 22                                          redm-205
   20 continue                                                          redm-206
   21 iq(itn+im+1,1)=iq(2,j)                                            redm-207
      iq(itn+im+2,1)=is                                                 redm-208
      iq(itn+im+3,1)=ij                                                 redm-209
      imax=max0(imax,iq(2,j))                                           redm-210
      im=im+3                                                           redm-211
      iq(2,j)=im/3                                                      redm-212
      go to 23                                                          redm-213
   22 iq(2,j)=1+k/3                                                     redm-214
   23 continue                                                          redm-215
      itm=itn+im+mod(im,2)                                              redm-216
c table of form factors                                                 redm-217
c lt is true if the multipole order matters for form factors            redm-218
      lt=(lo(1).or.lo(11).or.lo(17).or.lo(19)).and.lo(107)              redm-219
      do 26 j=1,it                                                      redm-220
      if (invt.eq.0) go to 25                                           redm-221
      do 24 l=1,invt,7                                                  redm-222
      if (iq(itm+l,1).ne.iq(1,j)) go to 24                              redm-223
      if (lt.and.(iq(itm+l+1,1).ne.iq(2,j))) go to 24                   redm-224
      iq(1,j)=1+l/7                                                     redm-225
      iq(itm+l+2,1)=max0(iq(3,j),iq(itm+l+2,1))                         redm-226
      go to 26                                                          redm-227
   24 continue                                                          redm-228
   25 k=iq(2,j)                                                         redm-229
      k1=iq(itn+3*k-2,1)                                                redm-230
      iq(itm+invt+1,1)=iq(1,j)                                          redm-231
      iq(itm+invt+2,1)=k                                                redm-232
      iq(itm+invt+3,1)=iq(3,j)                                          redm-233
      iq(itm+invt+4,1)=0                                                redm-234
      iq(itm+invt+5,1)=0                                                redm-235
      iq(itm+invt+6,1)=0                                                redm-236
      iq(itm+invt+7,1)=k1                                               redm-237
      if ((iq(1,j).lt.0).or.((iq(1,j).gt.1000).and.(k1.le.1).and.(mod(iqredm-238
     1(1,j),1000).ne.0))) iq(itm+invt+6,1)=1                            redm-239
      if (lo(11).and.(mod(iq(itn+3*k-1,1),2).eq.0)) iq(itm+invt+4,1)=1  redm-240
      if (lo(19)) iq(itm+invt+5,1)=iq(itm+invt+3,1)                     redm-241
      invt=invt+7                                                       redm-242
      iq(1,j)=invt/7                                                    redm-243
   26 continue                                                          redm-244
c search on correction terms                                            redm-245
      intc=invt                                                         redm-246
      do 28 j=1,invt,7                                                  redm-247
      if (iq(itm+j+5,1).eq.0) go to 28                                  redm-248
      k1=itm+j-1                                                        redm-249
      do 27 l=1,7                                                       redm-250
   27 iq(itm+intc+l,1)=iq(k1+l,1)                                       redm-251
      iq(itm+intc+6,1)=-(1+j/7)                                         redm-252
      intc=intc+7                                                       redm-253
      iq(k1+6,1)=intc/7                                                 redm-254
   28 continue                                                          redm-255
      do 30 j=1,intc,7                                                  redm-256
      if (iq(itm+j+3,1).eq.0) go to 29                                  redm-257
      invc=invc+1                                                       redm-258
      iq(itm+j+3,1)=invc                                                redm-259
   29 if ((iq(itm+j+2,1).eq.0).and.(iq(itm+j+4,1).eq.0)) go to 30       redm-260
      inls=inls+1                                                       redm-261
      iq(itm+j+2,1)=inls                                                redm-262
      if (iq(itm+j+4,1).eq.0) go to 30                                  redm-263
      invd=invd+1                                                       redm-264
      iq(itm+j+4,1)=invd                                                redm-265
   30 continue                                                          redm-266
      itp=itm+intc+mod(intc,2)                                          redm-267
      ntc=invt/7                                                        redm-268
      do 31 j=1,ntc                                                     redm-269
      iq(itp+4*j-3,1)=j                                                 redm-270
      iq(itp+4*j-2,1)=0                                                 redm-271
      iq(itp+4*j-1,1)=iq(itm+7*j-4,1)                                   redm-272
      iq(itp+4*j,1)=iq(itm+7*j,1)                                       redm-273
   31 continue                                                          redm-274
      intv=4*ntc                                                        redm-275
      if (lo(120)) go to 37                                             redm-276
      do 36 i1=1,ncoll                                                  redm-277
      do 35 i2=i1,ncoll                                                 redm-278
      k1=niv(i1,i2,1)                                                   redm-279
      k2=niv(i1,i2,2)                                                   redm-280
      if (k1.gt.k2) go to 35                                            redm-281
      kk=i1*(ncoll+1)+i2                                                redm-282
      do 34 k=k1,k2                                                     redm-283
      j=iq(1,k)                                                         redm-284
      if (iq(itp+4*j-2,1).ne.0) go to 32                                redm-285
      iq(itp+4*j-2,1)=kk                                                redm-286
      go to 34                                                          redm-287
   32 do 33 l=1,4                                                       redm-288
   33 iq(itp+intv+l,1)=iq(itp+4*j+l-4,1)                                redm-289
      iq(itp+intv+2,1)=kk                                               redm-290
      intv=intv+4                                                       redm-291
      iq(1,k)=intv/4                                                    redm-292
   34 continue                                                          redm-293
   35 continue                                                          redm-294
   36 continue                                                          redm-295
   37 im=im/3                                                           redm-296
      intv=intv/4                                                       redm-297
      invt=invt/7                                                       redm-298
      intc=intc/7                                                       redm-299
      insl=0                                                            redm-300
      do 39 j=1,intv                                                    redm-301
      l=iq(itp+4*j-1,1)                                                 redm-302
      insl=max0(insl,l)                                                 redm-303
      do 38 k=1,it                                                      redm-304
      if (iq(1,k).eq.j) iq(3,k)=l                                       redm-305
   38 continue                                                          redm-306
   39 continue                                                          redm-307
c number of real and imaginary form factors                             redm-308
   40 nv=intc                                                           redm-309
      if (lo(13).or.lo(19)) nv=nv+2*inls                                redm-310
      ity(1)=0                                                          redm-311
      lo(221)=im.eq.0                                                   redm-312
      if (lo(100)) go to 41                                             redm-313
      ity(3)=npx                                                        redm-314
      ity(5)=ity(3)+npx                                                 redm-315
      if (lo(201).and.lo(203)) ity(5)=ity(3)                            redm-316
      ity(7)=ity(5)+intv                                                redm-317
      ity(2)=ity(7)+2*insl                                              redm-318
      ity(4)=ity(2)+npx                                                 redm-319
      ity(6)=ity(4)+npx                                                 redm-320
      if (lo(201).and.lo(203)) ity(6)=ity(4)                            redm-321
      ity(8)=ity(6)+intv                                                redm-322
      if (lo(112)) ity(8)=ity(6)                                        redm-323
      itx(1)=ity(8)+2*insl                                              redm-324
      if (lo(114)) itx(1)=ity(8)                                        redm-325
      if (lo(112)) itx(1)=ity(6)                                        redm-326
      itx(5)=itx(1)+npp                                                 redm-327
      itx(9)=itx(5)+npp                                                 redm-328
      if (lo(201).and.lo(203)) itx(9)=itx(5)                            redm-329
      itx(13)=itx(9)+intc                                               redm-330
      itx(2)=itx(13)+2*inls                                             redm-331
      itx(6)=itx(2)+npp                                                 redm-332
      itx(10)=itx(6)+npp                                                redm-333
      if (lo(201).and.lo(203)) itx(10)=itx(6)                           redm-334
      itx(14)=itx(10)+intc                                              redm-335
      itx(7)=itx(14)+2*inls                                             redm-336
      if (lo(114)) itx(7)=itx(14)                                       redm-337
      if (lo(112)) itx(7)=itx(10)                                       redm-338
      itx(8)=itx(7)+npp                                                 redm-339
      itx(3)=itx(8)+npp                                                 redm-340
      itx(4)=itx(3)+npp                                                 redm-341
      itx(11)=itx(4)+npp                                                redm-342
      itx(12)=itx(11)+intc                                              redm-343
      itx(15)=itx(12)+intc                                              redm-344
      if (lo(112)) itx(15)=itx(12)                                      redm-345
      itx(16)=itx(15)+invc                                              redm-346
      itxm=itx(16)+2*invd+intc                                          redm-347
      go to 42                                                          redm-348
   41 ity(5)=0                                                          redm-349
      itx(1)=0                                                          redm-350
      itx(2)=14*ncoll                                                   redm-351
      ity(2)=itx(2)                                                     redm-352
      itx(7)=itx(2)+4*(intv+insl)                                       redm-353
      itx(3)=itx(7)+24*npp                                              redm-354
      itx(4)=itx(7)-24                                                  redm-355
      itx(5)=itx(3)-11                                                  redm-356
      itx(6)=itx(2)-4                                                   redm-357
      itxm=itx(3)+11*intc                                               redm-358
   42 if (lo(152).and.lo(161)) return                                   redm-359
c reduced matrix elements punched on cards on request                   redm-360
c output of reduced matrix elements on request                          redm-361
      it=niv(ncoll,ncoll,2)                                             redm-362
      itm=6*it-3                                                        redm-363
      itn=itm+3*im-4+mod(im,2)                                          redm-364
      if (lo(52)) write (mw,1004)                                       redm-365
      do 45 i1=1,ncoll                                                  redm-366
      do 44 i2=i1,ncoll                                                 redm-367
      k1=niv(i1,i2,1)                                                   redm-368
      k2=niv(i1,i2,2)                                                   redm-369
      if (lo(52)) write (mw,1005) i1,i2,k1,k2                           redm-370
      k=k2-k1+1                                                         redm-371
      if (lo(61)) write (61,1000) i1,i2,k                               redm-372
      if (k.eq.0) go to 44                                              redm-373
      do 43 k=k1,k2                                                     redm-374
      if (lo(52)) write (mw,1006) k,(iq(j,k),j=1,3),t(3,k)              redm-375
      if (lo(161)) go to 43                                             redm-376
      n=iq(1,k)                                                         redm-377
      m=iq(2,k)                                                         redm-378
      nm=iq(itn+7*n+1,1)                                                redm-379
      ns=iq(itm+3*m+2,1)                                                redm-380
      nj=iq(itm+3*m+3,1)                                                redm-381
      if (ns.le.0) nj=0                                                 redm-382
      if (ns.eq.-2) ns=-1                                               redm-383
      if (nj.eq.0.and.iq(3,k).ne.0) nj=1                                redm-384
      write (61,1007) nm,iq(itm+3*m+1,1),ns,nj,t(3,k)                   redm-385
   43 continue                                                          redm-386
   44 continue                                                          redm-387
   45 continue                                                          redm-388
      if (it.eq.0.or.lo(152)) return                                    redm-389
      write (mw,1008) (i,(iq(itm+3*i+j,1),j=1,3),i=1,im)                redm-390
      write (mw,1009) (i,(iq(itn+7*i+j,1),j=1,7),i=1,intc)              redm-391
      itp=itn+7*intc+3+mod(intc,2)                                      redm-392
      write (mw,1010) (i,(iq(itp+4*i+j,1),j=1,4),i=1,intv)              redm-393
      return                                                            redm-394
   46 write (mw,1011) j1,j2,i1,i2                                       redm-395
      go to 59                                                          redm-396
   47 write (mw,1012) nn                                                redm-397
      go to 59                                                          redm-398
   48 write (mw,1013) iq(2,it),ipi(1,i1),ipi(1,i2)                      redm-399
      go to 59                                                          redm-400
   49 write (mw,1014)                                                   redm-401
      go to 59                                                          redm-402
   50 write (mw,1015)                                                   redm-403
      go to 59                                                          redm-404
   51 write (mw,1016)                                                   redm-405
      go to 59                                                          redm-406
   52 write (mw,1017)                                                   redm-407
      go to 59                                                          redm-408
   53 write (mw,1018) n,ijs,jis                                         redm-409
      go to 59                                                          redm-410
   54 write (mw,1019) i,j                                               redm-411
      go to 59                                                          redm-412
   55 write (mw,1020) j                                                 redm-413
      go to 59                                                          redm-414
   56 write (mw,1021) m,iq(2,it),n                                      redm-415
      go to 59                                                          redm-416
   57 write (mw,1022) m,nps                                             redm-417
      go to 59                                                          redm-418
   58 write (mw,1023) nm,ijl,jil                                        redm-419
      go to 59                                                          redm-420
   59 write (mw,1024)                                                   redm-421
      stop                                                              redm-422
 1000 format (3i5)                                                      redm-423
 1001 format (' for i =',i4,'  and ip =',i4,i8,' reduced matrix elementsredm-424
     1')                                                                redm-425
 1002 format (4i5,f20.12)                                               redm-426
 1003 format (10x,'form factor =',i4,' l =',i4,4x,'2*s =',i4,4x,'2*j =',redm-427
     1i4,4x,' reduced matrix element',d20.6)                            redm-428
 1004 format (//' nuclear reduced matrix elements'/)                    redm-429
 1005 format (/' state',i3,'  with state',i3,10x,' from',i4,' to',i4/)  redm-430
 1006 format (10x,'n =',i3,3x,'form factor =',i3,3x,'mult. =',i3,3x,'sp.redm-431
     1-o. =',i3,6x,'matrix element',d15.6)                              redm-432
 1007 format (4i5,f20.12)                                               redm-433
 1008 format (//5x,' correspondence to multipoles'//(20x,'n =',i3,5x,'l redm-434
     1=',i3,5x,'2*s =',i3,5x,'2*j =',i3))                               redm-435
 1009 format (//4x,' correspondence to form factors in their computationredm-436
     1'//(10x,'n =',i3,4x,'f.f. =',i6,4x,'mult. =',i4,4x,'sp.-o. =',i4,4redm-437
     2x,'coul =',i4,4x,'spdo =',i4,4x,'cor =',i4,4x,'l =',i4))          redm-438
 1010 format (//4x,' correspondence to form factors in their use'//(10x,redm-439
     1'n =',i3,4x,'above =',i4,4x,'disp. =',i4,4x,'sp.-o. =',i4,4x,'l ='redm-440
     2,i4))                                                             redm-441
 1011 format (//' incorrect order of input for reduced matrix elements :redm-442
     1',2i6,' instead of',2i6)                                          redm-443
 1012 format (//' a magnetic coulomb interaction cannot be used if the credm-444
     1oulomb interaction is not deformed:',i3)                          redm-445
 1013 format (/' multipole order',i4,' not of the same parity as',2i4)  redm-446
 1014 format (' error for harmonic vibrational model')                  redm-447
 1015 format (' error for anharmonic vibrational model')                redm-448
 1016 format (' error for symmetric rotational model')                  redm-449
 1017 format (' error for asymmetric rotational model')                 redm-450
 1018 format (/' 2*s =',i4,' incorrect between channels with 2*s =',2i4)redm-451
 1019 format (/' last form factor identification',i3,'  new form factor redm-452
     1identification',i3,'  too large')                                 redm-453
 1020 format (/' last form factor identification',i3,'  was not already redm-454
     1read with this sign')                                             redm-455
 1021 format (/' 2*j =',i4,' incorrect with l =',i4,' and 2*s =',i4)    redm-456
 1022 format (/' j-value =',i4,'  used as deformed spin-orbit control inredm-457
     1correct. limit:',i2)                                              redm-458
 1023 format (/' 2*transfer of ang. momentum',i4,' not between',i4,' andredm-459
     1',i4)                                                             redm-460
 1024 format (//' in redm  ... stop ...')                               redm-461
      end                                                               redm-462
c 29/02/04                                                      ecis03  vibm-000
      subroutine vibm(niv,iq,t,ipi,ncoll,it,iph,nvar,var,nva,nbta,nbt1,fvibm-001
     1ac,nfa,idt,lo)                                                    vibm-002
c nuclear reduced matrix elements for the harmonic vibrational model    vibm-003
c the control number for form factor is i for beta(i) and i+j*(nbt1+1)  vibm-004
c for beta(i)*beta(j) with j larger than i in the harmonic vibrational  vibm-005
c model (order of derivative in the anharmonic vibrational model)       vibm-006
c for arguments niv to it and fac to lo    see redm                     vibm-007
c input variables: iph(i): number of phonons(0,1,2 phonons or 3 for     vibm-008
c             mixture of 1 and 2 phonons states)                        vibm-009
c                  iph(ncoll+i) for i=1,ncoll: address of the descrip-  vibm-010
c             tion of two phonons and mixed states which are in the samevibm-011
c             table iph for i larger than 2*ncoll.                      vibm-012
c                  nvar,var:  1 and 2 phonons mixing coefficients       vibm-013
c                  nva:  number of 1 and 2 phonons mixing coefficients  vibm-014
c                  rbta(i,j)   angular momentum of phonons for i=9      vibm-015
c                        0 for i=10 to be used in second order monopole vibm-016
c                        correction, anything not to be used            vibm-017
c                  nbt1: number of phonons                              vibm-018
c                                                                       vibm-019
c  the deformations beta and factors 1/sqrt(4*pi) are not included in   vibm-020
c the matrix elements which are computed here. the full expressions are:vibm-021
c (0||q2||0) = sum on beta**2/(4*pi) with iq=0                          vibm-022
c (0||q1||i) = (-)**i beta(i)/sqrt(4*pi) with iq=i                      vibm-023
c (i||q1||0) same value without (-)**i                                  vibm-024
c (ip||q2||i) = (-)**i beta(i)*beta(ip)*djcg(i,ip,0,0|iq,0)/(2*pi)      vibm-025
c    plus sum on beta**2*sqrt(2*i+1)/(4*pi) with iq=0 when i=ip         vibm-026
c (0||q2||l1,l2,i) = (-)**i beta(l1)*beta(l2) djcg(l1,l2,0,0|i,0)/      vibm-027
c    (2*pi*sqrt(1+delta(l1,l2)))   with iq=i                            vibm-028
c (l1,l2,i||q2||0) same value without (-)**i                            vibm-029
c (ip||q1||l1,l2,i) = (-)**iq beta(*)*(delta(iq,l1)*delta(ip,l2)+(-)**  vibm-030
c    (ip+i+iq)*delta(iq,l2)*delta(ip,l1)) * sqrt((2*i+1)/((2*iq+1)*     vibm-031
c    (1+delta(l1,l2))*sqrt(4*pi))                                       vibm-032
c (l1,l2,i||q1||ip) same expression but with (-)**ip+i+iq  in front     vibm-033
c (l3,l4,ip||q2||l1,l2,i)  sum on beta**2*(delta(l1,l3)*delta(l2,l4)+   vibm-034
c    (-)**(l1+l2-i)*delta(l1,l4)*delta(l2,l3)) * sqrt(2*ip+1)/(4*pi*sqrtvibm-035
c    ((1+delta(l1,l2))*(1+delta(l3,l4))) with iq=0,when i=ip            vibm-036
c    plus,when two phonons are identical,sum with all the possible va-  vibm-037
c    lues for iq of beta(l5)*beta(l6)*djcg(l5,l6,0,0|iq,0)*dj6j(l6,ip,  vibm-038
c    l7,i,l5,iq) * sqrt((2*i+1)*(2*ip+1))/(2*pi*sqrt((1+delta(l1,l2)*(1+vibm-039
c    delta(l3,l4))   where  l7 is the common phonon ,l5 and l6 the othervibm-040
c    phonons in i and ip, multiplied by the phase                       vibm-041
c      *(-)**(ip-l1) if l1=l3,        *(-)**(l3) if l1=l4,              vibm-042
c      *(-)**(ip+l1-i) if l2=l3,      *(-)**(l1+l3+l4-i) if l2=l4.      vibm-043
c (j||l=iq||i) is multiplied by a phase (-)**((iq+ipi(i)-ipi(j))/2)     vibm-044
c and the factors beta/sqrt(4*pi) are shifted on the form factors       vibm-045
c***********************************************************************vibm-046
      implicit real*8 (a-h,o-z)                                         vibm-047
      logical lib(4),lo(250)                                            vibm-048
      dimension iph(2,ncoll),iq(6,1),t(3,1),ipi(11,1),ia(6,4),b(4),aa(2,vibm-049
     12),var(nva),niv(ncoll,ncoll,2),fac(1),nbta(18,1),nvar(2,7)        vibm-050
      common /inout/ mr,mw,ms                                           vibm-051
      it=1                                                              vibm-052
      nsp=0                                                             vibm-053
      if (lo(13).or.lo(19)) nsp=10                                      vibm-054
      do 39 i1=1,ncoll                                                  vibm-055
      aa(1,1)=1.d0                                                      vibm-056
      aa(1,2)=0.d0                                                      vibm-057
      if (iph(1,i1).le.2) go to 1                                       vibm-058
      jvar=iph(2,i1)+1                                                  vibm-059
      ivar=nvar(2,jvar)                                                 vibm-060
      ay=1.74532925d-02*var(ivar)                                       vibm-061
      aa(1,1)=dcos(ay)                                                  vibm-062
      aa(1,2)=dsin(ay)                                                  vibm-063
      if (.not.lo(217)) write (mw,1000) i1,var(ivar),aa(1,1),aa(1,2)    vibm-064
    1 aa(2,1)=aa(1,1)                                                   vibm-065
      aa(2,2)=aa(1,2)                                                   vibm-066
      do 38 i2=i1,ncoll                                                 vibm-067
      if (i1.eq.i2) go to 2                                             vibm-068
      aa(2,1)=1.d0                                                      vibm-069
      aa(2,2)=0.d0                                                      vibm-070
      if (iph(1,i2).le.2) go to 2                                       vibm-071
      ivar=iph(2,i2)+1                                                  vibm-072
      jvar=nvar(2,ivar)                                                 vibm-073
      if (jvar.gt.nva) go to 40                                         vibm-074
      ay=1.74532925d-02*var(jvar)                                       vibm-075
      aa(2,1)=dcos(ay)                                                  vibm-076
      aa(2,2)=dsin(ay)                                                  vibm-077
    2 niv(i1,i2,1)=it                                                   vibm-078
      l1=iph(1,i1)                                                      vibm-079
      ax=aa(1,1)                                                        vibm-080
      if (l1.gt.2) l1=1                                                 vibm-081
      if (dabs(ax).lt.1.d-6) go to 27                                   vibm-082
    3 l2=iph(1,i2)                                                      vibm-083
      if (l2.gt.2) l2=1                                                 vibm-084
      ay=ax*aa(2,1)                                                     vibm-085
      if (dabs(ay).lt.1.d-6) go to 26                                   vibm-086
    4 i=l1+l2+1                                                         vibm-087
      if (i.eq.3.and.l1.ne.l2) i=6                                      vibm-088
      if (l1.gt.l2) go to 5                                             vibm-089
      j1=i1                                                             vibm-090
      j2=i2                                                             vibm-091
      go to 6                                                           vibm-092
    5 j1=i2                                                             vibm-093
      j2=i1                                                             vibm-094
c  transposition                                                        vibm-095
      ay=ay*dfloat(1-mod(ipi(3,i1)+ipi(3,i2)+2*(ipi(1,i1)+ipi(1,i2)+1),4vibm-096
     1))                                                                vibm-097
    6 go to ( 7 , 9 , 10 , 14 , 18 , 24 ) , i                           vibm-098
c  (0||q||0)                                                            vibm-099
    7 if ((ipi(3,j1).ne.1).or.(ipi(3,j2).ne.1)) go to 41                vibm-100
      if (lo(102)) go to 26                                             vibm-101
      do 8 l=1,nbt1                                                     vibm-102
      if (nbta(18,l).ne.0) go to 8                                      vibm-103
      if (2*it.gt.idt) call memo('vibm',idt,2*it,2)                     vibm-104
      iq(1,it)=l*(nbt1+2)                                               vibm-105
      iq(2,it)=0                                                        vibm-106
      iq(3,it)=nsp                                                      vibm-107
      t(3,it)=ay                                                        vibm-108
      it=it+1                                                           vibm-109
    8 continue                                                          vibm-110
      go to 26                                                          vibm-111
c  (ip||q||0)  with ip=j2                                               vibm-112
    9 if (2*it.gt.idt) call memo('vibm',idt,2*it,2)                     vibm-113
      n2=iph(2,j2)                                                      vibm-114
      if (iph(1,j2).gt.2) n2=nvar(1,n2+1)                               vibm-115
      if ((ipi(3,j2).ne.(2*nbta(17,n2)+1)).or.(ipi(3,j1).ne.1)) go to 41vibm-116
      iq(1,it)=n2                                                       vibm-117
      iq(2,it)=nbta(17,n2)                                              vibm-118
      iq(3,it)=nsp                                                      vibm-119
      t(3,it)=ay                                                        vibm-120
      if (mod(iabs(iq(2,it)+ipi(1,j1)-ipi(1,j2)),4).ne.0) t(3,it)=-t(3,ivibm-121
     1t)                                                                vibm-122
      go to 25                                                          vibm-123
c  (ip||q||i)                                                           vibm-124
   10 if (lo(102)) go to 26                                             vibm-125
      n1=iph(2,j1)                                                      vibm-126
      if (iph(1,j1).gt.2) n1=nvar(1,n1+1)                               vibm-127
      n2=iph(2,j2)                                                      vibm-128
      if (iph(1,j2).gt.2) n2=nvar(1,n2+1)                               vibm-129
      if ((ipi(3,j2).ne.(2*nbta(17,n2)+1)).or.(ipi(3,j1).ne.(2*nbta(17,nvibm-130
     11)+1))) go to 41                                                  vibm-131
      if (n1.ne.n2) go to 12                                            vibm-132
      aq=dsqrt(dfloat(2*nbta(17,n1)+1))                                 vibm-133
      do 11 l=1,nbt1                                                    vibm-134
      if (nbta(18,l).ne.0) go to 11                                     vibm-135
      if (2*it.gt.idt) call memo('vibm',idt,2*it,2)                     vibm-136
      iq(1,it)=l*(nbt1+2)                                               vibm-137
      iq(2,it)=0                                                        vibm-138
      iq(3,it)=nsp                                                      vibm-139
      t(3,it)=aq*ay                                                     vibm-140
      it=it+1                                                           vibm-141
   11 continue                                                          vibm-142
c factor 2 for non identical phonons added on the 10/03/81              vibm-143
   12 k1=iabs(nbta(17,n2)-nbta(17,n1))+1                                vibm-144
      k2=nbta(17,n2)+nbta(17,n1)+1                                      vibm-145
      fs=dfloat(2*(1-2*mod(nbta(17,n1)+iabs(ipi(1,j1)-ipi(1,j2)+k1-1)/2,vibm-146
     12)))                                                              vibm-147
      do 13 k=k1,k2,2                                                   vibm-148
      if (2*it.gt.idt) call memo('vibm',idt,2*it,2)                     vibm-149
      j=k-1                                                             vibm-150
      aq=fs*djcg(ipi(3,j1)-1,ipi(3,j2)-1,2*j,0,0,fac,nfa)               vibm-151
      iq(1,it)=max0(n1,n2)*(nbt1+1)+min0(n1,n2)                         vibm-152
      iq(2,it)=j                                                        vibm-153
      iq(3,it)=nsp                                                      vibm-154
      t(3,it)=aq*ay                                                     vibm-155
      fs=-fs                                                            vibm-156
   13 it=it+1                                                           vibm-157
      go to 26                                                          vibm-158
c  (l1,l2,ip||q||i) with i=j1 and ip=j2                                 vibm-159
   14 i=iph(2,j2)                                                       vibm-160
      lb1=nvar(1,i)                                                     vibm-161
      lb2=nvar(2,i)                                                     vibm-162
      n1=iph(2,j1)                                                      vibm-163
      if (iph(1,j1).gt.2) n1=nvar(1,n1+1)                               vibm-164
      if (ipi(3,j1).ne.(2*nbta(17,n1)+1)) go to 41                      vibm-165
      lib(1)=lb1.eq.n1                                                  vibm-166
      lib(2)=lb2.eq.n1                                                  vibm-167
      if (2*it.gt.idt) call memo('vibm',idt,2*it,2)                     vibm-168
      if (lib(1).and.lib(2)) go to 16                                   vibm-169
      if (lib(2)) go to 15                                              vibm-170
      if (.not.lib(1)) go to 26                                         vibm-171
      iq(1,it)=lb2                                                      vibm-172
      iq(2,it)=nbta(17,lb2)                                             vibm-173
      iq(3,it)=nsp                                                      vibm-174
      t(3,it)=ay*dfloat(1-2*mod(iabs(ipi(1,j1)-ipi(1,j2)+iq(2,it))/2,2))vibm-175
      go to 17                                                          vibm-176
   15 iq(1,it)=lb1                                                      vibm-177
      iq(2,it)=nbta(17,lb1)                                             vibm-178
      iq(3,it)=nsp                                                      vibm-179
      t(3,it)=ay*dfloat(1-mod(iabs(ipi(3,j1)+ipi(3,j2)-2+ipi(1,j1)-ipi(1vibm-180
     1,j2)-iq(2,it)),4))                                                vibm-181
      go to 17                                                          vibm-182
   16 if (mod(ipi(3,j2),4).ne.1) go to 26                               vibm-183
      iq(1,it)=n1                                                       vibm-184
      iq(2,it)=nbta(17,n1)                                              vibm-185
      iq(3,it)=nsp                                                      vibm-186
      t(3,it)=dsqrt(2.d0)*ay*dfloat(1-mod(iabs(ipi(1,j1)-ipi(1,j2)+iq(2,vibm-187
     1it)),4))                                                          vibm-188
   17 t(3,it)=t(3,it)*dsqrt(dfloat(ipi(3,j2))/dfloat(2*iq(2,it)+1))     vibm-189
      go to 25                                                          vibm-190
c  (l3,l4,ip||q||l1,l2,i)                                               vibm-191
   18 if (lo(102)) go to 26                                             vibm-192
      i=iph(2,i1)                                                       vibm-193
      lb1=nvar(1,i)                                                     vibm-194
      lb2=nvar(2,i)                                                     vibm-195
      i=iph(2,i2)                                                       vibm-196
      lb3=nvar(1,i)                                                     vibm-197
      lb4=nvar(2,i)                                                     vibm-198
      lib(1)=lb1.ne.lb3                                                 vibm-199
      lib(2)=lb2.ne.lb4                                                 vibm-200
      lib(3)=lb1.ne.lb4                                                 vibm-201
      lib(4)=lb2.ne.lb3                                                 vibm-202
      if (lib(1).and.lib(2).and.lib(3).and.lib(4)) go to 26             vibm-203
      ja1=(ipi(3,j1)-1)/2                                               vibm-204
      ja2=(ipi(3,j2)-1)/2                                               vibm-205
      ia(1,1)=nbta(17,lb2)                                              vibm-206
      ia(2,1)=nbta(17,lb4)                                              vibm-207
      ia(1,2)=nbta(17,lb1)                                              vibm-208
      ia(2,2)=nbta(17,lb3)                                              vibm-209
      ia(1,3)=ia(1,1)                                                   vibm-210
      ia(2,3)=ia(2,2)                                                   vibm-211
      ia(1,4)=ia(1,2)                                                   vibm-212
      ia(2,4)=ia(2,1)                                                   vibm-213
      ia(3,1)=ia(1,2)                                                   vibm-214
      ia(3,2)=ia(1,1)                                                   vibm-215
      ia(3,3)=ia(1,2)                                                   vibm-216
      ia(3,4)=ia(1,1)                                                   vibm-217
      ia(6,1)=max0(lb2,lb4)*(nbt1+1)+min0(lb2,lb4)                      vibm-218
      ia(6,2)=max0(lb1,lb3)*(nbt1+1)+min0(lb1,lb3)                      vibm-219
      ia(6,3)=max0(lb2,lb3)*(nbt1+1)+min0(lb2,lb3)                      vibm-220
      ia(6,4)=max0(lb1,lb4)*(nbt1+1)+min0(lb1,lb4)                      vibm-221
      imin=1000                                                         vibm-222
      imax=0                                                            vibm-223
      do 19 i=1,4                                                       vibm-224
      if (lib(i)) go to 19                                              vibm-225
      ia(4,i)=iabs(ia(1,i)-ia(2,i))                                     vibm-226
      ia(5,i)=ia(1,i)+ia(2,i)                                           vibm-227
      if (ia(4,i).lt.imin) imin=ia(4,i)                                 vibm-228
      if (ia(5,i).gt.imax) imax=ia(5,i)                                 vibm-229
   19 continue                                                          vibm-230
      b(1)=dfloat(1-2*mod(ja2+ia(1,2),2))                               vibm-231
      b(2)=dfloat(1-2*mod(ia(1,2)+ia(2,2)+ia(2,1)+ja1,2))               vibm-232
      b(3)=dfloat(1-2*mod(ia(2,2),2))                                   vibm-233
      b(4)=dfloat(1-2*mod(ja2+ja1+ia(1,2),2))                           vibm-234
      t0=dsqrt(dfloat((2*ja1+1)*(2*ja2+1)))*2.d0                        vibm-235
      if (lb1.eq.lb2) t0=dsqrt(0.5d0)*t0                                vibm-236
      if (lb3.eq.lb4) t0=dsqrt(0.5d0)*t0                                vibm-237
      if (ja1.ne.ja2) go to 21                                          vibm-238
      tkq=0.d0                                                          vibm-239
      if ((lb1.eq.lb3).and.(lb2.eq.lb4)) tkq=1.d0                       vibm-240
      if ((lb1.eq.lb4).and.(lb2.eq.lb3)) tkq=tkq+dfloat(1-2*mod(ja1+ia(1vibm-241
     1,1)+ia(1,2),2))                                                   vibm-242
      if (tkq.eq.0.d0) go to 21                                         vibm-243
      if (lb1.eq.lb2) tkq=0.5d0*tkq                                     vibm-244
      do 20 l=1,nbt1                                                    vibm-245
      if (nbta(18,l).ne.0) go to 20                                     vibm-246
      if (2*it.gt.idt) call memo('vibm',idt,2*it,2)                     vibm-247
      iq(1,it)=l*(nbt1+2)                                               vibm-248
      iq(2,it)=0                                                        vibm-249
      iq(3,it)=nsp                                                      vibm-250
      t(3,it)=tkq*dsqrt(2.d0*ja1+1.d0)*ay                               vibm-251
      it=it+1                                                           vibm-252
   20 continue                                                          vibm-253
   21 imin=max0(imin,iabs(ja1-ja2))+1                                   vibm-254
      imax=min0(imax,ja1+ja2)+1                                         vibm-255
      do 23 m=imin,imax                                                 vibm-256
      j=m-1                                                             vibm-257
      do 22 k=1,4                                                       vibm-258
      if (lib(k).or.(j.lt.ia(4,k)).or.(j.gt.ia(5,k)).or.(mod(j+ia(5,k),2vibm-259
     1).ne.0)) go to 22                                                 vibm-260
      if (2*it.gt.idt) call memo('vibm',idt,2*it,2)                     vibm-261
      t3=b(k)*dj6j(2*ia(1,k),2*ia(2,k),2*j,2*ja2,2*ja1,2*ia(3,k),fac,nfavibm-262
     1)*djcg(2*ia(1,k),2*ia(2,k),2*j,0,0,fac,nfa)*dfloat(1-mod(iabs(ipi(vibm-263
     21,j1)-ipi(1,j2)+j),4))                                            vibm-264
      if (dabs(t3).lt.1.d-6) go to 22                                   vibm-265
      iq(1,it)=ia(6,k)                                                  vibm-266
      iq(2,it)=j                                                        vibm-267
      iq(3,it)=nsp                                                      vibm-268
      t(3,it)=t3*t0*ay                                                  vibm-269
      it=it+1                                                           vibm-270
   22 continue                                                          vibm-271
   23 continue                                                          vibm-272
      go to 26                                                          vibm-273
c  (l1,l2,ip||q||0) with ip=j2                                          vibm-274
   24 if (lo(102)) go to 26                                             vibm-275
      k3=(ipi(3,j2)-1)/2                                                vibm-276
      iq(2,it)=k3                                                       vibm-277
      i=iph(2,j2)                                                       vibm-278
      k1=nvar(1,i)                                                      vibm-279
      k2=nvar(2,i)                                                      vibm-280
      iq(1,it)=max0(k1,k2)*(nbt1+1)+min0(k1,k2)                         vibm-281
      iq(3,it)=nsp                                                      vibm-282
      w1=2.d0                                                           vibm-283
      if (k1.eq.k2) w1=dsqrt(w1)                                        vibm-284
      t(3,it)=ay*djcg(2*nbta(17,k1),2*nbta(17,k2),ipi(3,j2)-1,0,0,fac,nfvibm-285
     1a)*dfloat(1-mod(iabs(ipi(1,j1)-ipi(1,j2)+k3),4))*w1               vibm-286
   25 it=it+1                                                           vibm-287
   26 if ((aa(2,2).eq.0.d0).or.(l2.eq.2)) go to 27                      vibm-288
      l2=2                                                              vibm-289
      ay=ax*aa(2,2)                                                     vibm-290
      go to 4                                                           vibm-291
   27 if ((aa(1,2).eq.0.d0).or.(l1.eq.2)) go to 28                      vibm-292
      l1=2                                                              vibm-293
      ax=aa(1,2)                                                        vibm-294
      go to 3                                                           vibm-295
   28 iti=niv(i1,i2,1)                                                  vibm-296
      if (iti.eq.it) go to 37                                           vibm-297
      itf=it-1                                                          vibm-298
      if (itf.eq.iti) go to 32                                          vibm-299
      it1=iti+1                                                         vibm-300
      it=iti                                                            vibm-301
      do 31 i=it1,itf                                                   vibm-302
      do 29 j=iti,it                                                    vibm-303
      if ((iq(1,i).ne.iq(1,j)).or.(iq(2,i).ne.iq(2,j)).or.(iq(3,i).ne.iqvibm-304
     1(3,j))) go to 29                                                  vibm-305
      t(3,j)=t(3,j)+t(3,i)                                              vibm-306
      go to 31                                                          vibm-307
   29 continue                                                          vibm-308
      it=it+1                                                           vibm-309
      do 30 k=1,3                                                       vibm-310
   30 iq(k,it)=iq(k,i)                                                  vibm-311
      t(3,it)=t(3,i)                                                    vibm-312
   31 continue                                                          vibm-313
      it=it+1                                                           vibm-314
   32 itf=it-1                                                          vibm-315
      do 36 i=iti,itf                                                   vibm-316
      if (it.le.i) go to 37                                             vibm-317
   33 if (dabs(t(3,i)).gt.1.d-12) go to 36                              vibm-318
      it1=i+1                                                           vibm-319
      it=it-1                                                           vibm-320
      if (it1.gt.it) go to 37                                           vibm-321
      do 35 j=it1,it                                                    vibm-322
      do 34 k=1,3                                                       vibm-323
   34 iq(k,j-1)=iq(k,j)                                                 vibm-324
   35 t(3,j-1)=t(3,j)                                                   vibm-325
      go to 33                                                          vibm-326
   36 continue                                                          vibm-327
   37 niv(i1,i2,2)=it-1                                                 vibm-328
   38 continue                                                          vibm-329
   39 continue                                                          vibm-330
      it=it-1                                                           vibm-331
      return                                                            vibm-332
   40 write (mw,1001) jvar,nva                                          vibm-333
      go to 42                                                          vibm-334
   41 write (mw,1002) i1,i2                                             vibm-335
   42 write (mw,1003)                                                   vibm-336
      stop                                                              vibm-337
 1000 format (' state',i4,f15.5,' degrees      amplitudes =',f15.7,'  1 vibm-338
     1phonon and',f15.7,'  2 phonons')                                  vibm-339
 1001 format (' number of variables used:',i5,5x,'exceeds number of varivibm-340
     1ables read:',i6)                                                  vibm-341
 1002 format (' incorrect description of level',i3,'  or',i3)           vibm-342
 1003 format (//' in vibm  ... stop ...')                               vibm-343
      end                                                               vibm-344
c 29/02/04                                                      ecis03  rotm-000
      subroutine rotm(niv,iq,t,ipi,ncoll,iph,nbta,nvar,var,nva,it,iqmax,rotm-001
     1nspin,fac,nfa,idt,lo)                                             rotm-002
c nuclear reduced matrix elements for the symmetric rotational model    rotm-003
c the control number for the form factor with the vibration n1 and the  rotm-004
c multipolarity l is 1000*(l+1)+n1                                      rotm-005
c for arguments niv to it and fac to lo    see redm                     rotm-006
c special input: iqmax: maximum multipole expansion                     rotm-007
c                nspin: twice ground state band value k                 rotm-008
c                ipi:   description of levels                           rotm-009
c                nbta:  description of vibrational bands                rotm-010
c                nvar,var:   mixture coefficients of bands              rotm-011
c                nva:   number of values of var                         rotm-012
c                                                                       rotm-013
c    (ip||q||i)   = sqrt(2*i+1) * cg(i,iq,ip,k,0,k)                     rotm-014
c   (ip+v||q||i)  = sqrt(2*i+1) * cg(i,iq,ip,k,v,k+v)                   rotm-015
c  (ip+v||q||i+v) = sqrt(2*i+1) * cg(i,iq,ip,k+v,0,k+v)                 rotm-016
c***********************************************************************rotm-017
      implicit real*8 (a-h,o-z)                                         rotm-018
      logical lo(250)                                                   rotm-019
      dimension t(3,1),ipi(11,ncoll),niv(ncoll,ncoll,2),iq(6,1),fac(1),vrotm-020
     1ar(nva),iph(2,ncoll),nbta(18,1),aa(2,2),nvar(2,1)                 rotm-021
      common /inout/ mr,mw,ms                                           rotm-022
      it=1                                                              rotm-023
      nsp=0                                                             rotm-024
      if (lo(13).or.lo(19)) nsp=10                                      rotm-025
      do 24 i1=1,ncoll                                                  rotm-026
      ia1=ipi(3,i1)-1                                                   rotm-027
      aa(1,1)=1.d0                                                      rotm-028
      aa(1,2)=0.d0                                                      rotm-029
      if (iph(1,i1).le.1) go to 1                                       rotm-030
      jvar=iph(2,i1)                                                    rotm-031
      ivar=nvar(2,jvar)                                                 rotm-032
      ay=1.74532925d-02*var(ivar)                                       rotm-033
      aa(1,1)=dcos(ay)                                                  rotm-034
      aa(1,2)=dsin(ay)                                                  rotm-035
      if (.not.lo(217)) write (mw,1000) i1,var(ivar),aa(1,1),aa(1,2)    rotm-036
    1 aa(2,1)=aa(1,1)                                                   rotm-037
      aa(2,2)=aa(1,2)                                                   rotm-038
      do 23 i2=i1,ncoll                                                 rotm-039
      ia2=ipi(3,i2)-1                                                   rotm-040
      if (i1.eq.i2) go to 2                                             rotm-041
      aa(2,1)=1.d0                                                      rotm-042
      aa(2,2)=0.d0                                                      rotm-043
      if (iph(1,i2).le.1) go to 2                                       rotm-044
      ivar=iph(2,i2)                                                    rotm-045
      jvar=nvar(2,ivar)                                                 rotm-046
      if (jvar.gt.nva) go to 25                                         rotm-047
      ay=1.74532925d-02*var(jvar)                                       rotm-048
      aa(2,1)=dcos(ay)                                                  rotm-049
      aa(2,2)=dsin(ay)                                                  rotm-050
    2 niv(i1,i2,1)=it                                                   rotm-051
      l1=iph(1,i1)                                                      rotm-052
      ax=aa(1,1)                                                        rotm-053
      if (l1.gt.1) l1=0                                                 rotm-054
      if (dabs(ax).lt.1.d-6) go to 12                                   rotm-055
    3 l2=iph(1,i2)                                                      rotm-056
      if (l2.gt.1) l2=0                                                 rotm-057
      ay=ax*aa(2,1)                                                     rotm-058
      if (dabs(ay).lt.1.d-6) go to 11                                   rotm-059
    4 if (l1.ne.l2) go to 7                                             rotm-060
      nsj=nspin                                                         rotm-061
      if (l1.eq.0) go to 5                                              rotm-062
      n3=iph(2,i1)                                                      rotm-063
      if (n3.ne.iph(2,i2)) go to 11                                     rotm-064
      nsj=2*nbta(18,n3)+nsj                                             rotm-065
    5 if (ipi(1,i1).ne.ipi(1,i2)) go to 26                              rotm-066
      if ((iabs(nsj).gt.ia2).or.(iabs(nsj).gt.ia1)) go to 27            rotm-067
      iq1=min0(iqmax,(ia1+ia2)/2)                                       rotm-068
      iq2=max0(2,iabs(ia1-ia2)/2)                                       rotm-069
      if (2*(iq2/2).ne.iq2) iq2=iq2+1                                   rotm-070
      if (iq2.gt.iq1) go to 11                                          rotm-071
      do 6 iqz=iq2,iq1,2                                                rotm-072
      if (2*it.gt.idt) call memo('rotm',idt,2*it,2)                     rotm-073
      iq(1,it)=1000*(iqz+1)                                             rotm-074
      iq(2,it)=iqz                                                      rotm-075
      iq(3,it)=nsp                                                      rotm-076
      t(3,it)=dfloat(1-mod(iqz,4))*dsqrt(ia1+1.d0)*djcg(ia1,2*iqz,ia2,nsrotm-077
     1j,0,fac,nfa)*ay                                                   rotm-078
      if (dabs(t(3,it)).gt.1.d-6) it=it+1                               rotm-079
    6 continue                                                          rotm-080
      go to 11                                                          rotm-081
    7 if (l1.gt.l2) go to 8                                             rotm-082
      n3=iph(2,i2)                                                      rotm-083
      go to 9                                                           rotm-084
c  transposition                                                        rotm-085
    8 ay=ay*dfloat(1-mod(ipi(3,i1)+ipi(3,i2)+2*(ipi(1,i1)+ipi(1,i2)+1),4rotm-086
     1))                                                                rotm-087
      n3=iph(2,i1)                                                      rotm-088
c 0 phonons -1 phonon                                                   rotm-089
    9 nsj=2*nbta(18,n3)                                                 rotm-090
      if (mod(ipi(1,i1)+ipi(1,i2)+nbta(17,n3),2).ne.0) go to 28         rotm-091
      if (iabs(nsj+nspin).gt.ia2) go to 27                              rotm-092
      iq1=(ia1+ia2)/2                                                   rotm-093
      iq2=max0(iabs(nsj),iabs(ia1-ia2))/2                               rotm-094
      if (mod(iq2+nbta(17,n3),2).ne.0) iq2=iq2+1                        rotm-095
      if (iq2.gt.iq1) go to 11                                          rotm-096
      do 10 iqz=iq2,iq1,2                                               rotm-097
      if (3*it.gt.idt) call memo('rotm',idt,3*it,2)                     rotm-098
      iq(1,it)=1000*(iqz+1)+n3                                          rotm-099
      iq(2,it)=iqz                                                      rotm-100
      iq(3,it)=nsp                                                      rotm-101
      t(3,it)=dfloat(1-mod(iqz+ipi(1,i1)+ipi(1,i2),4))*dsqrt(ia1+1.d0)*drotm-102
     1jcg(ia1,2*iqz,ia2,nspin,nsj,fac,nfa)*ay                           rotm-103
      if (dabs(t(3,it)).gt.1.d-6) it=it+1                               rotm-104
   10 continue                                                          rotm-105
   11 if ((aa(2,2).eq.0.d0).or.(l2.eq.1)) go to 12                      rotm-106
      l2=1                                                              rotm-107
      ay=ax*aa(2,2)                                                     rotm-108
      go to 4                                                           rotm-109
   12 if ((aa(1,2).eq.0.d0).or.(l1.eq.1)) go to 13                      rotm-110
      l1=1                                                              rotm-111
      ax=aa(1,2)                                                        rotm-112
      go to 3                                                           rotm-113
   13 iti=niv(i1,i2,1)                                                  rotm-114
      if (iti.eq.it) go to 22                                           rotm-115
      itf=it-1                                                          rotm-116
      if (itf.eq.iti) go to 17                                          rotm-117
      it1=iti+1                                                         rotm-118
      it=iti                                                            rotm-119
      do 16 i=it1,itf                                                   rotm-120
      do 14 j=iti,it                                                    rotm-121
      if ((iq(1,i).ne.iq(1,j)).or.(iq(2,i).ne.iq(2,j)).or.(iq(3,i).ne.iqrotm-122
     1(3,j))) go to 14                                                  rotm-123
      t(3,j)=t(3,j)+t(3,i)                                              rotm-124
      go to 16                                                          rotm-125
   14 continue                                                          rotm-126
      it=it+1                                                           rotm-127
      do 15 k=1,3                                                       rotm-128
   15 iq(k,it)=iq(k,i)                                                  rotm-129
      t(3,it)=t(3,i)                                                    rotm-130
   16 continue                                                          rotm-131
      it=it+1                                                           rotm-132
   17 itf=it-1                                                          rotm-133
      do 21 i=iti,itf                                                   rotm-134
      if (it.le.i) go to 22                                             rotm-135
   18 if (dabs(t(3,i)).gt.1.d-12) go to 21                              rotm-136
      it1=i+1                                                           rotm-137
      it=it-1                                                           rotm-138
      if (it1.gt.it) go to 22                                           rotm-139
      do 20 j=it1,it                                                    rotm-140
      do 19 k=1,3                                                       rotm-141
   19 iq(k,j-1)=iq(k,j)                                                 rotm-142
   20 t(3,j-1)=t(3,j)                                                   rotm-143
      go to 18                                                          rotm-144
   21 continue                                                          rotm-145
   22 niv(i1,i2,2)=it-1                                                 rotm-146
   23 continue                                                          rotm-147
   24 continue                                                          rotm-148
      it=it-1                                                           rotm-149
      return                                                            rotm-150
   25 write (mw,1001) jvar,nva                                          rotm-151
      go to 29                                                          rotm-152
   26 write (mw,1002) i1,i2                                             rotm-153
      go to 29                                                          rotm-154
   27 write (mw,1003) i1,i2                                             rotm-155
      go to 29                                                          rotm-156
   28 write (mw,1004) i1,i2,n3                                          rotm-157
      go to 29                                                          rotm-158
   29 write (mw,1005)                                                   rotm-159
      stop                                                              rotm-160
 1000 format (' state',i4,f15.5,' degrees      amplitudes =',f15.7,' grorotm-161
     1und state band and',f15.5,' vibrational band')                    rotm-162
 1001 format (' number of variables used:',i5,5x,'exceeds number of varirotm-163
     2ables read:',i6)                                                  rotm-164
 1002 format (/' parities of states',i4,'  and',i4,'  incorrect for the rotm-165
     1rotational model')                                                rotm-166
 1003 format (' too large magnetic quantum number between levels',i4,' arotm-167
     1nd',i4)                                                           rotm-168
 1004 format (/' parities of states',i4,'  and',i4,'  incorrect for the rotm-169
     1rotational model with the vibration',i4)                          rotm-170
 1005 format (//' in rotm  ... stop ...')                               rotm-171
      end                                                               rotm-172
c 29/02/04                                                      ecis03  roam-000
      subroutine roam(niv,iq,t,ipi,ncoll,it,beta,iph,var,va,iqmax,fac,nfroam-001
     1a,idt,lo)                                                         roam-002
c nuclear reduced matrix elements for the asymmetric rotational model   roam-003
c the control number for form factor (l=2,k=0) is 2,for (l=2,k=2) is 3, roam-004
c    for (l=4,k=0) is 4,for (l=4,k=2) is 2  ... and so on...            roam-005
c for arguments niv to it and fac to lo    see redm                     roam-006
c special input: beta:  deformations.the gamma parameter beta(*,2) is   roam-007
c                       related to the band mixing param. if lo(2)=.trueroam-008
c                iph(i,2):number of nuclear parameters in iph(i,1)      roam-009
c                       their address in iph(i,2)                       roam-010
c                var:   band mixing coefficients                        roam-011
c                va:    working space for amplitudes (permanent)        roam-012
c                iqmax: maximum order of multipole expansion            roam-013
c                                                                       roam-014
c  (ip||q(iq,kq)||i) = sqrt(2*i+1) *cg(i,iq,ip,k,kq,kp)                 roam-015
c***********************************************************************roam-016
      implicit real*8 (a-h,o-z)                                         roam-017
      logical lo(250)                                                   roam-018
      dimension iq(6,1),t(3,1),ipi(11,1),var(1),beta(9,3),niv(ncoll,ncolroam-019
     1l,2),fac(1),va(5),iph(2,ncoll)                                    roam-020
      common /inout/ mr,mw,ms                                           roam-021
      ivar=0                                                            roam-022
      i2=1                                                              roam-023
      if (lo(102)) go to 4                                              roam-024
c var(1) is the angle gamma of davydov and filippov model               roam-025
c the second level must be a the first 2+ and the third one,if present, roam-026
c the second 2+ .their mixing coefficients are computed from var(1).    roam-027
c there can be any number of levels after the third one.                roam-028
      g=var(1)-beta(1,2)                                                roam-029
      if (.not.lo(216)) write (mw,1000) g,(beta(i,2),i=1,8)             roam-030
      do 1 i=1,8                                                        roam-031
    1 beta(i,2)=beta(i,2)+g                                             roam-032
      if (.not.lo(216)) write (mw,1001) (beta(i,2),i=1,8)               roam-033
      g=0.0174532925199433d0*var(1)                                     roam-034
      g1=dsin(g)                                                        roam-035
      g2=dcos(g)                                                        roam-036
      g3=dsin(3.d0*g)                                                   roam-037
      g4=dcos(3.d0*g)                                                   roam-038
      g=dsqrt(9.d0-8.d0*g3*g3)                                          roam-039
      g5=-(g1*g3+3.d0*g2*g4+g)                                          roam-040
      g6=3.d0*g1*g4-g2*g3                                               roam-041
      va(1)=1.d0                                                        roam-042
      if (ncoll.eq.1) go to 2                                           roam-043
      g=dsqrt(g6*g6+g5*g5)                                              roam-044
      va(2)=g5/g                                                        roam-045
      va(3)=g6/g                                                        roam-046
      if (ncoll.eq.2) go to 2                                           roam-047
      va(4)=-va(3)                                                      roam-048
      va(5)=va(2)                                                       roam-049
    2 i2=min0(ncoll,3)                                                  roam-050
      do 3 i1=1,i2                                                      roam-051
      if (i1.eq.1.and.ipi(3,i1).ne.1) go to 14                          roam-052
      if (i1.eq.1) go to 3                                              roam-053
      if (ipi(3,i1).ne.5) go to 14                                      roam-054
      if (.not.lo(216)) write (mw,1002) i1,va(2*i1-2),va(2*i1-1)        roam-055
    3 continue                                                          roam-056
      ivar=i2-1                                                         roam-057
      i2=4                                                              roam-058
      if (i2.gt.ncoll) go to 7                                          roam-059
c levels not related to the gamma deformation                           roam-060
    4 do 6 i1=i2,ncoll                                                  roam-061
      if (ipi(3,i1).eq.3) go to 16                                      roam-062
      ivar=iph(2,i1)                                                    roam-063
      if (mod(ipi(3,i1),4).ne.1) var(ivar+1)=90.d0                      roam-064
      k1=ivar+i1                                                        roam-065
      va(k1)=1.d0                                                       roam-066
      if (iph(1,i1).eq.0) go to 6                                       roam-067
      k2=k1+iph(1,i1)-1                                                 roam-068
      do 5 k=k1,k2                                                      roam-069
      ivar=ivar+1                                                       roam-070
      g=0.0174532925199433d0*var(ivar)                                  roam-071
      va(k+1)=va(k)*dsin(g)                                             roam-072
    5 va(k)=va(k)*dcos(g)                                               roam-073
      if (.not.lo(216)) write (mw,1002) i1,(va(k),k=k1,k2),va(k2+1)     roam-074
    6 continue                                                          roam-075
c computation of red. mat. ele. for i=/<ip at the first call            roam-076
    7 it=1                                                              roam-077
      nsp=0                                                             roam-078
      if (lo(13).or.lo(19)) nsp=10                                      roam-079
      do 13 i1=1,ncoll                                                  roam-080
      nt=iph(1,i1)+1                                                    roam-081
      nv=iph(2,i1)+i1-1                                                 roam-082
      ia1=ipi(3,i1)-1                                                   roam-083
      nx=ia1/2-2*(ia1/4)                                                roam-084
      do 12 i2=i1,ncoll                                                 roam-085
      if (ipi(1,i1).ne.ipi(1,i2)) go to 15                              roam-086
      niv(i1,i2,1)=it                                                   roam-087
      mt=iph(1,i2)+1                                                    roam-088
      mv=iph(2,i2)+i2-1                                                 roam-089
      ia2=ipi(3,i2)-1                                                   roam-090
      mx=ia2/2-2*(ia2/4)                                                roam-091
      iq1=min0(iqmax,(ia1+ia2)/2,8)                                     roam-092
      iq2=max0(2,2*((iabs(ia1-ia2)/2+1)/2))                             roam-093
      if (iq2.gt.iq1) go to 11                                          roam-094
c computation of reduced matrix elements                                roam-095
      do 10 iqz=iq2,iq1,2                                               roam-096
      fs=dfloat(iqz-4*((iqz+2)/4)+1)                                    roam-097
      iqy=iqz/2+1                                                       roam-098
      do 9 mqz=1,iqy                                                    roam-099
      if (2*it.gt.idt) call memo('roam',idt,2*it,2)                     roam-100
      iq(1,it)=1000*((iqy*(iqy-1))/2+mqz)                               roam-101
      b=0.d0                                                            roam-102
      iq(2,it)=iqz                                                      roam-103
      iq(3,it)=nsp                                                      roam-104
      mq=2*mqz-2                                                        roam-105
      do 8 n1=1,nt                                                      roam-106
      if (n1-nx.eq.0) go to 8                                           roam-107
      n=2*n1-2                                                          roam-108
      lm=n-mq                                                           roam-109
      if (iabs(lm).ge.2*mt) go to 8                                     roam-110
      l1=1+iabs(lm)/2                                                   roam-111
      fq=djcg(ia1,2*iqz,ia2,2*n,-2*mq,fac,nfa)*va(nv+n1)*va(mv+l1)      roam-112
      if (lm.lt.0.and.mx.eq.1) fq=-fq                                   roam-113
      if (mq*n*lm.ne.0) fq=.7071068d0*fq                                roam-114
      b=b+fq                                                            roam-115
      if (n*mq.eq.0) go to 8                                            roam-116
      lm=mq+n                                                           roam-117
      if (lm.ge.2*mt) go to 8                                           roam-118
      l1=1+lm/2                                                         roam-119
      fq=djcg(ia1,2*iqz,ia2,2*n,2*mq,fac,nfa)*va(nv+n1)*va(mv+l1)       roam-120
      if (mq*n*lm.ne.0) fq=.7071068d0*fq                                roam-121
      b=b+fq                                                            roam-122
    8 continue                                                          roam-123
      if (mq.ne.0) b=.7071068d0*b                                       roam-124
      t(3,it)=dsqrt(dfloat(ia1+1))*b*fs                                 roam-125
      if (dabs(t(3,it)).gt.1.d-6) it=it+1                               roam-126
    9 continue                                                          roam-127
   10 continue                                                          roam-128
   11 niv(i1,i2,2)=it-1                                                 roam-129
   12 continue                                                          roam-130
   13 continue                                                          roam-131
      it=it-1                                                           roam-132
      return                                                            roam-133
   14 write (mw,1003)                                                   roam-134
      go to 17                                                          roam-135
   15 write (mw,1004) i1,i2                                             roam-136
      go to 17                                                          roam-137
   16 write (mw,1005)                                                   roam-138
   17 write (mw,1006)                                                   roam-139
      stop                                                              roam-140
 1000 format (/' for constrained asymmetric rotational model the beta(i,roam-141
     12) are increased by',f10.5//23x,'v',9x,'w',8x,'vs',8x,'ws',7x,'vsoroam-142
     2',7x,'wso',6x,'coul s.o. coul'/' initial values ',8f10.5)         roam-143
 1001 format (' modified values',8f10.5)                                roam-144
 1002 format (/' band mixing coefficients for the level',i4/(6d20.7))   roam-145
 1003 format (/' level order incorrect for link between deformation and roam-146
     1band mixing'/' use 0+-2+-2+ and then the other levels')           roam-147
 1004 format (/' parities of states',i4,'  and',i4,'  incorrect for the roam-148
     1rotational model')                                                roam-149
 1005 format (/' no spin-1 state in this model')                        roam-150
 1006 format (//' in roam  ... stop ...')                               roam-151
      end                                                               roam-152
c 29/02/04                                                      ecis03  djcg-000
      function djcg(j1,j2,j3,m1,m2,fac,nfa)                             djcg-001
c clebsch-gordan coefficients ( j1  j2  m1  m2 | j3  m1+m2 )            djcg-002
c the arguments j1,j2,j3,m1 and m2 are integer doubled values           djcg-003
c fac is a table of logarithm of factorials and nfa its length.         djcg-004
c***********************************************************************djcg-005
      implicit real*8(a-f)                                              djcg-006
      dimension fac(1)                                                  djcg-007
      common /inout/ mr,mw,ms                                           djcg-008
      djcg=0.d0                                                         djcg-009
      m3=m1+m2                                                          djcg-010
      if (j1+j2+j3.gt.2*nfa) go to 18                                   djcg-011
      if ((j1.lt.0).or.(j2.lt.0).or.(j3.lt.0)) go to 16                 djcg-012
      iy1=j1+m1+2                                                       djcg-013
      ix1=iy1/2                                                         djcg-014
      iy2=j2+m2+2                                                       djcg-015
      ix2=iy2/2                                                         djcg-016
      iy3=j3-m3+2                                                       djcg-017
      ix3=iy3/2                                                         djcg-018
      if ((ix1.le.0).or.(ix2.le.0).or.(ix3.le.0)) return                djcg-019
      if ((2*ix1.ne.iy1).or.(2*ix2.ne.iy2).or.(2*ix3.ne.iy3)) go to 17  djcg-020
      iy1=ix1-m1                                                        djcg-021
      iy2=ix2-m2                                                        djcg-022
      iy3=ix3+m3                                                        djcg-023
      if ((iy1.le.0).or.(iy2.le.0).or.(iy3.le.0)) return                djcg-024
c at this point ix1,ix2,ix3 are twice j+m and iy1,iy2,iy3 twice j-m     djcg-025
c search for a zero argument                                            djcg-026
      if (j3.eq.0) go to 4                                              djcg-027
      if ((j1.eq.0).or.(j2.eq.0)) go to 5                               djcg-028
      if (m3.eq.0) go to 6                                              djcg-029
      if (m2.eq.0) go to 7                                              djcg-030
      if (m1.eq.0) go to 8                                              djcg-031
c general case                                                          djcg-032
    1 nx=ix1+ix2+ix3                                                    djcg-033
      iz1=nx-ix1-iy1                                                    djcg-034
      iz2=nx-ix2-iy2                                                    djcg-035
      iz3=nx-ix3-iy3                                                    djcg-036
      if ((iz1.le.0).or.(iz2.le.0).or.(iz3.le.0)) return                djcg-037
      nxy=nx-1                                                          djcg-038
      i1=ix2-iy3                                                        djcg-039
      i2=iy1-ix3                                                        djcg-040
c k1 and k2 are the limits of the sum                                   djcg-041
c m1,m2,m3,k1,k3,k4 have their factorials in the denominator            djcg-042
c nxy=j1+j2+j3+1      iz1,iz2,iz3  are j1+j2-j3                         djcg-043
      k1=max0(i1,i2,0)+1                                                djcg-044
      k2=min0(iy1,ix2,iz3)                                              djcg-045
      k3=k1-i1                                                          djcg-046
      k4=k1-i2                                                          djcg-047
      n1=iy1-k1+1                                                       djcg-048
      n2=ix2-k1+1                                                       djcg-049
      n3=iz3-k1+1                                                       djcg-050
      djcg=dexp(0.5d0*(fac(ix3+iy3)-fac(ix3+iy3-1)-fac(nxy)+fac(iz1)+facdjcg-051
     1(iz2)+fac(iz3)+fac(ix1)+fac(ix2)+fac(ix3)+fac(iy1)+fac(iy2)+fac(iydjcg-052
     23))-fac(n1)-fac(n2)-fac(n3)-fac(k1)-fac(k3)-fac(k4))              djcg-053
      if (2*(k1/2).eq.k1) djcg=-djcg                                    djcg-054
      if (k1.eq.k2) go to 3                                             djcg-055
      a4=djcg                                                           djcg-056
      k=k2-k1                                                           djcg-057
      k3=k2-i1                                                          djcg-058
      k4=k2-i2                                                          djcg-059
      n1=iy1-k2                                                         djcg-060
      n2=ix2-k2                                                         djcg-061
      n3=iz3-k2                                                         djcg-062
c k2,k3,k4,n1,n2,n3 are the arguments of the factorials in the last termdjcg-063
      do 2 i=1,k                                                        djcg-064
      a1=dfloat((k2-i)*(k3-i)*(k4-i))                                   djcg-065
      a2=dfloat((n1+i)*(n2+i)*(n3+i))                                   djcg-066
    2 djcg=a4-djcg*a2/a1                                                djcg-067
    3 return                                                            djcg-068
c j1,j2 or j3  is zero                                                  djcg-069
    4 if (j1.ne.j2) return                                              djcg-070
      a1=dfloat(j1+1)                                                   djcg-071
      djcg=1.d0/dsqrt(a1)                                               djcg-072
      if (mod(iy1,2).eq.0) djcg=-djcg                                   djcg-073
      return                                                            djcg-074
    5 if (j1+j2.ne.j3) return                                           djcg-075
      djcg=1.d0                                                         djcg-076
      return                                                            djcg-077
c m1,m2 or m3 is zero; if the others m are larger than 1/2,general case djcg-078
    6 if (iabs(m1)-1) 9 , 10 , 1                                        djcg-079
    7 if (iabs(m1).gt.1) go to 1                                        djcg-080
      go to 11                                                          djcg-081
    8 if (iabs(m3).gt.1) go to 1                                        djcg-082
      go to 12                                                          djcg-083
c all the m are zeros                                                   djcg-084
    9 n5=ix1+ix2+ix3-1                                                  djcg-085
      if (2*(n5/2).ne.n5) return                                        djcg-086
      n2=ix1+ix2-ix3                                                    djcg-087
      n3=ix2+ix3-ix1                                                    djcg-088
      n4=ix3+ix1-ix2                                                    djcg-089
      a1=fac(2*ix3)-fac(2*ix3-1)                                        djcg-090
      kc=1                                                              djcg-091
      go to 14                                                          djcg-092
c one m is zero and the others +-1/2  formula of dcgs                   djcg-093
   10 iq=ix3-1                                                          djcg-094
      iz1=ix1+ix2-2                                                     djcg-095
      iz2=ix1-iy2                                                       djcg-096
      lz1=j1                                                            djcg-097
      lz2=j2                                                            djcg-098
      lw2=m2                                                            djcg-099
      lw1=iy1                                                           djcg-100
      go to 13                                                          djcg-101
   11 iq=ix2-1                                                          djcg-102
      iz1=ix1+ix3-2                                                     djcg-103
      iz2=ix3-iy1                                                       djcg-104
      lz1=j1                                                            djcg-105
      lz2=j3                                                            djcg-106
      lw2=m1                                                            djcg-107
      lw1=iy3                                                           djcg-108
      go to 13                                                          djcg-109
   12 iq=ix1-1                                                          djcg-110
      iz1=ix2+ix3-2                                                     djcg-111
      iz2=ix2-iy3                                                       djcg-112
      lz1=j2                                                            djcg-113
      lz2=j3                                                            djcg-114
      lw2=-m3                                                           djcg-115
      lw1=iy2                                                           djcg-116
   13 n2=iz1-iq+1                                                       djcg-117
      n3=iq+iz2+1                                                       djcg-118
      n4=iq-iz2+1                                                       djcg-119
      if (n2.lt.1.or.n3.lt.1.or.n4.lt.1) return                         djcg-120
      n5=iz1+iq+2                                                       djcg-121
      a1=fac(j3+2)-fac(j3+1)-fac(lz1+2)+fac(lz1+1)-fac(lz2+2)+fac(lz2+1)djcg-122
      kc=2                                                              djcg-123
c simple formula                                                        djcg-124
   14 if (n5-1.gt.nfa) go to 18                                         djcg-125
      l1=(n5+1)/2                                                       djcg-126
      l2=(n2+1)/2                                                       djcg-127
      l3=(n3+1)/2                                                       djcg-128
      l4=(n4+1)/2                                                       djcg-129
      djcg=dexp(0.5d0*(a1+fac(n2)+fac(n3)+fac(n4)-fac(n5))+fac(l1)-fac(ldjcg-130
     12)-fac(l3)-fac(l4))                                               djcg-131
      if (kc.eq.2) go to 15                                             djcg-132
      if (mod(l1+ix1-ix2,2).eq.0) djcg=-djcg                            djcg-133
      return                                                            djcg-134
   15 if (lw2.gt.0) l4=l4+n5+1                                          djcg-135
      djcg=2.d0*djcg                                                    djcg-136
      if (mod(l4+lw1+ix1-iy2,2).ne.0) djcg=-djcg                        djcg-137
      return                                                            djcg-138
   16 write (mw,1000)                                                   djcg-139
      return                                                            djcg-140
   17 write (mw,1001)                                                   djcg-141
      return                                                            djcg-142
   18 write (mw,1002)                                                   djcg-143
      return                                                            djcg-144
 1000 format (' negative angular momentum in djcg')                     djcg-145
 1001 format (' integer/half-integer rule between quantum numbers transgdjcg-146
     1ressed in djcg')                                                  djcg-147
 1002 format (' factorial too large in djcg')                           djcg-148
      end                                                               djcg-149
c 29/02/04                                                      ecis03  dj6j-000
      function dj6j(j1,j2,j3,j4,j5,j6,fac,nfa)                          dj6j-001
c                       ( j1  j2  j3 )                                  dj6j-002
c 6-j coefficients      )            (                                  dj6j-003
c                       ( j4  j5  j6 )                                  dj6j-004
c the arguments j1,j2,j3,j4,j5 and j6 are integer doubled values        dj6j-005
c fac is a table of logarithm of factorials and nfa its length.         dj6j-006
c***********************************************************************dj6j-007
      implicit real*8(a-f)                                              dj6j-008
      dimension ix(6),ia(3,4),iy(4),fac(1)                              dj6j-009
      common /inout/ mr,mw,ms                                           dj6j-010
      data ia /1,2,3,1,5,6,4,2,6,4,5,3/                                 dj6j-011
      dj6j=0.d0                                                         dj6j-012
      ix(1)=j1                                                          dj6j-013
      ix(2)=j2                                                          dj6j-014
      ix(3)=j3                                                          dj6j-015
      ix(4)=j4                                                          dj6j-016
      ix(5)=j5                                                          dj6j-017
      ix(6)=j6                                                          dj6j-018
c  the arguments multiplied by 2 are in the table ix                    dj6j-019
c search for a zero argument                                            dj6j-020
      do 1 i=1,6                                                        dj6j-021
      if (ix(i).lt.0) go to 14                                          dj6j-022
      if (ix(i).eq.0) go to ( 5 , 6 , 7 , 8 , 9, 10 ),i                 dj6j-023
    1 continue                                                          dj6j-024
c general case                                                          dj6j-025
c check of the triangular relations and computation of delta            dj6j-026
      do 2 k=1,4                                                        dj6j-027
      iz1=ia(1,k)                                                       dj6j-028
      iz2=ia(2,k)                                                       dj6j-029
      iz3=ia(3,k)                                                       dj6j-030
      ix1=ix(iz1)                                                       dj6j-031
      ix2=ix(iz2)                                                       dj6j-032
      ix3=ix(iz3)                                                       dj6j-033
      n=ix1+ix2+ix3+2                                                   dj6j-034
      i1=n/2                                                            dj6j-035
      if (2*i1.ne.n) go to 12                                           dj6j-036
      if (i1.gt.nfa) go to 13                                           dj6j-037
      n1=i1-ix3                                                         dj6j-038
      n2=i1-ix2                                                         dj6j-039
      n3=i1-ix1                                                         dj6j-040
      if ((i1.le.0).or.(n1.le.0).or.(n2.le.0).or.(n3.le.0)) go to 15    dj6j-041
      iy(k)=i1+1                                                        dj6j-042
    2 dj6j=dj6j+fac(n1)-fac(i1+1)+fac(n2)+fac(n3)                       dj6j-043
      n1=(ix(1)+ix(2)+ix(4)+ix(5))/2                                    dj6j-044
      n2=(ix(1)+ix(3)+ix(4)+ix(6))/2                                    dj6j-045
      n3=(ix(2)+ix(3)+ix(5)+ix(6))/2                                    dj6j-046
c k1 and k2 are the limits of the sum                                   dj6j-047
c k1,l1,l2,l3,l4,m1,m2,m3 are for the factorials of the first term      dj6j-048
      k1=max0(iy(1),iy(2),iy(3),iy(4))                                  dj6j-049
      k2=min0(n1,n2,n3)+2                                               dj6j-050
      l1=k1-iy(1)+1                                                     dj6j-051
      l2=k1-iy(2)+1                                                     dj6j-052
      l3=k1-iy(3)+1                                                     dj6j-053
      l4=k1-iy(4)+1                                                     dj6j-054
      m1=n1-k1+3                                                        dj6j-055
      m2=n2-k1+3                                                        dj6j-056
      m3=n3-k1+3                                                        dj6j-057
      dj6j=dexp(.5d0*dj6j+fac(k1)-fac(l1)-fac(l2)-fac(l3)-fac(l4)-fac(m1dj6j-058
     1)-fac(m2)-fac(m3))                                                dj6j-059
      if (2*(k1/2).ne.k1) dj6j=-dj6j                                    dj6j-060
      if (k2.eq.k1) go to 4                                             dj6j-061
      a2=dj6j                                                           dj6j-062
      k=k2-k1                                                           dj6j-063
    3 a1=dfloat((m1-k)*(m2-k)*(m3-k))                                   dj6j-064
      k=k-1                                                             dj6j-065
      a3=dfloat((l1+k)*(l2+k)*(l3+k)*(l4+k))                            dj6j-066
      dj6j=a2-dfloat(k1+k)*a1*dj6j/a3                                   dj6j-067
      if (k.gt.0) go to 3                                               dj6j-068
    4 return                                                            dj6j-069
c one quantum number is zero;check of triangular relations              dj6j-070
    5 if (ix(2).ne.ix(3).or.ix(5).ne.ix(6)) go to 15                    dj6j-071
      ix(6)=ix(4)                                                       dj6j-072
      ix(1)=ix(2)                                                       dj6j-073
      ix(4)=ix(5)                                                       dj6j-074
      go to 11                                                          dj6j-075
    6 if (ix(1).ne.ix(3).or.ix(4).ne.ix(6)) go to 15                    dj6j-076
      ix(6)=ix(5)                                                       dj6j-077
      go to 11                                                          dj6j-078
    7 if (ix(1).ne.ix(2).or.ix(4).ne.ix(5)) go to 15                    dj6j-079
      if (ix(4).ne.ix(5)) go to 15                                      dj6j-080
      go to 11                                                          dj6j-081
    8 if (ix(2).ne.ix(6).or.ix(3).ne.ix(5)) go to 15                    dj6j-082
      ix(6)=ix(1)                                                       dj6j-083
      ix(1)=ix(5)                                                       dj6j-084
      ix(4)=ix(2)                                                       dj6j-085
      go to 11                                                          dj6j-086
    9 if (ix(1).ne.ix(6).or.ix(3).ne.ix(4)) go to 15                    dj6j-087
      ix(6)=ix(2)                                                       dj6j-088
      go to 11                                                          dj6j-089
   10 if (ix(1).ne.ix(5).or.ix(2).ne.ix(4)) go to 15                    dj6j-090
      ix(6)=ix(3)                                                       dj6j-091
c value of the 6-j coefficient with an argument zero                    dj6j-092
   11 if (min0(ix(1),ix(4),ix(6)).lt.0) go to 14                        dj6j-093
      if (ix(6).gt.ix(1)+ix(4).or.ix(6).lt.iabs(ix(1)-ix(4))) go to 15  dj6j-094
      if (max0(ix(1),ix(4)).gt.nfa) go to 13                            dj6j-095
      k=ix(1)+ix(4)+ix(6)                                               dj6j-096
      n=k/2                                                             dj6j-097
      if (2*n.ne.k) go to 12                                            dj6j-098
      dj6j=dfloat(1-2*mod(n,2))/dsqrt(dfloat((ix(1)+1)*(ix(4)+1)))      dj6j-099
      return                                                            dj6j-100
   12 write (mw,1000)                                                   dj6j-101
      go to 15                                                          dj6j-102
   13 write (mw,1001)                                                   dj6j-103
      go to 15                                                          dj6j-104
   14 write (mw,1002)                                                   dj6j-105
   15 dj6j=0.d0                                                         dj6j-106
      return                                                            dj6j-107
 1000 format (' integer/half-integer rule between quantum numbers transgdj6j-108
     1ressed in dj6j')                                                  dj6j-109
 1001 format (' factorial too large in dj6j')                           dj6j-110
 1002 format (' negative angular momentum in dj6j')                     dj6j-111
      end                                                               dj6j-112
c 29/02/04                                                      ecis03  dj9j-000
      function dj9j(j1,j2,j3,j4,j5,j6,j7,j8,j9,aa,ito)                  dj9j-001
c computation of                                                        dj9j-002
c                                     | j1  j2  j3 |                    dj9j-003
c                                     |            |                    dj9j-004
c   9j(j1,j2,j3,j4,j5,j6,j7,j8,j9) =  | j4  j5  j6 |                    dj9j-005
c                                     |            |                    dj9j-006
c                                     | j7  j8  j9 |                    dj9j-007
c                                                                       dj9j-008
c the arguments are integer double values                               dj9j-009
c aa is a working space and ito its length                              dj9j-010
c***********************************************************************dj9j-011
      implicit real*8 (a-f)                                             dj9j-012
      dimension aa(1),j(5),ix(9),jx(3,3),js(3),jf(3),ia(5,3),ib(3)      dj9j-013
      equivalence (ix(1),jx(1,1)),(ib(1),ib1),(ib(2),ib2),(ib(3),ib3)   dj9j-014
      common /inout/ mr,mw,ms                                           dj9j-015
      data ia /1,2,3,6,9,6,4,5,8,2,8,9,7,1,4/                           dj9j-016
      dj9j=0.d0                                                         dj9j-017
      ix(1)=j1                                                          dj9j-018
      ix(2)=j2                                                          dj9j-019
      ix(3)=j3                                                          dj9j-020
      ix(4)=j4                                                          dj9j-021
      ix(5)=j5                                                          dj9j-022
      ix(6)=j6                                                          dj9j-023
      ix(7)=j7                                                          dj9j-024
      ix(8)=j8                                                          dj9j-025
      ix(9)=j9                                                          dj9j-026
      do 2 i=1,3                                                        dj9j-027
      do 1 k=1,3                                                        dj9j-028
      if (jx(k,i).lt.0) go to 13                                        dj9j-029
    1 continue                                                          dj9j-030
c check of triangular relations                                         dj9j-031
      if (mod(jx(1,i)+jx(2,i)+jx(3,i),2).ne.0.or.mod(jx(i,1)+jx(i,2)+jx(dj9j-032
     1i,3),2).ne.0) go to 11                                            dj9j-033
      if (iabs(jx(1,i)-jx(2,i)).gt.jx(3,i).or.jx(1,i)+jx(2,i).lt.jx(3,i)dj9j-034
     1) return                                                          dj9j-035
      if (iabs(jx(i,1)-jx(i,2)).gt.jx(i,3).or.jx(i,1)+jx(i,2).lt.jx(i,3)dj9j-036
     1) return                                                          dj9j-037
    2 continue                                                          dj9j-038
c search of the configuration for which the sum on products of 6-j      dj9j-039
c coefficients is the smallest one                                      dj9j-040
      k1=min0(ix(3),ix(5),ix(7))                                        dj9j-041
      k2=min0(ix(2),ix(4),ix(9))                                        dj9j-042
      k3=min0(ix(1),ix(6),ix(8))                                        dj9j-043
      kt=max0(k1,k2,k3)                                                 dj9j-044
      if (kt.eq.k1) go to 6                                             dj9j-045
      if (k2.gt.k3) go to 4                                             dj9j-046
      do 3 i=1,3                                                        dj9j-047
      ii=ix(i)                                                          dj9j-048
      ix(i)=ix(i+3)                                                     dj9j-049
      ix(i+3)=ix(i+6)                                                   dj9j-050
    3 ix(i+6)=ii                                                        dj9j-051
      go to 6                                                           dj9j-052
    4 do 5 i=1,3                                                        dj9j-053
      ii=ix(i+6)                                                        dj9j-054
      ix(i+6)=ix(i+3)                                                   dj9j-055
      ix(i+3)=ix(i)                                                     dj9j-056
    5 ix(i)=ii                                                          dj9j-057
    6 do 7 k=1,3                                                        dj9j-058
      ia1=ia(1,k)                                                       dj9j-059
      ia2=ia(2,k)                                                       dj9j-060
      ia4=ia(4,k)                                                       dj9j-061
      ia5=ia(5,k)                                                       dj9j-062
      js(k)=max0(iabs(ix(ia1)-ix(ia5)),iabs(ix(ia4)-ix(ia2)))+1         dj9j-063
    7 jf(k)=min0(ix(ia1)+ix(ia5),ix(ia2)+ix(ia4))+1                     dj9j-064
      kf=min0(jf(1),jf(2),jf(3))                                        dj9j-065
      kt=2+(kf-max0(js(1),js(2),js(3)))/2                               dj9j-066
c loop on the three 6-j coefficients                                    dj9j-067
      itx=0                                                             dj9j-068
      az=1.d0                                                           dj9j-069
      do 9 k=1,3                                                        dj9j-070
      ij=itx                                                            dj9j-071
      ib(k)=itx+(jf(k)-kf)/2                                            dj9j-072
      do 8 i=1,5                                                        dj9j-073
      ia1=ia(i,k)                                                       dj9j-074
    8 j(i)=ix(ia1)                                                      dj9j-075
      jt=2+(jf(k)-js(k))/2                                              dj9j-076
      itx=itx+jt                                                        dj9j-077
      if (itx.gt.ito) go to 12                                          dj9j-078
      at=dfloat(jf(k))                                                  dj9j-079
      call dx6j(aa(1+ij),at,j,jt)                                       dj9j-080
    9 az=az*at*dfloat(j(3)+1)                                           dj9j-081
c summation on products of 6-j                                          dj9j-082
      af=dfloat(kf)                                                     dj9j-083
      do 10 i=2,kt                                                      dj9j-084
      dj9j=dj9j+af*aa(i+ib1)*aa(i+ib2)*aa(i+ib3)                        dj9j-085
   10 af=af-2.d0                                                        dj9j-086
c normalisation                                                         dj9j-087
      dj9j=dj9j/dsqrt(az)                                               dj9j-088
      return                                                            dj9j-089
   11 write (mw,1000)                                                   dj9j-090
      return                                                            dj9j-091
   12 write (mw,1001)                                                   dj9j-092
      return                                                            dj9j-093
   13 write (mw,1002)                                                   dj9j-094
      return                                                            dj9j-095
 1000 format (' integer/half-integer rule between quantum numbers transgdj9j-096
     1ressed in dj9j')                                                  dj9j-097
 1001 format (' too many 6-j needed in dj9j')                           dj9j-098
 1002 format (' negative angular momentum in dj9j')                     dj9j-099
      end                                                               dj9j-100
c 29/02/04                                                      ecis03  dx6j-000
      subroutine dx6j(aa,at,j,jt)                                       dx6j-001
c  recurrence computation of unnormalised                               dx6j-002
c                       ( j(1)  j(2)  j(3) )                            dx6j-003
c 6-j coefficients      )                  (                            dx6j-004
c                       ( j(4)  j(5)   jj  )                            dx6j-005
c for all values of jj.  the arguments j are integer doubled values.    dx6j-006
c input data:  jt:   number of 6j coefficients plus one                 dx6j-007
c              at:   jj+1 for maximum value of jj (usual 2j+1)          dx6j-008
c output data: aa:   unnormalised 6j coefficients in aa(2) to aa(jt)    dx6j-009
c                    starting from the largest value of jj; aa(1)=0     dx6j-010
c              at:   normalisation: the values aa must be divided by    dx6j-011
c                      (-)**(j(1)+j(2)+j(4)+j(5))*sqrt((j(3)+1)*at)     dx6j-012
c***********************************************************************dx6j-013
      implicit real*8 (a-f)                                             dx6j-014
      dimension aa(2),j(5)                                              dx6j-015
      aa(1)=0.d0                                                        dx6j-016
      aa(2)=1.d0                                                        dx6j-017
      if (jt.le.2) return                                               dx6j-018
      al=at                                                             dx6j-019
      c2=0.d0                                                           dx6j-020
      bk1=dfloat(j(1)-j(5))**2                                          dx6j-021
      bk3=dfloat(j(2)-j(4))**2                                          dx6j-022
      bk2=dfloat(j(1)+j(5)+2)**2                                        dx6j-023
      bk4=dfloat(j(2)+j(4)+2)**2                                        dx6j-024
      d1=dfloat(j(1)-j(5))*dfloat(j(1)+j(5)+2)*dfloat(j(4)-j(2))*dfloat(dx6j-025
     1j(2)+j(4)+2)/16.d0                                                dx6j-026
      d2=(bk1+bk2+bk3+bk4-dfloat(4*j(3)*(j(3)+2)))/8.d0-1.d0            dx6j-027
      bk=(al+1.d0)**2                                                   dx6j-028
      do 2 i=3,jt                                                       dx6j-029
      c1=c2                                                             dx6j-030
      bk=bk-al*4.d0                                                     dx6j-031
      c2=.03125d0*dsqrt((bk3-bk)*(bk1-bk)*(bk2-bk)*(bk4-bk))            dx6j-032
      d4=.5d0*(al+.5d0*bk-1.d0)                                         dx6j-033
      aa(i)=-(al*(d1+(d2-d4)*d4)*aa(i-1)+(al-1.d0)*c1*aa(i-2))/(c2*(al+1dx6j-034
     1.d0))                                                             dx6j-035
      al=al-2.d0                                                        dx6j-036
      at=at+al*aa(i)*aa(i)                                              dx6j-037
      if (at.lt.1.d12) go to 2                                          dx6j-038
      at=at*1.d-24                                                      dx6j-039
      do 1 ii=2,i                                                       dx6j-040
    1 aa(ii)=aa(ii)*1.d-12                                              dx6j-041
    2 continue                                                          dx6j-042
      return                                                            dx6j-043
      end                                                               dx6j-044
c 29/02/04                                                      ecis03  extp-000
      subroutine extp(npp,ncoll,ncolt,wv,niv,iq,ivy,ivq,ipi,fac,nfa,va,nextp-001
     1va,ll,ipp,pip,idt,lo)                                             extp-002
c input and setup of external form factors, elastic and transitions     extp-003
c input : npp:  number of different elastic channel potentials          extp-004
c         ncoll:number of coupled nuclear states                        extp-005
c         ncolt:number of nuclear states including uncoupled ones       extp-006
c         wv:   masses of particle and target in wv(1,*) and wv(2,*)    extp-007
c         niv:  addresses in table of nuclear matrix elements (see redm)extp-008
c         iq:   table of reduced nuclear matrix elements (see redm)     extp-009
c         ivy:  table of form factors  (see redm)                       extp-010
c         ivq:  table of angular momenta (see redm)                     extp-011
c         ipi(5,*): reference to potentials                             extp-012
c         fac:  table of logarithm of factorials                        extp-013
c         nfa:  length of fac                                           extp-014
c         ipp,pip: dispersion relations, equivalent by call             extp-015
c         idt:  size of available working space                         extp-016
c         lo:   logical controls                                        extp-017
c in common /pote1/   see redm                                          extp-018
c output: va:   for optical model parameters read here                  extp-019
c         nva:  in equivalence by call with va                          extp-020
c         ll:   addresses in va in equivalence with nva(1,3)            extp-021
c           nva(1) first address after ll                               extp-022
c           nva(2) number of sets of folding parameters                 extp-023
c           nva(3) first address of folding parameters                  extp-024
c           nva(4) last address of folding parameters                   extp-025
c           ll(1,ityp,k) first address of parameters which can be variedextp-026
c             for ityp and form factor k, 1 for form factors not used   extp-027
c           ll(2,ityp,k) last address for ityp and form factor k, -1 forextp-028
c             form factors not used                                     extp-029
c                                                                       extp-030
c ityp 1 real volume or dirac scalar potential                          extp-031
c      2 imaginary volume or dirac scalar potential                     extp-032
c      3 real surface or dirac vector potential                         extp-033
c      4 imaginary surface or dirac vector potential                    extp-034
c      5 real spin-orbit or dirac tensor potential                      extp-035
c      6 imaginary spin-orbit or dirac tensor potential                 extp-036
c      7 coulomb potential                                              extp-037
c      8 coulomb spin-orbit potential                                   extp-038
c                                                                       extp-039
c l1,l2 controls the level to potential assignment                      extp-040
c ml    is 0 for the potential or the place of the transition form      extp-041
c       factor in the sequence of reduced matrix elements.              extp-042
c       the form factors contain the deformation.                       extp-043
c l1x,l2x,mlx  form factor copied to l1,l2,ml                           extp-044
c                                                                       extp-045
c the spin-orbit transition form factor to be read is the second one    extp-046
c multiplied by r**2. (multipole of an ordinary woods-saxon potential)  extp-047
c                                                                       extp-048
c itypx  -1  woods-saxon potential                                      extp-049
c        -2  first derivative   multiplied by r/sqrt(4*pi)              extp-050
c        -3  second derivative  multiplied by r**2/(8*pi)               extp-051
c        -4  third derivative   multiplied by r**3/(48*pi**(3/2))       extp-052
c        -5  deformed woods-saxon potential                             extp-053
c        -6  derivative of deformed woods-saxon potential               extp-054
c        -7  laguerre polynomial                                        extp-055
c        -8  solution in real woods-saxon potential                     extp-056
c        -9  bessel expansion                                           extp-057
c       -10  laguerre expansion                                         extp-058
c l2x gives the number of deformations, of nodes, of bessel functions,  extp-059
c                      of laguerre polynomials                          extp-060
c mlx is the l-value of bessel or laguerre expansion, or number of boundextp-061
c functions: =0 or 1 for one with the quantum numbers of the transition,extp-062
c            =2 for two functions with the same itypx,                  extp-063
c            =3 when itypx=-8 for laguerre polynomial as the second one.extp-064
c mlx and -l1x are quantum numbers of vibrational band                  extp-065
c -l1x gives the multiplication of step in computing bound function     extp-066
c -l1x is the order of derivation of bessel or laguerre expansion.      extp-067
c                                                                       extp-068
c allowed values of itypx for standard potentials                       extp-069
c ***********************************************                       extp-070
c **** ml is 0 ****                                                     extp-071
c itypx =    -1       -2,-4    -5       -6       -7,-8    -9,-10        extp-072
c ityp = 1   yes      no       yes      no       no       yes           extp-073
c ityp = 2   yes      no       yes      no       no       yes           extp-074
c ityp = 3   yes      no       yes      no       no       yes           extp-075
c ityp = 4   yes      no       yes      no       no       yes           extp-076
c ityp = 5   yes      no       yes      no       no       yes           extp-077
c ityp = 6   yes      no       yes      no       no       yes           extp-078
c ityp = 7   yes      no       yes      no       no       yes           extp-079
c ityp = 8   yes      no       yes      no       no       yes           extp-080
c **** ml is not 0 ****                                                 extp-081
c ityp = 1   yes      yes      yes      yes      yes      yes           extp-082
c ityp = 2   yes      yes      yes      yes      yes      yes           extp-083
c ityp = 3   yes      yes      yes      yes      no       yes           extp-084
c ityp = 4   yes      yes      yes      yes      no       yes           extp-085
c ityp = 5   yes      yes      yes      yes      no       yes           extp-086
c ityp = 6   yes      yes      yes      yes      no       yes           extp-087
c ityp = 7   no       yes      yes      yes      no       yes           extp-088
c ityp = 8   no       yes      yes      yes      no       yes           extp-089
c number of parameters to store                                         extp-090
c itypx = -1,-4       -5        -6        -7        -8        -9,-10    extp-091
c integer 6           7         8         15        15        9         extp-092
c real*8  4           4+l2x     4+l2x     1         23        2+l2x     extp-093
c the odd number of integer needed is rounded to next even value        extp-094
c there is one more for coulomb potentials and itypx=-1 to -6.          extp-095
c there are 5 more parameters for itypx=-7 and mlx=2.                   extp-096
c there are 16 or 6 more parameters for itypx=-8 and mlx=2 or mlx=3.    extp-097
c***********************************************************************extp-098
      implicit real*8 (a-h,o-z)                                         extp-099
      logical lo(250)                                                   extp-100
      dimension ivy(7,1),ivq(3,1),niv(ncoll,ncoll,2),iq(6,1),ipi(11,1),fextp-101
     1ac(1),va(150),nva(300),ll(2,8,1),itz(10),wv(18,1),ipp(2,15,1),pip(extp-102
     215,1)                                                             extp-103
      character*8 aa(3,8)                                               extp-104
      character*4 ierm,last                                             extp-105
      common /pote1/ itx(16),imax,intc,inls,invc,invd,itxm              extp-106
      common /inout/ mr,mw,ms                                           extp-107
      data aa /'      re','al volum','e/scalar',' imagina','ry volum','eextp-108
     1/scalar','     rea','l surfac','e/vector','  imagin','. surfac','eextp-109
     2/vector','  real s','pin-orbi','t/tensor',' imag. s','pin-orbi','textp-110
     3/tensor','        ','        ',' coulomb','      sp','in-orbit',' extp-111
     4coulomb'/                                                         extp-112
      data itz /2,2,2,2,3,4,7,7,4,4/                                    extp-113
      data ierm /'last'/                                                extp-114
      if (lo(99)) go to 43                                              extp-115
      npx=npp+intc                                                      extp-116
      nma=3+8*npx                                                       extp-117
      nva(1)=nma                                                        extp-118
      if (nma.gt.idt) call memo('extp',idt,nma,2)                       extp-119
c setting the controls of input                                         extp-120
      ntot=0                                                            extp-121
      do 9 i=1,npx                                                      extp-122
      do 1 j=1,16                                                       extp-123
      ll(1,j,i)=-1                                                      extp-124
    1 ll(2,j,i)=-1                                                      extp-125
      if (i.gt.npp) go to 2                                             extp-126
      if (lo(201)) ll(1,5,i)=1                                          extp-127
      if (lo(202)) ll(1,6,i)=1                                          extp-128
      if (lo(201)) ll(1,8,i)=1                                          extp-129
      go to 7                                                           extp-130
    2 k=i-npp                                                           extp-131
      l=ivy(2,k)                                                        extp-132
      if (ivq(2,l).ge.0) go to 4                                        extp-133
      do 3 l=1,6                                                        extp-134
    3 ll(1,l,i)=1                                                       extp-135
      ll(1,8,i)=1                                                       extp-136
      go to 7                                                           extp-137
    4 if (lo(12)) go to 5                                               extp-138
      ll(1,2,i)=1                                                       extp-139
      ll(1,4,i)=1                                                       extp-140
    5 if (lo(100)) go to 6                                              extp-141
      if (k.gt.inls) ll(1,5,i)=1                                        extp-142
      if (lo(114).or.k.gt.inls) ll(1,6,i)=1                             extp-143
      if (k.gt.invc) ll(1,7,i)=1                                        extp-144
      if (k.gt.invd) ll(1,8,i)=1                                        extp-145
      go to 7                                                           extp-146
    6 if (ivy(3,k).eq.0) ll(1,5,i)=1                                    extp-147
      if (lo(114).or.ivy(3,k).eq.0) ll(1,6,i)=1                         extp-148
      if (ivy(4,k).eq.0) ll(1,7,i)=1                                    extp-149
      if (ivy(5,k).eq.0) ll(1,8,i)=1                                    extp-150
c count of form factors to be read                                      extp-151
    7 do 8 j=1,8                                                        extp-152
      if (ll(1,j,i).eq.-1) ntot=ntot+1                                  extp-153
    8 continue                                                          extp-154
    9 continue                                                          extp-155
      nfold=0                                                           extp-156
   10 if (ntot.le.0) go to 41                                           extp-157
c input of a form factor                                                extp-158
      read (mr,1000,err= 44 ) l1,l2,ml,ityp,l1x,l2x,mlx,itypx,nst,nfold,extp-159
     1mint                                                              extp-160
      if (ityp.gt.8.or.iabs(nst).gt.ncolt.or.ityp.le.0) go to 45        extp-161
      nfold=max0(nfold,nfold)                                           extp-162
      if (iabs(ml).ne.0) go to 11                                       extp-163
c test for a potential                                                  extp-164
      if (l1.ne.l2.or.l1.gt.ncolt) go to 46                             extp-165
      lz=ipi(5,l1)                                                      extp-166
      if (nst.eq.0) nst=l1                                              extp-167
      if (lo(173)) write (mw,1001) (aa(k,ityp),k=1,3),lz                extp-168
      go to 14                                                          extp-169
c test for a transition                                                 extp-170
   11 if (l1.gt.ncoll.or.l2.gt.ncoll) go to 47                          extp-171
      ly=niv(l1,l2,1)+iabs(ml)-1                                        extp-172
      if (ly.gt.niv(l1,l2,2)) go to 48                                  extp-173
      lx=iq(1,ly)                                                       extp-174
      if (ml.gt.0) go to 12                                             extp-175
      lx=ivy(6,lx)                                                      extp-176
      if (lx.le.0) go to 49                                             extp-177
   12 if (lo(100)) go to 13                                             extp-178
      if ((ityp.eq.5).or.(ityp.eq.6)) lx=ivy(3,lx)                      extp-179
      if (ityp.ge.7) lx=ivy(ityp-3,lx)                                  extp-180
   13 lz=lx+npp                                                         extp-181
      if (nst.eq.0) nst=1                                               extp-182
      if (lo(173)) write (mw,1002) (aa(k,ityp),k=1,3),l1,l2,ml          extp-183
c test it is not already read and that there is place                   extp-184
   14 if (ll(1,ityp,lz).ne.-1) go to 50                                 extp-185
      if (nma+31.gt.idt) call memo('extp',idt,nma+32,2)                 extp-186
      ntot=ntot-1                                                       extp-187
      nna=2*nma-1                                                       extp-188
      nva(nna)=8*lz+ityp                                                extp-189
      nva(nna+2)=nfold                                                  extp-190
      if (itypx.lt.0.or.l1x.le.0) go to 21                              extp-191
      nva(nna+5)=nma                                                    extp-192
      nmd=nma+3                                                         extp-193
      ll(1,ityp,lz)=nmd                                                 extp-194
      va(nmd)=1.d0                                                      extp-195
      if (mint.lt.0) read (mr,1003,err= 58 ) va(nmd)                    extp-196
c use of already stored form factor/test existence of copied form factorextp-197
      if (ityp.ne.itypx) go to 51                                       extp-198
      if (ml.ne.0) go to 15                                             extp-199
      if (l1x.ne.l2x.or.l1x.gt.ncolt) go to 52                          extp-200
      lzx=ipi(5,l1x)                                                    extp-201
      if (lo(173)) write (mw,1004) l1x,itypx,l1                         extp-202
      go to 17                                                          extp-203
   15 if (l1x.gt.ncoll.or.l2x.gt.ncoll) go to 53                        extp-204
      lyy=niv(l1x,l2x,1)+mlx-1                                          extp-205
      if (lyy.gt.niv(l1x,l2x,2)) go to 54                               extp-206
      lxx=iq(1,lyy)                                                     extp-207
      if (lo(100)) go to 16                                             extp-208
      if ((ityp.eq.5).or.(ityp.eq.6)) lxx=ivy(3,lxx)                    extp-209
      if (ityp.ge.7) lxx=ivy(ityp-3,lxx)                                extp-210
   16 lzx=lxx+npp                                                       extp-211
      if (lo(173)) write (mw,1005) l1x,l2x,mlx,itypx,l1,l2,ml           extp-212
   17 nmc=ll(1,ityp,lzx)                                                extp-213
      if (nmc.eq.-1) go to 55                                           extp-214
c use of already stored form factor/test possibility to copy            extp-215
      nmb=nva(2*nmc-2)                                                  extp-216
      itypx=-nva(2*nmb)                                                 extp-217
      if (nva(2*nmb+1).eq.0.and.nfold.ne.0) nva(2*nmb+1)=-1             extp-218
      if (nva(2*nmb+1).ne.0.and.nfold.eq.0) nva(2*nma+1)=-1             extp-219
      if (itypx.ne.-16) go to 18                                        extp-220
      lzx=(nva(2*nmb+2)-1)/8                                            extp-221
      go to 17                                                          extp-222
   18 if (itypx.gt.-5.or.ml.eq.0) go to 20                              extp-223
      if (itypx.ne.-7.and.itypx.ne.-8) go to 19                         extp-224
      ll(1,ityp+2,lz)=1                                                 extp-225
      ntot=ntot-1                                                       extp-226
      nmb=nmb+itz(-itypx)                                               extp-227
      if (nva(2*nmb-1).eq.1) go to 19                                   extp-228
      if (nva(2*nmb+2).ne.1.or.nva(2*nmb+6).ne.1) go to 20              extp-229
      k=iq(2,ly)                                                        extp-230
      va(nmd)=dcgs(2*ivq(1,k),nva(2*nmb+3),nva(2*nmb+7),fac,nfa)*dsqrt(2extp-231
     1.d0*ivq(1,k)+1.d0)/va(nmc)                                        extp-232
      if (va(nmd).eq.0.d0) go to 56                                     extp-233
      go to 20                                                          extp-234
   19 if (iq(2,ly).ne.iq(2,lyy)) go to 57                               extp-235
   20 nva(nna+1)=16                                                     extp-236
      nva(nna+3)=8*lzx+ityp                                             extp-237
      nva(nna+4)=nma                                                    extp-238
      nmb=nma+2                                                         extp-239
      if (lo(173)) write (mw,1006) nma,nmb,(nva(nna+i),i=0,4),nmd,va(nmdextp-240
     1)                                                                 extp-241
      ll(2,ityp,lz)=nmd                                                 extp-242
      nma=nmd+1                                                         extp-243
      go to 40                                                          extp-244
   21 nva(nna+3)=mint                                                   extp-245
      nva(nna+4)=nst                                                    extp-246
      if (itypx.lt.0) go to 23                                          extp-247
      nva(nna+5)=nma                                                    extp-248
      ll(1,ityp,lz)=nma+3                                               extp-249
c form factor read from cards                                           extp-250
      read (mr,1003,err= 58 ) va(nma+3),va(nma+4)                       extp-251
      if (va(nma+3).eq.0.d0) va(nma+3)=1.d0                             extp-252
      if (va(nma+4).eq.0.d0) va(nma+4)=1.d0                             extp-253
      nm=nma+5                                                          extp-254
   22 nmb=nm+3                                                          extp-255
      if (nmb.gt.idt) call memo('extp',idt,nmb,2)                       extp-256
      read (mr,1007,err= 58 ) (va(i),i=nm,nmb),last                     extp-257
      nm=nmb+1                                                          extp-258
      if (last.ne.ierm) go to 22                                        extp-259
      nvn=nma+2                                                         extp-260
      nm1=nvn+1                                                         extp-261
      nm2=nvn+2                                                         extp-262
      nm3=nvn+3                                                         extp-263
      nva(2*nma)=1-(nmb-nvn)/2                                          extp-264
      if (lo(173)) write (mw,1008) nma,nvn,(nva(nna+i-1),i=1,6),nm1,nm2,extp-265
     1va(nm1),va(nm2),nm3,nmb,(va(i),i=nm3,nmb)                         extp-266
      ll(2,ityp,lz)=nmb                                                 extp-267
      nma=nmb+1                                                         extp-268
      go to 40                                                          extp-269
c standard form factors                                                 extp-270
   23 if (itypx.lt.-10) go to 59                                        extp-271
      itypy=-itypx                                                      extp-272
      if (itypy.lt.9) go to 24                                          extp-273
      if ((ml.ne.0).and.(mlx.eq.0)) mlx=ivy(7,lx)                       extp-274
      if (mlx.lt.0) mlx=0                                               extp-275
      go to 25                                                          extp-276
   24 if (((itypy-1)*(itypy-5).ne.0).and.ml.eq.0) go to 60              extp-277
      if ((itypy.eq.1).and.(ml.ne.0).and.(ityp.ge.7)) go to 61          extp-278
      if ((itypy.ge.7).and.(ityp.gt.2)) go to 62                        extp-279
   25 nva(nna+1)=itypy                                                  extp-280
      nmb=nma+itz(itypy)                                                extp-281
      if (itypy.lt.5) go to 26                                          extp-282
      nva(nna+5)=l2x                                                    extp-283
      nva(nna+6)=mlx                                                    extp-284
      nva(nna+7)=-l1x                                                   extp-285
      if (itypy.eq.7.or.itypy.eq.8) go to 32                            extp-286
      nva(2*nmb-1)=nma                                                  extp-287
   26 nva(2*nmb)=nma                                                    extp-288
      ll(1,ityp,lz)=nmb+1                                               extp-289
      if (lo(73)) go to 27                                              extp-290
      if (itypy.ge.9) write (mw,1009) nma,nmb,(nva(nna+i-1),i=1,9)      extp-291
      if (itypy.eq.6) write (mw,1010) nma,nmb,(nva(nna+i-1),i=1,9)      extp-292
      if (itypy.eq.5) write (mw,1011) nma,nmb,(nva(nna+i-1),i=1,7)      extp-293
      if (itypy.lt.5) write (mw,1012) nma,nmb,(nva(nna+i-1),i=1,6)      extp-294
   27 if (itypy.ge.9) go to 29                                          extp-295
      nma=nmb+1                                                         extp-296
      nmb=nmb+4                                                         extp-297
      if (ityp.gt.6) nmb=nmb+1                                          extp-298
      read (mr,1003,err= 58 ) (va(i),i=nma,nmb)                         extp-299
      if (itypy.gt.6) go to 28                                          extp-300
      k=iabs(nst)                                                       extp-301
      if (k.eq.nst) go to 28                                            extp-302
      if (lo(173)) write (mw,1013) va(nma),va(nma+1)                    extp-303
      ex=wv(2,k)**.33333333333333d0                                     extp-304
      ey=ex                                                             extp-305
      if (lo(16)) ex=ex+wv(1,k)**.33333333333333d0                      extp-306
      ey=ey/ex                                                          extp-307
      va(nma+1)=va(nma+1)*ex                                            extp-308
      if (lo(116).or.ml.eq.0) go to 28                                  extp-309
      ityz=itypy                                                        extp-310
      if (ityz.ge.5) ityz=ityz-4                                        extp-311
      ityw=1                                                            extp-312
      k=iq(2,ly)                                                        extp-313
      if (ityp.gt.6) ityw=ityw*ivq(1,k)                                 extp-314
      if (lo(6)) ityw=ityw-1                                            extp-315
      if (ityz.gt.1) va(nma)=va(nma)*ey**((ityz-1)*ityw)                extp-316
   28 if (lo(173)) write (mw,1014) nma,nmb,(va(i),i=nma,nmb)            extp-317
      if (itypy.lt.5) go to 39                                          extp-318
   29 nma=nmb+1                                                         extp-319
      nmc=nma                                                           extp-320
      if (itypy.ge.9) nmc=nmc+2                                         extp-321
      nmb=nmc+l2x-1                                                     extp-322
      if (nmb.gt.idt) call memo('extp',idt,nmb,2)                       extp-323
      read (mr,1003,err= 58 ) (va(i),i=nma,nmb)                         extp-324
      if ((itypy.ge.9).and.(va(nma).eq.0.d0)) va(nma)=1.d0              extp-325
      if (nst.gt.0.or.itypy.ge.9) go to 31                              extp-326
      if (lo(173)) write (mw,1015) (va(i),i=nma,nmb)                    extp-327
      do 30 i=nma,nmb                                                   extp-328
      j=i-nma                                                           extp-329
      if (ityp.lt.7) j=0                                                extp-330
      if (lo(106)) j=j+1                                                extp-331
   30 va(i)=va(i)*ey**j                                                 extp-332
   31 if (lo(73)) go to 39                                              extp-333
      if (itypy.ge.9) write (mw,1016) nma,nmb,va(nma),va(nma+1),l2x,(i,vextp-334
     1a(i),i=nmc,nmb)                                                   extp-335
      if (itypy.lt.9) write (mw,1017) nma,nmb,l2x,(i,va(i),i=nma,nmb)   extp-336
      go to 39                                                          extp-337
   32 ll(1,ityp+2,lz)=1                                                 extp-338
      ntot=ntot-1                                                       extp-339
      if (lo(100)) go to 63                                             extp-340
      nva(nna+7)=-l1x                                                   extp-341
      if (mlx.eq.0) mlx=1                                               extp-342
      if ((mlx.lt.0.or.mlx.gt.3).or.(mlx.eq.3.and.itypy.eq.7)) go to 64 extp-343
      nva(nna+6)=mlx                                                    extp-344
      mly=mlx                                                           extp-345
      nmd=nma+2                                                         extp-346
      if (lo(173)) write (mw,1018) nma,nmd,(nva(nna+i-1),i=1,6)         extp-347
      nmd=nmd+1                                                         extp-348
      k=iq(2,ly)                                                        extp-349
      if (mlx.gt.1) go to 34                                            extp-350
      do 33 i=1,3                                                       extp-351
   33 nva(nna+7+i)=ivq(i,k)                                             extp-352
      nva(nna+11)=nma                                                   extp-353
      nmb=nmd+2                                                         extp-354
      if (lo(173)) write (mw,1019) nmd,nmb,(nva(nna+i),i=6,11)          extp-355
      nmc=nmb                                                           extp-356
      go to 36                                                          extp-357
   34 read (mr,1000) (nva(nna+i),i=7,14),nvc                            extp-358
      if (nva(nna+9).eq.1.and.nvc.eq.0) nva(nna+9)=-3                   extp-359
      nmb=nma+7                                                         extp-360
      nva(nna+15)=nma                                                   extp-361
      nmc=nmb+1                                                         extp-362
      va(nmc)=1.d0                                                      extp-363
      if (nva(nna+9).ne.1.or.nva(nna+13).ne.1.or.nvc.eq.0) go to 35     extp-364
      va(nmc)=dcgs(2*ivq(1,k),nva(nna+10),nva(nna+14),fac,nfa)*dsqrt(dflextp-365
     1oat(2*ivq(1,k)+1))                                                extp-366
      if (va(nmc).eq.0.d0) go to 56                                     extp-367
   35 if (lo(173)) write (mw,1020) nmd,nmb,(nva(nna+i),i=6,15),nmc,va(nmextp-368
     1c)                                                                extp-369
   36 nmc=nmc+1                                                         extp-370
      ll(1,ityp,lz)=nmb+1                                               extp-371
      if (itypy.eq.8) go to 38                                          extp-372
   37 read (mr,1003,err= 58 ) (va(nmc+i-1),i=1,mlx)                     extp-373
      if (mlx.eq.2.and.va(nmc+1).eq.0.d0) va(nmc+1)=va(nmc)             extp-374
      nmb=nmc+mlx-1                                                     extp-375
      if (lo(173)) write (mw,1021) nmc,nmb,(va(i),i=nmc,nmb)            extp-376
      go to 39                                                          extp-377
   38 nmb=nmc+10                                                        extp-378
      read (mr,1003,err= 58 ) (va(i),i=nmc,nmb)                         extp-379
      if (va(nmc+4).eq.0.d0) va(nmc+4)=35.d0                            extp-380
      if (lo(173)) write (mw,1022) nmc,nmb,(va(i),i=nmc,nmb)            extp-381
      if (mlx.eq.1.and.mly.eq.2.and.va(nmc-10).lt.0.d0.and.va(nmc).lt.0.extp-382
     1d0) go to 65                                                      extp-383
      nmc=nmb+1                                                         extp-384
      mlx=mlx-2                                                         extp-385
      if (mlx.eq.1) go to 37                                            extp-386
      if (mlx.eq.0) go to 38                                            extp-387
   39 ll(2,ityp,lz)=nmb                                                 extp-388
      nma=nmb+1                                                         extp-389
   40 if (lo(110).or.lz.gt.npp) go to 10                                extp-390
      nmc=ll(1,ityp,lz)                                                 extp-391
      ex=va(nmc)                                                        extp-392
      if (ipp(1,2,lz).ne.0.and.ex.eq.0.d0.and.ityp.eq.2) go to 66       extp-393
      if (ipp(2,2,lz).ne.0.and.ex.eq.0.d0.and.ityp.eq.4) go to 67       extp-394
      if (pip(15,lz).ne.0.d0.and.ex.eq.0.d0.and.ityp.eq.1) go to 68     extp-395
      if (pip(7,lz).ne.0.d0.and.ex.eq.0.d0.and.ityp.eq.5) go to 69      extp-396
      if (pip(8,lz).ne.0.d0.and.ex.eq.0.d0.and.ityp.eq.6) go to 70      extp-397
      go to 10                                                          extp-398
   41 nva(2)=nfold                                                      extp-399
      nva(3)=nma                                                        extp-400
      nva(4)=nma                                                        extp-401
      if (nfold.eq.0) return                                            extp-402
      if (lo(173)) write (mw,1023) nfold                                extp-403
      do 42 i=1,nfold                                                   extp-404
      read (mr,1003,err= 75 ) va(nma),va(nma+1),va(nma+2)               extp-405
      if (lo(173)) write (mw,1024) i,va(nma),va(nma+1),va(nma+2)        extp-406
   42 nva(4)=nva(4)+3                                                   extp-407
      return                                                            extp-408
   43 write (mw,1025)                                                   extp-409
      go to 71                                                          extp-410
   44 write (mw,1026)                                                   extp-411
      go to 71                                                          extp-412
   45 write (mw,1027) ityp,nst,ncolt                                    extp-413
      go to 71                                                          extp-414
   46 write (mw,1028) ml,l1,l2,ncolt                                    extp-415
      go to 71                                                          extp-416
   47 write (mw,1029) ml,l1,l2,ncoll                                    extp-417
      go to 71                                                          extp-418
   48 write (mw,1030) ml,l1,l2                                          extp-419
      go to 71                                                          extp-420
   49 write (mw,1031) l1,l2,ml                                          extp-421
      go to 71                                                          extp-422
   50 write (mw,1032) l1,l2,ml,ityp                                     extp-423
      go to 71                                                          extp-424
   51 write (mw,1033) l1,l2,ml,ityp,l1x,l2x,mlx,itypx                   extp-425
      go to 71                                                          extp-426
   52 write (mw,1034) mlx,l1x,l2x,ncolt                                 extp-427
      go to 71                                                          extp-428
   53 write (mw,1035) mlx,l1x,l2x,ncoll                                 extp-429
      go to 71                                                          extp-430
   54 write (mw,1036) mlx,l1x,l2x,ncoll                                 extp-431
      go to 71                                                          extp-432
   55 write (mw,1037) mlx,l1x,l2x,itypx                                 extp-433
      go to 71                                                          extp-434
   56 write (mw,1038) nva(nna+8),nva(nna+12),k                          extp-435
      go to 71                                                          extp-436
   57 write (mw,1039) itypx,iq(2,lyy),iq(2,ly)                          extp-437
      go to 71                                                          extp-438
   58 write (mw,1040) ityp,lz                                           extp-439
      go to 71                                                          extp-440
   59 write (mw,1041) itypx                                             extp-441
      go to 71                                                          extp-442
   60 write (mw,1042) itypx,ityp                                        extp-443
      go to 71                                                          extp-444
   61 write (mw,1043) itypx,ityp                                        extp-445
      go to 71                                                          extp-446
   62 write (mw,1044) itypx,ityp                                        extp-447
      go to 71                                                          extp-448
   63 write (mw,1045) itypx                                             extp-449
      go to 71                                                          extp-450
   64 write (mw,1046) mlx,itypx                                         extp-451
      go to 71                                                          extp-452
   65 write (mw,1047) va(nmc-10),va(nmc)                                extp-453
      go to 71                                                          extp-454
   66 write (mw,1048) lz,ipp(1,2,lz),ex                                 extp-455
      go to 71                                                          extp-456
   67 write (mw,1049) lz,ipp(2,2,lz),ex                                 extp-457
      go to 71                                                          extp-458
   68 write (mw,1050) lz,lz,pip(15,lz),ex                               extp-459
      go to 71                                                          extp-460
   69 write (mw,1051) lz,lz,pip(7,lz),ex                                extp-461
      go to 71                                                          extp-462
   70 write (mw,1052) lz,lz,pip(8,lz),ex                                extp-463
   71 if (ntot.eq.0) go to 76                                           extp-464
      write (mw,1053) ntot,npp                                          extp-465
      do 74 j=1,npx                                                     extp-466
      do 73 i=1,8                                                       extp-467
      if (ll(1,i,j).ne.-1) go to 73                                     extp-468
      if (j.gt.npp) go to 72                                            extp-469
      write (mw,1054) (aa(k,i),k=1,3),j                                 extp-470
      go to 73                                                          extp-471
   72 write (mw,1055) (aa(k,i),k=1,3),j-npp                             extp-472
   73 continue                                                          extp-473
   74 continue                                                          extp-474
      go to 76                                                          extp-475
   75 write (mw,1056) i,nfold                                           extp-476
   76 write (mw,1057)                                                   extp-477
      stop                                                              extp-478
 1000 format (12i5)                                                     extp-479
 1001 format (/3a8,' potential nr(',i2,')')                             extp-480
 1002 format (/3a8,' transition potential from level(',i2,') to level(',extp-481
     1i2,') and the order ml =',i2)                                     extp-482
 1003 format (7f10.5)                                                   extp-483
 1004 format (' the elastic potential nr(',i2,') typ(',i1,') is copied textp-484
     1o nr(',i2,')')                                                    extp-485
 1005 format (' transition potential l1(',i2,') l2(',i2,') ml(',i2,') tyextp-486
     1p(',i2,') is copied to l1(',i2,') l2(',i2,') ml(',i2,')')         extp-487
 1006 format (' using parameters',i6,' to',i6,' for copy to:',i5,5x,'(coextp-488
     1py):',i3,5x,'fold =',i3,5x,'from:',i5,5x,'start:',i5/' using paramextp-489
     2eter',i6,' for multiplicative factor',d15.8)                      extp-490
 1007 format (f10.5,f20.10,f10.5,f20.10,a4)                             extp-491
 1008 format (' using parameters',i6,' to',i6,' to store:'/i5,5x,'nb poiextp-492
     1nts:',i5,5x,'fold:',i2,5x,'intg:',i2,5x,'step:',i2,5x,'start:',i5/extp-493
     25x,'parameters',i6,' to',i6,' to store:'/20x,'strength:',f15.6,10xextp-494
     3,'scale:',f15.6/' and parameters',i6,' to',i6,' to store:'/4(6x,'rextp-495
     4adius',7x,'potential',2x)/(4(2x,0p,f10.5,3x,1p,d15.7)))           extp-496
 1009 format (' using parameters',i6,' to',i6,' to store:'/i5,3x,'type:'extp-497
     1,i2,3x,'fold:',i2,3x,'intg:',i2,3x,'step:',i2,i6,' functions  l:',extp-498
     2i3,i4,' derivations  start:',i5)                                  extp-499
 1010 format (' using parameters',i6,' to',i6,' to store:'/i5,3x,'type:'extp-500
     1,i2,3x,'fold:',i2,3x,'intg:',i2,3x,'step:',i2,i6,' deformations   extp-501
     2lbet:',i5,5x,'kbet:',i5,5x,'start:',i5)                           extp-502
 1011 format (' using parameters',i6,' to',i6,' to store:'/i5,3x,'type:'extp-503
     1,i2,3x,'fold:',i2,3x,'intg:',i2,3x,'step:',i2,i6,' deformations',5extp-504
     2x,'start:',i5)                                                    extp-505
 1012 format (' using parameters',i6,' to',i6,' to store:',i4,3x,'type:'extp-506
     1,i2,3x,'fold:',i2,3x,'intg:',i2,3x,'step:',i2,5x,'start:',i5)     extp-507
 1013 format (' values read:',f12.6,3x,f9.6)                            extp-508
 1014 format (' using parameters',i6,' to',i6,' for'/' depth',f12.6,' meextp-509
     1v  radius',f10.6,' f  diffuseness',f9.6,' f at the power (1.+',f9.extp-510
     26,')',2x,f9.6,' (3rd coul. parm.)'/)                              extp-511
 1015 format (' deformations read:',8f10.5/(19x,8f10.5))                extp-512
 1016 format (' using parameters',i6,' to',i6,' for strength:',f12.6,10xextp-513
     1,'scale:',f12.6/' and to store',i5,' bessel function or legendre pextp-514
     2olynomials coefficients:'/(6(3x,i5,f10.5)))                       extp-515
 1017 format (' using parameters',i6,' to',i6,' for',i5,' deformations:'extp-516
     1/(6(3x,i5,f10.5)))                                                extp-517
 1018 format (' using parameters',i6,' to',i6,' to store:',i4,3x,'type:'extp-518
     1,i2,3x,'fold:',i2,3x,'intg:',i2,3x,'step:',i2,5x,'mult:',i3)      extp-519
 1019 format (' using parameters',i6,' to',i6,' to store:',i2,' functionextp-520
     1s   n =',i2,3x,'l =',i3,3x,'2*s =',i2,3x,'2*j =',i3,5x,'start:',i5extp-521
     2)                                                                 extp-522
 1020 format (' using parameters',i6,' to',i6,' to store:'/i5,' functionextp-523
     1s',2(2x,'n =',i2,3x,'l =',i3,3x,'2*s =',i2,3x,'2*j =',i3),5x,'starextp-524
     2t:',i5/' using parameter',i6,' for multiplicative factor',d18.8)  extp-525
 1021 format (' using parameters',i6,' to',i6,' for the oscillator paramextp-526
     1eter',2f10.5)                                                     extp-527
 1022 format (' using parameters',i6,' to',i6,' to store:'/' **** bindinextp-528
     1g energy',f12.6,' mev ****',2x,'total mass',f12.6,2x,'particle masextp-529
     2s',f12.6,2x,'product of charges',f8.2/' search on depth of real poextp-530
     3tential from',f12.6,' with reduced radius',f10.6,' fermi and diffuextp-531
     4seness',f10.6,' fermi'/' spin-orbit potential  depth:',f12.6,' mevextp-532
     5  radius:',f10.6,' f  diffuseness:',f9.6,' f  coulomb radius:',f10extp-533
     6.6,' f'/)                                                         extp-534
 1023 format (/2x,i3,' sets of folding parameters')                     extp-535
 1024 format (2x,i2,5x,' v =',f12.6,5x,' r =',f9.6,5x,' a =',f9.6)      extp-536
 1025 format (' external form factors not allowed with schroedinder equiextp-537
     1valent of dirac equation')                                        extp-538
 1026 format (' input error in the first card defining the potential')  extp-539
 1027 format (/' ityp =',i5,' not allowed or nst =',i5,' larger than ncoextp-540
     1lt =',i3)                                                         extp-541
 1028 format (' with ml =',i2,' l1 =',i3,' is not equal to l2 =',i3,' orextp-542
     1 is larger than ncolt =',i3)                                      extp-543
 1029 format (' with ml =',i3,' l1 =',i3,' or l2 =',i3,' is larger than extp-544
     1ncoll =',i3)                                                      extp-545
 1030 format (' ml =',i3,' too large between levels l1 =',i3,' and l2 ='extp-546
     1,i3)                                                              extp-547
 1031 format (' there is no correction term of the form factor for l1 ='extp-548
     1,i3,'  l2 =',i3,'  ml =',i3)                                      extp-549
 1032 format (' the form factor for l1 =',i3,'  l2 =',i3,'  ml =',i3,'  extp-550
     1and ityp =',i2,' is already read or does not have to be read')    extp-551
 1033 format (/' different types not allowed to copy for form factors l1extp-552
     1/l2/ml/ityp/l1x/l2x/mlx/itypx :'/30x,8i5)                         extp-553
 1034 format (' with mlx =',i2,' l1x =',i3,' is not equal to l2x =',i3,'extp-554
     1 or is larger than ncolt =',i3)                                   extp-555
 1035 format (' with mlx =',i3,' l1x =',i3,' or l2x =',i3,' is larger thextp-556
     1an ncoll =',i3)                                                   extp-557
 1036 format (' mlx =',i3,' too large between levels l1x =',i3,' and l2xextp-558
     1 =',i5)                                                           extp-559
 1037 format (' form factor defined by l1x =',i3,'  l2x =',i3,'  mlx =',extp-560
     1i3,'  itypx =',i3,' not yet defined')                             extp-561
 1038 format (' no particle-hole coupling with 2*jp =',i3,' and 2*jh =',extp-562
     1i3,' to l =',i3)                                                  extp-563
 1039 format (' copy with itypx =',i3,' not allowed between transitions extp-564
     1with quantum numbers',i2,' and',i2)                               extp-565
 1040 format (' input error for the potential (',i2,',',i2,')')         extp-566
 1041 format (/' itypx =',i5,' not allowed for standard form factors')  extp-567
 1042 format (' itypx,ityp =',2i5,'  not allowed: central potential cannextp-568
     1ot be derivative or bound function')                              extp-569
 1043 format (' itypx,ityp =',2i5,'  not allowed: coulomb transition forextp-570
     1m factor must be derivative')                                     extp-571
 1044 format (' itypx,ityp =',2i5,'  not allowed: bound state function cextp-572
     1an be only real or imaginary transition potential')               extp-573
 1045 format (' itypx =',i3,'  not allowed in dirac formalism')         extp-574
 1046 format (' l2x =',i3,'  not allowed with itypx =',i4)              extp-575
 1047 format (' for ityp=-8 and two functions, both are unbounded',2f12.extp-576
     16)                                                                extp-577
 1048 format (' the potential',i4,' cannot be used for dispersion relatiextp-578
     1ons because the volume imaginary strength is 0:'/10x,'nv =',i3,'  extp-579
     1wv =',d13.6)                                                      extp-580
 1049 format (' the potential',i4,' cannot be used for dispersion relatiextp-581
     1ons because the surface imaginary strength is 0:'/10x,'ns =',i3,' extp-582
     2 ws =',d13.6)                                                     extp-583
 1050 format (' the potential',i4,' cannot be used with variation of theextp-584
     1 hartree-fock potential of which the strength is 0':/10x,'pip(15,'extp-585
     2,i2,') =',d13.6,'  v =',d13.6)                                    extp-586
 1051 format (' the potential',i4,' cannot be used with variation of theextp-587
     1 real spin-orbit of which the strength is 0':/10x,'pip(7,',i2,') =extp-588
     2',d13.6,'  vls =',d13.6)                                          extp-589
 1052 format (' the potential',i4,' cannot be used with variation of theextp-590
     1 imaginary spin-orbit of which the strength is 0':/10x,'pip(8,',i2extp-591
     2,') =',d13.6,'  wls =',d13.6)                                     extp-592
 1053 format (i6,' form factors to read, for (ityp, n  )  ( potentials fextp-593
     1or n smaller than',i2,' transitions after)')                      extp-594
 1054 format (10x,3a8,' missing for potential',i4)                      extp-595
 1055 format (10x,3a8,' missing for transition',i4)                     extp-596
 1056 format (' input error for the',i4,'th set of the',i4,' sets of folextp-597
     1ding parameters to be read')                                      extp-598
 1057 format (' in extp  .... stop ....')                               extp-599
      end                                                               extp-600
c 29/02/04                                                      ecis03  dcgs-000
      function dcgs(l,j1,j2,fac,nfa)                                    dcgs-001
c   cgs(l,j1,j2) =                                                      dcgs-002
c                                 /~~~~~~~~~~~~~~~~   ( j2   l   j1  )  dcgs-003
c  cgs(l,j1,j2) = (-)**(j1+1/2)  / (2*j1+1)*(2*j2+1)  (              )  dcgs-004
c                               v                     (-1/2  0   1/2 )  dcgs-005
c  when j1 and j2 are half-integers                                     dcgs-006
c                              ( j2  l  j1 )                            dcgs-007
c  cgs(l,j1,j2) = (-)**(j1-1)  (           )                            dcgs-008
c                              (  0  0  0  )                            dcgs-009
c  when j1 and j2  are integers                                         dcgs-010
c l,j1,j2 are integer double values.                                    dcgs-011
c fac is a table of logarithm of factorials and nfa its length.         dcgs-012
c***********************************************************************dcgs-013
      implicit real*8 (a-h,o-z)                                         dcgs-014
      dimension fac(1)                                                  dcgs-015
      if (l.lt.0.or.j1.lt.0.or.j2.lt.0) go to 1                         dcgs-016
      ll=l+j1+j2+2                                                      dcgs-017
      lt=ll/2                                                           dcgs-018
      if (2*lt.ne.ll) go to 1                                           dcgs-019
      if (lt.ge.nfa) go to 1                                            dcgs-020
      l1=lt-j1                                                          dcgs-021
      l2=lt-j2                                                          dcgs-022
      l3=lt-l                                                           dcgs-023
      if (l1.le.0.or.l2.le.0.or.l3.le.0) go to 1                        dcgs-024
      l4=lt+1                                                           dcgs-025
      n1=(l1+1)/2                                                       dcgs-026
      n2=(l2+1)/2                                                       dcgs-027
      n3=(l3+1)/2                                                       dcgs-028
      n4=(l4+1)/2                                                       dcgs-029
      dcgs=dexp(fac(n4)-fac(n1)-fac(n2)-fac(n3)-.5d0*(fac(l4)-fac(l1)-fadcgs-030
     1c(l2)-fac(l3)))                                                   dcgs-031
      if (2*(n1/2).ne.n1) dcgs=-dcgs                                    dcgs-032
      if (n4-n1-n2-n3+1) 3 , 2 , 1                                      dcgs-033
    1 dcgs=0.d0                                                         dcgs-034
    2 dcgs=2.d0*dcgs                                                    dcgs-035
    3 return                                                            dcgs-036
      end                                                               dcgs-037
c 29/02/04                                                      ecis03  conu-000
      subroutine conu(ix,ipi,wv,ipim,wvm,nci,xd,scn,kxt,lo)             conu-001
c discretisation of continua for compound nucleus                       conu-002
c input variables:   ix:  0 for count of points                         conu-003
c               any other value for computation of points, weights, ... conu-004
c                    wv:        see calx                                conu-005
c                    scn:       descriptions of level densities         conu-006
c                    lo:        logical controls                        conu-007
c output variables:  ipim,wvm:  ipi,wv for continua of comp. nucleus    conu-008
c                    nci: starting and final addresses for continua     conu-009
c                    xd:  steps of discretisation of continua           conu-010
c                          energy and spin dependence of level densitiesconu-011
c                    kxt: number of transmission coefficients           conu-012
c in scn:  1-sa  2-ux   3-tau  4-sg   5-e0   6-ex   7-nz  b is scnb     conu-013
c for common /ncomp/  see calx, lect and colf                           conu-014
c***********************************************************************conu-015
      implicit real*8 (a-h,o-z)                                         conu-016
      logical lo(250)                                                   conu-017
      dimension ipi(11,1),wv(18,1),ipim(11,1),wvm(18,1),nci(2,1),xd(3,1)conu-018
     1,scn(7,1)                                                         conu-019
      common /dcons/ cm,ck,chb,cmb,ccz                                  conu-020
      common /dcont/ xe,xm,xn,xz                                        conu-021
      common /ncomp/ nsp(5),ncont,ncoj,ncons,nie,ncolx,ndp,ndq,acn1,acn2conu-022
     1,az(18)                                                           conu-023
      common /inout/ mr,mw,ms                                           conu-024
c discretisation of continuum for compound nucleus                      conu-025
      nie=0                                                             conu-026
      if (ix.eq.0) go to 1                                              conu-027
      amrd=xm/cm                                                        conu-028
      amr=wv(3,1)/cm+wv(1,1)+wv(2,1)                                    conu-029
      kxt=ipi(8,ncolx+1-ncont)                                          conu-030
    1 do 14 i=1,ncont                                                   conu-031
      j=i+ncons-ncont                                                   conu-032
      scnb=dexp(2.d0*dsqrt(scn(1,j)*scn(2,j))-(scn(6,j)-scn(5,j))/scn(3,conu-033
     1j))*scn(3,j)/(scn(1,j)**.5d0*scn(2,j)**1.5d0)                     conu-034
      iv=i-ncont+ncolx                                                  conu-035
      nci(1,i)=nie+1                                                    conu-036
      if (wv(3,iv).le.0.d0) go to 13                                    conu-037
      ne=0                                                              conu-038
      e=wv(3,iv)                                                        conu-039
      acn3=1.d0/acn2                                                    conu-040
      if (e*acn2.lt.1.d0) acn3=e/1.9d0                                  conu-041
      if (ix.eq.0) go to 2                                              conu-042
      hrec=wv(11,iv)                                                    conu-043
      rec=1.d0                                                          conu-044
      if (lo(193).and.wv(1,1).ne.wv(1,iv)) rec=wv(2,1)/wv(2,iv)         conu-045
      if (lo(108)) go to 2                                              conu-046
      amt=wv(2,iv)                                                      conu-047
      if (lo(209)) go to 2                                              conu-048
      if (lo(44)) amt=wv(2,1)                                           conu-049
      amrd=(amr**4-(wv(1,iv)**2-amt**2)**2)/(4.d0*amr**3)               conu-050
    2 if (e.le.0.d0) go to 13                                           conu-051
      nie=nie+1                                                         conu-052
      if (ne.ne.0) go to 4                                              conu-053
      if (e.lt.acn1*acn3) go to 3                                       conu-054
      estp=e/acn1                                                       conu-055
      go to 5                                                           conu-056
    3 ne=idint(e/acn3+1.d0)                                             conu-057
      if (ne.eq.1) ne=2                                                 conu-058
      acn3=e/dfloat(ne)*1.000001d0                                      conu-059
    4 estp=acn3                                                         conu-060
    5 if (e.lt.estp) estp=e                                             conu-061
      ecn=e-.5d0*estp                                                   conu-062
      e=e-estp                                                          conu-063
      if (ix.eq.0) go to 2                                              conu-064
      do 6 k=1,16                                                       conu-065
    6 wvm(k,nie)=wv(k,iv)                                               conu-066
      do 7 k=1,11                                                       conu-067
    7 ipim(k,nie)=ipi(k,iv)                                             conu-068
      wvm(3,nie)=ecn                                                    conu-069
      xd(2,nie)=estp                                                    conu-070
      if (lo(8)) go to 8                                                conu-071
      wsk2=ck*wvm(3,nie)*amrd                                           conu-072
      wvm(12,nie)=wvm(3,nie)*(wvm(1,nie)+wvm(2,nie))/wvm(2,nie)         conu-073
      go to 9                                                           conu-074
    8 wvm(2,nie)=wv(1,1)+wv(2,1)-wvm(1,nie)+ecn/cm                      conu-075
      wsk2=0.125d0*ck*wvm(3,nie)*(wvm(3,nie)/cm+2.d0*wvm(1,nie)+2.d0*amtconu-076
     1)*(wvm(3,nie)/cm+2.d0*wvm(1,nie))*(wvm(3,nie)/cm+2.d0*amt)/amr**2 conu-077
      wvm(12,nie)=wvm(3,nie)*(wvm(3,nie)/(2.d0*cm)+wvm(1,nie)+wvm(2,nie)conu-078
     1)/wvm(2,nie)                                                      conu-079
    9 wvm(4,nie)=dsqrt(dabs(wsk2))                                      conu-080
      wvm(9,nie)=wvm(4,nie)*rec                                         conu-081
      wvm(8,nie)=hrec*dsqrt(ck*amrd)                                    conu-082
      wvm(10,nie)=hrec*hrec*wsk2                                        conu-083
      if (lo(209)) go to 10                                             conu-084
      wvm(5,nie)=0.5d0*ck*ccz*amrd*ipi(4,iv)/wvm(4,nie)                 conu-085
      go to 11                                                          conu-086
   10 hpc=chb*wvm(4,nie)                                                conu-087
      wvm(7,nie)=dsqrt(hpc**2+xm**2)                                    conu-088
      wvm(5,nie)=ccz*ipi(4,iv)/wvm(4,nie)*wvm(7,nie)/chb**2             conu-089
   11 ly=4+idint(3.3d0*dsqrt(wvm(3,nie)))                               conu-090
      if (dabs(wvm(5,nie)).gt.400.d0) go to 13                          conu-091
      ipim(10,nie)=ly-1                                                 conu-092
      ipim(8,nie)=kxt                                                   conu-093
      kxt=kxt+ly*ipim(2,nie)                                            conu-094
      if (wv(3,1)-wvm(3,nie).gt.scn(6,j)) go to 12                      conu-095
      xd(1,nie)=xd(2,nie)*dexp((wv(3,1)-wvm(3,nie)-scn(5,j))/scn(3,j))/sconu-096
     1cn(3,j)                                                           conu-097
      xd(3,nie)=2.d0*scn(4,j)**2                                        conu-098
      go to 2                                                           conu-099
   12 exd=wv(3,1)-wvm(3,nie)+scn(2,j)-scn(6,j)                          conu-100
      ebyt=dsqrt(scn(1,j)*exd)                                          conu-101
      xd(1,nie)=xd(2,nie)*dexp(2.d0*ebyt)/(ebyt*exd*scnb)               conu-102
      xd(3,nie)=2.d0*scn(4,j)**2*dsqrt(exd/scn(2,j))                    conu-103
      go to 2                                                           conu-104
   13 if (ix.eq.0) go to 14                                             conu-105
      jy=nie-nci(1,i)+1                                                 conu-106
      write (mw,1000) i,jy                                              conu-107
      nci(2,i)=nie                                                      conu-108
   14 continue                                                          conu-109
      return                                                            conu-110
 1000 format (' ***** start of',i4,'th continuum *****',5x,i5,' discreticonu-111
     1sation points')                                                   conu-112
      end                                                               conu-113
c 29/02/04                                                      ecis03  disp-000
      subroutine disp(ipi,wv,ipp,pip,nval,val,ncolt,lo)                 disp-001
c computation of the depths of real surface and volume contributions    disp-002
c obtained by dispersion relations from the imaginary volume and        disp-003
c surface potentials. computation of the corrections to the imaginary   disp-004
c potentials due to differences of energy. variation of hartree-fock anddisp-005
c spin-orbit potentials.                                                disp-006
c input variables: ipi(5,iv): potential for the level iv                disp-007
c                  wv(3,iv):  center of mass energy of the level iv     disp-008
c                  ipp,pip:   equivalent by call  (see calx)            disp-009
c                  nval,val:  optical potentials                        disp-010
c                  ncolt:     total number of levels                    disp-011
c                  lo:        logical controls                          disp-012
c                             lo(10) =.true. use of dispersion relationsdisp-013
c                             lo(209)=.true. use of dirac potentials    disp-014
c output variables:wv(13,iv): corr. to volume/scalar imaginary potentialdisp-015
c                  wv(14,iv): corr. to volume/scalar real potential     disp-016
c                  wv(15,iv): corr. to surface/vector imaginary pot.    disp-017
c                  wv(16,iv): corr. to surface/vector real potential    disp-018
c                  wv(17,iv): corr. to sp-o/tensor imaginary potential  disp-019
c                  wv(18,iv): corr. to sp-o/tensor real potential       disp-020
c surface, j=1 for first and 2 for second term, k=1 imaginary value for disp-021
c reference energy, 2 imaginary and 3 real values for actual energy     disp-022
c***********************************************************************disp-023
      implicit real*8 (a-h,o-z)                                         disp-024
      logical lo(250)                                                   disp-025
      dimension ipi(11,ncolt),ipp(2,15,1),wv(18,1),ww(6),pip(15,1),av(2,disp-026
     12,3),nval(2,34),val(34,1),h(2),nn(2),mm(2),bb(2),vv(3)            disp-027
      common /inout/ mr,mw,ms                                           disp-028
      data pi /3.141592653589793d0/                                     disp-029
      if (.not.lo(216).and.lo(10)) write (mw,1000)                      disp-030
c loop on levels                                                        disp-031
      do 34 iv=1,ncolt                                                  disp-032
      do 1 i=1,6                                                        disp-033
    1 ww(i)=0.d0                                                        disp-034
      ipi(11,iv)=max0(1,ipi(11,iv))                                     disp-035
      if (lo(110)) go to 32                                             disp-036
      ip=ipi(5,iv)                                                      disp-037
      if (lo(7)) go to 2                                                disp-038
      vv(1)=val(1,ip)                                                   disp-039
      vv(2)=val(4,ip)                                                   disp-040
      vv(3)=val(16,ip)                                                  disp-041
      go to 3                                                           disp-042
    2 vv(1)=val(nval(1,8*ip-5),1)                                       disp-043
      vv(2)=val(nval(1,8*ip-4),1)                                       disp-044
      vv(3)=val(nval(1,8*ip),1)                                         disp-045
    3 iz=3                                                              disp-046
      if (ipp(1,1,ip).lt.0) iz=12                                       disp-047
      ef=pip(4,ip)                                                      disp-048
      ep=pip(5,ip)                                                      disp-049
      eo=ep-ef                                                          disp-050
      yy=pip(3,ip)-ef                                                   disp-051
      y=wv(iz,iv)-ef                                                    disp-052
c spin-orbit or tensor potential                                        disp-053
      if (pip(8,ip).ne.0.d0) ww(5)=-pip(8,ip)*(y-yy)/vv(3)              disp-054
      if (pip(7,ip).ne.0.d0) ww(6)=dexp(-pip(7,ip)*(y-yy))-1.d0         disp-055
c volume/scalar/vector form-factor                                      disp-056
      do 29 i=1,2                                                       disp-057
      n=iabs(ipp(i,2,ip))                                               disp-058
      if (n.eq.0) go to 28                                              disp-059
      m=n/2                                                             disp-060
      do 7 k=1,2                                                        disp-061
      b=pip(3*i+k+5,ip)                                                 disp-062
      do 4 l=1,3                                                        disp-063
    4 av(i,k,l)=0.d0                                                    disp-064
      if (dabs(yy).gt.eo) av(i,k,1)=(dabs(yy)-eo)**n/((dabs(yy)-eo)**n+bdisp-065
     1**n)                                                              disp-066
      if (dabs(y).gt.eo) av(i,k,2)=(dabs(y)-eo)**n/((dabs(y)-eo)**n+b**ndisp-067
     1)                                                                 disp-068
      if (.not.lo(209).and.((i.eq.2).and.(n.gt.0))) go to 30            disp-069
      av(i,k,3)=dlog(dabs((y+eo)/(y-eo)))/pi                            disp-070
c loop on poles in the upper plane                                      disp-071
      do 5 j=1,m                                                        disp-072
      bt=pi*dfloat(2*j-1)/dfloat(n)                                     disp-073
      h(1)=((y-eo)**2+2.d0*b*(y-eo)*dcos(bt)+b**2)*m/b                  disp-074
      h(2)=((y+eo)**2-2.d0*b*(y+eo)*dcos(bt)+b**2)*m/b                  disp-075
    5 av(i,k,3)=av(i,k,3)+dsin(bt)*((y+eo)/h(2)+(y-eo)/h(1))*dfloat(2*j-disp-076
     11)/dfloat(n)+((dcos(bt)*(y-eo)+b)*dlog(dabs(y-eo)/b)/h(1)+(dcos(btdisp-077
     2)*(y+eo)-b)*dlog(dabs(y+eo)/b)/h(2))/pi                           disp-078
      if (n.eq.ipp(i,2,ip)) go to 8                                     disp-079
      if (k.eq.1) go to 7                                               disp-080
c sum or difference of two volume terms                                 disp-081
      do 6 j=1,3                                                        disp-082
    6 av(i,1,j)=pip(3*i+8,ip)*av(i,1,j)+(1.d0-pip(3*i+8,ip))*av(i,2,j)  disp-083
    7 continue                                                          disp-084
    8 if ((n.lt.0).or.(i.eq.2)) go to 27                                disp-085
c volume correction for large energy contributions                      disp-086
      ea=pip(6,ip)                                                      disp-087
      if (ea.eq.0.d0) go to 27                                          disp-088
      cn=pip(11,ip)                                                     disp-089
      n2=ipp(2,1,ip)                                                    disp-090
      if (n2.eq.0) go to 17                                             disp-091
c large negative energies                                               disp-092
      av(1,2,1)=0.d0                                                    disp-093
      av(1,2,2)=0.d0                                                    disp-094
      if (yy.lt.-ea) av(1,2,1)=-av(1,1,1)*(yy+ea)**n2/((yy+ea)**n2+ea**ndisp-095
     12)*dexp(cn*(dsqrt(ea+ef)-dsqrt(-yy+ef)))                          disp-096
      if (y.lt.-ea) av(1,2,2)=-av(1,1,2)*(y+ea)**n2/((y+ea)**n2+ea**n2)*disp-097
     1dexp(cn*(dsqrt(ea+ef)-dsqrt(-y+ef)))                              disp-098
      m2=n2/2                                                           disp-099
      nn(1)=n                                                           disp-100
      mm(1)=m                                                           disp-101
      bb(1)=b                                                           disp-102
      nn(2)=n2                                                          disp-103
      mm(2)=m2                                                          disp-104
      bb(2)=ea                                                          disp-105
      if (cn.ne.0.d0) go to 9                                           disp-106
c no damping factor                                                     disp-107
      h(1)=dlog(dmax1(dabs(y+ea),1.d-4))                                disp-108
      h(2)=dlog(ea)                                                     disp-109
      go to 11                                                          disp-110
    9 ye=cn*dsqrt(ea+ef)                                                disp-111
c damping factor                                                        disp-112
      yd=ef-y                                                           disp-113
      do 10 l=1,2                                                       disp-114
      yc=cn*dsqrt(dabs(yd))                                             disp-115
      yr=0.d0                                                           disp-116
      yi=0.d0                                                           disp-117
      if (yd.ge.0.d0) yr=yc                                             disp-118
      if (yd.lt.0.d0) yi=yc                                             disp-119
      call dcei(ye+yr,yi,cr,ci)                                         disp-120
      call dcei(ye-yr,-yi,br,bi)                                        disp-121
      h(l)=-cr-br                                                       disp-122
   10 yd=yd+y                                                           disp-123
   11 av(1,2,3)=h(2)-h(1)                                               disp-124
      do 16 l=1,2                                                       disp-125
      do 15 j=1,mm(l)                                                   disp-126
      bt=pi*dfloat(2*j-1)/dfloat(nn(l))                                 disp-127
      zz=datan2(-bb(l)*dsin(bt),ea-eo-bb(l)*dcos(bt))                   disp-128
      zr=(ea-eo)**2-2.d0*(ea-eo)*dcos(bt)*bb(l)+bb(l)**2                disp-129
      dr=zr**mm(3-l)*dcos(nn(3-l)*zz)+bb(3-l)**nn(3-l)                  disp-130
      di=zr**mm(3-l)*dsin(nn(3-l)*zz)                                   disp-131
      dd=dr**2+di**2                                                    disp-132
      cr=1.d0-bb(3-l)**nn(3-l)*dr/dd                                    disp-133
      ci=bb(3-l)**nn(3-l)*di/dd                                         disp-134
      br=bb(l)*(cr*dcos(bt)-ci*dsin(bt))                                disp-135
      bi=bb(l)*(cr*dsin(bt)+ci*dcos(bt))                                disp-136
      de=-bb(l)*dsin(bt)                                                disp-137
      if (cn.ne.0.d0) go to 12                                          disp-138
c no damping factor                                                     disp-139
      if (l.eq.1) zt=zz                                                 disp-140
      if (l.eq.2) zt=bt                                                 disp-141
      if (l.eq.1) df=dlog(zr)/2.d0                                      disp-142
      if (l.eq.2) df=dlog(ea)                                           disp-143
      go to 13                                                          disp-144
   12 if (l.eq.1) xr=ep+bb(1)*dcos(bt)                                  disp-145
c damping factor                                                        disp-146
      if (l.eq.2) xr=ea+ef-bb(2)*dcos(bt)                               disp-147
      xi=bb(l)*dsin(bt)                                                 disp-148
      if (l.eq.2) xi=-xi                                                disp-149
      yc=cn*(xr**2+xi**2)**.25d0                                        disp-150
      yd=datan2(xi,xr)/2.d0                                             disp-151
      yr=yc*dcos(yd)                                                    disp-152
      yi=yc*dsin(yd)                                                    disp-153
      call dcei(ye+yr,yi,cr,ci)                                         disp-154
      call dcei(ye-yr,-yi,dr,di)                                        disp-155
      df=-cr-dr                                                         disp-156
      zt=-ci-di                                                         disp-157
   13 if (l.eq.1) dc=-y-eo-bb(l)*dcos(bt)                               disp-158
      if (l.eq.2) dc=y+ea-bb(l)*dcos(bt)                                disp-159
      do 14 k=1,2                                                       disp-160
      dd=-(dc**2+de**2)*dfloat(mm(l))                                   disp-161
      av(1,2,3)=-av(1,2,3)+(br*((df-h(k))*dc+zt*de)-bi*(zt*dc-(df-h(k))*disp-162
     1de))/dd                                                           disp-163
   14 dc=dc-y*dfloat(2*l-3)                                             disp-164
   15 continue                                                          disp-165
   16 continue                                                          disp-166
      av(1,2,3)=av(1,2,3)/pi                                            disp-167
      av(1,1,1)=av(1,1,1)+av(1,2,1)                                     disp-168
      av(1,1,2)=av(1,1,2)+av(1,2,2)                                     disp-169
      av(1,1,3)=av(1,1,3)+av(1,2,3)                                     disp-170
   17 if (pip(10,ip).eq.0.d0) go to 27                                  disp-171
c large positive energy term                                            disp-172
      el=ef+ea                                                          disp-173
      ell=dsqrt(el)                                                     disp-174
      av(1,2,1)=0.d0                                                    disp-175
      av(1,2,2)=0.d0                                                    disp-176
      if (yy.gt.ea) av(1,2,1)=(dsqrt(yy+ef)+ell*(el/(yy+ef)-3.d0)/2.d0)*disp-177
     1dexp(-cn*(dsqrt(yy+ef)-ell))                                      disp-178
      if (y.gt.ea) av(1,2,2)=(dsqrt(y+ef)+ell*(el/(y+ef)-3.d0)/2.d0)*dexdisp-179
     1p(-cn*(dsqrt(y+ef)-ell))                                          disp-180
      if (cn.ne.0.d0) go to 21                                          disp-181
c no damping factor                                                     disp-182
      f=y+ef                                                            disp-183
      if (f.eq.el) f=el+.000001d0                                       disp-184
      fe=dsqrt(-ef)                                                     disp-185
      ax=f/el                                                           disp-186
      if (dabs(ax).gt.1.d-4) go to 18                                   disp-187
      g2=.5d0*(1.d0+1.5d0*ax*(1.d0+ax/9.d0*(1.d0+.3d0*ax)))             disp-188
      go to 20                                                          disp-189
   18 g2=-(1.d0/ax-3.d0)*dlog(dabs(1.d0-ax))/2.d0                       disp-190
      bx=dsqrt(dabs(ax))                                                disp-191
      if (f.lt.0.d0) go to 19                                           disp-192
      g2=g2-dlog(dabs(1.d0-bx)/(1.d0+bx))*bx                            disp-193
      go to 20                                                          disp-194
   19 g2=g2-2.d0*bx*datan2(bx,1.d0)                                     disp-195
   20 g2=g2+1.5d0*dlog(el)                                              disp-196
      g1=datan2(fe,ell)*fe/ell*2.d0+(el/ef*dlog(ea/el)-3.d0*dlog(ea))/2.disp-197
     1d0                                                                disp-198
      av(1,2,3)=(g1+g2)*ell/pi                                          disp-199
      go to 25                                                          disp-200
c damping factor                                                        disp-201
   21 ax=cn*ell                                                         disp-202
      f=y+ef                                                            disp-203
      av(1,2,3)=0.d0                                                    disp-204
      call dcei(ax,0.d0,b0,b1)                                          disp-205
      do 24 k=1,2                                                       disp-206
      ff=cn**2*f                                                        disp-207
      zf=dsqrt(dabs(ff))                                                disp-208
      zr=0.d0                                                           disp-209
      zi=0.d0                                                           disp-210
      if (ff.ge.0.d0) zr=zf                                             disp-211
      if (ff.lt.0.d0) zi=zf                                             disp-212
      call dcei(ax-zr,-zi,e1,b1)                                        disp-213
      call dcei(ax+zr,zi,e2,b2)                                         disp-214
      if (dabs(zf).gt.dmin1(ax,512.d0)/4096.d0) go to 22                disp-215
      e0=(b0-1.d0/ax+1.d0/ax**2)*(1.d0+ff/6.d0*(1.d0+ff/60.d0))-ff/(3.d0disp-216
     1*ax**3)*((1.d0-3.d0/ax)*(1.d0+ff/30.d0)+ff*(1.d0-10.d0/ax)/(10.d0*disp-217
     2ax**2))                                                           disp-218
      go to 23                                                          disp-219
   22 e0=(e1+e2-2*b0)/ff                                                disp-220
   23 av(1,2,3)=-av(1,2,3)-(ax*(ax**2*e0-3.d0*(e1+e2))/2.d0+2.d0+zr*(e1-disp-221
     1e2)-zi*(b1-b2))/cn/pi                                             disp-222
      h(k)=(ax*(ax**2*e0-3.d0*(e1+e2))/2.d0+2.d0+zr*(e1-e2)-zi*(b1-b2))/disp-223
     1cn/pi                                                             disp-224
   24 f=ef                                                              disp-225
c the last computed term being fixed, it must be subtracted to the      disp-226
c strength of volume imaginary potential to obtain the coefficient x    disp-227
c of the other term:  x * av(1,1,k) + av(1,2,k) = y where y is the givendisp-228
c strength of imaginary volume potential for k=1, the computed strengthsdisp-229
c of the imaginary and real volume potential for k=2 and 3 respectively disp-230
   25 xx=(vv(2)-av(1,2,1)*pip(10,ip))/av(1,1,1)                         disp-231
      do 26 k=1,3                                                       disp-232
   26 av(1,1,k)=xx*av(1,1,k)+pip(10,ip)*av(1,2,k)                       disp-233
   27 ww(2*i-1)=av(i,1,2)/av(i,1,1)-1.d0                                disp-234
      ww(2*i)=av(i,1,3)/av(i,1,1)                                       disp-235
   28 if ((i.eq.1).and.(pip(15,ip).ne.0.d0)) ww(2)=ww(2)+vv(1)*(dexp(-pidisp-236
     1p(15,ip)*(y-yy))-1.d0)/vv(2)                                      disp-237
   29 continue                                                          disp-238
      go to 32                                                          disp-239
c surface form-factor                                                   disp-240
   30 cs=pip(13,ip)                                                     disp-241
      cn=pip(14,ip)                                                     disp-242
      av(2,1,1)=av(2,1,1)*dexp(-cn*yy-cs*dabs(yy))                      disp-243
      av(2,1,2)=av(2,1,2)*dexp(-cn*y-cs*dabs(y))                        disp-244
      ww(3)=av(2,1,2)/av(2,1,1)-1.d0                                    disp-245
      h(1)=0.d0                                                         disp-246
      h(2)=0.d0                                                         disp-247
      call dcei((cs+cn)*(eo-y),0.d0,p2,p)                               disp-248
      call dcei((cs-cn)*(eo+y),0.d0,p4,p)                               disp-249
      m=n/2                                                             disp-250
c loop on poles in the complex upper plane                              disp-251
      do 31 i=1,m                                                       disp-252
      a3=pi*dfloat(2*i-1)/dfloat(n)                                     disp-253
      ay=b*dcos(a3)                                                     disp-254
      az=b*dsin(a3)                                                     disp-255
      call dcei((cs+cn)*ay,(cs+cn)*az,br,bi)                            disp-256
      cr=p2*(y-eo)+br*ay-bi*az                                          disp-257
      ci=br*az+bi*ay                                                    disp-258
      h(1)=h(1)+(cr*(y-eo+ay)+ci*az)/((y-eo+ay)**2+az**2)               disp-259
      call dcei((cs-cn)*ay,(cs-cn)*az,br,bi)                            disp-260
      cr=-p4*(y+eo)+br*ay-bi*az                                         disp-261
      ci=br*az+bi*ay                                                    disp-262
   31 h(2)=h(2)+(cr*(y+eo-ay)-ci*az)/((y+eo-ay)**2+az**2)               disp-263
      av(2,1,3)=(dexp(-(cs+cn)*eo)*h(1)+dexp(-(cs-cn)*eo)*h(2))/(pi*dflodisp-264
     1at(m))                                                            disp-265
      ww(4)=av(2,1,3)/av(2,1,1)                                         disp-266
   32 do 33 i=1,6                                                       disp-267
   33 wv(i+12,iv)=ww(i)                                                 disp-268
      if (.not.lo(216).and.lo(10)) write (mw,1001) iv,ip,pip(3,ip),wv(izdisp-269
     1,iv),ww                                                           disp-270
   34 continue                                                          disp-271
      return                                                            disp-272
 1000 format (' level  pot. ref. ener.     energy  volume/scalar correctdisp-273
     1ion surface/vector correction   sp.-o/tensor correction'/34x,3(4x,disp-274
     2'imaginary',9x,'real'))                                           disp-275
 1001 format (2i6,2f11.4,6f13.6)                                        disp-276
      end                                                               disp-277
c 29/02/04                                                      ecis03  dcei-000
      subroutine dcei(ar,ai,zr,zi)                                      dcei-001
c complex exponential integral function multiplied by exponential for   dcei-002
c complex argument: exp(z)*ei(z)                                        dcei-003
c***********************************************************************dcei-004
      implicit real*8 (a-h,o-z)                                         dcei-005
      zr=0.d0                                                           dcei-006
      zi=0.d0                                                           dcei-007
      if ((ar.eq.0.d0).and.(ai.eq.0.d0)) return                         dcei-008
      if (dabs(ar)+18.5d0.ge.32.d0) go to 3                             dcei-009
      if (dsqrt(1024.d0-(ar+18.5d0)**2)/1.665d0.lt.dabs(ai)) go to 3    dcei-010
c series expansion                                                      dcei-011
      zr=-.57721566490153d0-dlog(ar**2+ai**2)*0.5d0                     dcei-012
      zi=-datan2(ai,ar)                                                 dcei-013
      yr=1.d0                                                           dcei-014
      yi=0.d0                                                           dcei-015
      do 1 m=1,2000                                                     dcei-016
      aj=dfloat(m)                                                      dcei-017
      yz=yr                                                             dcei-018
      yr=-(yz*ar-yi*ai)/aj                                              dcei-019
      yi=-(yz*ai+yi*ar)/aj                                              dcei-020
      if (yr**2+yi**2.lt.1.d-30*(ar**2+ai**2)) go to 2                  dcei-021
      zr=zr-yr/aj                                                       dcei-022
    1 zi=zi-yi/aj                                                       dcei-023
    2 yr=dexp(ar)                                                       dcei-024
      yi=yr*zi                                                          dcei-025
      yr=yr*zr                                                          dcei-026
      zr=yr*dcos(ai)-yi*dsin(ai)                                        dcei-027
      zi=yi*dcos(ai)+yr*dsin(ai)                                        dcei-028
      return                                                            dcei-029
c continued fraction                                                    dcei-030
    3 do 4 i=1,20                                                       dcei-031
      aj=dfloat(21-i)                                                   dcei-032
      zr=zr+ar                                                          dcei-033
      zi=zi+ai                                                          dcei-034
      z=zr**2+zi**2                                                     dcei-035
      zr=aj*zr/z                                                        dcei-036
      zi=-aj*zi/z                                                       dcei-037
      zr=zr+1.d0                                                        dcei-038
      z=zr**2+zi**2                                                     dcei-039
      zr=aj*zr/z                                                        dcei-040
    4 zi=-aj*zi/z                                                       dcei-041
      zr=zr+ar                                                          dcei-042
      zi=zi+ai                                                          dcei-043
      z=zr**2+zi**2                                                     dcei-044
      zr=zr/z                                                           dcei-045
      zi=-zi/z                                                          dcei-046
      return                                                            dcei-047
      end                                                               dcei-048
c 29/02/04                                                      ecis03  ggdr-000
      subroutine ggdr(ipi,wv,scn,lo)                                    ggdr-001
c giant dipole resonance related calculations                           ggdr-002
c input variables: ipi(j,*):product of charges for j=4                  ggdr-003
c                  wv(j,*): mass of particle and target for j=1,2       ggdr-004
c                           center of mass energy in mev for j=3        ggdr-005
c                  scn:     descriptions of level densities             ggdr-006
c                  lo:      logical controls                            ggdr-007
c for common /ncomp/ see calx, lect and colf                            ggdr-008
c in common /ncomp/nrd,nfiss: number of gamma and fission transmission  ggdr-009
c                             coefficients read in lect                 ggdr-010
c                  tg0,bn,fnug,egd,ggd:  neutron binding energy         ggdr-011
c                           giant dipole resonance energy and width ....ggdr-012
c                  ipi(j,i): for i=ncoll+1 to ncolt, maximum l+1 and    ggdr-013
c in common /ncomp/egd,ggd: energy and width of giant dipole resonance  ggdr-014
c                  tg1,sgsq  .........                                  ggdr-015
c in scn:  1-sa  2-ux   3-tau  4-sg   5-e0   6-ex   7-nz  8-b           ggdr-016
c***********************************************************************ggdr-017
      implicit real*8 (a-h,o-z)                                         ggdr-018
      logical lo(250)                                                   ggdr-019
      dimension wv(18,1),ipi(11,3),scn(7)                               ggdr-020
      common /ncomp/ nsp(4),nrd,ncoj(7),acn(8),bz(5),tg0,bn,fnug,egd,ggdggdr-021
     1,tg1,sgsq                                                         ggdr-022
      common /inout/ mr,mw,ms                                           ggdr-023
      if (lo(181)) return                                               ggdr-024
      bz(2)=dabs(bz(2))                                                 ggdr-025
      if (lo(82)) bz(3)=bz(1)*bz(1)-1.d0                                ggdr-026
      if (.not.(lo(212).or.lo(215))) return                             ggdr-027
c  gamma ray input                                                      ggdr-028
      if (lo(186).or.(nrd.ne.0)) return                                 ggdr-029
      xfr=0.5d0                                                         ggdr-030
      na=idint(wv(2,1)+wv(1,1)+.5d0)                                    ggdr-031
      aa=dfloat(na)                                                     ggdr-032
      nz=idint(scn(7)+.1d0)                                             ggdr-033
      nn=na-nz                                                          ggdr-034
      zz=dfloat(nz*nn)                                                  ggdr-035
      kgd=0                                                             ggdr-036
      if (egd.eq.0.d0) egd=163.d0*dsqrt(zz)/(aa**1.3333333d0)           ggdr-037
      if (egd.lt.0.d0) go to 1                                          ggdr-038
      kgd=1                                                             ggdr-039
      if (ggd.le.0.d0) ggd=5.d0                                         ggdr-040
    1 if (.not.lo(216)) write (mw,1000) na,nz,nn,bn,fnug,scn(4)         ggdr-041
      atg0=dabs(tg0)                                                    ggdr-042
      if (.not.lo(216)) write (mw,1001) atg0                            ggdr-043
      if (kgd.eq.0.and..not.lo(216)) write (mw,1002)                    ggdr-044
      if (kgd.eq.1.and..not.lo(216)) write (mw,1003) egd,ggd,xfr        ggdr-045
      sgsq=2.d0*scn(4)**2                                               ggdr-046
      roj=0.d0                                                          ggdr-047
      ecm=0.d0                                                          ggdr-048
    2 tg=0.d0                                                           ggdr-049
      elim=bn+ecm                                                       ggdr-050
      elo=0.d0                                                          ggdr-051
    3 ehi=elo+0.05d0                                                    ggdr-052
      if (ehi.ge.elim) ehi=elim                                         ggdr-053
      eps=(ehi+elo)/2.d0                                                ggdr-054
      esq=eps*eps                                                       ggdr-055
      tint=(ehi-elo)*eps*esq                                            ggdr-056
      eee=-egd*egd+esq                                                  ggdr-057
      if (kgd.eq.1) tint=tint*eps/(esq*ggd*ggd+eee*eee)                 ggdr-058
      exc=bn+ecm-eps                                                    ggdr-059
      if (exc.gt.scn(6)) go to 4                                        ggdr-060
      ebyt=(exc-scn(5))/scn(3)                                          ggdr-061
      tint=tint*dexp(ebyt)/scn(3)                                       ggdr-062
      go to 5                                                           ggdr-063
    4 exd=exc+scn(2)-scn(6)                                             ggdr-064
      ebyt=dsqrt(scn(1)*exd)                                            ggdr-065
      scnb=dexp(2.d0*dsqrt(scn(1)*scn(2))-(scn(6)-scn(5))/scn(3))*scn(3)ggdr-066
     1/(scn(1)**.5d0*scn(2)**1.5d0)                                     ggdr-067
      tint=tint*dexp(2.d0*ebyt)/(ebyt*exd*scnb)                         ggdr-068
    5 tg=tg+tint                                                        ggdr-069
      if (ehi.eq.elim) go to 6                                          ggdr-070
      elo=ehi                                                           ggdr-071
      go to 3                                                           ggdr-072
    6 if (ecm.ne.0.d0) go to 9                                          ggdr-073
      temp=tg                                                           ggdr-074
      id=ipi(3,1)-1                                                     ggdr-075
      n1=iabs(id-1)                                                     ggdr-076
      n2=id+1                                                           ggdr-077
      do 8 i=n1,n2,2                                                    ggdr-078
      n3=iabs(i-2)                                                      ggdr-079
      n4=i+2                                                            ggdr-080
      do 7 j=n3,n4,2                                                    ggdr-081
      dex=-dfloat(j+1)**2/(sgsq*4.d0)                                   ggdr-082
    7 roj=roj+dexp(dex)*dfloat(j+1)/sgsq                                ggdr-083
    8 continue                                                          ggdr-084
      ctg=atg0/(temp*roj)                                               ggdr-085
      ecm=wv(3,1)                                                       ggdr-086
      go to 2                                                           ggdr-087
    9 tg1=tg*ctg                                                        ggdr-088
      return                                                            ggdr-089
 1000 format (/'    gamma ray channel parameters :'//'   a=',i3,'  z=',iggdr-090
     13,'  n=',i3,5x,f9.3,' mev  neutron binding',5x,f6.2,' radiative d.ggdr-091
     2 of f.',5x,'sigma=',f6.3)                                         ggdr-092
 1001 format ('   normalised to slow s-wave neutron gamma widths/spacingggdr-093
     1s =',d12.4)                                                       ggdr-094
 1002 format ('   e1 strong coupling model')                            ggdr-095
 1003 format ('   e1 giant resonance at ',f7.2,' mev   width=',f7.2,' meggdr-096
     1v',5x,'exchange fraction=',f5.2)                                  ggdr-097
      end                                                               ggdr-098
c 29/02/04                                                      ecis03  cal1-000
      subroutine cal1(nw,cw,dw,lo)                                      cal1-001
c this subroutine computes form factors (pote), looks for quantum       cal1-002
c numbers (quan), checks for convergence with respect to total spin,    cal1-003
c computes helicity amplitudes (sche) and computes chi2 (resu)          cal1-004
c the arguments are the working space w, in equivalence by call with nw cal1-005
c and dw and the array of logical controls lo. the common /noeq/ is not cal1-006
c used outside this subroutine and the subroutines called by it.        cal1-007
c nplace is the maximum working space used                              cal1-008
c***********************************************************************cal1-009
      implicit real*8 (a-h,o-z)                                         cal1-010
      logical lo(250)                                                   cal1-011
      character*4 cw(2,1)                                               cal1-012
      character*1 jp                                                    cal1-013
      dimension nw(2,2),dw(1)                                           cal1-014
      common /decou/ njit,nipp,npaa,nwv,niph,nscn,npar,nniv,nfis,ngam,npcal1-015
     1ot,nbeta,nfm,ntgx,ndonn,nrc,niw,nde,nise,nnvi,nnwi,ncc,mcc,nxa,namcal1-016
     21,nfac,nfam,npad,nfg,nxg,nsm,nres,nxx,nt,nivq,nivy,nivz,ncoi,mipi,cal1-017
     3nxd,mwv,nixt,nty,ntx,nry,nrco,nrdo,nvc1,nvc2,nnc,ncx,idmt,ncoll,njcal1-018
     4max,iterm,npp,jdm,jit,nsec,lmd,mcm(2),ncols,ncolt,kmax,kmin,nva,nbcal1-019
     5et,nbt1,lmx,lmax1,nlt,ism,iqm,iqmax,ms1,ms2,nct(6),kba,kab,kbc,kcccal1-020
     6,njc,jtx,jth,ncolr,nrec,ntot,nfa,lmax2,ke,itemm,nplace,kxt,nrz,ntzcal1-021
     7,lmax3,ipm,ipk,bjm,eiter,aconv,conj,h,nspin                       cal1-022
      common /pote2/ ity(8),invt,intv,insl,npx                          cal1-023
      common /ncomp/ nsp(5),ncont,ncoj(3),ncolx,ndp,ndq,acn(20)         cal1-024
      common /noequ/ ncxn,nic,nci,nc,ncin,nin,jpi,ipj,r1(2),naj         cal1-025
      common /dcons/ cm,ck,chb,cmb,ccz                                  cal1-026
      common /dcont/ xe,xm,xn,xz                                        cal1-027
      common /inout/ mr,mw,ms                                           cal1-028
      jmin=mod(nw(2,1)+nw(1,2),2)                                       cal1-029
      nr5=nnc                                                           cal1-030
      nww=nr5+2*kab                                                     cal1-031
      nxc=nww+4*ism*kab                                                 cal1-032
      if (lo(220).and.lo(151)) go to 2                                  cal1-033
      if (lo(219)) go to 22                                             cal1-034
      if (lo(100)) nxc=nxc+4*ism*kab                                    cal1-035
      if (lo(21)) nxc=nnc                                               cal1-036
      id1=idmt-ncx                                                      cal1-037
c computation of potentials and form factors                            cal1-038
      n=ncx-1                                                           cal1-039
      do 1 i=nrco,n                                                     cal1-040
    1 dw(i)=0.d0                                                        cal1-041
      call pote(dw(nbeta),nw(1,nbeta),dw(nvc1),nw(1,nivq),nw(1,nivy),nw(cal1-042
     11,nivz),dw(ncx),nw(1,ncx),dw(npot),nw(1,npot),dw(nrco),dw(nrdo),dwcal1-043
     2(nwv),dw(mwv),aconv,ism,ncoll,ncolx-ncont,ncolt,id1,nw,nw(1,mipi),cal1-044
     3nw(1,nipp),dw(nixt),iqm,npp,nbt1,mcm,chb,ccz,lo)                  cal1-045
    2 if (lo(220)) go to 22                                             cal1-046
      nplace=max0(nplace,nxc+id1)                                       cal1-047
      jpi=0                                                             cal1-048
      ip1=1                                                             cal1-049
      if (lo(223)) ip1=2                                                cal1-050
      npt=0                                                             cal1-051
      n=nty+ntz-1                                                       cal1-052
      do 3 i=nty,n                                                      cal1-053
    3 dw(i)=0.d0                                                        cal1-054
      if (lo(181).or.lo(82)) go to 4                                    cal1-055
      nx=nnc+2*ism                                                      cal1-056
      n=nx+2*(ism+2)                                                    cal1-057
      if (n.gt.idmt) call memo('cal1',idmt,n,1)                         cal1-058
      nplace=max0(nplace,n)                                             cal1-059
c loop on the parities  jpi is the parity (0 or 1)                      cal1-060
    4 ipj=1                                                             cal1-061
      lo(227)=.false.                                                   cal1-062
      lo(232)=lo(181)                                                   cal1-063
      iterm=itemm                                                       cal1-064
      do 5 k=1,kab                                                      cal1-065
    5 nw(k,ncc)=0                                                       cal1-066
c loop on the values of j                                               cal1-067
c search for quantum numbers and coupling coefficients                  cal1-068
    6 lo(225)=lo(21)                                                    cal1-069
      naj=jmin+2*ipj-2                                                  cal1-070
      aj=0.5d0*dfloat(naj)                                              cal1-071
      iterr=0                                                           cal1-072
    7 call quan(ncoll,dw(nwv),nw,nw(1,nniv),nw(1,nt),dw(nt),nw(1,nivq),ncal1-073
     1w(1,nivz),nw(1,ncc),nw(1,nxc),dw(nxc),iu,nw(1,nnvi),kab,kbc,dw(nxacal1-074
     2),dw(nfac),nfa,idmt-nxc-200,lmd,lo)                               cal1-075
      if (ncin.eq.0) go to 15                                           cal1-076
      nx=nxc+iu*lmd                                                     cal1-077
      ipx=ipj                                                           cal1-078
      lo(232)=lo(232).or.ipj.gt.kmax                                    cal1-079
      nx1=nx                                                            cal1-080
      ncxn=ncin                                                         cal1-081
      if (lo(224)) ncxn=nc                                              cal1-082
      nwr=2*nx1+20*kab*kab-1                                            cal1-083
      if (nwr+10*kab**2.gt.idmt) call memo('cal1',idmt,nwr+10*kab**2,1) cal1-084
      call mtch(nw(1,nnwi),ncoll,kab,dw(nwv),nw(1,mcc),dw(nxg),nw(1,nxc)cal1-085
     1,dw(nxc),dw(nx1),ism,lmax2,nw(1,nniv),nw(1,nivz),dw(nfg),lmax1,lmacal1-086
     2x3,nw(1,nwr),dw(nrco),dw(nrdo),dw(nfam),lmd,bjm,chb,xm,lo)        cal1-087
      if (lo(227)) go to 12                                             cal1-088
      if (lo(44)) nx=nx+4*kab*kab                                       cal1-089
      if (lo(74)) call hora                                             cal1-090
c  nx  first address which can be used                                  cal1-091
      if (lo(225)) go to 12                                             cal1-092
c iterations                                                            cal1-093
      nfar=nfam+8*kab                                                   cal1-094
      nfai=nfar+ncxn*kab                                                cal1-095
      if (lo(100)) go to 8                                              cal1-096
      nwr=2*nx+4*(ism+2)-1                                              cal1-097
      nr4=nwr+2*nc*ism                                                  cal1-098
      if (lo(210)) nr4=nwr+4*nc*ism                                     cal1-099
      n=nr4+2*ism                                                       cal1-100
      go to 9                                                           cal1-101
    8 nwr=nx+2*(ism+2)                                                  cal1-102
      nr4=nwr+4*nc*ism                                                  cal1-103
      nin=4*nin                                                         cal1-104
c  n is the first free address and nin the number of coupling potentialscal1-105
c which can be stored                                                   cal1-106
      n=nr4+4*ism                                                       cal1-107
    9 n3=n                                                              cal1-108
      if (n.gt.idmt) call memo('cal1',idmt,(n+1)/2,1)                   cal1-109
      lo(207)=lo(124).and.iterm.gt.1                                    cal1-110
      if (bjm.ne.0.d0) nin=nin+nc                                       cal1-111
      if (lo(207)) n3=n3+nin*ism                                        cal1-112
      if (lo(54)) write (mw,1000) n3,aj                                 cal1-113
      if (n3.le.idmt) go to 10                                          cal1-114
      lo(207)=.false.                                                   cal1-115
      lo(124)=.false.                                                   cal1-116
      lo(24)=.true.                                                     cal1-117
      n3=n                                                              cal1-118
      write (mw,1001)                                                   cal1-119
   10 nplace=max0(nplace,n3)                                            cal1-120
      if (lo(100)) go to 11                                             cal1-121
      call inti(dw(nfam),dw(nx),dw(nww),dw(nwr),dw(nr4),dw(npad),nw(1,nrcal1-122
     15),ism,kab,dw(n),iterm,nc,dw(nvc1),dw(nvc2),nw(1,nnwi),nw(1,mcc),ncal1-123
     2w(1,nxc),dw(nxc),dw(nx1),npx,h,aconv,eiter,ncxn,nni,iterr,lo)     cal1-124
      if (lo(204).or.iterm.eq.1) go to 13                               cal1-125
      if (lo(123)) go to 13                                             cal1-126
      if (lo(210)) write (mw,1002) aj,jpi                               cal1-127
      lo(225)=.true.                                                    cal1-128
      lo(228)=.true.                                                    cal1-129
      go to 7                                                           cal1-130
   11 call intr(dw(nfam),dw(nx),dw(nww),dw(nwr),dw(nr4),dw(npad),nw(1,nrcal1-131
     15),ism,kab,dw(n),iterm,nc,dw(nvc1),dw(nvc2),nw(1,nnwi),nw(1,mcc),ncal1-132
     2w(1,nxc),dw(nxc),dw(nx1),h,aconv,eiter,ncxn,nni,iterr,lo)         cal1-133
      go to 13                                                          cal1-134
c usual coupled channels calculation                                    cal1-135
c nwr is the first address to store potentials and nm the maximum       cal1-136
c number of points   for arguments  see inch                            cal1-137
   12 nwr=nx+6*kab*kab                                                  cal1-138
      if (lo(54)) write (mw,1000) nwr,aj                                cal1-139
      nfai=nx+nc*kab                                                    cal1-140
      nfar=nfai+3*kab*kab                                               cal1-141
      if (lo(227)) go to 13                                             cal1-142
      n=nwr+2*nc*nc*(ism+1)                                             cal1-143
      if (n.gt.2*idmt) call memo('cal1',idmt,(n+1)/2,1)                 cal1-144
      nm=(idmt-nwr)/(2*nc*nc)-1                                         cal1-145
      nm=min0(nm,ism)                                                   cal1-146
      if (lo(54).and.nm.ne.ism) write (mw,1003) nm                      cal1-147
      n3=nwr+(nm+1)*nc*nc                                               cal1-148
      nplace=max0(nplace,2*n3-nwr,nfar+3*kab*kab)                       cal1-149
      call inch(dw(nvc1),dw(nvc2),nw(1,mcc),nw(1,nxc),dw(nxc),nw(1,nnwi)cal1-150
     1,dw(nfam),dw(nx1),dw(nx),dw(nwr),dw(n3),ism,kab,nc,ncxn,nm,iterm,ncal1-151
     2px,nw(1,nwr),lo)                                                  cal1-152
   13 if (lo(74)) call hora                                             cal1-153
c nfar and nfai  addresses of real and imaginary parts of s-matrix      cal1-154
      nmx=nwr+(4+ncin)*(nc+kxt)                                         cal1-155
      n=nmx+max0(4*nc*nc,lmax2+4*ipj)                                   cal1-156
      if (n.gt.idmt) call memo('cal1',idmt,n,1)                         cal1-157
      npt=npt+1                                                         cal1-158
      call scam(dw(nsm),dw(nty),dw(ntx),dw(nry),njmax,kmax,nw(1,mcc),nw(cal1-159
     11,ncc),dw(nfar),dw(nfai),dw(nwv),ncoll,ncols,kab,kcc,nw,nw(1,mipi)cal1-160
     2,dw(ngam),dw(nfis),dw(nixt),nw(1,ncoi),dw(nxd),dw(nmx),dw(nmx),dw(cal1-161
     3nwr),nct,ncin+4,dw(nxa),kbc,idmt-nmx,xz,lo)                       cal1-162
      if (lo(232)) go to 14                                             cal1-163
      lo(232)=r1(2).lt.conj.and.ipj.gt.kmin                             cal1-164
      if (.not.lo(232)) ipk=ipj                                         cal1-165
      if (lo(232).and.(lo(218).or.lo(215))) write (mw,1004) aj,r1(2)    cal1-166
   14 if (lo(74)) call hora                                             cal1-167
      if (lo(21)) go to 15                                              cal1-168
c reduction of maximum number of iterations if 2 where sufficient(iterr)cal1-169
      if (lo(125).and.(iterr.le.2).and.(ipj.gt.jdm)) iterm=1            cal1-170
c checks of convergence                                                 cal1-171
      if ((nni.eq.nc).and.(ipj.gt.jdm)) lo(227)=.true.                  cal1-172
      if (lo(128).and.nni.eq.nc.and.ipj.gt.jdm+1) go to 18              cal1-173
c increase of the total angular momentum                                cal1-174
   15 if (lo(143)) go to 17                                             cal1-175
      do 16 i=1,jit                                                     cal1-176
      if (ipj.le.nw(1,njit+i-1)) go to 17                               cal1-177
   16 ipj=ipj+nw(2,njit+i-1)*ip1                                        cal1-178
   17 ipj=ipj+ip1                                                       cal1-179
      if (ipj.gt.lmax3-lmx) lo(227)=.true.                              cal1-180
      if (.not.lo(208)) lo(227)=.false.                                 cal1-181
      if ((ipj.le.njmax).and.((r1(1).ge.conj).or.(ipj.le.jdm).or.(ncin.ecal1-182
     1q.0))) go to 6                                                    cal1-183
c change of parity                                                      cal1-184
   18 naj=jmin+2*ipx-2                                                  cal1-185
      if (lo(218).or.lo(215)) write (mw,1005) aj,r1(1)                  cal1-186
      if (jpi.eq.1) go to 19                                            cal1-187
      jpi=jpi+1                                                         cal1-188
      ipy=ipx                                                           cal1-189
      ipz=ipk                                                           cal1-190
      go to 4                                                           cal1-191
   19 ipm=max0(ipx,ipy)                                                 cal1-192
      ipk=max0(ipk,ipz)                                                 cal1-193
      if (lo(163)) go to 22                                             cal1-194
      write (63,1006) dw(nwv),dw(nwv+11),dw(nwv+1),nw(2,2),npt          cal1-195
      rewind 99                                                         cal1-196
      do 21 i=1,npt                                                     cal1-197
      read (99,1007) u1,jp,k3                                           cal1-198
      write (63,1007) u1,jp,k3                                          cal1-199
      do 20 k=1,k3                                                      cal1-200
      read (99,1008) k1,k2,u1,u2                                        cal1-201
   20 write (63,1008) k1,k2,u1,u2                                       cal1-202
   21 continue                                                          cal1-203
      close (99,status='delete')                                        cal1-204
   22 kcb=max0(nct(5),nct(6))                                           cal1-205
      ndx=nxc+8*kcb                                                     cal1-206
      ndy=ndx+jth                                                       cal1-207
      ndz=ndy+jth                                                       cal1-208
      nmy=ndz+jtx                                                       cal1-209
      nga=nmy+3*njc                                                     cal1-210
      nma=nga+4*kbc*kab                                                 cal1-211
      nmc=nma+ms1*ms2*kcb                                               cal1-212
      n=nmc+2*ipm                                                       cal1-213
      if (n.gt.idmt) call memo('cal1',idmt,n,1)                         cal1-214
      call sche(dw(nsm),njmax,kmax,nw,ms1,ms2,nw(1,nfm),dw(ntx),dw(nmc),cal1-215
     1nw(1,nxc),dw(nga),dw(nxg),lmax2,dw(nwv),kab,kba,kcb,jmin,ipm,ipk,dcal1-216
     2w(nty),ncoll,ncols,nct,dw(nry),dw(nma),jit,nw(1,njit),nlt,idmt-nmccal1-217
     3,xz,lo)                                                           cal1-218
      id1=idmt-nga                                                      cal1-219
c for arguments    see calx and resu                                    cal1-220
      call resu(nw,dw(nsm),dw(ntx),njmax,kmax,ncoll,ncols,nw(1,nfm),cw(1cal1-221
     1,nfm),nw(1,ntgx),dw(ntgx),ipm,ipk,dw(ndonn),ncolr,nw(1,nam1),dw(nacal1-222
     2m1),dw(nwv),dw(mwv),dw(nry),nw(1,ncoi),dw(nxd),jmin,nrz,njc,dw(nrecal1-223
     3s),dw(nga),dw(nmy),dw(ndx),dw(ndy),dw(ndz),cmb,xz,id1,lo)         cal1-224
      nplace=max0(nplace,nga+id1)                                       cal1-225
      if (lo(74)) call hora                                             cal1-226
      lo(217)=.true.                                                    cal1-227
      lo(215)=.false.                                                   cal1-228
      return                                                            cal1-229
 1000 format (10x,'required working field',i10,'  for j =',f7.1)        cal1-230
 1001 format (/' working field too small to store all the potentials'/1xcal1-231
     1,52('*')//' the 24th control is set .true.'//)                    cal1-232
 1002 format (' warning: for j =',f6.1,' parity (-1)**',i1,' the derivatcal1-233
     1ive terms are neglected')                                         cal1-234
 1003 format ('+',60x,'computation of potentials by',i5,'  at a time')  cal1-235
 1004 format (' maximum j-value =',f6.1,' for compound nucleus',6x,'maxical1-236
     1mum coefficient at the end',d12.3)                                cal1-237
 1005 format (' maximum j-value =',f6.1,16x,'maximum scattering coefficical1-238
     1ent at the end',d12.3)                                            cal1-239
 1006 format ('<tlj     >',f10.2,f10.5,f10.2,2i5)                       cal1-240
 1007 format (1x,f4.1,1x,a1,1x,i4)                                      cal1-241
 1008 format (1x,i2,i4,f6.1,2x,1p,d14.7,0p,3x)                          cal1-242
      end                                                               cal1-243
c 24/05/04                                                      ecis03
      subroutine pote(beta,nbta,v,ivq,ivy,ivz,q,np,val,nval,vco,vdo,wv,wpote-001
     1vm,aconv,ism,ncoll,ncold,ncolt,idt,ipi,ipim,ipp,tl,iqm,npp,nbt1,mcpote-002
     2m,chb,ccz,lo)                                                     pote-003
c computation and output of form factors                                pote-004
c input variables: beta,nbta: deformations of the target                pote-005
c                  ivq:       table of angular momenta of form factors  pote-006
c                  ivy:       table for computation of form factors     pote-007
c                  ivz:       table for use of form factors             pote-008
c                  val,nval:  optical model and folding parameters      pote-009
c                  wv,wvm:      ( see calx )                            pote-010
c                  aconv:     value below which the pot. can be negl.   pote-011
c                  ism:       number of points                          pote-012
c                  ncoll:     number of coupled nuclear states          pote-013
c                  ncold:     total number of states without continuum  pote-014
c                  ncolt:     total number of states with continuum     pote-015
c                  idt: maximum working field p  returns the place used pote-016
c                  ipi,ipim:    ( see calx )                            pote-017
c                  ipp:       cross-reference to potentials in ipi(1,*) pote-018
c                  iqm:       maximum order of deformation in rot. modelpote-019
c                  npp:       number of optical potentials              pote-020
c                  nbt1:      number of vibrations                      pote-021
c                  mcm:       angular momentum limitation on coul. corr.pote-022
c                  lo:        logical controls                          pote-023
c commons /pote1/ and /pote2/   see redm                                pote-024
c common /dcons/   see calc and colf                                    pote-025
c output variables:v(i,j): potential and transition form factors        pote-026
c             for schroedinger equations:                               pote-027
c     after ity(1) (=0) real central potentials in order ipi(11,*)      pote-028
c     after ity(3) real spin-orbit form factors in the same order       pote-029
c     after ity(5) real transition form factors in order ivz(1,*)       pote-030
c     after ity(7) real derived spin-orbit form factors in order        pote-031
c           ivz(1,*) with the r**-2 form factor at the same address+inlspote-032
c     imaginary potentials and form factor follow with the same order   pote-033
c           from ity(2), ity(4), ity(6) and ity(8)                      pote-034
c                                                                       pote-035
c             for dirac equations:                                      pote-036
c     after ity(1) (=0) for each level, 14 form factors v(*,i,*) which  pote-037
c           are central potential for i=1,2   spin-orbit potential for  pote-038
c           i=3,4  d=e+m+v-w for i=5,6   e-m-v-w for i=7,8  d**(1/2) forpote-039
c           i=9,10 d**(-1) for i=11,12  and  - d( tensor ) for i=13,14  pote-040
c     after itx(6) the invt sets of complex scalar + vector form factorspote-041
c           followed by the insl sets of tensor form factors            pote-042
c                                                                       pote-043
c                  vco(2,i): strength of coulomb potential tails        pote-044
c                            scalar in vco(1,i), spin-orbit in vco(2,i) pote-045
c                  vdo(2,i): strength of coulomb transition tails       pote-046
c                            scalar in vdo(1,i), spin-orbit in vdo(2,i) pote-047
c                  tl:   transmission coefficients for uncoupled states pote-048
c working field: np  in equivalence with q, double precision.           pote-049
c***********************************************************************pote-050
      implicit real*8 (a-h,o-z)                                         pote-051
      logical lo(250)                                                   pote-052
      dimension v(ism,1),ivq(3,1),beta(9,1),val(34,1),ivz(4,1),vco(2,1),pote-053
     1vdo(2,1),nval(1),ipi(11,1),ipp(30,1),nbta(18,1),np(1),ilo(16),mcm(pote-054
     22),ipim(11,1),ipix(11),ivy(7,1),q(1),wv(18,1),pgn(10),xgn(10),w(24pote-055
     3),wvm(18,1),wvx(18),tl(1)                                         pote-056
      character*4 bb(2)                                                 pote-057
      character*8 aa(3,8)                                               pote-058
      common /pote1/ itx(16),imax,intc,inls,invc,invd,itxm              pote-059
      common /pote2/ ity(8),invt,intv,insl,npx                          pote-060
      common /dcont/ xe,xm,xn,xz                                        pote-061
      common /inout/ mr,mw,ms                                           pote-062
      equivalence (itx(1),it1),(itx(2),it2),(itx(3),it3),(itx(4),it4),(ipote-063
     1tx(5),it5),(itx(6),it6),(itx(7),it7),(itx(8),it8),(itx(9),it9),(itpote-064
     2x(10),it0),(itx(11),ita),(itx(12),itb),(itx(13),itc),(itx(14),itd)pote-065
     3,(itx(15),ite),(itx(16),itf)                                      pote-066
      equivalence (ity(1),iv1),(ity(2),iv2),(ity(3),iv3),(ity(4),iv4),(ipote-067
     1ty(5),iv5),(ity(6),iv6),(ity(7),iv7),(ity(8),iv8)                 pote-068
      data pgn( 1),pgn( 2) / 1.52753387130726d-01, 1.49172986472604d-01/pote-069
      data pgn( 3),pgn( 4) / 1.42096109318382d-01, 1.31688638449177d-01/pote-070
      data pgn( 5),pgn( 6) / 1.18194531961518d-01, 1.01930119817240d-01/pote-071
      data pgn( 7),pgn( 8) / 8.32767415767047d-02, 6.26720483341091d-02/pote-072
      data pgn( 9),pgn(10) / 4.06014298003869d-02, 1.76140071391521d-02/pote-073
      data xgn( 1),xgn( 2) / 7.65265211334973d-02, 2.27785851141645d-01/pote-074
      data xgn( 3),xgn( 4) / 3.73706088715420d-01, 5.10867001950827d-01/pote-075
      data xgn( 5),xgn( 6) / 6.36053680726515d-01, 7.46331906460151d-01/pote-076
      data xgn( 7),xgn( 8) / 8.39116971822219d-01, 9.12234428251326d-01/pote-077
      data xgn( 9),xgn(10) / 9.63971927277914d-01, 9.93128599185095d-01/pote-078
      data bb /'    ','last'/                                           pote-079
      data aa/'      re','al volum','e/scalar',' imagina','ry volum','e/pote-080
     1scalar','     rea','l surfac','e/vector','  imagin','. surfac','e/pote-081
     2vector','  real s','pin-orbi','t/tensor',' imag. s','pin-orbi','t/pote-082
     3tensor','        ','        ',' coulomb','      sp','in-orbit',' cpote-083
     4oulomb'/                                                          pote-084
      data ilo /162,162,162,162,201,202,162,203,162,112,162,112,113,114,pote-085
     1111,119/                                                          pote-086
      idy=0                                                             pote-087
      if (lo(220)) go to 4                                              pote-088
      itm=itxm                                                          pote-089
      if (lo(100)) itm=itm-it7                                          pote-090
      if (lo(7)) go to 3                                                pote-091
      invz=intc                                                         pote-092
      iny=1                                                             pote-093
      if (lo(209)) iny=3                                                pote-094
      do 2 ip=1,npp                                                     pote-095
      k=iabs(ipp(1,ip))                                                 pote-096
      invy=invz+iny                                                     pote-097
      n1=(invy+1)/2+1                                                   pote-098
      n2=n1+max0(imax,iqm)+1                                            pote-099
      id1=invy+27                                                       pote-100
      idx=10                                                            pote-101
      if (lo(3)) idx=36                                                 pote-102
      if (lo(101)) idx=1                                                pote-103
      idx=max0(idx*id1+10*invy,6*ism)+n2                                pote-104
      if (idx.gt.idt) call memo('pote',idt,idx,2)                       pote-105
      ik=ip                                                             pote-106
      if (lo(100)) ik=it4+24*ip+1                                       pote-107
      call rotp(beta,nbta,beta(1,nbt1+1),ik,v,v(1,it3+1),ivy,np,q(n1),q(pote-108
     1n2),q(10*invy+n2),val(1,ip),id1,ism,wv(11,k),invz,invy,iqm,iny,nbtpote-109
     21,pgn,xgn,ccz,lo)                                                 pote-110
c  to use the folding model, the spin-orbit potentials and the first    pote-111
c spin-orbit non diagonal form factors are not derived ( v(r) instead ofpote-112
c (1/r)*(d/dr)(v(r)) )  for schroedinger equations. for dirac equations pote-113
c the derivatives are computed but not used.                            pote-114
      idy=max0(idx,idy)                                                 pote-115
      if (lo(74)) call hora                                             pote-116
      if (lo(117)) go to 2                                              pote-117
c  *******  folding model  **********                                   pote-118
      ist=5+ism+idint(2.d0*(dabs(val(33,ip))+2.d0*dabs(val(34,ip)))/wv(1pote-119
     11,k))                                                             pote-120
      if (val(32,ip)*val(33,ip).eq.0.d0) ist=ism+5                      pote-121
c the working space in p is shifted from v with the origins in table it pote-122
      nnf=1+ism*itm                                                     pote-123
      idz=nnf+4*itm                                                     pote-124
      idx=idz+4*ist                                                     pote-125
      if (invz.ne.0) idx=idx+2*ist*imax                                 pote-126
      idy=max0(idy,idx)                                                 pote-127
      if (idx.gt.2*idt) call memo('pote',idt,(idx+1)/2,2)               pote-128
      do 1 j=1,nnf                                                      pote-129
    1 q(j)=0.d0                                                         pote-130
      call fold(v(1,ik),p,val(26,ip),3,ip,ism,ist,aconv,ivy,invz,q(idz),pote-131
     1pgn,xgn,wv,np(nnf),lo)                                            pote-132
      if (lo(74)) call hora                                             pote-133
    2 invz=0                                                            pote-134
      go to 4                                                           pote-135
    3 nnf=2*itm                                                         pote-136
      if (nnf.gt.idt) call memo('pote',idt,nnf,2)                       pote-137
      idz=idt-nnf                                                       pote-138
      ik=1                                                              pote-139
      if (lo(100)) ik=it7+1                                             pote-140
      call stdp(v(1,ik),ivy,ism,val,nval,idz,idx,q(nnf+1),wv,pgn,xgn,npppote-141
     1,np,q(nnf+1),aconv,ccz,lo)                                        pote-142
      idy=max0(idy,idx+2*nnf)                                           pote-143
    4 if (lo(162)) go to 14                                             pote-144
      npt=8*(npp+intc)                                                  pote-145
      if (lo(201)) npt=npt-npp                                          pote-146
      if (lo(202)) npt=npt-npp                                          pote-147
      if (lo(203)) npt=npt-npp                                          pote-148
      if (lo(111)) npt=npt-intc                                         pote-149
      if (lo(112)) npt=npt-2*intc                                       pote-150
      if (lo(113)) npt=npt-intc                                         pote-151
      if (lo(114)) npt=npt-intc                                         pote-152
      if (lo(119)) npt=npt-intc                                         pote-153
      write (62,1000) wv(1,1),wv(12,1),wv(2,1),ipi(4,1),npt             pote-154
      ist=2*(ism/2)                                                     pote-155
      idx=ist                                                           pote-156
      idy=max0(idy,idx)                                                 pote-157
      if (idx.gt.2*idt) call memo('pote',idt,(idx+1)/2,2)               pote-158
c punch the form factors                                                pote-159
      do 5 i=1,ist                                                      pote-160
    5 q(i)=i*wv(11,1)                                                   pote-161
      ir=0                                                              pote-162
      do 8 ip=1,npp                                                     pote-163
      do 7 ij=1,8                                                       pote-164
      is=1                                                              pote-165
      il=ilo(ij)                                                        pote-166
      if (lo(il)) go to 7                                               pote-167
      ji=ip+itx(ij)                                                     pote-168
      if (lo(100)) ji=it7+ij+24*(ip-1)                                  pote-169
      ir=ir+1                                                           pote-170
      write (mw,1001) (aa(j,ij),j=1,3),ip,ir                            pote-171
      write (62,1001) (aa(j,ij),j=1,3),ip,ir                            pote-172
      do 6 i=1,ist,2                                                    pote-173
      if (i.eq.ist-1) is=2                                              pote-174
      write (mw,1002) q(i),v(i,ji),q(i+1),v(i+1,ji),bb(is),ir           pote-175
    6 write (62,1003) q(i),v(i,ji),q(i+1),v(i+1,ji),bb(is),ir           pote-176
    7 continue                                                          pote-177
    8 continue                                                          pote-178
      if (intc.eq.0) go to 14                                           pote-179
      do 13 iq=1,intc                                                   pote-180
      do 12 ij=9,16                                                     pote-181
      is=1                                                              pote-182
      il=ilo(ij)                                                        pote-183
      if (lo(il)) go to 12                                              pote-184
      ip=iq                                                             pote-185
      if (ij.eq.13.or.ij.eq.14) ip=ivy(3,iq)+inls                       pote-186
      if (ij.ge.15) ip=ivy(ij-11,iq)                                    pote-187
      if (ip.le.0) go to 12                                             pote-188
      ji=ip+itx(ij)                                                     pote-189
      if (lo(100)) ji=it7+24*npp+11*iq+ij-19                            pote-190
      ir=ir+1                                                           pote-191
      write (mw,1004) (aa(j,ij-8),j=1,3),iq,ir                          pote-192
      write (62,1004) (aa(j,ij-8),j=1,3),iq,ir                          pote-193
      if (lo(200).and.(ij.ge.13).and.(ij.ne.15)) go to 10               pote-194
      do 9 i=1,ist,2                                                    pote-195
      if (i.eq.ist-1) is=2                                              pote-196
      write (mw,1002) q(i),v(i,ji),q(i+1),v(i+1,ji),bb(is),ir           pote-197
    9 write (62,1003) q(i),v(i,ji),q(i+1),v(i+1,ji),bb(is),ir           pote-198
      go to 12                                                          pote-199
   10 if (ij.eq.16) ji=ji+invd                                          pote-200
      do 11 i=1,ist,2                                                   pote-201
      a1=-v(i,ji)*q(i)**2                                               pote-202
      a2=-v(i+1,ji)*q(i+1)**2                                           pote-203
      if (i.eq.ist-1) is=2                                              pote-204
      write (mw,1002) q(i),a1,q(i+1),a2,bb(is),ir                       pote-205
   11 write (62,1003) q(i),a1,q(i+1),a2,bb(is),ir                       pote-206
   12 continue                                                          pote-207
   13 continue                                                          pote-208
   14 if (lo(220)) go to 66                                             pote-209
      if (intc.eq.invt) go to 26                                        pote-210
c addition of correction terms of form factors                          pote-211
      do 25 k=1,invt                                                    pote-212
      if (ivy(6,k).le.0) go to 25                                       pote-213
      k1=ivy(6,k)                                                       pote-214
      l=ivy(7,k)+2                                                      pote-215
      do 24 n=1,8                                                       pote-216
      il=ilo(n+8)                                                       pote-217
      if ((il.ne.162).and.lo(il)) go to 24                              pote-218
      l1=l                                                              pote-219
      m=0                                                               pote-220
      if (lo(100)) go to 17                                             pote-221
      if (n.gt.6) go to 16                                              pote-222
      if (n.gt.4) go to 15                                              pote-223
      k2=itx(n+8)+k                                                     pote-224
      k3=itx(n+8)+k1                                                    pote-225
      go to 19                                                          pote-226
   15 if (ivy(3,k).eq.0) go to 24                                       pote-227
      k2=itx(n+8)+ivy(3,k)+inls                                         pote-228
      k3=itx(n+8)+ivy(3,k1)+inls                                        pote-229
      l1=l1+2                                                           pote-230
      m=-inls                                                           pote-231
      go to 19                                                          pote-232
   16 if (ivy(n-3,k).eq.0) go to 24                                     pote-233
      k2=itx(n+8)+ivy(n-3,k)                                            pote-234
      k3=itx(n+8)+ivy(n-3,k1)                                           pote-235
      if (n.eq.8) m=invd                                                pote-236
      go to 18                                                          pote-237
   17 if ((n.gt.4).and.(n.ne.7)) m=min0(11-n,4)                         pote-238
      k2=it5+11*k+n                                                     pote-239
      k3=k2+11*(k1-k)                                                   pote-240
      if (n.le.6) go to 19                                              pote-241
   18 ci=v(ism,k3)                                                      pote-242
      cr=v(ism,k2)                                                      pote-243
      go to 21                                                          pote-244
   19 dd=0.d0                                                           pote-245
      ci=0.d0                                                           pote-246
      cr=0.d0                                                           pote-247
      do 20 is=1,ism                                                    pote-248
      dd=dd+wv(11,1)                                                    pote-249
      ci=ci+v(is,k3)*dd**l1                                             pote-250
   20 cr=cr+v(is,k2)*dd**l1                                             pote-251
   21 if ((ci.eq.0.d0).or.(cr.eq.0.d0)) go to 24                        pote-252
      cr=cr/ci                                                          pote-253
      if (.not.lo(217)) write (mw,1005) k,n,cr                          pote-254
   22 do 23 is=1,ism                                                    pote-255
   23 v(is,k2)=v(is,k2)-cr*v(is,k3)                                     pote-256
      if (m.eq.0) go to 24                                              pote-257
      k2=k2+m                                                           pote-258
      k3=k3+m                                                           pote-259
      m=0                                                               pote-260
      go to 22                                                          pote-261
   24 continue                                                          pote-262
   25 continue                                                          pote-263
   26 rm=ism*wv(11,1)                                                   pote-264
      if (lo(74)) call hora                                             pote-265
c storage of optical potentials                                         pote-266
      xp=xn/chb                                                         pote-267
      xq=xp**2                                                          pote-268
      do 42 kj=1,ncolt                                                  pote-269
      jj=mod(kj+ncoll-1,ncolt)+1                                        pote-270
      if (jj.gt.ncold) go to 29                                         pote-271
      do 27 i=1,11                                                      pote-272
   27 ipix(i)=ipi(i,jj)                                                 pote-273
      do 28 i=1,18                                                      pote-274
   28 wvx(i)=wv(i,jj)                                                   pote-275
      go to 32                                                          pote-276
   29 do 30 i=1,11                                                      pote-277
   30 ipix(i)=ipim(i,jj-ncold)                                          pote-278
      do 31 i=1,18                                                      pote-279
   31 wvx(i)=wvm(i,jj-ncold)                                            pote-280
   32 if (lo(100)) go to 36                                             pote-281
c potentials for schroedinger equation                                  pote-282
      if (jj.gt.ncoll) go to 33                                         pote-283
      i1=ipix(11)                                                       pote-284
      i2=i1+iv2                                                         pote-285
      i3=i1+iv3                                                         pote-286
      i4=i1+iv4                                                         pote-287
      go to 34                                                          pote-288
   33 i1=1                                                              pote-289
      i2=2                                                              pote-290
      i3=3                                                              pote-291
      i4=4                                                              pote-292
   34 j=ipix(5)                                                         pote-293
      do 35 is=1,ism                                                    pote-294
      v(is,i1)=v(is,j+it1)+v(is,j+it3)+wvx(14)*v(is,j+it2)+wvx(16)*v(is pote-295
     1,j+it4)                                                           pote-296
      v(is,i2)=v(is,j+it2)+v(is,j+it4)+wvx(13)*v(is,j+it2)+wvx(15)*v(is pote-297
     1,j+it4)                                                           pote-298
      if (lo(229)) v(is,i3)=v(is,j+it5)*(1.d0+wvx(18))                  pote-299
      if (lo(230)) v(is,i4)=v(is,j+it6)*(1.d0+wvx(17))                  pote-300
      if (.not.lo(203)) v(is,i3)=v(is,i3)+v(is,j+it8)*xq                pote-301
   35 v(is,i1)=v(is,i1)-v(is,j+it7)                                     pote-302
      if (.not.lo(203)) vco(2,i1)=v(ism,j+it8)*rm**3/xm                 pote-303
      if (lo(199)) go to 41                                             pote-304
      vco(1,i1)=rm*v(ism,j+it7)*xm/(xe*chb)                             pote-305
      vco(2,i1)=vco(2,i1)+vco(1,i1)*chb/(xm+wv(7,1))                    pote-306
      go to 41                                                          pote-307
c potentials for dirac equation                                         pote-308
c at this point:   after v(1,it7),                                      pote-309
c v(*,n,1) scalar potential v for n=1,2 vector potential w for n=3,4    pote-310
c          tensor potential t for n=5,6 coulomb potentials for n=7,8    pote-311
c          their first derivatives for n=9,16                           pote-312
c          their second derivatives for n=17,24                         pote-313
c   the first derivatives of non-coulomb potentials have a reversed signpote-314
   36 m=it4+24*ipix(5)                                                  pote-315
      j=jj                                                              pote-316
      if (j.gt.ncoll) j=1                                               pote-317
      n=14*j-14                                                         pote-318
      rr=0.d0                                                           pote-319
      do 40 is=1,ism                                                    pote-320
      rr=rr+wvx(11)                                                     pote-321
      do 37 k=1,24                                                      pote-322
   37 w(k)=v(is,k+m)                                                    pote-323
      if (lo(110)) go to 39                                             pote-324
      do 38 k=1,24,8                                                    pote-325
      w(k)=w(k)+wvx(14)*w(k+1)                                          pote-326
      w(k+1)=w(k+1)+wvx(13)*w(k+1)                                      pote-327
      w(k+2)=w(k+2)+wvx(16)*w(k+3)                                      pote-328
      w(k+3)=w(k+3)+wvx(15)*w(k+3)                                      pote-329
      w(k+4)=(1.d0+wvx(18))*w(k+4)                                      pote-330
   38 w(k+5)=(1.d0+wvx(17))*w(k+5)                                      pote-331
   39 w(3)=w(3)+w(7)                                                    pote-332
      w(11)=w(11)+w(15)                                                 pote-333
      w(19)=w(19)+w(23)                                                 pote-334
      w(13)=(w(13)+w(16))/xm                                            pote-335
      w(21)=(w(21)+w(24))/xm                                            pote-336
      w(14)=w(14)/xm                                                    pote-337
      w(22)=w(22)/xm                                                    pote-338
      w(15)=xm+wvx(7)+w(1)-w(3)                                         pote-339
      w(16)=w(2)-w(4)                                                   pote-340
      v(is,n+7)=(wvx(7)-xm-w(1)-w(3))/chb                               pote-341
      v(is,n+8)=-(w(2)+w(4))/chb                                        pote-342
      dd=w(15)**2+w(16)**2                                              pote-343
      w(5)=w(15)/dd                                                     pote-344
      w(6)=-w(16)/dd                                                    pote-345
      dd=dsqrt(dsqrt(dd)/(xm+wvx(7)))                                   pote-346
      ar=.5d0*datan2(w(16),w(15))                                       pote-347
      v(is,n+9)=dd*dcos(ar)                                             pote-348
      v(is,n+10)=dd*dsin(ar)                                            pote-349
      ar=w(11)-w(9)                                                     pote-350
      ai=w(12)-w(10)                                                    pote-351
      br=w(17)-w(19)                                                    pote-352
      bi=w(18)-w(20)                                                    pote-353
      cr=ar*w(5)-ai*w(6)+w(13)                                          pote-354
      ci=ar*w(6)+ai*w(5)+w(14)                                          pote-355
      er=br*w(5)-bi*w(6)+w(13)*(cr+cr-w(13))-w(14)*(ci+ci-w(14))-w(21)+2pote-356
     1.d0*cr/rr                                                         pote-357
      ei=br*w(6)+bi*w(5)+w(13)*(ci+ci-w(14))+w(14)*(cr+cr-w(13))-w(22)+2pote-358
     1.d0*ci/rr                                                         pote-359
      v(is,n+1)=-w(1)-w(3)*wvx(7)/xm-(w(1)*w(1)-w(2)*w(2)-w(3)*w(3)+w(4)pote-360
     1*w(4))/(2.d0*xm)-(.75d0*(cr**2-ci**2)-.5d0*er)*xn                 pote-361
      v(is,n+2)=-w(2)-w(4)*wvx(7)/xm-(w(1)*w(2)-w(3)*w(4))/xm-(1.5d0*cr*pote-362
     1ci-.5d0*ei)*xn                                                    pote-363
      v(is,n+3)=.5d0*cr*xn/rr                                           pote-364
      v(is,n+4)=.5d0*ci*xn/rr                                           pote-365
      v(is,n+5)=w(15)/chb                                               pote-366
      v(is,n+6)=w(16)/chb                                               pote-367
      v(is,n+11)=w(5)*chb                                               pote-368
      v(is,n+12)=w(6)*chb                                               pote-369
      v(is,n+13)=w(13)/chb                                              pote-370
   40 v(is,n+14)=w(14)/chb                                              pote-371
      vco(1,j)=w(7)*rr/chb                                              pote-372
      vco(2,j)=rr*(w(7)/(xm+wvx(7))+w(8)/xm)                            pote-373
   41 if (jj.le.ncoll) go to 42                                         pote-374
      nx1=2*ism+5                                                       pote-375
      nx2=nx1+10*(ipix(10)+1)                                           pote-376
      nx3=2*nx2-1                                                       pote-377
      call tlnc(wv(11,1),ipix,wvx,tl(ipix(8)),ism,q,q(nx1),ipix(10)+1,nppote-378
     1(nx3),q(nx2),idt-nx3,v,vco,lo)                                    pote-379
   42 continue                                                          pote-380
      if (intv.eq.0) go to 66                                           pote-381
c storage of transition form factors                                    pote-382
      do 65 j=1,intv                                                    pote-383
      ij=ivz(1,j)                                                       pote-384
      if (lo(200)) go to 43                                             pote-385
      ik=it6+4*j                                                        pote-386
      ki=it5+11*ij                                                      pote-387
   43 l=ivy(4,ij)                                                       pote-388
      if (l.eq.0) go to 48                                              pote-389
      k=ivy(2,ij)                                                       pote-390
      if (ivq(2,k).ge.0) go to 48                                       pote-391
c magnetic coulomb transition                                           pote-392
      dd=2.d0*(wv(11,1)/wv(8,1))**2/chb                                 pote-393
      if (lo(100)) go to 45                                             pote-394
      do 44 is=1,ism                                                    pote-395
      if (lo(12)) v(is,j+iv6)=0.d0                                      pote-396
   44 v(is,j+iv5)=-v(is,l+ite)*dd                                       pote-397
      if (ivy(7,ij).le.mcm(1)) vdo(1,j)=v(ism,l+ite)*dd*rm**(ivy(7,ij)+1pote-398
     1)                                                                 pote-399
      go to 65                                                          pote-400
   45 do 47 is=1,ism                                                    pote-401
      do 46 m=1,4                                                       pote-402
   46 v(is,ik+m)=0.d0                                                   pote-403
   47 v(is,ik+3)=v(is,ki+7)*dd                                          pote-404
      if (ivy(7,ij).le.mcm(1)) vdo(1,j)=v(ism,ki+7)*dd*rm**(ivy(7,ij)+1)pote-405
      go to 65                                                          pote-406
c central transition form-factor                                        pote-407
   48 i1=ivz(2,j)/(ncoll+1)                                             pote-408
      i2=mod(ivz(2,j),ncoll+1)                                          pote-409
      do 49 k=1,6                                                       pote-410
      wvx(k)=0.d0                                                       pote-411
      if (i2.ne.0) wvx(k)=.5d0*(wv(k+12,i1)+wv(k+12,i2))                pote-412
   49 continue                                                          pote-413
      if (lo(100)) go to 52                                             pote-414
      do 50 is=1,ism                                                    pote-415
      if (lo(12)) v(is,j+iv6)=v(is,ij+it0)+v(is,ij+itb)+wvx(1)*v(is,ij+ipote-416
     1t0)+wvx(3)*v(is,ij+itb)                                           pote-417
   50 v(is,j+iv5)=v(is,ij+it9)+v(is,ij+ita)+wvx(2)*v(is,ij+it0)+wvx(4)*vpote-418
     1(is,ij+itb)                                                       pote-419
      if (l.eq.0) go to 57                                              pote-420
c coulomb transition form factor for schroedinger equation              pote-421
      do 51 is=1,ism                                                    pote-422
   51 v(is,j+iv5)=v(is,j+iv5)-v(is,l+ite)                               pote-423
      if (ivy(7,ij).le.mcm(1)) vdo(1,j)=v(ism,l+ite)*rm**(ivy(7,ij)+1)  pote-424
      go to 57                                                          pote-425
   52 do 53 is=1,ism                                                    pote-426
      v(is,ik+1)=v(is,ki+1)+wvx(2)*v(is,ki+2)                           pote-427
      v(is,ik+2)=v(is,ki+2)+wvx(1)*v(is,ki+2)                           pote-428
      v(is,ik+3)=v(is,ki+3)+wvx(4)*v(is,ki+4)                           pote-429
   53 v(is,ik+4)=v(is,ki+4)+wvx(3)*v(is,ki+4)                           pote-430
      if (l.eq.0) go to 55                                              pote-431
c coulomb transition form factor for dirac equation                     pote-432
      do 54 is=1,ism                                                    pote-433
   54 v(is,ik+3)=v(is,ik+3)+v(is,ki+7)                                  pote-434
      if (ivy(7,ij).le.mcm(1)) vdo(1,j)=v(ism,ki+7)*rr**(ivy(7,ij)+1)   pote-435
   55 do 56 is=1,ism                                                    pote-436
      cr=v(is,ik+1)                                                     pote-437
      ci=v(is,ik+2)                                                     pote-438
      v(is,ik+1)=xp*(v(is,ik+3)+cr)                                     pote-439
      v(is,ik+2)=xp*(v(is,ik+4)+ci)                                     pote-440
      v(is,ik+3)=xp*(v(is,ik+3)-cr)                                     pote-441
   56 v(is,ik+4)=xp*(v(is,ik+4)-ci)                                     pote-442
   57 if (j.gt.invt) go to 65                                           pote-443
c spin-orbit transition form factor for schroedinger equation           pote-444
      l=ivy(3,ij)                                                       pote-445
      if (l.eq.0) go to 65                                              pote-446
      if (lo(100)) go to 62                                             pote-447
      do 58 is=1,ism                                                    pote-448
      v(is,l+iv7)=v(is,l+itc)*(1.d0+wvx(6))                             pote-449
   58 v(is,l+iv7+insl)=v(is,l+inls+itc)*(1.d0+wvx(6))                   pote-450
      if (lo(114)) go to 60                                             pote-451
      do 59 is=1,ism                                                    pote-452
      v(is,l+iv8)=v(is,l+itd)*(1.d0+wvx(5))                             pote-453
   59 v(is,l+iv8+insl)=v(is,l+inls+itd)*(1.d0+wvx(5))                   pote-454
   60 k=ivy(5,ij)                                                       pote-455
      if (k.eq.0) go to 65                                              pote-456
      do 61 is=1,ism                                                    pote-457
      v(is,l+iv7)=v(is,l+iv7)+v(is,k+itf)*xq                            pote-458
   61 v(is,l+iv7+insl)=v(is,l+iv7+insl)+v(is,k+invd+itf)*xq             pote-459
      if (ivy(7,ij).le.mcm(2)) vdo(2,l)=-v(ism,k+invd+itf)*rm**(ivy(7,i pote-460
     1j)+3)*xq                                                          pote-461
      go to 65                                                          pote-462
c spin-orbit transition form factor for dirac equation                  pote-463
   62 il=it6+4*(l+intv)                                                 pote-464
      rr=0.d0                                                           pote-465
      do 63 is=1,ism                                                    pote-466
      rr=rr+wv(11,1)                                                    pote-467
      v(is,il+1)=-xq*v(is,ki+9)*(1.d0+wvx(6))                           pote-468
      v(is,il+2)=-xq*v(is,ki+10)*(1.d0+wvx(5))                          pote-469
      v(is,il+3)=xq*v(is,ki+5)/rr*(1.d0+wvx(6))                         pote-470
   63 v(is,il+4)=xq*v(is,ki+6)/rr*(1.d0+wvx(5))                         pote-471
      if (ivy(5,ij).eq.0) go to 65                                      pote-472
      rr=0.d0                                                           pote-473
      do 64 is=1,ism                                                    pote-474
      rr=rr+wv(11,1)                                                    pote-475
      v(is,il+1)=v(is,il+1)-xq*v(is,ki+11)                              pote-476
   64 v(is,il+3)=v(is,il+3)+xq*v(is,ki+8)/rr                            pote-477
      if (ivy(7,ij).le.mcm(2)) vdo(2,l)=xp*v(ism,ki+8)*rr**(ivy(7,ij)+1 pote-478
     1)                                                                 pote-479
   65 continue                                                          pote-480
c output of potentials                                                  pote-481
   66 if (lo(151)) go to 73                                             pote-482
      if (lo(100)) go to 70                                             pote-483
      do 67 j=1,npx                                                     pote-484
      write (mw,1006) j                                                 pote-485
      write (mw,1007) (i,v(i,j+iv1),v(i,j+iv2),i=1,ism)                 pote-486
      if (lo(229)) write (mw,1008) (i,v(i,j+iv3),i=1,ism)               pote-487
      if (lo(230)) write (mw,1009) (i,v(i,j+iv4),i=1,ism)               pote-488
   67 continue                                                          pote-489
      if (iv2.eq.iv5) go to 73                                          pote-490
      nvx=iv2-iv5                                                       pote-491
      write (mw,1010)                                                   pote-492
      nva=min0(nvx,6)                                                   pote-493
      do 68 i=1,ism                                                     pote-494
      write (mw,1011) i,(j,v(i,j+iv5),j=1,nva)                          pote-495
      if (nva.ne.nvx) write (mw,1012) (j,v(i,j+iv5),j=7,nvx)            pote-496
   68 continue                                                          pote-497
      if (it1.eq.iv6) go to 73                                          pote-498
      mvx=it1-iv6                                                       pote-499
      write (mw,1013)                                                   pote-500
      nva=min0(mvx,6)                                                   pote-501
      do 69 i=1,ism                                                     pote-502
      write (mw,1011) i,(j,v(i,j+iv6),j=1,nva)                          pote-503
      if (nva.ne.mvx) write (mw,1012) (j,v(i,j+iv6),j=7,mvx)            pote-504
   69 continue                                                          pote-505
      go to 73                                                          pote-506
   70 n=0                                                               pote-507
      do 71 l=1,ncoll                                                   pote-508
      write (mw,1014) l                                                 pote-509
      write (mw,1015) (i,(v(i,n+j),j=1,6),i=1,ism)                      pote-510
      write (mw,1016) l                                                 pote-511
      write (mw,1015) (i,(v(i,n+j),j=7,12),i=1,ism)                     pote-512
      if (.not.(lo(201).and.lo(203))) write (mw,1017) l,(i,(v(i,n+j),j=1pote-513
     13,14),i=1,ism)                                                    pote-514
   71 n=n+14                                                            pote-515
      l=intv+insl                                                       pote-516
      if (l.eq.0) go to 73                                              pote-517
      n=it2                                                             pote-518
      do 72 k=1,l                                                       pote-519
      if (k.le.intv) write (mw,1018) k                                  pote-520
      if (k.gt.intv) write (mw,1019) k                                  pote-521
      write (mw,1020) (i,(v(i,n+j),j=1,4),i=1,ism)                      pote-522
   72 n=n+4                                                             pote-523
   73 idt=idy                                                           pote-524
      return                                                            pote-525
 1000 format ('<potenti.>',f10.2,f10.5,f10.2,2i5)                       pote-526
 1001 format (2x,3a8,' potential ***',i2,' ***',5x,i5)                  pote-527
 1002 format (2x,0p,f10.5,1p,d20.6,0p,f10.5,1p,d20.6,a4,i6)             pote-528
 1003 format (0p,f10.5,1p,d20.6,0p,f10.5,1p,d20.6,a4,i6)                pote-529
 1004 format (2x,3a8,' transition potential ***',i2,' ***',5x,i5)       pote-530
 1005 format (' form factor',i4,'  potential',i3,'  ratio of correcting pote-531
     1deformation',d15.6)                                               pote-532
 1006 format (//' potential ****',i2,' ****')                           pote-533
 1007 format (//' central potential'//(3(5x,i5,1p,2d14.5,' i')))        pote-534
 1008 format (//' real spin-orbit potential'//(6(2x,i4,1p,d14.5)))      pote-535
 1009 format (//' imaginary spin-orbit potential'//(6(2x,i4,1p,d14.5))) pote-536
 1010 format (//' real multipoles'/)                                    pote-537
 1011 format (4x,i4,6(i4,1p,d14.5))                                     pote-538
 1012 format ((8x,6(i4,1p,d14.5)))                                      pote-539
 1013 format (//' imaginary multipoles'/)                               pote-540
 1014 format (//' potentials of schroedinger''s equation for channel',i3pote-541
     1/15x,'central',27x,'spin-orbit',28x,'d(r)')                       pote-542
 1015 format (2x,i3,1p,2d14.7,' i',5x,2d14.7,' i',5x,2d14.7,' i')       pote-543
 1016 format (/17x,'e(r)',28x,'sqrt(d(r))',25x,'d(r)**(-1)',3x,'for chanpote-544
     1nel',i3)                                                          pote-545
 1017 format (/45x,'tensor potential',36x,'for channel',i3/(3(2x,i3,1p,2pote-546
     1d14.7,' i')))                                                     pote-547
 1018 format (//' scalar and vector multipoles',i6/)                    pote-548
 1019 format (//' tensor multipoles',i6/)                               pote-549
 1020 format (5x,i5,1p,2d26.7,' i',10x,2d16.7,' i')                     pote-550
      end                                                               pote-551
c 25/07/04                                                      ecis03  rotp-000
      subroutine rotp(beta,nbta,bta,ip,v,va,ivy,iv,pp,b,p,val,id1,ism,h,rotp-001
     1invz,iq1,iqm,iny,nbt1,pgn,xgn,ccz,lo)                             rotp-002
c input variables:  beta,nbta: deformations, equivalent by call         rotp-003
c                   bta:       static deformations (rotational model)   rotp-004
c                   ip:        potential number (schroedinger equation) rotp-005
c                              address to temporarily storage of dirac  rotp-006
c                              potentials in v                          rotp-007
c                   ivy:       description of form factors              rotp-008
c                              (see third part of iq in redm)           rotp-009
c                   val:       optical parameters                       rotp-010
c                   id1:       first dimension of the working space p   rotp-011
c                   ism,h:     number and size of steps                 rotp-012
c                   invz:      number of transition form factors        rotp-013
c                   iq1:       iny + number of transition form factors  rotp-014
c                   iqm:       maximum multipolarity of static deform.  rotp-015
c                   iny:       1 + number of derivatives of central     rotp-016
c                              potentials ( schroedinger: 1, dirac: 2)  rotp-017
c                   nbt1:      number of vibrations                     rotp-018
c                   pgn,xgn:   weights, abscissae of legendre integral  rotp-019
c                   lo:        logical controls                         rotp-020
c in common /pote1/ (see redm) number and starting address of different rotp-021
c            potentials and form  factor in v for schroedinger equation rotp-022
c in common /dcons/ (see calc) hbar, coulomb parameter                  rotp-023
c output variables: v:         potentials and transition form factors   rotp-024
c                              only potentials and derivatives for diracrotp-025
c                   va:        transition form factors for dirac equ.   rotp-026
c working space:    iv:        order of derivative of the iq1 form fac. rotp-027
c                   pp:        intermediate results, weights, ....      rotp-028
c                   b:         for deformations                         rotp-029
c                   p:         double and single prec. in equivalence   rotp-030
c***********************************************************************rotp-031
      implicit real*8 (a-h,o-z)                                         rotp-032
      logical lo(250),lq(8,5)                                           rotp-033
      dimension ivy(7,2),iv(1),iz(8,2),p(id1,3),ep(8),pp(2),zz(2),dd(2),rotp-034
     1q(8,12,3),vr(6,10),b(10,1),nbta(18,1),pgn(10),xgn(10),ldl(8),srd(4rotp-035
     2),vs(14),beta(9,1),bta(9,1),val(25),v(ism,1),va(ism,11,1)         rotp-036
      common /pote1/ itx(16),imax,intc,inls,invc,invd,itxm              rotp-037
      common /inout/ mr,mw,ms                                           rotp-038
      equivalence (itx(1),it1),(itx(2),it2),(itx(3),it3),(itx(4),it4),(irotp-039
     1tx(5),it5),(itx(6),it6),(itx(7),it7),(itx(8),it8),(itx(9),it9),(itrotp-040
     2x(10),it0),(itx(11),ita),(itx(12),itb),(itx(13),itc),(itx(14),itd)rotp-041
     3,(itx(15),ite),(itx(16),itf)                                      rotp-042
      data ldl /7,112,7,112,113,114,111,119/                            rotp-043
      data srd /1.d0,1.d0,2.d0,6.d0/                                    rotp-044
c checks of diffusenesses                                               rotp-045
      do 2 i=1,8                                                        rotp-046
      j=ldl(i)                                                          rotp-047
      lq(i,5)=lo(j)                                                     rotp-048
      lq(i,1)=val(3*i-2).eq.0.d0                                        rotp-049
      lq(i,2)=(i.le.6).or.(val(3*i-2)*val(3*i).ne.0.d0)                 rotp-050
      lq(i,3)=lq(i,1).or.(.not.lq(i,2))                                 rotp-051
      lq(i,2)=lq(i,2).or.lq(i,1)                                        rotp-052
      if (lq(i,1)) go to 2                                              rotp-053
      lq(i,4)=lo(109).or.(val(3*i-1).ge.0.d0)                           rotp-054
      if (.not.lq(i,2)) go to 1                                         rotp-055
      if (val(3*i).ge.0.02d0*h) go to 1                                 rotp-056
      write (mw,1000) val(3*i),i,ip                                     rotp-057
      val(3*i)=dmax1(-val(3*i),0.02d0*h)                                rotp-058
    1 if (val(3*i-1).ge.h.or.lo(9)) go to 2                             rotp-059
      write (mw,1001) val(3*i-1),i,ip                                   rotp-060
      val(3*i-1)=dmax1(-val(3*i-1),h)                                   rotp-061
    2 continue                                                          rotp-062
      lq(1,2)=lq(7,2).and.lq(8,2)                                       rotp-063
      idg=0                                                             rotp-064
      inx=iny+1                                                         rotp-065
      sr=1.d0                                                           rotp-066
      do 11 i=1,iq1                                                     rotp-067
      iv(i)=i+3                                                         rotp-068
      if (i.le.iny) go to 8                                             rotp-069
      k=mod(ivy(1,i-iny),1000)                                          rotp-070
      if (k.eq.0.or.lo(3)) go to 6                                      rotp-071
      if (k.gt.nbt1) go to 4                                            rotp-072
      iv(i)=2                                                           rotp-073
      idg=max0(idg,1)                                                   rotp-074
      do 3 j=1,8                                                        rotp-075
      if (lo(106)) sr=dabs(val(3*j-1))                                  rotp-076
    3 b(j,i)=0.282095d0*beta(j,k)*sr                                    rotp-077
      go to 10                                                          rotp-078
    4 k1=mod(k,nbt1+1)                                                  rotp-079
      k2=k/(nbt1+1)                                                     rotp-080
      idg=max0(idg,2)                                                   rotp-081
      iv(i)=3                                                           rotp-082
      do 5 j=1,8                                                        rotp-083
      if (lo(106)) sr=dabs(val(3*j-1))                                  rotp-084
    5 b(j,i)=0.0397887d0*beta(j,k1)*beta(j,k2)*sr*sr                    rotp-085
      go to 10                                                          rotp-086
    6 iv(i)=k+1                                                         rotp-087
      idg=max0(idg,k)                                                   rotp-088
      if (lo(1)) go to 8                                                rotp-089
      do 7 j=1,8                                                        rotp-090
      if (lo(106)) sr=dabs(val(3*j-1))                                  rotp-091
    7 b(j,i)=sr**k*0.282095d0*beta(j,k+1)/srd(k+1)                      rotp-092
      go to 10                                                          rotp-093
    8 do 9 j=1,8                                                        rotp-094
    9 b(j,i)=1.d0                                                       rotp-095
   10 b(9,i)=b(5,i)                                                     rotp-096
   11 b(10,i)=b(6,i)                                                    rotp-097
      iv(1)=1                                                           rotp-098
c set up of form factor computation                                     rotp-099
      ids=1                                                             rotp-100
      idr=1                                                             rotp-101
      if (lo(17).or.lo(99)) ids=0                                       rotp-102
      if (lo(209)) idr=0                                                rotp-103
      idt=idr+ids                                                       rotp-104
      do 12 i=1,8                                                       rotp-105
      idz=idg                                                           rotp-106
      if (lq(i,5)) idz=0                                                rotp-107
      iz(i,2)=idz+1                                                     rotp-108
      if (lq(i,3)) go to 12                                             rotp-109
      ep(i)=dexp(h/val(3*i))                                            rotp-110
      if ((i.eq.3).or.(i.eq.4)) idz=idz+idr                             rotp-111
      if ((i.eq.5).or.(i.eq.6).or.(i.eq.8)) idz=idz+ids                 rotp-112
      if (lo(209)) idz=max0(idz,2)                                      rotp-113
   12 iz(i,1)=idz                                                       rotp-114
c lq(i,1) is .true. if the form factor is not used                      rotp-115
c lq(i,2) is .true. for coulomb form factor with diffuseness            rotp-116
c lq(i,3) is .false. for any woods-saxon form factors                   rotp-117
c lq(i,4) is .false. for symmetrised woods-saxon form factors           rotp-118
c lq(i,5) is .false. for deformed form factors                          rotp-119
      call rotd(nbta,bta,ivy,iv,pp,p,q,val,id1,invz,imax,iq1,iqm,iny,idtrotp-120
     1,lq,dd,pgn,xgn,lo)                                                rotp-121
      zz(1)=ccz*val(19)                                                 rotp-122
      zz(2)=ccz*val(22)                                                 rotp-123
      if (dd(1).ne.0.d0) zz(1)=zz(1)/dd(1)                              rotp-124
      if (dd(2).ne.0.d0) zz(2)=zz(2)/dd(2)                              rotp-125
      do 13 i=1,60                                                      rotp-126
   13 vr(i,1)=0.d0                                                      rotp-127
      r=0.d0                                                            rotp-128
      do 61 is=1,ism                                                    rotp-129
      r=r+h                                                             rotp-130
      do 15 i=1,iq1                                                     rotp-131
      do 14 j=17,27                                                     rotp-132
   14 p(j,i)=0.d0                                                       rotp-133
   15 continue                                                          rotp-134
c integration loop                                                      rotp-135
      do 52 j=1,idt                                                     rotp-136
      do 35 i=1,8                                                       rotp-137
      if (lq(i,3)) go to 35                                             rotp-138
      if (p(i,j).ne.0.d0) go to 16                                      rotp-139
      q(i,j,1)=q(i,j,1)+h                                               rotp-140
      if (q(i,j,1)+50.d0*val(3*i).gt.0.d0) p(i,j)=dexp(q(i,j,1)/val(3*i)rotp-141
     1)                                                                 rotp-142
      go to 17                                                          rotp-143
   16 if (p(i,j).lt.1.d15) p(i,j)=p(i,j)*ep(i)                          rotp-144
   17 if ((.not.lq(i,4)).and.p(i+8,j).gt.1.d-15) p(i+8,j)=p(i+8,j)/ep(i)rotp-145
      idv=iz(i,1)                                                       rotp-146
      vr(1,i)=val(3*i-2)/(1.d0+p(i,j))                                  rotp-147
      if (idv.le.0) go to 18                                            rotp-148
      ar=1.d0/(val(3*i)*(1.d0+p(i,j)))                                  rotp-149
      vr(2,i)=vr(1,i)*ar*p(i,j)                                         rotp-150
      if (idv.gt.1) vr(3,i)=vr(2,i)*ar*(p(i,j)-1.d0)                    rotp-151
      if (idv.gt.2) vr(4,i)=vr(2,i)*(p(i,j)**2-4.d0*p(i,j)+1.d0)*ar*ar  rotp-152
      if (idv.gt.3) vr(5,i)=vr(3,i)*(p(i,j)**2-10.d0*p(i,j)+1.d0)*ar*ar rotp-153
   18 if (lq(i,4)) go to 28                                             rotp-154
      vs(10)=1.d0/(1.d0+p(i+8,j))                                       rotp-155
      if (idv.le.0) go to 19                                            rotp-156
      ar=vs(10)/val(3*i)                                                rotp-157
      vs(11)=vs(10)*ar*p(i+8,j)                                         rotp-158
      if (idv.gt.1) vs(12)=vs(11)*ar*(p(i+8,j)-1.d0)                    rotp-159
      if (idv.gt.2) vs(13)=vs(11)*(p(i+8,j)**2-4.d0*p(i+8,j)+1.d0)*ar*arrotp-160
      if (idv.gt.3) vs(14)=vs(12)*(p(i+8,j)**2-10.d0*p(i+8,j)+1.d0)*ar*arotp-161
     1r                                                                 rotp-162
      if (idv.gt.3) vs(5)=vr(1,i)*vs(14)+4.d0*vr(2,i)*vs(13)+6.d0*vr(3,irotp-163
     1)*vs(12)+4.d0*vr(4,i)*vs(11)+vr(5,i)*vs(10)                       rotp-164
      if (idv.gt.2) vs(4)=vr(1,i)*vs(13)+3.d0*vr(2,i)*vs(12)+3.d0*vr(3,irotp-165
     1)*vs(11)+vr(4,i)*vs(10)                                           rotp-166
      if (idv.gt.1) vs(3)=vr(1,i)*vs(12)+2.d0*vr(2,i)*vs(11)+vr(3,i)*vs(rotp-167
     110)                                                               rotp-168
      if (idv.gt.0) vs(2)=vr(1,i)*vs(11)+vr(2,i)*vs(10)                 rotp-169
   19 vs(1)=vr(1,i)*vs(10)                                              rotp-170
      if ((i.lt.3).or.(i.ge.7).or.(idt.eq.0)) go to 25                  rotp-171
      if (idv.gt.3) vs(9)=vr(1,i)*vs(14)+2.d0*vr(2,i)*vs(13)-2.d0*vr(4,irotp-172
     1)*vs(11)-vr(5,i)*vs(10)                                           rotp-173
      if (idv.gt.2) vs(8)=vr(1,i)*vs(13)+vr(2,i)*vs(12)-vr(3,i)*vs(11)-vrotp-174
     1r(4,i)*vs(10)                                                     rotp-175
      if (idv.gt.1) vs(7)=vr(1,i)*vs(12)-vr(3,i)*vs(10)                 rotp-176
      vs(6)=vr(1,i)*vs(11)-vr(2,i)*vs(10)                               rotp-177
      if (i.gt.4) go to 21                                              rotp-178
      if (idr.eq.0) go to 25                                            rotp-179
      ar=4.d0*r*val(3*i)/val(3*i-1)                                     rotp-180
      do 20 k=1,idv                                                     rotp-181
   20 vr(k,i)=ar*vs(k+5)                                                rotp-182
      go to 35                                                          rotp-183
   21 if (ids.eq.0) go to 25                                            rotp-184
      if (lo(100)) go to 23                                             rotp-185
      do 22 k=1,idv                                                     rotp-186
      vr(k,i+4)=vs(k)/r**2                                              rotp-187
   22 vr(k,i)=-vs(k+5)/r                                                rotp-188
      go to 35                                                          rotp-189
   23 do 24 k=1,idv                                                     rotp-190
   24 vr(k,i+4)=-vs(k+5)                                                rotp-191
   25 if (.not.lo(209)) go to 26                                        rotp-192
      vr(6,i)=vr(3,i)*vs(10)-2.d0*vr(2,i)*vs(11)+vr(1,i)*vs(12)         rotp-193
      vr(5,i)=vr(2,i)*vs(10)-vr(1,i)*vs(11)                             rotp-194
   26 idz=iz(i,2)                                                       rotp-195
      do 27 k=1,idz                                                     rotp-196
   27 vr(k,i)=vs(k)                                                     rotp-197
      go to 35                                                          rotp-198
   28 if ((i.lt.3).or.(i.ge.7).or.(idt.eq.0)) go to 34                  rotp-199
      if (i.gt.4) go to 30                                              rotp-200
      if (idr.eq.0) go to 34                                            rotp-201
      do 29 k=1,idv                                                     rotp-202
   29 vr(k,i)=4.d0*vr(k+1,i)*val(3*i)                                   rotp-203
      go to 34                                                          rotp-204
   30 if (ids.eq.0) go to 34                                            rotp-205
      if (lo(100)) go to 32                                             rotp-206
      do 31 k=1,idv                                                     rotp-207
      vr(k,i+4)=vr(k,i)/r**2                                            rotp-208
   31 vr(k,i)=vr(k+1,i)/r                                               rotp-209
      go to 34                                                          rotp-210
   32 do 33 k=1,idv                                                     rotp-211
   33 vr(k,i+4)=vr(k+1,i)                                               rotp-212
   34 if (.not.lo(209)) go to 35                                        rotp-213
      vr(5,i)=vr(2,i)                                                   rotp-214
      vr(6,i)=vr(3,i)                                                   rotp-215
   35 continue                                                          rotp-216
      if (lo(199)) go to 36                                             rotp-217
      call rotz(vr,xgn,r,q,val,j,iv,b,p,id1,iq1,ccz,lo)                 rotp-218
      go to 52                                                          rotp-219
   36 do 38 l=1,iq1                                                     rotp-220
      k=iv(l)                                                           rotp-221
      do 37 m=1,10                                                      rotp-222
   37 p(m+16,l)=p(m+16,l)+vr(k,m)*p(l+27,j)*b(m,l)                      rotp-223
   38 continue                                                          rotp-224
      if (lq(1,2)) go to 52                                             rotp-225
c deformed coulomb potential                                            rotp-226
      do 51 i=7,8                                                       rotp-227
      if (lq(i,2)) go to 51                                             rotp-228
      c=p(i,j)/r                                                        rotp-229
      if (i.eq.8.and.lo(117).and.lo(200)) go to 40                      rotp-230
      if (r.lt.p(i,j)) go to 39                                         rotp-231
      p(i+16,1)=p(i+16,1)+zz(i-6)*(p(i,j)**2)*c*p(28,j)                 rotp-232
      if (lo(200)) go to 41                                             rotp-233
      p(i+16,2)=p(i+16,2)+zz(i-6)*p(i,j)*c**2*p(28,j)                   rotp-234
      p(i+16,3)=p(i+16,3)+zz(i-6)*2.d0*c**3*p(28,j)                     rotp-235
      go to 41                                                          rotp-236
   39 p(i+16,1)=p(i+16,1)+(0.5d0*p(i,j)*p(i,j)-r*r/6.d0)*zz(i-6)*p(28,j)rotp-237
     1*3.d0                                                             rotp-238
      if (lo(200)) go to 41                                             rotp-239
      p(i+16,2)=p(i+16,2)+r*zz(i-6)*p(28,j)                             rotp-240
      p(i+16,3)=p(i+16,3)-zz(i-6)*p(28,j)                               rotp-241
      go to 41                                                          rotp-242
   40 c1=zz(i-6)*p(28,j)                                                rotp-243
      if (r.gt.p(i,j)) c1=c1*c**3                                       rotp-244
      p(24,1)=p(24,1)+c1                                                rotp-245
   41 if (invz.eq.0) go to 51                                           rotp-246
      if (lo(8*i+55)) go to 51                                          rotp-247
      do 50 k=inx,iq1                                                   rotp-248
      l=ivy(7,k-iny)+1                                                  rotp-249
      if ((ivy(i-3,k-iny).eq.0).or.(l.eq.1)) go to 50                   rotp-250
      d=l                                                               rotp-251
      n=iv(k)                                                           rotp-252
      if (r.lt.p(i,j)) go to 42                                         rotp-253
      c1=(p(i,j)**2)*(c**l)*3.d0/((d+2.d0)*(2.d0*d-1.d0))               rotp-254
      if (n.gt.1) c1=c1*(d+2.d0)/p(i,j)                                 rotp-255
      if (n.gt.2) c1=c1*(d+1.d0)/p(i,j)                                 rotp-256
      if (n.gt.3) c1=c1*d/p(i,j)                                        rotp-257
      go to 44                                                          rotp-258
   42 if (l.ne.3) go to 43                                              rotp-259
      if (n.eq.1) c1=r*r*(0.2d0+dlog(c))*0.6d0                          rotp-260
      if (n.ge.2) c1=0.6d0*r/c                                          rotp-261
      if (n.ge.3) c1=-c1/p(i,j)                                         rotp-262
      if (n.ge.4) c1=-2.d0*c1/p(i,j)                                    rotp-263
      go to 44                                                          rotp-264
   43 if (n.eq.1) c1=r*r*(1.d0/(d+2.d0)-1.d0/(c**(l-3)*(2.d0*d-1.d0)))*3rotp-265
     1.d0/(d-3.d0)                                                      rotp-266
      if (n.ge.2) c1=r/c**(l-2)*3.d0/(2.d0*d-1.d0)                      rotp-267
      if (n.ge.3) c1=-c1*(d-2.d0)/p(i,j)                                rotp-268
      if (n.eq.4) c1=-c1*(d-1.d0)/p(i,j)                                rotp-269
   44 if (i.eq.7.or.lo(17)) go to 49                                    rotp-270
      if (r.lt.p(i,j)) go to 45                                         rotp-271
      c2=-d*c1/r                                                        rotp-272
      go to 47                                                          rotp-273
   45 if (l.ne.3) go to 46                                              rotp-274
      if (n.eq.1) c2=-1.2d0*(0.3d0*r-dlog(c))*r                         rotp-275
      if (n.ge.2) c2=2.d0*c1/r                                          rotp-276
      go to 47                                                          rotp-277
   46 if (n.eq.1) c2=(2.d0/(d+2.d0)-(d-1.d0)/(c**(l-3)*(2.d0*d-1.d0)))*3rotp-278
     1.d0/(d-3.d0)*r                                                    rotp-279
      if (n.ne.1)  c2=(d-1.d0)*c1/r                                     rotp-280
   47 if (lo(100)) go to 48                                             rotp-281
      p(27,k)=p(27,k)-zz(2)*c1*p(k+27,j)*b(i,k)/r**2                    rotp-282
      p(24,k)=p(24,k)-zz(2)*c2*p(k+27,j)*b(i,k)/r                       rotp-283
      go to 50                                                          rotp-284
   48 p(27,k)=p(27,k)-zz(2)*c2*p(k+27,j)*b(i,k)                         rotp-285
      p(24,k)=p(24,k)+zz(2)*c1*p(k+27,j)*b(i,k)                         rotp-286
      go to 50                                                          rotp-287
   49 p(i+16,k)=p(i+16,k)+zz(i-6)*c1*p(k+27,j)*b(i,k)                   rotp-288
   50 continue                                                          rotp-289
   51 continue                                                          rotp-290
   52 continue                                                          rotp-291
c storage of form factors                                               rotp-292
      if (lo(100)) go to 56                                             rotp-293
      v(is,ip+it1)=p(17,1)                                              rotp-294
      v(is,ip+it2)=p(18,1)                                              rotp-295
      v(is,ip+it3)=p(19,1)                                              rotp-296
      v(is,ip+it4)=p(20,1)                                              rotp-297
      if (.not.lo(201)) v(is,ip+it5)=p(21,1)                            rotp-298
      if (.not.lo(202)) v(is,ip+it6)=p(22,1)                            rotp-299
      v(is,ip+it7)=p(23,1)                                              rotp-300
      if (.not.lo(203)) v(is,ip+it8)=p(24,1)                            rotp-301
      if (invz.le.0) go to 61                                           rotp-302
      do 55 j=1,invz                                                    rotp-303
      k=j+iny                                                           rotp-304
      v(is,j+it9)=p(17,k)                                               rotp-305
      v(is,j+ita)=p(19,k)                                               rotp-306
      if (lo(112)) go to 53                                             rotp-307
      v(is,j+it0)=p(18,k)                                               rotp-308
      v(is,j+itb)=p(20,k)                                               rotp-309
   53 ij=ivy(4,j)                                                       rotp-310
      if (ij.ne.0) v(is,ij+ite)=p(23,k)                                 rotp-311
      ij=ivy(3,j)                                                       rotp-312
      if (ij.eq.0) go to 54                                             rotp-313
      v(is,ij+itc)=p(21,k)                                              rotp-314
      v(is,ij+itc+inls)=-p(25,k)                                        rotp-315
      if (lo(114)) go to 54                                             rotp-316
      v(is,ij+itd)=p(22,k)                                              rotp-317
      v(is,ij+itd+inls)=-p(26,k)                                        rotp-318
   54 ij=ivy(5,j)                                                       rotp-319
      if (ij.eq.0) go to 55                                             rotp-320
      v(is,ij+itf)=p(24,k)                                              rotp-321
      v(is,ij+itf+invd)=p(27,k)                                         rotp-322
   55 continue                                                          rotp-323
      go to 61                                                          rotp-324
   56 k=ip                                                              rotp-325
      do 58 i=1,3                                                       rotp-326
      do 57 j=17,24                                                     rotp-327
      v(is,k)=p(j,i)                                                    rotp-328
   57 k=k+1                                                             rotp-329
   58 continue                                                          rotp-330
      if (invz.eq.0) go to 61                                           rotp-331
      do 60 k=1,invz                                                    rotp-332
      do 59 j=1,11                                                      rotp-333
   59 va(is,j,k)=p(j+16,k+3)                                            rotp-334
   60 continue                                                          rotp-335
   61 continue                                                          rotp-336
c coulomb potentials with diffuse charge distribution                   rotp-337
      if (lq(7,3).and.lq(8,3)) return                                   rotp-338
      do 67 i=7,8                                                       rotp-339
      if (lq(i,3)) go to 67                                             rotp-340
      i1=ip+itx(i)                                                      rotp-341
      if (i.eq.8.and.lo(117).and.lo(200)) go to 62                      rotp-342
      if (lo(100)) i1=ip+i-1                                            rotp-343
      call copo(v(1,i1),v(1,i1),p,ism,h,0,val(3*i-2),val(25),ccz,zt,.falrotp-344
     1se.,.false.)                                                      rotp-345
      if (lo(200)) go to 63                                             rotp-346
      call deri(v(1,i1+8),v(1,i1),h,ism,.true.)                         rotp-347
      call deri(v(1,i1+16),v(1,i1+8),h,ism,.true.)                      rotp-348
      go to 63                                                          rotp-349
   62 call copo(p,v(1,i1),p,ism,h,0,val(3*i-2),val(25),ccz,zt,.false.,.frotp-350
     1alse.)                                                            rotp-351
      call deri(v(1,i1),p,h,ism,.false.)                                rotp-352
   63 if (invz.eq.0.or.lo(8*i+55)) go to 67                             rotp-353
      do 66 j=1,invz                                                    rotp-354
      n=ivy(i-3,j)                                                      rotp-355
      l=ivy(7,j)                                                        rotp-356
      if ((n.eq.0).or.(l.eq.0)) go to 66                                rotp-357
      i1=n+itx(i+8)                                                     rotp-358
      if (lo(100)) i1=it5+11*j+i                                        rotp-359
      i2=i1                                                             rotp-360
      if (lo(200).and.(i.eq.8).and.lo(117)) i2=i2+invd                  rotp-361
      call copo(v(1,i2),v(1,i1),p,ism,h,l,val(3*i-2),val(25),ccz,zt,.falrotp-362
     1se.,.true.)                                                       rotp-363
      if ((i.eq.7).or.lo(17)) go to 66                                  rotp-364
      if (lo(200)) go to 64                                             rotp-365
      call deri(v(1,i1+3),v(1,i1),h,ism,.true.)                         rotp-366
      go to 66                                                          rotp-367
   64 call deri(v(1,i1),v(1,i2),h,ism,.false.)                          rotp-368
      rr=0.d0                                                           rotp-369
      do 65 is=1,ism                                                    rotp-370
      rr=rr+h                                                           rotp-371
   65 v(is,i2)=-v(is,i2)/rr**2                                          rotp-372
   66 continue                                                          rotp-373
   67 continue                                                          rotp-374
      return                                                            rotp-375
 1000 format (' too small diffuseness =',d15.6,' for the potential',2i4,rotp-376
     1'   changed into its minimum value')                              rotp-377
 1001 format (' too small coulomb radius =',d15.6,' for the potential',2rotp-378
     1i4,'   changed into its minimum value')                           rotp-379
      end                                                               rotp-380
c 29/02/04                                                      ecis03  rotd-000
      subroutine rotd(nbta,bta,ivy,iv,pp,p,q,val,id1,invz,imax,iq1,iqm,irotd-001
     1ny,idt,lq,dd,pgn,xgn,lo)                                          rotd-002
c       symmetric rotational model                                      rotd-003
c a 20-points gauss-legendre integration method is used, reduced to 10  rotd-004
c values by symmetry                                                    rotd-005
c                                                                       rotd-006
c       asymmetric rotational model                                     rotd-007
c 36 values of (theta,phi) have been chosen. the values of theta are    rotd-008
c n*pi/14. and for each value of "n" there are n+1 values of phi equi-  rotd-009
c distant between 0. and pi/2.   the matrix,the elements of which are   rotd-010
c the rotation matrix elements for these angles and l given in nl,k in  rotd-011
c nk has been inverted . the coefficients of the 15 lowest (l,k) are    rotd-012
c stored in poids . the 15 reduced rotation matrix elements for the 8   rotd-013
c values of theta are in rb .                                           rotd-014
c                                                                       rotd-015
c       vibrational model                                               rotd-016
c the angular integration is reduced to one point.                      rotd-017
c input variables:  nbta:   informations on vibrations                  rotd-018
c                   bta:    static deformations                         rotd-019
c                   ivy:    informations on form factors                rotd-020
c                   iv:     order of derivative of each form factor     rotd-021
c                   val:    optical parameters                          rotd-022
c                   id1,invz,iq1,iqm,iny,lq:   see rotp                 rotd-023
c                   imax:   maximum angular momentum                    rotd-024
c                   pgn,xgn: weight and abscissae of legendre integral  rotd-025
c                   lo:     logical controls                            rotd-026
c output variables: p(i+27,j):  weight at point j of form factor i      rotd-027
c                   q:      radii in fermis. in rotational model, q(,,2)rotd-028
c                           is first derivative/sin(theta) and q(,,3)   rotd-029
c                           2nd derivative + 1st derivative/tg(theta),  rotd-030
c                           used for schroe. equiv. of dirac equation.  rotd-031
c                   idt:    number of integration points                rotd-032
c                   dd:     charge integrals                            rotd-033
c working space:    pp:     for legendre polynomials                    rotd-034
c***********************************************************************rotd-035
      implicit real*8 (a-h,o-z)                                         rotd-036
      logical lo(250),lq(8,5)                                           rotd-037
      dimension nl(36),nk(36),ivy(7,1),iv(1),p(id1,1),pp(2),pgn(10),xgn(rotd-038
     110),dd(2),q(8,12,3),nbta(18,1),ff(660),poids(36,15),rb(15,8),bta(9rotd-039
     2,1),val(24)                                                       rotd-040
      equivalence (poids(1,1),ff(1)),(rb(1,1),ff(541))                  rotd-041
      data ff(  1),ff(  2) / 5.12820512820513d-03, 2.43496936475441d-02/rotd-042
      data ff(  3),ff(  4) / 2.43496936475441d-02, 2.12528237972895d-02/rotd-043
      data ff(  5),ff(  6) / 5.53147440814732d-02, 2.12528237972895d-02/rotd-044
      data ff(  7),ff(  8) / 2.53452023906582d-02, 4.44873368571440d-02/rotd-045
      data ff(  9),ff( 10) / 4.44873368571440d-02, 2.53452023906582d-02/rotd-046
      data ff( 11),ff( 12) / 1.86559801758989d-02, 4.85184708058446d-02/rotd-047
      data ff( 13),ff( 14) / 4.12568870375796d-02, 4.85184708058446d-02/rotd-048
      data ff( 15),ff( 16) / 1.86559801758989d-02, 2.45925296747690d-02/rotd-049
      data ff( 17),ff( 18) / 3.46398560932081d-02, 4.17933479732147d-02/rotd-050
      data ff( 19),ff( 20) / 4.17933479732147d-02, 3.46398560932081d-02/rotd-051
      data ff( 21),ff( 22) / 2.45925296747690d-02, 1.19673178236678d-02/rotd-052
      data ff( 23),ff( 24) / 4.47278246564596d-02, 3.42917677140348d-02/rotd-053
      data ff( 25),ff( 26) / 3.69076912422490d-02, 3.42917677140348d-02/rotd-054
      data ff( 27),ff( 28) / 4.47278246564596d-02, 1.19673178236678d-02/rotd-055
      data ff( 29),ff( 30) / 1.22068028124735d-02, 1.07129429826274d-02/rotd-056
      data ff( 31),ff( 32) / 1.70796570854178d-02, 1.60746817649944d-02/rotd-057
      data ff( 33),ff( 34) / 1.60746817649944d-02, 1.70796570854178d-02/rotd-058
      data ff( 35),ff( 36) / 1.07129429826274d-02, 1.22068028124735d-02/rotd-059
      data ff( 37),ff( 38) / 1.16509780810355d-02, 5.02196040257258d-02/rotd-060
      data ff( 39),ff( 40) / 5.02196040257258d-02, 3.27291637647035d-02/rotd-061
      data ff( 41),ff( 42) / 9.18762267773519d-02, 3.27291637647035d-02/rotd-062
      data ff( 43),ff( 44) / 2.59023523875124d-02, 3.90112947467209d-02/rotd-063
      data ff( 45),ff( 46) / 3.90112947467209d-02, 2.59023523875124d-02/rotd-064
      data ff( 47),ff( 48) /-1.94110577743667d-03, 1.63152196117813d-02/rotd-065
      data ff( 49),ff( 50) / 4.25393417813309d-03, 1.63152196117813d-02/rotd-066
      data ff( 51),ff( 52) /-1.94110577743667d-03,-2.10440960549142d-03/rotd-067
      data ff( 53),ff( 54) /-2.95605747812527d-02,-1.76788269194279d-02/rotd-068
      data ff( 55),ff( 56) /-1.76788269194279d-02,-2.95605747812527d-02/rotd-069
      data ff( 57),ff( 58) /-2.10440960549142d-03,-2.76725877126884d-02/rotd-070
      data ff( 59),ff( 60) /-2.18051394343160d-02,-3.71237658735663d-02/rotd-071
      data ff( 61),ff( 62) /-3.47941600457989d-02,-3.71237658735663d-02/rotd-072
      data ff( 63),ff( 64) /-2.18051394343160d-02,-2.76725877126884d-02/rotd-073
      data ff( 65),ff( 66) /-2.37727476826438d-03,-2.57698170677382d-02/rotd-074
      data ff( 67),ff( 68) /-1.69793430277171d-02,-1.76582790639056d-02/rotd-075
      data ff( 69),ff( 70) /-1.76582790639056d-02,-1.69793430277171d-02/rotd-076
      data ff( 71),ff( 72) /-2.57698170677382d-02,-2.37727476826438d-03/rotd-077
      data ff( 73),ff( 74) /               0.d+00, 1.72605997389226d-03/rotd-078
      data ff( 75),ff( 76) /-1.72605997389226d-03, 1.25329145074895d-02/rotd-079
      data ff( 77),ff( 78) /               0.d+00,-1.25329145074895d-02/rotd-080
      data ff( 79),ff( 80) / 2.24225003695212d-02, 2.96494182999275d-02/rotd-081
      data ff( 81),ff( 82) /-2.96494182999275d-02,-2.24225003695212d-02/rotd-082
      data ff( 83),ff( 84) / 3.91319410166702d-02, 4.84852241623139d-02/rotd-083
      data ff( 85),ff( 86) /               0.d+00,-4.84852241623139d-02/rotd-084
      data ff( 87),ff( 88) /-3.91319410166702d-02, 3.97624306723559d-02/rotd-085
      data ff( 89),ff( 90) / 8.10325074410309d-02, 2.28106411006477d-02/rotd-086
      data ff( 91),ff( 92) /-2.28106411006477d-02,-8.10325074410309d-02/rotd-087
      data ff( 93),ff( 94) /-3.97624306723559d-02, 5.59851854712431d-02/rotd-088
      data ff( 95),ff( 96) / 6.92750919115029d-02, 5.27666983806334d-02/rotd-089
      data ff( 97),ff( 98) /               0.d+00,-5.27666983806334d-02/rotd-090
      data ff( 99),ff(100) /-6.92750919115029d-02,-5.59851854712431d-02/rotd-091
      data ff(101),ff(102) / 1.57386702462217d-02, 4.84030198418523d-02/rotd-092
      data ff(103),ff(104) / 2.47182393346187d-02, 9.25890190803834d-03/rotd-093
      data ff(105),ff(106) /-9.25890190803834d-03,-2.47182393346187d-02/rotd-094
      data ff(107),ff(108) /-4.84030198418523d-02,-1.57386702462217d-02/rotd-095
      data ff(109),ff(110) / 1.62578391680559d-02, 5.49097361991748d-02/rotd-096
      data ff(111),ff(112) / 5.49097361991748d-02, 8.83119316755724d-03/rotd-097
      data ff(113),ff(114) / 4.65475180836232d-02, 8.83119316755724d-03/rotd-098
      data ff(115),ff(116) /-1.52665570705068d-02,-4.45213321560779d-02/rotd-099
      data ff(117),ff(118) /-4.45213321560779d-02,-1.52665570705068d-02/rotd-100
      data ff(119),ff(120) /-3.25206220517009d-02,-5.00345998670453d-02/rotd-101
      data ff(121),ff(122) /-5.61452437357254d-02,-5.00345998670453d-02/rotd-102
      data ff(123),ff(124) /-3.25206220517009d-02,-5.34880433627418d-03/rotd-103
      data ff(125),ff(126) /-2.71365320807763d-02,-2.11168478505607d-02/rotd-104
      data ff(127),ff(128) /-2.11168478505607d-02,-2.71365320807763d-02/rotd-105
      data ff(129),ff(130) /-5.34880433627418d-03, 5.38896697941338d-03/rotd-106
      data ff(131),ff(132) / 2.71262358172909d-02, 2.30796535753636d-02/rotd-107
      data ff(133),ff(134) / 2.05455707964392d-02, 2.30796535753636d-02/rotd-108
      data ff(135),ff(136) / 2.71262358172909d-02, 5.38896697941338d-03/rotd-109
      data ff(137),ff(138) / 1.18873085059175d-02, 1.57695500564231d-02/rotd-110
      data ff(139),ff(140) / 1.69343260833909d-02, 1.84154828722142d-02/rotd-111
      data ff(141),ff(142) / 1.84154828722142d-02, 1.69343260833909d-02/rotd-112
      data ff(143),ff(144) / 1.57695500564231d-02, 1.18873085059175d-02/rotd-113
      data ff(145),ff(146) /               0.d+00, 8.48270535877333d-03/rotd-114
      data ff(147),ff(148) /-8.48270535877333d-03, 5.07879724674491d-02/rotd-115
      data ff(149),ff(150) /               0.d+00,-5.07879724674491d-02/rotd-116
      data ff(151),ff(152) / 6.07576950711252d-02, 9.00787083612551d-02/rotd-117
      data ff(153),ff(154) /-9.00787083612551d-02,-6.07576950711252d-02/rotd-118
      data ff(155),ff(156) / 6.45377024914683d-02, 6.34461864848980d-02/rotd-119
      data ff(157),ff(158) /               0.d+00,-6.34461864848980d-02/rotd-120
      data ff(159),ff(160) /-6.45377024914683d-02,-5.65537884945032d-03/rotd-121
      data ff(161),ff(162) / 4.77376504465041d-02,-6.49930325424402d-03/rotd-122
      data ff(163),ff(164) / 6.49930325424402d-03,-4.77376504465041d-02/rotd-123
      data ff(165),ff(166) / 5.65537884945032d-03, 1.24655233750459d-03/rotd-124
      data ff(167),ff(168) /-8.76714858478633d-02,-1.18181266709155d-02/rotd-125
      data ff(169),ff(170) /               0.d+00, 1.18181266709155d-02/rotd-126
      data ff(171),ff(172) / 8.76714858478633d-02,-1.24655233750459d-03/rotd-127
      data ff(173),ff(174) /-3.84487336410874d-02,-7.62058619698479d-03/rotd-128
      data ff(175),ff(176) /-3.01133238640137d-02,-1.08854252444356d-02/rotd-129
      data ff(177),ff(178) / 1.08854252444356d-02, 3.01133238640137d-02/rotd-130
      data ff(179),ff(180) / 7.62058619698479d-03, 3.84487336410874d-02/rotd-131
      data ff(181),ff(182),ff(183),ff(184)/3*0.d0, 1.36660942007569d-03/rotd-132
      data ff(185),ff(186) /-2.73321884015139d-03, 1.36660942007569d-03/rotd-133
      data ff(187),ff(188) / 1.10470452782256d-02,-1.10470452782256d-02/rotd-134
      data ff(189),ff(190) /-1.10470452782256d-02, 1.10470452782256d-02/rotd-135
      data ff(191),ff(192) / 2.19899348965421d-02, 7.44598962747265d-03/rotd-136
      data ff(193),ff(194) /-5.88718490480295d-02, 7.44598962747265d-03/rotd-137
      data ff(195),ff(196) / 2.19899348965421d-02, 4.68819219798074d-02/rotd-138
      data ff(197),ff(198) / 1.75997201070024d-02,-6.44816420868098d-02/rotd-139
      data ff(199),ff(200) /-6.44816420868098d-02, 1.75997201070024d-02/rotd-140
      data ff(201),ff(202) / 4.68819219798074d-02, 3.99738678988680d-02/rotd-141
      data ff(203),ff(204) / 7.12682217154704d-02,-6.36366236436914d-02/rotd-142
      data ff(205),ff(206) /-9.52109319412941d-02,-6.36366236436914d-02/rotd-143
      data ff(207),ff(208) / 7.12682217154704d-02, 3.99738678988680d-02/rotd-144
      data ff(209),ff(210) / 3.48854645305456d-02, 1.59406059510446d-02/rotd-145
      data ff(211),ff(212) /-3.85251092517111d-03,-4.69735595564191d-02/rotd-146
      data ff(213),ff(214) /-4.69735595564191d-02,-3.85251092517111d-03/rotd-147
      data ff(215),ff(216) / 1.59406059510446d-02, 3.48854645305456d-02/rotd-148
      data ff(217),ff(218) / 2.09351688388115d-02, 4.48693101517502d-02/rotd-149
      data ff(219),ff(220) / 4.48693101517502d-02,-2.58717911400513d-02/rotd-150
      data ff(221),ff(222) /-2.81401919724747d-02,-2.58717911400513d-02/rotd-151
      data ff(223),ff(224) /-2.67091832939234d-02,-6.48487928844068d-02/rotd-152
      data ff(225),ff(226) /-6.48487928844068d-02,-2.67091832939234d-02/rotd-153
      data ff(227),ff(228) / 7.16351218404911d-03, 1.79021864804572d-02/rotd-154
      data ff(229),ff(230) / 2.15963617795819d-02, 1.79021864804572d-02/rotd-155
      data ff(231),ff(232) / 7.16351218404911d-03, 2.39109798331374d-02/rotd-156
      data ff(233),ff(234) / 4.82363267486100d-02, 4.45971408837992d-02/rotd-157
      data ff(235),ff(236) / 4.45971408837992d-02, 4.82363267486100d-02/rotd-158
      data ff(237),ff(238) / 2.39109798331374d-02,-8.59824516528979d-04/rotd-159
      data ff(239),ff(240) /-8.77138104825350d-03,-1.02303358111611d-03/rotd-160
      data ff(241),ff(242) /-4.79305557318445d-03,-1.02303358111611d-03/rotd-161
      data ff(243),ff(244) /-8.77138104825350d-03,-8.59824516528979d-04/rotd-162
      data ff(245),ff(246) /-1.06844320272751d-02,-1.45408758222938d-02/rotd-163
      data ff(247),ff(248) /-1.99395576475419d-02,-1.82297258567795d-02/rotd-164
      data ff(249),ff(250) /-1.82297258567795d-02,-1.99395576475419d-02/rotd-165
      data ff(251),ff(252) /-1.45408758222938d-02,-1.06844320272751d-02/rotd-166
      data ff(253),ff(254) /               0.d+00, 2.01805115490348d-02/rotd-167
      data ff(255),ff(256) /-2.01805115490348d-02, 8.57318720924763d-02/rotd-168
      data ff(257),ff(258) /               0.d+00,-8.57318720924763d-02/rotd-169
      data ff(259),ff(260) / 3.23094559967599d-02, 8.19417704703203d-02/rotd-170
      data ff(261),ff(262) /-8.19417704703203d-02,-3.23094559967599d-02/rotd-171
      data ff(263),ff(264) /-1.46857629097277d-02,-6.79023750172081d-02/rotd-172
      data ff(265),ff(266) /               0.d+00, 6.79023750172081d-02/rotd-173
      data ff(267),ff(268) / 1.46857629097277d-02,-6.96933563711756d-02/rotd-174
      data ff(269),ff(270) /-4.17790846324735d-02,-3.84574445723291d-02/rotd-175
      data ff(271),ff(272) / 3.84574445723291d-02, 4.17790846324735d-02/rotd-176
      data ff(273),ff(274) / 6.96933563711756d-02, 3.99606295249026d-02/rotd-177
      data ff(275),ff(276) /-3.02669933372692d-02, 1.78196010140318d-02/rotd-178
      data ff(277),ff(278) /               0.d+00,-1.78196010140318d-02/rotd-179
      data ff(279),ff(280) / 3.02669933372692d-02,-3.99606295249026d-02/rotd-180
      data ff(281),ff(282) /-1.85102966735610d-03, 5.84883614463197d-02/rotd-181
      data ff(283),ff(284) / 2.06176299500674d-02, 5.03674288697549d-03/rotd-182
      data ff(285),ff(286) /-5.03674288697549d-03,-2.06176299500674d-02/rotd-183
      data ff(287),ff(288) /-5.84883614463197d-02, 1.85102966735610d-03/rotd-184
      data ff(289),ff(290),ff(291),ff(292)/3*0.d0, 8.75524578710006d-03/rotd-185
      data ff(293),ff(294) /-1.75104915742001d-02, 8.75524578710006d-03/rotd-186
      data ff(295),ff(296) / 5.09492763472956d-02,-5.09492763472956d-02/rotd-187
      data ff(297),ff(298) /-5.09492763472956d-02, 5.09492763472956d-02/rotd-188
      data ff(299),ff(300) / 5.07686792912787d-02, 3.43411087448840d-02/rotd-189
      data ff(301),ff(302) /-1.70219576072325d-01, 3.43411087448840d-02/rotd-190
      data ff(303),ff(304) / 5.07686792912787d-02, 5.95241999935498d-02/rotd-191
      data ff(305),ff(306) /-1.56733778150275d-02,-4.38508221785223d-02/rotd-192
      data ff(307),ff(308) /-4.38508221785223d-02,-1.56733778150275d-02/rotd-193
      data ff(309),ff(310) / 5.95241999935498d-02,-6.35546557275261d-02/rotd-194
      data ff(311),ff(312) / 5.26475282909628d-02,-1.74503883012358d-02/rotd-195
      data ff(313),ff(314) / 5.67150314755984d-02,-1.74503883012358d-02/rotd-196
      data ff(315),ff(316) / 5.26475282909628d-02,-6.35546557275261d-02/rotd-197
      data ff(317),ff(318) / 1.43084825509049d-02,-7.77375076960055d-02/rotd-198
      data ff(319),ff(320) / 2.99695551646778d-02, 3.34594699804229d-02/rotd-199
      data ff(321),ff(322) / 3.34594699804229d-02, 2.99695551646778d-02/rotd-200
      data ff(323),ff(324) /-7.77375076960055d-02, 1.43084825509049d-02/rotd-201
      data ff(325),ff(326),ff(327),ff(328),ff(329),ff(330) / 6*0.d+00 / rotd-202
      data ff(331),ff(332) / 2.45227713022227d-03,-4.90455426044453d-03/rotd-203
      data ff(333),ff(334) / 4.90455426044453d-03,-2.45227713022227d-03/rotd-204
      data ff(335),ff(336) / 1.70476858680581d-02,-2.41090685616840d-02/rotd-205
      data ff(337),ff(338) /               0.d+00, 2.41090685616840d-02/rotd-206
      data ff(339),ff(340) /-1.70476858680581d-02, 2.87679007598782d-02/rotd-207
      data ff(341),ff(342) /-6.25948031834043d-03,-7.67073502036074d-02/rotd-208
      data ff(343),ff(344) / 7.67073502036074d-02, 6.25948031834043d-03/rotd-209
      data ff(345),ff(346) /-2.87679007598782d-02, 6.77534129025308d-02/rotd-210
      data ff(347),ff(348) /-2.45662401760060d-02,-9.29568496692793d-02/rotd-211
      data ff(349),ff(350) /               0.d+00, 9.29568496692793d-02/rotd-212
      data ff(351),ff(352) / 2.45662401760060d-02,-6.77534129025308d-02/rotd-213
      data ff(353),ff(354) / 1.40653464342708d-02, 3.44626025062703d-02/rotd-214
      data ff(355),ff(356) /-6.14715612078917d-02,-3.05058349395271d-02/rotd-215
      data ff(357),ff(358) / 3.05058349395271d-02, 6.14715612078917d-02/rotd-216
      data ff(359),ff(360) /-3.44626025062703d-02,-1.40653464342708d-02/rotd-217
      data ff(361),ff(362) / 2.68196038675183d-02, 2.31031610463596d-02/rotd-218
      data ff(363),ff(364) / 2.31031610463596d-02,-4.28485793267828d-02/rotd-219
      data ff(365),ff(366) /-7.35437975772992d-02,-4.28485793267828d-02/rotd-220
      data ff(367),ff(368) / 8.24684503593131d-03, 1.06081754814925d-02/rotd-221
      data ff(369),ff(370) / 1.06081754814925d-02, 8.24684503593131d-03/rotd-222
      data ff(371),ff(372) / 2.51256208268608d-02, 4.43395667660788d-02/rotd-223
      data ff(373),ff(374) / 5.39942159127383d-02, 4.43395667660788d-02/rotd-224
      data ff(375),ff(376) / 2.51256208268608d-02,-2.19715194066651d-02/rotd-225
      data ff(377),ff(378) /-3.13725579969708d-02,-4.08834934180796d-02/rotd-226
      data ff(379),ff(380) /-4.08834934180796d-02,-3.13725579969708d-02/rotd-227
      data ff(381),ff(382) /-2.19715194066651d-02,-1.88427973024923d-03/rotd-228
      data ff(383),ff(384) /-2.16035578956301d-02,-1.17587068801884d-02/rotd-229
      data ff(385),ff(386) /-1.12062882635935d-02,-1.17587068801884d-02/rotd-230
      data ff(387),ff(388) /-2.16035578956301d-02,-1.88427973024923d-03/rotd-231
      data ff(389),ff(390) / 5.74971871310925d-03, 2.25181635560216d-02/rotd-232
      data ff(391),ff(392) / 1.76219271299887d-02, 1.69776491290416d-02/rotd-233
      data ff(393),ff(394) / 1.69776491290416d-02, 1.76219271299887d-02/rotd-234
      data ff(395),ff(396) / 2.25181635560216d-02, 5.74971871310925d-03/rotd-235
      data ff(397),ff(398) /               0.d+00, 3.55735538800802d-02/rotd-236
      data ff(399),ff(400) /-3.55735538800802d-02, 8.33786715099005d-02/rotd-237
      data ff(401),ff(402) /               0.d+00,-8.33786715099005d-02/rotd-238
      data ff(403),ff(404) /-4.89348970296868d-02,-2.91035565005004d-04/rotd-239
      data ff(405),ff(406) / 2.91035565005004d-04, 4.89348970296868d-02/rotd-240
      data ff(407),ff(408) /-2.62016346104983d-02,-8.33457375352782d-02/rotd-241
      data ff(409),ff(410) /               0.d+00, 8.33457375352782d-02/rotd-242
      data ff(411),ff(412) / 2.62016346104983d-02, 2.62738780028789d-02/rotd-243
      data ff(413),ff(414) / 8.32340348860637d-02, 3.18724837249571d-02/rotd-244
      data ff(415),ff(416) /-3.18724837249571d-02,-8.32340348860637d-02/rotd-245
      data ff(417),ff(418) /-2.62738780028789d-02, 2.62547109771934d-02/rotd-246
      data ff(419),ff(420) / 7.98302855528211d-03, 4.48364778698653d-03/rotd-247
      data ff(421),ff(422) /               0.d+00,-4.48364778698653d-03/rotd-248
      data ff(423),ff(424) /-7.98302855528211d-03,-2.62547109771934d-02/rotd-249
      data ff(425),ff(426) /-2.51077741509568d-02,-2.87429639697600d-02/rotd-250
      data ff(427),ff(428) /-1.79981066009081d-02,-7.87642513464656d-03/rotd-251
      data ff(429),ff(430) / 7.87642513464656d-03, 1.79981066009081d-02/rotd-252
      data ff(431),ff(432) / 2.87429639697600d-02, 2.51077741509568d-02/rotd-253
      data ff(433),ff(434),ff(435),ff(436)/3*0.d0, 2.38959949710526d-02/rotd-254
      data ff(437),ff(438) /-4.77919899421051d-02, 2.38959949710526d-02/rotd-255
      data ff(439),ff(440) / 7.91176151667601d-02,-7.91176151667601d-02/rotd-256
      data ff(441),ff(442) /-7.91176151667601d-02, 7.91176151667601d-02/rotd-257
      data ff(443),ff(444) /-1.24626161171327d-02, 5.33272858981795d-02/rotd-258
      data ff(445),ff(446) /-8.17293395620937d-02, 5.33272858981795d-02/rotd-259
      data ff(447),ff(448) /-1.24626161171327d-02,-1.44916866191644d-02/rotd-260
      data ff(449),ff(450) /-9.04220344262881d-02, 1.04913721045452d-01/rotd-261
      data ff(451),ff(452) / 1.04913721045452d-01,-9.04220344262881d-02/rotd-262
      data ff(453),ff(454) /-1.44916866191644d-02,-5.73533998264151d-02/rotd-263
      data ff(455),ff(456) / 7.23959359228724d-02,-1.77393445770836d-02/rotd-264
      data ff(457),ff(458) / 5.39361696125263d-03,-1.77393445770836d-02/rotd-265
      data ff(459),ff(460) / 7.23959359228724d-02,-5.73533998264151d-02/rotd-266
      data ff(461),ff(462) / 5.42648795710159d-02,-2.39248769146420d-02/rotd-267
      data ff(463),ff(464) / 7.38288973327365d-04,-3.10782916297012d-02/rotd-268
      data ff(465),ff(466) /-3.10782916297012d-02, 7.38288973327365d-04/rotd-269
      data ff(467),ff(468) /-2.39248769146420d-02, 5.42648795710159d-02/rotd-270
      data ff(469),ff(470),ff(471),ff(472),ff(473),ff(474) / 6*0.d+00 / rotd-271
      data ff(475),ff(476) / 1.58592251779111d-02,-3.17184503558222d-02/rotd-272
      data ff(477),ff(478) / 3.17184503558222d-02,-1.58592251779111d-02/rotd-273
      data ff(479),ff(480) / 6.36434740587254d-02,-9.00054641703897d-02/rotd-274
      data ff(481),ff(482) /               0.d+00, 9.00054641703897d-02/rotd-275
      data ff(483),ff(484) /-6.36434740587254d-02, 2.20893694492763d-02/rotd-276
      data ff(485),ff(486) / 2.93554190800171d-02,-1.48336186023447d-01/rotd-277
      data ff(487),ff(488) / 1.48336186023447d-01,-2.93554190800171d-02/rotd-278
      data ff(489),ff(490) /-2.20893694492763d-02, 4.17889616928183d-02/rotd-279
      data ff(491),ff(492) /-9.17122054842361d-02, 7.52722761872573d-02/rotd-280
      data ff(493),ff(494) /               0.d+00,-7.52722761872573d-02/rotd-281
      data ff(495),ff(496) / 9.17122054842361d-02,-4.17889616928183d-02/rotd-282
      data ff(497),ff(498) /-6.41790551032870d-02, 5.94260666825252d-02/rotd-283
      data ff(499),ff(500) / 7.67785691121092d-03, 2.62939467857734d-02/rotd-284
      data ff(501),ff(502) /-2.62939467857734d-02,-7.67785691121092d-03/rotd-285
      data ff(503),ff(504) /-5.94260666825252d-02, 6.41790551032870d-02/rotd-286
      data ff(505),ff(506),ff(507),ff(508),ff(509),ff(510) / 6*0.d+00 / rotd-287
      data ff(511),ff(512),ff(513),ff(514)                 / 4*0.d+00 / rotd-288
      data ff(515),ff(516) / 6.25351913613187d-03,-1.25070382722637d-02/rotd-289
      data ff(517),ff(518) / 1.25070382722637d-02,-1.25070382722637d-02/rotd-290
      data ff(519),ff(520) / 6.25351913613187d-03, 3.11758837931106d-02/rotd-291
      data ff(521),ff(522) /-5.04436396065700d-02, 1.92677558134594d-02/rotd-292
      data ff(523),ff(524) / 1.92677558134594d-02,-5.04436396065700d-02/rotd-293
      data ff(525),ff(526) / 3.11758837931106d-02, 3.58893219026970d-02/rotd-294
      data ff(527),ff(528) /-1.67264809607312d-02,-9.33778447285944d-02/rotd-295
      data ff(529),ff(530) / 1.48430007573257d-01,-9.33778447285944d-02/rotd-296
      data ff(531),ff(532) /-1.67264809607312d-02, 3.58893219026970d-02/rotd-297
      data ff(533),ff(534) / 4.68575275756458d-02,-4.50757375114331d-02/rotd-298
      data ff(535),ff(536) /-3.00076119100051d-02, 2.82258218457924d-02/rotd-299
      data ff(537),ff(538) / 2.82258218457924d-02,-3.00076119100051d-02/rotd-300
      data ff(539),ff(540) /-4.50757375114331d-02, 4.68575275756458d-02/rotd-301
      data ff(541),ff(542),ff(543),ff(544) / 2*1.d+00, 0.d+00, 1.d+00 / rotd-302
      data ff(545),ff(546),ff(547),ff(548) / 2*0.d+00, 1.d+00, 0.d+00 / rotd-303
      data ff(549),ff(550),ff(551),ff(552) / 2*0.d+00, 1.d+00, 0.d+00 / rotd-304
      data ff(553),ff(554),ff(555),ff(556) / 3*0.d+00, 1.d+00         / rotd-305
      data ff(557),ff(558) / 9.25726650926814d-01, 3.03219677861538d-02/rotd-306
      data ff(559),ff(560) / 7.63148756611001d-01, 1.10652387063757d-01/rotd-307
      data ff(561),ff(562) / 1.28207234895501d-03, 5.36257386538795d-01/rotd-308
      data ff(563),ff(564) / 2.17289580469363d-01, 8.13196358030030d-03/rotd-309
      data ff(565),ff(566) / 5.76608786636350d-05, 2.78047174877667d-01/rotd-310
      data ff(567),ff(568) / 3.29131159509191d-01, 2.49657214768430d-02/rotd-311
      data ff(569),ff(570) / 5.20868271692270d-04, 2.66389008100408d-06/rotd-312
      data ff(571),ff(572) /               1.d+00, 7.17617351394050d-01/rotd-313
      data ff(573),ff(574) / 1.15282233550037d-01, 2.13774427323495d-01/rotd-314
      data ff(575),ff(576) / 3.48423989314638d-01, 1.85320103458231d-02/rotd-315
      data ff(577),ff(578) /-2.35732455017163d-01, 4.90294315725551d-01/rotd-316
      data ff(579),ff(580) / 9.85729671840697d-02, 3.16881041332955d-03/rotd-317
      data ff(581),ff(582) /-4.09576022206791d-01, 4.20201210269288d-01/rotd-318
      data ff(583),ff(584) / 2.34245007796887d-01, 2.41313741208102d-02/rotd-319
      data ff(585),ff(586) / 5.56591156140697d-04,               1.d+00/rotd-320
      data ff(587),ff(588) / 4.16890700467236d-01, 2.38053374687832d-01/rotd-321
      data ff(589),ff(590) /-2.82554557772787d-01, 5.03833139973589d-01/rotd-322
      data ff(591),ff(592) / 7.90217156752737d-02,-3.59733444374334d-01/rotd-323
      data ff(593),ff(594) / 2.89718584757935d-01, 3.03418532856755d-01/rotd-324
      data ff(595),ff(596) / 2.79017946123459d-02, 7.08378251175649d-02/rotd-325
      data ff(597),ff(598) /-1.72370094784044d-01, 4.12885596178737d-01/rotd-326
      data ff(599),ff(600) / 1.55306184423031d-01, 1.01200845906307d-02/rotd-327
      data ff(601),ff(602) /               1.d+00, 8.31092995327642d-02/rotd-328
      data ff(603),ff(604) / 3.74319061007963d-01,-4.21630141495484d-01/rotd-329
      data ff(605),ff(606) / 4.15874017677357d-01, 1.95380697242947d-01/rotd-330
      data ff(607),ff(608) / 1.11600329703613d-01,-1.97772479536753d-01/rotd-331
      data ff(609),ff(610) / 4.29387782672098d-01, 1.08476318674788d-01/rotd-332
      data ff(611),ff(612) / 2.63594691134320d-01,-2.34078763472890d-01/rotd-333
      data ff(613),ff(614) / 7.77527093709932d-02, 3.57086142014797d-01/rotd-334
      data ff(615),ff(616) / 6.18663570444226d-02,               1.d+00/rotd-335
      data ff(617),ff(618) /-2.17617351394050d-01, 4.97090202145758d-01/rotd-336
      data ff(619),ff(620) /-1.75906698838214d-01, 1.01968005344553d-01/rotd-337
      data ff(621),ff(622) / 3.44562631700107d-01, 3.21522932835539d-01/rotd-338
      data ff(623),ff(624) /-3.16879195937032d-01, 2.47505734203973d-01/rotd-339
      data ff(625),ff(626) / 2.54047379389696d-01,-2.23915517573357d-01/rotd-340
      data ff(627),ff(628) / 2.47297362843729d-01,-3.04922989721535d-01/rotd-341
      data ff(629),ff(630) / 3.15711860946547d-01, 1.92409975848431d-01/rotd-342
      data ff(631),ff(632) /               1.d+00,-4.25726650926814d-01/rotd-343
      data ff(633),ff(634) / 5.82050467909641d-01, 2.00043214171989d-01/rotd-344
      data ff(635),ff(636) /-2.45486828370620d-01, 4.72409970427464d-01/rotd-345
      data ff(637),ff(638) /-3.40709996864496d-02, 5.77157388195865d-02/rotd-346
      data ff(639),ff(640) /-1.44294709220167d-01, 4.07841145692130d-01/rotd-347
      data ff(641),ff(642) /-9.23304365056544d-02, 7.92778608560820d-02/rotd-348
      data ff(643),ff(644) /-3.36435261948797d-02,-7.14935648162744d-02/rotd-349
      data ff(645),ff(646) / 3.61684038642514d-01,               1.d+00/rotd-350
      data ff(647),ff(648) /              -5.d-01, 6.12372435695795d-01/rotd-351
      data ff(649),ff(650) /             3.75d-01,-3.95284707521047d-01/rotd-352
      data ff(651),ff(652) / 5.22912516583797d-01,           -3.125d-01/rotd-353
      data ff(653),ff(654) / 3.20217211436237d-01,-3.50780380010057d-01/rotd-354
      data ff(655),ff(656) / 4.74958879799083d-01,         2.734375d-01/rotd-355
      data ff(657),ff(658) /-2.77316239832795d-01, 2.90851726077911d-01/rotd-356
      data ff(659),ff(660) /-3.23629924643875d-01, 4.43148525027868d-01/rotd-357
      data nl/0,2,2,4,4,4,6,6,6,6,8,8,8,8,8,10,10,10,10,10,10,12,12,12,1rotd-358
     12,12,12,12,14,14,14,14,14,14,14,14/                               rotd-359
      data nk/0,0,2,0,2,4,0,2,4,6,0,2,4,6,8,0,2,4,6,8,10,0,2,4,6,8,10,12rotd-360
     1,0,2,4,6,8,10,12,14/                                              rotd-361
      data pi/3.1415926535d0/                                           rotd-362
      dd(1)=0.d0                                                        rotd-363
      dd(2)=0.d0                                                        rotd-364
      if (lo(1)) go to 4                                                rotd-365
      idt=1                                                             rotd-366
      do 2 j=1,8                                                        rotd-367
      if (lq(j,1)) go to 2                                              rotd-368
      if (lq(j,3)) go to 1                                              rotd-369
      p(j,1)=0.d0                                                       rotd-370
      q(j,1,1)=-val(3*j-1)                                              rotd-371
      p(j+8,1)=1.d-16                                                   rotd-372
      if (lq(j,4)) go to 2                                              rotd-373
      q(j,1,1)=val(3*j-1)                                               rotd-374
      if (q(j,1,1).gt.-36.d0*val(3*j)) p(j+8,1)=dexp(q(j,1,1)/val(3*j)) rotd-375
      go to 2                                                           rotd-376
    1 p(j,1)=val(3*j-1)                                                 rotd-377
      dd(j-6)=p(j,1)**3                                                 rotd-378
    2 continue                                                          rotd-379
      do 3 i=1,iq1                                                      rotd-380
    3 p(i+27,1)=1.d0                                                    rotd-381
      return                                                            rotd-382
    4 if (lo(3)) go to 18                                               rotd-383
c *** symmetric rotational model ***************                        rotd-384
      idt=10                                                            rotd-385
      iq=iqm                                                            rotd-386
      if (invz.ne.0) iq=max0(iq,imax)                                   rotd-387
      iq2=iqm/2                                                         rotd-388
      sr=1.d0                                                           rotd-389
      do 6 j=1,8                                                        rotd-390
      if (lq(j,1)) go to 6                                              rotd-391
      if (lo(6)) sr=1.d0/val(3*j-1)                                     rotd-392
      if (.not.lq(j,4)) sr=dabs(sr)                                     rotd-393
      do 5 i=1,iq2                                                      rotd-394
    5 p(16+j,2*i)=sr*bta(j,i)*dsqrt(dfloat(4*i+1)/(4.d0*pi))            rotd-395
    6 continue                                                          rotd-396
      do 17 i=1,10                                                      rotd-397
      pp(2)=xgn(i)                                                      rotd-398
      pp(1)=1.d0                                                        rotd-399
      do 7 j=2,iq                                                       rotd-400
      c=1.d0/dfloat(j)                                                  rotd-401
    7 pp(j+1)=(2.d0-c)*pp(2)*pp(j)+(c-1.d0)*pp(j-1)                     rotd-402
      c1=1.d0-pp(2)**2                                                  rotd-403
      do 11 j=1,8                                                       rotd-404
      if (lq(j,1)) go to 11                                             rotd-405
      p(j,i)=0.d0                                                       rotd-406
      q(j,i,2)=0.d0                                                     rotd-407
      q(j,i,3)=0.d0                                                     rotd-408
      q(j,i,1)=1.d0                                                     rotd-409
      do 8 k=2,iqm,2                                                    rotd-410
      c=k                                                               rotd-411
      q(j,i,1)=q(j,i,1)+p(16+j,k)*pp(k+1)                               rotd-412
      q(j,i,2)=q(j,i,2)-c*p(16+j,k)*(pp(2)*pp(k+1)-pp(k))/c1            rotd-413
    8 q(j,i,3)=q(j,i,3)-p(16+j,k)*pp(k+1)*c*(c+1.d0)                    rotd-414
      c2=val(3*j-1)                                                     rotd-415
      if (.not.lq(j,4)) c2=-c2                                          rotd-416
      do 9 k=1,3                                                        rotd-417
    9 q(j,i,k)=-q(j,i,k)*c2                                             rotd-418
      if (lq(j,3)) go to 10                                             rotd-419
      p(j+8,i)=1.d-16                                                   rotd-420
      if (lq(j,4)) go to 11                                             rotd-421
      if (q(j,i,1).gt.-36.d0*val(3*j)) p(j+8,i)=dexp(q(j,i,1)/val(3*j)) rotd-422
      go to 11                                                          rotd-423
   10 p(j,i)=-q(j,i,1)                                                  rotd-424
      dd(j-6)=dd(j-6)+pgn(i)*(p(j,i)**3)                                rotd-425
   11 continue                                                          rotd-426
      do 16 ij=1,iq1                                                    rotd-427
      k=1                                                               rotd-428
      if (ij.gt.iny) k=ivy(1,ij-iny)/1000                               rotd-429
      c=pp(k)                                                           rotd-430
      if ((iv(ij).eq.1).or.(ij.le.iny)) go to 16                        rotd-431
      kb=mod(ivy(1,ij-iny),1000)                                        rotd-432
      kl=nbta(17,kb)                                                    rotd-433
      kk=nbta(18,kb)                                                    rotd-434
      if (ivy(6,ij-iny).lt.0) kl=mod(kl,2)                              rotd-435
      if (kk.ne.0) go to 12                                             rotd-436
      c=c*pp(kl+1)*dsqrt(dfloat(2*kl+1))                                rotd-437
      go to 16                                                          rotd-438
c computation of y(k-1,kk) * y(kl,kk)                                   rotd-439
   12 c=dsqrt(2.d0*kl+1.d0)                                             rotd-440
      do 13 kb=1,kk                                                     rotd-441
   13 c=c*c1*dfloat(2*kb-1)**2/dsqrt(dfloat((kl+kb)*(k-kb)*(kl-kb+1)*(k+rotd-442
     1kb-1)))                                                           rotd-443
      kz=k-1-kk                                                         rotd-444
      do 15 j=1,2                                                       rotd-445
      if (kz.le.0) go to 15                                             rotd-446
      d=0.d0                                                            rotd-447
      do 14 kb=1,kz                                                     rotd-448
      c2=d                                                              rotd-449
      d=c                                                               rotd-450
   14 c=c2+(d*pp(2)-c2)*dfloat(2*(kk+kb)-1)/dfloat(kb)                  rotd-451
   15 kz=kl-kk                                                          rotd-452
   16 p(ij+27,i)=pgn(i)*c*dsqrt(dfloat(2*k-1))                          rotd-453
   17 continue                                                          rotd-454
      return                                                            rotd-455
c *** asymmetric rotational model ***************                       rotd-456
   18 idt=36                                                            rotd-457
      do 21 j=1,8                                                       rotd-458
      do 20 i=1,iqm                                                     rotd-459
      if (nk(i+1).eq.0) go to 19                                        rotd-460
      p(16+j,i+1)=p(16+j,i)*dsin(pi*bta(j,i)/180.d0)                    rotd-461
      p(16+j,i)=p(16+j,i)*dcos(pi*bta(j,i)/180.d0)                      rotd-462
      go to 20                                                          rotd-463
   19 p(16+j,i+1)=bta(j,i)*dsqrt(dfloat(2*nl(i+1)+1)/(4.d0*pi))         rotd-464
   20 continue                                                          rotd-465
   21 continue                                                          rotd-466
      sr=1.d0                                                           rotd-467
      do 23 j=1,8                                                       rotd-468
      if (lq(j,1)) go to 23                                             rotd-469
      if (lo(6)) sr=1.d0/val(3*j-1)                                     rotd-470
      if (.not.lq(j,4)) sr=dabs(sr)                                     rotd-471
      do 22 i=1,iqm                                                     rotd-472
      if (nk(i+1).ne.0) p(16+j,i+1)=p(16+j,i+1)*1.414213562d0           rotd-473
   22 p(16+j,i+1)=sr*p(16+j,i+1)                                        rotd-474
   23 continue                                                          rotd-475
      i=0                                                               rotd-476
      do 29 l=1,8                                                       rotd-477
      phi=pi/dfloat(4*max0(1,l-1))                                      rotd-478
      do 28 m=1,l                                                       rotd-479
      i=i+1                                                             rotd-480
      do 24 j=1,iq1                                                     rotd-481
      k=1                                                               rotd-482
      if (j.gt.iny) k=ivy(1,j-iny)/1000                                 rotd-483
   24 p(j+27,i)=poids(i,k)                                              rotd-484
      do 27 j=1,8                                                       rotd-485
      if (lq(j,1)) go to 27                                             rotd-486
      p(j,i)=0.d0                                                       rotd-487
      r=1.d0                                                            rotd-488
      do 25 k=1,iqm                                                     rotd-489
   25 r=r+p(16+j,k+1)*rb(k+1,l)*dcos(dfloat(nk(k+1)*nk(i)) *phi)        rotd-490
      q(j,i,1)=-r*val(3*j-1)                                            rotd-491
      if (lq(j,3)) go to 26                                             rotd-492
      p(j+8,i)=1.d-16                                                   rotd-493
      if (lq(j,4)) go to 27                                             rotd-494
      q(j,i,1)=-q(j,i,1)                                                rotd-495
      if (q(j,i,1).gt.-36.d0*val(3*j)) p(j+8,i)=dexp(q(j,i,1)/val(3*j)) rotd-496
      go to 27                                                          rotd-497
   26 p(j,i)=r*dabs(val(3*j-1))                                         rotd-498
      dd(j-6)=dd(j-6)+poids(i,1)*(p(j,i)**3)                            rotd-499
   27 continue                                                          rotd-500
   28 continue                                                          rotd-501
   29 continue                                                          rotd-502
      return                                                            rotd-503
      end                                                               rotd-504
c 29/02/04                                                      ecis03  rotz-000
      subroutine rotz(vr,xgn,r,q,val,j,iv,b,p,id1,iq1,ccz,lo)           rotz-001
c deformation of the schroedinger equation which is equivalent to the   rotz-002
c dirac equation only for elastic scattering.                           rotz-003
c     no asymmetric rotational model                                    rotz-004
c     no diffuseness of coulomb charge and no coulomb deformation       rotz-005
c     no vibrational band in rotational model                           rotz-006
c     only first order vibrational model                                rotz-007
c input variables: vr(i,j): potential for i=1, -1rst derivative for i=5 rotz-008
c                           and second derivative for i=6               rotz-009
c                  xgn:     abscissae for legendre integration          rotz-010
c                  r:       radius                                      rotz-011
c                  q(i,j,k):derivatives dr/dtheta for k=2 and 3         rotz-012
c                  val:     optical model                               rotz-013
c                  j:       point of legendre angular integral          rotz-014
c                  iv:      number of phonons plus one                  rotz-015
c                  b:       deformations                                rotz-016
c                  p(i,j):  previous results for i=17 to 26 and weights rotz-017
c                           for i=28 and up in the rotational model     rotz-018
c                  id1:     first dimension of p                        rotz-019
c                  iq1:     number of transition form factors plus 3    rotz-020
c                  lo:      logical controls                            rotz-021
c output variables:p(i,j)   for i=17 to 26, potential for j=1 and       rotz-022
c                           transition form factors for j=4 to iq1.     rotz-023
c***********************************************************************rotz-024
      implicit real*8 (a-h,o-z)                                         rotz-025
      logical lo(250)                                                   rotz-026
      dimension vr(6,10),q(8,12,3),xgn(10),b(10,1),p(id1,1),iv(1),val(1)rotz-027
      common /dcont/ xe,xm,xn,xz                                        rotz-028
      common /inout/ mr,mw,ms                                           rotz-029
      do 2 i=7,8                                                        rotz-030
      if (r.gt.val(3*i-1)) go to 1                                      rotz-031
      vr(1,i)=ccz*val(3*i-2)*(1.5d0-.5d0*(r*r)/val(3*i-1)**2)/val(3*i-1)rotz-032
      vr(6,i)=-ccz*val(3*i-2)/val(3*i-1)**3                             rotz-033
      vr(5,i)=-vr(6,i)*r                                                rotz-034
      go to 2                                                           rotz-035
    1 vr(1,i)=ccz*val(3*i-2)/r                                          rotz-036
      vr(5,i)=vr(1,i)/r                                                 rotz-037
      vr(6,i)=2.d0*vr(5,i)/r                                            rotz-038
    2 continue                                                          rotz-039
c computation of d(r) and inverse                                       rotz-040
      c1=xe+xm+vr(1,1)-vr(1,3)-vr(1,7)                                  rotz-041
      c2=vr(1,2)-vr(1,4)                                                rotz-042
      dd=c1**2+c2**2                                                    rotz-043
      dr=c1/dd                                                          rotz-044
      di=-c2/dd                                                         rotz-045
      c3=xe-xm-vr(1,1)-vr(1,3)-vr(1,7)                                  rotz-046
      c4=-vr(1,2)-vr(1,4)                                               rotz-047
      c5=(c1*c3-c2*c4-xe**2+xm**2)/(2.d0*xm)                            rotz-048
      c6=(c1*c4+c2*c3)/(2.d0*xm)                                        rotz-049
      d1=vr(5,3)-vr(5,1)+vr(5,7)                                        rotz-050
      d2=vr(5,4)-vr(5,2)                                                rotz-051
      cr=d1*dr-d2*di+(vr(5,5)+vr(5,8))/xm                               rotz-052
      ci=d2*dr+d1*di+vr(5,6)/xm                                         rotz-053
      cc=vr(1,7)*xe/xm                                                  rotz-054
      br=vr(6,1)-vr(6,7)-vr(6,3)                                        rotz-055
      bi=vr(6,2)-vr(6,4)                                                rotz-056
c square of gradient  and laplacian     radial term                     rotz-057
      er=br*dr-bi*di+(vr(5,5)+vr(5,8))/xm*(cr+cr-(vr(5,5)+vr(5,8))/xm)-vrotz-058
     1r(5,6)/xm*(ci+ci-vr(5,6)/xm)-(vr(6,5)+vr(6,8))/xm+2.d0*cr/r       rotz-059
      ei=br*di+bi*dr+(vr(5,5)+vr(5,8))/xm*(ci+ci-vr(5,6)/xm)+vr(5,6)/xm*rotz-060
     1(cr+cr-(vr(5,5)+vr(5,8))/xm)-vr(6,6)/xm+2.d0*ci/r                 rotz-061
      c5=c5-(.75d0*(cr**2-ci**2)-.5d0*er)*xn                            rotz-062
      c6=c6-(1.5d0*cr*ci-.5d0*ei)*xn                                    rotz-063
      if (lo(101)) go to 5                                              rotz-064
c rotational model                                                      rotz-065
      c=1.d0-xgn(j)**2                                                  rotz-066
      do 3 i=1,8                                                        rotz-067
      vr(4,i)=(vr(6,i)*q(i,j,2)**2*c+vr(5,i)*q(i,j,3))/r**2             rotz-068
    3 vr(3,i)=vr(5,i)*q(i,j,2)/r                                        rotz-069
c square of gradient is d/dr.d/dr + 1/r**2 d/dth.d/dth                  rotz-070
      c3=vr(3,1)-vr(3,3)-vr(3,7)                                        rotz-071
      c4=vr(3,2)-vr(3,4)                                                rotz-072
      c7=c3*dr-c4*di                                                    rotz-073
      c8=c3*di+c4*dr                                                    rotz-074
      c3=(vr(3,5)+vr(3,8))/xm                                           rotz-075
      c4=vr(3,6)/xm                                                     rotz-076
      c5=c5-(.75d0*(c7**2-c8**2)+.5d0*(c7*c3-c8*c4)+.75d0*(c3**2-c4**2))rotz-077
     1*c*xn                                                             rotz-078
      c6=c6-(1.5d0*c7*c8+.5d0*(c7*c4+c8*c3)+1.5d0*c3*c4)*c*xn           rotz-079
c laplacian is d**2/dr**2 + 2/r d/dr + 1/r**2 (d**2/dth**2+d/dth/tg )   rotz-080
      c3=vr(4,1)-vr(4,3)-vr(4,7)                                        rotz-081
      c4=vr(4,2)-vr(4,4)                                                rotz-082
      c5=c5+.5d0*(c3*dr-c4*di+(vr(4,5)+vr(4,8))/xm)*xn                  rotz-083
      c6=c6+.5d0*(c4*dr+c3*di+vr(4,6)/xm)*xn                            rotz-084
c c5 + i c6   central term                                              rotz-085
c cr + i ci   spin-orbit term                                           rotz-086
c dr + i di   1/denominator                                             rotz-087
      p(17,1)=p(17,1)+(c5+cc)*p(28,j)                                   rotz-088
      p(18,1)=p(18,1)+c6*p(28,j)                                        rotz-089
      p(21,1)=p(21,1)+.5d0*xn*(cr-vr(5,8)/xm)*p(28,j)/r                 rotz-090
      p(22,1)=p(22,1)+.5d0*xn*ci*p(28,j)/r                              rotz-091
      p(23,1)=p(23,1)+cc*p(28,j)                                        rotz-092
      p(24,1)=p(24,1)+vr(5,8)/r*p(28,j)                                 rotz-093
      if (iq1.lt.4) return                                              rotz-094
c logarithm of d(r) c9 + i c0                                           rotz-095
      c9=.5d0*dlog(c1**2+c2**2)-(vr(1,5)+vr(1,8))/xm                    rotz-096
      c0=datan2(c2,c1)-vr(1,6)/xm                                       rotz-097
      do 4 i=4,iq1                                                      rotz-098
      if (iv(i).gt.1) go to 7                                           rotz-099
      p(17,i)=p(17,i)+(c5+cc)*p(i+27,j)                                 rotz-100
      p(18,i)=p(18,i)+c6*p(i+27,j)                                      rotz-101
      p(21,i)=p(21,i)+.5d0*xn*(cr-vr(5,8)/xm)*p(i+27,j)/r               rotz-102
      p(22,i)=p(22,i)+.5d0*xn*ci*p(i+27,j)/r                            rotz-103
      p(23,i)=p(23,1)+cc*p(i+27,j)                                      rotz-104
      p(24,i)=p(24,1)+vr(5,8)/r*p(i+27,j)                               rotz-105
      p(25,i)=p(25,i)-.5d0*xn*c9*p(i+27,j)/r**2                         rotz-106
    4 p(26,i)=p(26,i)-.5d0*xn*c0*p(i+27,j)/r**2                         rotz-107
      return                                                            rotz-108
c computation of zeroth order                                           rotz-109
    5 p(17,1)=c5+cc                                                     rotz-110
      p(18,1)=c6                                                        rotz-111
      p(21,1)=.5d0*(cr-vr(5,8)/xm)*xn/r                                 rotz-112
      p(22,1)=.5d0*ci*xn/r                                              rotz-113
      p(23,1)=cc                                                        rotz-114
      p(24,1)=vr(5,8)/r                                                 rotz-115
      if (iq1.lt.4) return                                              rotz-116
      do 6 i=4,iq1                                                      rotz-117
c computation of first order                                            rotz-118
      if (iv(i).ne.2) go to 8                                           rotz-119
      c1r=vr(5,1)*b(1,i)-vr(5,3)*b(3,i)                                 rotz-120
      c2r=vr(5,2)*b(2,i)-vr(5,4)*b(4,i)                                 rotz-121
      drr=-(dr*dr-di*di)*c1r+2.d0*dr*di*c2r                             rotz-122
      dir=-(dr*dr-di*di)*c2r-2.d0*dr*di*c1r                             rotz-123
      c3r=-vr(5,1)*b(1,i)-vr(5,3)*b(3,i)                                rotz-124
      c4r=-vr(5,2)*b(2,i)-vr(5,4)*b(4,i)                                rotz-125
      c5r=(c1r*c3-c2r*c4+c1*c3r-c2*c4r)/(2.d0*xm)                       rotz-126
      c6r=(c1r*c4+c2r*c3+c1*c4r+c2*c3r)/(2.d0*xm)                       rotz-127
      d1r=vr(6,3)*b(3,i)-vr(6,1)*b(1,i)                                 rotz-128
      d2r=vr(6,4)*b(4,i)-vr(6,2)*b(2,i)                                 rotz-129
      crr=d1r*dr-d2r*di+d1*drr-d2*dir+vr(6,5)*b(5,i)/xm                 rotz-130
      cir=d2r*dr+d1r*di+d2*drr+d1*dir+vr(6,6)*b(6,i)/xm                 rotz-131
      err=br*drr-bi*dir+(vr(5,5)+vr(5,8))/xm*(crr+crr-vr(6,5)*b(5,i)/xm)rotz-132
     1-vr(5,6)/xm*(cir+cir-vr(6,6)*b(6,i)/xm)+vr(6,5)*b(5,i)/xm*(cr+cr-(rotz-133
     2vr(5,5)+vr(5,8))/xm)-vr(6,6)*b(6,i)/xm*(ci+ci-vr(5,6)/xm)+2.d0*crrrotz-134
     3/r                                                                rotz-135
      eir=br*dir+bi*drr+(vr(5,5)+vr(5,8))/xm*(cir+cir-vr(6,6)*b(6,i)/xm)rotz-136
     1+vr(5,6)/xm*(crr+crr-vr(6,5)*b(5,i)/xm)+vr(6,5)*b(5,i)/xm*(ci+ci-vrotz-137
     2r(5,6)/xm)+vr(6,6)*b(6,i)/xm*(cr+cr-vr(6,5)/xm)+2.d0*cir/r        rotz-138
      p(17,i)=c5r-(1.5d0*(cr*crr-ci*cir)-.5d0*err)*xn                   rotz-139
      p(18,i)=c6r-(1.5d0*(crr*ci+cr*cir)-.5d0*eir)*xn                   rotz-140
      p(21,i)=.5d0*crr*xn/r                                             rotz-141
      p(22,i)=.5d0*cir*xn/r                                             rotz-142
      p(23,i)=0.d0                                                      rotz-143
      p(24,i)=0.d0                                                      rotz-144
      p(25,i)=-.5d0*xn*(c1r*dr-c2r*di-vr(5,5)*b(5,i)/xm)/r**2           rotz-145
    6 p(26,i)=-.5d0*xn*(c1r*di+c2r*dr-vr(5,6)*b(6,i)/xm)/r**2           rotz-146
      return                                                            rotz-147
    7 write (mw,1000)                                                   rotz-148
      go to 9                                                           rotz-149
    8 write (mw,1001)                                                   rotz-150
    9 write (mw,1002)                                                   rotz-151
      stop                                                              rotz-152
 1000 format (' no vibrational band in rotational model')               rotz-153
 1001 format (' only first order vibrational model')                    rotz-154
 1002 format (' in rotz   ... stop')                                    rotz-155
      end                                                               rotz-156
c 29/02/04                                                      ecis03  copo-000
      subroutine copo(w,v,q,ism,h,l,val,vac,ccz,zt,lt,lz)               copo-001
c computes the coulomb potential of the charge distribution stored in v.copo-002
c input variables: v:   charge distribution unnormalised                copo-003
c                  h:   step size                                       copo-004
c                  ism: number of points                                copo-005
c                  l:   angular momentum, return 0 if l is negative     copo-006
c                  val: product of charges is in val(1)                 copo-007
c                  vac: parameter of charge distribution                copo-008
c                  lt:  logical  .true.  form factor already normalised copo-009
c                         .false.  normalisation stored from the centralcopo-010
c                  lz:  logical  .true. to use the normalisation stored copo-011
c                          even if l=0                                  copo-012
c output variables:w:   form factor which can be at the same place as v copo-013
c                  zt:  normalisation factor                            copo-014
c workspace:       q    which can be at the same place as w             copo-015
c***********************************************************************copo-016
      implicit real*8 (a-h,o-z)                                         copo-017
      dimension v(ism),val(1),w(ism),q(ism,5)                           copo-018
      logical lt,lz                                                     copo-019
      if (l.ge.0) go to 2                                               copo-020
      do 1 is=1,ism                                                     copo-021
    1 v(is)=0.d0                                                        copo-022
      return                                                            copo-023
    2 rr=0.d0                                                           copo-024
      do 3 is=1,ism                                                     copo-025
      rr=rr+h                                                           copo-026
      v(is)=v(is)*(1.d0+vac*rr*rr)                                      copo-027
      q(is,4)=rr**l                                                     copo-028
      q(is,3)=q(is,4)/rr                                                copo-029
      q(is,5)=q(is,4)*rr                                                copo-030
    3 q(is,1)=q(is,5)*rr                                                copo-031
      v(ism)=0.d0                                                       copo-032
      v(ism-1)=0.d0                                                     copo-033
      q(1,1)=q(1,1)*v(1)                                                copo-034
      q(ism,2)=0.d0                                                     copo-035
      do 4 is=2,ism                                                     copo-036
      js=ism+1-is                                                       copo-037
      q(is,1)=q(is-1,1)+q(is,1)*v(is)                                   copo-038
    4 q(js,2)=q(js+1,2)+v(js+1)/q(js+1,3)                               copo-039
      c=dfloat(2*l+1)                                                   copo-040
      zz=1.d0/c                                                         copo-041
      if (lt) go to 6                                                   copo-042
      if (l.ne.0.or.lz) go to 5                                         copo-043
      zt=ccz*val(1)/q(ism,1)                                            copo-044
    5 zz=zt*zz                                                          copo-045
    6 c=c*h/12.d0                                                       copo-046
      do 7 is=1,ism                                                     copo-047
    7 w(is)=(q(is,1)/q(is,5)+q(is,2)*q(is,4)+c*v(is))*zz                copo-048
      return                                                            copo-049
      end                                                               copo-050
c 29/02/04                                                      ecis03  stdp-000
      subroutine stdp(v,ivy,ism,va,nva,nx,idx,x,wv,pgn,xgn,npp,izz,p,acostdp-001
     1nv,ccz,lo)                                                        stdp-002
c computes form factors independently of models                         stdp-003
c input : ivy:     table of form factors  (see redm)                    stdp-004
c         ism:     number of integration steps                          stdp-005
c         va,nva:  for optical model parameters to use here             stdp-006
c         nx:      length of working space                              stdp-007
c         wv:      step size in wv(11,*)                                stdp-008
c         npp:     number of optical potentials                         stdp-009
c         pgn,xgn: weights and abscissae of gauss-legendre integration  stdp-010
c         aconv:   value below which the folding is neglected           stdp-011
c         lo:      logical controls                                     stdp-012
c in common /pote1/ see redm                                            stdp-013
c in common /dcons/ see calc and colf                                   stdp-014
c output: v(ism,1) elastic and inelastic form factors in the sequence   stdp-015
c                  central-real, spin-orbit-real, transition real,      stdp-016
c                  transition spin-orbit-real, imaginary potentials     stdp-017
c                  followed by coulomb, coulomb transition potentials.  stdp-018
c         idx:     length of working field used                         stdp-019
c working space: x(3,i) to compute bound functions, fold coulomb poten- stdp-020
c                  tial and compute rotational form factors and bessel  stdp-021
c                  functions.                                           stdp-022
c         izz,p    for folding                                          stdp-023
c***********************************************************************stdp-024
      implicit real*8 (a-h,o-z)                                         stdp-025
      logical lo(250),lt(9)                                             stdp-026
      dimension va(3),nva(2,2),v(ism,1),ivy(7,1),p(1),izz(4,1),nij(3),itstdp-027
     1z(10),vr(5,2),vs(4),xgn(10),pgn(10),wv(18,1),x(3,22),zb(77),cl(8),stdp-028
     2y(3),zb1(40),zb2(37)                                              stdp-029
      common /pote1/ itx(16),imax,intc,inls,invc,invd,itxm              stdp-030
      common /inout/ mr,mw,ms                                           stdp-031
      equivalence (itx(10),it0),(itx(13),itc),(itx(15),ite),(itx(16),itfstdp-032
     1),(zb1,zb),(zb2,zb(41))                                           stdp-033
      data nij /1,24,11/                                                stdp-034
      data pis2 /1.5707963267949d0/                                     stdp-035
      data itz /3,3,3,3,4,5,3,3,5,5/                                    stdp-036
      data zb1 /4.49340945790906d0,7.72525183693771d0,5.76345919689455d0stdp-037
     1,9.09501133047635d0,12.3229409705666d0,6.98793200050052d0,10.41711stdp-038
     285473794d0,13.6980231532492d0,16.9236212852138d0,8.18256145257124dstdp-039
     30,11.7049071545704d0,15.0396647076165d0,18.3012559595420d0,21.5254stdp-040
     4177333999d0,9.35581211104275d0,12.9665301727743d0,16.3547096393505stdp-041
     5d0,19.6531521018212d0,22.9045506479037d0,26.1277501372255d0,10.512stdp-042
     68354080940d0,14.2073924588425d0,17.6479748701659d0,20.983463068944stdp-043
     78d0,24.2627680423970d0,27.5078683649043d0,30.7303807316466d0,11.65stdp-044
     870321925164d0,15.4312892102684d0,18.9229991985461d0,22.29534801913stdp-045
     908d0,25.6028559538106d0,28.8703733470427d0,32.1111962396826d0,35.3stdp-046
     a331941827165d0,12.7907817119721d0,16.6410028815122d0,20.1824707649stdp-047
     b492d0,23.5912748179830d0,26.9270407788180d0/                      stdp-048
      data zb2 /30.2172627093614d0,33.4768008195015d0,36.7145291272447d0stdp-049
     1,39.9361278108677d0,13.9158226105049d0,17.8386431992053d0,21.42848stdp-050
     269721154d0,24.8732139238751d0,28.2371343599681d0,31.5501883818318dstdp-051
     30,34.8286965376857d0,38.0824790873276d0,41.3178646902445d0,44.5391stdp-052
     4446334095d0,15.0334693037434d0,19.0258535361278d0,22.6627206581361stdp-053
     5d0,26.1427676433791d0,29.5346341078439d0,32.8705345976875d0,36.168stdp-054
     61571359112d0,39.4382144800081d0,42.6876512846611d0,45.921201763835stdp-055
     76d0,49.1422214247461d0,16.1447429423013d0,20.2039426328117d0,23.88stdp-056
     865307559684d0,27.4012592588663d0,30.8207940864510d0,34.17947466648stdp-057
     932d0,37.4962736357858d0,40.7827470981251d0,44.0464252109438d0,47.2stdp-058
     a924656052694d0,50.5245397255712d0,53.7453428657930d0/             stdp-059
c meaning of internal logical lt:   lt(1) spin-orbit transition (schroe)stdp-060
c lt(2) spin-orbit potential derivative                                 stdp-061
c lt(3) form factor given by points or bound state                      stdp-062
c lt(4) computation of a coulomb potential from the charge density      stdp-063
c lt(5) zero diffuseness coulomb    lt(6) surface potential             stdp-064
c lt(7) first or second passage in woods-saxon/bessel loop              stdp-065
c lt(8) woods-saxon form factor     lt(9) not symmetric                 stdp-066
      idx=0                                                             stdp-067
      hm=1000.d0                                                        stdp-068
      nfo=0                                                             stdp-069
      n=4*itxm                                                          stdp-070
      if (lo(100)) n=n-4*itx(7)                                         stdp-071
      do 1 i=1,n                                                        stdp-072
    1 izz(i,1)=0                                                        stdp-073
      if (intc.eq.0) go to 7                                            stdp-074
      ntt=24*npp                                                        stdp-075
      do 6 i=1,intc                                                     stdp-076
      if (lo(100)) go to 4                                              stdp-077
      do 2 j=9,12                                                       stdp-078
      if (lo(112).and.(mod(j,2).eq.0)) go to 2                          stdp-079
      k=itx(j)+i                                                        stdp-080
      izz(3,k)=ivy(7,i)                                                 stdp-081
    2 continue                                                          stdp-082
      k=ivy(3,i)                                                        stdp-083
      if (k.eq.0) go to 3                                               stdp-084
      izz(3,k+itc)=ivy(7,i)                                             stdp-085
      if (lo(14)) izz(3,k+it0)=ivy(7,i)                                 stdp-086
    3 k=ivy(4,i)                                                        stdp-087
      if (k.ne.0) izz(3,k+ite)=ivy(7,i)                                 stdp-088
      k=ivy(5,i)                                                        stdp-089
      if (k.ne.0) izz(3,k+itf)=ivy(7,i)                                 stdp-090
      go to 6                                                           stdp-091
    4 do 5 j=1,11                                                       stdp-092
    5 izz(3,ntt+j)=ivy(7,i)                                             stdp-093
    6 ntt=ntt+11                                                        stdp-094
    7 nma=nva(1,1)                                                      stdp-095
    8 if (nma.ge.nva(1,2)) go to 100                                    stdp-096
      i1=nva(1,nma)                                                     stdp-097
      iv=nva(2,nma)                                                     stdp-098
      itv=mod(i1-1,8)+1                                                 stdp-099
      j1=(i1-1)/8                                                       stdp-100
      itt=itv                                                           stdp-101
      lt(1)=(itv-5)*(itv-6)*(itv-8).eq.0                                stdp-102
      inl=0                                                             stdp-103
      if (j1.gt.npp) itt=itv+8                                          stdp-104
      if (lo(100)) go to 9                                              stdp-105
      ji=1                                                              stdp-106
      ij=1                                                              stdp-107
      if (j1.gt.npp) j1=j1-npp                                          stdp-108
      l1=j1+itx(itt)                                                    stdp-109
      if ((itt.eq.13).or.(itt.eq.14)) inl=inls                          stdp-110
      if (itt.eq.16) inl=invd                                           stdp-111
      if (inl.ne.0) ij=2                                                stdp-112
      go to 12                                                          stdp-113
    9 if (j1.le.npp) go to 10                                           stdp-114
      ji=3                                                              stdp-115
      if (lt(1)) inl=4                                                  stdp-116
      if (itt.eq.16) inl=3                                              stdp-117
      l1=24*npp+11*(j1-npp-1)+itv                                       stdp-118
      go to 11                                                          stdp-119
   10 inl=8                                                             stdp-120
      ji=2                                                              stdp-121
      l1=itv+24*(j1-1)                                                  stdp-122
   11 ij=1+inl/3                                                        stdp-123
   12 if (iv.ne.16) go to 15                                            stdp-124
c form factor copied                                                    stdp-125
      l3=0                                                              stdp-126
      l2=l1+nij(ji)*(nva(2,nma+1)-i1)/8                                 stdp-127
      do 14 j=1,ij                                                      stdp-128
      do 13 is=1,ism                                                    stdp-129
   13 v(is,l1+l3)=v(is,l2+l3)*va(nma+3)                                 stdp-130
   14 l3=l3+inl                                                         stdp-131
      izz(1,l1)=-nva(1,nma+1)                                           stdp-132
      izz(2,l1)=izz(2,l2)                                               stdp-133
      izz(4,l1)=izz(4,l2)                                               stdp-134
      go to 99                                                          stdp-135
   15 j=max0(iv,1)                                                      stdp-136
      nmb=nma+itz(j)                                                    stdp-137
      lt(7)=.false.                                                     stdp-138
      if (iv.ge.7) go to 18                                             stdp-139
      if (va(nmb).ne.0.d0) go to 18                                     stdp-140
c zero form factors and go to next                                      stdp-141
      l2=l1                                                             stdp-142
      do 17 j=1,ij                                                      stdp-143
      do 16 is=1,ism                                                    stdp-144
   16 v(is,l2)=0.d0                                                     stdp-145
   17 l2=l2+inl                                                         stdp-146
      go to 99                                                          stdp-147
   18 lt(1)=lt(1).and.lo(200)                                           stdp-148
      lt(2)=lt(1).and.(itv.eq.itt).and.(nva(1,nma+1).eq.0)              stdp-149
      lt(3)=.false.                                                     stdp-150
      lt(4)=itv.gt.6                                                    stdp-151
      lt(8)=(iv.gt.0).and.(iv.lt.7)                                     stdp-152
      k=iabs(nva(1,nma+2))                                              stdp-153
      hh=wv(11,k)                                                       stdp-154
      h=hh                                                              stdp-155
      hm=dmin1(h,hm)                                                    stdp-156
      izz(1,l1)=-nva(1,nma+1)                                           stdp-157
      izz(2,l1)=itt                                                     stdp-158
      izz(4,l1)=k                                                       stdp-159
      if (nva(1,nma+1).eq.0) go to 19                                   stdp-160
      ij=1                                                              stdp-161
      nfo=max0(nfo,nva(1,nma+1))                                        stdp-162
   19 l=izz(3,l1)                                                       stdp-163
      ji=ij                                                             stdp-164
      if (lt(2)) ji=ji+1                                                stdp-165
      if ((iv.gt.0).and.(iv.lt.9)) go to 22                             stdp-166
      ap=va(nmb)                                                        stdp-167
      if (iv.ge.9) go to 27                                             stdp-168
      lt(2)=lt(2).and.(nva(2,nma+1).ne.0)                               stdp-169
      lt(4)=lt(4).and.((nva(2,nma+1).ne.0))                             stdp-170
c form factor interpolated                                              stdp-171
      call intp(-iv,ism,h*va(nmb+1),va(nmb),va(nmb+2),v,l1)             stdp-172
      if (ij.eq.1) go to 25                                             stdp-173
   20 l2=l1                                                             stdp-174
      do 21 j=2,ij                                                      stdp-175
      call deri(v(1,l2+inl),v(1,l2),h,ism,.true.)                       stdp-176
   21 l2=l2+inl                                                         stdp-177
      if (iv.gt.0) go to 97                                             stdp-178
      go to 25                                                          stdp-179
   22 if (lt(8)) go to 31                                               stdp-180
c bound state form factor                                               stdp-181
      k=nva(1,nmb)                                                      stdp-182
      ivm=nva(2,nmb-1)                                                  stdp-183
      ivx=iv                                                            stdp-184
      jv=0                                                              stdp-185
      nmc=nmb+3                                                         stdp-186
      if (k.eq.1) go to 23                                              stdp-187
      jv=ism                                                            stdp-188
      if (2*jv.gt.nx) call memo('stdf',nx,2*jv,2)                       stdp-189
      idx=idx-2*jv                                                      stdp-190
      call stbf(p,nva(2,nmb),ism,va(nmc+11-iv),ivm,nx-jv,idx,x(jv+1,1),istdp-191
     1vx,hh,izz(4*itxm+jv+1,1),lo)                                      stdp-192
      nmc=nmc+10*ivx-66                                                 stdp-193
      if (k.eq.3) ivx=ivx-1                                             stdp-194
      nmb=nmb+2                                                         stdp-195
   23 call stbf(v(1,l1),nva(2,nmb),ism,va(nmc),ivm,nx-jv,idx,x(jv+1,1),istdp-196
     1vx,hh,izz(4*itxm+jv+1,1),lo)                                      stdp-197
      if (k.eq.1) go to 99                                              stdp-198
      idx=idx+jv                                                        stdp-199
      do 24 is=1,ism                                                    stdp-200
   24 v(is,l1)=v(is,l1)*p(is)*va(nmb+3)                                 stdp-201
      go to 99                                                          stdp-202
   25 lt(3)=.true.                                                      stdp-203
      if (.not.lt(2).or.lt(4)) go to 26                                 stdp-204
      idx=max0(idx,ism)                                                 stdp-205
      if (idx.gt.2*nx) call memo('stdf',nx,(idx+1)/2,2)                 stdp-206
      call deri(p,v(1,l1),h,ism,.true.)                                 stdp-207
   26 if (lt(2).or.(nva(2,nma+1).ne.0)) go to 48                        stdp-208
      if (ij.eq.1) go to 99                                             stdp-209
      go to 97                                                          stdp-210
c bessel expansion                                                      stdp-211
   27 nmc=nmb+1                                                         stdp-212
      l2x=nva(2,nma+2)                                                  stdp-213
      ll=nva(1,nma+3)                                                   stdp-214
      if (iv.eq.9) go to 28                                             stdp-215
      jl=nva(2,nma+3)                                                   stdp-216
      lj=ji+jl-1                                                        stdp-217
      if (va(nmc).eq.0.d0) va(nmc)=1.d0                                 stdp-218
      go to 48                                                          stdp-219
   28 lj=ll+ji+nva(2,nma+3)                                             stdp-220
      idx=max0(idx,3*max0(l2x,lj))                                      stdp-221
      if (idx.gt.2*nx) call memo('stdf',nx,(idx+1)/2,2)                 stdp-222
c computation of zeros of bessel functions - the l+1 zeros for l=1 to   stdp-223
c l=11 are in data zb. the others are computed with mc mahon's formula  stdp-224
c page 371, handbook of math. functions, abramovitz and stegun          stdp-225
      if (va(nmc).eq.0.d0) va(nmc)=ism*h                                stdp-226
      do 30 ii=1,l2x                                                    stdp-227
      if ((ll.ne.0).and.((ll.lt.12).and.(ii.le.ll+1))) go to 29         stdp-228
      x(1,ii)=(2*ii+ll)*pis2                                            stdp-229
      if (ll.eq.0) go to 30                                             stdp-230
      a1=2.d0*x(1,ii)                                                   stdp-231
      a2=dfloat(ll*(ll+1))                                              stdp-232
      x(1,ii)=x(1,ii)-a2*(1.d0+(7.d0*a2-6.d0+((166.d0*a2-408.d0)*a2+360.stdp-233
     1d0+(((6949.d0*a2-33252.d0)*a2+81180.d0)*a2-75600.d0)/(7.d0*a1**2))stdp-234
     2/(5.d0*a1**2))/(3.d0*a1**2))/a1                                   stdp-235
      go to 30                                                          stdp-236
   29 k=(ll*(ll+1))/2+ii-1                                              stdp-237
      x(1,ii)=zb(k)                                                     stdp-238
   30 x(1,ii)=x(1,ii)/va(nmc)                                           stdp-239
      lm=ll+1                                                           stdp-240
      lt(6)=lt(2).and.(nva(2,nma+1).eq.0)                               stdp-241
      go to 48                                                          stdp-242
c woods-saxon and its derivatives to some power                         stdp-243
   31 nmc=nmb+4                                                         stdp-244
      lt(5)=((va(nmb+2).eq.0.d0).and.lt(4))                             stdp-245
      lt(4)=((va(nmb+2).ne.0.d0).and.lt(4))                             stdp-246
      lt(6)=(((itv.eq.3).or.(itv.eq.4)).and.lo(200))                    stdp-247
      lt(9)=lo(109).or.(va(nmb+1).ge.0.d0).or.lt(5)                     stdp-248
      if (itv.gt.6) nmc=nmc+1                                           stdp-249
      if (lt(5)) go to 32                                               stdp-250
      sep=dexp(hh/va(nmb+2))                                            stdp-251
      if (va(nmb+2).gt.0.02d0*h)  go to 33                              stdp-252
      write (mw,1000) va(nmb+2),nma,i                                   stdp-253
      va(nmb+2)=dmax1(-va(nmb+2),0.02d0*h)                              stdp-254
      go to 33                                                          stdp-255
   32 if (va(nmb+1).ge.h) go to 33                                      stdp-256
      write (mw,1001) va(nmb+1),nma,i                                   stdp-257
      va(nmb+1)=dmax1(-va(nmb+1),h)                                     stdp-258
   33 if (iv.le.4) go to 44                                             stdp-259
c initialisation of do loops for deformed potentials                    stdp-260
      iqm=nva(2,nma+2)                                                  stdp-261
      ix=20                                                             stdp-262
      iq=max0(l,iqm)                                                    stdp-263
      if (iv.eq.6) iq=max0(iq,nva(2,nma+2))                             stdp-264
      idx=max0(idx,3*iq+120)                                            stdp-265
      if (idx.gt.2*nx) call memo('stdf',nx,(idx+1)/2,2)                 stdp-266
      a2=0.d0                                                           stdp-267
      a1=1.d0                                                           stdp-268
      if (lo(6)) a1=dabs(va(nmb+1))                                     stdp-269
      do 34 i=1,iqm                                                     stdp-270
   34 x(1,40+i)=va(nmc+i-1)*dsqrt(dfloat(2*i+1)/(8.d0*pis2))/a1         stdp-271
      do 43 ii=1,20                                                     stdp-272
      i=1+mod(ii-1,10)                                                  stdp-273
      x(2,22)=xgn(i)                                                    stdp-274
      if (i.ne.ii) x(2,22)=-x(2,22)                                     stdp-275
      x(2,21)=1.d0                                                      stdp-276
      do 35 j=2,iq                                                      stdp-277
   35 x(2,j+21)=(dfloat(2*j-1)*x(2,22)*x(2,j+20)+dfloat(1-j)*x(2,j+19))/stdp-278
     1dfloat(j)                                                         stdp-279
      x(3,ii+20)=0.5d0*pgn(i)                                           stdp-280
      x(2,ii)=0.d0                                                      stdp-281
      a5=x(2,l+21)                                                      stdp-282
      if (iv.eq.5) go to 40                                             stdp-283
      kl=nva(2,nma+2)                                                   stdp-284
      if (nva(1,nma+3).ne.0) go to 36                                   stdp-285
      a5=a5*x(2,kl+21)*dsqrt(dfloat(2*kl+1))                            stdp-286
      go to 40                                                          stdp-287
c computation of y(l,kk) * y(kl,kk)                                     stdp-288
   36 a5=dsqrt(dfloat(2*kl+1))                                          stdp-289
      kk=nva(1,nma+3)                                                   stdp-290
      do 37 n=1,kk                                                      stdp-291
   37 a5=a5*(1.d0-xgn(i)**2)*dfloat(2*n-1)**2/dsqrt(dfloat((kl+n)*(l+n)*stdp-292
     1(kl-n+1)*(l-n+1)))                                                stdp-293
      kz=l-kk                                                           stdp-294
      do 39 j=1,2                                                       stdp-295
      if (kz.le.0) go to 39                                             stdp-296
      a4=0.d0                                                           stdp-297
      do 38 k=1,kz                                                      stdp-298
      a3=a4                                                             stdp-299
      a4=a5                                                             stdp-300
   38 a5=a3+(a4*x(2,22)-a3)*(2.d0*(kk+k)-1.d0)/k                        stdp-301
   39 kz=kl-kk                                                          stdp-302
   40 x(3,ii)=x(3,ii+20)*a5*dsqrt(2.d0*l+1.d0)                          stdp-303
      rr=1.d0                                                           stdp-304
      do 41 k=1,iqm                                                     stdp-305
   41 rr=rr+x(1,40+k)*x(2,k+21)                                         stdp-306
      x(2,ii)=-rr*va(nmb+1)                                             stdp-307
      x(1,ii)=0.d0                                                      stdp-308
      x(1,20+ii)=1.d-16                                                 stdp-309
      if (lt(9)) go to 42                                               stdp-310
      x(2,ii)=-x(2,ii)                                                  stdp-311
      if (x(2,ii).gt.-36.d0*va(nmb+2)) x(1,20+ii)=dexp(x(2,ii)/va(nmb+2)stdp-312
     1)                                                                 stdp-313
   42 if (.not.lt(5)) go to 43                                          stdp-314
      x(2,ii)=dabs(x(2,ii))                                             stdp-315
      a2=a2+x(2,ii)**3*x(3,20+ii)                                       stdp-316
   43 continue                                                          stdp-317
      go to 46                                                          stdp-318
c initialisation of do loops for not deformed potentials                stdp-319
   44 iqm=0                                                             stdp-320
      ix=1                                                              stdp-321
      idx=max0(idx,63)                                                  stdp-322
      if (idx.gt.2*nx) call memo('stdf',nx,(idx+1)/2,2)                 stdp-323
      x(1,1)=0.d0                                                       stdp-324
      x(2,1)=-va(nmb+1)                                                 stdp-325
      x(3,1)=1.d0                                                       stdp-326
      x(3,21)=1.d0                                                      stdp-327
      x(1,21)=1.d-16                                                    stdp-328
      if (lt(9)) go to 45                                               stdp-329
      x(2,1)=-x(2,1)                                                    stdp-330
      if (x(2,1).gt.-36.d0*va(nmb+2)) x(1,21)=dexp(x(2,1)/va(nmb+2))    stdp-331
   45 if (.not.lt(5)) go to 46                                          stdp-332
      x(2,1)=-x(2,1)                                                    stdp-333
      a2=x(2,1)**3                                                      stdp-334
   46 iv1=1+mod(iv-1,4)                                                 stdp-335
      ap=va(nmb)                                                        stdp-336
      an=va(nmb+1)                                                      stdp-337
      if (lo(6)) an=an/dabs(va(nmb+1))                                  stdp-338
      if (.not.lt(9)) an=-an                                            stdp-339
      if (iv1.gt.1) ap=ap*an/dsqrt(8.d0*pis2)                           stdp-340
      if (iv1.gt.2) ap=ap*an*0.5d0                                      stdp-341
      if (iv1.gt.3) ap=ap*an/3.d0                                       stdp-342
      if (va(nmb+3).gt.-1.d0) go to 47                                  stdp-343
      write (mw,1002) va(nmb+3),nma                                     stdp-344
      va(nmb+3)=-.8d0                                                   stdp-345
   47 a1=va(nmb+3)                                                      stdp-346
      a5=dfloat(l+1)                                                    stdp-347
      iv2=iv1                                                           stdp-348
      iv3=iv2-1                                                         stdp-349
      iv2=iv3+ji                                                        stdp-350
      if (lt(6)) iv2=iv2+1                                              stdp-351
      if (itv.gt.6) ap=ap*ccz                                           stdp-352
      if (lt(5)) ap=ap/a2                                               stdp-353
   48 if (lt(4)) ji=1                                                   stdp-354
      rr=0.d0                                                           stdp-355
      an=0.d0                                                           stdp-356
      a6=0.d0                                                           stdp-357
      do 90 is=1,ism                                                    stdp-358
      rr=rr+hh                                                          stdp-359
      if (lt(3)) go to 89                                               stdp-360
      do 49 i=1,3                                                       stdp-361
   49 y(i)=0.d0                                                         stdp-362
      if (iv.ge.9) go to 70                                             stdp-363
c integration loop                                                      stdp-364
      do 69 i=1,ix                                                      stdp-365
      if (lt(5)) go to 60                                               stdp-366
      if (x(1,i).ne.0.d0) go to 50                                      stdp-367
      x(2,i)=x(2,i)+hh                                                  stdp-368
      if (x(2,i)+50.d0*va(nmb+2).gt.0.d0) x(1,i)=dexp(x(2,i)/va(nmb+2)) stdp-369
      go to 51                                                          stdp-370
   50 if (x(1,i).lt.1.d15) x(1,i)=x(1,i)*sep                            stdp-371
   51 if ((.not.lt(9)).and.x(1,i+20).gt.1.d-15) x(1,i+20)=x(1,i+20)/sep stdp-372
      j=i                                                               stdp-373
      k=1                                                               stdp-374
   52 vr(1,k)=1.d0/(1.d0+x(1,j))                                        stdp-375
      if (iv2.eq.1) go to 53                                            stdp-376
      a2=vr(1,k)/va(nmb+2)                                              stdp-377
      vr(2,k)=vr(1,k)*a2*x(1,j)                                         stdp-378
      if (iv2.gt.2) vr(3,k)=vr(2,k)*a2*(x(1,j)-1.d0)                    stdp-379
      if (iv2.gt.3) vr(4,k)=vr(2,k)*(x(1,j)**2-4.d0*x(1,j)+1.d0)*a2*a2  stdp-380
      if (iv2.gt.4) vr(5,k)=vr(3,k)*(x(1,j)**2-10.d0*x(1,j)+1.d0)*a2*a2 stdp-381
   53 if (a1.eq.0.d0) go to 54                                          stdp-382
      if (iv2.gt.4) vr(5,k)=(a1+1.d0)*(a1*(a1-1.d0)*((a1-2.d0)*vr(2,k)**stdp-383
     12+6.d0*vr(1,k)*vr(3,k))*vr(2,k)**2+a1*vr(1,k)**2*(3.d0*vr(3,k)**2+stdp-384
     24.d0*vr(2,k)*vr(4,k))+vr(1,k)**3*vr(5,k))*vr(1,k)**(a1-3.d0)      stdp-385
      if (iv2.gt.3) vr(4,k)=(a1+1.d0)*(a1*((a1-1.d0)*vr(2,k)**2+3.d0*vr(stdp-386
     11,k)*vr(3,k))*vr(2,k)+vr(1,k)**2*vr(4,k))*vr(1,k)**(a1-2.d0)      stdp-387
      if (iv2.gt.2) vr(3,k)=(a1+1.d0)*(a1*vr(2,k)**2+vr(3,k)*vr(1,k))*vrstdp-388
     1(1,k)**(a1-1.d0)                                                  stdp-389
      if (iv2.gt.1) vr(2,k)=(a1+1.d0)*vr(1,k)**a1*vr(2,k)               stdp-390
      vr(1,k)=vr(1,k)**(a1+1.d0)                                        stdp-391
   54 if (.not.lt(9)) go to 55                                          stdp-392
      if (lt(6)) vr(iv1,1)=vr(iv2,1)*4.d0*va(nmb+2)                     stdp-393
      go to 58                                                          stdp-394
   55 j=j+20                                                            stdp-395
      k=k+1                                                             stdp-396
      if (k.eq.2) go to 52                                              stdp-397
      if (lo(200).or.(ij.ne.3)) go to 56                                stdp-398
      vr(3,1)=vr(1,1)*vr(3,2)-2.d0*vr(2,1)*vr(2,2)+vr(3,1)*vr(1,2)      stdp-399
      vr(2,1)=vr(2,1)*vr(1,2)-vr(1,1)*vr(2,2)                           stdp-400
      go to 57                                                          stdp-401
   56 if (iv2.gt.4) vs(4)=vr(1,1)*vr(5,2)+2.d0*vr(2,1)*vr(4,2)-2.d0*vr(4stdp-402
     1,1)*vr(2,2)-vr(5,1)*vr(1,2)                                       stdp-403
      if (iv2.gt.3) vs(3)=vr(1,1)*vr(4,2)+vr(2,1)*vr(3,2)-vr(3,1)*vr(2,2stdp-404
     1)-vr(4,i)*vr(1,2)                                                 stdp-405
      if (iv2.gt.2) vs(2)=vr(1,1)*vr(3,2)-vr(3,1)*vr(1,2)               stdp-406
      vs(1)=vr(1,1)*vr(2,2)-vr(2,1)*vr(1,2)                             stdp-407
      if (iv2.gt.4) vr(5,1)=vr(1,1)*vr(5,2)+4.d0*vr(2,1)*vr(4,2)+6.d0*vrstdp-408
     1(3,1)*vr(3,2)+4.d0*vr(4,1)*vr(2,2)+vr(5,1)*vr(1,2)                stdp-409
      if (iv2.gt.3) vr(4,1)=vr(1,1)*vr(4,2)+3.d0*vr(2,1)*vr(3,2)+3.d0*vrstdp-410
     1(3,1)*vr(2,2)+vr(4,1)*vr(1,2)                                     stdp-411
      if (iv2.gt.2) vr(3,1)=vr(1,1)*vr(3,2)+2.d0*vr(2,1)*vr(2,2)+vr(3,1)stdp-412
     1*vr(1,2)                                                          stdp-413
      if (iv2.gt.1) vr(2,1)=vr(1,1)*vr(2,2)+vr(2,1)*vr(1,2)             stdp-414
   57 vr(1,1)=vr(1,1)*vr(1,2)                                           stdp-415
      if (lt(6)) vr(iv1,1)=rr*(4.d0*va(nmb+2)**(a1+1.d0))/va(nmb+1)*vs(istdp-416
     1v1)                                                               stdp-417
      if (lt(1)) vr(iv3+2,1)=-vs(iv3+1)                                 stdp-418
   58 if (lt(4)) a6=a6+vr(1,1)*rr**2*x(3,i+20)*(1.d0+va(nmb+4)*rr**2)   stdp-419
      do 59 j=1,ji                                                      stdp-420
   59 y(j)=y(j)+vr(iv3+j,1)*x(3,i)                                      stdp-421
      go to 69                                                          stdp-422
c deformed coulomb potential                                            stdp-423
   60 a4=x(2,i)/rr                                                      stdp-424
      if (itv.ne.itt) go to 62                                          stdp-425
      if (a4.gt.1.d0) go to 61                                          stdp-426
      y(1)=y(1)+(x(2,i)**2)*a4*x(3,i)                                   stdp-427
      y(2)=y(2)+x(2,i)*a4**2*x(3,i)                                     stdp-428
      y(3)=y(3)+2.d0*a4**3*x(3,i)                                       stdp-429
      go to 69                                                          stdp-430
   61 y(1)=y(1)+(0.5d0*x(2,i)*x(2,i)-rr*rr/6.d0)*x(3,i)*3.d0            stdp-431
      y(2)=y(2)+rr*x(3,i)                                               stdp-432
      y(3)=y(3)-x(3,i)                                                  stdp-433
      go to 69                                                          stdp-434
   62 if (a4.gt.1.d0) go to 63                                          stdp-435
      a3=(x(2,i)**2)*(a4**(l+1))*3.d0/((a5+2.d0)*(2.d0*a5-1.d0))        stdp-436
      if (iv1.gt.1) a3=a3*(a5+2.d0)/x(2,i)                              stdp-437
      if (iv1.gt.2) a3=a3*(a5+1.d0)/x(2,i)                              stdp-438
      if (iv1.gt.3) a3=a3*a5/x(2,i)                                     stdp-439
      go to 65                                                          stdp-440
   63 if (l.ne.2) go to 64                                              stdp-441
      if (iv1.eq.1) a3=rr*rr*(0.2d0+dlog(a4))*0.6d0                     stdp-442
      if (iv1.ge.2) a3=0.6d0*rr/a4                                      stdp-443
      if (iv1.ge.3) a3=-a3/x(2,i)                                       stdp-444
      if (iv1.ge.4) a3=-2.d0*a3/x(2,i)                                  stdp-445
      go to 65                                                          stdp-446
   64 if (iv1.eq.1) a3=rr*rr*(1.d0/(a5+2.d0)-1.d0/(a4**(l-2)*(2.d0*a5-1.stdp-447
     1d0)))*3.d0/(a5-3.d0)                                              stdp-448
      if (iv1.ge.2) a3=rr/a4**(l-1)*3.d0/(2.d0*a5-1.d0)                 stdp-449
      if (iv1.ge.3) a3=-a3*(a5-2.d0)/x(2,i)                             stdp-450
      if (iv1.eq.4) a3=-a3*(a5-1.d0)/x(2,i)                             stdp-451
   65 y(1)=y(1)+a3*x(3,i)                                               stdp-452
      if (ji.eq.1) go to 69                                             stdp-453
      if (a4.gt.1.d0) go to 66                                          stdp-454
      a3=-a5*a3/rr                                                      stdp-455
      go to 68                                                          stdp-456
   66 if (l.ne.2) go to 67                                              stdp-457
      if (iv2.eq.1) a3=-1.2d0*(0.3d0*rr-dlog(a4))*rr                    stdp-458
      if (iv2.ge.2) a3=2.d0*a3/rr                                       stdp-459
      go to 68                                                          stdp-460
   67 if (iv2.eq.1) a3=(2.d0/(a5+2.d0)-(a5-1.d0)/(a4**(l-2)*(2.d0*a5-1.dstdp-461
     10)))*3.d0/(a5-3.d0)*rr                                            stdp-462
      if (iv2.ne.1) a3=(a5-1.d0)*a3/rr                                  stdp-463
   68 y(2)=y(2)-a3*x(3,i)                                               stdp-464
   69 continue                                                          stdp-465
      go to 87                                                          stdp-466
c computation of bessel functions                                       stdp-467
   70 if (iv.gt.9) go to 79                                             stdp-468
      if (rr.gt.va(nmc)) go to 90                                       stdp-469
      do 78 ii=1,l2x                                                    stdp-470
      a1=rr*x(1,ii)                                                     stdp-471
      x(2,1)=dsin(a1)/a1                                                stdp-472
      if (lj.eq.1) go to 75                                             stdp-473
      k=idint(1.d0+a1)                                                  stdp-474
      if (k.lt.lj) go to 72                                             stdp-475
      x(2,2)=(x(2,1)-dcos(a1))/a1                                       stdp-476
      if (lj.eq.2) go to 75                                             stdp-477
      do 71 j=3,lj                                                      stdp-478
   71 x(2,j)=(2*j-3)*x(2,j-1)/a1-x(2,j-2)                               stdp-479
      go to 75                                                          stdp-480
   72 a3=lj                                                             stdp-481
      a4=dmax1(dsqrt(10.5d0*a1)-0.5d0,a3)                               stdp-482
      k=idint(a4+3.d0+21.d0*a1/(a4+a4+1.d0))                            stdp-483
      a2=0.d0                                                           stdp-484
   73 a2=a1/(2.d0*k+1.d0-a2*a1)                                         stdp-485
      if (k.le.lj) x(2,k+1)=a2                                          stdp-486
      k=k-1                                                             stdp-487
      if (k.ge.1) go to 73                                              stdp-488
      do 74 k=2,lj                                                      stdp-489
   74 x(2,k)=x(2,k)*x(2,k-1)                                            stdp-490
c computation of derivatives of bessel functions (- derivative)         stdp-491
   75 jl=lj-1                                                           stdp-492
      do 77 j=lm,lj                                                     stdp-493
      kk=ji+j-lj                                                        stdp-494
      if (kk.ge.1) y(kk)=y(kk)+va(nmc+ii)*x(2,lm)                       stdp-495
      if (kk.eq.ji) go to 78                                            stdp-496
      a3=0.d0                                                           stdp-497
      a5=0.d0                                                           stdp-498
      do 76 k=1,jl                                                      stdp-499
      a2=(a5+1.d0)*x(2,k+1)-a5*a3                                       stdp-500
      a3=x(2,k)                                                         stdp-501
      x(2,k)=x(1,ii)*a2/(2.d0*a5+1.d0)                                  stdp-502
   76 a5=a5+1.d0                                                        stdp-503
   77 jl=jl-1                                                           stdp-504
   78 continue                                                          stdp-505
      go to 87                                                          stdp-506
c computation of laguerre polynomials x**ll l(2x**2) dexp(-x**2)        stdp-507
   79 do 86 j=1,l2x,2                                                   stdp-508
      if (j.ne.1) go to 80                                              stdp-509
      a1=rr/va(nmc)                                                     stdp-510
      a2=a1*a1                                                          stdp-511
      cl(1)=a1**ll*dexp(-0.5d0*a2)                                      stdp-512
      cl(2)=(ll+1.5d0-a2)*cl(1)                                         stdp-513
      go to 81                                                          stdp-514
   80 cl(1)=(cl(2)*(dfloat(ll+2*j)-2.5d0-a2)-cl(1)*(dfloat(ll+j)-1.5d0))stdp-515
     1/dfloat(j-1)                                                      stdp-516
      cl(2)=(cl(1)*(dfloat(ll+2*j)-0.5d0-a2)-cl(2)*(dfloat(ll+j)-0.5d0))stdp-517
     1/dfloat(j)                                                        stdp-518
   81 if (jl.ne.0) go to 82                                             stdp-519
      y(1)=y(1)+cl(1)*va(nmc+j)                                         stdp-520
      if (j.lt.l2x) y(1)=y(1)+cl(2)*va(nmc+j+1)                         stdp-521
   82 if (lj.eq.0) go to 86                                             stdp-522
      do 83 l=3,6                                                       stdp-523
   83 cl(l)=0.d0                                                        stdp-524
c -derivative of laguerre polynomials x**ll l(2x**2) dexp(-x**2)        stdp-525
      do 85 k=1,lj                                                      stdp-526
      do 84 l=1,6                                                       stdp-527
   84 cl(l+2)=cl(l)                                                     stdp-528
      cl(1)=((dfloat(ll+2*j+k)-a2)*cl(3)-dfloat(2*j)*cl(4)-dfloat(2*(k-1stdp-529
     1)*(k-2))*cl(7))/a1+dfloat(4*(k-1))*cl(5)                          stdp-530
      cl(2)=-((dfloat(ll+2*j+1-k)-a2)*cl(4)-dfloat(2*j+1+2*ll)*cl(3)-dflstdp-531
     1oat(2*(k-1)*(k-2))*cl(8))/a1-dfloat(4*(k-1))*cl(6)                stdp-532
      if (k.lt.jl) go to 86                                             stdp-533
      y(k+1-jl)=y(k+1-jl)+cl(1)*va(nmc+j)                               stdp-534
      if (j.lt.l2x) y(k+1-jl)=y(k+1-jl)+cl(2)*va(nmc+j+1)               stdp-535
   85 continue                                                          stdp-536
   86 continue                                                          stdp-537
   87 l2=l1                                                             stdp-538
      do 88 j=1,ji                                                      stdp-539
      v(is,l2)=ap*y(j)                                                  stdp-540
   88 l2=l2+inl                                                         stdp-541
      go to 90                                                          stdp-542
   89 y(1)=v(is,l1)/ap                                                  stdp-543
      if (lt(2).and.(.not.lt(4))) v(is,l1)=p(is)                        stdp-544
   90 an=an+ap*y(1)*rr**(l+2)                                           stdp-545
      if (lt(7)) go to 97                                               stdp-546
      if (.not.lt(4)) go to 92                                          stdp-547
c folding of charge distribution with coulomb potential                 stdp-548
      idx=max0(idx,5*ism)                                               stdp-549
      if (idx.gt.2*nx) call memo('stdf',nx,(idx+1)/2,2)                 stdp-550
      a7=0.d0                                                           stdp-551
      if (lt(8)) a7=va(nmb+4)                                           stdp-552
      call copo(v(1,l1),v(1,l1),x,ism,hh,l,ap,a7,ccz,a6,.true.,.false.) stdp-553
      if (a6.eq.0.d0) a6=dabs(v(ism,l1)*dfloat(2*l+1)*(ism*hh)**(l+1)/(cstdp-554
     1cz*va(nmb)))                                                      stdp-555
      do 91 is=1,ism                                                    stdp-556
   91 v(is,l1)=v(is,l1)/a6                                              stdp-557
   92 if (nva(2,nma+1).eq.0) go to 96                                   stdp-558
      an=dabs(an*hh/ap)                                                 stdp-559
      if (itv.gt.6) an=dabs(v(ism,l1)*dfloat(2*l+1)*(ism*hh)**(l+1)/(cczstdp-560
     1*va(nmb)))                                                        stdp-561
      if (lt(2).and.(itt.eq.8).and.(nva(1,nma+1).eq.0).and.(va(nmb+2).eqstdp-562
     1.0.d0).and.lt(8)) an=an*hh*ism                                    stdp-563
      if (nva(2,nma+1).gt.0) go to 93                                   stdp-564
      nva(2,nma+1)=-nva(2,nma+1)                                        stdp-565
      ap=va(nmb)                                                        stdp-566
      va(nmb)=ap*an                                                     stdp-567
      write (mw,1003) ap,va(nmb),itt,j1                                 stdp-568
      go to 96                                                          stdp-569
   93 l2=l1                                                             stdp-570
      do 95 j=1,ij                                                      stdp-571
      do 94 is=1,ism                                                    stdp-572
   94 v(is,l2)=v(is,l2)/an                                              stdp-573
   95 l2=l2+inl                                                         stdp-574
   96 if (.not.lt(4)) go to 97                                          stdp-575
      lt(4)=.false.                                                     stdp-576
      lt(7)=.true.                                                      stdp-577
      if (lt(2)) go to 25                                               stdp-578
      if (ij.ne.1) go to 20                                             stdp-579
   97 if (.not.lt(1).or.(nva(1,nma+1).ne.0)) go to 99                   stdp-580
      rr=0.d0                                                           stdp-581
      do 98 is=1,ism                                                    stdp-582
      rr=rr+h                                                           stdp-583
      a1=v(is,l1+inl)                                                   stdp-584
      v(is,l1+inl)=-v(is,l1)/rr**2                                      stdp-585
   98 v(is,l1)=a1/rr                                                    stdp-586
   99 nma=nva(2,i1-6)+1                                                 stdp-587
      go to 8                                                           stdp-588
  100 if (nfo.eq.0) return                                              stdp-589
c folding                                                               stdp-590
      nnf=ism*itxm+1                                                    stdp-591
      if (lo(100)) nnf=nnf-ism*itx(7)                                   stdp-592
      do 101 i=1,nnf                                                    stdp-593
  101 p(i)=0.d0                                                         stdp-594
      n1=nva(2,1)                                                       stdp-595
      ist=0                                                             stdp-596
      do 102 n=1,nfo                                                    stdp-597
      is=5+ism+idint(2.d0*(dabs(va(n1+3*n-2))+2.d0*dabs(va(n1+3*n-1)))/hstdp-598
     1m)                                                                stdp-599
      if (va(n1+3*n-3)*va(n1+3*n-2).eq.0.d0) is=ism+5                   stdp-600
  102 ist=max0(is,ist)                                                  stdp-601
      idy=nnf+2*ist*(imax+1)                                            stdp-602
      idx=max0(idy,idx)                                                 stdp-603
      if (idx.gt.2*nx) call memo('stdf',nx,(idx+1)/2,2)                 stdp-604
      call fold(v,p,va(n1),nfo,1,ism,ist,aconv,ivy,intc,p(nnf),pgn,xgn,wstdp-605
     1v,izz,lo)                                                         stdp-606
      return                                                            stdp-607
 1000 format (' too small diffuseness =',d15.8,'   changed into minimum stdp-608
     1value in stdp for nma =',i5,' and i =',i2)                        stdp-609
 1001 format (' too small coulomb radius =',d15.8,'   changed into minimstdp-610
     1um value in stdp for nma =',i5,' and i =',i2)                     stdp-611
 1002 format (' power 1+',d15.6,'  changed to .2 for nma =',i4)         stdp-612
 1003 format (' strength',d15.6,' replaced by the integral',d15.6,' for stdp-613
     1the form factor',i4,' of the potential',i4)                       stdp-614
      end                                                               stdp-615
c 29/02/04                                                      ecis03  stbf-000
      subroutine stbf(v,ivx,ism,va,ivm,nx,idx,xx,iv,h,iex,lo)           stbf-001
c computes bound state form factors                                     stbf-002
c input : ivx:  table of quantum numbers                                stbf-003
c         ism:  number of integration steps                             stbf-004
c         va:   for optical model parameters to use here                stbf-005
c         ivm:  step factor for woods-saxon wave functions              stbf-006
c         nx:   length of working space                                 stbf-007
c         lo:   logical controls                                        stbf-008
c output: v(ism):  bound state wave function                            stbf-009
c         idx:  length of working field used                            stbf-010
c working space: xx(3,i): to compute bound functions                    stbf-011
c                iex: for coulomb function, in equivalence with xx      stbf-012
c***********************************************************************stbf-013
      implicit real*8 (a-h,o-z)                                         stbf-014
      logical lo(250)                                                   stbf-015
      dimension va(11),v(1),ivx(4),xx(3,1),iex(1)                       stbf-016
      common /dcons/ cm,ck,chb,cmb,ccz                                  stbf-017
      common /inout/ mr,mw,ms                                           stbf-018
      l=ivx(2)                                                          stbf-019
      if (iv.eq.8) go to 7                                              stbf-020
      n=ivx(1)                                                          stbf-021
c computation of the normalisation of laguerre polynomials              stbf-022
      a1=2.256758334191d0                                               stbf-023
      a3=l                                                              stbf-024
      if (l.eq.0) go to 2                                               stbf-025
      do 1 i=1,l                                                        stbf-026
    1 a1=a1/(dfloat(i)+.5d0)                                            stbf-027
    2 if (n.eq.0) go to 4                                               stbf-028
      do 3 i=1,n                                                        stbf-029
      a2=dfloat(i)                                                      stbf-030
    3 a1=a1*(a2+a3+.5d0)/a2                                             stbf-031
    4 a1=dsqrt(a1)                                                      stbf-032
c computation of laguerre polynomials                                   stbf-033
      rr=0.d0                                                           stbf-034
      do 6 is=1,ism                                                     stbf-035
      rr=rr+h                                                           stbf-036
      x1=(va(1)*rr)**2                                                  stbf-037
      x3=a1*dexp(.5d0*(a3*dlog(x1)-x1))                                 stbf-038
      if (n.eq.0) go to 6                                               stbf-039
      x2=x3                                                             stbf-040
      do  5 i=1,n                                                       stbf-041
      a2=dfloat(i)                                                      stbf-042
      x2=2.d0*x2*dfloat(i-n-1)*x1/(a2*(2.d0*(a3+a2)+1.d0))              stbf-043
    5 x3=x3+x2                                                          stbf-044
    6 v(is)=x3                                                          stbf-045
      return                                                            stbf-046
c bound state in woods-saxon potential                                  stbf-047
c control of storage and step size                                      stbf-048
    7 ireb=ivm                                                          stbf-049
      if (ireb.eq.0) ireb=4                                             stbf-050
      kn=ireb*ism                                                       stbf-051
      idx=max0(idx,6*kn+6)                                              stbf-052
      if (idx.gt.2*nx) call memo('stbf',nx,(idx+1)/2,2)                 stbf-053
      a4=ireb                                                           stbf-054
      a4=h/a4                                                           stbf-055
      if (va(3).eq.0.d0) va(3)=1.d0                                     stbf-056
      y3=(va(2)-va(3))**0.33333333333333d0                              stbf-057
      a2=y3*va(6)                                                       stbf-058
      kr=idint(a2/a4)                                                   stbf-059
      y2=va(1)                                                          stbf-060
      if (y2.eq.0.d0) y2=0.01d0                                         stbf-061
      jl=ivx(4)                                                         stbf-062
      if (ivx(3).eq.0) jl=2*l                                           stbf-063
      if (lo(51)) write (mw,1000) ivx,kn,ireb,kr,y2,(va(i),i=2,11)      stbf-064
      a1=a4*a4                                                          stbf-065
      y1=va(3)*(va(2)-va(3))/va(2)                                      stbf-066
      y5=ck*y1*a1                                                       stbf-067
      a5=y2*y5                                                          stbf-068
      rr=dsqrt(dabs(a5))/a4                                             stbf-069
      x5=0.5d0*ck*ccz*y1*va(4)/rr                                       stbf-070
      if (va(1).gt.0.d0) go to 8                                        stbf-071
c matching of unbound functions                                         stbf-072
      idx=max0(idx,10*l+10)                                             stbf-073
      if (idx.gt.2*nx) call memo('stbf',nx,(idx+1)/2,2)                 stbf-074
      call fcou(l,x5,rr*a4*kn,xx(l+2,1),xx(2*l+3,1),xx(3*l+4,1),xx(4*l+5stbf-075
     1,1),iex,xx(5*l+6,1))                                              stbf-076
      z1=xx(2*l+2,1)                                                    stbf-077
      z2=xx(4*l+4,1)                                                    stbf-078
      call fcou(l,x5,rr*a4*(kn-2),xx(l+2,1),xx(2*l+3,1),xx(3*l+4,1),xx(4stbf-079
     1*l+5,1),iex,xx(5*l+6,1))                                          stbf-080
      z3=xx(2*l+2,1)                                                    stbf-081
      z4=xx(4*l+4,1)                                                    stbf-082
    8 x1=y3*va(11)                                                      stbf-083
      a3=y3*va(9)                                                       stbf-084
      y3=2.d0*va(8)*y5                                                  stbf-085
      y4=ivx(3)*(ivx(3)+2)-jl*(jl+2)+4*l*(l+1)                          stbf-086
      y4=.25d0*y4                                                       stbf-087
      a6=dfloat(l*(l+1))                                                stbf-088
      a6=a6*a1                                                          stbf-089
      x4=x5*2.d0*a1*rr                                                  stbf-090
      x3=0.d0                                                           stbf-091
      k=kn+1                                                            stbf-092
c computation of optical potentials                                     stbf-093
      do 10 i=1,k                                                       stbf-094
      x3=x3+a4                                                          stbf-095
      x2=dexp((x3-a3)/va(10))                                           stbf-096
      xx(2,i)=a6/(x3*x3)+y4*y3*x2/((1.d0+x2)**2*x3*va(10))+a5           stbf-097
      xx(3,i)=-1.d0/(1.d0+dexp((x3-a2)/va(7)))                          stbf-098
      if (x3.gt.x1) go to 9                                             stbf-099
      xx(2,i)=xx(2,i)+x4*(1.5d0-0.5d0*x3*x3/(x1*x1))/x1                 stbf-100
      go to 10                                                          stbf-101
    9 xx(2,i)=xx(2,i)+x4/x3                                             stbf-102
   10 continue                                                          stbf-103
      if (va(1).lt.0.d0) go to 15                                       stbf-104
c matching conditions                                                   stbf-105
      x1=(x3-a4)*rr                                                     stbf-106
      x3=x3*rr                                                          stbf-107
      a6=a6/a1                                                          stbf-108
      n=idint(5.d0*(x3-x1)+1.d0)                                        stbf-109
      y3=n                                                              stbf-110
      y3=(x3-x1)/y3                                                     stbf-111
      ig=idint(1.d0/y3)                                                 stbf-112
      jg=min0(100,ig)                                                   stbf-113
      a5=y3*y3                                                          stbf-114
      a3=1.d0                                                           stbf-115
      do 12 i=1,20                                                      stbf-116
      m=2*i*jg                                                          stbf-117
      a4=x3+y3*dfloat(m)                                                stbf-118
      y1=dexp(y3)                                                       stbf-119
      y4=0.5d0/y3+0.5d0                                                 stbf-120
      y2=(a6/(a4*a4)+2.d0*x5/a4+1.d0)*a5                                stbf-121
      do 11 j=1,m                                                       stbf-122
      y1=(2.d0+y2/(1.d0-y2/12.d0))-1.d0/y1                              stbf-123
      a2=y2                                                             stbf-124
      a4=a4-y3                                                          stbf-125
      y2=(a6/(a4*a4)+2.d0*x5/a4+1.d0)*a5                                stbf-126
      a1=y1*(1.d0-a2/12.d0)/(1.d0-y2/12.d0)                             stbf-127
   11 y4=y4/(a1*a1)+1.d0                                                stbf-128
      if (dabs(y1-a3).lt.0.1d-4*dabs(y1-1.d0)) go to 13                 stbf-129
   12 a3=y1                                                             stbf-130
      if (lo(51)) write (mw,1001)                                       stbf-131
   13 y4=(y4-0.5d0)*y3                                                  stbf-132
      if (lo(51)) write (mw,1002) i,m                                   stbf-133
      x2=1.d0/y1                                                        stbf-134
      x3=1.d0                                                           stbf-135
      x4=y2                                                             stbf-136
      do 14 i=1,n                                                       stbf-137
      x1=x2                                                             stbf-138
      x2=x3                                                             stbf-139
      x3=(2.d0+x4/(1.d0-x4/12.d0))*x2-x1                                stbf-140
      a4=a4-y3                                                          stbf-141
   14 x4=(a6/(a4*a4)+2.d0*x5/a4+1.d0)*a5                                stbf-142
      a3=x3*(1.d0-y2/12.d0)/(1.d0-x4/12.d0)                             stbf-143
      go to 16                                                          stbf-144
   15 kr=k                                                              stbf-145
   16 ks=idint(2.d0+dsqrt(a6/12.d0))                                    stbf-146
c starting values                                                       stbf-147
      do 17 i=1,ks                                                      stbf-148
   17 xx(1,i)=0.d0                                                      stbf-149
      xx(1,ks)=1.d0                                                     stbf-150
      if (l.eq.1) xx(1,ks-1)=-.2d0                                      stbf-151
      a4=va(5)                                                          stbf-152
      ik=2*ivx(1)                                                       stbf-153
      ist=0                                                             stbf-154
      x1=0.d0                                                           stbf-155
      y1=-1.d0                                                          stbf-156
      in1=0                                                             stbf-157
      in2=0                                                             stbf-158
c search for the eigenvalue                                             stbf-159
   18 x3=x1+a4                                                          stbf-160
   19 ist=ist+1                                                         stbf-161
      in3=0                                                             stbf-162
      x4=x3*y5                                                          stbf-163
c upwards integration                                                   stbf-164
      do 20 i=ks,kr                                                     stbf-165
      x5=x4*xx(3,i-1)+xx(2,i-1)                                         stbf-166
      xx(1,i+1)=(2.d0+x5/(1.d0-x5/12.d0))*xx(1,i)-xx(1,i-1)             stbf-167
      if (xx(1,i+1)*xx(1,i).lt.0.d0) in3=in3+2                          stbf-168
   20 continue                                                          stbf-169
      if (va(1).lt.0.d0) go to 29                                       stbf-170
      a1=xx(1,kr)                                                       stbf-171
      a2=xx(1,kr+1)                                                     stbf-172
      xx(1,kn+2)=1.d0                                                   stbf-173
      xx(1,kn+1)=a3*(1.d0-(x4*xx(3,kn)+xx(2,kn))/12.d0)/(1.d0-(x4*xx(3,kstbf-174
     1n+1)+xx(2,kn+1))/12.d0)                                           stbf-175
c backwards integration                                                 stbf-176
      do 21 i=kr,kn                                                     stbf-177
      j=kn+kr-i                                                         stbf-178
      x5=x4*xx(3,j)+xx(2,j)                                             stbf-179
      if (xx(1,j+1)*xx(1,j+2).lt.0.d0) in3=in3+2                        stbf-180
   21 xx(1,j)=(2.d0+x5/(1.d0-x5/12.d0))*xx(1,j+1)-xx(1,j+2)             stbf-181
      y3=a1/a2-xx(1,kr)/xx(1,kr+1)                                      stbf-182
      if (y3.gt.0.d0) in3=in3+1                                         stbf-183
      if (lo(51)) write (mw,1003) ist,in3,x3,y3                         stbf-184
      if (dabs(y3).le.1.d-10.or.x2.eq.x3.or.x1.eq.x3) go to 27          stbf-185
      if (in2.ne.0) go to 24                                            stbf-186
      if (in3.gt.ik) go to 22                                           stbf-187
      y1=y3                                                             stbf-188
      x1=x3                                                             stbf-189
      in1=in3                                                           stbf-190
      a4=x1                                                             stbf-191
      go to 18                                                          stbf-192
   22 if (lo(51)) write (mw,1004) ik,in1,in3                            stbf-193
      x2=x3                                                             stbf-194
      in2=in3                                                           stbf-195
      y2=y3                                                             stbf-196
c interpolation of solution                                             stbf-197
   23 x3=x1+0.5d0*(x2-x1)                                               stbf-198
      if (in2.eq.in1+1) x3=(y1*x2-y2*x1)/(y1-y2)                        stbf-199
      go to 19                                                          stbf-200
   24 x4=(y1*y2*x3*(x2-x1)+y1*y3*x2*(x1-x3)+y2*y3*x1*(x3-x2))/(y1*y2*(x2stbf-201
     1-x1)+y1*y3*(x1-x3)+y2*y3*(x3-x2))                                 stbf-202
      if (in2.gt.in1+2) x4=1.d20                                        stbf-203
      if (in3.gt.ik) go to 25                                           stbf-204
      x1=x3                                                             stbf-205
      y1=y3                                                             stbf-206
      in1=in3                                                           stbf-207
      go to 26                                                          stbf-208
   25 x2=x3                                                             stbf-209
      y2=y3                                                             stbf-210
      in2=in3                                                           stbf-211
   26 if ((x1-x4)*(x4-x2).lt.0.d0) go to 23                             stbf-212
      x3=x4                                                             stbf-213
      go to 19                                                          stbf-214
   27 y3=a1/xx(1,kr)                                                    stbf-215
      k=kn+2                                                            stbf-216
      do 28 i=kr,k                                                      stbf-217
   28 xx(1,i)=y3*xx(1,i)                                                stbf-218
   29 do 30 i=1,kn                                                      stbf-219
   30 xx(1,i)=(xx(1,i)+10.d0*xx(1,i+1)+xx(1,i+2))/12.d0                 stbf-220
      if (va(1).gt.0.d0) go to 31                                       stbf-221
      x1=xx(1,kn)*z4-xx(1,kn-2)*z2                                      stbf-222
      x2=xx(1,kn-2)*z1-xx(1,kn)*z3                                      stbf-223
      x3=z1*z4-z2*z3                                                    stbf-224
      y2=datan2(x2,x1)                                                  stbf-225
      y1=(x1**2+x2**2)/x3**2                                            stbf-226
      x3=va(5)                                                          stbf-227
      go to 33                                                          stbf-228
   31 y1=0.d0                                                           stbf-229
      do 32 i=1,kn                                                      stbf-230
   32 y1=y1+xx(1,i)**2                                                  stbf-231
      y1=y1-0.5d0*xx(1,kn)**2                                           stbf-232
      y2=y4*xx(1,kn)**2/rr                                              stbf-233
      y3=ireb                                                           stbf-234
      y1=y1*h/y3+y2                                                     stbf-235
      y2=100.d0*y2/y1                                                   stbf-236
   33 y1=1.d0/dsqrt(y1)                                                 stbf-237
      is=0                                                              stbf-238
      rr=0.d0                                                           stbf-239
      do 34 i=ireb,kn,ireb                                              stbf-240
      is=is+1                                                           stbf-241
      rr=rr+h                                                           stbf-242
   34 v(is)=y1*xx(1,i)/rr                                               stbf-243
      if (lo(51)) write (mw,1005) x3,y2,(is,v(is),is=1,ism)             stbf-244
      return                                                            stbf-245
 1000 format (//' woods-saxon potential eigenfunction with n =',i2,3x,'lstbf-246
     1 =',i3,3x,'2*s =',i2,3x,'2*j =',i3,3x,i4,' steps (divided by',i3,'stbf-247
     2) matching at the',i4,'th'/' **** binding energy',f12.6,' mev ****stbf-248
     3',4x,'total mass',f12.6,4x,'particle mass',f12.6,4x,'product of chstbf-249
     4arges',f8.2/' search on depth of real potential from',f12.6,' withstbf-250
     5 reduced radius',f10.6,' fermi and diffuseness',f10.6,' fermi'/' sstbf-251
     6pin-orbit potential depth:',f12.6,' mev radius:',f10.6,' fermi difstbf-252
     7fuseness:',f9.6,' fermi coulomb radius:',f10.6,' fermi')          stbf-253
 1001 format (10x,'no convergence on matching values')                  stbf-254
 1002 format (10x,'matching value obtained for i=',i3,' with',i6,' pointstbf-255
     1s')                                                               stbf-256
 1003 format (2x,i3,5x,'2*n (+0/1) =',i3,5x,'v =',d20.10,5x,'d =',d20.10stbf-257
     1)                                                                 stbf-258
 1004 format (' interpolation for 2*n =',i4,5x,'between',i4,' and',i4)  stbf-259
 1005 format (//' depth used',d20.10,' mev',15x,'tail percentage or phasstbf-260
     1e-shift',f10.5//(6(i6,d15.6)))                                    stbf-261
      end                                                               stbf-262
c 29/02/04                                                      ecis03  deri-000
      subroutine deri(x,y,h,n,lt)                                       deri-001
c numerical derivation of the function y known in n points with step h  deri-002
c it needs at least 7 points and returns in x the value of -d(y)/dr     deri-003
c if lt is false, the result is divided by r.                           deri-004
c***********************************************************************deri-005
      implicit real*8 (a-h,o-z)                                         deri-006
      logical lt                                                        deri-007
      common /inout/ mr,mw,ms                                           deri-008
      dimension x(7),y(7)                                               deri-009
      n3=n-3                                                            deri-010
      if (n3.ge.4) go to 1                                              deri-011
      write (mw,1000) n                                                 deri-012
      stop                                                              deri-013
    1 hh=-h*60.d0                                                       deri-014
      x(1)=(-147.d0*y(1)+360.d0*y(2)-450.d0*y(3)+400.d0*y(4)-225.d0*y(5)deri-015
     1+72.d0*y(6)-10.d0*y(7))/hh                                        deri-016
      x(2)=(-10.d0*y(1)-77.d0*y(2)+150.d0*y(3)-100.d0*y(4)+50.d0*y(5)-15deri-017
     1.d0*y(6)+2.d0*y(7))/hh                                            deri-018
      x(3)=(2.d0*y(1)-24.d0*y(2)-35.d0*y(3)+80.d0*y(4)-30.d0*y(5)+8.d0*yderi-019
     1(6)-y(7))/hh                                                      deri-020
      do 2 i=4,n3                                                       deri-021
    2 x(i)=(45.d0*(y(i+1)-y(i-1))-9.d0*(y(i+2)-y(i-2))+y(i+3)-y(i-3))/hhderi-022
      x(n-2)=(y(n-6)-8.d0*y(n-5)+30.d0*y(n-4)-80.d0*y(n3)+35.d0*y(n-2)+2deri-023
     14.d0*y(n-1)-2.d0*y(n))/hh                                         deri-024
      x(n-1)=(-2.d0*y(n-6)+15.d0*y(n-5)-50.d0*y(n-4)+100.d0*y(n3)-150.d0deri-025
     1*y(n-2)+77.d0*y(n-1)+10.d0*y(n))/hh                               deri-026
      x(n)=(10.d0*y(n-6)-72.d0*y(n-5)+225.d0*y(n-4)-400.d0*y(n3)+450.d0*deri-027
     1y(n-2)-360.d0*y(n-1)+147.d0*y(n))/hh                              deri-028
      if (lt) return                                                    deri-029
      r=0.d0                                                            deri-030
      do 3 i=1,n                                                        deri-031
      r=r+h                                                             deri-032
    3 x(i)=x(i)/r                                                       deri-033
      return                                                            deri-034
 1000 format (5x,i5,' points insufficient for derivation in deri'//10x,'deri-035
     1 ...  stop  ...')                                                 deri-036
      end                                                               deri-037
c 29/02/04                                                      ecis03  intp-000
      subroutine intp(i,ism,h,g,rr,v,lx)                                intp-001
c interpolation routine for radial form factors                         intp-002
c input variables: i:   number of points where the function is given    intp-003
c                  ism: number of points where the function is needed   intp-004
c                  h:   step size                                       intp-005
c                  g:   normalisation factor                            intp-006
c                  rr(2,1): radii (j=1) and values (j=2) to interpolate intp-007
c                  lx:  address of result in v                          intp-008
c output variable: v(i,lx) for i=1 to ism                               intp-009
c***********************************************************************intp-010
      implicit real*8 (a-h,o-z)                                         intp-011
      dimension rr(2,1),v(ism,1)                                        intp-012
      if (i.lt.4) go to 4                                               intp-013
      ir=1                                                              intp-014
      do 3 is=1,ism                                                     intp-015
      x0=is*h                                                           intp-016
    1 if (x0.lt.rr(1,ir+2)) go to 2                                     intp-017
      if (ir.ge.i-3) go to 2                                            intp-018
      ir=ir+1                                                           intp-019
      go to 1                                                           intp-020
    2 x1=(x0-rr(1,ir+1))*(x0-rr(1,ir+2))*(x0-rr(1,ir+3))/((rr(1,ir)-rr(1intp-021
     1,ir+1))*(rr(1,ir)-rr(1,ir+2))*(rr(1,ir)-rr(1,ir+3)))              intp-022
      x2=(x0-rr(1,ir))*(x0-rr(1,ir+2))*(x0-rr(1,ir+3))/((rr(1,ir+1)-rr(1intp-023
     1,ir))*(rr(1,ir+1)-rr(1,ir+2))*(rr(1,ir+1)-rr(1,ir+3)))            intp-024
      x3=(x0-rr(1,ir))*(x0-rr(1,ir+1))*(x0-rr(1,ir+3))/((rr(1,ir+2)-rr(1intp-025
     1,ir))*(rr(1,ir+2)-rr(1,ir+1))*(rr(1,ir+2)-rr(1,ir+3)))            intp-026
      x4=(x0-rr(1,ir))*(x0-rr(1,ir+1))*(x0-rr(1,ir+2))/((rr(1,ir+3)-rr(1intp-027
     1,ir))*(rr(1,ir+3)-rr(1,ir+1))*(rr(1,ir+3)-rr(1,ir+2)))            intp-028
    3 v(is,lx)=g*(x1*rr(2,ir)+x2*rr(2,ir+1)+x3*rr(2,ir+2)+x4*rr(2,ir+3))intp-029
      return                                                            intp-030
    4 do 5 is=1,ism                                                     intp-031
    5 v(is,lx)=0.d0                                                     intp-032
      return                                                            intp-033
      end                                                               intp-034
c 29/02/04                                                      ecis03  fold-000
      subroutine fold(v1,v2,val,nfo,ip,ism,ist,aconv,ivy,invz,fr,pgn,xgnfold-001
     1,wv,izz,lo)                                                       fold-002
c v1 are the potentials and form factors, unfolded as input, folded as  fold-003
c output. v2 are working fields in which 0. are stored before the call. fold-004
c input variables: val(i,j),i=1,3,j=1,nfo  folding parameters           fold-005
c                  nfo:    number of sets of folding parameters         fold-006
c                  ip:     potential to be folded if lo(7)=.false.      fold-007
c                  ism:    number of points                             fold-008
c                  ist:    maximum number of steps for folding functionsfold-009
c                  aconv:  value below which the folding is neglected   fold-010
c                  ivy:    table of form factors (see redm)             fold-011
c                  invz:   number of transition form factors to fold    fold-012
c                  pgn,xgn: 20-point gauss legendre integration         fold-013
c                  wv:     masses, wave numbers, step size (see calx)   fold-014
c                  lo(i):  logical controls (see calc)                  fold-015
c in common /pote1/  see redm                                           fold-016
c working fields:  fr(i,j),i=1,ist: gaussian or saxon folding functions fold-017
c          for j=1,imt.  for yukawa or hulthen folding: h-functions for fold-018
c          j=1,imt, j-functions for j=imt+1,2*imt; these functions are  fold-019
c          multiplied by r*r*exp(+\-r/va)                               fold-020
c          integrals with h and j-functions for j=2*imt+1,2*imt+2       fold-021
c                  izz(i,*) address of folding parameters below for i=1 fold-022
c                           type of form factor from 1 to 16 for i=2    fold-023
c                           angular momentum for i=3                    fold-024
c                           address of step size for i=4                fold-025
c                    (this part is an input with external form factors) fold-026
c folding conventions : val(*,1) real potential, val(*,2) imaginary one fold-027
c if val(1,*)=0  no folding                      val(*,3) coulomb       fold-028
c if val(3,*)=0 gaussian form factor with range val(2,*)                fold-029
c if val(2,*)=0 hulthen form factor with ranges val(1,*) and val(3,*)   fold-030
c if val(2,*)=val(3,*)=0 yukawa form factor with range val(1,*)         fold-031
c all other cases  saxon form factor with radius val(2,*) and diffuse-  fold-032
c ness val(3,*) - all form factors are normalised - val(1,*) is used    fold-033
c only for hulthen form factor                                          fold-034
c the diffuseness of a saxon form factor and the ranges of a hulthen or fold-035
c yukawa form factor are positive by taking the absolute value          fold-036
c***********************************************************************fold-037
      implicit real*8 (a-h,o-z)                                         fold-038
      dimension v1(ism,1),v2(ism,1),fr(ist,2),val(3,3),ivy(7,1),izz(4,1)fold-039
     1,mm(3),xgn(10),pgn(10),wv(18,1)                                   fold-040
      logical lo(250)                                                   fold-041
      common /pote1/ itx(16),imax,intc,inls,invc,invd,itxm              fold-042
      common /inout/ mr,mw,ms                                           fold-043
      data pim2 /6.2831853070d0/                                        fold-044
      ac=-dlog(aconv)                                                   fold-045
      jsl=ism+1                                                         fold-046
      itxn=itxm                                                         fold-047
      if (lo(100)) itxn=itxn-itx(2)                                     fold-048
      if (lo(7)) go to 9                                                fold-049
c initialisation of the table izz when potentials are not external      fold-050
      mm(1)=1                                                           fold-051
      mm(2)=2                                                           fold-052
      mm(3)=3                                                           fold-053
      if ((val(1,2).eq.val(1,1)).and.(val(2,2).eq.val(2,1)).and.(val(3,2fold-054
     1).eq.val(3,1))) mm(2)=1                                           fold-055
      if ((val(1,3).eq.val(1,2)).and.(val(2,3).eq.val(2,2)).and.(val(3,3fold-056
     1).eq.val(3,2))) mm(3)=2                                           fold-057
      if ((val(1,3).eq.val(1,1)).and.(val(2,3).eq.val(2,1)).and.(val(3,3fold-058
     1).eq.val(3,1))) mm(3)=1                                           fold-059
      nfox=max0(mm(1),mm(2),mm(3))                                      fold-060
      do 2 j=1,itxn                                                     fold-061
      do 1 i=1,3                                                        fold-062
    1 izz(i,j)=0                                                        fold-063
    2 izz(4,j)=ip                                                       fold-064
      do 3 i=1,8                                                        fold-065
      if ((i.eq.5).and.lo(201)) go to 3                                 fold-066
      if ((i.eq.6).and.lo(202)) go to 3                                 fold-067
      if ((i.eq.8).and.lo(203)) go to 3                                 fold-068
      m=mod(i+1,2)+1                                                    fold-069
      if (i.gt.6) m=3                                                   fold-070
      n=i                                                               fold-071
      if (lo(200)) n=1+itx(i)                                           fold-072
      izz(1,n)=-mm(m)                                                   fold-073
      izz(2,n)=i                                                        fold-074
    3 continue                                                          fold-075
      if (invz.eq.0) go to 9                                            fold-076
      ij=itx(3)-itx(7)                                                  fold-077
      do 8 j=1,intc                                                     fold-078
      do 7 i=1,8                                                        fold-079
      m=mod(i+1,2)+1                                                    fold-080
      n=i+ij                                                            fold-081
      if (i.gt.6) go to 5                                               fold-082
      if (i.gt.4) go to 4                                               fold-083
      if ((m.eq.2).and.lo(112)) go to 7                                 fold-084
      if (lo(200)) n=j+itx(i+8)                                         fold-085
      go to 6                                                           fold-086
    4 if (lo(108+i)) go to 7                                            fold-087
      if (lo(200)) n=ivy(3,j)+itx(i+8)                                  fold-088
      go to 6                                                           fold-089
    5 if (lo(55+8*i)) go to 7                                           fold-090
      if (lo(200)) n=itx(i+8)+ivy(i-3,j)                                fold-091
      m=3                                                               fold-092
    6 izz(1,n)=-mm(m)                                                   fold-093
      izz(2,n)=i+8                                                      fold-094
      izz(3,n)=ivy(7,j)                                                 fold-095
    7 continue                                                          fold-096
    8 ij=ij+11                                                          fold-097
c classification of step sizes                                          fold-098
    9 do 11 i=2,itxn                                                    fold-099
      if (izz(1,i).eq.0) go to 11                                       fold-100
      do 10 j=2,i                                                       fold-101
      if (izz(1,j-1).ne.izz(1,i)) go to 10                              fold-102
      if (izz(4,j-1).eq.izz(4,i)) go to 10                              fold-103
      i1=izz(4,i)                                                       fold-104
      j1=izz(4,j-1)                                                     fold-105
      if (wv(11,i1).ne.wv(11,j1)) go to 10                              fold-106
      izz(4,i)=j1                                                       fold-107
      go to 11                                                          fold-108
   10 continue                                                          fold-109
   11 continue                                                          fold-110
      nfot=-nfo                                                         fold-111
c for external potentials, add 1 for dummy folding                      fold-112
      if (lo(7)) nfox=nfo+1                                             fold-113
c loop on foldings                                                      fold-114
      do 64 ii=1,nfox                                                   fold-115
      if (ii.gt.nfo) go to 54                                           fold-116
      ic=0                                                              fold-117
      do 12 j=1,3                                                       fold-118
      if (val(j,ii).ne.0.d0) ic=ic+2**(3-j)                             fold-119
      if (val(j,ii).ge.0.d0) go to 12                                   fold-120
      write (mw,1000) val(j,ii),j,ii                                    fold-121
      val(j,ii)=-val(j,ii)                                              fold-122
   12 continue                                                          fold-123
      if (ic.lt.4) go to 64                                             fold-124
      ih=0                                                              fold-125
   13 imt=1                                                             fold-126
      jh=0                                                              fold-127
      kh=0                                                              fold-128
c separation of foldings with respect to the step size                  fold-129
      do 14 j=1,itxn                                                    fold-130
      if (izz(1,j)+ii.ne.0) go to 14                                    fold-131
      if (izz(4,j).lt.ih) go to 14                                      fold-132
      kh=kh+1                                                           fold-133
      if ((jh.ne.0).and.(izz(4,j).gt.ih)) go to 14                      fold-134
      jh=jh+1                                                           fold-135
      ih=izz(4,j)                                                       fold-136
      izz(1,j)=nfot-1                                                   fold-137
      imt=max0(imt,izz(3,j)+1)                                          fold-138
   14 continue                                                          fold-139
      if (jh.eq.0) go to 64                                             fold-140
      nfot=nfot-1                                                       fold-141
      h=wv(11,ih)                                                       fold-142
c computation of the strength of the folding functions                  fold-143
      cn=1.d0                                                           fold-144
      if (ic.gt.5) go to 15                                             fold-145
c yukawa folding                                                        fold-146
      if (val(3,ii).eq.val(1,ii)) val(3,ii)=.99d0*val(1,ii)             fold-147
      cn=h/(2.d0*pim2*(val(1,ii)**2-val(3,ii)**2))                      fold-148
      jst=ism+5                                                         fold-149
      go to 18                                                          fold-150
   15 if (ic.eq.7) go to 16                                             fold-151
c gaussian folding                                                      fold-152
      isy=1+idint(val(2,ii)*dsqrt(ac)/h)                                fold-153
      cn=h/(0.5d0*pim2*dsqrt(0.5d0*pim2)*val(2,ii)**3)                  fold-154
      go to 18                                                          fold-155
c saxon folding                                                         fold-156
   16 is=1+idint((val(2,ii)+10.d0*val(3,ii))/h)                         fold-157
      isy=1+idint((val(2,ii)+2.d0*val(3,ii)*ac)/h)                      fold-158
      cn=0.d0                                                           fold-159
      do 17 k=1,is                                                      fold-160
      rr=h*k                                                            fold-161
   17 cn=cn+rr*rr/(1.d0+dexp((rr-val(2,ii))/val(3,ii)))                 fold-162
      cn=.5d0/(pim2*cn)                                                 fold-163
c gaussian or saxon folding                                             fold-164
   18 an=dfloat(imt-1)                                                  fold-165
      if (ic.lt.6) go to 36                                             fold-166
c do loop on the points of potentials                                   fold-167
      fs=0.d0                                                           fold-168
      is=0                                                              fold-169
   19 is=is+1                                                           fold-170
      jst=is+isy                                                        fold-171
      jsm=min0(ism,jst)                                                 fold-172
      r=val(2,ii)                                                       fold-173
      a=val(3,ii)                                                       fold-174
      x1=h*dfloat(is)                                                   fold-175
      if (jst.le.ism) go to 20                                          fold-176
      jsz=max0(ism,1+is+2*idint((r+2.d0*a)/h))                          fold-177
      jst=min0(jst,jsz+4)                                               fold-178
      isz=jsz-1                                                         fold-179
      isx=jst-jsz                                                       fold-180
c loop on the points of the folding function for which the symmetry     fold-181
c between the two arguments is used                                     fold-182
   20 ji=is-1                                                           fold-183
   21 ji=ji+1                                                           fold-184
      a3=h*ji                                                           fold-185
      a4=2.d0*x1*a3                                                     fold-186
      y=x1*x1+a3*a3                                                     fold-187
      if (a.eq.0.d0) go to 25                                           fold-188
c saxon folding function  by a 20-points gaussian integration           fold-189
c the saxon form factor itself is the variable                          fold-190
      do 22 k=1,imt                                                     fold-191
   22 fr(ji,k)=0.d0                                                     fold-192
      r1=dmin1(70.d0,(dabs(x1-a3)-r)/a)                                 fold-193
      r2=dmin1(70.d0,(x1+a3-r)/a)                                       fold-194
      e1=1.d0/(1.d0+dexp(r1))                                           fold-195
      e2=1.d0/(1.d0+dexp(r2))                                           fold-196
      em=0.5d0*(e1+e2)                                                  fold-197
      es=0.5d0*(e1-e2)                                                  fold-198
      p1=es*2.d0*a*pim2/a4                                              fold-199
      do 24 ij=1,10                                                     fold-200
      pp=p1*pgn(ij)                                                     fold-201
      e1=1.d0/(em+es*xgn(ij))-1.d0                                      fold-202
      e2=1.d0/(em-es*xgn(ij))-1.d0                                      fold-203
      u1=r+a*dlog(e1)                                                   fold-204
      u2=r+a*dlog(e2)                                                   fold-205
      r1=pp*u1*(1.d0+e1)/e1                                             fold-206
      r2=pp*u2*(1.d0+e2)/e2                                             fold-207
      fr(ji,1)=fr(ji,1)+r1+r2                                           fold-208
      if (imt.eq.1) go to 24                                            fold-209
      e1=(y-u1*u1)/a4                                                   fold-210
      e2=(y-u2*u2)/a4                                                   fold-211
      r3=r1*e1                                                          fold-212
      r4=r2*e2                                                          fold-213
      fr(ji,2)=fr(ji,2)+r3+r4                                           fold-214
      if (imt.eq.2) go to 24                                            fold-215
c recurrence for legendre polynomials                                   fold-216
      do 23 k=3,imt                                                     fold-217
      r5=r1                                                             fold-218
      r6=r2                                                             fold-219
      r1=r3                                                             fold-220
      r2=r4                                                             fold-221
      r3=(dfloat(2*k-3)*r1*e1-r5*dfloat(k-2))/dfloat(k-1)               fold-222
      r4=(dfloat(2*k-3)*r2*e2-r6*dfloat(k-2))/dfloat(k-1)               fold-223
   23 fr(ji,k)=fr(ji,k)+r3+r4                                           fold-224
   24 continue                                                          fold-225
      go to 29                                                          fold-226
c gaussian folding function                                             fold-227
   25 a4=a4/(r*r)                                                       fold-228
      y=y/(r*r)                                                         fold-229
      b1=dexp(a4-y)                                                     fold-230
      b2=0.d0                                                           fold-231
      if (a4+y.lt.50.) b2=dexp(-a4-y)                                   fold-232
      dn=1.d0/a4                                                        fold-233
   26 fr(ji,1)=pim2*(b1-b2)*dn                                          fold-234
      if (imt.eq.1) go to 29                                            fold-235
c downwards recurrence for small arguments                              fold-236
      q=dmax1(dsqrt(10.5d0*a4)-0.5d0,an)                                fold-237
      k=idint(q+3.d0+21.d0*a4/(q+q+1.d0))                               fold-238
      a1=0.d0                                                           fold-239
   27 a1=a4/(2.d0*k+1.d0+a4*a1)                                         fold-240
      if (k.lt.imt) fr(ji,k+1)=a1                                       fold-241
      k=k-1                                                             fold-242
      if (k.gt.0) go to 27                                              fold-243
      do 28 k=2,imt                                                     fold-244
   28 fr(ji,k)=fr(ji,k)*fr(ji,k-1)                                      fold-245
   29 if (ic.lt.6) go to 39                                             fold-246
      if (ji.lt.jst) go to 21                                           fold-247
      ik=1                                                              fold-248
      go to 46                                                          fold-249
   30 ik=2                                                              fold-250
      if (jst.le.ism) go to 46                                          fold-251
c form the coulomb potentials,asymptotic correction                     fold-252
c the form factors are assumed to decrease as (r)**(-l-1)               fold-253
      a1=dfloat(ism)                                                    fold-254
      do 32 i=jsl,jst                                                   fold-255
      y=a1/dfloat(i)                                                    fold-256
      a4=dfloat(ism*i)*h**2                                             fold-257
      do 31 j=1,imt                                                     fold-258
      fr(i,j)=fr(i,j)*a4                                                fold-259
   31 a4=a4*y                                                           fold-260
   32 continue                                                          fold-261
c correction of the last value by sum between ism and jsz and a pade    fold-262
c approximation limited to four terms (between jsz+1 and jst)           fold-263
      do 35 i=1,imt                                                     fold-264
      a1=0.d0                                                           fold-265
      a2=0.d0                                                           fold-266
      a3=0.d0                                                           fold-267
      a4=0.d0                                                           fold-268
      y=0.d0                                                            fold-269
      if (jsl.gt.isz) go to 34                                          fold-270
      do 33 j=jsl,isz                                                   fold-271
   33 y=y+fr(j,i)                                                       fold-272
   34 if (isx.eq.0.or.fr(jsz,i).eq.0.d0) go to 35                       fold-273
      a1=-fr(jsz+1,i)/fr(jsz,i)                                         fold-274
      if (isx.eq.1.or.fr(jsz+1,i).eq.0.d0) go to 35                     fold-275
      b1=fr(jsz+2,i)/fr(jsz+1,i)                                        fold-276
      a2=-a1-b1                                                         fold-277
      if (isx.eq.2.or.a2.eq.0.d0) go to 35                              fold-278
      b2=fr(jsz+3,i)/fr(jsz+1,i)                                        fold-279
      c1=-(b1*a1+b2)/a2                                                 fold-280
      a3=b1-c1                                                          fold-281
      if (isx.eq.3.or.a3.eq.0.d0) go to 35                              fold-282
      a4=c1-(b2+(b2*a1+fr(jsz+4,i)/fr(jsz+1,i))/a2)/a3                  fold-283
   35 fr(jsl,i)=y+fr(jsz,i)/(1.d0+a1/(1.d0+a2/(1.d0+a3/(1.d0+a4))))     fold-284
      go to 46                                                          fold-285
c loop on the two yukawa form factors                                   fold-286
   36 fs=1.d0                                                           fold-287
      va=val(1,ii)                                                      fold-288
   37 if (va.eq.0.d0) go to 53                                          fold-289
c computation of bessel functions multiplied by r*r and exp(r/va)       fold-290
      ji=0                                                              fold-291
      b1=1.d0                                                           fold-292
      b2=1.d0                                                           fold-293
      b4=dexp(-h/va)                                                    fold-294
   38 ji=ji+1                                                           fold-295
      a2=h*dfloat(ji)                                                   fold-296
      a4=a2/va                                                          fold-297
      b2=b2*b4**2                                                       fold-298
      fr(ji,imt+1)=fs*a2                                                fold-299
      dn=a2*va                                                          fold-300
      go to 26                                                          fold-301
c upwards recurrence for the irregular function                         fold-302
   39 fr(ji,imt+2)=fr(ji,imt+1)*(1.d0+1.d0/a4)                          fold-303
      if (imt.eq.2) go to 41                                            fold-304
      do 40 k=3,imt                                                     fold-305
   40 fr(ji,k+imt)=fr(ji,k-2+imt)+fr(ji,k-1+imt)*(2*k-3)/a4             fold-306
   41 if (ji.lt.jst) go to 38                                           fold-307
c corrections for singular first derivative (yukawa form factor)        fold-308
      vr=-fs*h*pim2/6.d0                                                fold-309
      ik=1                                                              fold-310
      go to 46                                                          fold-311
c correction for coulomb potentials                                     fold-312
   42 a6=dfloat(ism)                                                    fold-313
      do 44 i=jsl,jst                                                   fold-314
      y=a6/dfloat(i)                                                    fold-315
      a1=y                                                              fold-316
      do 43 j=1,imt                                                     fold-317
      fr(i,j+imt)=fr(i,j+imt)*a1                                        fold-318
   43 a1=a1*y                                                           fold-319
   44 continue                                                          fold-320
c estimation of the last value by a pade of four terms                  fold-321
      do 45 i=1,imt                                                     fold-322
      a6=-fr(jsl+1,i+imt)/fr(jsl,i+imt)                                 fold-323
      if (i.eq.1) go to 45                                              fold-324
      b2=fr(jsl+2,i+imt)/fr(jsl+1,i+imt)                                fold-325
      a2=-a6-b2                                                         fold-326
      b3=fr(jsl+3,i+imt)/fr(jsl+1,i+imt)                                fold-327
      c1=-(b2*a6+b3)/a2                                                 fold-328
      a4=b2-c1                                                          fold-329
      a1=c1-(b3+(b3*a6+fr(jsl+4,i+imt)/fr(jsl+1,i+imt))/a2)/a4          fold-330
      a6=a6/(1.d0+b4*a2/(1.d0+b4*a4/(1.d0+b4*a1)))                      fold-331
   45 fr(jsl,i+imt)=fr(jsl,i+imt)/(1.d0+b4*a6)                          fold-332
      ik=2                                                              fold-333
c folding of the potentials                                             fold-334
   46 do 51 k=1,itxn                                                    fold-335
      if (izz(1,k).ne.nfot) go to 51                                    fold-336
      if ((ik.eq.1).and.mod(izz(2,k),8).gt.6) go to 51                  fold-337
      if ((ik.eq.2).and.mod(izz(2,k),8).le.6) go to 51                  fold-338
      n=izz(3,k)+1                                                      fold-339
      if (ic.lt.6) go to 48                                             fold-340
      do 47 js=is,jsm                                                   fold-341
      b1=(h*dfloat(js))**2                                              fold-342
      if (js.eq.is) go to 47                                            fold-343
      v2(js,k)=v2(js,k)+v1(is,k)*fr(js,n)*x1**2                         fold-344
   47 v2(is,k)=v2(is,k)+v1(js,k)*fr(js,n)*b1                            fold-345
      if ((ik.eq.2).and.(jst.gt.ism)) v2(is,k)=v2(is,k)+v1(ism,k)*fr(jslfold-346
     1,n)                                                               fold-347
      go to 51                                                          fold-348
   48 b2=0.d0                                                           fold-349
      b3=fr(jsl,n+imt)*v1(ism,k)                                        fold-350
      do 49 is=1,ism                                                    fold-351
      js=jsl-is                                                         fold-352
      fr(js,2*imt+1)=b3*b4                                              fold-353
      b2=b2*b4+fr(is,n)*v1(is,k)                                        fold-354
      b3=b3*b4+fr(js,n+imt)*v1(js,k)                                    fold-355
   49 fr(is,2*imt+2)=b2                                                 fold-356
      do 50 is=1,ism                                                    fold-357
      rr=(is*h)**2                                                      fold-358
   50 v2(is,k)=v2(is,k)+(fr(is,n)*fr(is,2*imt+1)+fr(is,n+imt)*fr(is,2*imfold-359
     1t+2))/rr+v1(is,k)*vr                                              fold-360
   51 continue                                                          fold-361
      if (ic.lt.6) go to 52                                             fold-362
      if (ik.eq.1) go to 30                                             fold-363
      if (is.lt.ism) go to 19                                           fold-364
   52 if (ik.eq.1) go to 42                                             fold-365
   53 fs=-fs                                                            fold-366
      if (fs.ge.0.d0) go to 55                                          fold-367
      va=val(3,ii)                                                      fold-368
      go to 37                                                          fold-369
c transfer of potentials from working space                             fold-370
   54 nfot=1                                                            fold-371
   55 do 63 j=1,itxn                                                    fold-372
      if (izz(1,j).ne.nfot) go to 63                                    fold-373
      if (nfot.eq.1) go to 57                                           fold-374
      do 56 is=1,ism                                                    fold-375
   56 v1(is,j)=cn*v2(is,j)                                              fold-376
      go to 58                                                          fold-377
c step size for dummy folding                                           fold-378
   57 ih=izz(4,j)                                                       fold-379
      h=wv(11,ih)                                                       fold-380
   58 if (lo(200).or.(izz(2,j).gt.8)) go to 59                          fold-381
      call deri(v1(1,j+8),v1(1,j),h,ism,.true.)                         fold-382
      call deri(v1(1,j+16),v1(1,j+8),h,ism,.true.)                      fold-383
      go to 63                                                          fold-384
   59 ix=mod(izz(2,j)-1,8)+1                                            fold-385
      if ((ix.lt.5).or.(ix.eq.7)) go to 63                              fold-386
      iml=0                                                             fold-387
      inl=0                                                             fold-388
      if (lo(100)) go to 60                                             fold-389
      if (izz(2,j).le.8) go to 61                                       fold-390
      inl=inls                                                          fold-391
      if (ix.eq.8) inl=invd                                             fold-392
      go to 61                                                          fold-393
   60 if (izz(2,j).le.8) go to 63                                       fold-394
      iml=4                                                             fold-395
      if (ix.eq.8) iml=3                                                fold-396
   61 call deri(v2(1,j),v1(1,j),h,ism,lo(100))                          fold-397
      do 62 is=1,ism                                                    fold-398
      if (inl.eq.0) go to 62                                            fold-399
      ay=dfloat(is)*h                                                   fold-400
      v1(is,j+inl)=-v1(is,j)/ay**2                                      fold-401
   62 v1(is,j+iml)=v2(is,j)                                             fold-402
   63 continue                                                          fold-403
      if (kh.ne.jh.and.nfot.ne.1) go to 13                              fold-404
   64 continue                                                          fold-405
      return                                                            fold-406
 1000 format (' negative value',d15.5,4x,'of folding parameter val(',i3,fold-407
     1',',i3,')')                                                       fold-408
      end                                                               fold-409
c 29/02/04                                                      ecis03  tlnc-000
      subroutine tlnc(hh,ipix,wvx,tl,ism,x,ff,lm,nn,dd,il,v,vco,lo)     tlnc-001
c transmission coefficients of uncoupled states for compound nucleus    tlnc-002
c input variables: hh:        step size for the ground state            tlnc-003
c                  ipix,wvx:  ipi and wv for this state (see calx)      tlnc-004
c                  ism:       number of steps                           tlnc-005
c                  lm:        number of coulomb functions needed        tlnc-006
c                  il:        length of working space                   tlnc-007
c                  v:         potentials real and imaginary             tlnc-008
c                  vco:       strength of long range coulomb correction tlnc-009
c                  lo:        logical controls                          tlnc-010
c output variables:tl:     transmission coefficients of uncoupled levelstlnc-011
c working space:   x:      for the integration                          tlnc-012
c                  ff:     for coulomb functions and corrections        tlnc-013
c                  nn:     needed by subroutine fcou                    tlnc-014
c                  dd:     needed by subroutine cori                    tlnc-015
c***********************************************************************tlnc-016
      implicit real*8 (a-h,o-z)                                         tlnc-017
      logical lo(250)                                                   tlnc-018
      dimension ipix(10),v(ism,4),nn(1),vco(2),wvx(18),x(2,2),ff(lm,6),dtlnc-019
     1d(200),fam(7),b(4),g(4),av(5),tl(1)                               tlnc-020
      if (wvx(3).le.0.d0) return                                        tlnc-021
      j=1                                                               tlnc-022
      call fcou(ipix(10),wvx(5),ism*wvx(11)*wvx(9),ff,ff(1,2),ff(1,3),fftlnc-023
     1(1,4),nn,ff(1,5))                                                 tlnc-024
      jc=0                                                              tlnc-025
      if (lo(203).and.lo(144)) go to 1                                  tlnc-026
      jc=5                                                              tlnc-027
      call cori(wvx(5),wvx(5),wvx(9),wvx(9),ism*wvx(11),dd,ff(1,5),ff(1,tlnc-028
     15),ff,ff,dd(200),lm,lm,il,lm,ff(1,6))                             tlnc-029
    1 l=ipix(10)+1                                                      tlnc-030
      if (l.le.0) return                                                tlnc-031
      ij=ipix(2)                                                        tlnc-032
      do 17 lj=1,l                                                      tlnc-033
      do 16 jl=1,ij                                                     tlnc-034
      jj=2*(lj+jl)-ij-3                                                 tlnc-035
      j=j+1                                                             tlnc-036
      tl(j)=0.d0                                                        tlnc-037
      if (jj.lt.ij+1-2*lj) go to 16                                     tlnc-038
      l1=lj-1                                                           tlnc-039
      fam(5)=dfloat(lj*(lj-1))                                          tlnc-040
      fam(6)=.25d0*dfloat(jj*(jj+2)-ij*ij+1)-fam(5)                     tlnc-041
c values of long range tails of central potentials                      tlnc-042
      f2=vco(1)**2                                                      tlnc-043
      f3=vco(2)*fam(6)                                                  tlnc-044
      if (wvx(3).gt.0.d0.and.jc.gt.0) go to 2                           tlnc-045
      f2=0.d0                                                           tlnc-046
      f3=0.d0                                                           tlnc-047
c integration region - set up of potential in five points for           tlnc-048
c transformation of matching values                                     tlnc-049
    2 b1=hh*hh/48.d0                                                    tlnc-050
      c1=dfloat(ism-1)*hh                                               tlnc-051
      a1=wvx(9)**2                                                      tlnc-052
      if (wvx(3).lt.0.d0) a1=-a1                                        tlnc-053
      do 3 k=1,5                                                        tlnc-054
      av(k)=b1*(2.d0*wvx(9)*wvx(5)/c1-a1+(fam(5)-f2-f3/c1)/c1**2)       tlnc-055
    3 c1=c1+0.5d0*hh                                                    tlnc-056
c computation of coulomb corrections                                    tlnc-057
      do 4 k=1,4                                                        tlnc-058
    4 b(k)=ff(l1+1,k)                                                   tlnc-059
      if (jc.le.0) go to 8                                              tlnc-060
      if (wvx(5).ne.0.d0) go to 5                                       tlnc-061
      f2=f3*wvx(9)                                                      tlnc-062
      f3=0.d0                                                           tlnc-063
    5 do 6 k=1,4                                                        tlnc-064
    6 g(k)=-ff(l1+1,k+jc)*f2                                            tlnc-065
      if (f3.eq.0.d0) go to 7                                           tlnc-066
      b1=2.d0*wvx(5)*dfloat(l1*(l1+1))                                  tlnc-067
      b2=dfloat(l1+1)**2+wvx(5)**2                                      tlnc-068
      c1=-(dfloat(2*l1+1)*b2+2*wvx(5)**2)/b1                            tlnc-069
      c2=dfloat(2*l1+3)*b2/b1                                           tlnc-070
      a1=dfloat(ism)*wvx(11)*wvx(9)                                     tlnc-071
      d1=(b2+dfloat(l1+1)*wvx(5)/a1)/a1/b1                              tlnc-072
      d2=-wvx(5)*dsqrt(b2)/b1/a1                                        tlnc-073
      a1=b2/b1/a1                                                       tlnc-074
      a3=f3*wvx(9)                                                      tlnc-075
      g(1)=g(1)-a3*(c1*ff(l1+1,1+jc)+c2*ff(l1+2,1+jc)-d1*ff(l1+1,1)**   tlnc-076
     12-d2*2.d0*ff(l1+1,1)*ff(l1+2,1)-a1*ff(l1+2,1)**2)                 tlnc-077
      g(2)=g(2)-a3*(c1*ff(l1+1,2+jc)+c2*ff(l1+2,2+jc)-d1*ff(l1+1,1)*f   tlnc-078
     1f(l1+1,3)-d2*(ff(l1+1,1)*ff(l1+2,3)+ff(l1+2,1)*ff(l1+1            tlnc-079
     2,3))-a1*ff(l1+2,1)*ff(l1+2,3))                                    tlnc-080
      g(4)=g(4)-a3*(c1*ff(l1+1,4+jc)+c2*ff(l1+2,4+jc)-d1*ff(l1+1,3)**   tlnc-081
     12-d2*2.d0*ff(l1+1,3)*ff(l1+2,3)-a1*ff(l1+2,3)**2)                 tlnc-082
    7 a4=1.d0+(g(1)*g(4)-g(2)**2)                                       tlnc-083
      g(3)=b(1)                                                         tlnc-084
      b(1)=(b(1)*(1.d0-g(2))+g(1)*b(3))/a4                              tlnc-085
      b(3)=(-g(3)*g(4)+(1.d0+g(2))*b(3))/a4                             tlnc-086
      g(3)=b(2)                                                         tlnc-087
      b(2)=(b(2)*(1.d0-g(2))+g(1)*b(4))/a4                              tlnc-088
      b(4)=(-g(3)*g(4)+(1.d0+g(2))*b(4))/a4                             tlnc-089
    8 a1=(1.d0-av(2))/(2.d0+10.d0*av(2))                                tlnc-090
      b1=(1.d0-av(4))/(2.d0+10.d0*av(4))                                tlnc-091
      a2=a1*(1.d0-av(1))/(1.d0-4.d0*av(1))                              tlnc-092
      b2=b1*(1.d0-av(5))/(1.d0-4.d0*av(5))                              tlnc-093
      c1=(2.d0+10.d0*av(3))-(1.d0-av(3))*(a1+b1)                        tlnc-094
      a1=(16.d0-144.d0*av(2))/(2.d0+10.d0*av(2))                        tlnc-095
      b1=(16.d0-144.d0*av(4))/(2.d0+10.d0*av(4))                        tlnc-096
      c2=(7.d0+a1*(1.d0-av(1)))/(1.d0-4.d0*av(1))                       tlnc-097
      d2=(7.d0+b1*(1.d0-av(5)))/(1.d0-4.d0*av(5))                       tlnc-098
      d1=(b1-a1)*(1.d0-av(3))                                           tlnc-099
      a1=a2*d2+b2*c2                                                    tlnc-100
      b1=(c1*d2+d1*b2)/a1                                               tlnc-101
      b2=30.d0*hh*b2*wvx(9)/a1                                          tlnc-102
      fam(1)=b1*b(1)-b2*b(2)                                            tlnc-103
      fam(3)=b1*b(3)-b2*b(4)                                            tlnc-104
      b1=(c2*c1-a2*d1)/a1                                               tlnc-105
      a2=-30.d0*hh*a2*wvx(9)/a1                                         tlnc-106
      fam(2)=b1*b(1)-a2*b(2)                                            tlnc-107
      fam(4)=b1*b(3)-a2*b(4)                                            tlnc-108
      fam(7)=wvx(8)**2                                                  tlnc-109
      fam(6)=2.d0*fam(7)*fam(6)                                         tlnc-110
c computation of the regular solution                                   tlnc-111
      do 9 is=1,ism                                                     tlnc-112
      a1=is*is                                                          tlnc-113
      x(1,is+2)=wvx(10)-fam(5)/a1+fam(7)*v(is,1)                        tlnc-114
      x(2,is+2)=fam(7)*v(is,2)                                          tlnc-115
      if (lo(229)) x(1,is+2)=x(1,is+2)+fam(6)*v(is,3)                   tlnc-116
      if (lo(230)) x(2,is+2)=x(2,is+2)+fam(6)*v(is,4)                   tlnc-117
    9 continue                                                          tlnc-118
      if (lo(27)) go to 11                                              tlnc-119
c modified numerov method                                               tlnc-120
      do 10 is=1,ism                                                    tlnc-121
      a1=x(1,is+2)**2-x(2,is+2)**2                                      tlnc-122
      if (lo(26)) a1=a1*(1.d0-x(1,is+2)*.033333333333333d0)             tlnc-123
      x(2,is+2)=x(2,is+2)*(1.d0-x(1,is+2)*.166666666666667d0)           tlnc-124
   10 x(1,is+2)=x(1,is+2)-a1*.083333333333333d0                         tlnc-125
      go to 13                                                          tlnc-126
c numerov method                                                        tlnc-127
   11 do 12 is=1,ism                                                    tlnc-128
      a2=(12.d0+x(1,is+2))**2+x(2,is+2)**2                              tlnc-129
      a1=12.d0*(x(1,is+2)*(12.d0+x(1,is+2))+x(2,is+2)**2)/a2            tlnc-130
      if (lo(26)) a1=a1*(1.d0+x(1,is+2)**2*.416666666666667d-2)         tlnc-131
      x(1,is+2)=a1                                                      tlnc-132
   12 x(2,is+2)=144.d0*x(2,is+2)/a2                                     tlnc-133
   13 x(1,1)=0.d0                                                       tlnc-134
      x(2,1)=0.d0                                                       tlnc-135
      x(1,2)=1.d-15                                                     tlnc-136
      x(2,2)=0.d0                                                       tlnc-137
      do 15 is=1,ism                                                    tlnc-138
      b1=x(1,is+1)*x(1,is+2)-x(2,is+1)*x(2,is+2)                        tlnc-139
      b2=x(2,is+1)*x(1,is+2)+x(1,is+1)*x(2,is+2)                        tlnc-140
      x(1,is+2)=x(1,is+1)+x(1,is+1)-x(1,is)-b1                          tlnc-141
      x(2,is+2)=x(2,is+1)+x(2,is+1)-x(2,is)-b2                          tlnc-142
      if (dabs(x(1,is+2)).lt.1.d15) go to 15                            tlnc-143
c renormalisation of large function values                              tlnc-144
      js=2*is+4                                                         tlnc-145
      do 14 i=3,js                                                      tlnc-146
   14 x(i,1)=x(i,1)*1.d-30                                              tlnc-147
   15 continue                                                          tlnc-148
c end of integration                                                    tlnc-149
c matching                                                              tlnc-150
      a1=x(1,ism)*fam(4)-fam(3)*x(1,ism+2)                              tlnc-151
      a2=x(2,ism)*fam(4)-fam(3)*x(2,ism+2)                              tlnc-152
      b1=x(1,ism)*fam(2)-fam(1)*x(1,ism+2)                              tlnc-153
      b2=x(2,ism)*fam(2)-fam(1)*x(2,ism+2)                              tlnc-154
      a2=a2+b1                                                          tlnc-155
      a1=a1-b2                                                          tlnc-156
      a3=a1*a1+a2*a2                                                    tlnc-157
      a1=-a1/a3                                                         tlnc-158
      a2=a2/a3                                                          tlnc-159
      fam(7)=a1*b1-a2*b2                                                tlnc-160
      fam(6)=b1*a2+b2*a1                                                tlnc-161
      tl(j)=dmax1(0.d0,4.d0*(fam(6)-fam(7)**2-fam(6)**2))               tlnc-162
   16 continue                                                          tlnc-163
   17 continue                                                          tlnc-164
      return                                                            tlnc-165
      end                                                               tlnc-166
c 29/02/04                                                      ecis03  quan-000
      subroutine quan(ncoll,wv,ipi,niv,iq,tq,ivq,ivz,mc,nat,at,it,nvi,kaquan-001
     1b,kbc,aa,fac,nfa,nmax,id,lo)                                      quan-002
c input variables: ncoll:   number of coupled nuclear states            quan-003
c                  wv:      see calx                                    quan-004
c                  ipi:     projectile and target multiplicity, parity  quan-005
c                           and maximum angular momentum.  see calx     quan-006
c                  niv(i1,i2,1/2): first/last address in the table of   quan-007
c                           reduced nuclear matrix elements. see redm   quan-008
c                  iq,tq:   table of reduced nuclear matrix elements    quan-009
c                  ivq(i):  table of multipoles.   see redm             quan-010
c                  ivz(i):  table of form factors.   see redm           quan-011
c                  kab:     maximum number of coupled channels          quan-012
c                  kbc:     maximum number of solutions                 quan-013
c                  fac:     table of logarithms of factorials           quan-014
c                  nfa:     length of fac                               quan-015
c                  nmax:  available length of at/nat(less 100 for 9j)   quan-016
c                  id:      first dimension of tables nat and at        quan-017
c                  lo(i):   logical controls. see comments in calc      quan-018
c in common /ncomp/  parametrisation of the deformed spin-orbit         quan-019
c in common /pote2/ity(5):  number of diagonal potentials               quan-020
c                  intv:    number of non spin-orbit form factors       quan-021
c                  insl:    number of spin-orbit form factors           quan-022
c in common /noequ/jpi:     channel parity (0/1)                        quan-023
c                  naj:     twice channel spin                          quan-024
c output variables:mc(ic,1): nuclear state numbers, ic = 1,nc           quan-025
c                  mc(ic,2): orbital momentum                           quan-026
c                  mc(ic,3): twice orbital spin                         quan-027
c                  mc(ic,4): reference to potential or copy             quan-028
c                  mc(ic,5): lc*(lc+1)                                  quan-029
c                  mc(ic,6): eigenvalue of l.s                          quan-030
c                  at(id,i),nat(id,i) in equivalence by call            quan-031
c                       table of coupling coefficients for i=1,it       quan-032
c                    nat(1,i)  address of the form factor, negative for quan-033
c                        a complex term                                 quan-034
c                    at(2,i)  geometrical coefficient                   quan-035
c                    at(3,i)  idem for small components (dirac equation)quan-036
c                  it: number of non zero coupling coefficients         quan-037
c                  nvi(i1,i2,1-3): address in the table at(i), analogousquan-038
c                    to the niv addresses: nvi(i1,i2,1) to nvi(i1,i2,2) quan-039
c                    for the non derivatives couplings, nvi(i1,i2,2)+1  quan-040
c                    to nvi(i1,i2,3)  for the derivative couplings      quan-041
c for identical particle and target, mc results are in mc(*,*+7)        quan-042
c    nat and at results are after the usual ones, nvi results are in    quan-043
c    nvi(*,*,*+3), nc and ncin are different from nic and nci.          quan-044
c    the coefficients of the symmetrisation are in aa.                  quan-045
c in common /noequ/nic:  number of equations at the channel spin        quan-046
c                  nci:  number of solutions                            quan-047
c                  nc:   number of equations for identical particles    quan-048
c                  ncin: number of solutions for identical particles    quan-049
c                  nin:  number of coupling potentials                  quan-050
c working space:   at(i,j):  for j>it, working space for dj9j           quan-051
c***********************************************************************quan-052
      implicit real*8 (a-h,o-z)                                         quan-053
      logical lo(250),llo                                               quan-054
      dimension niv(ncoll,ncoll,3),nvi(kab,kab,6),nat(2*id,4),at(id,4),mquan-055
     1c(kab,12),ivz(4,1),ipi(11,1),ivq(3,1),iq(6,1),tq(3,1),fac(1),wv(18quan-056
     2,1),aa(kbc,1)                                                     quan-057
      character*1 ip(2)                                                 quan-058
      common /ncomp/ nsp(12),acn(2),az1,az2,az3,az4,az5,az6,bz(12)      quan-059
      common /pote2/ ity(8),invt,intv,insl,npx                          quan-060
      common /noequ/ ncxn,nic,nci,nc,ncin,nin,jpi,ipj,r1(2),naj         quan-061
      common /inout/ mr,mw,ms                                           quan-062
      data ip /'+','-'/                                                 quan-063
c find quantum number of coupled channels                               quan-064
      nc=0                                                              quan-065
      aj=.5d0*dfloat(naj)                                               quan-066
      do 6 i=1,ncoll                                                    quan-067
      nj1=naj-ipi(3,i)+1                                                quan-068
      nj2=iabs(nj1)                                                     quan-069
      nj=ipi(3,i)                                                       quan-070
      nl=ipi(2,i)                                                       quan-071
      do 5 j=1,nj                                                       quan-072
      l1=(naj-nj-nl)/2+j                                                quan-073
      l2=iabs(l1)                                                       quan-074
      do 4 k=1,nl                                                       quan-075
      if (mod(l1+ipi(1,i)+jpi,2).ne.0) go to 3                          quan-076
      if ((l1.lt.l2).or.(nj1.lt.nj2).or.(l1.gt.ipi(10,i))) go to 3      quan-077
      nc=nc+1                                                           quan-078
      mc(nc,4)=ipi(11,i)                                                quan-079
      if (lo(228)) go to 2                                              quan-080
      if (lo(100)) mc(nc,4)=i                                           quan-081
      do 1 m=nc,kab                                                     quan-082
      if (mc(m,1).ne.i) go to 1                                         quan-083
      if (mc(m,2).ne.l1) go to 1                                        quan-084
      if (mc(m,3).ne.nj1) go to 1                                       quan-085
      mc(nc,4)=-m                                                       quan-086
      go to 2                                                           quan-087
    1 continue                                                          quan-088
    2 mc(nc,1)=i                                                        quan-089
      mc(nc,2)=l1                                                       quan-090
      mc(nc,3)=nj1                                                      quan-091
      mc(nc,5)=mc(nc,2)*(mc(nc,2)+1)                                    quan-092
      mc(nc,6)=((nj1-ipi(2,i)+1)*(nj1+ipi(2,i)+1))/4-mc(nc,5)           quan-093
    3 l1=l1+1                                                           quan-094
    4 continue                                                          quan-095
    5 nj1=nj1+2                                                         quan-096
      if (i.ne.1) go to 6                                               quan-097
      ncin=nc                                                           quan-098
      if (ncin.eq.0) return                                             quan-099
    6 continue                                                          quan-100
      if (lo(158)) go to 8                                              quan-101
      write (mw,1000) aj,ip(jpi+1),nc,ncin                              quan-102
      do 7 j=1,nc                                                       quan-103
      sj=0.5d0*dfloat(mc(j,3))                                          quan-104
    7 write (mw,1001) j,mc(j,1),mc(j,2),sj,mc(j,4),mc(j,5),mc(j,6)      quan-105
c computation of coupling coefficients for the form factors             quan-106
c when the spin-orbit is deformed,there is no symmetry, the total       quan-107
c table is calculated. with no spin-orbit deformation,only one half is  quan-108
c calculated. lo(210) returns .true. if they are derivative couplings   quan-109
    8 lo(210)=.false.                                                   quan-110
      it=0                                                              quan-111
      nin=0                                                             quan-112
      invz=intv+ity(5)                                                  quan-113
      do 41 i1=1,nc                                                     quan-114
      j1=mc(i1,1)                                                       quan-115
      k1=ipi(11,j1)                                                     quan-116
      if (lo(100)) k1=j1                                                quan-117
      if (lo(227)) mc(i1,4)=k1                                          quan-118
      do 40 i2=1,i1                                                     quan-119
      j2=mc(i2,1)                                                       quan-120
      a2=wv(8,j1)*wv(8,j2)                                              quan-121
      it1=it+1                                                          quan-122
      nvi(i2,i1,1)=it1                                                  quan-123
      k1=niv(j2,j1,1)                                                   quan-124
      k2=niv(j2,j1,2)                                                   quan-125
      if (k1.gt.k2) go to 32                                            quan-126
      if (2*(k2-k1+3+it).gt.nmax) call memo('quan',nmax,2*(k2-k1+3+it),2quan-127
     1)                                                                 quan-128
      il=2*mc(i2,2)                                                     quan-129
      ilp=2*mc(i1,2)                                                    quan-130
      isj=mc(i2,3)                                                      quan-131
      isjp=mc(i1,3)                                                     quan-132
      iai=ipi(3,j2)-1                                                   quan-133
      iaip=ipi(3,j1)-1                                                  quan-134
      is=ipi(2,j2)-1                                                    quan-135
      isp=ipi(2,j1)-1                                                   quan-136
      do 22 k=k1,k2                                                     quan-137
      ni=iq(2,k)                                                        quan-138
c coefficient of a central multipole with angular momentum iq=ivq(1,ni) quan-139
c transfer of spin is=ivq(2,ni)/2 and of total momentum ij=ivq(3,ni)/2  quan-140
c noting the spin s,the orbital angular momentum l,the total spin of thequan-141
c particle j,the spin of the target ai,the eigenvalue of l.s g......    quan-142
c and "k"=sqrt(2*k+1)   the most general expression of (i2||iq||i1) is  quan-143
c  (-)**(aj+ai2+1+j1+(l2+iq-l1)/2)*"l1"*"l2"*"j1"*"j2"*"iq"*"ij"*       quan-144
c cgs(iq,l2,l1)*c6j(j1,ij,j2,ai2,aj,ai1)*c9j(l2,l1,iq,s2,s1,is,j2,j1,ij)quan-145
c in a macroscopic model, is=0 and ij=iq, the expressions used are      quan-146
c  (-)**(aj+ai2+1-s+(l1+l2+iq)/2)*"l1"*"l2"*"j1"*"j2"*"iq"*cgs(iq,l2,l1)quan-147
c    *c6j(j1,iq,j2,ai2,aj,ai1)*c6j(l1,iq,l2,j2,s,j1)                    quan-148
c for s=1/2 (-)**(aj+ai2-j2+(l1-l2+iq)/2)*"iq"*cgs(iq,j2,j1)            quan-149
c for s=0   (-)**(aj+ai2+1+(l1+l2+iq)/2)*"l1"*"l2"*"iq"*cgs(iq,l2,l1)*  quan-150
c           c6j(l1,iq,l2,ai2,aj,ai1)                                    quan-151
      iiq=2*ivq(1,ni)                                                   quan-152
      do 16 ix=2,id                                                     quan-153
      cx=0.d0                                                           quan-154
      cmatel=0.d0                                                       quan-155
      if ((iiq.gt.il+ilp).or.(iiq.lt.iabs(il-ilp))) go to 13            quan-156
      fx=1.d0                                                           quan-157
      kk=mc(i1,2)+mc(i2,2)+ivq(1,ni)                                    quan-158
      iis=ivq(2,ni)                                                     quan-159
      if (iis.lt.0) go to 11                                            quan-160
      iij=ivq(3,ni)                                                     quan-161
      cmatel=dj6j(isj,iij,isjp,iaip,naj,iai,fac,nfa)                    quan-162
      a1=dfloat(iij+1)                                                  quan-163
      if (is.gt.1.or.iis.ne.0) go to 9                                  quan-164
      cmatel=cmatel*dcgs(iij,isjp,isj,fac,nfa)                          quan-165
      kk=kk+naj+iaip                                                    quan-166
      if (is.eq.1) kk=kk+2+il-isjp                                      quan-167
      if (is.ne.1) a1=a1*dfloat((isj+1)*(isjp+1))                       quan-168
      go to 12                                                          quan-169
    9 a1=a1*dfloat((il+1)*(ilp+1))                                      quan-170
      a1=a1*dfloat((isj+1)*(isjp+1))                                    quan-171
      kk=(naj+iaip-is)+kk                                               quan-172
      cmatel=cmatel*dcgs(iiq,ilp,il,fac,nfa)                            quan-173
      if (iis.ne.0) go to 10                                            quan-174
      fx=dj6j(il,isj,is,isjp,ilp,iij,fac,nfa)                           quan-175
      go to 12                                                          quan-176
   10 cmatel=cmatel*dj9j(il,ilp,iiq,is,isp,iis,isj,isjp,iij,at(1,it+1),1quan-177
     100)                                                               quan-178
      a1=a1*dfloat((iiq+1)*(iis+1))                                     quan-179
      kk=kk+isjp+ilp+is                                                 quan-180
      go to 12                                                          quan-181
c magnetic coulomb excitation of the particle:                          quan-182
   11 iij=iiq-2                                                         quan-183
      if (iiq.gt.il+ilp+2.or.iiq.lt.iabs(il-ilp)+2) go to 13            quan-184
      cmatel=dj6j(isj,isjp,iij,ilp,il,is,fac,nfa)*dj6j(isj,isjp,iiq-2,iaquan-185
     1ip,iai,naj,fac,nfa)*dcgs(iiq,ilp,il,fac,nfa)                      quan-186
      kk=kk+naj+iaip-is-2                                               quan-187
      a1=dfloat((iiq+1)**3)*dfloat((isj+1)*(isjp+1))*dfloat((il+1)*(ilp+quan-188
     11))*dfloat((il+ilp+iiq+2)*(il+ilp-iij))*(il-ilp+iiq)*(ilp-il+iiq)/quan-189
     2dfloat((iiq-1)*iij)**2/16.d0                                      quan-190
   12 if (mod(kk,4).eq.0) cmatel=-cmatel                                quan-191
      cmatel=tq(3,k)*cmatel*dsqrt(a1)                                   quan-192
      cx=cmatel*fx                                                      quan-193
   13 if (ix.eq.3) go to 14                                             quan-194
      it=it+1                                                           quan-195
      nat(1,it)=iq(1,k)                                                 quan-196
   14 at(ix,it)=cx*a2                                                   quan-197
      if (lo(200)) go to 17                                             quan-198
      if (ix.eq.3) go to 22                                             quan-199
      if (iiq.ne.iij) go to 15                                          quan-200
      at(3,it)=at(2,it)                                                 quan-201
      if (iis.ne.0) at(3,it)=-at(3,it)                                  quan-202
      go to 22                                                          quan-203
   15 il=2*isj-il                                                       quan-204
   16 ilp=2*isjp-ilp                                                    quan-205
   17 nat(1,it)=nat(1,it)+ity(5)                                        quan-206
      if (lo(12)) nat(1,it)=-nat(1,it)                                  quan-207
      if (iq(3,k).eq.0) go to 22                                        quan-208
c deformed spin-orbit                                                   quan-209
c form factor (1/r)(d/dr)v(r)         coefficient:  (i2||iq||i1)*g1     quan-210
c parametrisation:  (i2||iq||i1)*(az3*g1+az4*g2+az1)                    quan-211
      a=cx*(mc(i2,6)*az3+mc(i1,6)*az4+az1)                              quan-212
      if (dabs(a).lt.1.d-10) go to 18                                   quan-213
      it=it+1                                                           quan-214
      nat(1,it)=iq(3,k)+invz                                            quan-215
      if (lo(14)) nat(1,it)=-nat(1,it)                                  quan-216
      at(2,it)=2.d0*a*a2                                                quan-217
c form factor v(r)/r**2   coefficient: (i2||iq||i1)*(s*(iq*(iq+1)-l1*(l1quan-218
c   +1)-l2*(l2+1)+g2*(1+g1)/(2*s))+xxx)                                 quan-219
c parametrisation:   (i2||iq||i1)*az5*(s*(iq*(iq+1)*az2........         quan-220
c xxx is -sqrt(f1*f2)*c6j(l1,j1,s-1,j2,l2,iq)/(2*s*c6j(l1,j1,s,j2,l2,iq)quan-221
c  with f=(l*l+l-(j-s)*(j-s+1))*((j+s)*(j+s+1)-l*l-l)                   quan-222
c  for s=1/2  xxx=0                                                     quan-223
c  for s=1  xxx=-4*l1*l2*(l1+1)*(l2+1)/iq*iq+iq-l1*l1-l1-l2*l2-l2)      quan-224
c when j1=l1 and j2=l2 , else  xxx=0                                    quan-225
   18 azi=dfloat(ivq(1,ni)*(ivq(1,ni)+1))                               quan-226
      aspi=dfloat(is)                                                   quan-227
      smatel=(0.5d0*dfloat(ipi(2,j1)-1)*(az2*azi-dfloat(mc(i1,5)+mc(i2,5quan-228
     1)))+dfloat(mc(i1,6))*(1.d0+dfloat(mc(i2,6))/aspi))*fx             quan-229
      if (is-2) 21 , 19 , 20                                            quan-230
   19 if (il.ne.isj.or.ilp.ne.isjp) go to 21                            quan-231
      a1=azi-mc(i1,5)-mc(i2,5)                                          quan-232
      if (a1.eq.0.d0) go to 20                                          quan-233
      smatel=smatel-4.d0*dfloat(mc(i1,5)*mc(i2,5))*fx/a1                quan-234
      go to 21                                                          quan-235
   20 g1=dfloat((mc(i1,3)-ipi(2,j1))/2)                                 quan-236
      g2=dfloat((mc(i1,3)+ipi(2,j1))/2)                                 quan-237
      f1=(dfloat(mc(i1,5))-g1*(g1+1.d0))*(g2*(g2+1.d0)-dfloat(mc(i1,5)))quan-238
      g1=dfloat((mc(i2,3)-ipi(2,j1))/2)                                 quan-239
      g2=dfloat((mc(i2,3)+ipi(2,j1))/2)                                 quan-240
      f2=(dfloat(mc(i2,5))-g1*(g1+1.d0))*(g2*(g2+1.d0)-dfloat(mc(i2,5)))quan-241
      f3=f1*f2                                                          quan-242
      if (f3.gt.0.d0) smatel=smatel-dsqrt(f3)*dj6j(il,isj,is-2,isjp,ilp,quan-243
     1iiq,fac,nfa)/aspi                                                 quan-244
   21 a=cmatel*az5*smatel                                               quan-245
      if (dabs(a).lt.1.d-10) go to 22                                   quan-246
      it=it+1                                                           quan-247
      nat(1,it)=iq(3,k)+invz+insl                                       quan-248
      if (lo(14)) nat(1,it)=-nat(1,it)                                  quan-249
      at(2,it)=2.d0*a*a2                                                quan-250
   22 continue                                                          quan-251
      llo=.false.                                                       quan-252
   23 if (it-it1) 32 , 27 , 24                                          quan-253
c  summation of coefficients related to the same form factor            quan-254
   24 it2=it-1                                                          quan-255
      do 26 i=it1,it2                                                   quan-256
      do 25 j=i,it2                                                     quan-257
      if (nat(1,i).ne.nat(1,j+1)) go to 25                              quan-258
      at(2,i)=at(2,i)+at(2,j+1)                                         quan-259
      at(2,j+1)=0.d0                                                    quan-260
      if (lo(200)) go to 25                                             quan-261
      at(3,i)=at(3,i)+at(3,j+1)                                         quan-262
      at(3,j+1)=0.d0                                                    quan-263
   25 continue                                                          quan-264
   26 continue                                                          quan-265
c elimination of too small coefficients                                 quan-266
   27 it2=it                                                            quan-267
      it=it1-1                                                          quan-268
      nmr=0                                                             quan-269
      nmi=0                                                             quan-270
      do 28 i=it1,it2                                                   quan-271
      cx=dabs(at(2,i))                                                  quan-272
      if (lo(100)) cx=cx+dabs(at(3,i))                                  quan-273
      if (cx.lt.1.d-10) go to 28                                        quan-274
      it=it+1                                                           quan-275
      nat(1,it)=nat(1,i)                                                quan-276
      at(2,it)=at(2,i)                                                  quan-277
      if (lo(100)) at(3,it)=at(3,i)                                     quan-278
      nmr=nmr+1                                                         quan-279
      if (nat(1,it).lt.0) nmi=nmi+1                                     quan-280
   28 continue                                                          quan-281
      if (nmr.ne.0) nin=nin+1                                           quan-282
      if (nmi.ne.0) nin=nin+1                                           quan-283
      if (llo) go to 36                                                 quan-284
      if (lo(113).and.lo(119)) go to 32                                 quan-285
      nvi(i2,i1,2)=it                                                   quan-286
c coefficients of the derivative coupling                               quan-287
c form factor  v(r)/r**2  coefficient: (i2||iq||i1)*(g1-g2)             quan-288
c parametrisation: (i2||iq||i1)*(g1-g2)*az6                             quan-289
      it2=it                                                            quan-290
      if (lo(100)) go to 30                                             quan-291
      do 29 i=it1,it2                                                   quan-292
      if (iabs(nat(1,i)).gt.invz) go to 29                              quan-293
      ij=iabs(nat(1,i))-ity(5)                                          quan-294
      if (ivz(3,ij).eq.0) go to 29                                      quan-295
      a=at(2,i)*dfloat(mc(i2,6)-mc(i1,6))*az6*2.d0                      quan-296
      if (dabs(a).lt.1.d-10) go to 29                                   quan-297
      lo(210)=.true.                                                    quan-298
      it=it+1                                                           quan-299
      nat(1,it)=ivz(3,ij)+invz+insl                                     quan-300
      if (lo(14)) nat(1,it)=-nat(1,it)                                  quan-301
      at(2,it)=a                                                        quan-302
   29 continue                                                          quan-303
      go to 33                                                          quan-304
   30 do 31 i=it1,it2                                                   quan-305
      ij=nat(1,i)                                                       quan-306
      if (ivz(3,ij).eq.0) go to 31                                      quan-307
      lo(210)=.true.                                                    quan-308
      it=it+1                                                           quan-309
      nat(1,it)=ivz(3,ij)+intv                                          quan-310
      at(2,it)=at(2,i)                                                  quan-311
      at(3,it)=at(2,it)*dfloat(mc(i2,6)-mc(i1,6))                       quan-312
   31 continue                                                          quan-313
      if (it.gt.it2) nin=nin+1                                          quan-314
      go to 33                                                          quan-315
   32 nvi(i2,i1,2)=it                                                   quan-316
   33 nvi(i2,i1,3)=it                                                   quan-317
      if (lo(100).or.(nvi(i2,i1,3).eq.nvi(i2,i1,2))) go to 38           quan-318
c copy of the coefficients and corrections in order to obtain           quan-319
c an hermitian interaction                                              quan-320
      k1=nvi(i2,i1,1)                                                   quan-321
      k2=nvi(i2,i1,2)                                                   quan-322
      it1=it+1                                                          quan-323
      nvi(i1,i2,1)=it1                                                  quan-324
      do 34 k=k1,k2                                                     quan-325
      it=it+1                                                           quan-326
      nat(1,it)=nat(1,k)                                                quan-327
   34 at(2,it)=at(2,k)                                                  quan-328
      k1=k2+1                                                           quan-329
      k2=nvi(i2,i1,3)                                                   quan-330
      do 35 k=k1,k2                                                     quan-331
      it=it+1                                                           quan-332
      nat(1,it)=nat(1,k)-insl                                           quan-333
      if (nat(1,k).lt.0) nat(1,it)=nat(1,it)+2*insl                     quan-334
      at(2,it)=-at(2,k)                                                 quan-335
      it=it+1                                                           quan-336
      nat(1,it)=nat(1,k)                                                quan-337
   35 at(2,it)=at(2,k)                                                  quan-338
      llo=.true.                                                        quan-339
      go to 23                                                          quan-340
   36 nvi(i1,i2,2)=it                                                   quan-341
      do 37 k=k1,k2                                                     quan-342
      it=it+1                                                           quan-343
      nat(1,it)=nat(1,k)                                                quan-344
   37 at(2,it)=-at(2,k)                                                 quan-345
      nvi(i1,i2,3)=it                                                   quan-346
      nin=nin+2                                                         quan-347
      if (lo(14)) nin=nin+2                                             quan-348
      go to 40                                                          quan-349
c symmetrisation of the table when there is no deformed spin-orbit      quan-350
   38 do 39 k=1,3                                                       quan-351
   39 nvi(i1,i2,k)=nvi(i2,i1,k)                                         quan-352
   40 continue                                                          quan-353
   41 continue                                                          quan-354
      if (lo(158)) go to 42                                             quan-355
c output of coupling coefficients                                       quan-356
      write (mw,1002) ((j,i,(nvi(j,i,k),k=1,3),i=1,nc),j=1,nc)          quan-357
      if (it.eq.0) go to 42                                             quan-358
      if (lo(200)) write (mw,1003) (i,nat(1,i),at(2,i),i=1,it)          quan-359
      if (lo(100)) write (mw,1004) (i,nat(1,i),at(2,i),at(3,i),i=1,it)  quan-360
   42 nci=ncin                                                          quan-361
      nic=nc                                                            quan-362
      if (.not.lo(231)) return                                          quan-363
c find quantum number of coupled channels for identical particles. not  quan-364
c used for dirac formalism (incorrect meaning of mc(*,10[3]) in mtch)   quan-365
      ncin=0                                                            quan-366
      ja=naj/2                                                          quan-367
      isi=ipi(2,1)-1                                                    quan-368
      nsm=isi+1                                                         quan-369
      nsb=jpi+1                                                         quan-370
      do 44 is=nsb,nsm,2                                                quan-371
      lp=ja+is                                                          quan-372
      lm=iabs(ja-is+1)+1                                                quan-373
      do 43 l=lm,lp                                                     quan-374
      if (mod(l+jpi,2).ne.1) go to 43                                   quan-375
      ncin=ncin+1                                                       quan-376
      mc(ncin,10)=ipi(11,1)                                             quan-377
      mc(ncin,7)=1                                                      quan-378
      mc(ncin,8)=l-1                                                    quan-379
      mc(ncin,9)=2*is-2                                                 quan-380
      mc(ncin,11)=mc(ncin,8)*(mc(ncin,8)+1)                             quan-381
      mc(ncin,12)=(ja*(ja+1)-l*(l-1)-is*(is-1))/2                       quan-382
   43 continue                                                          quan-383
   44 continue                                                          quan-384
      nc=ncin                                                           quan-385
      if (lo(58)) write (mw,1005) nci,ncin                              quan-386
      if (ncin.eq.0) return                                             quan-387
      if (nic.eq.nci) go to 46                                          quan-388
      n=nci+1                                                           quan-389
      do 45 i=n,nic                                                     quan-390
      nc=nc+1                                                           quan-391
      mc(nc,7)=mc(i,1)                                                  quan-392
      mc(nc,8)=mc(i,2)                                                  quan-393
      mc(nc,9)=mc(i,3)                                                  quan-394
      mc(nc,10)=mc(i,4)                                                 quan-395
      mc(nc,11)=mc(i,5)                                                 quan-396
   45 mc(nc,12)=mc(i,6)                                                 quan-397
   46 if (lo(158)) go to 48                                             quan-398
      write (mw,1000) aj,ip(jpi+1),nc,ncin                              quan-399
      do 47 j=1,nc                                                      quan-400
      sj=0.5d0*dfloat(mc(j,9))                                          quan-401
   47 write (mw,1001) j,mc(j,7),mc(j,8),sj,mc(j,10),mc(j,11),mc(j,12)   quan-402
c computation of transformation coefficients                            quan-403
   48 iti=it+1                                                          quan-404
      do 50 j=1,ncin                                                    quan-405
      do 49 i=1,nci                                                     quan-406
      aa(i,j)=0.d0                                                      quan-407
      if (mc(j,8).ne.mc(i,2)) go to 49                                  quan-408
      ij=mc(i,3)                                                        quan-409
      is=mc(j,9)                                                        quan-410
      aa(i,j)=dfloat(1-mod(2*mc(i,2)+naj+2*isi,4))*dsqrt((ij+1.d0)*(is+1quan-411
     1.d0))*dj6j(2*mc(i,2),isi,ij,isi,naj,is,fac,nfa)                   quan-412
   49 continue                                                          quan-413
   50 continue                                                          quan-414
      lo(210)=.false.                                                   quan-415
      nin=0                                                             quan-416
      ni=nci-ncin                                                       quan-417
      ibb=2                                                             quan-418
      if ((lo(201).and.lo(203)).or.lo(200)) ibb=1                       quan-419
      do 70 i1=1,nc                                                     quan-420
      if (i1.gt.ncin) go to 51                                          quan-421
      j1=1                                                              quan-422
      k1=nci                                                            quan-423
      go to 52                                                          quan-424
   51 j1=i1+ni                                                          quan-425
      k1=j1                                                             quan-426
   52 do 69 i2=1,nc                                                     quan-427
      if ((i2.gt.i1).and.(ibb.eq.1)) go to 70                           quan-428
      do 67 ib=1,ibb                                                    quan-429
      if (i2.gt.ncin) go to 53                                          quan-430
      j2=1                                                              quan-431
      k2=nci                                                            quan-432
      go to 54                                                          quan-433
   53 j2=i2+ni                                                          quan-434
      k2=j2                                                             quan-435
   54 it1=it+1                                                          quan-436
      if (ib.eq.1) nvi(i2,i1,4)=it1                                     quan-437
      do 58 l1=j1,k1                                                    quan-438
      a1=1.d0                                                           quan-439
      if (l1.le.nci) a1=aa(l1,i1)                                       quan-440
      if (a1.eq.0.d0) go to 58                                          quan-441
      do 57 l2=j2,k2                                                    quan-442
      a2=1.d0                                                           quan-443
      if (l2.le.nci) a2=aa(l2,i2)                                       quan-444
      if (a2.eq.0.d0) go to 57                                          quan-445
      m1=nvi(l2,l1,ib)                                                  quan-446
      m2=nvi(l2,l1,ib+1)                                                quan-447
      if (ib.eq.2) m1=m1+1                                              quan-448
      if (m1.gt.m2) go to 57                                            quan-449
      if (2*(m2-m1+3+it).gt.nmax) call memo('quan',nmax,2*(m2-m1+3+it),2quan-450
     1)                                                                 quan-451
      do 56 m=m1,m2                                                     quan-452
      it=it+1                                                           quan-453
      nat(1,it)=nat(1,m)                                                quan-454
      do 55 ix=2,id                                                     quan-455
   55 at(ix,it)=at(ix,m)*a1*a2                                          quan-456
   56 continue                                                          quan-457
   57 continue                                                          quan-458
   58 continue                                                          quan-459
      if (it-it1) 66 , 63 , 59                                          quan-460
c  summation of coefficients related to the same form factor            quan-461
   59 it2=it-1                                                          quan-462
      do 62 i=it1,it2                                                   quan-463
      do 61 j=i,it2                                                     quan-464
      if (nat(1,i).ne.nat(1,j+1)) go to 61                              quan-465
      do 60 ix=2,id                                                     quan-466
      at(ix,i)=at(ix,i)+at(ix,j+1)                                      quan-467
   60 at(ix,j+1)=0.d0                                                   quan-468
   61 continue                                                          quan-469
   62 continue                                                          quan-470
c elimination of too small coefficients                                 quan-471
   63 it2=it                                                            quan-472
      it=it1-1                                                          quan-473
      nmr=0                                                             quan-474
      nmi=0                                                             quan-475
      do 65 i=it1,it2                                                   quan-476
      cx=dabs(at(2,i))                                                  quan-477
      if (lo(100)) cx=cx+dabs(at(3,i))                                  quan-478
      if (cx.lt.1.d-10) go to 65                                        quan-479
      it=it+1                                                           quan-480
      nat(1,it)=nat(1,i)                                                quan-481
      do 64 ix=2,id                                                     quan-482
   64 at(ix,it)=at(ix,i)                                                quan-483
      if (lo(100)) at(3,it)=at(3,i)                                     quan-484
      nmr=nmr+1                                                         quan-485
      if (nat(1,it).lt.0) nmi=nmi+1                                     quan-486
   65 continue                                                          quan-487
      if (nmr.ne.0) nin=nin+1                                           quan-488
      if (nmi.ne.0) nin=nin+1                                           quan-489
      if ((ib.eq.2).and.(nmr.ne.0)) lo(210)=.true.                      quan-490
   66 nvi(i2,i1,ib+4)=it                                                quan-491
   67 continue                                                          quan-492
      if (ibb.eq.2) go to 70                                            quan-493
      nvi(i2,i1,6)=it                                                   quan-494
c symmetrisation of the table when there is no deformed spin-orbit      quan-495
      do 68 k=4,6                                                       quan-496
   68 nvi(i1,i2,k)=nvi(i2,i1,k)                                         quan-497
   69 continue                                                          quan-498
   70 continue                                                          quan-499
      if (lo(158)) return                                               quan-500
c output of coupling coefficients                                       quan-501
      write (mw,1002) ((i,j,(nvi(i,j,k),k=4,6),i=1,nc),j=1,nc)          quan-502
      if (it.lt.iti) return                                             quan-503
      if (lo(200)) write (mw,1003) (i,nat(1,i),at(2,i),i=iti,it)        quan-504
      if (lo(100)) write (mw,1004) (i,nat(1,i),at(2,i),at(3,i),i=iti,it)quan-505
      return                                                            quan-506
 1000 format (/' channel spin and parity',f6.1,a1,i11,' coupled channelsquan-507
     1 and',i3,' solutions'//8x,' i',3x,' v',3x,' l',3x,' j',9x,' pot',5quan-508
     2x,' cl',6x,' cj'/)                                                quan-509
 1001 format (5x,3i5,f6.1,i11,2i9)                                      quan-510
 1002 format (/' pairs of channels n1 n2, and coupling coefficient numbequan-511
     1rs nvi(n1,n2,k),k=1,3'/(1x,6(i3,i3,',',3i4,';')))                 quan-512
 1003 format (//5x,'coefficients'/(4(2x,2i4,1p,d15.6)))                 quan-513
 1004 format (//5x,'coefficients'/(3(2x,2i4,1p,2d15.6)))                quan-514
 1005 format (/' number of solutions reduced from',i3,' to',i3)         quan-515
      end                                                               quan-516
c 29/02/04                                                      ecis03  mtch-000
      subroutine mtch(nvi,ncoll,kab,wv,mc,bg,nat,st,aa,ism,lmax2,niv,ivzmtch-001
     1,fg,lmax1,lmax3,kr,vco,vdo,fam,id,bjm,chb,xm,lo)                  mtch-002
c computation of coulomb corrections as integrals from the matching     mtch-003
c point if lo(227)=.false. or from the origin if lo(227)=.true.         mtch-004
c input variables: nvi:   addresses of couplings in table at            mtch-005
c                  nc:    number of equations                           mtch-006
c                  ncoll: number of nuclear states                      mtch-007
c                  kab:   maximum number of coupled channels            mtch-008
c                  wv:    wave numbers and coulomb parameters           mtch-009
c                  mc:    nuclear state number and angular momentum     mtch-010
c                  bg:    table of coulomb integrals from 0 to infinity mtch-011
c                           for coupled equations or when lo(227)=.true.mtch-012
c                  nat,st:table of coupling coefficients                mtch-013
c                  ism:   number of integration points                  mtch-014
c                  lmax2: first dimension of table bg                   mtch-015
c                  niv:   address in the table of reduced matrix elementmtch-016
c                  ivz:   table of form factors (see redm 3rd part)     mtch-017
c                  fg:    coulomb functions                             mtch-018
c                  lmax1: first dimension of table fg                   mtch-019
c                  lmax3: maximum number of coulomb integrals from the  mtch-020
c                           matching point to infinity                  mtch-021
c                  vco:   strength of tails of coulomb potentials       mtch-022
c                  vdo:   strength of tails of coulomb transitions      mtch-023
c                  id:    first dimension of nat,st                     mtch-024
c                  bjm:   coefficient of increase of imaginary potentialmtch-025
c                  chb:                                                 mtch-026
c                  xm:                                                  mtch-027
c                  lo:    logical controls                              mtch-028
c in common /pote2/ity(5):number of diagonal potentials                 mtch-029
c                  intv:  number of form factors                        mtch-030
c                  insl:  number of spin-orbit form factors             mtch-031
c in common /noequ/ncxn:  number of solutions needed                    mtch-032
c                  nc:    number of equations                           mtch-033
c output variables:aa:    coulomb integrals from the matching point to  mtch-034
c                           infinity for iterations lo(225)=.false.     mtch-035
c                  fam(i,j): matching values and wave number for j=1 to mtch-036
c                         6, coefficient of central potential for j=7,  mtch-037
c                         coefficient of spin-orbit potential for j=8,  mtch-038
c                         energy for j=9, centrifugal potential for j=10mtch-039
c working space:   aa(1,1,i) for i=7,10 if lo(227) or lo(225)=.true.    mtch-040
c                  kr:    for lins                                      mtch-041
c local tables la(3,11) and ba(2,11) are set mcm(1)=5 and mcm(2)=4      mtch-042
c***********************************************************************mtch-043
      implicit real*8 (a-h,o-z)                                         mtch-044
      logical lo(250),lv                                                mtch-045
      dimension aa(kab,kab,4),wv(18,1),nat(2*id,1),st(id,1),b(4),c(2,2),mtch-046
     1mc(kab,6),nvi(kab,kab,3),niv(ncoll,ncoll,3),ivz(4,1),fg(lmax1,4,1)mtch-047
     2,g(4),ab(4,2),kr(1),vco(2,1),vdo(2,1),bg(lmax2,1),fam(kab,10),av(5mtch-048
     3),la(3,11),ba(2,11)                                               mtch-049
      common /pote2/ ity(8),invt,intv,insl,npx                          mtch-050
      common /noequ/ ncxn,nic,nci,nc,ncin,nin,jpi,ipj,r1(2),naj         mtch-051
      common /inout/ mr,mw,ms                                           mtch-052
      lv=lo(44).and.(lo(57).or.lo(58))                                  mtch-053
      ll4=4                                                             mtch-054
      if (lo(227)) ll4=1                                                mtch-055
      if (lv) write (mw,1000)                                           mtch-056
c loops on equations                                                    mtch-057
      do 56 ic=1,nc                                                     mtch-058
      i1=mc(ic,1)                                                       mtch-059
      k1=mc(ic,4)                                                       mtch-060
      l1=mc(ic,2)                                                       mtch-061
      if (k1.ge.0.or.lo(227)) go to 2                                   mtch-062
c transfer of informations when uncoupled functions are not recomputed  mtch-063
      k1=-k1                                                            mtch-064
      if (lo(200)) mc(ic,6)=0                                           mtch-065
      if (k1.eq.ic) go to 5                                             mtch-066
      do 1 i=1,8                                                        mtch-067
    1 fam(ic,i)=fam(k1,i)                                               mtch-068
      go to 5                                                           mtch-069
c values of long range tails of central potentials                      mtch-070
    2 f2=vco(1,k1)**2                                                   mtch-071
      f3=vco(2,k1)*mc(ic,6)                                             mtch-072
      jc=0                                                              mtch-073
      if (i1.le.ncoll) jc=niv(i1,i1,3)                                  mtch-074
      if (wv(3,i1).gt.0.d0.and.jc.gt.0) go to 3                         mtch-075
      f2=0.d0                                                           mtch-076
      f3=0.d0                                                           mtch-077
    3 if (lo(227)) go to 5                                              mtch-078
c integration region - set up of potential in five points for           mtch-079
c transformation of matching values                                     mtch-080
      b1=wv(11,1)*wv(11,1)/48.d0                                        mtch-081
      c1=(ism-1)*wv(11,1)                                               mtch-082
      a1=wv(9,i1)**2                                                    mtch-083
      if (wv(3,i1).lt.0.d0) a1=-a1                                      mtch-084
      do 4 k=1,5                                                        mtch-085
      av(k)=b1*(2.d0*wv(9,i1)*wv(5,i1)/c1-a1+(mc(ic,5)-f2-f3/c1)/c1**2) mtch-086
    4 c1=c1+0.5d0*wv(11,1)                                              mtch-087
c computation of coulomb corrections                                    mtch-088
    5 az=ism*wv(11,i1)                                                  mtch-089
      do 48 ip=1,ic                                                     mtch-090
      do 6 l=1,8                                                        mtch-091
    6 ab(l,1)=0.d0                                                      mtch-092
      i2=mc(ip,1)                                                       mtch-093
      ilm=1                                                             mtch-094
      if (lo(144)) go to 45                                             mtch-095
      l2=mc(ip,2)                                                       mtch-096
      i3=niv(i2,i1,3)                                                   mtch-097
      if (i3.eq.0) go to 45                                             mtch-098
      ay=dsqrt(wv(9,i1)*wv(9,i2))                                       mtch-099
      aw=ay*az                                                          mtch-100
c scan the couplings between equations                                  mtch-101
      is=0                                                              mtch-102
      if (lo(200).and.lo(19).and.(ic.ne.ip)) ilm=2                      mtch-103
      k1=nvi(ip,ic,1)                                                   mtch-104
      k2=nvi(ip,ic,2)                                                   mtch-105
      if (lo(111).or.(k1.gt.k2)) go to 15                               mtch-106
      iml=1                                                             mtch-107
c central contribution                                                  mtch-108
      i=1                                                               mtch-109
    7 if (vdo(1,i).eq.0.d0) go to 29                                    mtch-110
      ii=i+ity(5)                                                       mtch-111
      do 8 k=k1,k2                                                      mtch-112
      if (iabs(nat(1,k)).eq.ii) go to 9                                 mtch-113
    8 continue                                                          mtch-114
      go to 29                                                          mtch-115
    9 if (st(2,k).eq.0.d0.and.lo(200)) go to 29                         mtch-116
      la1=mc(ic,2)                                                      mtch-117
      la2=mc(ip,2)                                                      mtch-118
      la3=ivz(4,i)                                                      mtch-119
      zt=st(2,k)*ay**la3*vdo(1,i)/wv(11,i1)**2                          mtch-120
      if (lo(100)) zt=zt*.5d0*dsqrt((xm+wv(7,i1))*(xm+wv(7,i2)))/xm     mtch-121
      im=1                                                              mtch-122
   10 if (im.lt.5) yt=zt                                                mtch-123
      if ((yt.eq.0.d0).and.(zt.eq.0.d0)) go to 13                       mtch-124
      if (is.eq.0) go to 12                                             mtch-125
      do 11 j=1,is                                                      mtch-126
      if ((la(1,j).ne.la1).or.(la(2,j).ne.la2).or.(la(3,j).ne.la3)) go tmtch-127
     1o 11                                                              mtch-128
      ba(1,j)=ba(1,j)+zt                                                mtch-129
      ba(2,j)=ba(2,j)+yt                                                mtch-130
      go to 13                                                          mtch-131
   11 continue                                                          mtch-132
   12 is=is+1                                                           mtch-133
      la(1,is)=la1                                                      mtch-134
      la(2,is)=la2                                                      mtch-135
      la(3,is)=la3                                                      mtch-136
      ba(1,is)=zt                                                       mtch-137
      ba(2,is)=yt                                                       mtch-138
   13 go to ( 14 , 29 , 19 , 29 , 26 , 27 , 28 , 29 ),im                mtch-139
   14 if (lo(200)) go to 29                                             mtch-140
c vector contribution in dirac equation                                 mtch-141
      im=2                                                              mtch-142
      la1=mc(ic,3)-mc(ic,2)                                             mtch-143
      la2=mc(ip,3)-mc(ip,2)                                             mtch-144
      la3=ivz(4,i)                                                      mtch-145
      zt=st(3,k)*ay**la3*vdo(1,i)*chb**2*wv(9,i1)*wv(9,i2)/(2.d0*xm*(wv(mtch-146
     17,i2)+xm)*wv(11,i1)**2)                                           mtch-147
      if ((la1-mc(ic,2))*(la2-mc(ip,2)).lt.0) zt=-zt                    mtch-148
      go to 10                                                          mtch-149
   15 if (lo(119)) go to 30                                             mtch-150
      k3=nvi(ip,ic,3)                                                   mtch-151
c tensor contribution in dirac equation                                 mtch-152
      if (lo(200)) go to 20                                             mtch-153
      iml=2                                                             mtch-154
      k4=k2+1                                                           mtch-155
      if (k4.gt.k3) go to 30                                            mtch-156
      i=1                                                               mtch-157
   16 if (vdo(2,i).eq.0.d0) go to 29                                    mtch-158
      do 17 k=k4,k3                                                     mtch-159
      if (iabs(nat(1,k)).eq.ivz(3,i)+intv) go to 18                     mtch-160
   17 continue                                                          mtch-161
      go to 29                                                          mtch-162
   18 im=3                                                              mtch-163
      la1=mc(ic,3)-mc(ic,2)                                             mtch-164
      la2=mc(ip,2)                                                      mtch-165
      la3=ivz(4,i)+1                                                    mtch-166
      zt=.5d0*(st(3,k)+dfloat(la3)*st(2,k))*ay**la3*vdo(2,i)*chb*wv(9,i1mtch-167
     1)/(wv(11,i1)**2*xm)                                               mtch-168
      if ((la1-mc(ic,2)).gt.0) zt=-zt                                   mtch-169
      go to 10                                                          mtch-170
   19 im=4                                                              mtch-171
      la1=mc(ic,2)                                                      mtch-172
      la2=mc(ip,3)-la2                                                  mtch-173
      zt=-.5d0*(st(3,k)-dfloat(la3)*st(2,k))*ay**la3*vdo(2,i)*chb*wv(9,imtch-174
     12)/(wv(11,i2)**2*xm)                                              mtch-175
      if ((la2-mc(ip,2)).gt.0) zt=-zt                                   mtch-176
      go to 10                                                          mtch-177
   20 i=1                                                               mtch-178
      iml=3                                                             mtch-179
c spin-orbit contribution in schroedinger equation                      mtch-180
      kp1=nvi(ic,ip,1)                                                  mtch-181
      kp2=nvi(ic,ip,2)                                                  mtch-182
      kp3=nvi(ic,ip,3)                                                  mtch-183
   21 if (vdo(2,i).eq.0.d0) go to 29                                    mtch-184
      ii=ivz(3,i)+ity(5)+insl+intv                                      mtch-185
      ax1=0.d0                                                          mtch-186
      ax2=0.d0                                                          mtch-187
      ax3=0.d0                                                          mtch-188
      if (k1.gt.k3) go to 23                                            mtch-189
      do 22 k=k1,k3                                                     mtch-190
      if (iabs(nat(1,k))+insl.eq.ii) ax1=st(2,k)                        mtch-191
      if ((k.le.k2).and.(iabs(nat(1,k)).eq.ii)) ax2=st(2,k)             mtch-192
      if ((k.gt.k2).and.(iabs(nat(1,k)).eq.ii)) ax3=st(2,k)             mtch-193
   22 continue                                                          mtch-194
   23 ay1=0.d0                                                          mtch-195
      ay2=0.d0                                                          mtch-196
      ay3=0.d0                                                          mtch-197
      if (kp1.gt.kp3) go to 25                                          mtch-198
      do 24 k=kp1,kp3                                                   mtch-199
      if (iabs(nat(1,k))+insl.eq.ii) ay1=st(2,k)                        mtch-200
      if ((k.le.kp2).and.(iabs(nat(1,k)).eq.ii)) ay2=st(2,k)            mtch-201
      if ((k.gt.kp2).and.(iabs(nat(1,k)).eq.ii)) ay3=st(2,k)            mtch-202
   24 continue                                                          mtch-203
   25 if ((k1.gt.k3).and.(kp1.gt.kp3)) go to 29                         mtch-204
      la1=mc(ic,2)                                                      mtch-205
      la2=mc(ip,2)                                                      mtch-206
      la3=ivz(4,i)+2                                                    mtch-207
      if (la3.gt.la1+la2) go to 29                                      mtch-208
      xt=ay**la3*vdo(2,i)/wv(11,i1)**2                                  mtch-209
      zt=(ax2-dfloat(la3-1)*ax1+dfloat(la1+1)*ax3)*xt                   mtch-210
      yt=(ay2-dfloat(la3-1)*ay1+dfloat(la2+1)*ay3)*xt                   mtch-211
      im=5                                                              mtch-212
      go to 10                                                          mtch-213
   26 la3=la3-1                                                         mtch-214
      xt=xt/ay                                                          mtch-215
      zt=ax3*wv(9,i1)*wv(5,i1)/dfloat(la1+1)*xt                         mtch-216
      yt=ay3*wv(9,i2)*wv(5,i2)/dfloat(la2+1)*xt                         mtch-217
      im=6                                                              mtch-218
      go to 10                                                          mtch-219
   27 la2=la2+1                                                         mtch-220
      yt=-ay3*dsqrt(1.d0+(wv(5,i2)/dfloat(la2))**2)*wv(9,i2)*xt         mtch-221
      zt=0.d0                                                           mtch-222
      im=7                                                              mtch-223
      go to 10                                                          mtch-224
   28 la1=la1+1                                                         mtch-225
      la2=la2-1                                                         mtch-226
      zt=-ax3*dsqrt(1.d0+(wv(5,i1)/dfloat(la1))**2)*wv(9,i1)*xt         mtch-227
      yt=0.d0                                                           mtch-228
      im=8                                                              mtch-229
      go to 10                                                          mtch-230
   29 i=i+1                                                             mtch-231
      if (i.le.intv) go to ( 7 , 16 , 21 ),iml                          mtch-232
      if (iml.eq.1) go to 15                                            mtch-233
   30 if (is.eq.0) go to 45                                             mtch-234
      do 44 ik=1,is                                                     mtch-235
      if (dabs(ba(1,ik))+dabs(ba(2,ik)).lt.1.d-8) go to 44              mtch-236
      l4=la(1,ik)                                                       mtch-237
      l5=la(2,ik)                                                       mtch-238
      li=min0(l4,l5)                                                    mtch-239
      lf=max0(l4,l5)                                                    mtch-240
      ll=la(3,ik)                                                       mtch-241
      i4=i1                                                             mtch-242
      if (li.ne.la(2,ik)) i4=i2                                         mtch-243
      i5=i1+i2-i4                                                       mtch-244
      ei=wv(5,i5)                                                       mtch-245
      ef=wv(5,i4)                                                       mtch-246
      xi=wv(9,i5)*az                                                    mtch-247
      xf=wv(9,i4)*az                                                    mtch-248
      l3=(li+lf-ll+3)/2                                                 mtch-249
      if (l3.le.0) go to 44                                             mtch-250
      call cora(l3,ll,lf-li+1,ei,ef,xi,xf,b,c,lo(227))                  mtch-251
c order in c   (li,lf),(li,lf+1),(li+1,lf),(li+1,lf+1)                  mtch-252
c order in fg   f(ei)*f(ef),g(ei)*f(ef),f(ei)*g(ef),g(ei)*g(ef)         mtch-253
      if (lo(227)) go to 41                                             mtch-254
c integration region - integrals from matching point to infinity        mtch-255
      if (max0(l3+3,lf+2).gt.lmax3) go to 65                            mtch-256
      if (li.ne.l5) go to 31                                            mtch-257
      a1=c(1,2)                                                         mtch-258
      c(1,2)=c(2,1)                                                     mtch-259
      c(2,1)=a1                                                         mtch-260
c computation of the integrals from the matching point using b and c    mtch-261
   31 do 35 n1=1,4                                                      mtch-262
      g(n1)=0.d0                                                        mtch-263
      do 32 n3=1,4                                                      mtch-264
   32 g(n1)=g(n1)+b(n3)*fg(l3+n3-1,n1,i3)                               mtch-265
      nn2=2*((n1-1)/2)+1                                                mtch-266
      nn1=2*(n1-nn2)+1                                                  mtch-267
      do 34 n3=1,2                                                      mtch-268
      do 33 n4=1,2                                                      mtch-269
   33 g(n1)=g(n1)-c(n4,n3)*fg(l3+n3,nn1,i1)*fg(l3+n4,nn2,i2)            mtch-270
   34 continue                                                          mtch-271
   35 continue                                                          mtch-272
      do 37 il=1,ilm                                                    mtch-273
      do 36 l=1,4                                                       mtch-274
   36 ab(l,il)=ab(l,il)+ba(il,ik)*g(l)                                  mtch-275
   37 continue                                                          mtch-276
      if (lo(225).or.(lo(29).and.(ip.eq.ic))) go to 39                  mtch-277
      do 38 il=1,ilm                                                    mtch-278
      yt=ba(il,ik)*wv(11,i1)**2*ay/(12.d0*aw**(ll+1))                   mtch-279
c with the green's functions method,we must add h**2*fp(r)/12           mtch-280
c which is vre(ism-1)*(ki*fp(i)*g(f)+kf*f(i)*gp(f)-(ll+1)/r)/12.        mtch-281
      c0=-dfloat(ll+1)/az+6.d0/wv(11,i1)                                mtch-282
      ab(1,il)=ab(1,il)-yt*(wv(9,i1)*fg(l4+1,2,i1)*fg(l5+1,1,i2)+wv(9,i2mtch-283
     1)*fg(l4+1,1,i1)*fg(l5+1,2,i2)+c0*fg(l4+1,1,i1)*fg(l5+1,1,i2))     mtch-284
      ab(2,il)=ab(2,il)-yt*(wv(9,i1)*fg(l4+1,4,i1)*fg(l5+1,1,i2)+wv(9,i2mtch-285
     1)*fg(l4+1,3,i1)*fg(l5+1,2,i2)+c0*fg(l4+1,3,i1)*fg(l5+1,1,i2))     mtch-286
      ab(3,il)=ab(3,il)-yt*(wv(9,i1)*fg(l4+1,2,i1)*fg(l5+1,3,i2)+wv(9,i2mtch-287
     1)*fg(l4+1,1,i1)*fg(l5+1,4,i2)+c0*fg(l4+1,1,i1)*fg(l5+1,3,i2))     mtch-288
      ab(4,il)=ab(4,il)-yt*(wv(9,i1)*fg(l4+1,4,i1)*fg(l5+1,3,i2)+wv(9,i2mtch-289
     1)*fg(l4+1,3,i1)*fg(l5+1,4,i2)+c0*fg(l4+1,3,i1)*fg(l5+1,3,i2))     mtch-290
   38 continue                                                          mtch-291
      go to 44                                                          mtch-292
c correction of the potential in five points for matching values        mtch-293
   39 c1=dfloat(ism-1)*wv(11,i1)*ay                                     mtch-294
      do 40 i=1,5                                                       mtch-295
      av(i)=av(i)+ba(1,ik)*ay*wv(11,i1)**2/c1**(ll+1)/48.d0             mtch-296
   40 c1=c1+0.5d0*wv(11,i1)*ay                                          mtch-297
      go to 44                                                          mtch-298
c computation of integrals from 0 to infinity using b                   mtch-299
   41 ax=0.d0                                                           mtch-300
      if (l3+3.gt.lmax2) go to 66                                       mtch-301
      do 42 n1=1,4                                                      mtch-302
   42 ax=ax+b(n1)*bg(l3+n1-1,i3)                                        mtch-303
      do 43 il=1,ilm                                                    mtch-304
   43 ab(1,il)=ab(1,il)+ba(il,ik)*ax                                    mtch-305
   44 continue                                                          mtch-306
c limitation for too large integral of irregular functions              mtch-307
   45 if (dabs(ab(4,1)).gt.wv(9,i1)) ab(4,1)=ab(1,1)                    mtch-308
      if ((ilm.eq.2).and.(dabs(ab(4,2)).gt.wv(9,i2))) ab(4,2)=ab(1,2)   mtch-309
      if (.not.lv) go to 46                                             mtch-310
      write (mw,1001) ic,ip,l1,l2,(ab(i,1),i=1,ll4)                     mtch-311
      if (ilm.eq.2) write (mw,1001) ip,ic,l2,l1,(ab(i,2),i=1,ll4)       mtch-312
c build up of matrix of corrections                                     mtch-313
   46 do 47 l=1,ll4                                                     mtch-314
      if (ic.ne.ip) aa(ip,ic,l)=ab(l,ilm)                               mtch-315
   47 aa(ic,ip,l)=ab(l,1)                                               mtch-316
      if (lo(227).or.(ic.eq.ip)) go to 48                               mtch-317
      aa(ip,ic,2)=ab(3,ilm)                                             mtch-318
      aa(ip,ic,3)=ab(2,ilm)                                             mtch-319
   48 continue                                                          mtch-320
      if (.not.lo(227)) go to 49                                        mtch-321
      if (jc.le.0) go to 56                                             mtch-322
      if (wv(5,i1).eq.0.d0) f2=f3*wv(9,i1)                              mtch-323
      aa(ic,ic,1)=aa(ic,ic,1)-f2*bg(l1+1,jc)*wv(9,i1)                   mtch-324
      if ((wv(5,i1).eq.0.d0).or.(f3.eq.0.d0)) go to 56                  mtch-325
      b1=2.d0*wv(5,i1)*dfloat(l1*(l1+1))                                mtch-326
      b2=dfloat(l1+1)**2+wv(5,i1)**2                                    mtch-327
      c1=-(dfloat(2*l1+1)*b2+2*wv(5,i1)**2)/b1                          mtch-328
      c2=dfloat(2*l1+3)*b2/b1                                           mtch-329
      aa(ic,ic,1)=aa(ic,ic,1)-f3*(c1*bg(l1+1,jc)+c2*bg(l1+2,jc))*wv(9,i1mtch-330
     1)**2                                                              mtch-331
      go to 56                                                          mtch-332
   49 if (mc(ic,4).lt.0) go to 56                                       mtch-333
c matching values                                                       mtch-334
      do 50 k=1,4                                                       mtch-335
   50 b(k)=fg(l1+1,k,i1)                                                mtch-336
      if (jc.le.0) go to 54                                             mtch-337
      if (lo(129).and.(f2.eq.0.d0.and.f3.eq.0.d0)) go to 54             mtch-338
      if (wv(5,i1).ne.0.d0) go to 51                                    mtch-339
      f2=f3*wv(9,i1)                                                    mtch-340
      f3=0.d0                                                           mtch-341
   51 do 52 k=1,4                                                       mtch-342
   52 g(k)=-fg(l1+1,k,jc)*f2+ab(k,1)/wv(9,i1)                           mtch-343
      if (f3.eq.0.d0) go to 53                                          mtch-344
      b1=2.d0*wv(5,i1)*dfloat(l1*(l1+1))                                mtch-345
      b2=dfloat(l1+1)**2+wv(5,i1)**2                                    mtch-346
      c1=-(dfloat(2*l1+1)*b2+2*wv(5,i1)**2)/b1                          mtch-347
      c2=dfloat(2*l1+3)*b2/b1                                           mtch-348
      a1=dfloat(ism)*wv(11,i1)*wv(9,i1)                                 mtch-349
      d1=(b2+dfloat(l1+1)*wv(5,i1)/a1)/a1/b1                            mtch-350
      d2=-wv(5,i1)*dsqrt(b2)/b1/a1                                      mtch-351
      a1=b2/b1/a1                                                       mtch-352
      a3=f3*wv(9,i1)                                                    mtch-353
      g(1)=g(1)-a3*(c1*fg(l1+1,1,jc)+c2*fg(l1+2,1,jc)-d1*fg(l1+1,1,i1)**mtch-354
     12-d2*2.d0*fg(l1+1,1,i1)*fg(l1+2,1,i1)-a1*fg(l1+2,1,i1)**2)        mtch-355
      g(2)=g(2)-a3*(c1*fg(l1+1,2,jc)+c2*fg(l1+2,2,jc)-d1*fg(l1+1,1,i1)*fmtch-356
     1g(l1+1,3,i1)-d2*(fg(l1+1,1,i1)*fg(l1+2,3,i1)+fg(l1+2,1,i1)*fg(l1+1mtch-357
     2,3,i1))-a1*fg(l1+2,1,i1)*fg(l1+2,3,i1))                           mtch-358
      g(4)=g(4)-a3*(c1*fg(l1+1,4,jc)+c2*fg(l1+2,4,jc)-d1*fg(l1+1,3,i1)**mtch-359
     12-d2*2.d0*fg(l1+1,3,i1)*fg(l1+2,3,i1)-a1*fg(l1+2,3,i1)**2)        mtch-360
   53 a4=1.d0+(g(1)*g(4)-g(2)**2)                                       mtch-361
      g(3)=b(1)                                                         mtch-362
      b(1)=(b(1)*(1.d0-g(2))+g(1)*b(3))/a4                              mtch-363
      b(3)=(-g(3)*g(4)+(1.d0+g(2))*b(3))/a4                             mtch-364
      g(3)=b(2)                                                         mtch-365
      b(2)=(b(2)*(1.d0-g(2))+g(1)*b(4))/a4                              mtch-366
      b(4)=(-g(3)*g(4)+(1.d0+g(2))*b(4))/a4                             mtch-367
   54 a1=(1.d0-av(2))/(2.d0+10.d0*av(2))                                mtch-368
      b1=(1.d0-av(4))/(2.d0+10.d0*av(4))                                mtch-369
      a2=a1*(1.d0-av(1))/(1.d0-4.d0*av(1))                              mtch-370
      b2=b1*(1.d0-av(5))/(1.d0-4.d0*av(5))                              mtch-371
      c1=(2.d0+10.d0*av(3))-(1.d0-av(3))*(a1+b1)                        mtch-372
      a1=(16.d0-144.d0*av(2))/(2.d0+10.d0*av(2))                        mtch-373
      b1=(16.d0-144.d0*av(4))/(2.d0+10.d0*av(4))                        mtch-374
      c2=(7.d0+a1*(1.d0-av(1)))/(1.d0-4.d0*av(1))                       mtch-375
      d2=(7.d0+b1*(1.d0-av(5)))/(1.d0-4.d0*av(5))                       mtch-376
      d1=(b1-a1)*(1.d0-av(3))                                           mtch-377
      a1=a2*d2+b2*c2                                                    mtch-378
      b1=(c1*d2+d1*b2)/a1                                               mtch-379
      b2=30.d0*wv(11,1)*b2*wv(9,i1)/a1                                  mtch-380
      fam(ic,1)=b1*b(1)-b2*b(2)                                         mtch-381
      fam(ic,3)=b1*b(3)-b2*b(4)                                         mtch-382
      b1=(c2*c1-a2*d1)/a1                                               mtch-383
      a2=-30.d0*wv(11,1)*a2*wv(9,i1)/a1                                 mtch-384
      fam(ic,2)=b1*b(1)-a2*b(2)                                         mtch-385
      fam(ic,4)=b1*b(3)-a2*b(4)                                         mtch-386
      fam(ic,5)=wv(9,i1)                                                mtch-387
      if (lo(100)) fam(ic,5)=fam(ic,5)*chb/(xm+wv(7,i1))                mtch-388
      bt=fam(ic,2)*fam(ic,3)-fam(ic,1)*fam(ic,4)                        mtch-389
      if (bt.eq.0.d0) bt=1.d0                                           mtch-390
      do 55 i=1,4                                                       mtch-391
   55 fam(ic,i)=fam(ic,i)/bt                                            mtch-392
      fam(ic,6)=fam(ic,5)/bt                                            mtch-393
      if (lo(100)) fam(ic,5)=fam(ic,5)*wv(11,i1)                        mtch-394
      fam(ic,7)=wv(8,i1)**2                                             mtch-395
      fam(ic,8)=2.d0*fam(ic,7)*mc(ic,6)                                 mtch-396
      fam(ic,9)=wv(10,i1)                                               mtch-397
      fam(ic,10)=mc(ic,5)                                               mtch-398
      if (lo(200)) mc(ic,6)=idint(bjm*fam(ic,7))                        mtch-399
   56 continue                                                          mtch-400
      do 59 ic=1,nc                                                     mtch-401
      i1=mc(ic,1)                                                       mtch-402
      do 58 l=1,ll4                                                     mtch-403
      do 57 ip=1,nc                                                     mtch-404
   57 aa(ic,ip,l)=aa(ic,ip,l)/wv(9,i1)                                  mtch-405
   58 continue                                                          mtch-406
   59 continue                                                          mtch-407
      if (.not.lo(227)) return                                          mtch-408
      if (.not.lo(225)) go to 62                                        mtch-409
c transposition if coupled equations are used                           mtch-410
      do 61 ic=1,nc                                                     mtch-411
      do 60 ip=1,ic                                                     mtch-412
      ax=aa(ip,ic,1)                                                    mtch-413
      aa(ip,ic,1)=aa(ic,ip,1)                                           mtch-414
   60 aa(ic,ip,1)=ax                                                    mtch-415
   61 continue                                                          mtch-416
c linear system for computation of the s-matrix from the k-matrix       mtch-417
   62 do 64 ic=1,nc                                                     mtch-418
      do 63 ip=1,nc                                                     mtch-419
      aa(ic,nc+ip,1)=0.d0                                               mtch-420
      aa(ic,ip,4)=0.d0                                                  mtch-421
   63 aa(ic,nc+ip,4)=-aa(ic,ip,1)                                       mtch-422
   64 aa(ic,ic,4)=1.d0                                                  mtch-423
      call lins(aa(1,1,4),kab,aa,kab,nc,ncxn,kr,ier)                    mtch-424
      return                                                            mtch-425
   65 write (mw,1002) l3,lf,lmax3                                       mtch-426
      return                                                            mtch-427
   66 write (mw,1003) l3,lmax2                                          mtch-428
      return                                                            mtch-429
 1000 format (/' channels  l-values     coulomb integrals: f*f,g*f,f*g amtch-430
     1nd g*g')                                                          mtch-431
 1001 format (2x,2i3,2x,2i4,3x,4d18.10)                                 mtch-432
 1002 format (' starting values',i3,' for integrals and',i3,' for coulommtch-433
     1b functions too large . limitation at',i4)                        mtch-434
 1003 format (' starting value',i4,' too large for coulomb integrals whimtch-435
     1ch are computed up to',i5)                                        mtch-436
      end                                                               mtch-437
c 29/02/04                                                      ecis03  lins-000
      subroutine lins(a,ia,b,ib,na,m,k,ier)                             lins-001
c lins: jlsb2 version 01 18/12/68 math l003 of saclay                   lins-002
c solution of double precision complex linear systems with real and     lins-003
c imaginary parts in different arrays                                   lins-004
c     a real component of matrix and second members                     lins-005
c     b imaginary component of matrix and second members                lins-006
c second members are replaced by solutions                              lins-007
c     ia first dimension of array a                                     lins-008
c     ib first dimension of array b                                     lins-009
c     na order of the system                                            lins-010
c     m  number of second members                                       lins-011
c     k  working field of dimension >/= na                              lins-012
c     ier returns diagnostic 0 non singular matrix                      lins-013
c                            1 singular matrix                          lins-014
c                            2 quasi singular matrix                    lins-015
c***********************************************************************lins-016
      implicit real*8 (a-h,o-z)                                         lins-017
      dimension a(ia,1),k(1),b(ib,1)                                    lins-018
      common /inout/ mr,mw,ms                                           lins-019
      ier=0                                                             lins-020
      n=na                                                              lins-021
      ndeb=n+1                                                          lins-022
      nm=n+m                                                            lins-023
      do 1 i=1,n                                                        lins-024
    1 k(i)=i                                                            lins-025
      do 11 i=1,n                                                       lins-026
      amax=dabs(a(i,i))+dabs(b(i,i))                                    lins-027
      jmax=i                                                            lins-028
      i1=i+1                                                            lins-029
      if (i.eq.n) go to 3                                               lins-030
      do 2 j=i1,n                                                       lins-031
      amay=dabs(a(i,j))+dabs(b(i,j))                                    lins-032
      if (amax.ge.amay) go to 2                                         lins-033
      amax=amay                                                         lins-034
      jmax=j                                                            lins-035
    2 continue                                                          lins-036
    3 if (amax.eq.0.d0) go to 18                                        lins-037
      if (jmax.eq.i) go to 5                                            lins-038
      do 4 i2=1,n                                                       lins-039
      aux=b(i2,i)                                                       lins-040
      b(i2,i)=b(i2,jmax)                                                lins-041
      b(i2,jmax)=aux                                                    lins-042
      aux=a(i2,i)                                                       lins-043
      a(i2,i)=a(i2,jmax)                                                lins-044
    4 a(i2,jmax)=aux                                                    lins-045
      nab=k(jmax)                                                       lins-046
      k(jmax)=k(i)                                                      lins-047
      k(i)=nab                                                          lins-048
    5 if (i.eq.1) go to 7                                               lins-049
      sr=0.d0                                                           lins-050
      si=0.d0                                                           lins-051
      t=0.d0                                                            lins-052
      in=i-1                                                            lins-053
      do 6 it=1,in                                                      lins-054
      pr=a(it,i)*a(i,it)-b(it,i)*b(i,it)                                lins-055
      pi=a(it,i)*b(i,it)+a(i,it)*b(it,i)                                lins-056
      sr=sr+pr                                                          lins-057
      si=si+pi                                                          lins-058
    6 t=t+dabs(pr)+dabs(pi)                                             lins-059
      era=1.d-16*(t+dabs(a(i,i)-sr)+dabs(b(i,i)-si))                    lins-060
      if (amax.gt.era) go to 7                                          lins-061
      ier=2                                                             lins-062
      write (mw,1000)                                                   lins-063
      go to 19                                                          lins-064
    7 do 8 j=i1,nm                                                      lins-065
      aa=a(i,j)                                                         lins-066
      bb=b(i,j)                                                         lins-067
      ai=a(i,i)                                                         lins-068
      bi=b(i,i)                                                         lins-069
      d=ai*ai+bi*bi                                                     lins-070
      a(i,j)=(aa*ai+bb*bi)/d                                            lins-071
    8 b(i,j)=(bb*ai-aa*bi)/d                                            lins-072
      if (i.eq.n) go to 11                                              lins-073
      do 10 i3 =i1,n                                                    lins-074
      do 9 j3 =i1,nm                                                    lins-075
      b(i3,j3)=b(i3,j3)-a(i3,i)*b(i,j3)-b(i3,i)*a(i,j3)                 lins-076
    9 a(i3,j3)=a(i3,j3)-a(i3,i)*a(i,j3)+b(i3,i)*b(i,j3)                 lins-077
   10 continue                                                          lins-078
   11 continue                                                          lins-079
      if (n.eq.1) go to 19                                              lins-080
      do 14 kc=ndeb,nm                                                  lins-081
      j=n                                                               lins-082
   12 i=j-1                                                             lins-083
   13 a(i,kc)=a(i,kc)-a(j,kc)*a(i,j)+b(j,kc)*b(i,j)                     lins-084
      b(i,kc)=b(i,kc)-a(j,kc)*b(i,j)-b(j,kc)*a(i,j)                     lins-085
      i=i-1                                                             lins-086
      if (i.ne.0) go to 13                                              lins-087
      j=j-1                                                             lins-088
      if (j.ne.1) go to 12                                              lins-089
   14 continue                                                          lins-090
      do 17 i=1,n                                                       lins-091
   15 j=k(i)                                                            lins-092
      if (j.le.i) go to 17                                              lins-093
      k(i)=k(j)                                                         lins-094
      k(j)=j                                                            lins-095
      do 16 mp=ndeb,nm                                                  lins-096
      aux=b(j,mp)                                                       lins-097
      b(j,mp)=b(i,mp)                                                   lins-098
      b(i,mp)=aux                                                       lins-099
      aux=a(j,mp)                                                       lins-100
      a(j,mp)=a(i,mp)                                                   lins-101
   16 a(i,mp)=aux                                                       lins-102
      go to 15                                                          lins-103
   17 continue                                                          lins-104
      go to 19                                                          lins-105
   18 ier=1                                                             lins-106
      write (mw,1001)                                                   lins-107
   19 return                                                            lins-108
 1000 format (' *****  lins  ***** quasi singular matrix')              lins-109
 1001 format (' *****  lins  *****       singular matrix')              lins-110
      end                                                               lins-111
c 29/02/04                                                      ecis03  cora-000
      subroutine cora(l,lq,ll,e,f,v,w,b,c,lt)                           cora-001
c coefficients for coulomb integrals                                    cora-002
c m(l1,l2,lq,r)=sum from r to infinity of h(l1)*k(l2)/r**(lq+1)         cora-003
c expressed as sum on i of b(i)*m(l+i-2,l+i-2,1) + c1(r)*h(l)*k(l)      cora-004
c + c2(r)*h(l)*k(l+1) + c3(r)*h(l+1)*k(l) + c4(r)*h(l+1)*k(l+1)         cora-005
c where h and k are regular or irregular coulomb functions              cora-006
c l=integer part of (l1+l2-lq+3)/2 and i ranges from 1 to 4.            cora-007
c input variables: l,lq:   l,lq in the expressions above                cora-008
c                  ll:     value of l2-l1+1 which must be >1.           cora-009
c                  e,f:    coulomb parameters                           cora-010
c                  v,w:    product of r with the wave numbers           cora-011
c                  lt:     .true. for only integrals from 0 to infinity cora-012
c output variables:b(4):   coefficients b in the expressions above      cora-013
c                  c(4):   coefficients c                               cora-014
c                                                                       cora-015
c these results are obtained by expressing                              cora-016
c h(l1)*k(l2)/r**(lq+1)- sum on i of b(i)*h(l+i-2)*k(l+i-2)/r**2        cora-017
c as p1*h(l)*k(l) + p2*h(l)*k(l+1) + p3*h(l+1)*k(l) + p4*h(l+1)*q(l+1)  cora-018
c where p1,p2,p3,p4 are polynomial in 1/r and identification term by    cora-019
c term starting from the highest degree in 1/r with the derivative of   cora-020
c  q1*h(l)*k(l) + q2*h(l)*k(l+1) + q3*h(l+1)*k(l) + q4*h(l+1)*q(l+1)    cora-021
c this as been done using amp ( j.-m. drouffe, amp language reference   cora-022
c manual - version 6 - note cea-n-2297 1982).                           cora-023
c                                                                       cora-024
c the non relativistic results for lq=6 l2-l1=0,2,4 and all the         cora-025
c coefficients up to lq=5 have been obtained. this allow transfer of    cora-026
c angular momentum up to 5 for central term and 4 for spin-orbit.       cora-027
c                                                                       cora-028
c***********************************************************************cora-029
      implicit real*8 (a-h,o-z)                                         cora-030
      dimension b(4),c(4)                                               cora-031
      logical lt                                                        cora-032
      common /inout/ mr,mw,ms                                           cora-033
      do 1 i=1,4                                                        cora-034
      b(i)=0.d0                                                         cora-035
    1 c(i)=0.d0                                                         cora-036
      if ((lq.gt.6).or.(ll*(lq-ll+2).le.0)) go to 68                    cora-037
      a=dfloat(l+1)                                                     cora-038
      s=v/w                                                             cora-039
      x=e*s-f                                                           cora-040
      if (dabs(x).lt.1.d-10) x=0.d0                                     cora-041
      u=s**2-1.d0                                                       cora-042
      if (dabs(u).lt.1.d-10) u=0.d0                                     cora-043
      if ((x.eq.0.d0).and.(e.eq.0.d0)) go to 47                         cora-044
      p=s**2*(a**2+e**2)                                                cora-045
      q=a**2+f**2                                                       cora-046
      y=e*s+f                                                           cora-047
      z=e**2-f**2                                                       cora-048
      if (dabs(z).lt.1.d-10) z=0.d0                                     cora-049
      if (x.eq.0.d0.and.z.eq.0.d0) z=1.d0                               cora-050
      den=2.d0*x**2*(p-q)+8.d0*z*s**2                                   cora-051
      z=u                                                               cora-052
      if (x.eq.0.d0.and.z.eq.0.d0) z=-1.d0/(e*f)                        cora-053
      go to ( 2 , 7 , 11 , 18 , 26 , 39 ) , lq                          cora-054
    2 go to ( 3 , 4 ) , ll                                              cora-055
c multipole lq=1 l1=l2                                                  cora-056
    3 b(1)=1.d0                                                         cora-057
      return                                                            cora-058
    4 if ((e.ne.f).or.(v.ne.w)) go to 5                                 cora-059
c multipole lq=1 l1=l2-1 with e=f and v=w                               cora-060
      b1=dsqrt((a-1.d0)**2+e**2)                                        cora-061
      b(2)=-(a-.5d0)*q/(e*b1)                                           cora-062
      b(3)=(a+.5d0)*q/(e*b1)                                            cora-063
      if (lt) return                                                    cora-064
      c(1)=(q+(2.d0*a-1.d0)*e/v)/(2.d0*e*v*b1)                          cora-065
      c(3)=-dsqrt(q)/(2.d0*v*a*b1)                                      cora-066
      c(2)=c(3)*(2.d0*a-1.d0)                                           cora-067
      c(4)=q/(2.d0*e*v*b1)                                              cora-068
      return                                                            cora-069
c multipole lq=1 l1=l2-1                                                cora-070
    5 a1=-2.d0*f*(2.d0*(a-1.d0)*q-a**2*u)                               cora-071
      a2=f*(4.d0*q*(a-1.d0)*((6.d0*a+1.d0)*q-4.d0*a**2+1.d0)+u*((((16.d0cora-072
     1*a-24.d0)*a+4.d0)*a**2-2.d0)*q+a**2*(2.d0*a-1.d0-u*(a-1.d0)**2)*(4cora-073
     2.d0*a+2.d0)))                                                     cora-074
      a3=-f*(a-1.d0)*((24.d0*a-4.d0)*q+16.d0*a**2-4.d0+u*(((8.d0*a+8.d0)cora-075
     1*a+2.d0)*a-2.d0))                                                 cora-076
      a4=4.d0*(a-1.d0)*f                                                cora-077
      if (x.eq.0.d0) go to 6                                            cora-078
      a1=a1-x*(q*(a-1.d0)*(2.d0*a+6.d0)+a**2*(4.d0+a*u)+x*((2.d0*a-2.d0)cora-079
     1*f+a*x))                                                          cora-080
      a2=a2+x*(q*((a-1.d0)*(a+5.d0)*(12.d0*a+2.d0)*q-(((40.d0*a-16.d0)*acora-081
     1-34.d0)*a-8.d0)*a-6.d0+(((((8.d0*a+12.d0)*a-38.d0)*a+8.d0)*a+5.d0)cora-082
     2*a-4.d0)*u+(((16.d0*a+40.d0)*a-44.d0)*a-12.d0)*f*x+(((4.d0*a+20.d0cora-083
     3)*a-13.d0)*a-8.d0)*x**2)+(2.d0*a+1.d0)*(a**2*(4.d0-8.d0*a+((6.d0*acora-084
     4-7.d0)*a+4.d0)*u+a*(a-1.d0)**2*u**2)+x*(((4.d0*a+6.d0)*a-2.d0+(a-1cora-085
     5.d0)*((4.d0*a-4.d0)*a+2.d0)*u)*f+x*(a*(((2.d0*a-2.d0)*a+1.d0)*u-(4cora-086
     6.d0*a-6.d0)*a+1.d0)+(4.d0*a-2.d0)*f*x+a*x**2))))                  cora-087
      a3=a3+x*(a-1.d0)*(((8.d0*a-8.d0)*a+6.d0)*a+2.d0-(2.d0*a+6.d0)*(6.dcora-088
     10*a-1.d0)*q-((((4.d0*a+12.d0)*a+5.d0)*a-3.d0)*a-2.d0)*u-2.d0*x*(((cora-089
     24.d0*a+8.d0)*a-3.d0)*f-x))                                        cora-090
      a4=a4+x*2.d0*(a**2-1.d0)                                          cora-091
    6 bd=.5d0*den*dsqrt((a-1.d0)**2+e**2)                               cora-092
      if (.not.lt) c(1)=.5d0-a                                          cora-093
      go to 46                                                          cora-094
    7 go to ( 8 , 9 , 10 ) , ll                                         cora-095
c multipole lq=2 l1=l2                                                  cora-096
    8 a1=2.d0*z*a**2*y                                                  cora-097
      a2=-z*y*(2.d0*a+1.d0)*(((a-1.d0)*a-.5d0)*y**2+2.d0*a**2*(a-1.d0)**cora-098
     12*(s**2+1.d0))                                                    cora-099
      a3=2.d0*z*(2.d0*a+1.d0)*(a-1.d0)**2*y                             cora-100
      a4=0.d0                                                           cora-101
      bd=den*(a-1.d0)/dsqrt(s)                                          cora-102
      if (.not.lt) c(1)=-1.d0                                           cora-103
      if (x.eq.0) go to 46                                              cora-104
      a1=a1+x*(4.d0*f*e*s-2.d0*a*(a+q+a*s**2+p))                        cora-105
      a2=a2+x*((a+.5d0)*((((4.d0*a-6.d0)*a+2.d0)*a-1.d0)*(q+p*s**2)+4.d0cora-106
     1*(2.d0*a-3.d0)*f*e*s*(q+p+s**2+1.d0)+(((4.d0*a+2.d0)*a-14.d0)*a+1.cora-107
     2d0)*(q*s**2+p)+a**2*((s**4+1.d0)*((2.d0*a-6.d0)*a+5.d0)-s**2*(4.d0cora-108
     3*(a+1.d0)*a-14.d0)))+p*q*((8.d0*a-4.d0)*a+8.d0))                  cora-109
      a3=a3-2.d0*x*(a-1.d0)*((2.d0*a-3.d0)*(f**2+e**2*s**2)+4.d0*(2.d0*acora-110
     1+1.d0)*f*e*s+(s**2+1.d0)*(a+1.d0)*((6.d0*a+1.d0)*a-3.d0))         cora-111
      a4=4.d0*(a-1.d0)*x                                                cora-112
      go to 46                                                          cora-113
c multipole lq=2 l1=l2-1                                                cora-114
    9 b1=x*(a-1.d0)-e*s                                                 cora-115
      b3=-(a-1.d0)**2                                                   cora-116
      b2=b3/(a-.5d0)                                                    cora-117
      bd=-den*a*(a-1.d0)*(2.d0*a-3.d0)*dsqrt(s*((a-1.d0)**2+e**2))/(2.d0cora-118
     1*a-1.d0)                                                          cora-119
      if (lt) go to 13                                                  cora-120
      c(1)=b1+2.d0*a*(a-1.d0)**2/w                                      cora-121
      c(2)=b3                                                           cora-122
      c(3)=b2                                                           cora-123
      go to 13                                                          cora-124
c multipole lq=2 l1=l2-2                                                cora-125
   10 b1=q                                                              cora-126
      b3=-3.d0*e*s-x*(a-1.d0)                                           cora-127
      b4=(a-1.d0)/(a-.5d0)                                              cora-128
      bd=-3.d0*den*a*dsqrt(s*q*((a-1.d0)**2+e**2))/(2.d0*a-1.d0)        cora-129
      if (lt) go to 15                                                  cora-130
      c(1)=b1                                                           cora-131
      c(2)=b3-2.d0*a*(a-1.d0)/w                                         cora-132
      c(4)=b4                                                           cora-133
      go to 15                                                          cora-134
   11 go to ( 12 , 14 , 16 , 17 ) , ll                                  cora-135
c multipole lq=3 l1=l2                                                  cora-136
   12 b1=y/(a-1.d0)                                                     cora-137
      b2=1.d0                                                           cora-138
      b3=1.d0                                                           cora-139
      bd=den*a*(2.d0*a-3.d0)                                            cora-140
      if (lt) go to 13                                                  cora-141
      c(1)=b1-2.d0*a/w                                                  cora-142
      c(2)=b3                                                           cora-143
      c(3)=b2                                                           cora-144
   13 a1=-2.d0*a**2*y*b1*z                                              cora-145
      a2=y*((2.d0*a+1.d0)*((2.d0*(a**2-a)**2*(1.d0+s**2)+y**2*(a**2-a-.5cora-146
     1d0))*b1-y*(p*b2+q*b3)))*z                                         cora-147
      a3=-y*((2.d0*a-1.d0)*(-y*(b2+b3))+(4.d0*a+2.d0)*(a-1.d0)**2*b1)*z cora-148
      a4=0.d0                                                           cora-149
      if (x.eq.0.d0) go to 46                                           cora-150
      a1=a1+x*2.d0*p*(a*x-2.d0*f)*b2                                    cora-151
      a2=a2+x*p*(2.d0*q*((2.d0*a+3.d0)*(a+1.d0)*f+((2.d0*a+3.d0)*a-4.d0)cora-152
     1*e*s)-2.d0*p*(2.d0*a-3.d0)*(2.d0*a+1.d0)*f+(2.d0*a+1.d0)*((((2.d0*cora-153
     2a-1.d0)*a-8.d0)*a+5.d0)*f-s*((a+1.d0)*((6.d0*a-9.d0)*a+1.d0)*e-s*(cora-154
     3(6.d0*a-7.d0)*(a**2-1.d0)*f-s*((((2.d0*a-5.d0)*a+2.d0)*a-1.d0)*e))cora-155
     4)))*b2                                                            cora-156
      a3=a3+x*(2.d0*p*((2.d0*a-3.d0)*(a-1.d0)*e*s+f*((2.d0*a-3.d0)*a-4.dcora-157
     10))-2.d0*q*e*s*(2.d0*a+3.d0)*(2.d0*a-1.d0)-(2.d0*a-1.d0)*((((2.d0*cora-158
     2a+5.d0)*a+2.d0)*a+1.d0)*f-s*((6.d0*a+7.d0)*(a**2-1.d0)*e-s*((a-1.dcora-159
     30)*((6.d0*a+9.d0)*a+1.d0)*f-s*((((2.d0*a+1.d0)*a-8.d0)*a-5.d0)*e))cora-160
     4)))*b2                                                            cora-161
      if (lq.eq.3) go to 45                                             cora-162
      a4=a4+x*2.d0*(2.d0*e*s-a*x)*b2                                    cora-163
      go to 44                                                          cora-164
c multipole lq=3 l1=l2-1                                                cora-165
   14 b1=q/(a-1.d0)                                                     cora-166
      b3=-x                                                             cora-167
      b4=1.d0/(a+1.d0)                                                  cora-168
      bd=-3.d0*den*a*dsqrt(q)                                           cora-169
      if (lt) go to 15                                                  cora-170
      c(1)=b1                                                           cora-171
      c(2)=b3-2.d0*a/w                                                  cora-172
      c(4)=b4                                                           cora-173
   15 a1=-2.d0*a**2*y*b1*z                                              cora-174
      a2=y*((2.d0*a+1.d0)*((2.d0*(a**2-a)**2*(1.d0+s**2)+y**2*(a**2-a-.5cora-175
     1d0))*b1-y*q*b3)+(4.d0*a-2.d0)*(a+1.d0)**2*p*q*b4)*z               cora-176
      a3=-y*((2.d0*a-1.d0)*((2.d0*(a**2+a)**2*(1.d0+s**2)+y**2*(a**2+a-.cora-177
     15d0))*b4-y*b3)+(4.d0*a+2.d0)*(a-1.d0)**2*b1)*z                    cora-178
      a4=2.d0*a**2*y*b4*z                                               cora-179
      if (x.eq.0.d0) go to 46                                           cora-180
      a1=a1-x*4.d0*p*q*(a+1.d0)*b4                                      cora-181
      a2=a2+x*2.d0*p*q*(a+1.d0)*((2.d0*a+3.d0)*(q+p)+(2.d0*a-1.d0)*(4.d0cora-182
     1*e*f*s+(1.d0+s**2)*((2.d0*a-4.d0)*a-3.d0)))*b4                    cora-183
      a3=a3+x*(-4.d0*p*q*((2.d0*a+1.d0)*a+2.d0)-(2.d0*a-1.d0)*(2.d0*s*e*cora-184
     1f*(2.d0*a+3.d0)*(q+p+s**2+1.d0)-a**2*(((a+3.d0)*a+2.5d0)*(1.d0+s**cora-185
     24)-s**2*((2.d0*a-2.d0)*a-7.d0))+a*(a-1.d0)*(2.d0*a+3.d0)*(1.d0+s**cora-186
     32)*(p+q)-(s**2-1.d0)*((2.d0*a+4.d0)*a+.5d0)*(q-p)))*b4            cora-187
      a4=a4+x*2.d0*((a-1.d0)*(p+q)+y**2)*b4                             cora-188
      go to 44                                                          cora-189
c multipole lq=3 l1=l2-2                                                cora-190
   16 b1=-q*(2.d0*a-1.d0)*((2.d0*a-3.d0)*(a+1.d0)*x+(a-3.d0)*y)/(a-1.d0)cora-191
      b2=6.d0*q*(a-1.d0)                                                cora-192
      b3=((a-1.d0)*(6.d0*a-3.d0)*q+(2.d0*a-1.d0)*((a+1.d0)*x+2.d0*y)*(2.cora-193
     1d0*a-3.d0)*x-(a-1.d0)*(6.d0*a-9.d0)*p)                            cora-194
      b4=-((2.d0*a-1.d0)*x+y)*(2.d0*a-3.d0)                             cora-195
      bd=12.d0*a**2*(2.d0*a-3.d0)*den*s*dsqrt(q*((a-1.d0)**2+e**2))     cora-196
      if (lt) go to 43                                                  cora-197
      c(1)=b1-6.d0*q*a*(a-1.d0)*(2.d0*a-1.d0)/w                         cora-198
      c(2)=b3+a*(4.d0*a-6.d0)*(2.d0*a-1.d0)*((a+1.d0)*x+2.d0*y+3.d0*a*(acora-199
     1-1.d0)/w)/w                                                       cora-200
      c(3)=b2                                                           cora-201
      c(4)=b4-6.d0*a*(a-1.d0)*(2.d0*a-3.d0)/w                           cora-202
      go to 43                                                          cora-203
c multipole lq=3 l1=l2-3                                                cora-204
   17 b1=-q*(3.d0*e*s*y+a*(3.d0*x*y+2.d0*(a+1.d0)*(x**2+2.d0*a-1.d0-2.d0cora-205
     1*(a-1.d0)*s**2)))                                                 cora-206
      b2=3.d0*q*(a*x+y)                                                 cora-207
      b4=-(3.d0*f*y+a*(3.d0*x*y+2.d0*(a-1.d0)*(x**2+2.d0*a+2.d0-(2.d0*a+cora-208
     11.d0)*s**2)))                                                     cora-209
      b3=-x*b4*(a+1.d0)+3.d0*q*(y+a*x)+a*(3.d0*a+1.5d0)*(1.d0-s**2)*((3.cora-210
     1d0*a-2.d0)*y+((a-2.d0)*a+2.d0)*x)                                 cora-211
      bd=30.d0*a**2*den*s*dsqrt(q*((a-1.d0)**2+e**2)*((a+1.d0)**2+f**2))cora-212
      if (lt) go to 43                                                  cora-213
      c(1)=b1-3.d0*q*(2.d0*a-1.d0)*((6.d0*a+4.d0)*f+(a+1.d0)*(a+4.d0)*x+cora-214
     14.d0*a*(a**2-1.d0)/w)/w                                           cora-215
      c(2)=b3+((4.d0*a**2*(a**2-1.d0)*(2.d0*a-1.d0-s**2*(2.d0*a+1.d0))+(cora-216
     118.d0*a**2-3.d0)*y**2+a*(12.d0*a**2+3.d0)*x*y+(a**2-1.d0)*(4.d0*a*cora-217
     2*2-3.d0)*x**2)+3.d0*a*(4.d0*a**2-1.d0)*(5.d0*a*y+(a**2+4.d0)*x+4.dcora-218
     30*a*(a**2-1.d0)/w)/w)/w                                           cora-219
      c(3)=b2+12.d0*q*(a**2-1.d0)/w                                     cora-220
      c(4)=b4-3.d0*(2.d0*a+1.d0)*((6.d0*a-4.d0)*f+a*(a+1.d0)*x+4.d0*a*(acora-221
     1**2-1.d0)/w)/w                                                    cora-222
      go to 43                                                          cora-223
   18 go to ( 19 , 20 , 21 , 22 , 24 ) , ll                             cora-224
c multipole lq=4 l1=l2                                                  cora-225
   19 b1=-p*q*(2.d0*a+3.d0)/(a-1.d0)                                    cora-226
      b2=-q*(3.d0*e*s+a*x)                                              cora-227
      b3=-p*(3.d0*f-a*x)                                                cora-228
      b4=-((p+q)*(a+1.5d0)-1.5d0*y**2)/(a+1.d0)                         cora-229
      bd=3.d0*den*a**2*(2.d0*a+3.d0)*(a+2.d0)*dsqrt(s*p*q)              cora-230
      if (lt) go to 43                                                  cora-231
      c(1)=b1                                                           cora-232
      c(2)=(b3+p*a*(2.d0*a+3.d0)/w)                                     cora-233
      c(3)=(b2+q*a*(2.d0*a+3.d0)/w)                                     cora-234
      c(4)=(b4-3.d0*a*(y-a*(2.d0*a+3.d0)/w)/w)                          cora-235
      go to 43                                                          cora-236
c multipole lq=4 l1=l2-1                                                cora-237
   20 b1=q*(3.d0*e*s-a*x)*(4.d0*a+6.d0)/(a-1.d0)                        cora-238
      b2=18.d0*q                                                        cora-239
      b3=((2.d0*a+3.d0)*(3.d0*q+(2.d0*a-3.d0)*x**2)-(6.d0*a-9.d0)*p)    cora-240
      b4=(3.d0*f-a*x)*(4.d0*a-6.d0)/(a+1.d0)                            cora-241
      bd=12.d0*den*a**2*dsqrt(s*q)*(4.d0*a**2-9.d0)                     cora-242
      if (lt) go to 43                                                  cora-243
      c(1)=b1-6.d0*q*a*(2.d0*a+3.d0)/w                                  cora-244
      c(2)=b3+2.d0*a*(4.d0*a**2-9.d0)*(x+3.d0*a/w)/w                    cora-245
      c(3)=b2                                                           cora-246
      c(4)=b4-6.d0*a*(2.d0*a-3.d0)/w                                    cora-247
      go to 43                                                          cora-248
c multipole lq=4 l1=l2-2                                                cora-249
   21 b1=((2.d0*a-e**2)*s**2+(a+2.d0)*(2.d0*e*f*s-a*(2.d0*a+2.d0+f**2)/(cora-250
     1a-1.d0))/(a+1.d0))                                                cora-251
      b2=6.d0*q*((a+1.d0)*x-3.d0*f)                                     cora-252
      b3=(-x*(4.d0*a+6.d0)*b1*(a**2-1.d0)+3.d0*(p*((2.d0*a+5.d0)*x-3.d0*cora-253
     1y)+(1.d0-s**2)*a*(a+2.d0)*(2.d0*a+3.d0)*(a*x+e*s)))               cora-254
      b4=((4.d0*a+6.d0)*(b1*(a-1.d0)+3.d0*a*(s**2-1.d0))+3.d0*y*(3.d0*y-cora-255
     1(2.d0*a+5.d0)*x)/(a+1.d0))                                        cora-256
      b1=q*(a+1.d0)*(4.d0*a+6.d0)*b1                                    cora-257
      bd=60.d0*den*a**2*(a+2.d0)*(2.d0*a+3.d0)*dsqrt(s*q*((a+1.d0)**2+f*cora-258
     1*2))                                                              cora-259
      if (lt) go to 43                                                  cora-260
      c(1)=b1-6.d0*q*(a+2.d0)*(2.d0*a+3.d0)*(e*s+a*(x+4.d0*(a+1.d0)/w))/cora-261
     1w                                                                 cora-262
      c(2)=b3+2.d0*(2.d0*a+3.d0)*(6.d0*e*f*s+a*(f*((2.d0*a+13.d0)*x+6.d0cora-263
     1*f)+(a+1.d0)*(2.d0*a*(2.d0*a+4.d0-(2.d0*a+1.d0)*s**2)+(2.d0*a+1.d0cora-264
     2)*x**2))+3.d0*a*(a+2.d0)*(2.d0*a+1.d0)*((a+1.d0)*x+5.d0*f+a*(4.d0*cora-265
     2a+4.d0)/w)/w)/w                                                   cora-266
      c(3)=b2+12.d0*q*(a+1.d0)*(2.d0*a+3.d0)/w                          cora-267
      c(4)=b4-(12.d0*a+6.d0)*((a+6.d0)*f+a*(a+1.d0)*(x+(4.d0*a+6.d0)/w))cora-268
     1/w                                                                cora-269
      go to 43                                                          cora-270
c multipole lq=4 l1=l2-3                                                cora-271
   22 b1=f*q*(12.d0*(q-(2.d0*a-1.d0)*(2.d0*a-5.d0))/((2.d0*a-3.d0)*(a-1.cora-272
     1d0))+(26.d0*a-10.d0)*u)                                           cora-273
      b2=q*(36.d0*(q+4.d0*a**2-5.d0)/(2.d0*a-3.d0)-30.d0*(a**2-1.d0)*u)/cora-274
     1(2.d0*a+3.d0)                                                     cora-275
      b3=b2+u*(a**2*(6.d0*a+3.d0)*((4.d0*a+10.d0)+5.d0*(a**2-1.d0)*u)-18cora-276
     1.d0*q*a*(3.d0*a+4.d0))/(2.d0*a+3.d0)                              cora-277
      b4=f*(12.d0*(q-(2.d0*a+5.d0)*(2.d0*a+1.d0))+u*(4.d0*a+2.d0)*((13.dcora-278
     10*a+22.d0)*a-15.d0))/((a+1.d0)*(2.d0*a+3.d0))                     cora-279
      if (x.eq.0.d0) go to 23                                           cora-280
      b1=b1-2.d0*q*x*((6.d0*q*(a-2.d0)+(((28.d0*a-30.d0)*a-46.d0)*a+30.dcora-281
     10))/((2.d0*a-3.d0)*(a-1.d0))-(a+1.d0)*((9.d0*a-5.d0)*u-2.d0*x**2))cora-282
      b2=b2-12.d0*q*x*(f-x*(a+1.d0))/(2.d0*a+3.d0)                      cora-283
      b3=b3+x*(24.d0*q*(a*x-f)+(2.d0*a+1.d0)*(12.d0*(2.d0*a+5.d0)*f-((44cora-284
     1.d0*a+80.d0)*a-30.d0)*f*u+x*a*(28.d0*a+52.d0-u*(24.d0*a+2.d0)*(a+1cora-285
     2.d0))+12.d0*f*x**2+4.d0*a*x**3*(a+1.d0)))/(2.d0*a+3.d0)           cora-286
      b4=b4-x*(12.d0*(a-1.d0)*q+(4.d0*a+2.d0)*(6.d0*f*x+a*(14.d0*a+26.d0cora-287
     1-(a+1.d0)*((9.d0*a+1.d0)*u-2.d0*x**2))))/((2.d0*a+3.d0)*(a+1.d0)) cora-288
   23 bd=360.d0*den*a**2*s*dsqrt(s*q*((a+1.d0)**2+f**2)*((a-1.d0)**2+e**cora-289
     12))                                                               cora-290
      if (lt) go to 43                                                  cora-291
      c(1)=b1+q*(12.d0*(a*(2.d0*a-1.d0)*(2.d0*a-5.d0)-q*(9.d0*a-12.d0))/cora-292
     1(2.d0*a-3.d0)+30.d0*a*u*(a**2-1.d0)-24.d0*(2.d0*a-1.d0)*(f*(7.d0*acora-293
     2+5.d0)+5.d0*a*(a**2-1.d0)/w)/w)/w                                 cora-294
      c(2)=b3+(f*(48.d0*q-8.d0*a*u*(2.d0*a+1.d0)*(7.d0*a-5.d0))+6.d0*(10cora-295
     1.d0*q*(11.d0*a**2-2.d0)-a**2*(2.d0*a+1.d0)*(30.d0*(2.d0*a-1.d0)+5.cora-296
     2d0*u*(a**2-1.d0)-(8.d0*a-4.d0)*(12.d0*f+5.d0*(a**2-1.d0)/w)/w))/w)cora-297
     3/w                                                                cora-298
      c(3)=b2+24.d0*q*(2.d0*f+5.d0*(a**2-1.d0)/w)/w                     cora-299
      c(4)=b4+((12.d0*a*(2.d0*a+1.d0)*(2.d0*a+5.d0)-36.d0*q*(3.d0*a+4.d0cora-300
     1)+30.d0*a*u*(2.d0*a+1.d0)*(a**2-1.d0))/(2.d0*a+3.d0)-24.d0*(2.d0*acora-301
     2+1.d0)*(f*(7.d0*a-5.d0)+5.d0*a*(a**2-1.d0)/w)/w)/w                cora-302
      if (x.eq.0.d0) go to 43                                           cora-303
      c(1)=c(1)-12.d0*x*q*((a+2.d0)*(3.d0*f+(a+1.d0)*x)+(4.d0*a-2.d0)*(acora-304
     1+1.d0)*(a+5.d0)/w)/w                                              cora-305
      c(2)=c(2)+x*((12.d0*q*(5.d0*a+6.d0)+(2.d0*a+1.d0)*(12.d0*f*x*(a+2.cora-306
     1d0)-2.d0*a*(4.d0*a+10.d0+(a+1.d0)*(u*(9.d0*a-5.d0)-2.d0*x**2))))+1cora-307
     22.d0*(2.d0*a+1.d0)*(f*((7.d0*a+24.d0)*a-10.d0)+a*(a+1.d0)*((a+2.d0cora-308
     3)*x+(4.d0*a-2.d0)*(a+5.d0)/w))/w)/w                               cora-309
      c(3)=c(3)+24.d0*x*q*(a+1.d0)/w                                    cora-310
      c(4)=c(4)-12.d0*x*(2.d0*a+1.d0)*((3.d0*f*(a+2.d0)+a*x*(a+1.d0))/(2cora-311
     1.d0*a+3.d0)+2.d0*a*(a+1.d0)/w)/w                                  cora-312
      go to 43                                                          cora-313
c multipole lq=4 l1=l2-4                                                cora-314
   24 b1=6.d0*q*(q*((42.d0*a+3.d0)*u-36.d0)+a*(24.d0*a-12.d0-u*((34.d0*acora-315
     1+3.d0)*a+8.d0)-(8.d0*a+12.d0)*(a**2-1.d0)*u**2))                  cora-316
      b2=18.d0*q*(12.d0-u*(9.d0*a+1.d0))*f                              cora-317
      b3=9.d0*f*(q*(24.d0-u*(38.d0*a+2.d0))+u*a*(2.d0*a+1.d0)*(a+1.d0)*(cora-318
     14.d0+(17.d0*a-12.d0)*u))                                          cora-319
      b4=6.d0*(q*((42.d0*a+3.d0)*u-36.d0)+a*(2.d0*a+1.d0)*(12.d0-(17.d0*cora-320
     1a-2.d0)*u-u**2*(4.d0*a+6.d0)*(a-1.d0)))                           cora-321
      if (x.eq.0.d0) go to 25                                           cora-322
      b1=b1-q*x*(x*(24.d0*q+(56.d0*a+188.d0)*a+108.d0)+108.d0*(2.d0*a+3.cora-323
     1d0)*f-2.d0*(2.d0*a+3.d0)*(58.d0*a+7.d0)*f*u-2.d0*(a+1.d0)*(2.d0*a+cora-324
     23.d0)*(15.d0*a+4.d0)*u*x+12.d0*(2.d0*a+3.d0)*f*x**2+4.d0*(a+1.d0)*cora-325
     3(2.d0*a+3.d0)*x**3)                                               cora-326
      b2=b2+q*x*(24.d0*f*x+(a+1.d0)*(108.d0-(66.d0*a+24.d0)*u+12.d0*x**2cora-327
     1))                                                                cora-328
      b3=b3+x*(24.d0*f*q*x+(a+1.d0)*(q*(324.d0+36.d0*x**2-(498.d0*a+42.dcora-329
     10)*u)+(2.d0*a+1.d0)*(f*x*(108.d0-(152.d0*a+24.d0)*u+12.d0*x**2)-a*cora-330
     2(72.d0-(168.d0*a-12.d0)*u-((57.d0*a+24.d0)*a-36.d0)*u**2-x**2*(28.cora-331
     3d0-(36.d0*a+20.d0)*u+4.d0*x**2)))))                               cora-332
      b4=b4+x*(x*(a*(2.d0*a+1.d0)*(30.d0*a+20.d0)*u-24.d0*q)-(8.d0*a+4.dcora-333
     10)*(f*(27.d0-(29.d0*a+6.d0)*u)+x*(7.d0*a+3.d0*f*x+a*x**2)))       cora-334
   25 bd=2520.d0*den*a**2*s*dsqrt(s*q*((a+1.d0)**2+f**2)*((a-1.d0)**2+e*cora-335
     1*2)*((a+2.d0)**2+f**2))                                           cora-336
      if (lt) go to 43                                                  cora-337
      c(1)=b1+18.d0*q*(f*((a-1.d0)*(8.d0*a-4.d0)-20.d0*q+(2.d0*a+3.d0)*(cora-338
     1(17.d0*a-3.d0)*a-4.d0)*u)-4.d0*(15.d0*q*((4.d0*a+4.d0)*a-1.d0)-a*(cora-339
     22.d0*a-1.d0)*((34.d0*a+55.d0)*a+16.d0)-(2.d0*a+3.d0)*(2.d0*a*u*(a+cora-340
     31.d0)*(a-1.d0)*(a+2.d0)-5.d0*(2.d0*a-1.d0)*(f*((5.d0*a+5.d0)*a+4.dcora-341
     40)+2.d0*a*(a**2-1.d0)*(a+2.d0)/w)/w))/w)/w                        cora-342
      c(2)=b3+(360.d0*q**2-72.d0*q*(4.d0*a**2+1.d0)-24.d0*(a+1.d0)*u*(q*cora-343
     1((66.d0*a-12.d0)*a-9.d0)-a**2*(2.d0*a+1.d0)*(34.d0*a-19.d0+u*(a-1.cora-344
     2d0)*(2.d0*a+3.d0)))+18.d0*(20.d0*q*f*((20.d0*a+14.d0)*a-3.d0)-(a+1cora-345
     3.d0)*(a*f*((4.d0*a**2-1.d0)*140.d0+u*(10.d0*a+15.d0)*(2.d0*a+1.d0)cora-346
     4*(5.d0*a-4.d0))-4.d0*(10.d0*q*(((30.d0*a+19.d0)*a-1.d0)*a-6.d0)-a*cora-347
     5*2*(2.d0*a+1.d0)*((2.d0*a-1.d0)*(84.d0*a+56.d0)+(2.d0*a+3.d0)*((2.cora-348
     6d0*a-2.d0)*(a+2.d0)*u-(10.d0*a-5.d0)*(7.d0*f+2.d0*(a-1.d0)*(a+2.d0cora-349
     7)/w)/w)))/w))/w)/w                                                cora-350
      c(3)=b2+72.d0*q*(5.d0*q-4.d0*a**2-1.d0-(2.d0*a+3.d0)*((a**2-1.d0)*cora-351
     1u-5.d0*(f*(3.d0*a-1.d0)+2.d0*(a**2-1.d0)*(a+2.d0)/w)/w))/w        cora-352
      c(4)=b4-18.d0*(20.d0*q*f-(a+1.d0)*((2.d0*a+1.d0)*f*(4.d0+u*(17.d0*cora-353
     1a-12.d0))-4.d0*(15.d0*q*(4.d0*a-1.d0)-(2.d0*a+1.d0)*(a*(34.d0*a-19cora-354
     2.d0)+(2.d0*a+3.d0)*(a*(a-1.d0)*u-5.d0*(f*(5.d0*a-4.d0)+2.d0*a*(a-1cora-355
     3.d0)*(a+2.d0)/w)/w)))/w))/w                                       cora-356
      if (x.eq.0.d0) go to 43                                           cora-357
      c(1)=c(1)-6.d0*q*x*((a+2.d0)*(60.d0*q-(44.d0*a-10.d0)*a-6.d0-(2.d0cora-358
     1*a+3.d0)*((a+1.d0)*((11.d0*a-6.d0)*u-2.d0*x**2)-12.d0*f*x))+(8.d0*cora-359
     2a+12.d0)*(((20.d0*a+90.d0)*a-5.d0)*f+(a+1.d0)*(a+2.d0)*((2.d0*a+5.cora-360
     3d0)*x+(10.d0*a-5.d0)*(a+6.d0)/w))/w)/w                            cora-361
      c(2)=c(2)+x*((2.d0*a+3.d0)*(240.d0*f*q+(a+1.d0)*(144.d0*q*x-(2.d0*cora-362
     1a+1.d0)*((24.d0-24.d0*x**2+(182.d0*a-72.d0)*u)*f+a*x*(44.d0+(30.d0cora-363
     2*a+8.d0)*u-4.d0*x**2))))+(a+1.d0)*(q*((2400.d0*a+8400.d0)*a-360.d0cora-364
     3)-(24.d0*a+12.d0)*(a*((102.d0*a+357.d0)*a-114.d0)-(2.d0*a+3.d0)*((cora-365
     4a+2.d0)*(10.d0*f*x+a*(x**2-(5.5d0*a-3.d0)*u))+(f*((60.d0*a+270.d0)cora-366
     5*a-120.d0)+a*(a+2.d0)*(x*(4.d0*a+10.d0)+(20.d0*a-10.d0)*(a+6.d0)/wcora-367
     6))/w)))/w)/w                                                      cora-368
      c(3)=c(3)+24.d0*x*q*(2.d0*a+3.d0)*(5.d0*f+(a+1.d0)*(x+5.d0*(a+2.d0cora-369
     1)/w))/w                                                           cora-370
      c(4)=c(4)-6.d0*x*(a+1.d0)*(60.d0*q-(2.d0*a+1.d0)*(22.d0*a+(11.d0*acora-371
     1+4.d0)*a*u-12.d0*f*x-2.d0*a*x**2-(8.d0*a+12.d0)*(10.d0*f+a*(x+5.d0cora-372
     2*(a+2.d0)/w))/w))/w                                               cora-373
      go to 43                                                          cora-374
   26 go to ( 27 , 29 , 31 , 33 , 35 , 37 ) , ll                        cora-375
c multipole lq=5 l1=l2                                                  cora-376
   27 bd=12.d0*den*a**2*(a+2.d0)*(2.d0*a+5.d0)*(4.d0*a**2-9.d0)*s*dsqrt(cora-377
     1p*q)                                                              cora-378
      b1=28.d0*p*q*f*(2.d0*a+3.d0)/(a-1.d0)                             cora-379
      b2=q*(84.d0*q-a*(48.d0*a-72.d0-u*(a+2.d0)*(6.d0*a+27.d0)))        cora-380
      b3=p*(84.d0*q-a*(6.d0*a-9.d0)*(8.d0+(a+2.d0)*u))                  cora-381
      b4=(4.d0*a-6.d0)*(14.d0*q+a*(24.d0+(7.d0*a+12.d0)*u))*f/(a+1.d0)  cora-382
      if (x.eq.0.d0) go to 28                                           cora-383
      b1=b1+(28.d0*a+42.d0)*x*p*q/(a-1.d0)                              cora-384
      b2=b2+q*x*((28.d0*a+126.d0)*f+((4.d0*a+22.d0)*a+42.d0)*x)         cora-385
      b3=b3-p*x*(2.d0*a-3.d0)*(14.d0*f-2.d0*a*x)                        cora-386
      b4=b4+x*(4.d0*a-6.d0)*(21.d0*q-a*(14.d0*a-12.d0+(a**2-3.d0)*u)-x*(cora-387
     1(2.d0*a-7.d0)*f+a*x))/(a+1.d0)                                    cora-388
   28 if (lt) go to 43                                                  cora-389
      c(1)=b1-p*q*(a+2.d0)*(24.d0*a+36.d0)/w                            cora-390
      c(2)=b3-p*(4.d0*a**2-9.d0)*(8.d0*f-a*(6.d0*a+12.d0)/w)/w          cora-391
      c(3)=b2-q*(4.d0*a**2-9.d0)*(8.d0*f-a*(6.d0*a+12.d0)/w)/w          cora-392
      c(4)=b4-(12.d0*a-18.d0)*((2.d0*a-4.d0)*q+a*(a*(8.d0+(a+2.d0)*u)+(8cora-393
     1.d0*a+12.d0)*(f-(a+2.d0)*a/w)/w))/w                               cora-394
      if (x.eq.0.d0) go to 43                                           cora-395
      c(3)=c(3)-x*q*(8.d0*a**2-18.d0)*(a+4.d0)/w                        cora-396
      c(2)=c(2)+x*p*a*(8.d0*a**2-18.d0)/w                               cora-397
      c(4)=c(4)-x*(12.d0*a-18.d0)*((2.d0*a-4.d0)*f+a*(x+(4.d0*a+6.d0)/w)cora-398
     1)/w                                                               cora-399
      go to 43                                                          cora-400
c multipole lq=5 l1=l2-1                                                cora-401
   29 bd=-60.d0*a**2*(2.d0*a+5.d0)*(2.d0*a+3.d0)*(a+3.d0)*(a+2.d0)*den*scora-402
     1*dsqrt(p*q*((a+1.d0)**2+f**2))                                    cora-403
      b1=p*q*(4.d0*a+6.d0)*((28.d0*q-(12.d0*a-56.d0)*a+40.d0)/(a-1.d0)-(cora-404
     12.d0*a+5.d0)*(a+1.d0)*u)                                          cora-405
      b2=q*f*(168.d0*q+480.d0*a+240.d0+((48.d0*a+120.d0)*a+30.d0)*u)    cora-406
      b3=p*f*(168.d0*q+480.d0*a+240.d0-(12.d0*a+6.d0)*((2.d0*a+2.d0)*a-5cora-407
     1.d0)*u)                                                           cora-408
      b4=((2.d0*a-3.d0)*(56.d0*q-(24.d0*a-208.d0)*a+80.d0-(((4.d0*a-18.dcora-409
     10)*a-52.d0)*a-10.d0)*u)*q+a**2*(2.d0*a+1.d0)*(480.d0-((24.d0*a-56.cora-410
     2d0)*a-180.d0)*u-(2.d0*a+5.d0)*(2.d0*a+3.d0)*(a+1.d0)*u**2))/(a+1.dcora-411
     30)                                                                cora-412
      if (x.eq.0.d0) go to 30                                           cora-413
      b1=b1-x*p*q*(4.d0*a+6.d0)*(7.d0*f-x*(a+1.d0))                     cora-414
      b2=b2+x*q*((14.d0*a+210.d0)*q-(56.d0*a-380.d0)*a+240.d0-(6.d0*a+6.cora-415
     1d0)*(a**2-5.d0)*u-(12.d0*a-36.d0)*f*x-(6.d0*a+6.d0)*x**2)         cora-416
      b3=b3-x*p*((98.d0*a-42.d0)*q-(2.d0*a+1.d0)*(a*(24.d0*a-116.d0+(a+1cora-417
     1.d0)*((7.d0*a+16.d0)*u-2.d0*x**2))+(14.d0*a-6.d0)*f*x))           cora-418
      b4=b4-x*((2.d0*a-3.d0)*(((2.d0*a+1.d0)*(24.d0*a-80)+(14.d0*a-70.d0cora-419
     1)*q)*f-((2.d0*a-22.d0)*a+12.d0)*q*x)+(4.d0*a+2.d0)*((((11.d0*a+17.cora-420
     2d0)*a+1.d0)*a+15.d0)*f*u-x*((a-1.d0)*(2.d0*a-3.d0)*f*x+a*((14.d0*acora-421
     3-18.d0)*a+58.d0+(a+1.d0)*((a+2.d0)*(a-4.d0)*u+x**2)))))/(a+1.d0)  cora-422
   30 if (lt) go to 43                                                  cora-423
      c(1)=b1-12.d0*p*q*(2.d0*a+3.d0)*(a+2.d0)*(2.d0*f-(2.d0*a+5.d0)*(a+cora-424
     11.d0)/w)/w                                                        cora-425
      c(2)=b3-p*(4.d0*a+6.d0)*((16.d0*a-24.d0)*q+(2.d0*a+1.d0)*(40.d0*a-cora-426
     1a*(2.d0*a+5.d0)*(a+1.d0)*(u-(6.d0*a+12.d0)/w**2)+(30.d0*a+60.d0)*fcora-427
     2/w))/w                                                            cora-428
      c(3)=b2-q*(4.d0*a+6.d0)*((16.d0*a-24.d0)*q+(2.d0*a+1.d0)*(40.d0*a+cora-429
     1(30.d0*a+60.d0)*f/w)+a*(a+1.d0)*(6.d0*a+15.d0)*(u-(10.d0*a+20.d0)/cora-430
     2w**2))/w                                                          cora-431
      c(4)=b4-6.d0*(f*(((8.d0*a-28.d0)*a+24.d0)*q+a*(4.d0*a+2.d0)*(((2.dcora-432
     10*a+2.d0)*a-5.d0)*u-40.d0))-(2.d0*a+3.d0)*((((4.d0*a+6.d0)*a+62.d0cora-433
     2)*a+20.d0)*q+a*(2.d0*a+1.d0)*((2.d0*a+5.d0)*(a+1.d0)*u*a-40.d0*a-(cora-434
     310.d0*a+20.d0)*(4.d0*f+a*(a+1.d0)*(2.d0*a+5.d0)/w)/w))/w)/w       cora-435
      if (x.eq.0.d0) go to 43                                           cora-436
      c(1)=c(1)+x*p*q*(12.d0*a+18.d0)*(a+1.d0)*(a+2.d0)/w               cora-437
      c(2)=c(2)+x*p*(4.d0*a+6.d0)*(((8.d0*a-8.d0)*a-6.d0)*f-a*(a+1.d0)*(cora-438
     12.d0*a+1.d0)*(x+(3.d0*a+6.d0)/w))/w                               cora-439
      c(3)=c(3)-x*q*(24.d0*a+36.d0)*((2.d0*a-3.d0)*f+(a+1.d0)*(x+(5.d0*acora-440
     1+10.d0)/w))/w                                                     cora-441
      c(4)=c(4)+6.d0*x*((a-2.d0)*(a-3.d0)*(2.d0*a-3.d0)*q+(2.d0*a+1.d0)*cora-442
     1(((8.d0*a-12.d0)*a+40.d0)*a+((2.d0*a-2.d0)*a+6.d0)*f*x+a*(a+1.d0)*cora-443
     2((a**2-5.d0)*u+x**2)+(4.d0*a+6.d0)*(((2.d0*a+2.d0)*a+10.d0)*f+a*(acora-444
     3+1.d0)*(x+(5.d0*a+10.d0)/w))/w))/w                                cora-445
      go to 43                                                          cora-446
c multipole lq=5 l1=l2-2                                                cora-447
   31 dn=720.d0*a**2*(4.d0*a**2-9.d0)*(2.d0*a+5.d0)*(a+2.d0)            cora-448
      bd=den*dn*s*dsqrt(q*((a+1.d0)**2+f**2))/2.d0                      cora-449
      b1=2.d0*(2.d0*a+3.d0)*(24.d0*((2.d0*a+5.d0)*(a+2.d0)+7.d0*q)/(a-1.cora-450
     1d0)-(2.d0*a-3.d0)*(11.d0*a-10.d0)*u)*f                            cora-451
      b2=-6.d0*(24.d0*(2.d0*a**2.d0-15.d0*a-10.d0)-168.d0*q+5.d0*(a+1.d0cora-452
     1)*(2.d0*a**2+a-6.d0)*u)                                           cora-453
      b3=((1008.d0*q-144.d0*(2.d0*a**2-15.d0*a-10.d0))*q-(2.d0*a-3.d0)*ucora-454
     1*(6.d0*(17.d0*a**2-9.d0*a+10.d0)*q+a**2*(2.d0*a+1.d0)*(24.d0*(a+10cora-455
     2.d0)-15.d0*(a+1.d0)*(a+2.d0)*u)))                                 cora-456
      b4=2.d0*(2.d0*a-3.d0)*(168.d0*q+(2.d0*a+1.d0)*(24.d0*(a+10.d0)-(11cora-457
     1.d0*a**2-a-30.d0)*u))*f/(a+1.d0)                                  cora-458
      if (x.eq.0.d0) go to 32                                           cora-459
      b1=b1+x*2.d0*(2.d0*a+3.d0)*((20.d0*a**3-198.d0*a**2+316.d0*a+240.dcora-460
     10-42.d0*(2.d0*a-5.d0)*q)/(a-1.d0)+(2.d0*a-3.d0)*(12.d0*f*x+(a+1.d0cora-461
     2)*((9.d0*a+10.d0)*u-2.d0*x**2)))                                  cora-462
      b2=b2-x*12.d0*(7.d0*(2.d0*a-3.d0)*f-(a+1.d0)*(2.d0*a-3.d0)*x)     cora-463
      b3=b3-x*(2.d0*a-3.d0)*((420.d0*f-36.d0*(5.d0*a-2.d0)*x)*q+(2.d0*a+cora-464
     11.d0)*(48.d0*(a+10.d0)*f-(40.d0*a**2-38.d0*a-60.d0)*f*u+4.d0*(5.d0cora-465
     2*a-58.d0)*a*x+12.d0*(2.d0*a-1.d0)*f*x**2+a*(a+1.d0)*x*(8.d0*(3.d0*cora-466
     3a+4.d0)*u-4.d0*x**2)))                                            cora-467
      b4=b4-x*2.d0*(2.d0*a-3.d0)*(42.d0*(2.d0*a-1.d0)*q-(2.d0*a+1.d0)*(6cora-468
     1.d0*(2.d0*a-1.d0)*f*x+a*((10.d0*a-116.d0)+(a+1.d0)*((9.d0*a+16.d0)cora-469
     2*u-2.d0*x**2))))/(a+1.d0)                                         cora-470
   32 if (lt) go to 43                                                  cora-471
      b1=b1*q                                                           cora-472
      b2=b2*q                                                           cora-473
      c(1)=b1-6.d0*q*(a+2.d0)*(2.d0*a+3.d0)*(8.d0*a*(2.d0*a+5.d0)+24.d0*cora-474
     1q-5.d0*a*(a+1.d0)*(2.d0*a-3.d0)*u+4.d0*(2.d0*a-3.d0)*(2.d0*a+5.d0)cora-475
     2*(f+5.d0*a*(a+1.d0)/w)/w)/w                                       cora-476
      c(2)=b3-(4.d0*a**2-9.d0)*(8.d0*(12.d0*q+a*(a+10.d0)*(2.d0*a+1.d0)*cora-477
     1u)*f-(6.d0*a+12.d0)*((a+1.d0)*(20.d0*q-a**2*(10.d0*a+5.d0)*u)+(8.dcora-478
     20*a+4.d0)*a*(2.d0*a+5.d0)*(6.d0*f+5.d0*a*(a+1.d0)/w)/w)/w)/w      cora-479
      c(3)=b2-q*24.d0*(4.d0*a**2-9.d0)*(4.d0*f-5.d0*(a+1.d0)*(a+2.d0)/w)cora-480
     1/w                                                                cora-481
      c(4)=b4-6.d0*(2.d0*a-3.d0)*(24.d0*(a-2.d0)*q+a*(2.d0*a+1.d0)*(8.d0cora-482
     1*(a+10.d0)-5.d0*(a+1.d0)*(a+2.d0)*u)+4.d0*(2.d0*a+3.d0)*(2.d0*a+1.cora-483
     2d0)*((a+10.d0)*f+5.d0*a*(a+1.d0)*(a+2.d0)/w)/w)/w                 cora-484
      if (x.eq.0.d0) go to 43                                           cora-485
      c(1)=c(1)+x*q*(12.d0*a+24.d0)*(4.d0*a**2-9.d0)*(3.d0*f-(a+1.d0)*(xcora-486
     1+(4.d0*a+10.d0)/w))/w                                             cora-487
      c(2)=c(2)+x*(8.d0*a**2-18.d0)*(36.d0*(a-1.d0)*q-(2.d0*a+1.d0)*(6.dcora-488
     10*(a-2.d0)*f*x-a*(8.d0*(a+10.d0)-(a+1.d0)*((9.d0*a+10.d0)*u-2.d0*xcora-489
     2**2))-6.d0*(a+2.d0)*((a+10.d0)*f+a*(a+1.d0)*(x+(4.d0*a+10.d0)/w))/cora-490
     3w))/w                                                             cora-491
      c(3)=c(3)+x*q*24.d0*(4.d0*a**2-9.d0)*(a+1.d0)/w                   cora-492
      c(4)=c(4)+x*12.d0*(2.d0*a+1.d0)*(2.d0*a-3.d0)*(3.d0*(a-2.d0)*f-a*(cora-493
     1a+1.d0)*(x+(4.d0*a+6.d0)/w))/w                                    cora-494
      go to 43                                                          cora-495
c multipole lq=5 l1=l2-3                                                cora-496
   33 bd=-2520.d0*den*a**2*(a+2.d0)*(a+3.d0)*(2.d0*a+3.d0)*(2.d0*a+5.d0)cora-497
     1*s*dsqrt(q*((a+1.d0)**2+f**2)*((a+2.d0)**2+f**2))                 cora-498
      b1=q*(4.d0*a+6.d0)*(((24.d0*((a+36.d0)*a+40.d0)+168.d0*q)*q+48.d0*cora-499
     1a*(a+2.d0)*(a+3.d0)*(2.d0*a+5.d0))/(a-1.d0)-(a*(((80.d0*a+620.d0)*cora-500
     2a+966.d0)*a+540.d0)+((28.d0*a-26.d0)*a+60.d0)*q-6.d0*a*(a+1.d0)*(acora-501
     3+2.d0)*(2.d0*a+3.d0)*(2.d0*a+5.d0)*u)*u)                          cora-502
      b2=6.d0*f*q*(48.d0*((2.d0*a+21.d0)*a+20.d0)+168.d0*q-(((16.d0*a+36cora-503
     1.d0)*a-22.d0)*a-60.d0)*u)                                         cora-504
      b3=6.d0*f*((48.d0*((2.d0*a+21.d0)*a+20.d0)+168.d0*q-(10.d0*a-12.d0cora-505
     1)*(4.d0*a**2+5.d0)*u)*q+a*(a+1.d0)*(2.d0*a+1.d0)*(((16.d0*a+168.d0cora-506
     2)*a+720.d0)-(2.d0*a+3.d0)*(a+2.d0)*(8.d0*a+45.d0)*u)*u)           cora-507
      b4=((2.d0*a-3.d0)*(48.d0*((a+48.d0)*a+40.d0)+336.d0*q)*q/(a+1.d0)-cora-508
     1(4.d0*a**2-9.d0)*(28.d0*a-40.d0)*q*u+a*(2.d0*a+1.d0)*(96.d0*((2.d0cora-509
     2*a+21.d0)*a+90.d0)-(4.d0*a+6.d0)*(((40.d0*a+282.d0)*a+180.d0)-(a+2cora-510
     3.d0)*(2.d0*a+3.d0)*(6.d0*a+15.d0)*u)*u))                          cora-511
      if (x.eq.0.d0) go to 34                                           cora-512
      b1=b1+x*q*(4.d0*a+6.d0)*((((28.d0*a+402.d0)*a+704.d0)*a+360.d0)*x-cora-513
     1((88.d0*a+700.d0)*a+600.d0)*f-126.d0*f*q+(54.d0*a+24.d0)*q*x+(2.d0cora-514
     2*a+3.d0)*(((5.d0*a-53.d0)*a-70.d0)*f*u-(8.d0*a+2.d0)*f*x**2-(a+1.dcora-515
     30)*(a+2.d0)*((15.d0*a+25.d0)*u-2.d0*x**2)*x))                     cora-516
      b2=b2-x*6.d0*q*((((8.d0*a+372.d0)*a+696.d0)*a+360.d0)+(70.d0*a+42.cora-517
     1d0)*q-(2.d0*a+3.d0)*((10.d0*a+6.d0)*f*x+(a+1.d0)*(a+2.d0)*((11.d0*cora-518
     2a+25.d0)*u-2.d0*x**2)))                                           cora-519
      b3=b3+x*((48.d0*((13.d0*a-7.d0)*a-3.d0)*f*x-(((144.d0*a+6696.d0)*acora-520
     1+1104.d0)*a-3600.d0)-84.d0*(13.d0*a-9.d0)*q)*q+(a+1.d0)*(((((352.dcora-521
     20*a+224.d0)*a+1518.d0)*a+1260.d0)*u-12.d0*((20.d0*a-14.d0)*a-3.d0)cora-522
     3*x**2)*q+(2.d0*a+1.d0)*((2.d0*a-3.d0)*((88.d0*a+720.d0)+(16.d0*a+2cora-523
     44.d0)*x**2)*f*x+a*((((280.d0*a+2292.d0)*a+2772.d0)*a+1080.d0)*u-(1cora-524
     592.d0*a+2016.d0)*a-8640.d0-28.d0*((2.d0*a+31.d0)*a+24.d0)*x**2)-(2cora-525
     6.d0*a+3.d0)*(((16.d0*a-230.d0)*a-300.d0)*f*u*x+a*(a+2.d0)*(((57.d0cora-526
     7*a+171.d0)*a+90.d0)*u**2-(36.d0*a+62.d0)*u*x**2+4.d0*x**4)))))    cora-527
      b4=b4-x*((4.d0*a-6.d0)*(126.d0*a+42.d0)*f*q/(a+1.d0)-36.d0*(2.d0*acora-528
     1-3.d0)*(3.d0*a+1.d0)*q*x-(4.d0*a+2.d0)*(a*((28.d0*a+434.d0)*a+336.cora-529
     2d0)*x-(2.d0*a-3.d0)*(44.d0*a+360.d0)*f+(2.d0*a+3.d0)*(((5.d0*a-79.cora-530
     3d0)*a-150.d0)*f*u-(8.d0*a-12.d0)*f*x**2-a*(a+2.d0)*((15.d0*a+31.d0cora-531
     4)*u-2.d0*x**2)*x)))                                               cora-532
   34 if (lt) go to 43                                                  cora-533
      c(1)=b1-12.d0*q*(2.d0*a+3.d0)*(a+2.d0)*((12.d0*q+(2.d0*a+3.d0)*((8cora-534
     1.d0*a+41.d0)*a+15.d0)*u)*f-(4.d0*a+10.d0)*((a+3.d0)*4.d0*f+((33.d0cora-535
     2+13.d0*a)*q-a*(a+3.d0)*(4.d0*a-6.d0)-(2.d0*a+3.d0)*(3.d0*a*(a+1.d0cora-536
     3)*(a+2.d0)*u-10.d0*(a+3.d0)*((4.d0*a+1.d0)*f+3.d0*a*(a+1.d0)*(a+2.cora-537
     4d0)/w)/w))/w))/w                                                  cora-538
      c(3)=b2-12.d0*q*(2.d0*a+3.d0)*((((32.d0*a+288.d0)*a+456.d0)*a+240.cora-539
     1d0)+8.d0*(2.d0*a-3.d0)*q-(a+2.d0)*(2.d0*a+3.d0)*(3.d0*(a+1.d0)*(2.cora-540
     2d0*a+5.d0)*u-10.d0*((2.d0*a+11.d0)*f+3.d0*(2.d0*a+5.d0)*(a+1.d0)*(cora-541
     3a+2.d0)/w)/w))/w                                                  cora-542
      c(2)=b3-(4.d0*a+6.d0)*((((192.d0*a+1728.d0)*a+2736.d0)*a+1440.d0+4cora-543
     18.d0*(2.d0*a-3.d0)*q)*q-(a+1.d0)*((((176.d0*a+964.d0)*a+2166.d0)*acora-544
     2+540.d0)*q-a**2*(2.d0*a+1.d0)*(((16.d0*a+168.d0)*a+720.d0)+6.d0*(acora-545
     3+2.d0)*(2.d0*a+3.d0)*(2.d0*a+5.d0)*u))*u-6.d0*(a+2.d0)*((2.d0*a+3.cora-546
     4d0)*((a+1.d0)*(2.d0*a+1.d0)*(20.d0*a+75.d0)*a*u-(20.d0*a+110.d0)*qcora-547
     5)*f+(a+1.d0)*(2.d0*a+5.d0)*(6.d0*(28.d0*a**2*(2.d0*a+1.d0)*(a+3.d0cora-548
     6)-((52.d0*a+161.d0)*a+30.d0)*q+a**2*(a+2.d0)*(2.d0*a+1.d0)*(2.d0*acora-549
     7+3.d0)*u)-10.d0*a*(a+3.d0)*(2.d0*a+1.d0)*(2.d0*a+3.d0)*(14.d0*f+6.cora-550
     8d0*a*(a+2.d0)/w)/w)/w)/w)/w                                       cora-551
      c(4)=b4+12.d0*(((2.d0*a+1.d0)*(a+1.d0)*(((16.d0*a+168.d0)*a+720.d0cora-552
     1)-(a+2.d0)*(2.d0*a+3.d0)*(8.d0*a+45.d0)*u)-12.d0*(2.d0*a-3.d0)*(a-cora-553
     22.d0)*q)*f+(2.d0*a+3.d0)*(a+1.d0)*(((52.d0*a+266.d0)*a+660.d0)*q-acora-554
     3*(2.d0*a+1.d0)*((8.d0*a+84.d0)*a+360.d0)-(a+2.d0)*(2.d0*a+1.d0)*(2cora-555
     4.d0*a+3.d0)*(3.d0*a*(2.d0*a+5.d0)*u-10.d0*((8.d0*a+30.d0)*f+3.d0*acora-556
     5*(2.d0*a+5.d0)*(a+2.d0)/w)/w))/w)/w                               cora-557
      if (x.eq.0.d0) go to 43                                           cora-558
      c(1)=c(1)+6.d0*q*x*(2.d0*a+3.d0)*(a+2.d0)*(((40.d0*a+300.d0)*a+476cora-559
     1.d0)*a+240.d0+(18.d0*a-6.d0)*q-(2.d0*a+3.d0)*((2.d0*a-10.d0)*f*x+(cora-560
     2a+1.d0)*(a+2.d0)*((11.d0*a+15.d0)*u-2.d0*x**2)-(8.d0*a+20.d0)*((3.cora-561
     3d0*a+13.d0)*f+(a+1.d0)*(a+2.d0)*(x+(5.d0*a+15.d0)/w))/w))/w       cora-562
      c(2)=c(2)+x*(4.d0*a+6.d0)*(12.d0*(2.d0*a-3.d0)*(4.d0*a-1.d0)*f*q-(cora-563
     1a+1.d0)*(((60.d0*a-42.d0)*a+180.d0)*q*x+(2.d0*a+1.d0)*(((32.d0*a+3cora-564
     236.d0)*a+1440.d0)*f-(2.d0*a+3.d0)*((28.d0*a+202.d0)*a+180.d0)*f*u+cora-565
     3a*(((40.d0*a+308.d0)*a+120.d0)-(a+2.d0)*(2.d0*a+3.d0)*((15.d0*a+25cora-566
     4.d0)*u-2.d0*x**2))*x-(2.d0*a+3.d0)*(2.d0*a-24.d0)*f*x**2)+(3.d0*a+cora-567
     56.d0)*(((92.d0*a+406.d0)*a+780.d0)*q-(2.d0*a+1.d0)*(a*((8.d0*a+84.cora-568
     6d0)*a+360.d0)+(2.d0*a+3.d0)*(a*(a+2.d0)*((11.d0*a+15.d0)*u-2.d0*x*cora-569
     7*2)-(6.d0*a+40.d0)*f*x-(8.d0*a+20.d0)*((30.d0+8.d0*a)*f+a*(a+2.d0)cora-570
     8*(x+(5.d0*a+15.d0)/w))/w)))/w))/w                                 cora-571
      c(3)=c(3)+24.d0*x*q*(2.d0*a+3.d0)**2*((2.d0*a-3.d0)*f-(a+1.d0)*(a+cora-572
     12.d0)*(x+5.d0*(a+2.d0)/w))/w                                      cora-573
      c(4)=c(4)+x*6.d0*(a+1.d0)*(18.d0*(a-2.d0)*(2.d0*a-3.d0)*q+(2.d0*a+cora-574
     11.d0)*(a*((40.d0*a+308.d0)*a+120.d0)-(2.d0*a+3.d0)*((2.d0*a-24.d0)cora-575
     2*f*x+a*(a+2.d0)*((11.d0*a+25.d0)*u-2.d0*x**2)-4.d0*(2.d0*a+3.d0)*(cora-576
     3(20.d0+3.d0*a)*f+a*(a+2.d0)*(x+5.d0*(a+2.d0)/w))/w)))/w           cora-577
      go to 43                                                          cora-578
c multipole lq=5 l1=l2-4                                                cora-579
   35 bd=10080.d0*den*a**2*(2.d0*a+5.d0)*(a+2.d0)*s**2*dsqrt(q*((a+1.d0)cora-580
     1**2+f**2)*((a+2.d0)**2+f**2)*((a-1.d0)**2+e**2))                  cora-581
      b1=q*(((336.d0*q+48.d0*((8.d0*a+22.d0)*a+47.d0))*q-96.d0*(2.d0*a-1cora-582
     1.d0)*(a+2.d0)*(2.d0*a+5.d0)*(3.d0*a-7.d0))/((a-1.d0)*(2.d0*a-3.d0)cora-583
     2)+(4.d0*(((162.d0*a+683.d0)*a+538.d0)*a-280.d0)-4.d0*(7.d0*a-38.d0cora-584
     3)*q-(2.d0*a+3.d0)*(((163.d0*a+497.d0)*a-16.d0)*a-140.d0)*u)*u)*f  cora-585
      b2=3.d0*q*(((96.d0*((((12.d0*a+56.d0)*a+29.d0)*a-70.d0)*a-70.d0)+(cora-586
     148.d0*((4.d0*a+28.d0)*a+47.d0)+336.d0*q)*q)/(2.d0*a-3.d0)-4.d0*(((cora-587
     2((66.d0*a+307.d0)*a+172.d0)*a-280.d0)*a-280.d0)+(a-2.d0)*(4.d0*a-1cora-588
     39.d0)*q)*u)/(2.d0*a+3.d0)+35.d0*(a**2-1.d0)*(a+2.d0)**2*u**2)     cora-589
      b3=(((1008.d0*q+144.d0*((4.d0*a+28.d0)*a+47.d0))*q+288.d0*((((12.dcora-590
     10*a+56.d0)*a+29.d0)*a-70.d0)*a-70.d0))*q/(2.d0*a-3.d0)-12.d0*(((((cora-591
     2178.d0*a+967.d0)*a+1410.d0)*a+428.d0)*a-280.d0)+(a-2.d0)*(10.d0*a-cora-592
     319.d0)*q)*q*u+(3.d0*a+3.d0)*(((((458.d0*a+2185.d0)*a+2899.d0)*a-35cora-593
     42.d0)*a-420.d0)*q*u+(4.d0*a+2.d0)*a**2*(8.d0*((6.d0*a+37.d0)*a+70.cora-594
     5d0)-(((62.d0*a+349.d0)*a+524.d0)*a-140.d0)*u))*u)/(2.d0*a+3.d0)-52cora-595
     6.5d0*a**2*(a**2-1.d0)*(a+2.d0)**2*(2.d0*a+1.d0)*u**3              cora-596
      b4=(((336.d0*q+48.d0*((8.d0*a+34.d0)*a+47.d0)-(4.d0*a-8.d0)*((14.dcora-597
     10*a-41.d0)*a+57.d0)*u)*q/(a+1.d0)+(2.d0*a+1.d0)*(4.d0*(((162.d0*a+cora-598
     2863.d0)*a+1070.d0)*a-840.d0)*u-96.d0*((6.d0*a+37.d0)*a+70.d0)))/(2cora-599
     3.d0*a+3.d0)-(2.d0*a+1.d0)*(((163.d0*a+631.d0)*a+256.d0)*a-420.d0)*cora-600
     4u**2)*f                                                           cora-601
      if (x.eq.0.d0) go to 36                                           cora-602
      b1=b1+x*q*(8.d0*((((((180.d0*a+604.d0)*a-425.d0)*a-1813.d0)*a-394.cora-603
     1d0)*a+840.d0)+(((34.d0*a+147.d0)*a-193.d0)*a-450.d0)*q+42.d0*(a-2.cora-604
     2d0)*q**2)/((1.d0-a)*(2.d0*a-3.d0))+96.d0*f*q*x+16.d0*((((26.d0*a+1cora-605
     326.d0)*a+133.d0)*a-13.d0)*a-70.d0)*u+4.d0*((41.d0*a+115.d0)*a+170.cora-606
     4d0)*q*u+4.d0*((2.d0*a-1.d0)*a-54.d0)*f*x-8.d0*(5.d0*a+2.d0)*q*x**2cora-607
     5-(((152.d0*a+892.d0)*a+1380.d0)*a+664.d0)*x**2+(2.d0*a+3.d0)*(4.d0cora-608
     6*((20.d0*a+97.d0)*a+62.d0)*f*u*x+4.d0*(a-2.d0)*f*x**3+(a+1.d0)*(a+cora-609
     72.d0)*(((44.d0*a+36.d0)*u-4.d0*x**2)*x**2-((87.d0*a+67.d0)*a-70.d0cora-610
     8)*u**2)))                                                         cora-611
      b2=b2-12.d0*x*q*((28.d0*f*q+2.d0*((18.d0*a+83.d0)*a+56.d0)*f-(((34cora-612
     1.d0*a+217.d0)*a+341.d0)*a+166.d0)*x-4.d0*(3.d0*a+1.d0)*q*x)/(2.d0*cora-613
     2a+3.d0)+(((9.d0*a+58.d0)*a+44.d0)*u+2.d0*a*x**2)*f+(a+1.d0)*(a+2.dcora-614
     30)*(9.d0*(a+1.d0)*u-x**2)*x)                                      cora-615
      b3=b3+x*(((96.d0*(5.d0*a-3.d0)*q+4.d0*(((170.d0*a+1101.d0)*a+901.dcora-616
     10)*a+162.d0)-24.d0*((10.d0*a-5.d0)*a-2.d0)*f*x)*q*x-4.d0*((((22.d0cora-617
     2*a+543.d0)*a+629.d0)*a+510.d0)*u+168.d0*q)*f*q+(a+1.d0)*(4.d0*(((2cora-618
     36.d0*a-5.d0)*a+18.d0)*x**2-(((166.d0*a+627.d0)*a+1415.d0)*a+558.d0cora-619
     4)*u)*q*x+(2.d0*a+1.d0)*((96.d0*((6.d0*a+37.d0)*a+70.d0)-4.d0*((2.dcora-620
     50*a-105.d0)*a-498.d0)*x**2-8.d0*(((138.d0*a+751.d0)*a+1012.d0)*a-4cora-621
     620.d0)*u)*f+a*(4.d0*((38.d0*a+197.d0)*a+154.d0)*x**2-(((572.d0*a+2cora-622
     7362.d0)*a+960.d0)*a-40.d0)*u+8.d0*((90.d0*a+491.d0)*a+674.d0))*x))cora-623
     8)/(2.d0*a+3.d0)-24.d0*(17.d0*a+50.d0)*f*q+(a+1.d0)*(2.d0*a+1.d0)*(cora-624
     9(((373.d0*a+1411.d0)*a+544.d0)*a-420.d0)*f*u**2-4.d0*((23.d0*a+125cora-625
     a.d0)*a+54.d0)*f*u*x**2-4.d0*(a-6.d0)*f*x**4+a*(a+2.d0)*(((141.d0*acora-626
     b+199.d0)*a-22.d0)*u**2-(50.d0*a+48.d0)*u*x**2+4.d0*x**4)*x))      cora-627
      b4=b4+x*(((48.d0*((4.d0*a-4.d0)*a-1.d0)*f*x-8.d0*(((34.d0*a+225.d0cora-628
     1)*a-61.d0)*a-168.d0)-336.d0*(a-1.d0)*q)*q/(a+1.d0)+4.d0*((((82.d0*cora-629
     2a+315.d0)*a+902.d0)*a+396.d0)*u-a*(20.d0*a-26.d0)*x**2)*q+4.d0*(2.cora-630
     3d0*a+1.d0)*(((2.d0*a-105.d0)*a-498.d0)*f*x+a*((((104.d0*a+430.d0)*cora-631
     4a+171.d0)*a-10.d0)*u-2.d0*((90.d0*a+491.d0)*a+674.d0)-((38.d0*a+19cora-632
     57.d0)*a+154.d0)*x**2)))/(2.d0*a+3.d0)+(2.d0*a+1.d0)*(4.d0*((20.d0*cora-633
     6a+107.d0)*a+54.d0)*f*u*x+4.d0*(a-6.d0)*f*x**3+a*(a+2.d0)*(4.d0*(11cora-634
     7.d0*a+12.d0)*u*x**2-((87.d0*a+145.d0)*a-22.d0)*u**2-4.d0*x**4)))  cora-635
   36 if (lt) go to 43                                                  cora-636
      c(1)=b1-3.d0*q*(a+2.d0)*(((16.d0*((56.d0*a+62.d0)*a-177.d0)+48.d0*cora-637
     1q)*q-32.d0*a*(2.d0*a-1.d0)*(2.d0*a+5.d0)*(3.d0*a-7.d0))/(2.d0*a-3.cora-638
     2d0)+(4.d0*a*(((62.d0*a+159.d0)*a+29.d0)*a+70.d0)-4.d0*((97.d0*a+22cora-639
     39.d0)*a-6.d0)*q+35.d0*a*(a**2-1.d0)*(2.d0*a+3.d0)*(a+2.d0)*u)*u-4.cora-640
     4d0*(2.d0*a+5.d0)*((4.d0*(2.d0*a-1.d0)*(3.d0*a-7.d0)-92.d0*q+(2.d0*cora-641
     5a+3.d0)*((67.d0*a-17.d0)*a-14.d0)*u)*f-5.d0*(4.d0*((59.d0*a+59.d0)cora-642
     6*a-18.d0)*q-4.d0*a*(2.d0*a-1.d0)*(3.d0*a+1.d0)*(11.d0*a+14.d0)-(2*cora-643
     7a+3.d0)*(7.d0*a*(a**2-1.d0)*(a+2.d0)*u-6.d0*(2.d0*a-1.d0)*(((17.d0cora-644
     8*a+17.d0)*a+14.d0)*f+7.d0*a*(a**2-1.d0)*(a+2.d0)/w)/w))/w)/w)/w   cora-645
      c(2)=b3+(((96.d0*((12.d0*a+56.d0)*a+59.d0-q)-8.d0*(((188.d0*a+864.cora-646
     1d0)*a+889.d0)*a-18.d0)*u)*q+a*(a+1.d0)*(2.d0*a+1.d0)*(16.d0*((6.d0cora-647
     2*a+37.d0)*a+70.d0)*u+4.d0*(2.d0*a+3.d0)*((67.d0*a+136.d0)*a-140.d0cora-648
     3)*u**2))*f+3.d0*(a+2.d0)*(40.d0*((19.d0*a+46.d0)*q-((12.d0*a+32.d0cora-649
     4)*a+7.d0)*a-14.d0)*q-(a+1.d0)*(20.d0*(((132.d0*a+292.d0)*a-97.d0)*cora-650
     5a-42.d0)*q-a**2*(2.d0*a+1.d0)*(20.d0*((66.d0*a+127.d0)*a-98.d0)+35cora-651
     6.d0*(a-1.d0)*(2.d0*a+3.d0)*(a+2.d0)*u))*u+4.d0*(2.d0*a+5.d0)*(36.dcora-652
     70*((54.d0*a+37.d0)*a-10.d0)*q*f-(a+1.d0)*(a*(2.d0*a+1.d0)*(672.d0*cora-653
     8(2.d0*a-1.d0)+6.d0*(2.d0*a+3.d0)*(17.d0*a-14.d0)*u)*f-5.d0*(14.d0*cora-654
     9(((86.d0*a+55.d0)*a-3.d0)*a-18.d0)*q-a**2*(2.d0*a+1.d0)*(112.d0*(2cora-655
     a.d0*a-1.d0)*(3.d0*a+2.d0)+(2.d0*a+3.d0)*(7.d0*(a-1.d0)*(a+2.d0)*u-cora-656
     b6.d0*(2.d0*a-1.d0)*(24.d0*f+7.d0*(a-1.d0)*(a+2.d0)/w)/w)))/w))/w)/cora-657
     cw)/w                                                              cora-658
      c(3)=b2+12.d0*q*((8.d0*((12.d0*a+56.d0)*a+59.d0)-8.d0*q-(2.d0*a+3.cora-659
     1d0)*((32.d0*a+98.d0)*a-4.d0)*u)*f+5.d0*(a+2.d0)*((38.d0*a+92.d0)*qcora-660
     2-(((24.d0*a+64.d0)*a+14.d0)*a+28.d0)-(2.d0*a+3.d0)*(7.d0*(a**2-1.dcora-661
     30)*(a+2.d0)*u-6.d0*(2.d0*a+5.d0)*((10.d0*a-4.d0)*f+7.d0*(a**2-1.d0cora-662
     4)*(a+2.d0)/w)/w))/w)/w                                            cora-663
      c(4)=b4-3.d0*(((16.d0*(((56.d0*a+330.d0)*a+619.d0)*a+354.d0+(3.d0*cora-664
     1a-6.d0)*q)*q-(a+1.d0)*(4.d0*(((194.d0*a+935.d0)*a+1292.d0)*a-36.d0cora-665
     2)*q*u+a*(2.d0*a+1.d0)*(32.d0*((6.d0*a+37.d0)*a+70.d0)-4.d0*(((62.dcora-666
     30*a+349.d0)*a+524.d0)*a-140.d0)*u-35.d0*(a-1.d0)*(2.d0*a+3.d0)*(a+cora-667
     42.d0)**2*u**2))))/(2.d0*a+3.d0)+4.d0*(4.d0*((46.d0*a+213.d0)*a+230cora-668
     5.d0)*q*f-(a+1.d0)*((2.d0*a+1.d0)*((24.d0*a+148.d0)*a+280.d0+(2.d0*cora-669
     6a+3.d0)*((67.d0*a+136.d0)*a-140.d0)*u)*f-5.d0*(a+2.d0)*(4.d0*((118cora-670
     7.d0*a+257.d0)*a-90.d0)*q-4.d0*a*(2.d0*a+1.d0)*((66.d0*a+127.d0)*a-cora-671
     898.d0)-(2.d0*a+1.d0)*(2.d0*a+3.d0)*(7.d0*a*(a-1.d0)*(a+2.d0)*u-6.dcora-672
     90*(2.d0*a+5.d0)*((17.d0*a-14.d0)*f+7.d0*a*(a+2.d0)*(a-1.d0)/w)/w))cora-673
     a/w))/w)/w                                                         cora-674
      if (x.eq.0.d0) go to 43                                           cora-675
      c(1)=c(1)-q*x*(3.d0*a+6.d0)*(8.d0*((38.d0*a+167.d0)*a+171.d0-3.d0*cora-676
     1q)*f+4.d0*(((26.d0*a+145.d0)*a+231.d0)*a+106.d0)*x+(40.d0*a+64.d0)cora-677
     2*q*x+(2.d0*a+3.d0)*((8.d0*a+32.d0)*f*x**2-4.d0*((35.d0*a+101.d0)*acora-678
     3+6.d0)*f*u+4.d0*(a+1.d0)*(a+2.d0)*(x**3-(9.d0*a+4.d0)*u*x))-4.d0*(cora-679
     42.d0*a+5.d0)*((((44.d0*a+94.d0)*a-22.d0)*a+28.d0)-4.d0*(19.d0*a+44cora-680
     5.d0)*q-(2.d0*a+3.d0)*(4.d0*(3.d0*a+8.d0)*f*x+(a+1.d0)*(a+2.d0)*(2.cora-681
     6d0*x**2-(13.d0*a-7.d0)*u)+10.d0*(((11.d0*a+59.d0)*a-6.d0)*f+(a+1.dcora-682
     70)*(a+2.d0)*((a+3.d0)*x+(3.d0*a+21.d0)*(2.d0*a-1.d0)/w))/w))/w)/w cora-683
      c(2)=c(2)+x*(8.d0*(((196.d0*a+1104.d0)*a+1901.d0)*a+1026.d0+(15.d0cora-684
     1*a-18.d0)*q+12.d0*(5.d0*a+4.d0)*f*x)*q+(a+1.d0)*(32.d0*((4.d0*a+11cora-685
     2.d0)*a+18.d0)*q*x**2-8.d0*(((212.d0*a+966.d0)*a+1267.d0)*a+54.d0)*cora-686
     3q*u+(2.d0*a+1.d0)*(8.d0*((38.d0*a+213.d0)*a+318.d0)*f*x+4.d0*a*(((cora-687
     4(106.d0*a+599.d0)*a+912.d0)*a-140.d0)*u+((26.d0*a+107.d0)*a+46.d0)cora-688
     5*x**2-8.d0*((6.d0*a+37.d0)*a+70.d0))+(2.d0*a+3.d0)*(8.d0*(a+6.d0)*cora-689
     6f*x**3-4.d0*((47.d0*a+170.d0)*a+48.d0)*f*u*x+a*(a+2.d0)*(((87.d0*acora-690
     7+67.d0)*a-70.d0)*u**2-4.d0*(11.d0*a+9.d0)*u*x**2+4.d0*x**4))))+3.dcora-691
     80*(a+2.d0)*(32.d0*((24.d0*a+107.d0)*a+110.d0)*f*q+(a+1.d0)*(96.d0*cora-692
     9((4.d0*a+17.d0)*a+20.d0)*q*x-(8.d0*a+4.d0)*(2.d0*((6.d0*a+37.d0)*acora-693
     a+70.d0)*f+a*((22.d0*a+125.d0)*a+194.d0)*x+(2.d0*a+3.d0)*(((61.d0*acora-694
     b+143.d0)*a-70.d0)*f*u+a*(a+2.d0)*((9.d0*a+4.d0)*u-x**2)*x-(6.d0*a+cora-695
     c20.d0)*f*x**2))+(8.d0*a+20.d0)*(((532.d0*a+2246.d0)*a-180.d0)*q-(2cora-696
     d.d0*a+1.d0)*(4.d0*a*((66.d0*a+295.d0)*a-98.d0)-(2.d0*a+3.d0)*((22.cora-697
     ed0*a+60.d0)*f*x+a*(a+2.d0)*(2.d0*x**2-(13.d0*a-7.d0)*u)+10.d0*(((1cora-698
     f7.d0*a+93.d0)*a-42.d0)*f+a*(a+2.d0)*((a+3.d0)*x+3.d0*(a+7.d0)*(2.dcora-699
     g0*a-1.d0)/w))/w)))/w))/w)/w                                       cora-700
      c(3)=c(3)+12.d0*q*x*(2.d0*(((28.d0*a+148.d0)*a+221.d0)*a+106.d0)+(cora-701
     16.d0*a-4.d0)*q+(2.d0*a+3.d0)*((2.d0*a+12.d0)*f*x+(a+2.d0)*((a+1.d0cora-702
     2)*(2.d0*x**2-(13.d0*a+8.d0)*u)+5.d0*((10.d0*a+28.d0)*f+2.d0*(a+1.dcora-703
     30)*(a+2.d0)*(x+(6.d0*a+15.d0)/w))/w)))/w                          cora-704
      c(4)=c(4)+3.d0*x*((24.d0*(2.d0*a-1.d0)*(a-2.d0)*f*q-(4.d0*a+4.d0)*cora-705
     1(((20.d0*a+46.d0)*a+108.d0)*q*x+(2.d0*a+1.d0)*(((76.d0*a+426.d0)*acora-706
     2+636.d0)*f+a*((26.d0*a+107.d0)*a+46.d0)*x)))/(2.d0*a+3.d0)+(4.d0*acora-707
     3+4.d0)*((2.d0*a+1.d0)*((35.d0*a+130.d0)*a+48.d0)*f*u+(2.d0*a+1.d0)cora-708
     4*(a*(a+2.d0)*(9.d0*(a+1.d0)*u-x**2)*x-(2.d0*a+12.d0)*f*x**2)-(4.d0cora-709
     5*((38.d0*a+169.d0)*a+210.d0)*q-(2.d0*a+1.d0)*(a*((44.d0*a+250.d0)*cora-710
     6a+388.d0)-(2.d0*a+3.d0)*((12.d0*a+40.d0)*f*x-(a+2.d0)*(a*((13.d0*acora-711
     7+8.d0)*u-2.d0*x**2)-10.d0*((11.d0*a+30.d0)*f+a*(a+2.d0)*(x+(6.d0*acora-712
     8+15.d0)/w))/w))))/w))/w                                           cora-713
      go to 43                                                          cora-714
c multipole lq=5 l1=l2-5                                                cora-715
   37 bd=181440.d0*den*s**2*dsqrt(q*((a+1.d0)**2+f**2)*((a+2.d0)**2+f**2cora-716
     1)*((a-1.d0)**2+e**2)*((a+3.d0)**2+f**2))*a**2                     cora-717
      b1=q*(2304.d0*a*(2.d0*a-1.d0)-6912.d0*q+864.d0*(9.d0*a+1.d0)*q*u-2cora-718
     188.d0*a*((22.d0*a+3.d0)*a+5.d0)*u+8.d0*a*(((530.d0*a+611.d0)*a+12.cora-719
     2d0)*a+72.d0)*u**2-8.d0*((602.d0*a+683.d0)*a-60.d0)*q*u**2+96.d0*a*cora-720
     3(a**2-1.d0)*(2.d0*a+5.d0)*(2.d0*a+3.d0)*u**3)                     cora-721
      b2=24.d0*q*f*(288.d0-(204.d0*a+36.d0)*u+((89.d0*a+141.d0)*a-20.d0)cora-722
     1*u**2)                                                            cora-723
      b3=12.d0*f*(q*(576.d0-24.d0*(37.d0*a+3.d0)*u+((718.d0*a+582.d0)*a-cora-724
     140.d0)*u**2)+a*(a+1.d0)*(2.d0*a+1.d0)*u*(96.d0-(148.d0*a+12.d0)*u-cora-725
     2((137.d0*a+148.d0)*a-180.d0)*u**2))                               cora-726
      b4=q*(864.d0*(9.d0*a+1.d0)*u-6912.d0-8.d0*(602.d0*a**2+613.d0*a-60cora-727
     1.d0)*u**2)+a*(2.d0*a+1.d0)*(2304.d0-288.d0*(11.d0*a-1.d0)*u+8.d0*(cora-728
     2(265.d0*a+174.d0)*a-54.d0)*u**2+48.d0*(2.d0*a+3.d0)*(2.d0*a+5.d0)*cora-729
     3(a-1.d0)*u**3)                                                    cora-730
      if (x.eq.0.d0) go to 38                                           cora-731
      b1=b1+x*q*((1176.d0*f*u+((2040.d0*a+2616.d0)*u-1200.d0-48.d0*x**2)cora-732
     1*x)*q+(((2944.d0*a+4432.d0)*a+912.d0)*x+8.d0*((794.d0*a+1535.d0)*acora-733
     2+222.d0)*f)*u-(16.d0*((94.d0*a+385.d0)*a+216.d0)+((368.d0*a+1016.dcora-734
     30)*a+600.d0)*x**2)*x+(2*a+3.d0)*((((608.d0*a+632.d0)*u-600.d0-24.dcora-735
     40*x**2)*x**2-3456.d0-((1950.d0*a+2614.d0)*a-140.d0)*u**2)*f+(a+1.dcora-736
     50)*((120.d0*a+152.d0)*u*x**3-((414.d0*a+798.d0)*a+20.d0)*u**2*x-8.cora-737
     6d0*x**5)))                                                        cora-738
      b2=b2+x*q*(1200.d0*f*x-1176.d0*q*u-24.d0*((33.d0*a+120.d0)*a+38.d0cora-739
     1)*u-24.d0*(53.d0*a+60.d0)*f*u*x+48.d0*f*x**3+(a+1.d0)*(3456.d0+((7cora-740
     238.d0*a+1722.d0)*a+60.d0)*u**2+24.d0*(25.d0-(13.d0*a+19.d0)*u+x**2cora-741
     3)*x**2))                                                          cora-742
      b3=b3+x*((1200.d0*f*x-24.d0*((597.d0*a+720.d0)*a+74.d0)*u-1176.d0*cora-743
     1q*u-(2808.d0*a+2616.d0)*f*u*x+48.d0*f*x**3)*q+(a+1.d0)*((10368.d0-cora-744
     224.d0*(113.d0*a+79.d0)*u*x**2+(72.d0*x**2+1800.d0)*x**2+((11782.d0cora-745
     3*a+10730.d0)*a-420.d0)*u**2)*q+(2*a+1.d0)*((((3090.d0*a+3898.d0)*acora-746
     4+60.d0)*u**2+3456.d0+600.d0*x**2-304.d0*(14.d0*a+3.d0)*u-(680.d0*acora-747
     5+456.d0)*u*x**2+24.d0*x**4)*f*x+a*(((8.d0*x**2+184.d0)*x**2+752.d0cora-748
     6)*x**2-2304.d0-((3.d0*(((187.d0*a+479.d0)*a-6.d0)*a-240.d0)*u+4.d0cora-749
     7*((1175.d0*a+624.d0)*a-108.d0))*u-96.d0*(55.d0*a-3.d0))*u+(((570.dcora-750
     80*a+1278.d0)*a+356.d0)*u-60.d0*a-440.d0-44.d0*(3.d0*a+4.d0)*x**2)*cora-751
     9u*x**2))))                                                        cora-752
      b4=b4+x*((1176.d0*f*u-1200.d0*x+120.d0*(17.d0*a+12.d0)*u*x-48.d0*xcora-753
     1**3)*q+(2.d0*a+1.d0)*((8.d0*(397.d0*a+114.d0)*u-3456.d0-10.d0*((19cora-754
     25.d0*a+289.d0)*a+6.d0)*u**2-600.d0*x**2+8.d0*(76.d0*a+57.d0)*u*x**cora-755
     32-24.d0*x**4)*f+a*x*(440.d0*u-752.d0-((414.d0*a+1050.d0)*a+356.d0)cora-756
     4*u**2-184.d0*x**2+8.d0*(15.d0*a+22.d0)*u*x**2-8.d0*x**4)))        cora-757
   38 if (lt) go to 43                                                  cora-758
      c(1)=b1+24.d0*q*((60.d0*((9.d0*a+5.d0)*u-8.d0)*q+96.d0*(a-1.d0)*(2cora-759
     1.d0*a-1.d0)-4.d0*(((74.d0*a+15.d0)*a+28.d0)*a+3.d0)*u-(2.d0*a+3.d0cora-760
     2)*(a+2.d0)*((137.d0*a-37.d0)*a-30.d0)*u**2)*f+4.d0*(30.d0*((8.d0*acora-761
     3-6.d0)*a+5.d0-7.d0*q)*q+(a+2.d0)*(5.d0*((128.d0*a+80.d0)*a-33.d0)*cora-762
     4q-a*(((676.d0*a+544.d0)*a-201.d0)*a-144.d0))*u-(6.d0*a-6.d0)*((2.dcora-763
     50*a-1.d0)*(4.d0*a-6.d0)*a+(a+1.d0)*(2.d0*a+3.d0)*(2.d0*a+5.d0)*a*(cora-764
     6a+2.d0)*u**2)+5.d0*((12.d0*(2.d0*a-1.d0)*(((50.d0*a+153.d0)*a+136.cora-765
     7d0)*a+39.d0)-84.d0*((10.d0*a+19.d0)*a+3.d0)*q)*f+(a+2.d0)*((2.d0*acora-766
     8+3.d0)*(2.d0*a+5.d0)*((37.d0*a-17.d0)*a-6.d0)*u*f+6.d0*(a*(2.d0*a-cora-767
     91.d0)*(((236.d0*a+648.d0)*a+625.d0)*a+66.d0)-3.d0*(((140.d0*a+294.cora-768
     ad0)*a+196.d0)*a-105.d0)*q+(2.d0*a+3.d0)*(2.d0*a+5.d0)*(a*(a**2-1.dcora-769
     b0)*(2.d0*a+6.d0)*u-(14.d0*a-7.d0)*(((7.d0*a+5.d0)*a+6.d0)*f+a*(a**cora-770
     c2-1.d0)*(2.d0*a+6.d0)/w)/w))/w))/w)/w)/w                          cora-771
      c(2)=b3+8.d0*((1440.d0*q-288.d0*(4.d0*a**2+1.d0)+12.d0*(((168.d0*acora-772
     1+132.d0)*a+62.d0)*a+3.d0)*u-30.d0*(68.d0*a+30.d0)*q*u)*q+(a+1.d0)*cora-773
     2(8.d0*a+12.d0)*(((338.d0*a-83.d0)*a-45.d0)*q*u-(2.d0*a+1.d0)*a**2*cora-774
     3(12.d0+(169.d0*a-99.d0)*u+(a-1.d0)*(6.d0*a+15.d0)*u**2))*u+3.d0*((cora-775
     4(840.d0*q-120.d0*(4.d0*a**2+5.d0))*q-(2.d0*a+3.d0)*(40.d0*((65.d0*cora-776
     5a+30.d0)*a-11.d0)*q-5.d0*a*(2.d0*a+1.d0)*(a+1.d0)*(12.d0*(25.d0*a-cora-777
     613.d0)+(a+2.d0)*(37.d0*a-30.d0)*u))*u)*f+4.d0*((630.d0*((10.d0*a+1cora-778
     75.d0)*a+2.d0)*q-90.d0*((((200.d0*a+420.d0)*a+162.d0)*a-63.d0)*a-26cora-779
     8.d0))*q+(2.d0*a+3.d0)*((a+1.d0)*(1512.d0*(4.d0*a**2-1.d0)*a**2-(a+cora-780
     92.d0)*(30.d0*((44.d0*a-18.d0)*a-5.d0)*q-6.d0*a**2*(2.d0*a+1.d0)*(1cora-781
     a18.d0*a-83.d0+(a-1.d0)*(2.d0*a+5.d0)*u))*u)+5.d0*(42.d0*(((70.d0*acora-782
     b+129.d0)*a+53.d0)*a-30.d0)*q*f-(a+1.d0)*(a*(2.d0*a+1.d0)*(252.d0*(cora-783
     c2.d0*a-1.d0)*(4.d0*a+5.d0)+7.d0*(a+2.d0)*(2.d0*a+5.d0)*(7.d0*a-6.dcora-784
     d0)*u)*f-6.d0*(a+2.d0)*(14.d0*(((56.d0*a+36.d0)*a+4.d0)*a-15.d0)*q-cora-785
     ea**2*(2.d0*a+1.d0)*((4.d0*a+3.d0)*54.d0*(2.d0*a-1.d0)+(2.d0*a+5.d0cora-786
     f)*((a-1.d0)*(2.d0*a+6.d0)*u-7.d0*(2.d0*a-1.d0)*(9.d0*f+(a-1.d0)*(2cora-787
     g.d0*a+6.d0)/w)/w)))/w))/w))/w)/w)/w                               cora-788
      c(3)=b2+96.d0*q*((120.d0-25.d0*(4.d0*a+3.d0)*u)*q-24.d0*(4.d0*a**2cora-789
     1+1.d0)+((((88.d0*a+72.d0)*a+12.d0)*a+3.d0)+3.d0*(a**2-1.d0)*(2.d0*cora-790
     2a+3.d0)*(2.d0*a+5.d0)*u)*u+5.d0*((42.d0*q-(24.d0*a**2+30.d0))*f-(acora-791
     3+2.d0)*((2.d0*a+3.d0)*(25.d0*a-11.d0)*u*f-6.d0*(21.d0*(4.d0*a+1.d0cora-792
     4)*q-3.d0*(((32.d0*a+20.d0)*a-4.d0)*a-13.d0)-(2.d0*a+3.d0)*(2.d0*a+cora-793
     55.d0)*((a**2-1.d0)*u-7.d0*((5.d0*a-3.d0)*f+(a**2-1.d0)*(2.d0*a+6.dcora-794
     60)/w)/w))/w))/w)/w                                                cora-795
      c(4)=b4+24.d0*((60.d0*((9.d0*a+5.d0)*u-8.d0)*q+(a+1.d0)*(2.d0*a+1.cora-796
     1d0)*(96.d0-4.d0*(37.d0*a+3.d0)*u-((137.d0*a+148.d0)*a-180.d0)*u**2cora-797
     2))*f+4.d0*((30.d0*((8.d0*a+6.d0)*a+5.d0)-210.d0*q)*q+(2.d0*a+3.d0)cora-798
     3*((a+1.d0)*(10.d0*(32.d0*a-11.d0)*q*u-(2.d0*a+1.d0)*(a*(12.d0+(169cora-799
     4.d0*a-99.d0)*u)+3.d0*(a-1.d0)*(2.d0*a+5.d0)*a*u**2))-5.d0*(84.d0*(cora-800
     55.d0*a+1.d0)*q*f-(a+1.d0)*((2.d0*a+1.d0)*(12.d0*(25.d0*a-13.d0)+(acora-801
     6+2.d0)*(37.d0*a-30.d0)*u)*f-6.d0*(a+2.d0)*(105.d0*(2.d0*a-1.d0)*q-cora-802
     7(2.d0*a+1.d0)*((118.d0*a-83.d0)*a+(2.d0*a+5.d0)*(a*(a-1.d0)*u-7.d0cora-803
     8*((7.d0*a-6.d0)*f+a*(a-1.d0)*(2.d0*a+6.d0)/w)/w)))/w))/w))/w)/w   cora-804
      if (x.eq.0.d0) go to 43                                           cora-805
      c(1)=c(1)-q*x*(720.d0*(((6.d0*a+23.d0)*a+19.d0)+q)*f*x+(a+2.d0)*(7cora-806
     120.d0*q*x**2-384.d0*((22.d0*a-5.d0)*a+3.d0)+11520.d0*q+24.d0*(((43cora-807
     20.d0*a+255.d0)*a+29.d0)*a+6.d0)*u-72.d0*(173.d0*a+107.d0)*q*u+120.cora-808
     3d0*((2.d0*a+17.d0)*a+9.d0)*x**2+(2.d0*a+3.d0)*(144.d0*f*x**3-24.d0cora-809
     4*(95.d0*a+71.d0)*f*u*x+(a+1.d0)*(6.d0*((123.d0*a+137.d0)*a-120.d0)cora-810
     5*u**2-24.d0*(13.d0*a+14.d0)*u*x**2+24.d0*x**4)))-24.d0*((2.d0*a+5.cora-811
     6d0)*((20.d0*((10.d0*a-7.d0)*a+9.d0)-420.d0*q)*f+(a+2.d0)*((10.d0*(cora-812
     7(14.d0*a-1.d0)*a+3.d0)-180.d0*q)*x+(2.d0*a+3.d0)*((199.d0*a-31.d0)cora-813
     8*f*u-20.d0*f*x**2+(a+1.d0)*((21.d0*a+13.d0)*u-2.d0*x**2)*x)))+5.d0cora-814
     9*(a+2.d0)*(4*((((220.d0*a+1340.d0)*a+973.d0)*a+123.d0)*a-234.d0)-8cora-815
     a4.d0*((10.d0*a+55.d0)*a+21.d0)*q+(2.d0*a+3.d0)*(2.d0*a+5.d0)*((a+1cora-816
     b.d0)*(a+3.d0)*((15.d0*a-8.d0)*u-2.d0*x**2)-30.d0*(a+3.d0)*f*x-6.d0cora-817
     c*(21.d0*((2.d0*a+13.d0)*a-3.d0)*f+(a+1.d0)*(a+3.d0)*((2.d0*a+7.d0)cora-818
     d*x+(14.d0*a-7.d0)*(a+8.d0)/w))/w))/w)/w)/w                        cora-819
      c(2)=c(2)+x*(720.d0*((12.d0*a+32.d0)*a+19.d0+q)*q*x+(2.d0*a+3.d0)*cora-820
     1((7680.d0+480.d0*x**2-48.d0*(222.d0*a+107.d0)*u)*f*q+(a+1.d0)*((28cora-821
     28.d0*x**2-48.d0*(127.d0*a+71.d0)*u)*q*x+(2.d0*a+1.d0)*(((48.d0*x**cora-822
     32+720.d0)*x**2-768.d0+(32.d0*(62.d0*a+3.d0)+16.d0*((168.d0*a+139.dcora-823
     40)*a-90.d0)*u-(920.d0*a+672.d0)*x**2)*u)*f+a*x*((8.d0*x**2+40.d0-(cora-824
     5120.d0*a+152.d0)*u)*x**2+((414.d0*a+798.d0)*a+20.d0)*u**2-1408.d0+cora-825
     6(2280.d0*a+736.d0)*u))))+6.d0*((a+2.d0)*((4200.d0*q-200.d0*((20.d0cora-826
     7*a+8.d0)*a+9.d0))*q+(2.d0*a+3.d0)*(1200.d0*f*q*x+(a+1.d0)*((400.d0cora-827
     8*x**2-(4960.d0*a-620.d0)*u)*q+(2.d0*a+1.d0)*((40.d0*x**2-200.d0-(5cora-828
     948.d0*a+260.d0)*u)*f*x+a*((((123.d0*a+137.d0)*a-120.d0)*u+(2452.d0cora-829
     a*a-792.d0))*u+96.d0+4.d0*x**2*(x**2-35.d0-(13.d0*a+14.d0)*u))))))+cora-830
     b(8.d0*a+12.d0)*(420.d0*((10.d0*a+45.d0)*a+14.d0)*f*q-(a+1.d0)*(240cora-831
     c.d0*(2.d0*a+1.d0)*((10.d0*a+45.d0)*a-13.d0)*f-(a+2.d0)*(450.d0*(2.cora-832
     dd0*a+5.d0)*q*x+(2.d0*a+1.d0)*(2.d0*a+5.d0)*(30.d0*f*x**2-(274.d0*acora-833
     e-120.d0)*f*u+a*x*(2.d0*x**2-220.d0-(21.d0*a+13.d0)*u))+5.d0*(42.d0cora-834
     f*((42.d0*a+231.d0)*a-45.d0)*q-(2.d0*a+1.d0)*(8.d0*a*((118.d0*a+649cora-835
     g.d0)*a-249.d0)+(a+3.d0)*(2.d0*a+5.d0)*(a*(15.d0*a-8.d0)*u-42.d0*f*cora-836
     hx-2.d0*a*x**2))+(12.d0*a+6.d0)*(2.d0*a+5.d0)*(28.d0*((2.d0*a+13.d0cora-837
     i)*a-6.d0)*f+a*(a+3.d0)*((2.d0*a+7.d0)*x+(14.d0*a-7.d0)*(a+8.d0)/w)cora-838
     j)/w)/w)))/w)/w)/w                                                 cora-839
      c(3)=c(3)+24.d0*x*q*((30.d0*q+10.d0*((4.d0*a+16.d0)*a+9.d0))*x+(2.cora-840
     1d0*a+3.d0)*((160.d0-(124.d0*a+114.d0)*u+10.d0*x**2)*f+(a+1.d0)*(2.cora-841
     2d0*x**2-(21.d0*a+28.d0)*u)*x)+(5.d0*a+10.d0)*(126.d0*q-2.d0*((52.dcora-842
     30*a+4.d0)*a+15.d0)+(2.d0*a+3.d0)*(18.d0*f*x+(a+1.d0)*(2.d0*x**2-(1cora-843
     45.d0*a+13.d0)*u))+(12.d0*a+18.d0)*(2.d0*a+5.d0)*(14.d0*f+(a+1.d0)*cora-844
     5(x+(7.d0*a+21.d0)/w))/w)/w)/w                                     cora-845
      c(4)=c(4)-x*(720.d0*f*q*x+(a+1.d0)*((11520.d0+720.d0*x**2-72.d0*(1cora-846
     173.d0*a+114.d0)*u)*q-(2.d0*a+1.d0)*((24.d0*(95.d0*a+84.d0)*u-2160.cora-847
     2d0-144.d0*x**2)*f*x+a*(4224.d0-24.d0*(215.d0*a+92.d0)*u-6.d0*((123cora-848
     3.d0*a+287.d0)*a+10.d0)*u**2-120.d0*x**2+24.d0*(13.d0*a+19.d0)*u*x*cora-849
     4*2-24.d0*x**4)))+24.d0*(2.d0*a+3.d0)*(420.d0*f*q+(a+1.d0)*(180.d0*cora-850
     5q*x-7.d0*a*(2.d0*a+1.d0)*(3.d0*a+4.d0)*u*x-(2.d0*a+1.d0)*((100.d0+cora-851
     6(199.d0*a+130.d0)*u-20.d0*x**2)*f+a*x*(70.d0-2.d0*x**2))+5.d0*(a+2cora-852
     7.d0)*(420.d0*q+(2.d0*a+1.d0)*(30.d0*f*x+a*(2.d0*x**2-220.d0-(15.d0cora-853
     8*a+13.d0)*u)+6.d0*(2.d0*a+5.d0)*(21.d0*f+a*(x+(7.d0*a+21.d0)/w))/wcora-854
     9))/w))/w)/w                                                       cora-855
      go to 43                                                          cora-856
   39 if ((x.ne.0.d0).or.(mod(ll,2).ne.1).or.(ll.eq.7)) go to 69        cora-857
      go to ( 40 , 69 , 41 , 69 , 42 , 69 , 69 ) , ll                   cora-858
c multipole lq=6 l1=l2                                                  cora-859
   40 bd=120.d0*den*a**2*(2.d0*a+7.d0)*(2.d0*a+5.d0)*(a+2.d0)*(a+3.d0)*(cora-860
     1a+4.d0)*dsqrt(s*q*p*((a+1.d0)**2+f**2)*((a+1.d0)**2+e**2))*s**2   cora-861
      b1=p*q*((8.d0*(((154.d0*a-205.d0)*a-376.d0)*a-140.d0+((47.d0*a-282cora-862
     1.d0)*a-143.d0-63.d0*q)*q)+4.d0*((((47.d0*a+26.d0)*a-553.d0)*a-752.cora-863
     2d0)*a-280.d0-((79.d0*a+282.d0)*a+143.d0)*q)*u)/(a-1.d0)+2.d0*(2.d0cora-864
     3*a+7.d0)*(2.d0*a+5.d0)*(a+1.d0)**2*u**2)                          cora-865
      b2=(240.d0*(2.d0*a+1.d0)**2*(a-14.d0)+24.d0*((20.d0*a-336.d0)*a-14cora-866
     13.d0)*q-1512.d0*q**2-6.d0*((((36.d0*a+836.d0)*a+2797.d0)*a+2374.d0cora-867
     2)*a+560.d0+(((18.d0*a+275.d0)*a+726.d0)*a+286.d0)*q+(a+1.d0)*(((26cora-868
     3.d0*a+146.d0)*a+210.d0)*a+35.d0)*u)*u)/(2.d0*a+3.d0)              cora-869
      b3=p*f*(b2+a*(2.d0*a+4.d0)*u*(54.d0*q+6.d0*(38.d0*a+29.d0)+3.d0*(acora-870
     1+1.d0)*(9.d0*a+29.d0)*u))                                         cora-871
      b2=q*f*b2                                                         cora-872
      b4=(((((((32.d0*a-216.d0)*a-1692.d0)*a-2272.d0)*a+454.d0)*a+1402.dcora-873
     10)*a+210.d0)*q*u**2+(2.d0*a-3.d0)*((16.d0*a+8.d0)*((107.d0*a-444.dcora-874
     20)*a-140.d0)+8.d0*((((47.d0*a-176.d0)*a-924.d0)*a-724.d0)*a-140.d0cora-875
     3)*u+(8.d0*((47.d0*a-390.d0)*a-143.d0)-4.d0*((142.d0*a+390.d0)*a+14cora-876
     43.d0)*u-504.d0*q)*q)*q+a**2*(2.d0*a+1.d0)*(480.d0*(2.d0*a+1.d0)*(acora-877
     5-14.d0)+(4.d0*(((214.d0*a-849.d0)*a-3808.d0)*a-2100.d0)+((((204.d0cora-878
     6*a+752.d0)*a-232.d0)*a-2550.d0)*a-1680.d0)*u)*u))/((a+1.d0)*(2.d0*cora-879
     7a+3.d0))+a**2*(2.d0*a+5.d0)*(2.d0*a+7.d0)*(2.d0*a+1.d0)*(a+1.d0)*ucora-880
     8**3                                                               cora-881
      if (lt) go to 43                                                  cora-882
      c(1)=b1+12.d0*p*q*(a+2.d0)*((58.d0+76.d0*a+18.d0*q+(a+1.d0)*(9.d0*cora-883
     1a+29.d0)*u)*f-(2.d0*a+5.d0)*((28.d0*a+32.d0)*a+14.d0+(4.d0*a-6.d0)cora-884
     2*q+(a+1.d0)*((a+1.d0)*(2.d0*a+7.d0)*u+10.d0*(a+3.d0)*(2.d0*f-(a+1.cora-885
     3d0)*(2.d0*a+7.d0)/w)/w))/w)/w                                     cora-886
      c(2)=b3-2.d0*p*(2.d0*a*((((48.d0*a+16.d0)*a-570.d0)*a-703.d0)*a-21cora-887
     10.d0)*u+(2.d0*a-3.d0)*((((4.d0*a-34.d0)*a-172.d0)*a-116.d0)*u+8.d0cora-888
     2*((5.d0*a-48.d0)*a-29.d0)-72.d0*q)*q-a*(2.d0*a+1.d0)*(40.d0*(2.d0*cora-889
     3a+1.d0)*(14.d0-a)-(2.d0*a+7.d0)*(2.d0*a+5.d0)*(a+1.d0)**2*u**2)-6.cora-890
     4d0*(a+2.d0)*(5.d0*((14.d0-a)*(2.d0*a+1.d0)**2-(a-2.d0)*(2.d0*a-3.dcora-891
     50)*q-(a+1.d0)*(2.d0*a+1.d0)*((a+1.d0)*a-7.d0)*u)*f+(2.d0*a+5.d0)*(cora-892
     6(((4.d0*a+6.d0)*a+92.d0)*a+60.d0)*q+(2.d0*a+1.d0)*((a-14.d0)*a*(4.cora-893
     7d0*a+2.d0)+(a+1.d0)*(a*(a+1.d0)*(2.d0*a+7.d0)*u-10.d0*(a+3.d0)*(7.cora-894
     8d0*f+(2.d0*a+7.d0)*a*(a+1.d0)/w)/w)))/w)/w)/w                     cora-895
      c(3)=b2+2.d0*q*(a*((((16.d0*a+600.d0)*a+2332.d0)*a+2298.d0)*a+700.cora-896
     1d0)*u+(2.d0*a-3.d0)*((((4.d0*a+70.d0)*a+212.d0)*a+116.d0)*u-8.d0*(cora-897
     2(5.d0*a-48.d0)*a-29.d0)+72.d0*q)*q+40.d0*(2.d0*a+1.d0)**2*a*(14.d0cora-898
     3-a)+3.d0*a*(2.d0*a+5.d0)*(2.d0*a+7.d0)*(a+1.d0)**2*u**2+6.d0*(a+2.cora-899
     4d0)*(5.d0*((14.d0-a)*(2.d0*a+1.d0)**2-(a-2.d0)*(2.d0*a-3.d0)*q+(a+cora-900
     51.d0)*((8.d0*a+28.d0)*a+7.d0)*u)*f+(2.d0*a+5.d0)*((((4.d0*a+6.d0)*cora-901
     6a+92.d0)*a+60.d0)*q+2.d0*(a-14.d0)*a*(2.d0*a+1.d0)**2-5.d0*a*(a+1.cora-902
     7d0)**2*(2.d0*a+7.d0)*u-10.d0*(a+3.d0)*(a+1.d0)*(2.d0*a+1.d0)*(7.d0cora-903
     8*f+(2.d0*a+7.d0)*a*(a+1.d0)/w)/w)/w)/w)/w                         cora-904
      c(4)=b4+6.d0*(2.d0*f*((2.d0*a-3.d0)*(a-2.d0)*(((18.d0*a+58.d0)*a+2cora-905
     19.d0)*u+58.d0*(2.d0*a+1.d0)+18.d0*q)*q+a*(2.d0*a+1.d0)*(40.d0*(2.dcora-906
     20*a+1.d0)*(a-14.d0)+(((58.d0*a-123.d0)*a-906.d0)*a-560.d0)*u+(a+1.cora-907
     3d0)*(((9.d0*a+43.d0)*a+34.d0)*a-35.d0)*u**2))/(2.d0*a+3.d0)-((((((cora-908
     416.d0*a**2+60.d0)*a+820.d0)*a+794.d0)*a+140.d0)*u+4.d0*(2.d0*a-3.dcora-909
     50)*(2.d0*a-5.d0)*(a-2.d0)*q)*q-(2.d0*a+1.d0)*(a**2*(40.d0*(14.d0-acora-910
     6)*(2.d0*a+1.d0)-(a+1.d0)**2*(2.d0*a+5.d0)*(2.d0*a+7.d0)*u**2)-4.d0cora-911
     7*(((24.d0*a-44.d0)*a+257.d0)*a+70.d0)*q-(((48.d0*a-8.d0)*a-566.d0)cora-912
     8*a-420.d0)*a**2*u+10.d0*(a+2.d0)*(4.d0*((14.d0-a)*(2.d0*a+1.d0)*a-cora-913
     9((2.d0*a+2.d0)*a+15.d0)*q-a*(a+1.d0)*((a+1.d0)*a-7.d0)*u)*f+(2.d0*cora-914
     aa+5.d0)*(2.d0*(a-14.d0)*(2.d0*a+1.d0)*a**2+2.d0*(((2.d0*a+9.d0)*a+cora-915
     b43.d0)*a+21.d0)*q+a*(a+1.d0)*(a*(a+1.d0)*(2.d0*a+7.d0)*u+(4.d0*a+2cora-916
     c.d0)*(a+3.d0)*((a+7.d0)*2.d0*f+(2.d0*a+7.d0)*a*(a+1.d0)/w)/w))/w)/cora-917
     dw))/w)/w                                                          cora-918
      go to 43                                                          cora-919
c multipole lq=6 l1=l2-2                                                cora-920
   41 bd=2520.d0*den*a**2*(2.d0*a+5.d0)*(2.d0*a+7.d0)*(a+2.d0)*(a+3.d0)*cora-921
     1(a+4.d0)*s*dsqrt(s*q*p*((a+1.d0)**2+f**2)*((a+2.d0)**2+f**2))     cora-922
      b1=2*p*q*(120.d0*((((2.d0*a+57.d0)*a-117.d0)*a-306.d0)*a-140.d0+((cora-923
     111.d0*a-129.d0)*a-113.d0-21.d0*q)*q)/(a-1.d0)-((((74.d0*a-865.d0)*cora-924
     2a-5208.d0)*a-7344.d0)*a-3360.d0)*u+((266.d0*a+863.d0)*a+312.d0)*q*cora-925
     3u-3.d0*(a+1.d0)*(a+2.d0)*(2.d0*a+3.d0)*(2.d0*a+5.d0)*(2.d0*a+7.d0)cora-926
     4*u**2)                                                            cora-927
      b2=6.d0*q*f*((120.d0*((2.d0*a-147.d0)*a-113.d0-21.d0*q)*q+60.d0*((cora-928
     1((4.d0*a-56.d0)*a-261.d0)*a-259.d0)*a-56.d0)*u+(((86.d0*a-573.d0)*cora-929
     2a-2171.d0)*a-312.d0)*q*u-16800.d0*(a+1.d0)*(2.d0*a+1.d0))/(2.d0*a+cora-930
     33.d0)+(a+2.d0)*(((43.d0*a+193.d0)*a+210.d0)*a+105.d0)*u**2)       cora-931
      b3=3*p*((240.d0*((2.d0*a-147.d0)*a-113.d0-21.d0*q)*q+40.d0*(a+1.d0cora-932
     1)*(2.d0*a+1.d0)*(((2.d0*a+63.d0)*a+69.d0)*a-168.d0)*u+(((892.d0*a+cora-933
     21374.d0)*a-2182.d0)*a-624.d0)*q*u-33600.d0*(a+1.d0)*(2.d0*a+1.d0))cora-934
     3/(2.d0*a+3.d0)-(a+1.d0)*(a+2.d0)*(2.d0*a+1.d0)*((19.d0*a-6.d0)*a-2cora-935
     410.d0)*u**2)*f                                                    cora-936
      b4=(((2.d0*a-3.d0)*(240.d0*((((2.d0*a+69.d0)*a-369.d0)*a-534.d0)*acora-937
     1-140.d0+((11.d0*a-165.d0)*a-113.d0-21.d0*q)*q)*q+((((532.d0*a-1326cora-938
     2.d0)*a-5422.d0)*a-624.d0)*q-((((148.d0*a-4110.d0)*a+4130.d0)*a+451cora-939
     320.d0)*a+40512.d0)*a-6720.d0)*q*u)/(a+1.d0)+240.d0*a**2*(2.d0*a+1.cora-940
     4d0)*((a+2.d0)*((2.d0*a+59.d0)*a-189.d0)*u-840.d0))/(2.d0*a+3.d0)-(cora-941
     52.d0*(((((24.d0*a-26.d0)*a+317.d0)*a+2298.d0)*a+2001.d0)*a+630.d0)cora-942
     6*q+a**2*(2.d0*a+1.d0)*(((74.d0*a-1068.d0)*a-4812.d0)*a-3360.d0+3*(cora-943
     7a+2.d0)*(2.d0*a+3.d0)*(2.d0*a+5.d0)*(2.d0*a+7.d0)*u))*u**2)       cora-944
      if (lt) go to 43                                                  cora-945
      c(1)=b1+6.d0*p*q*(a+2.d0)*((360.d0*q+40.d0*((2.d0*a+53.d0)*a+57.d0cora-946
     1)-(2.d0*a+3.d0)*((19.d0*a+37.d0)*a-72.d0)*u)*f-(4.d0*a+10.d0)*(20.cora-947
     2d0*(2.d0*a-3.d0)*q+10.d0*(((2.d0*a+45.d0)*a+75.d0)*a+42.d0)-(a+1.dcora-948
     30)*(a+2.d0)*(6.d0*a+9.d0)*(2.d0*a+7.d0)*u+(a+3.d0)*(20.d0*a+30.d0)cora-949
     4*((a+16.d0)*f+(a+2.d0)*(6.d0*a+21.d0)*(a+1.d0)/w)/w)/w)/w         cora-950
      c(2)=b3+2.d0*p*((2.d0*a-3.d0)*(240.d0*(3.d0*q-(a-21.d0)*a+19.d0)-(cora-951
     1a+1.d0)*((116.d0*a+166.d0)*a-432.d0)*u)*q+a*(a+1.d0)*(2.d0*a+1.d0)cora-952
     2*(16800.d0-(20.d0*(((2.d0*a+63.d0)*a+174.d0)*a+42.d0)-(a+2.d0)*(6.cora-953
     3d0*a+9.d0)*(2.d0*a+5.d0)*(2.d0*a+7.d0)*u)*u)-(3.d0*a+6.d0)*((20.d0cora-954
     4*(a-2.d0)*(2.d0*a-3.d0)*q-(a+1.d0)*(2.d0*a+1.d0)*(840.d0-(2.d0*a+3cora-955
     5.d0)*((a+30.d0)*a+84.d0)*u))*5.d0*f-(4.d0*a+10.d0)*(a+1.d0)*(30.d0cora-956
     6*((2.d0*a+7.d0)*a+48.d0)*q-(2.d0*a+1.d0)*(a*(840.d0+(3.d0*a+6.d0)*cora-957
     7(2.d0*a+3.d0)*(2.d0*a+7.d0)*u)-(a+3.d0)*(20.d0*a+30.d0)*((7.d0*a+4cora-958
     82.d0)*f+a*(a+2.d0)*(6.d0*a+21.d0)/w)/w))/w)/w)/w                  cora-959
      c(3)=b2+6.d0*q*((2.d0*a-3.d0)*(80.d0*(3.d0*q-(a-21.d0)*a+19.d0)-((cora-960
     1(12.d0*a-26.d0)*a-222.d0)*a-144.d0)*u)*q-40.d0*a*((((4.d0*a-6.d0)*cora-961
     2a-90.d0)*a-138.d0)*a-63.d0)*u+a*(a+1.d0)*(5600.d0*(2.d0*a+1.d0)-3.cora-962
     3d0*(a+2.d0)*(2.d0*a+3.d0)*(2.d0*a+5.d0)*(2.d0*a+7.d0)*u**2)+10.d0*cora-963
     4(a+2.d0)*((420.d0*(a+1.d0)*(2.d0*a+1.d0)-10.d0*(a-2.d0)*(2.d0*a-3.cora-964
     5d0)*q-(2.d0*a+3.d0)*(((10.d0*a+34.d0)*a+21.d0)*a+42.d0)*u)*f+(6.d0cora-965
     6*a+15.d0)*((a+1.d0)*(((4.d0*a+14.d0)*a+96.d0)*q+a*((a+2.d0)*(2.d0*cora-966
     7a+3.d0)*(2.d0*a+7.d0)*u-56.d0*(2.d0*a+1.d0)))-14.d0*(a+3.d0)*(2.d0cora-967
     7*a+3.d0)*((3.d0*a-2.d0)*f+a*(a+2.d0)*(2.d0*a+7.d0)*(a+1.d0)/w)/w)/cora-968
     8w)/w)/w                                                           cora-969
      c(4)=b4+6.d0*(((a-2.d0)*(2.d0*a-3.d0)*(40.d0*(9.d0*q+(2.d0*a+73.d0cora-970
     1)*a+57.d0)-(((38.d0*a-49.d0)*a-433.d0)*a-216.d0)*u)*q+a*(a+1.d0)*(cora-971
     22.d0*a+1.d0)*(40.d0*(((2.d0*a+63.d0)*a+69.d0)*a-168.d0)*u-33600.d0cora-972
     3-(a+2.d0)*(2.d0*a+3.d0)*((19.d0*a-6.d0)*a-210.d0)*u**2))*f/(2.d0*acora-973
     4+3.d0)-(20.d0*(((((4.d0*a+132.d0)*a+35.d0)*a+1509.d0)*a+1812.d0)*acora-974
     5+420.d0+(a-2.d0)*(4.d0*a-6.d0)*(2.d0*a-5.d0)*q)*q-(a+1.d0)*(4.d0*(cora-975
     6((((12.d0*a+80.d0)*a+625.d0)*a+1710.d0)*a+1158.d0)*a+630.d0)*q*u+acora-976
     7**2*(2.d0*a+1.d0)*(16800.d0-(20.d0*(((2.d0*a+63.d0)*a+174.d0)*a+42cora-977
     8.d0)-(3.d0*a+6.d0)*(2.d0*a+3.d0)*(2.d0*a+5.d0)*(2.d0*a+7.d0)*u)*u)cora-978
     9)+(10.d0*a+20.d0)*((((((4.d0*a+132.d0)*a+371.d0)*a+1173.d0)*a+720.cora-979
     ad0)*q-a*(a+1.d0)*(2.d0*a+1.d0)*(840.d0-(2.d0*a+3.d0)*((a+30.d0)*a+cora-980
     b84.d0)*u))*2.d0*f+(6.d0*a+15.d0)*(a+1.d0)*(((((8.d0*a+60.d0)*a+220cora-981
     c.d0)*a-30.d0)*a+252.d0)*q+a*(2.d0*a+1.d0)*(280.d0*a+(2.d0*a+3.d0)*cora-982
     d(a*(a+2.d0)*(2.d0*a+7.d0)*u-14.d0*(a+3.d0)*((2.d0*a+12.d0)*f+a*(a+cora-983
     e2.d0)*(2.d0*a+7.d0)/w)/w)))/w)/w)/w)/w                            cora-984
      go to 43                                                          cora-985
c multipole lq=6 l1=l2-4                                                cora-986
   42 bd=181440.d0*den*a**2*(a+2.d0)*(a+3.d0)*(a+4.d0)*(2.d0*a+5.d0)*(2.cora-987
     1d0*a+7.d0)*s*dsqrt(s*q*((a+1.d0)**2+f**2)*((a+2.d0)**2+f**2)*((a+3cora-988
     2.d0)**2+f**2))                                                    cora-989
      b1=-q*((4320.d0*((7.d0*q+(a+78.d0)*a+103.d0)*q+((10.d0*a+255.d0)*acora-990
     1+638.d0)*a+420.d0)*q+2880.d0*a*(a+2.d0)*(a+3.d0)*(a+4.d0)*(2.d0*a+cora-991
     25.d0)*(2.d0*a+7.d0))/(a-1.d0)-72.d0*((5.d0*((14.d0*a-13.d0)*a+30.dcora-992
     30)*q+(((38.d0*a+833.d0)*a+243.d0)*a+678.d0)*a+2520.d0)*q+a*(((((14cora-993
     48.d0*a+2304.d0)*a+13879.d0)*a+31194.d0)*a+31336.d0)*a+13440.d0))*ucora-994
     5+(a+2.d0)*(4.d0*a+10.d0)*(a*((((814.d0*a+8467.d0)*a+23265.d0)*a+30cora-995
     6834.d0)*a+16632.d0)+(((338.d0*a+1757.d0)*a+8199.d0)*a+8190.d0)*q-2cora-996
     74.d0*a*(a+1.d0)*(a+3.d0)*(2.d0*a+3.d0)*(2.d0*a+5.d0)*(2.d0*a+7.d0)cora-997
     8*u)*u**2)                                                         cora-998
      b2=-6.d0*q*f*(2160.d0*((4.d0*a+84.d0)*a+103.d0+7.d0*q)*q/(2.d0*a+3cora-999
     1.d0)+1440.d0*(((2.d0*a+33.d0)*a+226.d0)*a+210.d0)-(a+2.d0)*(12.d0*cora1000
     2(((62.d0*a+623.d0)*a+126.d0)*a-1260.d0)+180.d0*(4.d0*a-5.d0)*q+(a+cora1001
     33.d0)*(2.d0*a+5.d0)*((41.d0*a+591.d0)*a+910.d0)*u)*u)             cora1002
      b3=-3.d0*f*(((30240.d0*q+4320.d0*((4.d0*a+84.d0)*a+103.d0)-360.d0*cora1003
     1(4.d0*a**2+5.d0)*(5.d0*a-6.d0)*u)*q-24.d0*(((((284.d0*a+3480.d0)*acora1004
     2+25.d0)*a-690.d0)*a+396.d0)*a-7560.d0)*u)*q/(2.d0*a+3.d0)+2880.d0*cora1005
     3(((2.d0*a+33.d0)*a+226.d0)*a+210.d0)*q+(2.d0*a+4.d0)*((((98.d0*a-2cora1006
     4563.d0)*a-7346.d0)*a-19775.d0)*a-13650.d0)*q*u**2+a*(a+1.d0)*(2.d0cora1007
     5*a+1.d0)*(480.d0*(((2.d0*a+33.d0)*a+226.d0)*a+840.d0)+(a+2.d0)*((acora1008
     6+3.d0)*(2.d0*a+5.d0)*((233.d0*a+1798.d0)*a+2520.d0)*u-4.d0*(((262.cora1009
     7d0*a+3523.d0)*a+16926.d0)*a+17640.d0))*u)*u)                      cora1010
      b4=-(4320.d0*(2.d0*a-3.d0)*((7.d0*q+(a+90.d0)*a+103.d0)*q+7.d0*(((cora1011
     12.d0*a+57.d0)*a+118.d0)*a+60.d0))*q/((a+1.d0)*(2.d0*a+3.d0))-72.d0cora1012
     2*(2.d0*a-3.d0)*((35.d0*a-50.d0)*q+((19.d0*a+425.d0)*a-66.d0)*a-840cora1013
     3.d0)*q*u+(a+2.d0)*(4.d0*a+10.d0)*(((338.d0*a+1567.d0)*a+8439.d0)*acora1014
     4+8190.d0)*q*u**2+a*(4.d0*a+2.d0)*(1440.d0*(((2.d0*a+33.d0)*a+226.dcora1015
     50)*a+840.d0)-36.d0*((((74.d0*a+1109.d0)*a+6154.d0)*a+9304.d0)*a+33cora1016
     660.d0)*u+(a+2.d0)*(2.d0*a+5.d0)*(((407.d0*a+3765.d0)*a+6714.d0)*a+cora1017
     74536.d0-12.d0*(a+3.d0)*(2.d0*a+3.d0)*(2.d0*a+5.d0)*(2.d0*a+7.d0)*ucora1018
     8)*u**2))                                                          cora1019
      if (lt) go to 43                                                  cora1020
      c(1)=b1+6.d0*q*(a+2.d0)*((240.d0*(9.d0*q+(8.d0*a+98.d0)*a+141.d0)*cora1021
     1q+4.d0*(((((524.d0*a+7460.d0)*a+40945.d0)*a+88825.d0)*a+77406.d0)*cora1022
     2a+17640.d0)*u-60.d0*(((6.d0*a-7.d0)*a+23.d0)*a-30.d0)*q*u-(a+3.d0)cora1023
     3*(2.d0*a+5.d0)*(480.d0*(a+4.d0)*(2.d0*a+7.d0)+(a+2.d0)*(2.d0*a+3.dcora1024
     40)*((233.d0*a+1373.d0)*a+420.d0)*u**2))*f+4.d0*(2.d0*a+5.d0)*((a+2cora1025
     5.d0)*(5.d0*(((116.d0*a+1028.d0)*a+3015.d0)*a+1953.d0)*q-a*((((292.cora1026
     6d0*a+2908.d0)*a+9639.d0)*a+5517.d0)*a-756.d0))*u-60.d0*((((14.d0*acora1027
     7+153.d0)*a+467.d0)*a+483.d0)+(2.d0*a-3.d0)*q)*q+(a+3.d0)*(12.d0*(2cora1028
     8.d0*a+7.d0)*a*(5.d0*(a+4.d0)*(2.d0*a-3.d0)-(a+1.d0)*(a+2.d0)*(2.d0cora1029
     9*a+3.d0)*(2.d0*a+5.d0)*u**2)+5.d0*((12.d0*(a+4.d0)*(a-2.d0)*(2.d0*cora1030
     aa-3.d0)*(2.d0*a+7.d0)-12.d0*((22.d0*a+175.d0)*a+318.d0)*q)*f+(a+2.cora1031
     bd0)*((2.d0*a+3.d0)*(2.d0*a+5.d0)*((85.d0*a+409.d0)*a+84.d0)*u*f-6.cora1032
     cd0*(2.d0*a+7.d0)*(15.d0*((20.d0*a+92.d0)*a+51.d0)*q-(a+4.d0)*a*((3cora1033
     d32.d0*a+368.d0)*a+141.d0)-(2.d0*a+3.d0)*(2.d0*a+5.d0)*(4.d0*a*(a+1cora1034
     e.d0)*(a+3.d0)*u-7.d0*(a+4.d0)*((19.d0*a+3.d0)*f+8.d0*a*(a+1.d0)*(acora1035
     f+3.d0)/w)/w))/w))/w))/w)/w                                        cora1036
      xx=(3.d0*a+6.d0)*(5.d0*f*(120.d0*((((8.d0*a+116.d0)*a+682.d0)*a+14cora1037
     105.d0)*a+966.d0-(a-2.d0)*(2.d0*a-3.d0)*q)*q-(2.d0*a+3.d0)*(4.d0*((cora1038
     2((140.d0*a+1808.d0)*a+7627.d0)*a+13909.d0)*a+6510.d0)*q-a*(a+1.d0)cora1039
     3*(2.d0*a+1.d0)*(12.d0*(((2.d0*a+33.d0)*a+226.d0)*a+840.d0)+(a+2.d0cora1040
     4)*(a+3.d0)*(10.d0*a+25.d0)*(17.d0*a+84.d0)*u))*u)+(4.d0*a+10.d0)*(cora1041
     512.d0*(a+2.d0)*(30.d0*(((8.d0*a+62.d0)*a+159.d0)*q-((((4.d0*a+40.dcora1042
     60)*a+151.d0)*a+94.d0)*a+84.d0))*q-(a+1.d0)*(2.d0*a+3.d0)*(5.d0*(((cora1043
     768.d0*a+564.d0)*a+1285.d0)*a+210.d0)*q-a**2*(2.d0*a+1.d0)*(((166.dcora1044
     80*a+1399.d0)*a+3108.d0)+(a+3.d0)*(4.d0*a+10.d0)*(2.d0*a+7.d0)*u))*cora1045
     9u)+10.d0*(a+3.d0)*(42.d0*(2.d0*a+3.d0)*(((70.d0*a+561.d0)*a+1241.dcora1046
     a0)*a+510.d0)*q*f-(2.d0*a+3.d0)*(a+1.d0)*(7.d0*a*(a+2.d0)*(2.d0*a+1cora1047
     b.d0)*(2.d0*a+5.d0)*(19.d0*a+84.d0)*u*f+(2.d0*a+7.d0)*(1008.d0*a*(acora1048
     c+4.d0)*(2.d0*a+1.d0)*f-(6.d0*a+12.d0)*(4.d0*((194.d0*a+797.d0)*a+1cora1049
     d05.d0)*q-a*(2.d0*a+1.d0)*(432.d0*a*(a+4.d0)+(2.d0*a+5.d0)*(4.d0*a*cora1050
     e(a+3.d0)*u-7.d0*(a+4.d0)*(27.d0*f+8.d0*a*(a+3.d0)/w)/w)))/w)))/w)/cora1051
     fw)/w                                                              cora1052
      c(2)=b3+2.d0*(1440.d0*(((((8.d0*a+132.d0)*a+906.d0)*a+2133.d0)*a+2cora1053
     1116.d0)*a+840.d0+(2.d0*a-3.d0)*((a+36.d0)*a+47.d0+3.d0*q)*q)*q-24.cora1054
     2d0*((((((504.d0*a+7644.d0)*a+39370.d0)*a+119625.d0)*a+174926.d0)*acora1055
     3+106596.d0)*a+17640.d0+(10.d0*a-15.d0)*(((8.d0*a-6.d0)*a+13.d0)*a-cora1056
     430.d0)*q)*q*u+(a+1.d0)*(8.d0*a+12.d0)*((a+2.d0)*(2.d0*a+5.d0)*(((3cora1057
     562.d0*a+3013.d0)*a+8436.d0)*a+1890.d0)*q*u+a**2*(2.d0*a+1.d0)*(60.cora1058
     6d0*(((2.d0*a+33.d0)*a+226.d0)*a+840.d0)-(a+2.d0)*(2.d0*a+5.d0)*((7cora1059
     73.d0*a+822.d0)*a+3024.d0+(a+3.d0)*(12.d0*a+30.d0)*(2.d0*a+7.d0)*u)cora1060
     8*u))*u+xx)/w                                                      cora1061
      c(3)=b2+24.d0*q*(2.d0*(60.d0*(((((8.d0*a+132.d0)*a+906.d0)*a+2133.cora1062
     1d0)*a+2116.d0)*a+840.d0+(2.d0*a-3.d0)*(3.d0*q+(a+36.d0)*a+47.d0)*qcora1063
     2)-(a+2.d0)*(2.d0*a+5.d0)*((((112.d0*a+1218.d0)*a+3459.d0)*a+4242.dcora1064
     30)*a+1764.d0+5.d0*(2.d0*a-3.d0)**2*q-3.d0*(a+1.d0)*(a+3.d0)*(2.d0*cora1065
     4a+3.d0)*(2.d0*a+5.d0)*(2.d0*a+7.d0)*u)*u)+5.d0*(a+2.d0)*(30.d0*(((cora1066
     5((8.d0*a+116.d0)*a+682.d0)*a+1405.d0)*a+966.d0)-(a-2.d0)*(2.d0*a-3cora1067
     6.d0)*q)*f-(a+2.d0)*(2.d0*a+5.d0)*((a+3.d0)*(2.d0*a+3.d0)*(37.d0*a+cora1068
     7217.d0)*u*f+6.d0*(6.d0*((((4.d0*a+40.d0)*a+151.d0)*a+94.d0)*a+84.dcora1069
     80)-2.d0*((24.d0*a+186.d0)*a+477.d0)*q+(2.d0*a+3.d0)*(2.d0*a+5.d0)*cora1070
     9(2.d0*(a+1.d0)*(a+3.d0)*(2.d0*a+7.d0)*u-7.d0*(a+3.d0)*((11.d0*a+51cora1071
     a.d0)*f+4.d0*(2.d0*a+7.d0)*(a+1.d0)*(a+3.d0)/w)/w))/w))/w)/w       cora1072
      c(4)=b4+6.d0*((240.d0*(a-2.d0)*(2.d0*a-3.d0)*(9.d0*q+(8.d0*a+118.dcora1073
     10)*a+141.d0)*q/(2.d0*a+3.d0)-60.d0*(a**2-4.d0)*(2.d0*a-3.d0)*(3.d0cora1074
     2*a-5.d0)*q*u-(a+1.d0)*(2.d0*a+1.d0)*(480.d0*(((2.d0*a+33.d0)*a+226cora1075
     3.d0)*a+840.d0)+(a+2.d0)*((a+3.d0)*(2.d0*a+5.d0)*((233.d0*a+1798.d0cora1076
     4)*a+2520.d0)*u**2-4.d0*(((262.d0*a+3523.d0)*a+16926.d0)*a+17640.d0cora1077
     5)*u)))*f-4.d0*(60.d0*(7.d0*(((((4.d0*a+60.d0)*a+291.d0)*a+969.d0)*cora1078
     6a+1409.d0)*a+690.d0)+(a-2.d0)*(2.d0*a-3.d0)*(2.d0*a-5.d0)*q)*q-(a+cora1079
     71.d0)*(2.d0*a+3.d0)*(60.d0*a*(2.d0*a+1.d0)*(((2.d0*a+33.d0)*a+226.cora1080
     8d0)*a+840.d0)+(a+2.d0)*(2.d0*a+5.d0)*(5.d0*((58.d0*a+473.d0)*a+130cora1081
     92.d0)*q-a*(2.d0*a+1.d0)*((73.d0*a+822.d0)*a+3024.d0+6.d0*(a+3.d0)*cora1082
     a(2.d0*a+5.d0)*(2.d0*a+7.d0)*u))*u)+5.d0*(a+2.d0)*(2.d0*a+3.d0)*(12cora1083
     b.d0*(((22.d0*a+273.d0)*a+1001.d0)*a+1590.d0)*q*f-(a+1.d0)*(12.d0*(cora1084
     c2.d0*a+1.d0)*(((2.d0*a+33.d0)*a+226.d0)*a+840.d0)*f+(a+2.d0)*(2.d0cora1085
     d*a+5.d0)*(5.d0*(a+3.d0)*(2.d0*a+1.d0)*(17.d0*a+84.d0)*u*f-6.d0*(15cora1086
     e.d0*((20.d0*a+164.d0)*a+357.d0)*q-(2.d0*a+1.d0)*(a*((166.d0*a+1399cora1087
     f.d0)*a+3108.d0)+(a+3.d0)*(2.d0*a+5.d0)*(a*(4.d0*a+14.d0)*u-7.d0*((cora1088
     g19.d0*a+84.d0)*f+4.d0*a*(2.d0*a+7.d0)*(a+3.d0)/w)/w)))/w)))/w)/w)/cora1089
     hw                                                                 cora1090
   43 a1=-2.d0*a**2*y*b1*z                                              cora1091
      a2=y*((2.d0*a+1.d0)*((2.d0*(a**2-a)**2*(1.d0+s**2)+y**2*(a**2-a-.5cora1092
     1d0))*b1-y*(p*b2+q*b3))+(4.d0*a-2.d0)*(a+1.d0)**2*p*q*b4)*z        cora1093
      a3=-y*((2.d0*a-1.d0)*((2.d0*(a**2+a)**2*(1.d0+s**2)+y**2*(a**2+a-.cora1094
     15d0))*b4-y*(b2+b3))+(4.d0*a+2.d0)*(a-1.d0)**2*b1)*z               cora1095
      a4=2.d0*a**2*y*b4*z                                               cora1096
      if (x.eq.0.d0) go to 46                                           cora1097
      a1=a1+x*2.d0*p*((a*x-2.d0*f)*b2-2.d0*q*(a+1.d0)*b4)               cora1098
      a2=a2+x*p*((2.d0*q*((2.d0*a+3.d0)*(a+1.d0)*f+((2.d0*a+3.d0)*a-4.d0cora1099
     1)*e*s)-2.d0*p*(2.d0*a-3.d0)*(2.d0*a+1.d0)*f+(2.d0*a+1.d0)*((((2.d0cora1100
     2*a-1.d0)*a-8.d0)*a+5.d0)*f-s*((a+1.d0)*((6.d0*a-9.d0)*a+1.d0)*e-s*cora1101
     3((6.d0*a-7.d0)*(a**2-1.d0)*f-s*((((2.d0*a-5.d0)*a+2.d0)*a-1.d0)*e)cora1102
     4))))*b2+2.d0*q*(a+1.d0)*((2.d0*a+3.d0)*(q+p)+(2.d0*a-1.d0)*(4.d0*ecora1103
     5*f*s+(1.d0+s**2)*((2.d0*a-4.d0)*a-3.d0)))*b4)                     cora1104
      a3=a3+x*((2.d0*p*((2.d0*a-3.d0)*(a-1.d0)*e*s+f*((2.d0*a-3.d0)*a-4.cora1105
     1d0))-2.d0*q*e*s*(2.d0*a+3.d0)*(2.d0*a-1.d0)-(2.d0*a-1.d0)*((((2.d0cora1106
     2*a+5.d0)*a+2.d0)*a+1.d0)*f-s*((6.d0*a+7.d0)*(a**2-1.d0)*e-s*((a-1.cora1107
     3d0)*((6.d0*a+9.d0)*a+1.d0)*f-s*((((2.d0*a+1.d0)*a-8.d0)*a-5.d0)*e)cora1108
     4))))*b2+(-4.d0*p*q*((2.d0*a+1.d0)*a+2.d0)-(2.d0*a-1.d0)*(2.d0*s*e*cora1109
     5f*(2.d0*a+3.d0)*(q+p+s**2+1.d0)-a**2*(((a+3.d0)*a+2.5d0)*(1.d0+s**cora1110
     64)-s**2*((2.d0*a-2.d0)*a-7.d0))+a*(a-1.d0)*(2.d0*a+3.d0)*(1.d0+s**cora1111
     72)*(p+q)-(s**2-1.d0)*((2.d0*a+4.d0)*a+.5d0)*(q-p)))*b4)           cora1112
      a4=a4+x*2.d0*(((a-1.d0)*(p+q)+y**2)*b4+(2.d0*e*s-a*x)*b2)         cora1113
   44 a4=a4+x*2.d0*((2.d0*f+a*x)*b3-2.d0*(a-1.d0)*b1)                   cora1114
   45 a1=a1+x*2.d0*(((a+1.d0)*(q+p)-y**2)*b1-q*(a*x+2.d0*e*s)*b3)       cora1115
      a2=a2+x*((-4.d0*p*q*(2.d0*a**2-a+2.d0)-(2.d0*a+1.d0)*(2.d0*s*e*f*(cora1116
     12.d0*a-3.d0)*(q+p+s**2+1.d0)+a**2*(((a-3.d0)*a+2.5d0)*(1.d0+s**4)-cora1117
     2s**2*((2.d0*a+2.d0)*a-7.d0))+a*(a+1.d0)*(2.d0*a-3.d0)*(1.d0+s**2)*cora1118
     3(p+q)+(s**2-1.d0)*((2.d0*a-4.d0)*a+.5d0)*(q-p)))*b1+q*(2.d0*p*((2.cora1119
     4d0*a+3.d0)*(a+1.d0)*e*s+f*((2.d0*a+3.d0)*a-4.d0))-2.d0*q*e*s*(2.d0cora1120
     5*a-3.d0)*(2.d0*a+1.d0)-(2.d0*a+1.d0)*((((2.d0*a-5.d0)*a+2.d0)*a-1.cora1121
     6d0)*f-s*((6.d0*a-7.d0)*(a**2-1.d0)*e-s*((a+1.d0)*((6.d0*a-9.d0)*a+cora1122
     71.d0)*f-s*((((2.d0*a-1.d0)*a-8.d0)*a+5.d0)*e)))))*b3)             cora1123
      a3=a3+x*(2.d0*(a-1.d0)*((2.d0*a-3.d0)*(q+p)+(2.d0*a+1.d0)*(4.d0*e*cora1124
     1f*s+(1.d0+s**2)*((2.d0*a+4.d0)*a-3.d0)))*b1+(2.d0*q*((2.d0*a-3.d0)cora1125
     2*(a-1.d0)*f+((2.d0*a-3.d0)*a-4.d0)*e*s)-2.d0*p*(2.d0*a+3.d0)*(2.d0cora1126
     3*a-1.d0)*f+(2.d0*a-1.d0)*((((2.d0*a+1.d0)*a-8.d0)*a-5.d0)*f-s*((a-cora1127
     41.d0)*((6.d0*a+9.d0)*a+1.d0)*e-s*((6.d0*a+7.d0)*(a**2-1.d0)*f-s*((cora1128
     5((2.d0*a+5.d0)*a+2.d0)*a+1.d0)*e)))))*b3)                         cora1129
   46 b(1)=a1*dsqrt(((a-1.d0)**2+e**2)*((a-1.d0)**2+f**2))*(2.d0*a-3.d0)cora1130
     1/(bd*a*(2.d0*a-1.d0))                                             cora1131
      b(2)=a2/(a*s*bd*(2.d0*a+1.d0))                                    cora1132
      b(3)=a3/(a*s*bd*(2.d0*a-1.d0))*dsqrt(p*q)                         cora1133
      b(4)=a4*dsqrt(p*q*((a+1.d0)**2+e**2)*((a+1.d0)**2+f**2))*(2.d0*a+3cora1134
     1.d0)/(bd*a*(2.d0*a+1.d0))                                         cora1135
      if (lt) return                                                    cora1136
      z=-2.d0*bd*v*w*dsqrt(s)/den                                       cora1137
      bd=a**2*bd*dsqrt(v*w)**3                                          cora1138
      a1=a1*(a-1.d0)**2                                                 cora1139
      a4=a4*(a+1.d0)**2                                                 cora1140
      c(1)=c(1)/z-(a+y*w*(.5d0*a-1.d0)/(a-1.d0)**2)*(2.d0*a-1.d0)*a1/bd cora1141
      c(2)=(c(2)/z+w*(a1-p*a4)/bd)*dsqrt(q)                             cora1142
      c(3)=(c(3)/z+w*(a1-q*a4)/bd)*dsqrt(p)                             cora1143
      c(4)=(c(4)/z+(a+y*w*(.5d0*a+1.d0)/(a+1.d0)**2)*(2.d0*a+1.d0)*a4/bdcora1144
     1)*dsqrt(p*q)                                                      cora1145
      return                                                            cora1146
c for neutrons ( coulomb parameter 0.)                                  cora1147
   47 x=w**2                                                            cora1148
      go to ( 48 , 49 , 52 , 55 , 59 , 63 ) , lq                        cora1149
   48 if ((ll.eq.1).or.(u.eq.0)) go to 70                               cora1150
c multipole lq=1 l1=l2-1 (useless)                                      cora1151
      b(2)=(u+2.d0-2.d0*a)/(dsqrt(s)*u)                                 cora1152
      b(3)=dsqrt(s)*(2.d0*a+2.d0)/u                                     cora1153
      if (lt) return                                                    cora1154
      c(1)=dsqrt(s)/(u*x)                                               cora1155
      c(4)=c(1)/s                                                       cora1156
      return                                                            cora1157
   49 go to ( 50 , 70 , 51 ) , ll                                       cora1158
c multipole lq=2 l1=l2                                                  cora1159
   50 b(2)=1.d0                                                         cora1160
      return                                                            cora1161
c multipole lq=2 l1=l2-2                                                cora1162
   51 b(2)=(2.d0*a-1.d0)/(3.d0*s)                                       cora1163
      b(3)=-(a+1.d0)/1.5d0                                              cora1164
      if (.not.lt) c(2)=-b(2)/(x*v)                                     cora1165
      return                                                            cora1166
   52 go to ( 70 , 53 , 70 , 54 ) , ll                                  cora1167
c multipole lq=3 l1=l2-1                                                cora1168
   53 b(2)=1.d0/(3.d0*dsqrt(s))                                         cora1169
      b(3)=-s*b(2)                                                      cora1170
      if (.not.lt) c(2)=-b(2)/(x*v)                                     cora1171
      return                                                            cora1172
c multipole lq=3 l1=l2-3                                                cora1173
   54 y=15.d0*s*dsqrt(s)                                                cora1174
      b(2)=(1.d0-2.d0*u*(a-1.d0))/y                                     cora1175
      b(3)=((2.d0*a+1.d0)*u-1.d0)*s/y                                   cora1176
      if (lt) return                                                    cora1177
      c(1)=(6.d0*a-3.d0)/(y*x**2*s)                                     cora1178
      c(2)=(2.d0+u*(2.d0*a+1.d0)-(12.d0*a**2-3.d0)/x)/(y*x*v)           cora1179
      c(3)=-3.d0/(y*x*w)                                                cora1180
      c(4)=(6.d0*a+3.d0)/(y*x**2)                                       cora1181
      return                                                            cora1182
   55 go to ( 56 , 70 , 57 , 70 , 58 ) , ll                             cora1183
c multipole lq=4 l1=l2                                                  cora1184
   56 b(2)=1.d0/(3.d0*a+6.d0)                                           cora1185
      b(3)=-(u+2.d0)*b(2)/(2.d0*s)                                      cora1186
      if (lt) return                                                    cora1187
      c(2)=-b(2)/(2.d0*x*v)                                             cora1188
      c(3)=c(2)/s                                                       cora1189
      c(4)=3.d0*c(3)/w                                                  cora1190
      return                                                            cora1191
c multipole lq=4 l1=l2-2                                                cora1192
   57 y=15.d0*s*(a+2.d0)                                                cora1193
      b(2)=-(u*(a-1.d0)-3.d0)/y                                         cora1194
      b(3)=((a+.5d0)*u-3.d0)*s/y                                        cora1195
      if (lt) return                                                    cora1196
      c(1)=(3.d0*a+6.d0)/(y*x**2*s)                                     cora1197
      c(2)=-(3.d0-(2.d0*a+1.d0)*(u-(6.d0*a+12.d0)/x))/(2.d0*y*x*v)      cora1198
      c(3)=-1.5d0/(y*x*w)                                               cora1199
      c(4)=-(2.d0*a+1.d0)*c(3)/w                                        cora1200
      return                                                            cora1201
c multipole lq=4 l1=l2-4                                                cora1202
   58 y=210.d0*(a+2.d0)*s                                               cora1203
      b(2)=(6.d0-2.d0*(a-1.d0)*u*(2.d0-(2.d0*a+3.d0)*u))/(y*s)          cora1204
      b(3)=-(6.d0-u*(4.d0*a-1.d0-u*(2.d0*a+3.d0)*(2.d0*a+1.d0)))/y      cora1205
      if (lt) return                                                    cora1206
      c1=u-(10.d0*a-5.d0)/x                                             cora1207
      c(1)=-(6.d0*a+12.d0)*(4.d0+(2.d0*a+3.d0)*c1)/(y*x**2*s**2)        cora1208
      c(2)=-(3.d0+(2.d0*a+10.d0)*u-(a+2.d0)*(108.d0*a-6.d0)/x+(2.d0*a+3.cora1209
     1d0)*(2.d0*a+1.d0)*(u**2-(6.d0*a+12.d0)*c1/x))/(y*x*v*s)           cora1210
      c(3)=-(3.d0-(6.d0*a+9.d0)*(u-(10.d0*a+20.d0)/x))/(y*x*v)          cora1211
      c(4)=-(2.d0*a+1.d0)*c(3)/w-(30.d0*a+60.d0)/(y*x**2*s)             cora1212
      return                                                            cora1213
   59 go to ( 70 , 60 , 70 , 61 , 70 , 62 ) , ll                        cora1214
c multipole lq=5 l1=l2-1                                                cora1215
   60 y=60.d0*(a+2.d0)*(a+3.d0)*dsqrt(s)                                cora1216
      b(2)=(16.d0-u*(2.d0*a-2.d0))/y                                    cora1217
      b(3)=-(16.d0-u*(2.d0*a-10.d0+u*(2.d0*a+1.d0)))/(y*s)              cora1218
      if (lt) return                                                    cora1219
      c(1)=6.d0*(a+2.d0)/(s*y*x**2)                                     cora1220
      c(2)=-(8.d0-(2.d0*a+1.d0)*(u-6.d0*(a+2.d0)/x))/(y*x*v)            cora1221
      c(3)=-(8.d0+3.d0*u-30.d0*(a+2.d0)/x)/(y*x*v*s)                    cora1222
      c(4)=(6.d0*a-12.d0+(15.d0*u-(60.d0*a+30.d0)*(a+2.d0)/x)/s**2)/(y*xcora1223
     1**2)                                                              cora1224
      return                                                            cora1225
c multipole lq=5 l1=l2-3                                                cora1226
   61 y=420.d0*(a+2.d0)*(a+3.d0)*dsqrt(s)                               cora1227
      b(2)=(48.d0-u*(2.d0*a-2.d0)*(9.d0-u*(2.d0*a+3.d0)))/(y*s)         cora1228
      b(3)=-(48.d0-u*(18.d0*a+6.d0-u*(2.d0*a+1.d0)*(2.d0*a+3.d0)))/y    cora1229
      if (lt) return                                                    cora1230
      c1=u-(10.d0*a+30.d0)/x                                            cora1231
      c(1)=(6.d0*a+12.d0)*(3.d0-(2.d0*a+3.d0)*c1)/(y*x**2*s**2)         cora1232
      c(2)=((24.d0*a+162.d0)*(a+2.d0)/x-24.d0+(12.d0*a-3.d0)*u-(2.d0*a+1cora1233
     1.d0)*(2.d0*a+3.d0)*(u**2-(6.d0*a+12.d0)*c1/x))/(y*x*s*v)          cora1234
      c(3)=-(24.d0-(6.d0*a+9.d0)*(u-(10.d0*a+20.d0)/x))/(y*x*v)         cora1235
      c(4)=-(2.d0*a+1.d0)*c(3)/w-(30.d0*a+60.d0)/(y*x**2*s)             cora1236
      return                                                            cora1237
c multipole lq=5 l1=l2-5                                                cora1238
   62 y=3780.d0*(a+2.d0)*(a+3.d0)*s*dsqrt(s)                            cora1239
      b(2)=(48.d0-u*(2.d0*a-2.d0)*(15.d0-u*(6.d0*a+6.d0-u*(2.d0*a+3.d0)*cora1240
     1(2.d0*a+5.d0))))/(y*s)                                            cora1241
      b(3)=-(48.d0-u*(30.d0*a-6.d0-u*(12.d0*a**2+12.d0*a-9.d0-u*(8.d0*a*cora1242
     1*3+36.d0*a**2+46.d0*a+15.d0))))/y                                 cora1243
      if (lt) return                                                    cora1244
      c1=u**2-(10.d0*a+30.d0)*(u-(14.d0*a-7.d0)/x)/x                    cora1245
      c(1)=(6.d0*a+12.d0)*(3.d0+(6.d0*a+24.d0)*u-(a+3.d0)*(260.d0*a+110.cora1246
     1d0)/x+(2.d0*a+5.d0)*(2.d0*a+3.d0)*c1)/(y*x**2*s**2)               cora1247
      c(2)=-(24.d0-(18.d0*a-9.d0)*u+(6.d0*a+12.d0)*(66.d0*a+183.d0)/x-(2cora1248
     1.d0*a+3.d0)*(18.d0*u**2-(12.d0*a+24.d0)*((8.d0*a+29.d0)*u-(a+3.d0)cora1249
     2*(200.d0*a-40.d0)/x)/x+(2.d0*a+5.d0)*(2.d0*a+1.d0)*(u**3-(6.d0*a+1cora1250
     32.d0)*c1/x)))/(y*x*v*s)                                           cora1251
      c1=u**2-(10.d0*a+20.d0)*(u-(14.d0*a+42.d0)/x)/x                   cora1252
      c(3)=-(24.d0-(12.d0*a+3.d0)*u+(6.d0*a+9.d0)*(2.d0*a+5.d0)*c1-(a+2.cora1253
     1d0)*(360.d0*a+1170.d0)/x)/(y*x*v)                                 cora1254
      c(4)=(18.d0*a-36.d0+(6.d0*a+9.d0)*((6.d0*a+33.d0)*u+(2.d0*a+1.d0)*cora1255
     1(2.d0*a+5.d0)*c1-(a+2.d0)*(260.d0*a+830.d0)/x))/(y*x**2*s)        cora1256
      return                                                            cora1257
   63 go to ( 64 , 70 , 65 , 70 , 66 , 70 , 67 ) , ll                   cora1258
c multipole lq=6 l1=l2                                                  cora1259
   64 y=120.d0*(a+2.d0)*(a+3.d0)*(a+4.d0)*s**2                          cora1260
      b(2)=(32.d0+u*(32.d0-u*(2.d0*a-2.d0)))/y                          cora1261
      b(3)=-(32.d0+u*(48.d0-u*(4.d0*a-14.d0+u*(2.d0*a+1.d0))))/(y*s)    cora1262
      if (lt) return                                                    cora1263
      c(1)=(a+2.d0)*(12.d0+6.d0*u-(60.d0*a+180.d0)/x)/(y*x**2*s)        cora1264
      c(2)=-(16.d0-u*(2.d0*a-12.d0+u*(2.d0*a+1.d0))+(6.d0*a+12.d0)*(2.d0cora1265
     1*a-4.d0+(2.d0*a+1.d0)*(u-(10.d0*a+30.d0)/x))/x)/(y*x*v)           cora1266
      c(3)=-(16.d0+u*(2.d0*a+20.d0+3.d0*u)-(6.d0*a+12.d0)*(4.d0-2.d0*a+5cora1267
     1.d0*u+(20.d0*a+10.d0)*(a+3.d0)/x)/x)/(y*x*s*v)                    cora1268
      c(4)=((12.d0*a-24.d0)*s**2+(6.d0*a+3.d0)*(u**2-(10.d0*a+20.d0)*(2.cora1269
     1d0+u+(4.d0*a+2.d0)*(a+3.d0)/x)/x))/(y*x**2*s**2)                  cora1270
      return                                                            cora1271
c multipole lq=6 l1=l2-2                                                cora1272
   65 y=840.d0*(a+2.d0)*(a+3.d0)*(a+4.d0)*s                             cora1273
      b(2)=(160.d0-u*(2.d0*a-2.d0)*(16.d0-u*(2.d0*a+3.d0)))/y           cora1274
      b(3)=-(160.d0-u*(32.d0*a-112.d0-u*((4.d0*a-24.d0)*a-10.d0+u*(2.d0*cora1275
     1a+3.d0)*(2.d0*a+1.d0))))/(y*s)                                    cora1276
      if (lt) return                                                    cora1277
      c1=u-(10.d0*a+30.d0)/x                                            cora1278
      c(1)=(60.d0-(12.d0*a+18.d0)*c1)*(a+2.d0)/(y*x**2*s)               cora1279
      c(2)=-(80.d0-(26.d0*a+4.d0)*u+(60.d0*a**2-240.d0)/x+(2.d0*a+1.d0)*cora1280
     1(2.d0*a+3.d0)*(u**2-(6.d0*a+12.d0)*c1/x))/(y*x*v)                 cora1281
      c(3)=-(80.d0-u*(6.d0*a-36.d0)+60.d0*(a**2-4.d0)/x-(6.d0*a+9.d0)*(ucora1282
     1**2-(10.d0*a+20.d0)*(u-(14.d0*a+42.d0)/x)/x))/(y*x*v*s)           cora1283
      c(4)=-(105.d0*(1.d0-(10.d0*a+20.d0)/x)-(60.d0*a-15.d0)*s**2+(6.d0*cora1284
     1a+3.d0)*(2.d0*a+3.d0)*(u*s**2-(10.d0*a+20.d0)*(1.d0+u-(14.d0*a+42.cora1285
     2d0)/x)/x))/(y*x**2*s**2)                                          cora1286
      return                                                            cora1287
c multipole lq=6 l1=l2-4                                                cora1288
   66 y=7560.d0*(a+2.d0)*(a+3.d0)*(a+4.d0)*s                            cora1289
      b(2)=(480.d0-u*(2.d0*a-2.d0)*(96.d0-u*(24.d0*a+33.d0-u*(2.d0*a+3.dcora1290
     10)*(2.d0*a+5.d0))))/(y*s)                                         cora1291
      b(3)=-(480.d0-u*(192.d0*a+48.d0-u*(2.d0*a+3.d0)*(24.d0*a+6.d0-u*(2cora1292
     1.d0*a+1.d0)*(2.d0*a+5.d0))))/y                                    cora1293
      if (lt) return                                                    cora1294
      c1=(u**2-(10.d0*a+30.d0)*(u-(14.d0*a+56.d0)/x)/x)                 cora1295
      c(1)=(6.d0*a+12.d0)*(30.d0-(12.d0*a+3.d0)*u-(a+3.d0)*(80.d0*a+470.cora1296
     1d0)/x+(2.d0*a+3.d0)*(2.d0*a+5.d0)*c1)/(y*x**2*s**2)               cora1297
      c(2)=-(240.d0-u*(126.d0*a-36.d0)+180.d0*(a**2-4.d0)/x+(2.d0*a+3.d0cora1298
     1)*((18.d0*a-9.d0)*u**2-(6.d0*a+12.d0)*((2.d0*a-49.d0)*u+(10.d0*a+3cora1299
     20.d0)*(22.d0*a+109.d0)/x)/x-(2.d0*a+1.d0)*(2.d0*a+5.d0)*(u**3-(6.dcora1300
     30*a+12.d0)*c1/x)))/(y*x*w*s**2)                                   cora1301
      c1=(2.d0*a+5.d0)*(u**2-(10.d0*a+20.d0)*(u-(14.d0*a+42.d0)/x)/x)   cora1302
      c(3)=-(240.d0-(66.d0*a+84.d0)*u+180.d0*(a**2-4.d0)/x+(6.d0*a+9.d0)cora1303
     1*c1)/(y*x*v)                                                      cora1304
      c(4)=((a-2.d0)*(180.d0-(72.d0*a+108.d0)*u)+(6.d0*a+9.d0)*((2.d0*a+cora1305
     11.d0)*c1-(a+2.d0)*(80.d0*a+740.d0)/x))/(y*x**2*s)                 cora1306
      return                                                            cora1307
c multipole lq=6 l1=l2-6                                                cora1308
   67 y=83160.d0*(a+2.d0)*(a+3.d0)*(a+4.d0)*s**2                        cora1309
      b(2)=(480.d0-u*(2.d0*a-2.d0)*(144.d0-u*(54.d0*a+57.d0-u*(2.d0*a+5.cora1310
     1d0)*(8.d0*a+6.d0-u*(2.d0*a+7.d0)*(2.d0*a+3.d0)))))/(y*s)          cora1311
      b(3)=-(480.d0-u*(288.d0*a-48.d0-u*(108.d0*a**2+120.d0*a-78.d0-u*(2cora1312
     1.d0*a+3.d0)*(2.d0*a+5.d0)*(8.d0*a-5.d0-u*(2.d0*a+1.d0)*(2.d0*a+7.dcora1313
     20)))))/y                                                          cora1314
      if (lt) return                                                    cora1315
      c1=u**3-(10.d0*a+30.d0)*(u**2-(14.d0*a+56.d0)*(u-(18.d0*a-9.d0)/x)cora1316
     1/x)/x                                                             cora1317
      c(1)=(6.d0*a+12.d0)*(30.d0-(18.d0*a-3.d0)*u+(10.d0*a+30.d0)*(118.dcora1318
     10*a+457.d0)/x-(2.d0*a+5.d0)*((4.d0*a+36.d0)*u**2-(10.d0*a+30.d0)*(cora1319
     2(24.d0*a+106.d0)*u-(14.d0*a+56.d0)*(52.d0*a+6.d0)/x)/x+(2.d0*a+7.dcora1320
     30)*(2.d0*a+3.d0)*c1))/(y*x**2*s**2)                               cora1321
      c(2)=-(240.d0-(174.d0*a-84.d0)*u+((72.d0*a+36.d0)*a-63.d0)*u**2+(1cora1322
     180.d0*(a**2-4.d0)-(6.d0*a+12.d0)*(((136.d0*a+772.d0)*a+1377.d0)*u-cora1323
     2(10.d0*a+30.d0)*((712.d0*a+3370.d0)*a+2193.d0)/x))/x-(2.d0*a+5.d0)cora1324
     3*(2.d0*a+3.d0)*((2.d0*a-26.d0)*u**3+(6.d0*a+12.d0)*((14.d0*a+82.d0cora1325
     4)*u**2-(10.d0*a+30.d0)*((38.d0*a+166.d0)*u-(14.d0*a+56.d0)*(70.d0*cora1326
     5a-19.d0)/x)/x)/x-(2.d0*a+7.d0)*(2.d0*a+1.d0)*(u**4-6.d0*(a+2.d0)*ccora1327
     61/x)))/(y*x*v*s)                                                  cora1328
      c1=u**3-(10.d0*a+20.d0)*(u**2-(14.d0*a+42.d0)*(u-(18.d0*a+72.d0)/xcora1329
     1)/x)/x                                                            cora1330
      c(3)=-(240.d0-(114.d0*a+36.d0)*u+180*(a**2-4.d0)/x+(6.d0*a+15.d0)*cora1331
     1((6.d0*a-1.d0)*u**2+(10.d0*a+20.d0)*((10.d0*a+57.d0)*u-(14.d0*a+42cora1332
     2.d0)*(34.d0*a+141.d0)/x)/x-(2.d0*a+7.d0)*(2.d0*a+3.d0)*c1))/(y*x*vcora1333
     3)                                                                 cora1334
      c(4)=(180.d0*a-360.d0-(108.d0*a+72.d0)*(a-2.d0)*u+(60.d0*a+120.d0)cora1335
     1*((118.d0*a+796.d0)*a+1401.d0)/x-(2.d0*a+5.d0)*(6.d0*a+9.d0)*((4.dcora1336
     20*a+47.d0)*u**2-(10.d0*a+20.d0)*((24.d0*a+117.d0)*u-(14.d0*a+42.d0cora1337
     3)*(52.d0*a+215.d0)/x)/x+(2.d0*a+7.d0)*(2.d0*a+1.d0)*c1))/(y*x**2*scora1338
     4)                                                                 cora1339
      return                                                            cora1340
   68 write (mw,1000) lq,ll                                             cora1341
      return                                                            cora1342
   69 write (mw,1001) lq,ll                                             cora1343
      return                                                            cora1344
   70 write (mw,1002) lq,ll                                             cora1345
      return                                                            cora1346
 1000 format (' in cora: lq =',i3,' too large or l1-l2+1=',i3,' out of bcora1347
     1ounds')                                                           cora1348
 1001 format (' in cora: coefficients suppressed for lq =',i3,' and l1-lcora1349
     12+1=',i3)                                                         cora1350
 1002 format (' in cora: coefficients not given by the method for lq =',cora1351
     1i3,' and l1-l2+1=',i3)                                            cora1352
      end                                                               cora1353
c 29/02/04                                                      ecis03  inti-000
      subroutine inti(fam,x,fr,gr,wre,pad,ipe,ism,kab,w,iterm,nc,v,vi,nvinti-001
     1i,mc,nat,at,ag,npx,h,acnv,eiter,ncin,nni,iterr,lo)                inti-002
c  e. c. i. s. method: schroedinger equation driving routine.           inti-003
c  inti calls insh  to solve the single homogeneous equations           inti-004
c             insi  to solve the single inhomogeneous equations         inti-005
c  pade approximants of type i may be used to accelerate the convergenceinti-006
c input variables: fam(ic,i): matching values for i=1,6                 inti-007
c                             constants of each equation for i=7,10     inti-008
c                  ism:   number of radial points                       inti-009
c                  kab:   maximum number of coupled channels            inti-010
c                  iterm: maximum number of iterations and dim. of pad  inti-011
c                  nc:    number of coupled equations                   inti-012
c                  v,vi:  real, imaginary potentials and couplings      inti-013
c                  nvi:   addresses of couplings                        inti-014
c                  mc:    nuclear state number, angular momenta....     inti-015
c                  nat,at:table of coupling coefficients                inti-016
c                  ag:    coulomb integrals for coulomb corrections     inti-017
c                  npx:   number of central potentials                  inti-018
c                  h:     step length                                   inti-019
c                  acnv:  epsilon for negligible function values        inti-020
c                  eiter: convergence epsilon for the scattering coef.  inti-021
c                  ncin:  number of solutions                           inti-022
c                  lo(i): logical controls                              inti-023
c  lo(22) =.true.  no use of pade approximants for convergence          inti-024
c  lo(23) =.true.  coupled equations when convergence is not obtained   inti-025
c  lo(29) =.true.  no diagonal terms in second members                  inti-026
c  lo(44) +.true.  coulomb corrections                                  inti-027
c  lo(53) =.true.  output of the number of iterations                   inti-028
c  lo(57) =.true.  output of phase-shifts at each e.c.i.s. iteration    inti-029
c  lo(92) =.true.  pure dwba calculation                                inti-030
c  lo(204)=.true.  if convergence is obtained in the iteration          inti-031
c  lo(206)=.true.  when the iteration is not the last one permitted     inti-032
c  lo(207)=.true.  if all the couplings have to be calculated beforehandinti-033
c  lo(210)=.true.  if derivatives are needed                            inti-034
c  lo(221)=.true.  for optical model without coupling                   inti-035
c output variables:fam(ic,i+7): scattering coefficients                 inti-036
c working fields:  x:     used in insh and insi                         inti-037
c                  fr:    solutions of homogeneous equations            inti-038
c                  gr:    solutions of coupled equations                inti-039
c                  wre:   real/imaginary inhomogeneous term             inti-040
c                  pad(iterm,kab+2): pade approximants                  inti-041
c               ipe(i,1): first non negligible point of uncoupled func. inti-042
c               ipe(i,2): first non negligible point of coupled funct.  inti-043
c                  w:     free part of the storage for couplings        inti-044
c output variables:nni:   number of eq. with negligible inhomog. term   inti-045
c                  iterr: largest number of iterations done for this j  inti-046
c***********************************************************************inti-047
      implicit real*8 (a-h,o-z)                                         inti-048
      logical lo(250)                                                   inti-049
      dimension fr(ism,4,1),gr(2,ism,1),wre(2,1),ipe(nc,2),v(ism,9),vi(iinti-050
     1sm,9),w(ism,1),nvi(kab,kab,4),mc(kab,6),nat(4,1),at(2,1),fam(kab,8inti-051
     2),x(1),pad(2,iterm,1),ag(kab,kab,4),z(4),y(2)                     inti-052
      common /inout/ mr,mw,ms                                           inti-053
c compute all coupling potentials and solve all homogeneous equations   inti-054
      i2=4*ism                                                          inti-055
      do 4 i=1,nc                                                       inti-056
      i1=mc(i,4)                                                        inti-057
      if (i1.lt.0) go to 1                                              inti-058
      call insh(fr(1,1,i),i,i1,kt,acnv,fam,x,kab,ism,v,vi,npx,nat,at,nviinti-059
     1,mc,lo)                                                           inti-060
      ipe(i,1)=kt                                                       inti-061
      go to 3                                                           inti-062
    1 i1=-i1                                                            inti-063
      if (i.eq.i1) go to 3                                              inti-064
      do 2 is=1,i2                                                      inti-065
    2 fr(is,1,i)=fr(is,1,i1)                                            inti-066
      ipe(i,1)=ipe(i1,1)                                                inti-067
    3 if (lo(57)) write (mw,1000) fam(i,7),fam(i,8),i,ipe(i,1)          inti-068
    4 continue                                                          inti-069
      if ((.not.lo(207)).or.lo(221)) go to 32                           inti-070
      ivv=0                                                             inti-071
c calculation of the non diagonal coupling potentials                   inti-072
      do 31 ic=1,nc                                                     inti-073
      do 27 ip=1,nc                                                     inti-074
      k1=nvi(ip,ic,1)                                                   inti-075
      k2=nvi(ip,ic,2)                                                   inti-076
      k3=nvi(ip,ic,3)                                                   inti-077
      if (k2.eq.k3.and.ip.lt.ic) go to 25                               inti-078
      do 5 j=1,4                                                        inti-079
    5 nvi(ip,ic,j)=0                                                    inti-080
c non derivative coupling potentials                                    inti-081
      if (k1.gt.k2) go to 15                                            inti-082
      if (lo(29).and.(ic.eq.ip)) go to 15                               inti-083
      ivv=ivv+1                                                         inti-084
      nvi(ip,ic,1)=ivv                                                  inti-085
      kt=iabs(nat(1,k1))                                                inti-086
      nima=k2+1-k1                                                      inti-087
      if (kt.eq.nat(1,k1)) nima=nima-1                                  inti-088
      do 6 is=1,ism                                                     inti-089
    6 w(is,ivv)=at(2,k1)*v(is,kt)                                       inti-090
      if (k1.eq.k2) go to 9                                             inti-091
      k4=k1+1                                                           inti-092
      do 8 k=k4,k2                                                      inti-093
      kt=iabs(nat(1,k))                                                 inti-094
      if (kt.eq.nat(1,k)) nima=nima-1                                   inti-095
      do 7 is=1,ism                                                     inti-096
    7 w(is,ivv)=w(is,ivv)+at(2,k)*v(is,kt)                              inti-097
    8 continue                                                          inti-098
    9 if (nima.eq.0) go to 15                                           inti-099
      ivv=ivv+1                                                         inti-100
      nvi(ip,ic,2)=ivv                                                  inti-101
      do 11 k=k1,k2                                                     inti-102
      if (nat(1,k).gt.0) go to 11                                       inti-103
      kt=-nat(1,k)                                                      inti-104
      do 10 is=1,ism                                                    inti-105
   10 w(is,ivv)=at(2,k)*vi(is,kt)                                       inti-106
      go to 12                                                          inti-107
   11 continue                                                          inti-108
   12 k1=k+1                                                            inti-109
      if (k1.gt.k2) go to 15                                            inti-110
      do 14 k=k1,k2                                                     inti-111
      if (nat(1,k).gt.0) go to 14                                       inti-112
      kt=-nat(1,k)                                                      inti-113
      do 13 is=1,ism                                                    inti-114
   13 w(is,ivv)=w(is,ivv)+at(2,k)*vi(is,kt)                             inti-115
   14 continue                                                          inti-116
c derivative coupling potentials                                        inti-117
   15 k2=k2+1                                                           inti-118
      if (k2.gt.k3) go to 27                                            inti-119
      ivv=ivv+1                                                         inti-120
      nvi(ip,ic,3)=ivv                                                  inti-121
      kt=iabs(nat(1,k2))                                                inti-122
      nima=k3+1-k2                                                      inti-123
      if (kt.eq.nat(1,k2)) nima=nima-1                                  inti-124
      do 16 is=1,ism                                                    inti-125
   16 w(is,ivv)=at(2,k2)*v(is,kt)                                       inti-126
      if (k2.eq.k3) go to 19                                            inti-127
      k4=k2+1                                                           inti-128
      do 18 k=k4,k3                                                     inti-129
      kt=iabs(nat(1,k))                                                 inti-130
      if (kt.eq.nat(1,k)) nima=nima-1                                   inti-131
      do 17 is=1,ism                                                    inti-132
   17 w(is,ivv)=w(is,ivv)+at(2,k)*v(is,kt)                              inti-133
   18 continue                                                          inti-134
   19 if (nima.eq.0) go to 27                                           inti-135
      ivv=ivv+1                                                         inti-136
      nvi(ip,ic,4)=ivv                                                  inti-137
      do 21 k=k2,k3                                                     inti-138
      kt=-nat(1,k)                                                      inti-139
      if (kt.eq.nat(1,k)) go to 21                                      inti-140
      do 20 is=1,ism                                                    inti-141
   20 w(is,ivv)=at(2,k)*vi(is,kt)                                       inti-142
      go to 22                                                          inti-143
   21 continue                                                          inti-144
   22 k2=k+1                                                            inti-145
      if (k2.gt.k3) go to 27                                            inti-146
      do 24 k=k2,k3                                                     inti-147
      kt=-nat(1,k)                                                      inti-148
      if (kt.eq.nat(1,k)) go to 24                                      inti-149
      do 23 is=1,ism                                                    inti-150
   23 w(is,ivv)=w(is,ivv)+at(2,k)*vi(is,kt)                             inti-151
   24 continue                                                          inti-152
      go to 27                                                          inti-153
c symmetrisation of the table                                           inti-154
   25 do 26 k=1,4                                                       inti-155
   26 nvi(ip,ic,k)=nvi(ic,ip,k)                                         inti-156
   27 continue                                                          inti-157
c correction to an increase of the imaginary potential                  inti-158
      if (mc(ic,6).eq.0) go to 31                                       inti-159
      i1=mc(ic,4)                                                       inti-160
      if (nvi(ic,ic,2).eq.0) go to 29                                   inti-161
      k=nvi(ic,ic,2)                                                    inti-162
      do 28 is=1,ism                                                    inti-163
   28 w(is,k)=w(is,k)-mc(ic,6)*vi(is,i1)                                inti-164
      go to 31                                                          inti-165
   29 ivv=ivv+1                                                         inti-166
      nvi(ic,ic,2)=ivv                                                  inti-167
      do 30 is=1,ism                                                    inti-168
   30 w(is,ivv)=-mc(ic,6)*vi(is,i1)                                     inti-169
   31 continue                                                          inti-170
   32 conv=acnv*h*h                                                     inti-171
      nni=0                                                             inti-172
c loop on solutions                                                     inti-173
      do 46 nci=1,ncin                                                  inti-174
      nci1=nci+8                                                        inti-175
      nci2=nci1+ncin                                                    inti-176
c set the zero's order solution                                         inti-177
      do 33 ic=1,nc                                                     inti-178
      ipe(ic,2)=ism+1                                                   inti-179
      fam(ic,nci1)=0.d0                                                 inti-180
   33 fam(ic,nci2)=0.d0                                                 inti-181
      fam(nci,nci1)=fam(nci,7)                                          inti-182
      fam(nci,nci2)=fam(nci,8)                                          inti-183
      if ((ipe(nci,1).gt.ism-3).or.lo(221)) go to 46                    inti-184
      do 34 is=1,ism                                                    inti-185
      gr(1,is,nci)=fr(is,1,nci)                                         inti-186
   34 gr(2,is,nci)=fr(is,2,nci)                                         inti-187
      ipe(nci,2)=ipe(nci,1)                                             inti-188
c derive the zero's order equation                                      inti-189
      if (lo(210)) call insi(wre,gr,gr(1,1,nc+1),fr,fam,x,pad,pad,1,eiteinti-190
     1r,acnv,kab,ism,ipe,nci,v,vi,w,conv,nat,at,nvi,nc,y,y,mc,lo,.true.,inti-191
     2h,z)                                                              inti-192
      amax=0.d0                                                         inti-193
c e. c. i. s. loop                                                      inti-194
      do 44 kiter=1,iterm                                               inti-195
      iterr=max0(iterr,kiter)                                           inti-196
      lo(204)=.true.                                                    inti-197
      lo(206)=((kiter.ne.iterm).and.(amax.lt.1.d10)).or.lo(23)          inti-198
      if (amax.gt.1.d10) write (mw,1001) amax,kiter                     inti-199
      do 43 ic=1,nc                                                     inti-200
      i=mod(ic+nci-1,nc)+1                                              inti-201
c compute second members and solve the inhomogeneous equations          inti-202
      do 35 j=1,4                                                       inti-203
   35 z(j)=0.d0                                                         inti-204
      if (lo(144)) go to 40                                             inti-205
      do 38 j=1,nc                                                      inti-206
      if ((lo(29).and.(i.eq.j)).or.(ipe(j,2).ge.ism)) go to 38          inti-207
c order in fg   f(ei)*f(ef),g(ei)*f(ef),f(ei)*g(ef),g(ei)*g(ef)         inti-208
      if (lo(22)) go to 36                                              inti-209
      ij=kiter                                                          inti-210
      if (1+mod(j+nc-nci-1,nc).ge.ic) ij=ij-1                           inti-211
      if (ij.eq.0) go to 36                                             inti-212
      y(1)=pad(1,ij,j)                                                  inti-213
      y(2)=pad(2,ij,j)                                                  inti-214
      go to 37                                                          inti-215
   36 y(1)=fam(j,nci1)                                                  inti-216
      y(2)=fam(j,nci2)                                                  inti-217
   37 z(1)=z(1)+y(1)*ag(i,j,3)-y(2)*ag(i,j,1)                           inti-218
      z(2)=z(2)+y(1)*ag(i,j,1)+y(2)*ag(i,j,3)                           inti-219
      z(3)=z(3)+y(1)*ag(i,j,4)-y(2)*ag(i,j,2)                           inti-220
      z(4)=z(4)+y(1)*ag(i,j,2)+y(2)*ag(i,j,4)                           inti-221
   38 continue                                                          inti-222
      if (i.eq.nci) go to 39                                            inti-223
      z(1)=z(1)+ag(i,nci,1)                                             inti-224
      z(3)=z(3)+ag(i,nci,2)                                             inti-225
   39 z(3)=z(3)-z(2)                                                    inti-226
      z(4)=z(4)+z(1)                                                    inti-227
      z(1)=z(1)+fam(i,7)*z(3)-fam(i,8)*z(4)                             inti-228
      z(2)=z(2)+z(3)*fam(i,8)+z(4)*fam(i,7)                             inti-229
   40 if (i.ne.nci) go to 41                                            inti-230
      z(1)=z(1)-fam(i,7)                                                inti-231
      z(2)=z(2)-fam(i,8)                                                inti-232
      z(3)=z(3)-1.d0                                                    inti-233
   41 if (lo(23).and.(.not.lo(206))) lo(204)=.true.                     inti-234
      call insi(wre,gr,gr(1,1,nc+1),fr,fam(i,5),x,pad(1,1,i),pad(1,1,nc+inti-235
     11),kiter,eiter,acnv,kab,ism,ipe(1,2),i,v,vi,w,conv,nat,at,nvi,nc,finti-236
     2am(i,nci1),fam(i,nci2),mc,lo,.false.,h,z)                         inti-237
      if (ipe(i,2).ge.ism) go to 42                                     inti-238
      amax=dmax1(amax,dabs(fam(i,nci1))+dabs(fam(i,nci2)))              inti-239
      if (i.ne.nci.and.lo(92)) ipe(i,2)=ism+1                           inti-240
      go to 43                                                          inti-241
   42 fam(i,nci1)=-z(1)                                                 inti-242
      fam(i,nci2)=-z(2)                                                 inti-243
      if (lo(57)) write (mw,1002)                                       inti-244
      if (kiter.eq.1.and.lo(144)) nni=nni+1                             inti-245
      if (i.eq.nci) ipe(nci,2)=ipe(nci,1)                               inti-246
   43 continue                                                          inti-247
      if (lo(204).or.(amax.gt.1.d10.and.lo(23))) go to 45               inti-248
   44 continue                                                          inti-249
      kiter=min0(kiter,iterm)                                           inti-250
   45 if (lo(53)) write (mw,1003) kiter                                 inti-251
   46 continue                                                          inti-252
      nni=nni/ncin                                                      inti-253
      return                                                            inti-254
 1000 format (2d30.15,5x,2i5)                                           inti-255
 1001 format (' maximum',d15.6,' obtained in previous iteration. last oninti-256
     1e is',i3)                                                         inti-257
 1002 format (5x,'the inhomogeneous term is neglected')                 inti-258
 1003 format (5x,i5,' iterations')                                      inti-259
      end                                                               inti-260
c 29/02/04                                                      ecis03  insh-000
      subroutine insh(p,ic,i1,kt,aconv,fam,x,kab,ism,v,vi,npx,nat,at,nviinsh-001
     1,mc,lo)                                                           insh-002
c  e. c. i. s. method: integration of a single homogeneous equation by  insh-003
c  the numerov method       - schroedinger equation -                   insh-004
c input variables: ic:    channel number of the equation                insh-005
c                  aconv: limit for negligible function values          insh-006
c                  fam(ic,i): matching values for i=1,4                 insh-007
c                             wave number for i=6                       insh-008
c                             constants of this equation for i=7,10     insh-009
c                  kab:   maximum number of coupled channels            insh-010
c                  v,vi:  real, imaginary potentials and couplings      insh-011
c                  npx:   number of central potentials                  insh-012
c                  ism:   number of radial points                       insh-013
c                  nat,at:coupling coefficients                         insh-014
c                  nvi:   table of addresses in nat,at                  insh-015
c                  mc(,6):coefficient of increase of imaginary potentialinsh-016
c                  lo(i): logical controls                              insh-017
c output variables:p(ism,i): real/imaginary regular solution for i=1,2  insh-018
c                            real/imaginary irregular solution for i=3,4insh-019
c                  fam(ic,7/8): real/imaginary part of zero's order     insh-020
c                            scattering coefficients                    insh-021
c                  kt:    the solution is negligible for is < kt        insh-022
c working space:   x:     for the integration                           insh-023
c***********************************************************************insh-024
      implicit real*8 (a-h,o-z)                                         insh-025
      logical lo(250)                                                   insh-026
      dimension p(ism,4),v(ism,1),vi(ism,1),nvi(kab,kab,2),nat(4,1),at(2insh-027
     1,1),mc(kab,6),fam(kab,10),x(2,2)                                  insh-028
      bconv=aconv                                                       insh-029
c for closed channels when green's function is used                     insh-030
      if (fam(ic,9).lt.0.d0) bconv=1.d-15                               insh-031
c computation of the regular solution                                   insh-032
      i2=i1+npx                                                         insh-033
      do 1 is=1,ism                                                     insh-034
      a=is*is                                                           insh-035
      x(1,is+2)=fam(ic,9)-fam(ic,10)/a+fam(ic,7)*v(is,i1)               insh-036
      x(2,is+2)=fam(ic,7)*vi(is,i1)                                     insh-037
      if (lo(229)) x(1,is+2)=x(1,is+2)+fam(ic,8)*v(is,i2)               insh-038
      if (lo(230)) x(2,is+2)=x(2,is+2)+fam(ic,8)*vi(is,i2)              insh-039
    1 continue                                                          insh-040
      if (lo(129)) go to 5                                              insh-041
      k1=nvi(ic,ic,1)                                                   insh-042
      k2=nvi(ic,ic,2)                                                   insh-043
      if (k1.gt.k2) go to 5                                             insh-044
      do 4 k=k1,k2                                                      insh-045
      kt=iabs(nat(1,k))                                                 insh-046
      do 2 is=1,ism                                                     insh-047
    2 x(1,is+2)=x(1,is+2)+at(2,k)*v(is,kt)                              insh-048
      if (nat(1,k).gt.0) go to 4                                        insh-049
      do 3 is=1,ism                                                     insh-050
    3 x(2,is+2)=x(2,is+2)+at(2,k)*vi(is,kt)                             insh-051
    4 continue                                                          insh-052
    5 if (mc(ic,6).eq.0) go to 7                                        insh-053
      do 6 is=1,ism                                                     insh-054
    6 x(2,is+2)=x(2,is+2)+vi(is,i1)*mc(ic,6)                            insh-055
    7 if (lo(27)) go to 9                                               insh-056
c modified numerov method                                               insh-057
      do 8 is=1,ism                                                     insh-058
      a=x(1,is+2)**2-x(2,is+2)**2                                       insh-059
      if (lo(26)) a=a*(1.d0-x(1,is+2)*.033333333333333d0)               insh-060
      x(2,is+2)=x(2,is+2)*(1.d0-x(1,is+2)*.166666666666667d0)           insh-061
    8 x(1,is+2)=x(1,is+2)-a*.083333333333333d0                          insh-062
      go to 11                                                          insh-063
c numerov method                                                        insh-064
    9 do 10 is=1,ism                                                    insh-065
      b=(12.d0+x(1,is+2))**2+x(2,is+2)**2                               insh-066
      a=12.d0*(x(1,is+2)*(12.d0+x(1,is+2))+x(2,is+2)**2)/b              insh-067
      if (lo(26)) a=a*(1.d0+x(1,is+2)**2*.416666666666667d-2)           insh-068
      x(1,is+2)=a                                                       insh-069
   10 x(2,is+2)=144.d0*x(2,is+2)/b                                      insh-070
   11 x(1,1)=0.d0                                                       insh-071
      x(2,1)=0.d0                                                       insh-072
      x(1,2)=1.d-15                                                     insh-073
      x(2,2)=0.d0                                                       insh-074
      do 13 is=1,ism                                                    insh-075
      p(is,3)=x(1,is+2)                                                 insh-076
      p(is,4)=x(2,is+2)                                                 insh-077
      hx=x(1,is+1)*x(1,is+2)-x(2,is+1)*x(2,is+2)                        insh-078
      hy=x(2,is+1)*x(1,is+2)+x(1,is+1)*x(2,is+2)                        insh-079
      x(1,is+2)=x(1,is+1)+x(1,is+1)-x(1,is)-hx                          insh-080
      x(2,is+2)=x(2,is+1)+x(2,is+1)-x(2,is)-hy                          insh-081
      if (dabs(x(1,is+2)).lt.1.d15) go to 13                            insh-082
c  renormalisation of large function values                             insh-083
      j=2*is+4                                                          insh-084
      do 12 i=3,j                                                       insh-085
   12 x(i,1)=x(i,1)*1.d-30                                              insh-086
   13 continue                                                          insh-087
c end of integration                                                    insh-088
c matching                                                              insh-089
      bre=x(1,ism)*fam(ic,4)-fam(ic,3)*x(1,ism+2)                       insh-090
      bim=x(2,ism)*fam(ic,4)-fam(ic,3)*x(2,ism+2)                       insh-091
      hx=x(1,ism)*fam(ic,2)-fam(ic,1)*x(1,ism+2)                        insh-092
      hy=x(2,ism)*fam(ic,2)-fam(ic,1)*x(2,ism+2)                        insh-093
      if (fam(ic,9).lt.0.d0) go to 14                                   insh-094
      bim=bim+hx                                                        insh-095
      bre=bre-hy                                                        insh-096
   14 a=bre*bre+bim*bim                                                 insh-097
      bre=-bre/a                                                        insh-098
      bim=bim/a                                                         insh-099
      fam(ic,7)=bre*hx-bim*hy                                           insh-100
      fam(ic,8)=hx*bim+hy*bre                                           insh-101
      if (lo(221)) return                                               insh-102
      bre=bre/12.d0                                                     insh-103
      bim=bim/12.d0                                                     insh-104
c normalisation of the regular solution                                 insh-105
      do 15 is=1,ism                                                    insh-106
      hx=x(1,is)+10.d0*x(1,is+1)+x(1,is+2)                              insh-107
      hy=x(2,is)+10.d0*x(2,is+1)+x(2,is+2)                              insh-108
      p(is,1)=hx*bre-hy*bim                                             insh-109
   15 p(is,2)=hx*bim+hy*bre                                             insh-110
c search of the first non negligible value                              insh-111
      do 16 kt=1,ism                                                    insh-112
      if ((abs(p(kt,1))+abs(p(kt,2))).gt.bconv) go to 17                insh-113
   16 continue                                                          insh-114
   17 if (lo(92)) return                                                insh-115
      hx=0.d0                                                           insh-116
      hy=0.d0                                                           insh-117
      if (fam(ic,9).lt.0.d0) go to 18                                   insh-118
      hx=fam(ic,1)                                                      insh-119
      hy=fam(ic,2)                                                      insh-120
c computation of the irregular solution - starting values               insh-121
c  the two last points of imaginary potential are zero                  insh-122
   18 x(2,ism)=hx/fam(ic,6)                                             insh-123
      x(2,ism+2)=hy/fam(ic,6)                                           insh-124
      x(1,ism)=fam(ic,3)/fam(ic,6)                                      insh-125
      x(1,ism+2)=fam(ic,4)/fam(ic,6)                                    insh-126
      bre=2.d0-p(ism,3)                                                 insh-127
      x(1,ism+1)=(x(1,ism)+x(1,ism+2))/bre                              insh-128
      x(2,ism+1)=(x(2,ism)+x(2,ism+2))/bre                              insh-129
      j1=ism-kt                                                         insh-130
      if (j1.le.0) go to 20                                             insh-131
c integration                                                           insh-132
      do 19 js=1,j1                                                     insh-133
      is=ism-js                                                         insh-134
      hx=x(1,is+1)*p(is,3)-x(2,is+1)*p(is,4)                            insh-135
      hy=x(2,is+1)*p(is,3)+x(1,is+1)*p(is,4)                            insh-136
      x(1,is)=x(1,is+1)+x(1,is+1)-x(1,is+2)-hx                          insh-137
   19 x(2,is)=x(2,is+1)+x(2,is+1)-x(2,is+2)-hy                          insh-138
c computation of irregular solution                                     insh-139
   20 do 21 is=kt,ism                                                   insh-140
      p(is,3)=(x(1,is)+10.d0*x(1,is+1)+x(1,is+2))/12.d0                 insh-141
   21 p(is,4)=(x(2,is)+10.d0*x(2,is+1)+x(2,is+2))/12.d0                 insh-142
      return                                                            insh-143
      end                                                               insh-144
c 29/02/04                                                      ecis03  insi-000
      subroutine insi(w,p,pd,ph,fam,x,pad1,pad2,kiter,eiter,aconv,kab,isinsi-001
     1m,ipd,i,v,vi,www,conv,nat,at,nvi,nc,far,fai,mc,lo,lt,h,z)         insi-002
c  e. c. i. s. method: integration of a single inhomogeneous equation   insi-003
c  by the numerov method       - schroedinger equation -                insi-004
c input variables: p:     coupled solution                              insi-005
c                  ph:    homogeneous solutions                         insi-006
c                  pd:    derivative of the coupled solution            insi-007
c                  fam:   wave number                                   insi-008
c                  kiter: current iteration number                      insi-009
c                  eiter: convergence epsilon for the scattering coeff. insi-010
c                  aconv: epsilon for negligible function values        insi-011
c                  kab:   maximum number of equations                   insi-012
c                  ism:   number of radial points                       insi-013
c                  ipd(ic): the function ic is negligible for r < ipd*h insi-014
c                  i:     channel number of the equation                insi-015
c                  v,vi:  real, imaginary potentials and couplings      insi-016
c                  www:   coupling between equations computed in inti   insi-017
c                  conv:  epsilon for negligible second member          insi-018
c                  nat,at:table of coupling coefficients                insi-019
c                  nvi:   addresses of coupling coefficients            insi-020
c                  nc:    number of coupled channels                    insi-021
c                  far,fai: phase-shifts to update                      insi-022
c                  lo(i): logical controls                              insi-023
c                  lt:    .true. to compute only the derivative         insi-024
c                  h:     integration step                              insi-025
c                  z:     coulomb integral for corrections              insi-026
c output variables:p:     solution for equation i                       insi-027
c                  pd:    derivative of the solution for equation i     insi-028
c                  far,fai:  scattering coefficient                     insi-029
c working field:   w(2,ism): real/imaginary second member               insi-030
c                  pad1: iteration results for the channel i            insi-031
c                  pad2: working field of pade,twice longer than pad1   insi-032
c                  x:    integral of regular solution with second memberinsi-033
c***********************************************************************insi-034
      implicit real*8 (a-h,o-z)                                         insi-035
      logical lo(250),lt                                                insi-036
      dimension ph(ism,4,1),p(2,ism,1),pd(2,ism,1),w(2,1),ipd(1),v(ism,1insi-037
     1),vi(ism,1),www(ism,1),nat(4,1),at(2,1),nvi(kab,kab,4),mc(kab,6),finsi-038
     2am(1),x(2,1),pad1(2,1),pad2(2,1),z(4),far(1),fai(1)               insi-039
      common /inout/ mr,mw,ms                                           insi-040
      if (lt) go to 35                                                  insi-041
      ism1=ism+1                                                        insi-042
c put zero in the inhomogeneous terms                                   insi-043
      do 1 is=1,ism                                                     insi-044
      w(1,is)=0.d0                                                      insi-045
    1 w(2,is)=0.d0                                                      insi-046
      idp=ism1                                                          insi-047
c non derivative term of coupling potentials                            insi-048
      do 23 ic=1,nc                                                     insi-049
      if (ipd(ic).gt.ism) go to 23                                      insi-050
      if (lo(207)) go to 7                                              insi-051
c no previous calculation of coupling potentials                        insi-052
      if (ic.ne.i) go to 3                                              insi-053
      if (mc(ic,6).eq.0) go to 3                                        insi-054
      kt=mc(ic,4)                                                       insi-055
      do 2 is=1,ism                                                     insi-056
      w(1,is)=w(1,is)+dfloat(mc(ic,6))*vi(is,kt)*p(2,is,ic)             insi-057
    2 w(2,is)=w(2,is)-dfloat(mc(ic,6))*vi(is,kt)*p(1,is,ic)             insi-058
    3 if (lo(29).and.(ic.eq.i)) go to 23                                insi-059
      k1=nvi(ic,i,1)                                                    insi-060
      k2=nvi(ic,i,2)                                                    insi-061
      if (k1.gt.k2) go to 13                                            insi-062
      k3=ipd(ic)                                                        insi-063
      idp=min0(idp,k3)                                                  insi-064
      do 6 k=k1,k2                                                      insi-065
      kt=iabs(nat(1,k))                                                 insi-066
      do 4 is=k3,ism                                                    insi-067
      w(1,is)=w(1,is)+at(2,k)*v(is,kt)*p(1,is,ic)                       insi-068
    4 w(2,is)=w(2,is)+at(2,k)*v(is,kt)*p(2,is,ic)                       insi-069
      if (kt.eq.nat(1,k)) go to 6                                       insi-070
      do 5 is=k3,ism                                                    insi-071
      w(1,is)=w(1,is)-at(2,k)*vi(is,kt)*p(2,is,ic)                      insi-072
    5 w(2,is)=w(2,is)+at(2,k)*vi(is,kt)*p(1,is,ic)                      insi-073
    6 continue                                                          insi-074
      go to 13                                                          insi-075
c coupling potentials already calculated                                insi-076
    7 l1=nvi(ic,i,1)                                                    insi-077
      l2=nvi(ic,i,2)                                                    insi-078
      k3=ipd(ic)                                                        insi-079
      idp=min0(idp,k3)                                                  insi-080
      if (l1.eq.0) go to 11                                             insi-081
      if (l2.gt.0) go to 9                                              insi-082
      do 8 is=k3,ism                                                    insi-083
      w(1,is)=w(1,is)+www(is,l1)*p(1,is,ic)                             insi-084
    8 w(2,is)=w(2,is)+www(is,l1)*p(2,is,ic)                             insi-085
      go to 13                                                          insi-086
    9 do 10 is=k3,ism                                                   insi-087
      w(1,is)=w(1,is)+www(is,l1)*p(1,is,ic)-www(is,l2)*p(2,is,ic)       insi-088
   10 w(2,is)=w(2,is)+www(is,l1)*p(2,is,ic)+www(is,l2)*p(1,is,ic)       insi-089
      go to 13                                                          insi-090
   11 if (l2.eq.0) go to 13                                             insi-091
      do 12 is=k3,ism                                                   insi-092
      w(1,is)=w(1,is)-www(is,l2)*p(2,is,ic)                             insi-093
   12 w(2,is)=w(2,is)+www(is,l2)*p(1,is,ic)                             insi-094
   13 if (.not.lo(210)) go to 23                                        insi-095
c derivative term of coupling potentials                                insi-096
      if (lo(207)) go to 17                                             insi-097
c no previous calculation of coupling potentials                        insi-098
      k1=k2+1                                                           insi-099
      k2=nvi(ic,i,3)                                                    insi-100
      if (k1.gt.k2) go to 23                                            insi-101
      do 16 k=k1,k2                                                     insi-102
      kt=iabs(nat(1,k))                                                 insi-103
      do 14 is=k3,ism                                                   insi-104
      w(1,is)=w(1,is)+at(2,k)*v(is,kt)*pd(1,is,ic)                      insi-105
   14 w(2,is)=w(2,is)+at(2,k)*v(is,kt)*pd(2,is,ic)                      insi-106
      if (kt.eq.nat(1,k)) go to 16                                      insi-107
      do 15 is=k3,ism                                                   insi-108
      w(1,is)=w(1,is)-at(2,k)*vi(is,kt)*pd(2,is,ic)                     insi-109
   15 w(2,is)=w(2,is)+at(2,k)*vi(is,kt)*pd(1,is,ic)                     insi-110
   16 continue                                                          insi-111
      go to 23                                                          insi-112
c coupling potentials already calculated                                insi-113
   17 l1=nvi(ic,i,3)                                                    insi-114
      l2=nvi(ic,i,4)                                                    insi-115
      if (l1.le.0) go to 21                                             insi-116
      if (l2.gt.0) go to 19                                             insi-117
      do 18 is=k3,ism                                                   insi-118
      w(1,is)=w(1,is)+www(is,l1)*pd(1,is,ic)                            insi-119
   18 w(2,is)=w(2,is)+www(is,l1)*pd(2,is,ic)                            insi-120
      go to 23                                                          insi-121
   19 do 20 is=k3,ism                                                   insi-122
      w(1,is)=w(1,is)+www(is,l1)*pd(1,is,ic)-www(is,l2)*pd(2,is,ic)     insi-123
   20 w(2,is)=w(2,is)+www(is,l1)*pd(2,is,ic)+www(is,l2)*pd(1,is,ic)     insi-124
      go to 23                                                          insi-125
   21 if (l2.eq.0) go to 23                                             insi-126
      do 22 is=k3,ism                                                   insi-127
      w(1,is)=w(1,is)-www(is,l2)*pd(2,is,ic)                            insi-128
   22 w(2,is)=w(2,is)+www(is,l2)*pd(1,is,ic)                            insi-129
   23 continue                                                          insi-130
      ipd(i)=idp                                                        insi-131
c search for the first non negligible value                             insi-132
      if (idp.gt.ism) go to 38                                          insi-133
      do 24 is=idp,ism                                                  insi-134
      if ((dabs(w(1,is))+dabs(w(2,is))).gt.conv) go to 25               insi-135
   24 continue                                                          insi-136
   25 ipd(i)=is                                                         insi-137
      kt=max0(ipd(i),1)                                                 insi-138
      if (ipd(i).ge.ism) go to 38                                       insi-139
      if (lo(144)) go to 26                                             insi-140
      w(1,ism)=0.d0                                                     insi-141
      w(2,ism)=0.d0                                                     insi-142
c integral of the regular function with the second member               insi-143
   26 x(1,kt)=-ph(kt,2,i)*w(2,kt)+ph(kt,1,i)*w(1,kt)                    insi-144
      x(2,kt)=ph(kt,1,i)*w(2,kt)+ph(kt,2,i)*w(1,kt)                     insi-145
      kkt=kt+1                                                          insi-146
      if (kkt.gt.ism) go to 28                                          insi-147
      do 27 is=kkt,ism                                                  insi-148
      x(1,is)=x(1,is-1)+ph(is,1,i)*w(1,is)-ph(is,2,i)*w(2,is)           insi-149
   27 x(2,is)=x(2,is-1)+ph(is,1,i)*w(2,is)+ph(is,2,i)*w(1,is)           insi-150
c scattering coefficients                                               insi-151
   28 bre=x(1,ism)/(h*fam(1))-z(1)                                      insi-152
      bim=x(2,ism)/(h*fam(1))-z(2)                                      insi-153
      if (lo(92)) go to 34                                              insi-154
      hx=z(3)*h                                                         insi-155
      hy=z(4)*h                                                         insi-156
      ist=ism+kt                                                        insi-157
c integral of the irregular function with the second member in hx/hy    insi-158
c and computation of the solution with the correction term w/12         insi-159
      do 29 is=kt,ism                                                   insi-160
      js=ist-is                                                         insi-161
      p(1,js,i)=(x(1,js)*ph(js,3,i)-x(2,js)*ph(js,4,i)-hx*ph(js,1,i)+hy*insi-162
     1ph(js,2,i))/h-w(1,js)/12.d0                                       insi-163
      p(2,js,i)=(x(1,js)*ph(js,4,i)+x(2,js)*ph(js,3,i)-hy*ph(js,1,i)-hx*insi-164
     1ph(js,2,i))/h-w(2,js)/12.d0                                       insi-165
      hx=hx-ph(js,3,i)*w(1,js)+ph(js,4,i)*w(2,js)                       insi-166
   29 hy=hy-ph(js,3,i)*w(2,js)-ph(js,4,i)*w(1,js)                       insi-167
      if (kt.eq.1) go to 31                                             insi-168
      k=kt-1                                                            insi-169
      do 30 is=1,k                                                      insi-170
      p(1,is,i)=-(hx*ph(is,1,i)-hy*ph(is,2,i))/h                        insi-171
   30 p(2,is,i)=-(hy*ph(is,1,i)+hx*ph(is,2,i))/h                        insi-172
   31 do 32 kt=1,ism                                                    insi-173
      if ((dabs(p(1,kt,i))+dabs(p(2,kt,i))).gt.aconv) go to 33          insi-174
   32 continue                                                          insi-175
   33 ipd(i)=kt                                                         insi-176
      if (lo(22)) go to 34                                              insi-177
      pad1(1,kiter)=bre                                                 insi-178
      pad1(2,kiter)=bim                                                 insi-179
c  test of convergence                                                  insi-180
   34 lo(205)=(dabs(bim-fai(1)).le.eiter.and.(dabs(bre-far(1)).le.eiter)insi-181
     1)                                                                 insi-182
      if (lo(122).and.lo(204).and.kiter.gt.3.and.(.not.lo(205))) call painsi-183
     1de(pad1,pad2,kiter,bre,bim,eiter,1.d0,0.d0,lo)                    insi-184
      lo(204)=lo(204).and.lo(205)                                       insi-185
      far(1)=bre                                                        insi-186
      fai(1)=bim                                                        insi-187
      if (lo(57)) write (mw,1000) i,far(1),fai(1),kiter,kt              insi-188
      if (.not.lo(210).or.lo(92)) return                                insi-189
c computation of r*(d/dr) of the solutions                              insi-190
   35 ist=ism-3                                                         insi-191
      do 37 j=1,2                                                       insi-192
      pd(j,1,i)=2.5d0*p(j,2,i)-.25d0*p(j,5,i)+(5.d0*p(j,4,i)-7.7d0*p(j,1insi-193
     1,i)-10.d0*p(j,3,i)+.2d0*p(j,6,i))/6.d0                            insi-194
      pd(j,2,i)=-.8d0*p(j,1,i)-p(j,4,i)+(8.d0*p(j,3,i)-3.5d0*p(j,2,i)+.8insi-195
     1d0*p(j,5,i)-.1d0*p(j,6,i))/3.d0                                   insi-196
      pd(j,3,i)=2.25d0*(p(j,4,i)-p(j,2,i))-.45d0*(p(j,5,i)-p(j,1,i))+.05insi-197
     1d0*p(j,6,i)                                                       insi-198
      fp=3.d0                                                           insi-199
      do 36 is=4,ist                                                    insi-200
      fp=fp+1.d0                                                        insi-201
   36 pd(j,is,i)=fp*(.75d0*(p(j,is+1,i)-p(j,is-1,i))-.15d0*(p(j,is+2,i)-insi-202
     1p(j,is-2,i))+(p(j,is+3,i)-p(j,is-3,i))/60.d0)                     insi-203
      fp=fp+1.d0                                                        insi-204
      pd(j,ism-2,i)=fp*(p(j,ism-6,i)-8.d0*p(j,ism-5,i)+30.d0*p(j,ism-4,iinsi-205
     1)-80.d0*p(j,ist,i)+35.d0*p(j,ism-2,i)+24.d0*p(j,ism-1,i)-2.d0*p(j,insi-206
     2ism,i))/60.d0                                                     insi-207
      fp=fp+1.d0                                                        insi-208
      pd(j,ism-1,i)=fp*(15.d0*p(j,ism-5,i)-2.d0*p(j,ism-6,i)-50.d0*p(j,iinsi-209
     1sm-4,i)+100.d0*p(j,ist,i)-150.d0*p(j,ism-2,i)+77.d0*p(j,ism-1,i)+1insi-210
     20.d0*p(j,ism,i))/60.d0                                            insi-211
      fp=fp+1.d0                                                        insi-212
      pd(j,ism,i)=fp*(10.d0*p(j,ism-6,i)-72.d0*p(j,ism-5,i)+225.d0*p(j,iinsi-213
     1sm-4,i)-400.d0*p(j,ist,i)+450.d0*p(j,ism-2,i)-360.d0*p(j,ism-1,i)+insi-214
     2147.d0*p(j,ism,i))/60.d0                                          insi-215
   37 continue                                                          insi-216
      return                                                            insi-217
   38 if (lo(22)) return                                                insi-218
      pad1(1,kiter)=0.d0                                                insi-219
      pad1(2,kiter)=0.d0                                                insi-220
      return                                                            insi-221
 1000 format (5x,i5,2d30.15,i10,10x,i5)                                 insi-222
      end                                                               insi-223
c 29/02/04                                                      ecis03  intr-000
      subroutine intr(fam,x,fr,gr,wre,pad,ipe,ism,kab,w,iterm,nc,v,vr,nvintr-001
     1i,mc,nat,at,ag,h,aconv,eiter,ncin,nni,iterr,lo)                   intr-002
c  e. c. i. s. method: dirac equation driving routine.                  intr-003
c             inrh  to solve the single homogeneous equations           intr-004
c             inri  to solve the single inhomogeneous equations         intr-005
c  pade approximants of type i may be used to accelerate the convergenceintr-006
c input variables: fam(ic,i): matching values for i=1,6                 intr-007
c                             constants of each equation for i=7,10     intr-008
c                  ism:   number of radial points                       intr-009
c                  kab:   maximum number of coupled channels            intr-010
c                  iterm: maximum number of iterations and dim. of pad  intr-011
c                  nc:    number of coupled equations                   intr-012
c                  v,vr:  potentials                                    intr-013
c                  nvi:   addresses of couplings                        intr-014
c                  mc:    nuclear state number, angular momenta....     intr-015
c                  nat,at:table of coupling coefficients                intr-016
c                  ag:    coulomb integrals for coulomb corrections     intr-017
c                  h:     step length                                   intr-018
c                  aconv: epsilon for negligible function values        intr-019
c                  eiter: convergence epsilon for the scattering coef.  intr-020
c                  ncin:  number of solutions                           intr-021
c                  lo(i): logical controls                              intr-022
c output variables:fam(ic,i+7): scattering coefficients                 intr-023
c working fields:  x:     used in inrh and inri                         intr-024
c                  fr:    solutions of homogeneous equations            intr-025
c                  gr:    solutions of coupled equations                intr-026
c                  wre:   real/imaginary inhomogeneous term             intr-027
c                  pad(iterm,kab+2): pade approximants                  intr-028
c               ipe(i,1): first non negligible point of uncoupled func. intr-029
c               ipe(i,2): first non negligible point of coupled funct.  intr-030
c                  w:     free part of the storage for couplings        intr-031
c output variables:nni:   number of eq. with negligible inhomog. term   intr-032
c                  iterr: largest number of iterations done for this j  intr-033
c***********************************************************************intr-034
      implicit real*8 (a-h,o-z)                                         intr-035
      logical lo(250)                                                   intr-036
      dimension ipe(nc,2),nvi(kab,kab,4),fam(kab,8),x(1),nat(6,1),pad(2,intr-037
     1iterm,1),ag(kab,kab,4),y(2),mc(kab,6),z(4),fr(ism,8,1),gr(ism,4,1)intr-038
     2,wre(ism,1),w(ism,4,1),at(3,1),v(ism,14,1),vr(ism,4,1)            intr-039
      common /inout/ mr,mw,ms                                           intr-040
      conv=aconv*h*h                                                    intr-041
      nni=0                                                             intr-042
      i2=8*ism                                                          intr-043
c compute all coupling potentials and solve all homogeneous equations   intr-044
      do 4 i=1,nc                                                       intr-045
      i1=mc(i,4)                                                        intr-046
      if (i1.lt.0) go to 1                                              intr-047
      call inrh(fr(1,1,i),i,k,aconv,fam,x,kab,ism,lo,dfloat(mc(i,6)+1),hintr-048
     1,v(1,1,i1),lo(221))                                               intr-049
      ipe(i,1)=k                                                        intr-050
      go to 3                                                           intr-051
    1 i1=-i1                                                            intr-052
      if (i1.eq.i) go to 3                                              intr-053
      do 2 is=1,i2                                                      intr-054
    2 fr(is,1,i)=fr(is,1,i1)                                            intr-055
      ipe(i,1)=ipe(i1,1)                                                intr-056
    3 if (lo(57)) write (mw,1000) fam(i,7),fam(i,8),i,ipe(i,1)          intr-057
    4 continue                                                          intr-058
      i2=2*ism                                                          intr-059
      if (.not.lo(207).or.lo(221)) go to 15                             intr-060
      iw=0                                                              intr-061
c calculation of the non diagonal coupling potentials                   intr-062
      do 14 ic=1,nc                                                     intr-063
      do 13 ip=1,ic                                                     intr-064
      k1=nvi(ip,ic,1)                                                   intr-065
      k2=nvi(ip,ic,2)                                                   intr-066
      k3=nvi(ip,ic,3)                                                   intr-067
      nvi(ip,ic,3)=0                                                    intr-068
      nvi(ip,ic,4)=0                                                    intr-069
      if (k1.gt.k2) go to 8                                             intr-070
      iw=iw+1                                                           intr-071
      nvi(ip,ic,3)=iw                                                   intr-072
      k=nat(1,k1)                                                       intr-073
      do 5 is=1,i2                                                      intr-074
      w(is,1,iw)=at(2,k1)*vr(is,1,k)                                    intr-075
    5 w(is,3,iw)=at(3,k1)*vr(is,3,k)                                    intr-076
      k4=k1+1                                                           intr-077
      if (k4.gt.k2) go to 8                                             intr-078
      do 7 k1=k4,k2                                                     intr-079
      k=nat(1,k1)                                                       intr-080
      do 6 is=1,i2                                                      intr-081
      w(is,1,iw)=w(is,1,iw)+at(2,k1)*vr(is,1,k)                         intr-082
    6 w(is,3,iw)=w(is,3,iw)+at(3,k1)*vr(is,3,k)                         intr-083
    7 continue                                                          intr-084
    8 if (k2.ge.k3) go to 12                                            intr-085
      iw=iw+1                                                           intr-086
      nvi(ip,ic,4)=iw                                                   intr-087
      k1=k2+1                                                           intr-088
      k=nat(1,k1)                                                       intr-089
      do 9 is=1,i2                                                      intr-090
      w(is,1,iw)=at(2,k1)*vr(is,1,k)+at(3,k1)*vr(is,3,k)                intr-091
    9 w(is,3,iw)=at(2,k1)*vr(is,1,k)-at(3,k1)*vr(is,3,k)                intr-092
      k4=k1+1                                                           intr-093
      if (k4.gt.k3) go to 12                                            intr-094
      do 11 k1=k4,k3                                                    intr-095
      k=nat(1,k1)                                                       intr-096
      do 10 is=1,i2                                                     intr-097
      w(is,1,iw)=w(is,1,iw)+at(2,k1)*vr(is,1,k)+at(3,k1)*vr(is,3,k)     intr-098
   10 w(is,3,iw)=w(is,3,iw)+at(2,k1)*vr(is,1,k)-at(3,k1)*vr(is,3,k)     intr-099
   11 continue                                                          intr-100
   12 nvi(ic,ip,3)=nvi(ip,ic,3)                                         intr-101
      nvi(ic,ip,4)=nvi(ip,ic,4)                                         intr-102
      if (iw.gt.iw) iw=iw                                               intr-103
   13 continue                                                          intr-104
   14 continue                                                          intr-105
   15 if (lo(74)) call hora                                             intr-106
c loop on solutions                                                     intr-107
      do 29 nci=1,ncin                                                  intr-108
      nci1=nci+8                                                        intr-109
      nci2=nci1+ncin                                                    intr-110
c set the zero's order solution                                         intr-111
      do 16 ic=1,nc                                                     intr-112
      ipe(ic,2)=ism+1                                                   intr-113
      fam(ic,nci1)=0.d0                                                 intr-114
   16 fam(ic,nci2)=0.d0                                                 intr-115
      fam(nci,nci1)=fam(nci,7)                                          intr-116
      fam(nci,nci2)=fam(nci,8)                                          intr-117
      if ((ipe(nci,1).gt.ism-3).or.lo(221)) go to 29                    intr-118
      do 17 is=1,i2                                                     intr-119
      gr(is,1,nci)=fr(is,1,nci)                                         intr-120
   17 gr(is,3,nci)=fr(is,5,nci)                                         intr-121
      ipe(nci,2)=ipe(nci,1)                                             intr-122
      amax=0.d0                                                         intr-123
c e. c. i. s. loop                                                      intr-124
      do 27 kiter=1,iterm                                               intr-125
      iterr=max0(iterr,kiter)                                           intr-126
      lo(204)=.true.                                                    intr-127
      lo(206)=((kiter.ne.iterm).and.(amax.lt.1.d10)).or.lo(23)          intr-128
      if (amax.gt.1.d10) write (mw,1001) amax,kiter                     intr-129
      do 26 ic=1,nc                                                     intr-130
      i=mod(ic+nci-1,nc)+1                                              intr-131
      i1=mc(i,1)                                                        intr-132
      do 18 j=1,4                                                       intr-133
   18 z(j)=0.d0                                                         intr-134
      if (lo(144)) go to 23                                             intr-135
      do 21 j=1,nc                                                      intr-136
      if (ipe(j,2).ge.ism) go to 21                                     intr-137
c order in fg   f(ei)*f(ef),g(ei)*f(ef),f(ei)*g(ef),g(ei)*g(ef)         intr-138
      if (lo(22)) go to 19                                              intr-139
      ij=kiter                                                          intr-140
      if (1+mod(j+nc-nci-1,nc).ge.ic) ij=ij-1                           intr-141
      if (ij.eq.0) go to 19                                             intr-142
      y(1)=pad(1,ij,j)                                                  intr-143
      y(2)=pad(2,ij,j)                                                  intr-144
      go to 20                                                          intr-145
   19 y(1)=fam(j,nci1)                                                  intr-146
      y(2)=fam(j,nci2)                                                  intr-147
   20 z(1)=z(1)+y(1)*ag(i,j,3)-y(2)*ag(i,j,1)                           intr-148
      z(2)=z(2)+y(1)*ag(i,j,1)+y(2)*ag(i,j,3)                           intr-149
      z(3)=z(3)+y(1)*ag(i,j,4)-y(2)*ag(i,j,2)                           intr-150
      z(4)=z(4)+y(1)*ag(i,j,2)+y(2)*ag(i,j,4)                           intr-151
   21 continue                                                          intr-152
      if (i.eq.nci) go to 22                                            intr-153
      z(1)=z(1)+ag(i,nci,1)                                             intr-154
      z(3)=z(3)+ag(i,nci,2)                                             intr-155
   22 z(3)=z(3)-z(2)                                                    intr-156
      z(4)=z(4)+z(1)                                                    intr-157
      z(1)=z(1)+fam(i,7)*z(3)-fam(i,8)*z(4)                             intr-158
      z(2)=z(2)+z(3)*fam(i,8)+z(4)*fam(i,7)                             intr-159
   23 if (i.ne.nci) go to 24                                            intr-160
      z(1)=z(1)-fam(i,7)                                                intr-161
      z(2)=z(2)-fam(i,8)                                                intr-162
      z(3)=z(3)-1.d0                                                    intr-163
   24 if (lo(23).and.(.not.lo(206))) lo(204)=.true.                     intr-164
c compute second members and solve the inhomogeneous equations          intr-165
      call inri(wre,fr(1,1,i),gr,w,nvi,fam(i,5),x,pad(1,1,i),pad(1,1,nc+intr-166
     11),kiter,eiter,conv,aconv,kab,nc,ism,ipe(1,2),i,nat,at,vr,fam(i,ncintr-167
     2i1),fam(i,nci2),dfloat(mc(i,6)+1),v(1,1,i1),lo,h,z)               intr-168
      if (ipe(i,2).ge.ism) go to 25                                     intr-169
      if (i.ne.nci.and.lo(92)) ipe(i,2)=ism+1                           intr-170
      amax=dmax1(amax,dabs(fam(i,nci1))+dabs(fam(i,nci2)))              intr-171
      go to 26                                                          intr-172
   25 fam(i,nci1)=-z(1)                                                 intr-173
      fam(i,nci2)=-z(2)                                                 intr-174
      if (lo(57)) write (mw,1002)                                       intr-175
      if (kiter.eq.1.and.lo(144)) nni=nni+1                             intr-176
      if (i.eq.nci) ipe(nci,2)=ipe(nci,1)                               intr-177
   26 continue                                                          intr-178
      if (lo(74)) call hora                                             intr-179
      if (lo(204).or.(amax.gt.1.d10.and.lo(23))) go to 28               intr-180
   27 continue                                                          intr-181
      kiter=min0(kiter,iterm)                                           intr-182
   28 if (lo(53)) write (mw,1003) kiter                                 intr-183
   29 continue                                                          intr-184
      nni=nni/ncin                                                      intr-185
      return                                                            intr-186
 1000 format (2d30.15,5x,2i5)                                           intr-187
 1001 format (' maximum',d15.6,' obtained in previous iteration. last onintr-188
     1e is',i3)                                                         intr-189
 1002 format (5x,'the inhomogeneous term is neglected')                 intr-190
 1003 format (5x,i5,' iterations')                                      intr-191
      end                                                               intr-192
c 29/02/04                                                      ecis03  inrh-000
      subroutine inrh(p,ic,kt,aconv,fam,x,nc,ism,lo,cc,h,vv,lt)         inrh-001
c  e. c. i. s. method: integration of a single homogeneous equation by  inrh-002
c  the numerov method   - dirac equation -                              inrh-003
c input variables: ic:    channel number of the equation                inrh-004
c                  aconv: limit for negligible function values          inrh-005
c                  fam(ic,i): matching values for i=1,4                 inrh-006
c                             constants of the equation for i=6,10      inrh-007
c                  nc:    number of coupled channels                    inrh-008
c                  ism:   number of radial points                       inrh-009
c                  lo(i): logical controls                              inrh-010
c                  cc:    eigenvalue of l.s+1                           inrh-011
c                  h:     step size                                     inrh-012
c                  vv:    potentials, d(r), ....                        inrh-013
c                  lt:    logical to return only with phase shift       inrh-014
c output variables:p(ism,i): regular solution for i=1,2 and 5,6         inrh-015
c                            irregular solution for i=3,4 and 7,8       inrh-016
c                            large components for i=1,4                 inrh-017
c                            small component for i=5,8                  inrh-018
c                  fam(ic,7/8): real/imaginary part of zero's order     inrh-019
c                         scattering coefficients                       inrh-020
c                  kt: the solution is negligible for is < kt           inrh-021
c working space:   x:    for the integration                            inrh-022
c***********************************************************************inrh-023
      implicit real*8 (a-h,o-z)                                         inrh-024
      logical lo(250),lt                                                inrh-025
      dimension fam(nc,10),x(2,2),p(ism,8),vv(ism,14)                   inrh-026
c computation of the regular solution                                   inrh-027
      do 1 is=1,ism                                                     inrh-028
      a=is*is                                                           inrh-029
      x(1,is+2)=fam(ic,10)/a-fam(ic,9)-fam(ic,7)*vv(is,1)-fam(ic,8)*vv(iinrh-030
     1s,3)                                                              inrh-031
    1 x(2,is+2)=-fam(ic,7)*vv(is,2)-fam(ic,8)*vv(is,4)                  inrh-032
      if (lo(27)) go to 3                                               inrh-033
c modified numerov method                                               inrh-034
      do 2 is=1,ism                                                     inrh-035
      a=x(1,is+2)**2-x(2,is+2)**2                                       inrh-036
      if (lo(26)) a=a*(1.d0+x(1,is+2)*.033333333333333d0)               inrh-037
      x(2,is+2)=x(2,is+2)*(1.d0+x(1,is+2)*.166666666666667d0)           inrh-038
    2 x(1,is+2)=x(1,is+2)+a*.083333333333333d0                          inrh-039
      go to 5                                                           inrh-040
c numerov method                                                        inrh-041
    3 do 4 is=1,ism                                                     inrh-042
      b=(12.d0-x(1,is+2))**2+x(2,is+2)**2                               inrh-043
      a=12.d0*(x(1,is+2)*(12.d0-x(1,is+2))-x(2,is+2)**2)/b              inrh-044
      if (lo(26)) a=a*(1.d0-x(1,is+2)**2*.416666666666667d-2)           inrh-045
      x(1,is+2)=a                                                       inrh-046
    4 x(2,is+2)=144.d0*x(2,is+2)/b                                      inrh-047
    5 x(1,1)=0.d0                                                       inrh-048
      x(2,1)=0.d0                                                       inrh-049
      x(1,2)=1.d-15                                                     inrh-050
      x(2,2)=0.d0                                                       inrh-051
      do 7 is=1,ism                                                     inrh-052
      p(is,3)=x(1,is+2)                                                 inrh-053
      p(is,4)=x(2,is+2)                                                 inrh-054
      hx=x(1,is+1)*x(1,is+2)-x(2,is+1)*x(2,is+2)                        inrh-055
      hy=x(2,is+1)*x(1,is+2)+x(1,is+1)*x(2,is+2)                        inrh-056
      x(1,is+2)=x(1,is+1)+x(1,is+1)-x(1,is)+hx                          inrh-057
      x(2,is+2)=x(2,is+1)+x(2,is+1)-x(2,is)+hy                          inrh-058
      if (dabs(x(1,is+2)).lt.1.d15) go to 7                             inrh-059
c renormalisation of large function values                              inrh-060
      j=2*is+4                                                          inrh-061
      do 6 i=3,j                                                        inrh-062
    6 x(i,1)=x(i,1)*1.d-30                                              inrh-063
    7 continue                                                          inrh-064
c end of integration                                                    inrh-065
c matching with two values                                              inrh-066
      bre=x(1,ism)*fam(ic,4)-fam(ic,3)*x(1,ism+2)                       inrh-067
      bim=x(2,ism)*fam(ic,4)-fam(ic,3)*x(2,ism+2)                       inrh-068
      hx=x(1,ism)*fam(ic,2)-fam(ic,1)*x(1,ism+2)                        inrh-069
      hy=x(2,ism)*fam(ic,2)-fam(ic,1)*x(2,ism+2)                        inrh-070
      bim=bim+hx                                                        inrh-071
      bre=bre-hy                                                        inrh-072
      brr=bre*bre+bim*bim                                               inrh-073
      bre=-bre/brr                                                      inrh-074
      bim=bim/brr                                                       inrh-075
      fam(ic,7)=bre*hx-bim*hy                                           inrh-076
      fam(ic,8)=hx*bim+hy*bre                                           inrh-077
      if (lt) return                                                    inrh-078
      bre=bre/12.d0                                                     inrh-079
      bim=bim/12.d0                                                     inrh-080
c normalisation of the regular solution                                 inrh-081
c and search of the first non negligible value                          inrh-082
      do 8 is=1,ism                                                     inrh-083
      brr=x(1,is)+10.d0*x(1,is+1)+x(1,is+2)                             inrh-084
      hy=x(2,is)+10.d0*x(2,is+1)+x(2,is+2)                              inrh-085
      hx=brr*bre-hy*bim                                                 inrh-086
      hy=hy*bre+brr*bim                                                 inrh-087
      p(is,1)=hx*vv(is,9)-hy*vv(is,10)                                  inrh-088
    8 p(is,2)=hx*vv(is,10)+hy*vv(is,9)                                  inrh-089
      do 9 kt=1,ism                                                     inrh-090
      if ((abs(p(kt,1))+abs(p(kt,2))).gt.aconv) go to 10                inrh-091
    9 continue                                                          inrh-092
   10 hx=fam(ic,1)                                                      inrh-093
      hy=fam(ic,2)                                                      inrh-094
c computation of the irregular solution - starting values               inrh-095
c the last point of imaginary potential is neglected                    inrh-096
      x(2,ism)=hx/fam(ic,6)                                             inrh-097
      x(2,ism+2)=hy/fam(ic,6)                                           inrh-098
      x(1,ism)=fam(ic,3)/fam(ic,6)                                      inrh-099
      x(1,ism+2)=fam(ic,4)/fam(ic,6)                                    inrh-100
      bre=2.d0+p(ism,3)                                                 inrh-101
      x(1,ism+1)=(x(1,ism)+x(1,ism+2))/bre                              inrh-102
      x(2,ism+1)=(x(2,ism)+x(2,ism+2))/bre                              inrh-103
      kr=min0(kt,ism-6)                                                 inrh-104
      i1=ism-kr                                                         inrh-105
c integration                                                           inrh-106
      do 11 js=1,i1                                                     inrh-107
      is=ism-js                                                         inrh-108
      hx=x(1,is+1)*p(is,3)-x(2,is+1)*p(is,4)                            inrh-109
      hy=x(2,is+1)*p(is,3)+x(1,is+1)*p(is,4)                            inrh-110
      x(1,is)=x(1,is+1)+x(1,is+1)-x(1,is+2)+hx                          inrh-111
   11 x(2,is)=x(2,is+1)+x(2,is+1)-x(2,is+2)+hy                          inrh-112
c computation of irregular solution                                     inrh-113
      do 12 is=kr,ism                                                   inrh-114
      bre=(x(1,is)+10.d0*x(1,is+1)+x(1,is+2))/12.d0                     inrh-115
      bim=(x(2,is)+10.d0*x(2,is+1)+x(2,is+2))/12.d0                     inrh-116
      p(is,3)=bre*vv(is,9)-bim*vv(is,10)                                inrh-117
   12 p(is,4)=bre*vv(is,10)+bim*vv(is,9)                                inrh-118
      ism3=ism-3                                                        inrh-119
      hh=h*60.d0                                                        inrh-120
      do 22 l=1,4                                                       inrh-121
      do 21 is=kt,ism                                                   inrh-122
      if (is-kr.gt.2) go to 16                                          inrh-123
      if (is-kr-1)  13 , 14 , 15                                        inrh-124
   13 p(is,l+4)=(-147.d0*p(is,l)+360.d0*p(is+1,l)-450.d0*p(is+2,l)+400.dinrh-125
     10*p(is+3,l)-225.d0*p(is+4,l)+72.d0*p(is+5,l)-10.d0*p(is+6,l))/hh  inrh-126
      go to 21                                                          inrh-127
   14 p(is,l+4)=(-10.d0*p(kr,l)-77.d0*p(is,l)+150.d0*p(is+1,l)-100.d0*p(inrh-128
     1is+2,l)+50.d0*p(is+3,l)-15.d0*p(is+4,l)+2.d0*p(is+5,l))/hh        inrh-129
      go to 21                                                          inrh-130
   15 p(is,l+4)=(2.d0*p(kr,l)-24.d0*p(is-1,l)-35.d0*p(is,l)+80.d0*p(is+1inrh-131
     1,l)-30.d0*p(is+2,l)+8.d0*p(is+3,l)-p(is+4,l))/hh                  inrh-132
      go to 21                                                          inrh-133
   16 if (is.gt.ism3) go to 17                                          inrh-134
      p(is,l+4)=(45.d0*(p(is+1,l)-p(is-1,l))-9.d0*(p(is+2,l)-p(is-2,l))+inrh-135
     1p(is+3,l)-p(is-3,l))/hh                                           inrh-136
      go to 21                                                          inrh-137
   17 if (is-ism+1) 18 , 19 , 20                                        inrh-138
   18 p(ism-2,l+4)=(p(ism-6,l)-8.d0*p(ism-5,l)+30.d0*p(ism-4,l)-80.d0*p(inrh-139
     1ism3,l)+35.d0*p(ism-2,l)+24.d0*p(ism-1,l)-2.d0*p(ism,l))/hh       inrh-140
      go to 21                                                          inrh-141
   19 p(ism-1,l+4)=(-2.d0*p(ism-6,l)+15.d0*p(ism-5,l)-50.d0*p(ism-4,l)+1inrh-142
     100.d0*p(ism3,l)-150.d0*p(ism-2,l)+77.d0*p(ism-1,l)+10.d0*p(ism,l))inrh-143
     2/hh                                                               inrh-144
      go to 21                                                          inrh-145
   20 p(ism,l+4)=(10.d0*p(ism-6,l)-72.d0*p(ism-5,l)+225.d0*p(ism-4,l)-40inrh-146
     10.d0*p(ism3,l)+450.d0*p(ism-2,l)-360.d0*p(ism-1,l)+147.d0*p(ism,l)inrh-147
     2)/hh                                                              inrh-148
   21 continue                                                          inrh-149
   22 continue                                                          inrh-150
      r=h*dfloat(kt-1)                                                  inrh-151
      do 23 is=kt,ism                                                   inrh-152
      r=r+h                                                             inrh-153
      br=p(is,1)*(cc/r+vv(is,13))-p(is,5)-p(is,2)*vv(is,14)             inrh-154
      bi=p(is,2)*(cc/r+vv(is,13))-p(is,6)+p(is,1)*vv(is,14)             inrh-155
      cr=p(is,3)*(cc/r+vv(is,13))-p(is,7)-p(is,4)*vv(is,14)             inrh-156
      ci=p(is,4)*(cc/r+vv(is,13))-p(is,8)+p(is,3)*vv(is,14)             inrh-157
      p(is,5)=br*vv(is,11)-bi*vv(is,12)                                 inrh-158
      p(is,6)=bi*vv(is,11)+br*vv(is,12)                                 inrh-159
      p(is,7)=cr*vv(is,11)-ci*vv(is,12)                                 inrh-160
   23 p(is,8)=ci*vv(is,11)+cr*vv(is,12)                                 inrh-161
      if (kt.eq.1) return                                               inrh-162
      kr=kt-1                                                           inrh-163
      do 25 is=1,kr                                                     inrh-164
      do 24 l=1,8                                                       inrh-165
   24 p(is,l)=0.d0                                                      inrh-166
   25 continue                                                          inrh-167
      return                                                            inrh-168
      end                                                               inrh-169
c 29/02/04                                                      ecis03  inri-000
      subroutine inri(w,p,q,ww,nvi,fam,x,pad1,pad2,kiter,eiter,conv,aconinri-001
     1v,kab,nc,ism,ipi,j,nat,at,vr,far,fai,cc,v,lo,h,z)                 inri-002
c  e. c. i. s. method: integration of a single inhomogeneous equation   inri-003
c  by the numerov method      - dirac equation -                        inri-004
c input variables: p:     uncoupled solutions                           inri-005
c                  q:     coupled solution                              inri-006
c                  ww:    coupling between equations                    inri-007
c                  nvi:   table of addresses of couplings               inri-008
c                  fam:   wave number                                   inri-009
c                  kiter: current iteration number                      inri-010
c                  eiter: convergence epsilon for the scattering coeff. inri-011
c                  conv:  epsilon for negligible second members         inri-012
c                  aconv: epsilon for negligible function values        inri-013
c                  kab:   dimension of table nvi                        inri-014
c                  nc:    number of coupled channels                    inri-015
c                  ism:   number of radial points                       inri-016
c                  ipi:   the function is negligible for r < ipi*h      inri-017
c                  j:     channel number of the equation                inri-018
c                  nat,at:coefficients and addresses of couplings       inri-019
c                  vr:    coupling potentials                           inri-020
c                  cc:    eigenvalue of l.s + 1                         inri-021
c                  v:     d(r) and tensor potentials for h**4 correctioninri-022
c                  lo(i): logical controls                              inri-023
c                  h:     integration step                              inri-024
c                  z:     coulomb integral for corrections              inri-025
c output variables:far,fai: real and imaginary part of scat. coeff.     inri-026
c working field:   w(ism,4):second members                              inri-027
c                  x:    integral of regular function with second memberinri-028
c                  pad1(2,j): iteration results for the channel j       inri-029
c                  pad2: working field of pade,twice longer than pad1   inri-030
c***********************************************************************inri-031
      implicit real*8 (a-h,o-z)                                         inri-032
      logical lo(250)                                                   inri-033
      dimension p(ism,8),w(ism,4),ipi(1),v(ism,14),q(ism,4,1),ww(ism,4,1inri-034
     1),nvi(kab,kab,4),wx(4),nat(6,1),at(3,1),vr(ism,4,1),fam(1),x(2,1),inri-035
     2pad1(2,1),pad2(1),z(4),far(1),fai(1)                              inri-036
      common /inout/ mr,mw,ms                                           inri-037
      ism1=ism+1                                                        inri-038
c put zero in the inhomogeneous terms                                   inri-039
      i2=4*ism                                                          inri-040
      do 1 is=1,i2                                                      inri-041
    1 w(is,1)=0.d0                                                      inri-042
      idp=ism1                                                          inri-043
      do 14 ic=1,nc                                                     inri-044
      if (ipi(ic).gt.ism) go to 14                                      inri-045
      k3=ipi(ic)                                                        inri-046
      idp=min0(idp,k3)                                                  inri-047
      if (lo(207)) go to 10                                             inri-048
c no previous calculation of coupling potentials                        inri-049
      l1=nvi(j,ic,1)                                                    inri-050
      l2=nvi(j,ic,2)                                                    inri-051
      l3=nvi(j,ic,3)                                                    inri-052
      if (l1.gt.l2) go to 5                                             inri-053
c scalar and vector terms of coupling potentials                        inri-054
      do 4 is=k3,ism                                                    inri-055
      do 2 i=1,4                                                        inri-056
    2 wx(i)=0.d0                                                        inri-057
      do 3 k1=l1,l2                                                     inri-058
      k=nat(1,k1)                                                       inri-059
      wx(1)=wx(1)+at(2,k1)*vr(is,1,k)                                   inri-060
      wx(2)=wx(2)+at(2,k1)*vr(is,2,k)                                   inri-061
      wx(3)=wx(3)+at(3,k1)*vr(is,3,k)                                   inri-062
    3 wx(4)=wx(4)+at(3,k1)*vr(is,4,k)                                   inri-063
      w(is,1)=w(is,1)+wx(1)*q(is,1,ic)-wx(2)*q(is,2,ic)                 inri-064
      w(is,2)=w(is,2)+wx(1)*q(is,2,ic)+wx(2)*q(is,1,ic)                 inri-065
      w(is,3)=w(is,3)+wx(3)*q(is,3,ic)-wx(4)*q(is,4,ic)                 inri-066
    4 w(is,4)=w(is,4)+wx(3)*q(is,4,ic)+wx(4)*q(is,3,ic)                 inri-067
    5 if (l2.ge.l3) go to 12                                            inri-068
c tensor terms of coupling potentials                                   inri-069
      l2=l2+1                                                           inri-070
      do 9 is=k3,ism                                                    inri-071
      do 6 i=1,4                                                        inri-072
    6 wx(i)=0.d0                                                        inri-073
      do 7 k1=l2,l3                                                     inri-074
      k=nat(1,k1)                                                       inri-075
      wx(1)=wx(1)+at(2,k1)*vr(is,1,k)                                   inri-076
      wx(2)=wx(2)+at(2,k1)*vr(is,2,k)                                   inri-077
      wx(3)=wx(3)+at(3,k1)*vr(is,3,k)                                   inri-078
    7 wx(4)=wx(4)+at(3,k1)*vr(is,4,k)                                   inri-079
      if (j.gt.ic) go to 8                                              inri-080
      wx(3)=-wx(3)                                                      inri-081
      wx(4)=-wx(4)                                                      inri-082
    8 w(is,1)=w(is,1)+(wx(1)+wx(3))*q(is,3,ic)-(wx(2)+wx(4))*q(is,4,ic) inri-083
      w(is,2)=w(is,2)+(wx(1)+wx(3))*q(is,4,ic)+(wx(2)+wx(4))*q(is,3,ic) inri-084
      w(is,3)=w(is,3)+(wx(1)-wx(3))*q(is,1,ic)-(wx(2)-wx(4))*q(is,2,ic) inri-085
    9 w(is,4)=w(is,4)+(wx(1)-wx(3))*q(is,2,ic)+(wx(2)-wx(4))*q(is,1,ic) inri-086
      go to 14                                                          inri-087
c coupling potentials computed in intr                                  inri-088
   10 k1=nvi(ic,j,3)                                                    inri-089
      if (k1.eq.0) go to 12                                             inri-090
c scalar and vector terms of coupling potentials                        inri-091
      do 11 is=k3,ism                                                   inri-092
      w(is,1)=w(is,1)+ww(is,1,k1)*q(is,1,ic)-ww(is,2,k1)*q(is,2,ic)     inri-093
      w(is,2)=w(is,2)+ww(is,1,k1)*q(is,2,ic)+ww(is,2,k1)*q(is,1,ic)     inri-094
      w(is,3)=w(is,3)+ww(is,3,k1)*q(is,3,ic)-ww(is,4,k1)*q(is,4,ic)     inri-095
   11 w(is,4)=w(is,4)+ww(is,3,k1)*q(is,4,ic)+ww(is,4,k1)*q(is,3,ic)     inri-096
   12 k1=nvi(ic,j,4)                                                    inri-097
c tensor terms of coupling potentials                                   inri-098
      if (k1.eq.0) go to 14                                             inri-099
      l1=1                                                              inri-100
      if (j.lt.ic) l1=3                                                 inri-101
      l2=4-l1                                                           inri-102
      do 13 is=k3,ism                                                   inri-103
      w(is,1)=w(is,1)+ww(is,l1,k1)*q(is,3,ic)-ww(is,l1+1,k1)*q(is,4,ic) inri-104
      w(is,2)=w(is,2)+ww(is,l1,k1)*q(is,4,ic)+ww(is,l1+1,k1)*q(is,3,ic) inri-105
      w(is,3)=w(is,3)+ww(is,l2,k1)*q(is,1,ic)-ww(is,l2+1,k1)*q(is,2,ic) inri-106
   13 w(is,4)=w(is,4)+ww(is,l2,k1)*q(is,2,ic)+ww(is,l2+1,k1)*q(is,1,ic) inri-107
   14 continue                                                          inri-108
      ipi(j)=idp                                                        inri-109
c search for the first non negligible value                             inri-110
      if (idp.gt.ism) go to 27                                          inri-111
      do 15 is=idp,ism                                                  inri-112
      if ((dabs(w(is,1))+dabs(w(is,2))+dabs(w(is,3))+dabs(w(is,4))).gt.cinri-113
     1onv) go to 16                                                     inri-114
   15 continue                                                          inri-115
   16 ipi(j)=is                                                         inri-116
      if (ipi(j).ge.ism) go to 27                                       inri-117
      kt=max0(ipi(j),1)                                                 inri-118
c integral of the regular function with the second member               inri-119
      x(1,kt)=p(kt,2)*w(kt,2)-p(kt,1)*w(kt,1)+p(kt,6)*w(kt,4)-p(kt,5)*w(inri-120
     1kt,3)                                                             inri-121
      x(2,kt)=-p(kt,1)*w(kt,2)-p(kt,2)*w(kt,1)-p(kt,5)*w(kt,4)-p(kt,6)*winri-122
     1(kt,3)                                                            inri-123
      kkt=kt+1                                                          inri-124
      if (kkt.gt.ism) go to 18                                          inri-125
      do 17 is=kkt,ism                                                  inri-126
      x(1,is)=x(1,is-1)-p(is,1)*w(is,1)+p(is,2)*w(is,2)-p(is,5)*w(is,3)+inri-127
     1p(is,6)*w(is,4)                                                   inri-128
   17 x(2,is)=x(2,is-1)-p(is,1)*w(is,2)-p(is,2)*w(is,1)-p(is,5)*w(is,4)-inri-129
     1p(is,6)*w(is,3)                                                   inri-130
c scattering coefficients                                               inri-131
   18 hx=z(3)*h                                                         inri-132
      hy=z(4)*h                                                         inri-133
      a=x(1,ism)/fam(1)-z(1)                                            inri-134
      b=x(2,ism)/fam(1)-z(2)                                            inri-135
      if (lo(92)) go to 26                                              inri-136
      ist=ism+kt                                                        inri-137
      r=h*dfloat(ism)                                                   inri-138
      do 19 is=kt,ism                                                   inri-139
      js=ist-is                                                         inri-140
      q(js,1,j)=(x(1,js)*p(js,3)-x(2,js)*p(js,4)-hx*p(js,1)+hy*p(js,2)-.inri-141
     15d0*w(js,3))/h+(v(js,5)*w(js,1)-v(js,6)*w(js,2)+w(js,3)*(cc/r+v(jsinri-142
     2,13))-w(js,4)*v(js,14))/12.d0                                     inri-143
      q(js,2,j)=(x(1,js)*p(js,4)+x(2,js)*p(js,3)-hy*p(js,1)-hx*p(js,2)-.inri-144
     15d0*w(js,4))/h+(v(js,5)*w(js,2)+v(js,6)*w(js,1)+w(js,4)*(cc/r+v(jsinri-145
     2,13))+w(js,3)*v(js,14))/12.d0                                     inri-146
      q(js,3,j)=(x(1,js)*p(js,7)-x(2,js)*p(js,8)-hx*p(js,5)+hy*p(js,6)+.inri-147
     15d0*w(js,1))/h+(v(js,7)*w(js,3)-v(js,8)*w(js,4)+w(js,1)*(cc/r+v(jsinri-148
     2,13))-w(js,2)*v(js,14))/12.d0                                     inri-149
      q(js,4,j)=(x(1,js)*p(js,8)+x(2,js)*p(js,7)-hy*p(js,5)-hx*p(js,6)+.inri-150
     15d0*w(js,2))/h+(v(js,7)*w(js,4)+v(js,8)*w(js,3)+w(js,2)*(cc/r+v(jsinri-151
     2,13))+w(js,1)*v(js,14))/12.d0                                     inri-152
      hx=hx+p(js,3)*w(js,1)-p(js,4)*w(js,2)+p(js,7)*w(js,3)-p(js,8)*w(jsinri-153
     1,4)                                                               inri-154
      hy=hy+p(js,3)*w(js,2)+p(js,4)*w(js,1)+p(js,7)*w(js,4)+p(js,8)*w(jsinri-155
     1,3)                                                               inri-156
   19 r=r-h                                                             inri-157
c corrections of order h**4                                             inri-158
      kt1=kt+3                                                          inri-159
      ism3=ism-3                                                        inri-160
      if (kt1.gt.ism3) go to 21                                         inri-161
      hz=h*720.d0                                                       inri-162
      do 20 is=kt1,ism3                                                 inri-163
      q(is,1,j)=q(is,1,j)-(45.d0*(w(is+1,3)-w(is-1,3))-9.d0*(w(is+2,3)-winri-164
     1(is-2,3))+w(is+3,3)-w(is-3,3))/hz                                 inri-165
      q(is,2,j)=q(is,2,j)-(45.d0*(w(is+1,4)-w(is-1,4))-9.d0*(w(is+2,4)-winri-166
     1(is-2,4))+w(is+3,4)-w(is-3,4))/hz                                 inri-167
      q(is,3,j)=q(is,3,j)+(45.d0*(w(is+1,1)-w(is-1,1))-9.d0*(w(is+2,1)-winri-168
     1(is-2,1))+w(is+3,1)-w(is-3,1))/hz                                 inri-169
   20 q(is,4,j)=q(is,4,j)+(45.d0*(w(is+1,2)-w(is-1,2))-9.d0*(w(is+2,2)-winri-170
     1(is-2,2))+w(is+3,2)-w(is-3,2))/hz                                 inri-171
   21 if (kt.eq.1) go to 23                                             inri-172
      k=kt-1                                                            inri-173
      do 22 is=1,k                                                      inri-174
      q(is,1,j)=-(hx*p(is,1)-hy*p(is,2))/h                              inri-175
      q(is,2,j)=-(hy*p(is,1)+hx*p(is,2))/h                              inri-176
      q(is,3,j)=-(hx*p(is,5)-hy*p(is,6))/h                              inri-177
   22 q(is,4,j)=-(hy*p(is,5)+hx*p(is,6))/h                              inri-178
   23 do 24 kt=1,ism                                                    inri-179
      if ((dabs(q(kt,1,j))+dabs(q(kt,2,j))+dabs(q(kt,3,j))+dabs(q(kt,4,jinri-180
     1))).gt.aconv) go to 25                                            inri-181
   24 continue                                                          inri-182
   25 ipi(j)=kt                                                         inri-183
      if (lo(22)) go to 26                                              inri-184
      pad1(1,kiter)=a                                                   inri-185
      pad1(2,kiter)=b                                                   inri-186
c  test of convergence                                                  inri-187
   26 lo(205)=(dabs(b-fai(1)).le.eiter.and.(dabs(a-far(1)).le.eiter))   inri-188
      if (lo(122).and.lo(204).and.kiter.gt.3.and.(.not.lo(205))) call painri-189
     1de(pad1,pad2,kiter,a,b,eiter,1.d0,0.d0,lo)                        inri-190
      lo(204)=lo(204).and.lo(205)                                       inri-191
      far(1)=a                                                          inri-192
      fai(1)=b                                                          inri-193
      if (lo(57)) write (mw,1000) j,far(1),fai(1),kiter,kt              inri-194
      return                                                            inri-195
   27 if (lo(22)) return                                                inri-196
      pad1(1,kiter)=0.d0                                                inri-197
      pad1(2,kiter)=0.d0                                                inri-198
      return                                                            inri-199
 1000 format (5x,i5,2d30.15,i10,10x,i5)                                 inri-200
      end                                                               inri-201
c 29/02/04                                                      ecis03  pade-000
      subroutine pade(r,p,mm,bre,bim,eiter,valr,vali,lo)                pade-001
c  pade approximant of type i, continued fraction                       pade-002
c input variables: r: partial taylor sums                               pade-003
c                  mm: number of components of p                        pade-004
c                  eiter: convergence criterion                         pade-005
c                  val: variable   here taken as (1.d0,0.d0)            pade-006
c                  lo: logical controls                                 pade-007
c output variables: bre,bim if convergence is obtained                  pade-008
c working field: p: at least twice as long as r                         pade-009
c***********************************************************************pade-010
      implicit real*8 (a-h,o-z)                                         pade-011
      dimension r(2,mm),p(2,2,mm)                                       pade-012
      logical lo(250)                                                   pade-013
      common /inout/ mr,mw,ms                                           pade-014
      lo(205)=.true.                                                    pade-015
      if (mm.gt.3) go to 1                                              pade-016
      lo(205)=.false.                                                   pade-017
      return                                                            pade-018
c  taylor coefficients                                                  pade-019
    1 mt=mm+1                                                           pade-020
      p(1,1,1)=r(1,1)                                                   pade-021
      p(1,2,1)=0.d0                                                     pade-022
      p(2,1,1)=r(2,1)                                                   pade-023
      p(2,2,1)=0.d0                                                     pade-024
      do 2 i=2,mm                                                       pade-025
      p(1,1,i)=r(1,i)-r(1,i-1)                                          pade-026
      p(1,2,i)=0.d0                                                     pade-027
      p(2,1,i)=r(2,i)-r(2,i-1)                                          pade-028
    2 p(2,2,i)=0.d0                                                     pade-029
c  decomposition loop                                                   pade-030
      nm=mm-1                                                           pade-031
      do 6 na=1,nm                                                      pade-032
      ml=mm-na                                                          pade-033
      zr=p(1,1,na)                                                      pade-034
      zi=p(2,1,na)                                                      pade-035
      if (dabs(zr)+dabs(zi).ge.1.d-8) go to 4                           pade-036
      p(1,2,mt-na)=0.d0                                                 pade-037
      p(2,2,mt-na)=0.d0                                                 pade-038
      do 3 j=1,ml                                                       pade-039
      p(1,1,na+j)=p(1,1,na+j)-p(1,1,na)*p(1,2,j)+p(2,1,na)*p(2,2,j)     pade-040
    3 p(2,1,na+j)=p(2,1,na+j)-p(2,1,na)*p(1,2,j)-p(1,1,na)*p(2,2,j)     pade-041
      go to 6                                                           pade-042
    4 p(1,2,mt-na)=1.d0                                                 pade-043
      do 5 j=1,ml                                                       pade-044
      zx=p(1,1,na)**2+p(2,1,na)**2                                      pade-045
      zr=(p(1,1,na+j)*p(1,1,na)+p(2,1,na+j)*p(2,1,na))/zx               pade-046
      zi=(p(2,1,na+j)*p(1,1,na)-p(1,1,na+j)*p(2,1,na))/zx               pade-047
      p(1,1,na+j)=p(1,2,j)-zr                                           pade-048
      p(2,1,na+j)=p(2,2,j)-zi                                           pade-049
      p(1,2,j)=zr                                                       pade-050
    5 p(2,2,j)=zi                                                       pade-051
    6 continue                                                          pade-052
      ar1=1.d30                                                         pade-053
c  truncated continued fractions                                        pade-054
      do 9  n=1,nm                                                      pade-055
      ip=mm+1-n                                                         pade-056
      p(1,2,n)=p(1,1,ip)                                                pade-057
      p(2,2,n)=p(2,1,ip)                                                pade-058
      do 8  i=2,ip                                                      pade-059
      id=ip+1-i                                                         pade-060
      if (p(1,2,mt-id).gt.0.d0) go to 7                                 pade-061
      ar=valr*p(1,2,n)-vali*p(2,2,n)+p(1,1,id)                          pade-062
      ai=valr*p(2,2,n)+vali*p(1,2,n)+p(2,1,id)                          pade-063
      p(1,2,n)=ar                                                       pade-064
      p(2,2,n)=ai                                                       pade-065
      go to 8                                                           pade-066
    7 ar=1.d0+valr*p(1,2,n)-vali*p(2,2,n)                               pade-067
      ai=valr*p(2,2,n)+vali*p(1,2,n)                                    pade-068
      zx=ar*ar+ai*ai                                                    pade-069
      p(1,2,n)=(p(1,1,id)*ar+p(2,1,id)*ai)/zx                           pade-070
      p(2,2,n)=(p(2,1,id)*ar-p(1,1,id)*ai)/zx                           pade-071
    8 continue                                                          pade-072
      if (n.eq.1) go to 9                                               pade-073
c search for smallest difference                                        pade-074
      zr=p(1,2,n)-p(1,2,n-1)                                            pade-075
      zi=p(2,2,n)-p(2,2,n-1)                                            pade-076
      ai1=dmax1(dabs(zr),dabs(zi))                                      pade-077
      if (ai1.ge.ar1) go to 9                                           pade-078
      nn=n                                                              pade-079
      ar1=ai1                                                           pade-080
    9 continue                                                          pade-081
      lo(205)=ar1.le.eiter                                              pade-082
      if (lo(57)) write (mw,1000) lo(205),mm,nn,p(1,2,nn),p(2,2,nn),p(1,pade-083
     12,nn-1),p(2,2,nn-1)                                               pade-084
      if ((.not.lo(205)).and.(lo(206).or.lo(23))) return                pade-085
      lo(205)=.true.                                                    pade-086
      bre=p(1,2,nn-1)                                                   pade-087
      bim=p(2,2,nn-1)                                                   pade-088
      if (nn.eq.2) return                                               pade-089
      bre=0.5d0*(bre+p(1,2,nn))                                         pade-090
      bim=0.5d0*(bim+p(2,2,nn))                                         pade-091
      return                                                            pade-092
 1000 format (' pade',5x,l3,5x,'iter =',i3,5x,'n =',i3,5x,4d15.8)       pade-093
      end                                                               pade-094
c 29/02/04                                                      ecis03  inch-000
      subroutine inch(v,vi,mc,nat,at,nvi,fam,y,x,wr,wi,ism,kab,nc,ncin,ninch-001
     1ml,jsx,npp,kr,lo)                                                 inch-002
c  standard integration of the coupled  equations by the numerov method inch-003
c input variables: v,vi:    real and imaginary potentials and couplings inch-004
c                  mc(*,6): address of central potentials               inch-005
c                  nat,at:  geometrical coefficients                    inch-006
c                  nvi:     addresses in the table nat,at               inch-007
c                  fam:     matching values and constants of equations  inch-008
c                  y:       coulomb corrections                         inch-009
c                  ism:     number of radial points                     inch-010
c                  kab:     maximum number of coupled channels          inch-011
c                  nc:      number of coupled channels                  inch-012
c                  ncin:    number of solutions                         inch-013
c                  nml:     maximum number of points where the coupling inch-014
c                           potentials can be calculated at a time      inch-015
c                  jsx:     periodicity of the schmidt's orthogonalisa- inch-016
c                           tion if lo(42) is .true.                    inch-017
c                  npp:     number of optical potentials                inch-018
c                  lo(i):   logical controls                            inch-019
c output variables: scattering coefficients multiplied kf/ki            inch-020
c                  real part in x(ic,ic',5), imaginary part in          inch-021
c                  x(ic,ic',2) for incoming channel ic'                 inch-022
c working fields:  wr/i(ic,ic',is): real/imaginary coupling potentials  inch-023
c                  x(ic,ic',i): numerov recurrence                      inch-024
c                  kr:      working field for lins                      inch-025
c***********************************************************************inch-026
      implicit real*8 (a-h,o-z)                                         inch-027
      dimension wr(nc,nc,1),wi(nc,nc,1),v(ism,1),vi(ism,1),mc(kab,6),nviinch-028
     1(kab,kab,2),kr(1),nat(4,1),at(2,1),x(kab,kab,6),fam(kab,10),y(kab,inch-029
     2kab,4)                                                            inch-030
      common /inout/ mr,mw,ms                                           inch-031
      logical lo(250),lt                                                inch-032
      if (lo(74)) call hora                                             inch-033
      jr=0                                                              inch-034
      n2=nc*nc                                                          inch-035
      do 3 i=1,nc                                                       inch-036
      do 2 j=1,nc                                                       inch-037
      do 1 k=1,6                                                        inch-038
    1 x(j,i,k)=0.d0                                                     inch-039
    2 continue                                                          inch-040
    3 x(i,i,3)=1.d-15                                                   inch-041
c  radial integration loop                                              inch-042
      do 31 js=1,ism                                                    inch-043
      is=mod(js-1,nml)+1                                                inch-044
      if (js.le.jr) go to 17                                            inch-045
      ji=jr+1                                                           inch-046
      jr=min0(ism,jr+nml)                                               inch-047
c the potentials are first calculated in wr(ic,ic',i) and               inch-048
c wi(ic,ic',i) starting with i=2   for ic larger or equal to ic'        inch-049
      do 10 l=1,nc                                                      inch-050
      do 9 j=l,nc                                                       inch-051
      m=j+(l-1)*nc                                                      inch-052
      n=m                                                               inch-053
      do 4 i=ji,jr                                                      inch-054
      n=n+n2                                                            inch-055
      wr(n,1,1)=0.d0                                                    inch-056
    4 wi(n,1,1)=0.d0                                                    inch-057
      if (l.ne.j) go to 6                                               inch-058
c optical model contribution                                            inch-059
      n=m                                                               inch-060
      i1=mc(l,4)                                                        inch-061
      i2=i1+npp                                                         inch-062
      do 5 i=ji,jr                                                      inch-063
      n=n+n2                                                            inch-064
      bre=dfloat(i)**2                                                  inch-065
      wr(n,1,1)=fam(l,9)-fam(l,10)/bre+fam(l,7)*v(i,i1)                 inch-066
      wi(n,1,1)=fam(l,7)*vi(i,i1)                                       inch-067
      if (lo(229)) wr(n,1,1)=wr(n,1,1)+fam(l,8)*v(i,i2)                 inch-068
      if (lo(230)) wi(n,1,1)=wi(n,1,1)+fam(l,8)*vi(i,i2)                inch-069
    5 continue                                                          inch-070
c coupled channel contribution                                          inch-071
    6 k1=nvi(j,l,1)                                                     inch-072
      k2=nvi(j,l,2)                                                     inch-073
      if (k1.gt.k2) go to 9                                             inch-074
      do 8 k=k1,k2                                                      inch-075
      kt=iabs(nat(1,k))                                                 inch-076
      lt=kt.ne.nat(1,k)                                                 inch-077
      n=m                                                               inch-078
      do 7 i=ji,jr                                                      inch-079
      n=n+n2                                                            inch-080
      wr(n,1,1)=wr(n,1,1)+at(2,k)*v(i,kt)                               inch-081
      if (lt) wi(n,1,1)=wi(n,1,1)+at(2,k)*vi(i,kt)                      inch-082
    7 continue                                                          inch-083
    8 continue                                                          inch-084
    9 continue                                                          inch-085
   10 continue                                                          inch-086
      jj=jr-ji+1                                                        inch-087
      do 16 i=1,jj                                                      inch-088
      j=i+1                                                             inch-089
c symmetrisation of old values                                          inch-090
      do 12 k=1,nc                                                      inch-091
      do 11 l=k,nc                                                      inch-092
      wr(k,l,j)=wr(l,k,j)                                               inch-093
   11 wi(k,l,j)=wi(l,k,j)                                               inch-094
   12 continue                                                          inch-095
c computation of v +v*v/12. for l larger or equal to k                  inch-096
      do 15 k=1,nc                                                      inch-097
      do 14 l=k,nc                                                      inch-098
      bre=0.d0                                                          inch-099
      bim=0.d0                                                          inch-100
      do 13 n=1,nc                                                      inch-101
      bre=bre-wr(n,k,j)*wr(n,l,j)+wi(n,k,j)*wi(n,l,j)                   inch-102
   13 bim=bim-wi(n,k,j)*wr(n,l,j)-wr(n,k,j)*wi(n,l,j)                   inch-103
c symmetrisation                                                        inch-104
      wr(l,k,i)=wr(l,k,j)+bre/12.d0                                     inch-105
      wi(l,k,i)=wi(l,k,j)+bim/12.d0                                     inch-106
      wr(k,l,i)=wr(l,k,i)                                               inch-107
   14 wi(k,l,i)=wi(l,k,i)                                               inch-108
      if (lo(30)) wr(k,k,i)=wr(k,k,i)+wr(k,k,j)**3/360.d0               inch-109
   15 continue                                                          inch-110
   16 continue                                                          inch-111
   17 do 24 i=1,nc                                                      inch-112
      do 18 j=1,nc                                                      inch-113
      x(i,j,1)=x(i,j,2)                                                 inch-114
      x(i,j,2)=x(i,j,3)                                                 inch-115
      x(i,j,4)=x(i,j,5)                                                 inch-116
   18 x(i,j,5)=x(i,j,6)                                                 inch-117
   19 do 21 j=1,nc                                                      inch-118
      hx=0.d0                                                           inch-119
      hy=0.d0                                                           inch-120
      do 20 k=1,nc                                                      inch-121
      hx=hx+wr(k,j,is)*x(i,k,2)-wi(k,j,is)*x(i,k,5)                     inch-122
   20 hy=hy+wi(k,j,is)*x(i,k,2)+wr(k,j,is)*x(i,k,5)                     inch-123
      x(i,j,3)=x(i,j,2)+x(i,j,2)-x(i,j,1)-hx                            inch-124
   21 x(i,j,6)=x(i,j,5)+x(i,j,5)-x(i,j,4)-hy                            inch-125
      if (dabs(x(i,i,3)).lt.1.d15) go to 24                             inch-126
      do 23 ji=1,6                                                      inch-127
      do 22 ij=1,nc                                                     inch-128
   22 x(i,ij,ji)=x(i,ij,ji)*1.d-30                                      inch-129
   23 continue                                                          inch-130
      go to 19                                                          inch-131
   24 continue                                                          inch-132
      if (lo(142).or.mod(js,jsx).ne.0.or.js.eq.ism) go to 31            inch-133
c  schmidt orthogonalisation procedure every jsx steps                  inch-134
      do 30 i=1,nc                                                      inch-135
      if (i.eq.1) go to 28                                              inch-136
      in=i-1                                                            inch-137
      do 27 k=1,in                                                      inch-138
      x(i,k,1)=0.d0                                                     inch-139
      x(i,k,4)=0.d0                                                     inch-140
      do 25 j=1,nc                                                      inch-141
      x(i,k,1)=x(i,k,1)+x(k,j,2)*x(i,j,2)-x(k,j,5)*x(i,j,5)             inch-142
   25 x(i,k,4)=x(i,k,4)+x(k,j,5)*x(i,j,2)+x(k,j,2)*x(i,j,5)             inch-143
      bre=x(i,k,1)*x(k,k,1)-x(i,k,4)*x(k,k,4)                           inch-144
      bim=x(i,k,1)*x(k,k,4)+x(i,k,4)*x(k,k,1)                           inch-145
      do 26 j=1,nc                                                      inch-146
      x(i,j,2)=x(i,j,2)-bre*x(k,j,2)+bim*x(k,j,5)                       inch-147
      x(i,j,5)=x(i,j,5)-bre*x(k,j,5)-bim*x(k,j,2)                       inch-148
      x(i,j,3)=x(i,j,3)-bre*x(k,j,3)+bim*x(k,j,6)                       inch-149
   26 x(i,j,6)=x(i,j,6)-bre*x(k,j,6)-bim*x(k,j,3)                       inch-150
   27 continue                                                          inch-151
   28 bre=0.d0                                                          inch-152
      bim=0.d0                                                          inch-153
      do 29 j=1,nc                                                      inch-154
      bre=bre+x(i,j,2)**2-x(i,j,5)**2                                   inch-155
   29 bim=bim+2.d0*x(i,j,2)*x(i,j,5)                                    inch-156
      bim=bim/bre                                                       inch-157
      x(i,i,1)=1.d0/(bre*(1.d0+bim**2))                                 inch-158
   30 x(i,i,4)=-x(i,i,1)*bim                                            inch-159
   31 continue                                                          inch-160
      if (lo(74)) call hora                                             inch-161
c  matrices of pseudo-wronskians for the matching condition             inch-162
      do 33 i=1,nc                                                      inch-163
      do 32 j=1,nc                                                      inch-164
      j1=nc+j                                                           inch-165
      x(i,j1,1)=(x(i,j,1)*fam(j,2)-fam(j,1)*x(i,j,3))                   inch-166
      x(i,j1,4)=(x(i,j,6)*fam(j,1)-fam(j,2)*x(i,j,4))                   inch-167
      x(i,j,1)=(x(i,j,3)*fam(j,3)-fam(j,4)*x(i,j,1))                    inch-168
      x(i,j,4)=(x(i,j,4)*fam(j,4)-fam(j,3)*x(i,j,6))                    inch-169
      if (fam(j,9).lt.0.d0) go to 32                                    inch-170
      x(i,j,1)=x(i,j,1)-x(i,j1,4)                                       inch-171
      x(i,j,4)=x(i,j,4)+x(i,j1,1)                                       inch-172
   32 continue                                                          inch-173
   33 continue                                                          inch-174
c  complex linear system of equations                                   inch-175
      ncx=ncin                                                          inch-176
      if (lo(44)) ncx=nc                                                inch-177
      call lins(x(1,1,4),kab,x,kab,nc,ncx,kr,ier)                       inch-178
      if (ier.ne.0) go to 39                                            inch-179
      if (lo(144)) return                                               inch-180
c building the linear system for s-matrix with coulomb corrections      inch-181
      do 36 i=1,nc                                                      inch-182
      do 35 j=1,nc                                                      inch-183
      j1=nc+j                                                           inch-184
      x(i,j,1)=y(j,i,1)                                                 inch-185
      x(i,j,3)=x(i,j1,1)                                                inch-186
      x(i,j,4)=y(j,i,2)                                                 inch-187
      x(i,j,6)=-y(j,i,1)+x(i,j1,4)                                      inch-188
      do 34 k=1,nc                                                      inch-189
      k1=k+nc                                                           inch-190
      x(i,j,1)=x(i,j,1)-(y(j,k,1)-y(j,k,4))*x(i,k1,1)+(y(j,k,3)+y(j,k,2)inch-191
     1)*x(i,k1,4)                                                       inch-192
      x(i,j,3)=x(i,j,3)-y(j,k,3)*x(i,k1,1)-y(j,k,1)*x(i,k1,4)           inch-193
      x(i,j,4)=x(i,j,4)-(y(j,k,1)-y(j,k,4))*x(i,k1,4)-(y(j,k,2)+y(j,k,3)inch-194
     1)*x(i,k1,1)                                                       inch-195
   34 x(i,j,6)=x(i,j,6)-y(j,k,3)*x(i,k1,4)+y(j,k,1)*x(i,k1,1)           inch-196
   35 continue                                                          inch-197
   36 x(i,i,4)=x(i,i,4)+1.d0                                            inch-198
c transfer of the second members in x(1,1,5) and x(1,1,2)               inch-199
      do 38 i=1,nc                                                      inch-200
      do 37 j=1,nc                                                      inch-201
      j1=nc+j                                                           inch-202
      y(i,j,2)=x(i,j1,1)                                                inch-203
      x(i,j1,1)=x(i,j,3)                                                inch-204
      y(i,j,1)=x(i,j1,4)                                                inch-205
   37 x(i,j1,4)=x(i,j,6)                                                inch-206
   38 continue                                                          inch-207
      call lins(x(1,1,4),kab,x,kab,nc,ncin,kr,ier)                      inch-208
      if (ier.ne.0) go to 39                                            inch-209
      if (lo(57)) write (mw,1000) ((i,j,y(i,j,1),y(i,j,2),x(i,nc+j,4),x(inch-210
     1i,nc+j,1),j=1,ncin),i=1,nc)                                       inch-211
      return                                                            inch-212
   39 write (mw,1001) ier                                               inch-213
      stop                                                              inch-214
 1000 format (/25x,'uncorrected values',30x,'corrected values'/(2x,2i3,4inch-215
     1d25.15))                                                          inch-216
 1001 format (' return from lins with ier =',i2,' in inch   ... stop ...inch-217
     1')                                                                inch-218
      end                                                               inch-219
c 29/02/04                                                      ecis03  scam-000
      subroutine scam(f,fcn,tx,gcn,jmax,kmax,mc,md,far,fai,wv,ncoll,ncolscam-001
     1s,kab,kba,ipi,ipim,gam,fiss,tl,ncj,xd,p,q,v,nct,iq,aa,kbc,idt,xz,lscam-002
     2o)                                                                scam-003
c storage of scattering coefficients                                    scam-004
c  input variables:jmax: maximum number of channel spins, dim. for f    scam-005
c                  kmax: max. num. of l of comp. nuc., dim. for fcn, gcnscam-006
c                  mc:   nuclear state numbers, angular momenta, etc... scam-007
c                         see quan                                      scam-008
c                  md:   extended mc for ident. part. with spin         scam-009
c                  far/fai: real/imaginary part of scattering coeff.    scam-010
c                  wv:   wave number and coulomb parameter.  see colf   scam-011
c                  ncoll:number of coupled levels                       scam-012
c                  ncols:number of levels with angular distribution     scam-013
c                  kab:  dimension for mc                               scam-014
c                  kba:  number of independent amplitudes               scam-015
c                  ipi,ipim: parity, multipl., addresses in f (see calx)scam-016
c                  gam:  gamma transmission coefficients read           scam-017
c                  fiss: fission coefficients for compound nucleus      scam-018
c                  tl:   transmission coefficients of uncoupled levels  scam-019
c                  ncj:  starting and final addresses for continua      scam-020
c                  xd:   energy and spin dependence of level densities  scam-021
c                  nct:  number of equa. and solutions for each parity  scam-022
c                  iq:   dimension for v                                scam-023
c                  aa:   coefficients of symmetrisation                 scam-024
c                  kbc:  dimension for aa                               scam-025
c                  idt:  size available for the q in double precision   scam-026
c                  xz:   conversion factor to millibarns                scam-027
c                  lo:   logical controls                               scam-028
c              lo(18) =.true.  identical particle and target            scam-029
c              lo(55) =.true.  output of c-matrix and compound nucleus  scam-030
c              lo(63) =.true.  penetrabilities written on file 63       scam-031
c              lo(82) =.true.  old simplified compound nucleus          scam-032
c              lo(83) =.true.  no engelbretch-weidenmuller transform    scam-033
c              lo(85) =.true.  fission transmission coefficients        scam-034
c              lo(86) =.true.  gamma emission in compound nucleus       scam-035
c              lo(87) =.true.  no width fluctuations                    scam-036
c              lo(224)=.true.  compute transmission coefficients        scam-037
c              lo(225)=.true.  usual coupled equations                  scam-038
c              lo(231)=.true.  identical non-0 spin particle and target scam-039
c              lo(232)=.true.  do not compute compound contributions    scam-040
c              lo(233)=.true.  store fission and gamma transm. coeff.   scam-041
c by common /ncomp/ncont:number of continua for compound nucleus        scam-042
c                  bz1,bz2,bz3,bz4,bz5: parameter for compound nucleus  scam-043
c                   (see description of input). for the others see conu scam-044
c by common /noequ/nic:  number of coupled channels                     scam-045
c                  nci:  number of solutions                            scam-046
c                  nc:   number of equations without antisymmetrisation scam-047
c                  ncin: number of solutions without antisymmetrisation scam-048
c                  jpi:  channel parity (0/1)                           scam-049
c                  ipj:  number of the channel spin                     scam-050
c                  naj:  twice channel spin                             scam-051
c output variables:f:    scattering coefficients                        scam-052
c                  fcn:  compound nucleus contributions                 scam-053
c                  tx:   total reaction cross section in mb followed by scam-054
c                        the total direct cross sections of coupled     scam-055
c                        levels, the total compound cross sections of   scam-056
c                        levels, the fission and gamma cross sections   scam-057
c                  gcn:  compound nucleus coefficients of legendre poly.scam-058
c in common /noequ/r1:   maximum of scattering and compound coefficient scam-059
c working space:   p:    for diagonalisation of the s matrix            scam-060
c                  q:    for angular distribution of compound nucleus   scam-061
c                  v(1,*):   level and quantum numbers                  scam-062
c                  v(2,*):   weigh for continua                         scam-063
c                  v(3,*):   transmission coefficients                  scam-064
c                  v(4,*):   width fluctuation parameter                scam-065
c                  v(5,*):   contribution to compound nucleus           scam-066
c***********************************************************************scam-067
      implicit real*8 (a-h,o-z)                                         scam-068
      logical lo(250),lg(2)                                             scam-069
      dimension f(2,jmax,1),fcn(kmax,1),mc(kab,12),far(kab,1),fai(kab,1)scam-070
     1,wv(18,1),ipi(11,1),ipim(11,1),gam(1),fiss(2,1),tl(1),ncj(2,1),xd(scam-071
     23,1),p(nc,nc,4),q(1),v(iq,1),nct(6),aa(kbc,1),gcn(kmax,1),tx(1),x(scam-072
     320),w(20),tp(20),sgf(2),tg(2),fnu(2),md(kab,12),mcx(4,2),vcx(4,2) scam-073
      character*1 ip(2)                                                 scam-074
      character*8 al(2)                                                 scam-075
      common /ncomp/ nsp(3),nfiss,nrd,ncont,ncoj,ncons,nie,ncolx,ndp,ndqscam-076
     1,acn(8),bz1,bz2,bz3,bz4,bz5,tg0,bn,fnug,egd,ggd,tg1,sgsq          scam-077
      common /noequ/ ncxn,nic,nci,nc,ncin,nin,jpi,ipj,r1(2),naj         scam-078
      common /inout/ mr,mw,ms                                           scam-079
      data ip,al,pi,nsy /'+','-',' fission','   gamma',3.1415926535d0,0/scam-080
      data x /7.0539889691988753d-02,3.7212681800161144d-01,9.1658210248scam-081
     1327356d-01,1.7073065310283439d+00,2.7491992553094321d+00,4.0489253scam-082
     2138508869d+00,5.6151749708616165d+00,7.4590174536710633d+00,9.5943scam-083
     3928695810968d+00,1.2038802546964316d+01,1.4814293442630740d+01,1.7scam-084
     4948895520519376d+01,2.1478788240285011d+01,2.5451702793186906d+01,scam-085
     52.9932554631700612d+01,3.5013434240479000d+01,4.0833057056728571d+scam-086
     601,4.7619994047346502d+01,5.5810795750063899d+01,6.652441652561575scam-087
     74d+01/                                                            scam-088
      data w /1.8108006241898926d-01,4.2255676787856397d-01,6.6690954670scam-089
     1184815d-01,9.1535237278307367d-01,1.1695397071955460d+00,1.4313549scam-090
     2859282060d+00,1.7029811379850227d+00,1.9870158907927472d+00,2.2866scam-091
     3357812534308d+00,2.6058347275538333d+00,2.9497837342139509d+00,3.3scam-092
     4253957820093196d+00,3.7422554705898109d+00,4.2142367102518804d+00,scam-093
     54.7625184614902093d+00,5.4217260442455743d+00,6.2540123569324213d+scam-094
     600,7.3873143890544346d+00,9.1513287309874796d+00,1.289338864593999scam-095
     77d+01/                                                            scam-096
      ik(i,l,j)=((j-naj+ipi(3,i)-1)/2*ipi(2,i)+(l-j+ipi(2,i)-1)/2)/2    scam-097
      nz=mod(ipj+jpi+1,2)                                               scam-098
      ns=0                                                              scam-099
      if (nz.ne.0) ns=nct(1)*nct(3)                                     scam-100
      r1(1)=0.d0                                                        scam-101
      r1(2)=0.d0                                                        scam-102
      jc=0                                                              scam-103
      aj=0.5d0*dfloat(naj)                                              scam-104
      bz=1.d0                                                           scam-105
      if (lo(18)) bz=2.d0                                               scam-106
      rz=pi*bz*xz*dfloat(naj+1)                                         scam-107
      if (lo(55)) write (mw,1000) aj,ip(jpi+1),nc,ncin                  scam-108
c computation of transmission coefficients                              scam-109
      nxx=ncin                                                          scam-110
      if (lo(224)) nxx=nc                                               scam-111
      do 5 ic=1,nxx                                                     scam-112
      iv=mc(ic,1)                                                       scam-113
      if (wv(3,iv).lt.0.d0) go to 5                                     scam-114
      if (ic.le.ncin) tx(1)=tx(1)+4.d0*fai(ic,ic)*rz*bz                 scam-115
      if (.not.lo(224)) go to 2                                         scam-116
      jc=jc+1                                                           scam-117
      v(1,jc)=dfloat(1024*(1024*iv+mc(ic,2))+mc(ic,3))                  scam-118
      v(2,jc)=1.d0                                                      scam-119
      v(3,jc)=4.d0*fai(ic,ic)                                           scam-120
      do 1 n=4,iq                                                       scam-121
    1 v(n,jc)=0.d0                                                      scam-122
    2 do 4 icp=1,nc                                                     scam-123
      ivq=mc(icp,1)                                                     scam-124
      a1=wv(6,ivq)/wv(6,iv)                                             scam-125
      if (lo(225)) a1=1.d0/a1                                           scam-126
      far(icp,ic)=far(icp,ic)*a1                                        scam-127
      fai(icp,ic)=fai(icp,ic)*a1                                        scam-128
      if (wv(3,ivq).lt.0.d0) go to 3                                    scam-129
      if (lo(224)) v(3,jc)=v(3,jc)-4.d0*(far(icp,ic)**2+fai(icp,ic)**2) scam-130
      if (ic.gt.ncin) go to 4                                           scam-131
c test of convergence                                                   scam-132
      r1(1)=dmax1(r1(1),dabs(far(icp,ic))+dabs(fai(icp,ic)))            scam-133
      a1=far(icp,ic)*far(icp,ic)+fai(icp,ic)*fai(icp,ic)                scam-134
      if (a1.gt.1.d0) write (mw,1001) aj,ip(jpi+1),nc,ncin,ic,icp,far(icscam-135
     1p,ic),fai(icp,ic)                                                 scam-136
      tx(ivq+1)=tx(ivq+1)+4.d0*a1*rz*bz                                 scam-137
      fj=0.5d0*dfloat(mc(icp,3))                                        scam-138
      if (lo(155)) go to 4                                              scam-139
c print out of the amplitudes                                           scam-140
      a1=dsqrt(a1)                                                      scam-141
      b1=0.d0                                                           scam-142
      if (a1.ne.0.d0) b1=datan2(fai(icp,ic),far(icp,ic))                scam-143
      write (mw,1002) icp,ic,ivq,mc(icp,2),fj,far(icp,ic),fai(icp,ic),a1scam-144
     1,b1                                                               scam-145
      go to 4                                                           scam-146
    3 if ((ic.le.ncin).and.lo(55)) write (mw,1003) icp,ic,ivq,mc(icp,2),scam-147
     1fj,far(icp,ic),fai(icp,ic)                                        scam-148
    4 continue                                                          scam-149
      if (.not.lo(224)) go to 5                                         scam-150
      if (v(3,jc).lt.0.d0) v(3,jc)=0.d0                                 scam-151
      if (ic.le.ncin) r1(2)=dmax1(r1(2),v(3,jc))                        scam-152
    5 continue                                                          scam-153
      if (lo(163).and.lo(155)) go to 8                                  scam-154
c output of transmission coefficients for coupled channels              scam-155
      if (lo(55)) write (mw,1004) aj,ip(jpi+1)                          scam-156
      ic=1+(jc-1)/4                                                     scam-157
      if (lo(63)) write (99,1005) aj,ip(jpi+1),jc                       scam-158
      do 7 i=1,ic                                                       scam-159
      j1=4*(i-1)                                                        scam-160
      j2=min0(jc-j1,4)                                                  scam-161
      do 6 j=1,j2                                                       scam-162
      n=idint(v(1,j+j1)+.01d0)                                          scam-163
      vcx(j,1)=0.5d0*dfloat(mod(n,1024))                                scam-164
      vcx(j,2)=v(3,j+j1)                                                scam-165
      mcx(j,2)=mod(n/1024,1024)                                         scam-166
    6 mcx(j,1)=(n/1024)/1024                                            scam-167
      if (lo(63)) write (99,1006) (mcx(j,1),mcx(j,2),vcx(j,1),vcx(j,2),jscam-168
     1=1,j2)                                                            scam-169
      if (lo(55)) write (mw,1007) (mcx(j,1),mcx(j,2),vcx(j,1),vcx(j,2),jscam-170
     1=1,j2)                                                            scam-171
    7 continue                                                          scam-172
    8 if (lo(232)) go to 62                                             scam-173
      nss=ns                                                            scam-174
      if (nz.ne.0) nss=nct(5)*nct(3)                                    scam-175
c fission coefficient                                                   scam-176
      tg(1)=0.d0                                                        scam-177
      fnu(1)=.5d0                                                       scam-178
      if (lo(186)) go to 9                                              scam-179
      kn=2*ipj+jpi-1                                                    scam-180
      if (kn.ge.nfiss) go to 9                                          scam-181
      tg(1)=fiss(1,kn)                                                  scam-182
      fnu(1)=.5d0*fiss(2,kn)                                            scam-183
    9 lg(1)=lo(185).or.tg(1).eq.0.d0                                    scam-184
c gamma coefficient                                                     scam-185
      tg(2)=0.d0                                                        scam-186
      fnu(2)=.5d0*fnug                                                  scam-187
      if (lo(186)) go to 12                                             scam-188
      if (nrd.ne.0) go to 11                                            scam-189
      a1=0.d0                                                           scam-190
      n1=naj-2                                                          scam-191
      n1=iabs(n1)                                                       scam-192
      n2=naj+2                                                          scam-193
      do 10 j=n1,n2,2                                                   scam-194
      a2=-dfloat((j+1)*(j+1))/(4.d0*sgsq)                               scam-195
   10 a1=a1+dexp(a2)*dfloat(j+1)/sgsq                                   scam-196
      tg(2)=6.283185307d0*tg1*a1                                        scam-197
      go to 12                                                          scam-198
   11 if (ipj.le.nrd) tg(2)=gam(ipj)                                    scam-199
   12 lg(2)=lo(186).or.tg(2).eq.0.d0                                    scam-200
      nc1=jc                                                            scam-201
      njc=jc                                                            scam-202
      if (ncoll.eq.ncolx) go to 24                                      scam-203
c transmission coefficients for uncoupled states                        scam-204
      nsp1=ncolx-ncoll-ncont                                            scam-205
      if (nsp1.lt.1) go to 17                                           scam-206
      do 16 i=1,nsp1                                                    scam-207
      ii=i+ncoll                                                        scam-208
      if (wv(3,ii).lt.0.d0) go to 16                                    scam-209
      nm=ipi(3,ii)                                                      scam-210
      mn=ipi(2,ii)                                                      scam-211
      do 15 j=1,nm                                                      scam-212
      nn=naj-nm-1+2*j                                                   scam-213
      if (nn.lt.iabs(nm-1-naj)) go to 15                                scam-214
      do 14 k=1,mn                                                      scam-215
      mm=nn+mn+1-2*k                                                    scam-216
      if (mm.lt.iabs(mn-1-nn).or.mm.ge.2*ipi(10,ii)+2) go to 14         scam-217
      l=mm/2                                                            scam-218
      if (mod(l+jpi+ipi(1,ii),2).ne.0) go to 14                         scam-219
      m=mn*l+k+ipi(8,ii)                                                scam-220
      jc=jc+1                                                           scam-221
      v(1,jc)=dfloat(1024*(1024*ii+l)+nn)                               scam-222
      v(2,jc)=1.d0                                                      scam-223
      v(3,jc)=tl(m)                                                     scam-224
      do 13 n=4,iq                                                      scam-225
   13 v(n,jc)=0.d0                                                      scam-226
   14 continue                                                          scam-227
   15 continue                                                          scam-228
      if (ii.le.ncols) nc1=jc                                           scam-229
   16 continue                                                          scam-230
   17 if (ncont.eq.0) go to 24                                          scam-231
c transmission coefficients for continua                                scam-232
      do 23 i=1,ncont                                                   scam-233
      ij=ncj(1,i)                                                       scam-234
      ji=ncj(2,i)                                                       scam-235
      if (ij.gt.ji) go to 23                                            scam-236
      mn=ipim(2,ij)                                                     scam-237
      it=mod(ipim(3,ij)+1,2)                                            scam-238
      do 22 ii=ij,ji                                                    scam-239
      l=ipim(10,ii)+1                                                   scam-240
      if (l.eq.0) go to 22                                              scam-241
      m=ipim(8,ii)                                                      scam-242
      ii1=ii+ncoll+nsp1                                                 scam-243
      do 21 lj=1,l                                                      scam-244
      do 20 jl=1,mn                                                     scam-245
      m=m+1                                                             scam-246
      if (tl(m).eq.0.d0) go to 20                                       scam-247
      jj=2*(lj+jl)-mn-3                                                 scam-248
      if (jj.lt.0) go to 20                                             scam-249
      ikm=iabs(jj-naj)/2+1                                              scam-250
      ikp=min0((jj+naj)/2+1,ncoj)                                       scam-251
      if (ikm.gt.ikp) go to 20                                          scam-252
      ai=0.d0                                                           scam-253
      do 18 kk=ikm,ikp                                                  scam-254
      ar=.5d0*dfloat(it+2*kk-1)                                         scam-255
   18 ai=ai+ar*dexp(-ar*ar/xd(3,ii))/xd(3,ii)                           scam-256
      jc=jc+1                                                           scam-257
      v(1,jc)=dfloat(1024*(1024*ii1+(lj-1))+jj)                         scam-258
      v(2,jc)=ai*xd(1,ii)                                               scam-259
      v(3,jc)=tl(m)                                                     scam-260
      do 19 n=4,iq                                                      scam-261
   19 v(n,jc)=0.d0                                                      scam-262
   20 continue                                                          scam-263
   21 continue                                                          scam-264
   22 continue                                                          scam-265
   23 continue                                                          scam-266
c compound nucleus                                                      scam-267
   24 sgf(1)=0.d0                                                       scam-268
      sgf(2)=0.d0                                                       scam-269
      if (lo(82)) go to 58                                              scam-270
      if (lo(83)) go to 28                                              scam-271
c computation of satchler p-matrix ("pr","pi")                          scam-272
      i=0                                                               scam-273
      do 27 ii=1,nc                                                     scam-274
      if (wv(3,mc(ii,1)).lt.0.d0) go to 27                              scam-275
      i=i+1                                                             scam-276
      j=0                                                               scam-277
      do 26 jj=1,nc                                                     scam-278
      if (wv(3,mc(jj,1)).lt.0.d0) go to 26                              scam-279
      j=j+1                                                             scam-280
      p(i,j,1)=2.d0*(fai(i,j)+fai(j,i))                                 scam-281
      p(i,j,2)=0.d0                                                     scam-282
      p(i,j,3)=0.d0                                                     scam-283
      p(i,j,4)=0.d0                                                     scam-284
      k=0                                                               scam-285
      do 25 kk=1,nc                                                     scam-286
      if (wv(3,mc(kk,1)).lt.0.d0) go to 25                              scam-287
      k=k+1                                                             scam-288
      p(i,j,1)=p(i,j,1)-4.d0*(far(i,k)*far(j,k)+fai(i,k)*fai(j,k))      scam-289
   25 p(i,j,2)=p(i,j,2)+4.d0*(far(i,k)*fai(j,k)-fai(i,k)*far(j,k))      scam-290
   26 continue                                                          scam-291
   27 p(i,i,3)=1.d0                                                     scam-292
      call diag(nc,njc,p,p(1,1,2),p(1,1,3),p(1,1,4),1.d-12,a1,ierr)     scam-293
      if (ierr.eq.0) go to 28                                           scam-294
      write (mw,1008)                                                   scam-295
      lo(83)=.true.                                                     scam-296
      lo(183)=.false.                                                   scam-297
   28 bir=1.d-12+tg(1)+tg(2)                                            scam-298
      do 29 ic=1,jc                                                     scam-299
      if (lo(183).and.ic.le.njc) v(3,ic)=dmax1(0.d0,p(ic,ic,1))         scam-300
   29 bir=bir+v(3,ic)*v(2,ic)                                           scam-301
c fluctuation parameter nu=2*fnu, (p.a.m.,n.p.a344(1980)185)            scam-302
c common factor "tp" of width fluct. integral (p.a.m.,prc 11(1975)426)  scam-303
      if (lo(87).or.(bir.lt.0.0001d0)) go to 39                         scam-304
      do 30 m=1,20                                                      scam-305
   30 tp(m)=1.d0                                                        scam-306
      efb=dexp(-bz5*bir)                                                scam-307
      do 36 ic=1,jc                                                     scam-308
      if (bz2.ne.0.d0) go to 31                                         scam-309
      v(4,ic)=(1.d0+bz4+(v(3,ic)**bz3-bz4)*efb)/2.d0                    scam-310
      go to 32                                                          scam-311
   31 v(4,ic)=0.5d0*bz2                                                 scam-312
   32 a1=v(3,ic)/v(4,ic)/bir                                            scam-313
      if (a1.eq.0.d0) go to 36                                          scam-314
      if (a1.gt.1.d-9) go to 34                                         scam-315
      do 33 m=1,20                                                      scam-316
   33 tp(m)=tp(m)*dexp(x(m)*v(3,ic)*v(2,ic)/bir*(1.d0-.5d0*x(m)*a1))    scam-317
      go to 36                                                          scam-318
   34 do 35 m=1,20                                                      scam-319
   35 tp(m)=tp(m)*((bir+x(m)*v(3,ic)/v(4,ic))/bir)**(v(4,ic)*v(2,ic))   scam-320
   36 continue                                                          scam-321
      do 38 i=1,2                                                       scam-322
      if (lg(i)) go to 38                                               scam-323
      do 37 m=1,20                                                      scam-324
   37 tp(m)=tp(m)*(1.d0+x(m)*tg(i)/(bir*fnu(i)))**fnu(i)                scam-325
   38 continue                                                          scam-326
c storage of compound terms                                             scam-327
   39 tq=0.d0                                                           scam-328
      if (lo(155)) go to 40                                             scam-329
      write (mw,1009) aj,ip(jpi+1)                                      scam-330
      if (lo(183)) write (mw,1010)                                      scam-331
   40 ncx=njc                                                           scam-332
      if (lo(83)) ncx=ncin                                              scam-333
      do 56 ic=1,ncx                                                    scam-334
      g=1.d0                                                            scam-335
      bri=bir                                                           scam-336
      if (lo(87).and.(ic.le.ncin)) bri=bri+v(3,ic)*bz3                  scam-337
      ar=1.d0                                                           scam-338
      if (lo(83)) go to 42                                              scam-339
      ar=0.d0                                                           scam-340
      do 41 ia=1,ncin                                                   scam-341
   41 ar=ar+(p(ia,ic,3)**2+p(ia,ic,4)**2)                               scam-342
   42 do 52 icp=1,jc                                                    scam-343
      iv=idint(v(1,icp)/1048576.d0)                                     scam-344
      if (lo(87).or.(bir.lt.0.0001d0)) go to 44                         scam-345
      g=0.d0                                                            scam-346
      do 43 m=1,20                                                      scam-347
   43 g=g+w(m)/(tp(m)*(1.d0+x(m)*v(3,ic)/(v(4,ic)*bri))*(1.d0+x(m)*v(3,iscam-348
     1cp)/(v(4,icp)*bri)))                                              scam-349
      if (icp.eq.ic) g=g+g/v(4,ic)                                      scam-350
   44 tq=v(3,ic)*v(3,icp)*g/bri                                         scam-351
      if (lo(87).and.(icp.eq.ic)) tq=tq+tq*bz3                          scam-352
      if ((icp.gt.nc1).or.lo(83)) go to 50                              scam-353
c inverse e-w transformation (p.a.m.,prc 12(1975)744)                   scam-354
      if (icp.gt.njc) go to 48                                          scam-355
      do 47 ia=1,ncin                                                   scam-356
      do 46 ib=1,njc                                                    scam-357
      a1=p(ia,ic,3)*p(ib,icp,3)-p(ia,ic,4)*p(ib,icp,4)                  scam-358
      b1=p(ia,ic,3)*p(ib,icp,4)+p(ia,ic,4)*p(ib,icp,3)                  scam-359
      a2=a1                                                             scam-360
      b2=b1                                                             scam-361
      if (icp.eq.ic) go to 45                                           scam-362
      a2=a1+p(ia,icp,3)*p(ib,ic,3)-p(ia,icp,4)*p(ib,ic,4)               scam-363
      b2=b1+p(ia,icp,3)*p(ib,ic,4)+p(ia,icp,4)*p(ib,ic,3)               scam-364
   45 v(ia+4,ib)=v(ia+4,ib)+(a1*a2+b1*b2)*tq                            scam-365
   46 continue                                                          scam-366
   47 continue                                                          scam-367
      go to 51                                                          scam-368
   48 do 49 ia=1,ncin                                                   scam-369
   49 v(ia+4,icp)=v(ia+4,icp)+(p(ia,ic,3)**2+p(ia,ic,4)**2)*tq          scam-370
      go to 51                                                          scam-371
   50 v(5,icp)=v(5,icp)+ar*tq                                           scam-372
   51 if ((ic.gt.ncin).or.lo(155)) go to 52                             scam-373
      gnu=2.d0*v(4,icp)                                                 scam-374
      ll=idint(v(1,icp))-1048576*iv                                     scam-375
      l=ll/1000                                                         scam-376
      fj=0.5d0*dfloat(ll-1024*l)                                        scam-377
      write (mw,1011) ic,icp,iv,l,fj,v(3,icp),tq,gnu,g                  scam-378
   52 continue                                                          scam-379
      if (lo(83).and.ic.gt.ncin) go to 56                               scam-380
      do 55 i=1,2                                                       scam-381
      if (lg(i)) go to 55                                               scam-382
      if (lo(87)) go to 54                                              scam-383
      g=0.d0                                                            scam-384
      do 53 m=1,20                                                      scam-385
   53 g=g+w(m)/(tp(m)*(1.d0+x(m)*v(3,ic)/(v(4,ic)*bri))*(1.d0+x(m)*tg(i)scam-386
     1/(bri*fnu(i))))                                                   scam-387
   54 a1=v(3,ic)*tg(i)*g/bri                                            scam-388
      sgf(i)=sgf(i)+a1*ar                                               scam-389
      fn=2.d0*fnu(i)                                                    scam-390
      if (lo(55).and.(ic.le.ncin)) write (mw,1012) al(i),tg(i),sgf(i),fnscam-391
     1,g                                                                scam-392
   55 continue                                                          scam-393
   56 continue                                                          scam-394
      if (lo(55)) write (mw,1013) bir                                   scam-395
      do 57 i=1,2                                                       scam-396
      if (lg(i)) go to 57                                               scam-397
      if (lo(233)) fcn(ipj,ndq+i)=fcn(ipj,ndq+i)+.25d0*sgf(i)           scam-398
      tx(ndp+i)=tx(ndp+i)+rz*sgf(i)                                     scam-399
   57 continue                                                          scam-400
      go to 62                                                          scam-401
c storage for simplified compound nucleus                               scam-402
   58 bir=bz3*bz3*(2.d0*aj+1.d0)*dexp(-aj*(aj+1.d0)/(2.d0*bz2*bz2))     scam-403
      do 59 ic=1,njc                                                    scam-404
   59 bir=bir+4.d0*v(3,ic)                                              scam-405
      if (lo(55)) write (mw,1014) bir                                   scam-406
      do 61 ic=1,ncin                                                   scam-407
      nt=ns+ik(1,2*mc(ic,2),mc(ic,3))*nct(nz+1)                         scam-408
      do 60 icp=1,njc                                                   scam-409
      tq=v(3,ic)*v(3,icp)/bir                                           scam-410
      if (iv.eq.1) tq=tq*bz1*bz1                                        scam-411
   60 v(ic+4,icp)=v(ic+4,icp)+4.d0*tq                                   scam-412
   61 continue                                                          scam-413
   62 if (lo(55).and.lo(231)) write (mw,1000) aj,ip(jpi+1),nc,ncin      scam-414
c storage of the amplitudes                                             scam-415
      ni=nci-ncin                                                       scam-416
      do 70 i1=1,nci                                                    scam-417
      nt=ns+ik(1,2*md(i1,2),md(i1,3))*nct(nz+1)                         scam-418
      if (lo(231)) go to 63                                             scam-419
      j1=i1                                                             scam-420
      k1=j1                                                             scam-421
      go to 64                                                          scam-422
   63 j1=1                                                              scam-423
      k1=ncin                                                           scam-424
   64 ivs=0                                                             scam-425
      do 69 i2=1,nic                                                    scam-426
      iv=md(i2,1)                                                       scam-427
      if ((iv.ne.ivs).and.(iv.ne.1)) nt=nt+(ipi(2,ivs)*ipi(3,ivs)+nsy)/2scam-428
      nsy=mod(ipi(1,iv)+jpi+ipj+(ipi(2,iv)+ipi(3,iv))/2+1,2)            scam-429
      ivs=iv                                                            scam-430
      id=nt+ik(iv,2*md(i2,2),md(i2,3))+1                                scam-431
      if (lo(231).and.(i2.le.nci)) go to 65                             scam-432
      j2=i2-ni                                                          scam-433
      k2=j2                                                             scam-434
      go to 66                                                          scam-435
   65 j2=1                                                              scam-436
      k2=ncin                                                           scam-437
   66 ar=0.d0                                                           scam-438
      ai=0.d0                                                           scam-439
      do 68 l1=j1,k1                                                    scam-440
      a1=bz                                                             scam-441
      if (lo(231)) a1=a1*aa(i1,l1)                                      scam-442
      if (a1.eq.0.d0) go to 68                                          scam-443
      do 67 l2=j2,k2                                                    scam-444
      a2=1.d0                                                           scam-445
      if (lo(231).and.(l2.le.ncin)) a2=aa(i2,l2)                        scam-446
      if (a2.eq.0.d0) go to 67                                          scam-447
      ar=ar+far(l2,l1)*a1*a2                                            scam-448
      ai=ai+fai(l2,l1)*a1*a2                                            scam-449
   67 continue                                                          scam-450
   68 continue                                                          scam-451
      f(1,ipj,id)=ar                                                    scam-452
      f(2,ipj,id)=ai                                                    scam-453
      if (lo(155).or..not.lo(231)) go to 69                             scam-454
      a1=dsqrt(ar*ar+ai*ai)                                             scam-455
      a2=0.d0                                                           scam-456
      if (a1.ne.0.d0) a2=datan2(ai,ar)                                  scam-457
      fj=0.5d0*dfloat(md(i2,3))                                         scam-458
      write (mw,1002) i2,i1,iv,md(i2,2),fj,ar,ai,a1,a2                  scam-459
   69 continue                                                          scam-460
   70 continue                                                          scam-461
      if (lo(232)) return                                               scam-462
c compound nucleus                                                      scam-463
      jcx=jc+ni                                                         scam-464
      iiv=ipi(2,1)-1                                                    scam-465
      iii=ipi(3,1)-1                                                    scam-466
      do 81 ic=1,nci                                                    scam-467
      la=2*md(ic,2)                                                     scam-468
      ja=md(ic,3)                                                       scam-469
      nt=nss+ik(iv,la,ja)*nct(nz+5)                                     scam-470
      ivs=0                                                             scam-471
      call cocn(la,la,ja,ja,iii,iiv,naj,ipj,q,q(ipj+1),idt-2*ipj)       scam-472
      if (lo(231)) go to 71                                             scam-473
      j1=ic                                                             scam-474
      k1=j1                                                             scam-475
      go to 72                                                          scam-476
   71 j1=1                                                              scam-477
      k1=ncin                                                           scam-478
   72 do 80 icp=1,jcx                                                   scam-479
      if (lo(231).and.(icp.le.nci)) go to 73                            scam-480
      j2=icp-ni                                                         scam-481
      k2=j2                                                             scam-482
      go to 74                                                          scam-483
   73 j2=1                                                              scam-484
      k2=ncin                                                           scam-485
   74 ar=0.d0                                                           scam-486
      do 76 l1=j1,k1                                                    scam-487
      a1=bz                                                             scam-488
      if (lo(231)) a1=a1*aa(i1,l1)                                      scam-489
      if (a1.eq.0.d0) go to 79                                          scam-490
      do 75 l2=j2,k2                                                    scam-491
      a2=1.d0                                                           scam-492
      if (lo(231).and.(l2.gt.ncin)) a2=aa(i2,l2)                        scam-493
      if (a2.eq.0.d0) go to 75                                          scam-494
      ar=ar+v(l1+4,l2)*a1*a2                                            scam-495
   75 continue                                                          scam-496
   76 continue                                                          scam-497
      if (ar.eq.0.d0) go to 81                                          scam-498
      iv=idint(v(1,icp)/1048576.d0)                                     scam-499
      if ((iv.ne.ivs).and.(iv.ne.1)) nt=nt+(ipi(2,ivs)*ipi(3,ivs)+nsy)/2scam-500
      nsy=mod(ipi(1,iv)+jpi+ipj+(ipi(2,iv)+ipi(3,iv))/2+1,2)            scam-501
      ivs=iv                                                            scam-502
      tx(ncoll+iv+1)=tx(ncoll+iv+1)+ar*v(2,icp)*rz                      scam-503
      if (icp.gt.nc1) go to 79                                          scam-504
      lb=idint(v(1,icp)/512.d0)-2048*iv                                 scam-505
      jb=idint(v(1,icp))-1048576*iv-512*lb                              scam-506
      if (.not.lo(233)) go to 77                                        scam-507
      id=nt+ik(iv,lb,jb)+1                                              scam-508
      fcn(ipj,id)=fcn(ipj,id)+.25d0*ar                                  scam-509
   77 call cocn(lb,lb,jb,jb,ipi(3,iv)-1,ipi(2,iv)-1,naj,ipj,q(ipj+1),q(2scam-510
     1*ipj+1),idt-3*ipj)                                                scam-511
      if ((iv.eq.1).and.(iii.ne.0).and.(icp.ne.ic)) call cocn(la,lb,ja,jscam-512
     1b,ipi(3,iv)-1,ipi(2,iv)-1,naj,ipj,q(2*ipj+1),q(3*ipj+1),idt-4*ipj)scam-513
      do 78 ll=1,ipj                                                    scam-514
      ai=q(ll)*q(ll+ipj)                                                scam-515
      if ((iv.eq.1).and.(iii.ne.0).and.(icp.ne.ic)) ai=ai+q(ll+2*ipj)**2scam-516
   78 gcn(ll,iv)=gcn(ll,iv)+.25d0*ai*ar*xz                              scam-517
      go to 80                                                          scam-518
   79 if (.not.lo(233)) go to 80                                        scam-519
      j=iv+kba-ncols                                                    scam-520
      fcn(ipj,j)=fcn(ipj,j)+0.25d0*ar*v(2,icp)                          scam-521
   80 continue                                                          scam-522
   81 jcx=nc1+ni                                                        scam-523
      return                                                            scam-524
 1000 format (//' channel spin and parity =',f7.1,a1,i11,' coupled channscam-525
     1els and',i3,' solutions'//'  ic  icp n    l    j',19x,'c matrix',2scam-526
     20x,'|c|',6x,'phase')                                              scam-527
 1001 format (' c matrix larger than 1 for aj ipi nc ncin ic icp =',f5.1scam-528
     1,a1,4i3,2x,2d12.4)                                                scam-529
 1002 format (1x,i3,i4,i3,i5,f7.1,4x,1p,2d15.7,' i',4x,0p,2f11.8)       scam-530
 1003 format (1x,i3,i4,i3,i5,f7.1,4x,1p,2d15.7,' i',4x,'closed')        scam-531
 1004 format (/' transmission coefficients for channel spin and parity =scam-532
     1',f7.1,a1/4(' level   l     j',16x))                              scam-533
 1005 format (1x,f4.1,1x,a1,1x,i4)                                      scam-534
 1006 format (i3,i4,f6.1,2x,1p,d14.7,0p)                                scam-535
 1007 format (4(1x,i2,i4,f6.1,2x,1p,d14.7,0p,3x))                       scam-536
 1008 format (' error in eigensystem.  e-w correction discontinued')    scam-537
 1009 format (//' channel spin and parity =',f7.1, a1//'  ic  icp n    lscam-538
     1    j',9x,'tl',9x,'hf',11x,'nu',9x,'g')                           scam-539
 1010 format (' tl  in transformed channel space')                      scam-540
 1011 format (1x,i3,i4,i3,i5,f7.1,f12.6,d14.6,2f10.6)                   scam-541
 1012 format (15x,a8,f12.6,d14.6,f10.4,f10.6)                           scam-542
 1013 format (20x,'sum',f12.6)                                          scam-543
 1014 format (15x,'h.-f.',d20.6)                                        scam-544
      end                                                               scam-545
c 29/02/04                                                      ecis03  diag-000
      subroutine diag(n,nc,zr,zi,xr,xi,eps,ax,ier)                      diag-001
c diagonalisation of a hermitian complex matrix by an extension of the  diag-002
c jacobi's method                                                       diag-003
c input: zr,zi:  real and imaginary parts of the matrix                 diag-004
c        xr,xi:  real and imaginary parts of the unit matrix            diag-005
c        n:      first dimension of zr,zi,xr and xi                     diag-006
c        nc:     dimension of the matrix                                diag-007
c        eps:    value below which matrix elements are set to 0.        diag-008
c output:zr,zi:  the eigenvalues are on the diagonal of zr              diag-009
c                all the other elements are 0. if process succeeded     diag-010
c        xr,xi:  eigenvectors                                           diag-011
c        ax:     square of the norm of the largest non diagonal element diag-012
c        ier:    returns 0 or -1 after 4*nc**2 rotations                diag-013
c***********************************************************************diag-014
      implicit real*8 (a-h,o-z)                                         diag-015
      dimension zr(n,1),zi(n,1),xr(n,1),xi(n,1)                         diag-016
      ier=0                                                             diag-017
      nt=0                                                              diag-018
    1 nt=nt+1                                                           diag-019
      if (nt.gt.4*nc*nc) go to 6                                        diag-020
      ax=0.d0                                                           diag-021
      l=1                                                               diag-022
      m=2                                                               diag-023
c symmetrisation and search for the largest non diagonal element        diag-024
      do 3 i=1,nc                                                       diag-025
      do 2 j=i,nc                                                       diag-026
      if (zr(j,i).eq.0.d0) zr(i,j)=0.d0                                 diag-027
      if (zi(j,i).eq.0.d0) zi(i,j)=0.d0                                 diag-028
      if (zr(i,j).eq.0.d0) zr(j,i)=0.d0                                 diag-029
      if (zi(i,j).eq.0.d0) zi(j,i)=0.d0                                 diag-030
      ar=(zr(i,j)+zr(j,i))/2.d0                                         diag-031
      ai=(zi(i,j)-zi(j,i))/2.d0                                         diag-032
      zr(j,i)=ar                                                        diag-033
      zr(i,j)=ar                                                        diag-034
      zi(i,j)=ai                                                        diag-035
      zi(j,i)=-ai                                                       diag-036
      if (i.eq.j) go to 2                                               diag-037
      ay=zr(i,j)**2+zi(i,j)**2                                          diag-038
      if (ax.gt.ay) go to 2                                             diag-039
      ax=ay                                                             diag-040
      l=i                                                               diag-041
      m=j                                                               diag-042
    2 continue                                                          diag-043
    3 continue                                                          diag-044
      if (ax.eq.0.d0) return                                            diag-045
c elementary transformation                                             diag-046
      u=datan2(-zi(l,m),zr(l,m))/2.d0                                   diag-047
      v=datan2(2.d0*dsqrt(zr(l,m)**2+zi(l,m)**2),zr(m,m)-zr(l,l))/2.d0  diag-048
      uc=dcos(u)                                                        diag-049
      us=dsin(u)                                                        diag-050
      tc=dcos(v)                                                        diag-051
      ts=-dsin(v)                                                       diag-052
      ucc=uc*tc                                                         diag-053
      ucs=uc*ts                                                         diag-054
      usc=us*tc                                                         diag-055
      uss=us*ts                                                         diag-056
c transformation of rows                                                diag-057
      do 4 i=1,nc                                                       diag-058
      ar=xr(i,l)*ucc+xi(i,l)*usc+xr(i,m)*ucs-xi(i,m)*uss                diag-059
      br=-xr(i,l)*ucs-xi(i,l)*uss+xr(i,m)*ucc-xi(i,m)*usc               diag-060
      ai=xi(i,l)*ucc-xr(i,l)*usc+xi(i,m)*ucs+xr(i,m)*uss                diag-061
      bi=-xi(i,l)*ucs+xr(i,l)*uss+xi(i,m)*ucc+xr(i,m)*usc               diag-062
      xr(i,l)=ar                                                        diag-063
      xr(i,m)=br                                                        diag-064
      xi(i,l)=ai                                                        diag-065
      xi(i,m)=bi                                                        diag-066
      ar=zr(i,l)*ucc+zi(i,l)*usc+zr(i,m)*ucs-zi(i,m)*uss                diag-067
      br=-zr(i,l)*ucs-zi(i,l)*uss+zr(i,m)*ucc-zi(i,m)*usc               diag-068
      ai=zi(i,l)*ucc-zr(i,l)*usc+zi(i,m)*ucs+zr(i,m)*uss                diag-069
      bi=-zi(i,l)*ucs+zr(i,l)*uss+zi(i,m)*ucc+zr(i,m)*usc               diag-070
      zr(i,l)=ar                                                        diag-071
      zr(i,m)=br                                                        diag-072
      zi(i,l)=ai                                                        diag-073
    4 zi(i,m)=bi                                                        diag-074
c transformation of columns                                             diag-075
      do 5 i=1,nc                                                       diag-076
      ar=zr(l,i)*ucc-zi(l,i)*usc+zr(m,i)*ucs+zi(m,i)*uss                diag-077
      br=-zr(l,i)*ucs+zi(l,i)*uss+zr(m,i)*ucc+zi(m,i)*usc               diag-078
      ai=zi(l,i)*ucc+zr(l,i)*usc+zi(m,i)*ucs-zr(m,i)*uss                diag-079
      bi=-zi(l,i)*ucs-zr(l,i)*uss+zi(m,i)*ucc-zr(m,i)*usc               diag-080
      if (dabs(ar).lt.eps) ar=0.d0                                      diag-081
      if (dabs(br).lt.eps) br=0.d0                                      diag-082
      if (dabs(ai).lt.eps) ai=0.d0                                      diag-083
      if (dabs(bi).lt.eps) bi=0.d0                                      diag-084
      zr(l,i)=ar                                                        diag-085
      zr(m,i)=br                                                        diag-086
      zi(l,i)=ai                                                        diag-087
    5 zi(m,i)=bi                                                        diag-088
      go to 1                                                           diag-089
    6 ier=-1                                                            diag-090
      return                                                            diag-091
      end                                                               diag-092
c 29/02/04                                                      ecis03  sche-000
      subroutine sche(f,jmax,kmax,ipi,mt1,mt2,mf,tx,bm,mc,fa,xg,lmax1,wvsche-001
     1,kab,kba,kcb,jmin,ipj,ipk,fn,ncoll,ncols,nct,fgn,am,jit,jti,nlt,idsche-002
     21,xz,lo)                                                          sche-003
c scattering coefficients in the helicity representation                sche-004
c input variables: f:     s-matrix                                      sche-005
c                  jmax:  maximum number of channel spins, dim. for f   sche-006
c                  kmax:  maximum number of comp. nucl, dim. for fn     sche-007
c                  ipi(1,iv):   parity of channel                       sche-008
c                  ipi(2/3,iv): multiplicities of particle and target   sche-009
c                  ipi(4,iv):   product of charges                      sche-010
c                  ipi(6/7,iv): first/last channel number. see deph     sche-011
c                  ipi(11,iv):  maximum angular momentum                sche-012
c                  mt1,mt2: maximum 2*spin+1 for part. and target       sche-013
c                  mf:    helicity numbers. see deph                    sche-014
c                  tx:    total reaction cross section in mb            sche-015
c                         followed by the total cross section for each  sche-016
c                         level, the compound nucleus cross sections,   sche-017
c                         the fission and the gamma cross sections      sche-018
c                  xg:    coulomb phase-shifts                          sche-019
c                  lmax1: dimension for xg                              sche-020
c                  wv:    wave number and coulomb parameter.  see colf  sche-021
c                  kab:   dimension for fa                              sche-022
c                  kba:   number of independent amplitudes              sche-023
c                  kcb:   dimension for mc                              sche-024
c                  jmin:  twice minimum channel spin                    sche-025
c                  ipj:   number of the channel spin                    sche-026
c                  ipk:   number of l values for compound nucleus       sche-027
c                  fn:    compound nucleus contribution                 sche-028
c                  ncoll: number of coupled levels                      sche-029
c                  ncols: number of levels with angular distribution    sche-030
c                  nct:   number of equ. and solutions for each parity  sche-031
c                  fgn:   coeff. of legendre polynomials for comp. nuc. sche-032
c                  jit:   number of different rates of interpolation    sche-033
c                  jti:   limits and steps of interpolation             sche-034
c                  nlt:   memories needed for legendre polynomials      sche-035
c                  id1:   length available for bm as double precision   sche-036
c                  xz:    conversion factor to millibarns               sche-037
c                  lo:    logical controls. if lo(220)=.true., compute  sche-038
c                            only the square roots and legendre coeffi. sche-039
c in common /ncjl/ ncj:   number of factors 1/(-x*cos(theta))           sche-040
c in common /ncomp/nsp:   number of uncoupled states                    sche-041
c output variables:f:     helicity scattering coefficients              sche-042
c                  tx,fgn:with addition of interpolated values          sche-043
c working field:   am(mt1,mt2,kab) for products of c.g. coefficients    sche-044
c                  fa:    for storage of s-matrix for a given total spinsche-045
c                  mc:    nuclear state numbers and angular momenta     sche-046
c                  bm:    for factors 1/(-x*cos(theta)), 3j coeff., etc sche-047
c***********************************************************************sche-048
      implicit real*8 (a-h,o-z)                                         sche-049
      logical lo(250)                                                   sche-050
      dimension f(2,jmax,ipj),ipi(11,ncols),mf(10,1),tx(1),bm(9),mc(kcb,sche-051
     12,4),fa(2,kab,2),xg(lmax1,1),wv(18,1),fn(kmax,ipk),nct(6),am(mt1,msche-052
     2t2,2),jti(2,jit),fgn(kmax,1)                                      sche-053
      character*1 ip(2),ipp                                             sche-054
      common /ncjl/ ncj,nl(3)                                           sche-055
      common /ncomp/ nsp(3),nrd(9),acn(20)                              sche-056
      common /inout/ mr,mw,ms                                           sche-057
      data ip,pi,k2,k3,k4 /'+','-',3.1415926535d0,3*0/                  sche-058
      if (lo(220)) go to 60                                             sche-059
      if (lo(219)) return                                               sche-060
c tables of quantum numbers                                             sche-061
      ipd=1                                                             sche-062
      if (lo(223)) ipd=2                                                sche-063
      ipz=2*ipd                                                         sche-064
      ija=jmin-ipz                                                      sche-065
      iaj=ija                                                           sche-066
      do 4 jpi=1,2                                                      sche-067
      nc=0                                                              sche-068
      do 3 i=1,ncols                                                    sche-069
      nj1=ija-ipi(3,i)+1                                                sche-070
      nj=ipi(3,i)                                                       sche-071
      do 2 j=1,nj                                                       sche-072
      l1=nj1-ipi(2,i)+1                                                 sche-073
      nm=ipi(2,i)                                                       sche-074
      do 1 k=1,nm                                                       sche-075
      if (mod(l1+2*ipi(1,i)+2*(jpi+ipd),4).eq.0) go to 1                sche-076
      nc=nc+1                                                           sche-077
      mc(nc,jpi,1)=i                                                    sche-078
      mc(nc,jpi,2)=l1                                                   sche-079
      mc(nc,jpi,3)=nj1                                                  sche-080
    1 l1=l1+2                                                           sche-081
    2 nj1=nj1+2                                                         sche-082
    3 continue                                                          sche-083
    4 continue                                                          sche-084
      nxy=0                                                             sche-085
      if (lo(81).and.lo(182)) nxy=nsp(3)+2                              sche-086
      if (lo(143)) go to 38                                             sche-087
c interpolation for the s-matrix                                        sche-088
      rz=4.d0*pi*xz*ipd                                                 sche-089
      i1=0                                                              sche-090
      i4=0                                                              sche-091
c loop on parities                                                      sche-092
      do 17 j=1,2                                                       sche-093
      i2=i1+nct(j)                                                      sche-094
      i3=nct(j+2)                                                       sche-095
      i1=i1+1                                                           sche-096
      if (i1.gt.i2) go to 17                                            sche-097
c loop on solutions                                                     sche-098
      do 16 k=1,i3                                                      sche-099
      ji4=(3+max0(ipi(3,1)-1-iaj-mc(k,j,3),ipi(2,1)-1-mc(k,j,2)-mc(k,j,3sche-100
     1),-2*mc(k,j,2),-2*mc(k,j,3)))/4-ipd+1                             sche-101
      i6=0                                                              sche-102
c loop on s matrix elements                                             sche-103
      do 15 i=i1,i2                                                     sche-104
      i4=i4+1                                                           sche-105
      i6=i6+1                                                           sche-106
      iv=mc(i6,j,1)                                                     sche-107
      ji3=(3+max0(ipi(3,iv)-1-iaj-mc(i6,j,3),ipi(2,iv)-1-mc(i6,j,2)-mc(ische-108
     16,j,3),-2*mc(i6,j,2),-2*mc(i6,j,3)))/4-ipd+1                      sche-109
      ji1=max0(ji3,ji4)                                                 sche-110
      jt1=min0(ipj,ipi(10,1)-mc(k,j,2)/2,ipi(10,iv)-mc(i,j,2)/2)        sche-111
      n1=0                                                              sche-112
      n3=1                                                              sche-113
    5 if (n3.lt.ji1) go to 6                                            sche-114
      n1=n1+1                                                           sche-115
      k1=k2                                                             sche-116
      k2=k3                                                             sche-117
      k3=k4                                                             sche-118
      k4=n3                                                             sche-119
      if (n1.gt.3) go to 9                                              sche-120
    6 do 7 l=1,jit                                                      sche-121
      if (n3.le.jti(1,l)) go to 8                                       sche-122
    7 n3=n3+jti(2,l)*ipd                                                sche-123
      l=jit                                                             sche-124
    8 n3=n3+ipd                                                         sche-125
      if (n3.le.jt1) go to 5                                            sche-126
      if (n3.gt.jti(1,l)+jti(2,l)*ipd+ipd) go to 14                     sche-127
      go to 69                                                          sche-128
    9 ji2=k3-ipd                                                        sche-129
      if (n3.eq.jt1) ji2=k4-ipd                                         sche-130
      if (ji1.gt.ji2) go to 14                                          sche-131
      m1=(k1-k2)*(k1-k3)*(k1-k4)                                        sche-132
      m2=(k2-k1)*(k2-k3)*(k2-k4)                                        sche-133
      m3=(k3-k1)*(k3-k2)*(k3-k4)                                        sche-134
      m4=(k4-k1)*(k4-k2)*(k4-k3)                                        sche-135
      n2=1                                                              sche-136
      do 13 n4=ji1,ji2,ipd                                              sche-137
      if (n4.eq.k1.or.n4.eq.k2.or.n4.eq.k3.or.n4.eq.k4) go to 13        sche-138
      sz=rz*(2*n4+jmin-1)                                               sche-139
      if (n2.ne.1) go to 10                                             sche-140
      n2=3                                                              sche-141
      a2=f(1,k1,i4)**2+f(2,k1,i4)**2                                    sche-142
      b2=f(1,k2,i4)**2+f(2,k2,i4)**2                                    sche-143
      c2=f(1,k3,i4)**2+f(2,k3,i4)**2                                    sche-144
      d2=f(1,k4,i4)**2+f(2,k4,i4)**2                                    sche-145
      if (a2*b2*c2*d2.eq.0.d0) go to 10                                 sche-146
      a1=datan2(f(2,k1,i4),f(1,k1,i4))                                  sche-147
      b1=datan2(f(2,k2,i4),f(1,k2,i4))                                  sche-148
      c1=datan2(f(2,k3,i4),f(1,k3,i4))                                  sche-149
      d1=datan2(f(2,k4,i4),f(1,k4,i4))                                  sche-150
      if ((a1-b1)*(b1-c1).lt.0.d0.or.(b1-c1)*(c1-d1).lt.0.d0) go to 10  sche-151
      n2=2                                                              sche-152
      a2=dlog(a2)                                                       sche-153
      b2=dlog(b2)                                                       sche-154
      c2=dlog(c2)                                                       sche-155
      d2=dlog(d2)                                                       sche-156
   10 a3=dfloat((n4-k2)*(n4-k3)*(n4-k4))/dfloat(m1)                     sche-157
      b3=dfloat((n4-k1)*(n4-k3)*(n4-k4))/dfloat(m2)                     sche-158
      c3=dfloat((n4-k1)*(n4-k2)*(n4-k4))/dfloat(m3)                     sche-159
      d3=dfloat((n4-k1)*(n4-k2)*(n4-k3))/dfloat(m4)                     sche-160
      if (n2.eq.3) go to 11                                             sche-161
      a4=a1*a3+b1*b3+c1*c3+d1*d3                                        sche-162
      b4=dexp(0.5d0*(a2*a3+b2*b3+c2*c3+d2*d3))                          sche-163
      f(1,n4,i4)=b4*dcos(a4)                                            sche-164
      f(2,n4,i4)=b4*dsin(a4)                                            sche-165
      go to 12                                                          sche-166
   11 f(1,n4,i4)=f(1,k1,i4)*a3+f(1,k2,i4)*b3+f(1,k3,i4)*c3+f(1,k4,i4)*d3sche-167
      f(2,n4,i4)=f(2,k1,i4)*a3+f(2,k2,i4)*b3+f(2,k3,i4)*c3+f(2,k4,i4)*d3sche-168
   12 tx(iv+1)=tx(iv+1)+(f(1,n4,i4)**2+f(2,n4,i4)**2)*sz                sche-169
      if (i6.eq.k) tx(1)=tx(1)+f(2,n4,i4)*sz                            sche-170
   13 continue                                                          sche-171
   14 ji1=ji2+ipz                                                       sche-172
      if (ji1.lt.jt1) go to 6                                           sche-173
   15 continue                                                          sche-174
   16 continue                                                          sche-175
   17 i1=i2                                                             sche-176
      if (lo(181).or.(.not.lo(233))) go to 38                           sche-177
c interpolation for the compound nucleus                                sche-178
      i1=0                                                              sche-179
      i4=0                                                              sche-180
      do 37 j=1,3                                                       sche-181
      if (j.le.2) go to 18                                              sche-182
      if (nxy.eq.0) go to 37                                            sche-183
      i2=i1                                                             sche-184
      i3=nxy                                                            sche-185
      go to 19                                                          sche-186
   18 i2=i1+nct(j+4)                                                    sche-187
      i3=nct(j+2)                                                       sche-188
      i1=i1+1                                                           sche-189
   19 if (i1.gt.i2) go to 37                                            sche-190
      i6=0                                                              sche-191
c loop on solutions                                                     sche-192
      do 36 k=1,i3                                                      sche-193
      if (j.eq.3) go to 20                                              sche-194
      ji4=(3+max0(ipi(3,1)-1-iaj-mc(k,j,3),ipi(2,1)-1-mc(k,j,2)-mc(k,j,3sche-195
     1),-2*mc(k,j,2),-2*mc(k,j,3)))/4-ipd+1                             sche-196
   20 i6=0                                                              sche-197
c loop on s matrix elements                                             sche-198
      do 35 i=i1,i2                                                     sche-199
      i4=i4+1                                                           sche-200
      i6=i6+1                                                           sche-201
      ji1=1                                                             sche-202
      if (j.eq.3) go to 21                                              sche-203
      iv=mc(i6,j,1)                                                     sche-204
      ivl=iv+ncoll+1                                                    sche-205
      ji3=(3+max0(ipi(3,iv)-1-iaj-mc(i6,j,3),ipi(2,iv)-1-mc(i6,j,2)-mc(ische-206
     16,j,3),-2*mc(i6,j,2),-2*mc(i6,j,3)))/4-ipd+1                      sche-207
      ji1=max0(ji3,ji4)                                                 sche-208
      go to 22                                                          sche-209
   21 ivl=k+ncoll+ncols+1                                               sche-210
   22 nt=0                                                              sche-211
      jpj=0                                                             sche-212
      do 23 l=ji1,ipk                                                   sche-213
      if (dabs(fn(l,i4)).lt.1.d-15) go to 23                            sche-214
      nt=nt+1                                                           sche-215
      jpj=l                                                             sche-216
   23 continue                                                          sche-217
      nt=min0(nt,4)-1                                                   sche-218
      if (nt.lt.1) go to 35                                             sche-219
      n1=0                                                              sche-220
      n3=1                                                              sche-221
   24 if (n3.lt.ji1) go to 25                                           sche-222
      n1=n1+1                                                           sche-223
      k1=k2                                                             sche-224
      k2=k3                                                             sche-225
      k3=k4                                                             sche-226
      k4=n3                                                             sche-227
      if (n1.gt.nt) go to 28                                            sche-228
   25 do 26 l=1,jit                                                     sche-229
      if (n3.le.jti(1,l)) go to 27                                      sche-230
   26 n3=n3+jti(2,l)*ipd                                                sche-231
      l=jit                                                             sche-232
   27 n3=n3+ipd                                                         sche-233
      if (n3.le.jpj) go to 24                                           sche-234
      if (n3.gt.jti(1,l)+jti(2,l)*ipd+ipd) go to 34                     sche-235
   28 ji2=k3-ipd                                                        sche-236
      if (n3.eq.jpj) ji2=k4-ipd                                         sche-237
      if (ji1.gt.ji2) go to 34                                          sche-238
      do 33 n4=ji1,ji2,ipd                                              sche-239
      if (n4.eq.k1.or.n4.eq.k2.or.n4.eq.k3.or.n4.eq.k4) go to 33        sche-240
      sz=rz*(2*n4+jmin-1)                                               sche-241
      if (nt.lt.3) go to 29                                             sche-242
      a3=dfloat((n4-k2)*(n4-k3)*(n4-k4))/dfloat((k1-k2)*(k1-k3)*(k1-k4))sche-243
      b3=dfloat((n4-k1)*(n4-k3)*(n4-k4))/dfloat((k2-k1)*(k2-k3)*(k2-k4))sche-244
      c3=dfloat((n4-k1)*(n4-k2)*(n4-k4))/dfloat((k3-k1)*(k3-k2)*(k3-k4))sche-245
      d3=dfloat((n4-k1)*(n4-k2)*(n4-k3))/dfloat((k4-k1)*(k4-k2)*(k4-k3))sche-246
      fn(n4,i4)=dabs(fn(k1,i4)*a3+fn(k2,i4)*b3+fn(k3,i4)*c3+fn(k4,i4)*d3sche-247
     1)                                                                 sche-248
      go to 31                                                          sche-249
   29 if (nt.eq.1) go to 30                                             sche-250
      b3=dfloat((n4-k3)*(n4-k4))/dfloat((k2-k3)*(k2-k4))                sche-251
      c3=dfloat((n4-k2)*(n4-k4))/dfloat((k3-k2)*(k3-k4))                sche-252
      d3=dfloat((n4-k2)*(n4-k3))/dfloat((k4-k2)*(k4-k3))                sche-253
      fn(n4,i4)=dabs(fn(k2,i4)*b3+fn(k3,i4)*c3+fn(k4,i4)*d3)            sche-254
      go to 31                                                          sche-255
   30 c3=dfloat(n4-k4)/dfloat(k3-k4)                                    sche-256
      d3=dfloat(n4-k3)/dfloat(k4-k3)                                    sche-257
      fn(n4,i4)=abs(fn(k3,i4)*c3+fn(k4,i4)*d3)                          sche-258
   31 tx(ivl)=tx(ivl)+fn(n4,i4)*sz                                      sche-259
      if ((j.eq.3).or.(fn(n4,i4).eq.0.d0)) go to 33                     sche-260
      call cocn(mc(k,j,2)+ipz*n4,mc(k,j,2)+ipz*n4,mc(k,j,3)+ipz*n4,mc(k,sche-261
     1j,3)+ipz*n4,ipi(3,1)-1,ipi(2,1)-1,ija+ipz*n4,n4,bm,bm(n4+1),id1-n4sche-262
     2)                                                                 sche-263
      call cocn(mc(i6,j,2)+ipz*n4,mc(i6,j,2)+ipz*n4,mc(i6,j,3)+ipz*n4,mcsche-264
     1(i6,j,3)+ipz*n4,ipi(3,iv)-1,ipi(2,iv)-1,ija+ipz*n4,n4,bm(n4+1),bm(sche-265
     22*n4+1),id1-2*n4)                                                 sche-266
      if ((iv.eq.1).and.(ipi(3,1).gt.1).and.(k.ne.i6)) call cocn(mc(k,j,sche-267
     12)+ipz*n4,mc(i6,j,2)+ipz*n4,mc(k,j,3)+ipz*n4,mc(i6,j,3)+ipz*n4,ipische-268
     2(3,iv)-1,ipi(2,iv)-1,ija+ipz*n4,n4,bm(2*n4+1),bm(3*n4+1),id1-3*n4)sche-269
      do 32 ll=1,n4                                                     sche-270
      z=bm(ll)*bm(ll+n4)                                                sche-271
      if ((iv.eq.1).and.(ipi(3,1).gt.1).and.(k.ne.i6)) z=bm(ll+2*n4)**2+sche-272
     1z                                                                 sche-273
   32 fgn(ll,iv)=fgn(ll,iv)+z*fn(n4,i4)*xz                              sche-274
   33 continue                                                          sche-275
   34 ji1=ji2+ipz                                                       sche-276
      if (ji1.lt.jpj) go to 25                                          sche-277
   35 continue                                                          sche-278
   36 continue                                                          sche-279
   37 i1=i2                                                             sche-280
   38 ik=1                                                              sche-281
      npt=0                                                             sche-282
      do 57 ij=1,ipj,ipd                                                sche-283
c transfer of s matrix for a given angular momentum                     sche-284
      i1=0                                                              sche-285
      i4=0                                                              sche-286
      do 41 j=1,2                                                       sche-287
      i2=i1+nct(j+2)                                                    sche-288
      i1=i1+1                                                           sche-289
      if (i1.gt.i2) go to 41                                            sche-290
      i3=nct(j)                                                         sche-291
      do 40 i=i1,i2                                                     sche-292
      do 39 k=1,i3                                                      sche-293
      i4=i4+1                                                           sche-294
      fa(1,k,i)=f(1,ij,i4)                                              sche-295
   39 fa(2,k,i)=f(2,ij,i4)                                              sche-296
   40 continue                                                          sche-297
   41 i1=i2                                                             sche-298
      do 42 i=1,kba                                                     sche-299
      f(1,ij,i)=0.d0                                                    sche-300
   42 f(2,ij,i)=0.d0                                                    sche-301
      j1=0                                                              sche-302
      iaj=iaj+ipz                                                       sche-303
      aaj=iaj+1                                                         sche-304
      do 54 ji=1,2                                                      sche-305
      j2=j1+nct(ji+2)                                                   sche-306
      j1=j1+1                                                           sche-307
      if (j1.gt.j2) go to 54                                            sche-308
      nc1=0                                                             sche-309
      nc2=0                                                             sche-310
      nc=nct(ji)                                                        sche-311
c  geometric coefficient for the transformation to helicity coefficientssche-312
      do 48 ic=1,nc                                                     sche-313
      mc(ic,ji,2)=mc(ic,ji,2)+ipz                                       sche-314
      mc(ic,ji,3)=mc(ic,ji,3)+ipz                                       sche-315
      iv=mc(ic,ji,1)                                                    sche-316
      ni=ipi(2,iv)                                                      sche-317
      mi=ipi(3,iv)                                                      sche-318
      mc(ic,1,4)=min0(mc(ic,ji,3)-iabs(iaj+1-mi),mc(ic,ji,2)-iabs(mc(ic,sche-319
     1ji,3)+1-ni))                                                      sche-320
      if (mc(ic,ji,2).gt.2*ipi(10,iv)) mc(ic,1,4)=-1                    sche-321
      if (mc(ic,1,4).lt.0) go to 48                                     sche-322
      if (iv.eq.1) nc1=nc1+1                                            sche-323
      nc2=nc2+1                                                         sche-324
      a1=0.d0                                                           sche-325
      ym=mc(ic,ji,3)-ni+1                                               sche-326
      xb1=0.5d0*dfloat(ni**2+(mc(ic,ji,3)-mc(ic,ji,2))*(mc(ic,ji,2)+mc(ische-327
     1c,ji,3)+2)-1)                                                     sche-328
      c3=0.d0                                                           sche-329
c coupling for particle helicity                                        sche-330
      do 43 i1=1,ni                                                     sche-331
      bm(i1)=0.d0                                                       sche-332
      if (iabs(2*i1-ni-1).gt.mc(ic,ji,3)) go to 43                      sche-333
      n3=(mc(ic,ji,3)+2*i1-ni-1)*(mc(ic,ji,3)-2*i1+ni+3)*(i1-1)         sche-334
      if (n3.eq.0) bm(i1)=2*mod(i1,2)-1                                 sche-335
      if (n3.le.0) go to 43                                             sche-336
      c2=c3                                                             sche-337
      c3=dsqrt(dfloat((ni-i1+1)*(i1-1))*(ym+dfloat(2*i1-2))*(ym+dfloat(2sche-338
     1*ni-2*i1+2)))                                                     sche-339
      bm(i1)=(xb1-dfloat(2*i1-ni-3)**2)*bm(i1-1)/c3                     sche-340
      if (i1.ge.3) bm(i1)=bm(i1)-c2*bm(i1-2)/c3                         sche-341
   43 a1=a1+bm(i1)**2                                                   sche-342
      do 47 i1=1,ni                                                     sche-343
      a2=0.d0                                                           sche-344
      if (dabs(bm(i1)).lt.1.d-10) go to 45                              sche-345
      ia=2*i1-ni-1                                                      sche-346
      xb1=0.5d0*dfloat(mi**2+(iaj-mc(ic,ji,3))*(iaj+mc(ic,ji,3)+2)-1)   sche-347
      c3=0.d0                                                           sche-348
c coupling for target helicity                                          sche-349
      do 44 i2=1,mi                                                     sche-350
      bm(ni+i2)=0.d0                                                    sche-351
      if (iabs(2*i2-mi-1-ia).gt.iaj) go to 44                           sche-352
      n3=(iaj+ia-2*i2+mi+3)*(iaj-ia+2*i2-mi-1)*(i2-1)                   sche-353
      if (n3.eq.0) bm(ni+i2)=dfloat(2*mod(i2,2)-1)                      sche-354
      if (n3.le.0) go to 44                                             sche-355
      c2=c3                                                             sche-356
      ib=2*i2-mi-3                                                      sche-357
      c3=dsqrt(dfloat((mi-i2+1)*(i2-1))*(aaj**2-dfloat(2*i1-2*i2+mi-ni+1sche-358
     1)**2))                                                            sche-359
      bm(ni+i2)=((xb1-dfloat(ib*(ib-ia)))*bm(ni+i2-1)-c2*bm(ni+i2-2))/c3sche-360
   44 a2=a2+bm(ni+i2)**2                                                sche-361
      if (a2*a1.ne.0.d0) a2=dfloat(mod(1+mc(ic,ji,3)-iaj+mi,4)-1)*dsqrt(sche-362
     1aaj/(a1*a2))                                                      sche-363
   45 do 46 i2=1,mi                                                     sche-364
   46 am(i1,i2,ic)=bm(i1)*bm(ni+i2)*a2                                  sche-365
   47 continue                                                          sche-366
   48 continue                                                          sche-367
      if (nc1.eq.0) go to 54                                            sche-368
      ncin=nct(ji+2)                                                    sche-369
c transformation                                                        sche-370
      if (ik.ne.ij) go to 49                                            sche-371
      if (lo(156).and.lo(160)) go to 49                                 sche-372
      bj=.5d0*dfloat(iaj)                                               sche-373
      jij=1+mod(ij+ji,2)                                                sche-374
      nc1=nc1*nc2                                                       sche-375
      if (lo(56)) write (mw,1000) bj,ip(jij)                            sche-376
      npt=npt+1                                                         sche-377
      if (lo(60)) write (99,1001) bj,ip(jij),nc2,nc1                    sche-378
   49 nc1=0                                                             sche-379
      do 53 ic=1,ncin                                                   sche-380
      if (mc(ic,1,4).lt.0) go to 53                                     sche-381
      icx=ic                                                            sche-382
      nc1=nc1+1                                                         sche-383
      if (ji.eq.2) icx=icx+nct(3)                                       sche-384
      lci=mc(ic,ji,2)/2+1                                               sche-385
      nc2=0                                                             sche-386
      do 52 icp=1,nc                                                    sche-387
      if (mc(icp,1,4).lt.0) go to 52                                    sche-388
      lcp=mc(icp,ji,2)/2+1                                              sche-389
      iv=mc(icp,ji,1)                                                   sche-390
      nc2=nc2+1                                                         sche-391
      c1=xg(lci,1)+xg(lcp,iv)                                           sche-392
      if (ik.ne.ij) go to 50                                            sche-393
      if (lo(156).and.lo(160)) go to 50                                 sche-394
      b1=-2.d0*fa(2,icp,icx)                                            sche-395
      if (ic.eq.icp) b1=b1+1.d0                                         sche-396
      b2=2.d0*fa(1,icp,icx)                                             sche-397
      b3=dsqrt(b1**2+b2**2)                                             sche-398
      d1=0.d0                                                           sche-399
      if (b3.ne.0.d0) d1=datan2(b2,b1)                                  sche-400
      d2=dmod(d1+c1+pi,2.d0*pi)-pi                                      sche-401
      lc=lcp-1                                                          sche-402
      bj=0.5d0*dfloat(mc(icp,ji,3))                                     sche-403
      if (lo(56)) write (mw,1002) nc1,nc2,iv,lc,bj,b1,b2,b3,d1,d2       sche-404
      if (lo(60)) write (99,1003) nc1,nc2,iv,lc,bj,b1,b2,b3             sche-405
c multiplication by the coulomb phase                                   sche-406
   50 a1=dcos(c1)                                                       sche-407
      a2=dsin(c1)                                                       sche-408
      c2=fa(1,icp,icx)*a1-fa(2,icp,icx)*a2                              sche-409
      c3=fa(1,icp,icx)*a2+fa(2,icp,icx)*a1                              sche-410
      i1=ipi(6,iv)                                                      sche-411
      i2=ipi(7,iv)                                                      sche-412
c  helicity scattering coefficients                                     sche-413
      do 51 id=i1,i2                                                    sche-414
      mf1=mf(1,id)                                                      sche-415
      mf2=mf(2,id)                                                      sche-416
      mf3=mf(3,id)                                                      sche-417
      mf4=mf(4,id)                                                      sche-418
      c1=am(mf1,mf2,icp)*am(mf3,mf4,ic)                                 sche-419
      f(1,ij,id)=f(1,ij,id)+c2*c1                                       sche-420
   51 f(2,ij,id)=f(2,ij,id)+c3*c1                                       sche-421
   52 continue                                                          sche-422
   53 continue                                                          sche-423
   54 continue                                                          sche-424
      if (lo(143).or.ik.ne.ij) go to 56                                 sche-425
      do 55 l=1,jit                                                     sche-426
      if (ik.le.jti(1,l)) go to 56                                      sche-427
   55 ik=ik+jti(2,l)*ipd                                                sche-428
   56 ik=ik+ipd                                                         sche-429
   57 continue                                                          sche-430
      if (lo(160)) go to 60                                             sche-431
      write (60,1004) wv(1,1),wv(12,1),wv(2,1),ipi(4,1),npt             sche-432
      rewind 99                                                         sche-433
      do 59 i=1,npt                                                     sche-434
      read (99,1001) u1,ipp,k1,k2                                       sche-435
      write (60,1001) u1,ipp,k1,k2                                      sche-436
      do 58 k=1,k2                                                      sche-437
      read (99,1003) k1,k2,k3,k4,bj,b1,b2,b3                            sche-438
   58 write (60,1005) k1,k2,k3,k4,bj,b1,b2,b3                           sche-439
   59 continue                                                          sche-440
      close (99,status='delete')                                        sche-441
   60 if (lo(165)) go to 61                                             sche-442
      nsa=7*(nlt+2*ipj+1)+1                                             sche-443
      if (nsa.gt.id1) call memo('sche',id1,nsa,2)                       sche-444
      call lcsp(f,fgn,jmax,kmax,ipi,ncoll,ncols,mf,wv,jmin,ipj,ipj,xz,bmsche-445
     1,bm(nsa),id1-nsa,lo)                                              sche-446
   61 if (lo(220).or.lo(141)) return                                    sche-447
c elimination of factors 1/(1-x*cos(theta))                             sche-448
      ncj=min0(ncj,ipj-1)                                               sche-449
      if (ncj.eq.0) return                                              sche-450
      do 68 nj=1,ncj                                                    sche-451
      ipj=ipj-1                                                         sche-452
c loop on the independent amplitudes                                    sche-453
      do 67 k=1,kba                                                     sche-454
      if (mf(6,k).eq.99999) go to 62                                    sche-455
      m1=mf(5,k)                                                        sche-456
      m2=mf(6,k)                                                        sche-457
      m3=((iabs(m1+m2)+iabs(m1-m2))/2-jmin)/2+1                         sche-458
   62 b3=0.25d0*dfloat(m1*m2)                                           sche-459
      if (m3.gt.ipj) go to 70                                           sche-460
      d1=0.d0                                                           sche-461
      d2=0.d0                                                           sche-462
      mj=2*m3+jmin-2                                                    sche-463
      c3=0.5d0*dfloat(mj)                                               sche-464
      f1=dfloat((mj+m2)/2+1-m3)                                         sche-465
      f2=dfloat((mj-m2)/2+1-m3)                                         sche-466
      f3=dfloat((mj+m1)/2+1-m3)                                         sche-467
      f4=dfloat((mj-m1)/2+1-m3)                                         sche-468
      c1=0.d0                                                           sche-469
      b1=0.d0                                                           sche-470
      a1=0.d0                                                           sche-471
      b4=0.d0                                                           sche-472
c calc. of x which minimises the differences with a weight (j+1)**2     sche-473
c for the 5 last one                                                    sche-474
      npj=ipj-5                                                         sche-475
      do 63 i=m3,ipj                                                    sche-476
      fi=i                                                              sche-477
      a2=a1                                                             sche-478
      b2=b1                                                             sche-479
      a1=f(1,i,k)                                                       sche-480
      b1=f(2,i,k)                                                       sche-481
      c3=c3+1.d0                                                        sche-482
      c2=c1                                                             sche-483
      c1=dsqrt((f1+fi)*(f2+fi)*(f3+fi)*(f4+fi))/(c3*(2.d0*c3+1.d0))     sche-484
      if (b3.ne.0.d0) b4=b3/(c3*c3-c3)                                  sche-485
      bm(2*i-1)=a1*b4+a2*c2+f(1,i+1,k)*c1                               sche-486
      bm(2*i)=b1*b4+b2*c2+f(2,i+1,k)*c1                                 sche-487
      if (i.le.npj) go to 63                                            sche-488
      d1=d1+c3*c3*(f(1,i,k)*bm(2*i-1)+f(2,i,k)*bm(2*i))                 sche-489
      d2=d2+c3*c3*(bm(2*i-1)**2+bm(2*i)**2)                             sche-490
   63 c1=c1*(c3+c3+1.d0)/(c3+c3-1.d0)                                   sche-491
      a3=.9999999d0                                                     sche-492
      if (lo(18)) go to 64                                              sche-493
      if (d2.ne.0.d0) a3=d1/d2                                          sche-494
      a4=a3                                                             sche-495
c x is fixed between +1 and -1                                          sche-496
      if (a4.gt..9999999d0) a4=.9999999d0                               sche-497
      if (a4.lt.-.9999999d0) a4=-.9999999d0                             sche-498
c calculation of the new scattering coefficients                        sche-499
      go to 65                                                          sche-500
   64 a4=a3*dfloat(2*mod(nj,2)-1)                                       sche-501
   65 do 66 i=m3,ipj                                                    sche-502
      f(1,i,k)=f(1,i,k)-a4*bm(2*i-1)                                    sche-503
   66 f(2,i,k)=f(2,i,k)-a4*bm(2*i)                                      sche-504
      if (.not.lo(216)) write (mw,1006) k,a4,a3,f(1,ipj,k),f(2,ipj,k),f(sche-505
     11,ipj+1,k),f(2,ipj+1,k)                                           sche-506
      f(1,ipj+1,k)=a4                                                   sche-507
   67 continue                                                          sche-508
   68 continue                                                          sche-509
      return                                                            sche-510
   69 write (mw,1007) n1                                                sche-511
      go to 71                                                          sche-512
   70 write (mw,1008) nj                                                sche-513
   71 write (mw,1009)                                                   sche-514
      stop                                                              sche-515
 1000 format (//' channel spin and parity =',f7.1,a1//'  ic icp n    l  sche-516
     1  j',18x,'s matrix',20x,'|s|',7x,'phase /with coul.')             sche-517
 1001 format (1x,f4.1,1x,a1,1x,i4,1x,i4)                                sche-518
 1002 format (1x,3i3,i5,f7.1,4x,1p,2d15.7,' i',4x,0p,3f11.8)            sche-519
 1003 format (1x,3(i2,1x),i3,1x,f5.1,1x,2(d15.7,1x),5x,f11.8)           sche-520
 1004 format ('<s-matrix>',f10.2,f10.5,f10.2,2i5)                       sche-521
 1005 format (1x,3(i2,1x),i3,1x,f5.1,1x,2(d15.7,1x),'i',4x,f11.8)       sche-522
 1006 format (' amplitude =',i3,d15.7,' (',d15.7,')  new',2d15.7,3x,'oldsche-523
     1',2d15.7)                                                         sche-524
 1007 format (5x,i2,' amplitudes insufficient to interpolate')          sche-525
 1008 format (' amplitudes insufficient to factorise (1-cos)',i2,' timessche-526
     1')                                                                sche-527
 1009 format (' in sche  .... stop ....')                               sche-528
      end                                                               sche-529
c 29/02/04                                                      ecis03  cocn-000
      subroutine cocn(la,lb,ja,jb,iw,iv,ij,ip,rb,rc,nt)                 cocn-001
c computation of coefficient for angular distribution of compound       cocn-002
c nucleus cross-sections.                                               cocn-003
c input variables:  la,lb,ja,jb,iw,iv,ij: integer double values         cocn-004
c                   ip:   number of coefficients requested              cocn-005
c                   nt:   size of the working space rc                  cocn-006
c output variable:  rb:   in rb(i), value of                            cocn-007
c                ( ll  la  lb )  ( ja  jb  ll )  ( la  lb  ll )         cocn-008
c                (            )  )            (  )            (         cocn-009
c                (  0   0   0 )  ( ij  ij  iw )  ( jb  ja  iv )         cocn-010
c        * (2 ij + 1) * sqrt ((2 la + 1)(2 lb + 1)(2 ja + 1)(2 jb + 1)) cocn-011
c                         for even values of ll, from ll=0 with positivecocn-012
c                         or null value for ll=0                        cocn-013
c working space:    rc:   for all the non-zero 6-j coefficients with    cocn-014
c                         even and odd values of ll, starting with the  cocn-015
c                         largest value of ll in rc(2)                  cocn-016
c***********************************************************************cocn-017
      implicit real*8 (a-h,o-z)                                         cocn-018
      common /inout/ mr,mw,ms                                           cocn-019
      dimension rb(1),rc(1),j(5)                                        cocn-020
      ld=iabs(la-lb)                                                    cocn-021
      lp=(la+lb)/4+1                                                    cocn-022
      lm=ld/4+1                                                         cocn-023
      ad=dfloat(ld**2)                                                  cocn-024
      ap=dfloat(la+lb+2)**2                                             cocn-025
      jt=max0(ip,lp)                                                    cocn-026
      if (jt.gt.nt) go to 7                                             cocn-027
      ti=0.d0                                                           cocn-028
c recurrence computation of 3-j coefficients for even values of ll      cocn-029
      do 2 i=1,jt                                                       cocn-030
      al=dfloat(4*i-4)                                                  cocn-031
      rc(i)=0.d0                                                        cocn-032
      if (i.lt.lm.or.i.gt.lp) go to 2                                   cocn-033
      if (i.gt.lm) go to 1                                              cocn-034
      rc(i)=1.d0                                                        cocn-035
      go to 2                                                           cocn-036
    1 rc(i)=-rc(i-1)*dsqrt(((al-2.d0)**2-ad)*(ap-(al-2.d0)**2)/((al**2-acocn-037
     1d)*(ap-al**2)))                                                   cocn-038
    2 ti=ti+rc(i)**2*(al+1.d0)                                          cocn-039
      ti=dsqrt(ti)                                                      cocn-040
      do 3 i=1,ip                                                       cocn-041
    3 rb(i)=rc(i)                                                       cocn-042
c quantum numbers of the first 6-j coefficient                          cocn-043
      j(1)=la                                                           cocn-044
      j(2)=ja                                                           cocn-045
      j(3)=iv                                                           cocn-046
      j(4)=jb                                                           cocn-047
      j(5)=lb                                                           cocn-048
      do 5 k=1,2                                                        cocn-049
      ji=max0(iabs(j(1)-j(5)),iabs(j(2)-j(4)))                          cocn-050
      jf=min0(j(1)+j(5),j(2)+j(4))                                      cocn-051
      jt=(jf-ji)/2+2                                                    cocn-052
      if (jt.gt.nt) go to 7                                             cocn-053
      at=dfloat(jf+1)                                                   cocn-054
      call dx6j(rc,at,j,jt)                                             cocn-055
      ti=ti*dsqrt(at*dfloat(j(3)+1))                                    cocn-056
      do 4 i=1,ip                                                       cocn-057
      ll=4*i-4                                                          cocn-058
      lk=1                                                              cocn-059
      if (ll.ge.ji.and.ll.le.jf) lk=2+(jf-ll)/2                         cocn-060
      rb(i)=rc(lk)*rb(i)                                                cocn-061
    4 continue                                                          cocn-062
c quantum numbers of the second 6-j coefficient                         cocn-063
      j(1)=ij                                                           cocn-064
      j(3)=iw                                                           cocn-065
    5 j(5)=ij                                                           cocn-066
c normalisation                                                         cocn-067
      ti=dsqrt(dfloat(la+1)*dfloat(lb+1)*dfloat(ja+1)*dfloat(jb+1))*dflococn-068
     1at(ij+1)/ti                                                       cocn-069
      if (rb(1).lt.0.d0) ti=-ti                                         cocn-070
      do 6 i=1,ip                                                       cocn-071
    6 rb(i)=rb(i)*ti                                                    cocn-072
      return                                                            cocn-073
    7 write (mw,1000) nt,jt                                             cocn-074
      stop                                                              cocn-075
 1000 format (' working space too small in cocn:',i5,' available',i6,' rcocn-076
     1equested'/' ... stop ...')                                        cocn-077
      end                                                               cocn-078
c 29/02/04                                                      ecis03  lcsp-000
      subroutine lcsp(f,fcn,jmax,kmax,ipi,ncoll,ncols,mf,wv,jmin,ipj,ipklcsp-001
     1,xz,a,ax,id,lo)                                                   lcsp-002
c coefficients of legendre polynomials for cross-sections               lcsp-003
c scattering coefficients in the helicity representation                lcsp-004
c input variables: f:     s-matrix                                      lcsp-005
c                  fcn:   transmission coefficients                     lcsp-006
c                  jmax:  maximum number of channel spins, dim. for f   lcsp-007
c                  kmax:  maximum number l for comp. nuc., dim. for fcn lcsp-008
c                  ipi(2/3,iv): multiplicities of target and particle   lcsp-009
c                  ipi(6/7,iv): first/last channel number. see deph     lcsp-010
c                  ncoll: number of coupled levels                      lcsp-011
c                  ncols: number of levels with angular distribution    lcsp-012
c                  mf:    helicity numbers. see deph                    lcsp-013
c                  wv:    wave number and coulomb parameter.  see colf  lcsp-014
c                  jmin:  twice minimum channel spin                    lcsp-015
c                  ipj:   number of channel spin                        lcsp-016
c                  ipk:   number of channel spin for compound nucleus   lcsp-017
c                  xz:    10/((2*spin(1)+1)*(2*ai(1)+1))/k**2           lcsp-018
c                  id:    dimension of working field ax single precisionlcsp-019
c                  lo(18) =.true.  identical particle and target        lcsp-020
c                  lo(81) =.true.  compound nucleus                     lcsp-021
c in common /ncjl/ nl:    indications for expansion of cross-sections   lcsp-022
c                         in legendre polynomials                       lcsp-023
c working field:   a(7,*) amplitude multiplied by a legendre polynomial lcsp-024
c                         alternatively in a(1-2,*) and a(3-4,*)        lcsp-025
c                         coefficients of recurrence in a(5-7,*)        lcsp-026
c                  ax:    1 to jml  legendre coefficients of cross-sect.lcsp-027
c                         jml+1 to jmt    for compound nucleus          lcsp-028
c                         jmt+1 to jmx    product spin rotation matriceslcsp-029
c***********************************************************************lcsp-030
      implicit real*8 (a-h,o-z)                                         lcsp-031
      logical lo(250),ls                                                lcsp-032
      dimension f(2,jmax,1),fcn(kmax,1),ipi(11,1),mf(10,1),wv(18,1),at(2lcsp-033
     1),ndl(2),a(7,1),ax(1)                                             lcsp-034
      common /ncjl/ ncj,nl(3)                                           lcsp-035
      common /inout/ mr,mw,ms                                           lcsp-036
c determination of the number of legendre polynomials                   lcsp-037
      ndl(1)=nl(2)                                                      lcsp-038
      ndl(2)=nl(3)                                                      lcsp-039
      if (ndl(1).eq.0) ndl(1)=(6*ipj-3+3*jmin)/2                        lcsp-040
      if (ndl(2).eq.0) ndl(2)=2*ipj-1+jmin                              lcsp-041
      write (65,1000) wv(1,1),wv(12,1),wv(2,1),ipi(4,1),ncols           lcsp-042
      write (mw,1001)                                                   lcsp-043
c loop on levels                                                        lcsp-044
      do 35 jk=1,ncols                                                  lcsp-045
      if (wv(3,jk).lt.0.d0) go to 35                                    lcsp-046
      if (jk.gt.ncoll) go to 32                                         lcsp-047
      jk1=ipi(6,jk)                                                     lcsp-048
      jk2=ipi(7,jk)                                                     lcsp-049
      jml=ndl(2)                                                        lcsp-050
      ls=jk.eq.1.and.wv(5,1).ne.0.d0                                    lcsp-051
      if (ls) jml=ndl(1)                                                lcsp-052
      jmt=jml                                                           lcsp-053
      if (jmt.gt.id) call memo('lcsp',id,jmt,2)                         lcsp-054
      do 1 j=1,jmt                                                      lcsp-055
    1 ax(j)=0.d0                                                        lcsp-056
c loop on amplitudes                                                    lcsp-057
      do 29 i=jk1,jk2                                                   lcsp-058
      if (mf(6,i).eq.99999) go to 3                                     lcsp-059
      m1=mf(5,i)                                                        lcsp-060
      m2=mf(6,i)                                                        lcsp-061
      m3=((iabs(m1+m2)+iabs(m1-m2))/2-jmin)/2+1                         lcsp-062
      if (jk.gt.ncoll) go to 3                                          lcsp-063
      a1=0.25d0*dfloat(m1*m2)                                           lcsp-064
      mj=2*m3+jmin-2                                                    lcsp-065
      a2=0.5d0*dfloat(mj)                                               lcsp-066
      x1=dfloat((mj+m2)/2+1-m3)                                         lcsp-067
      x2=dfloat((mj-m2)/2+1-m3)                                         lcsp-068
      x3=dfloat((mj+m1)/2+1-m3)                                         lcsp-069
      x4=dfloat((mj-m1)/2+1-m3)                                         lcsp-070
      a(7,m3)=0.d0                                                      lcsp-071
c coefficients of the recurrence                                        lcsp-072
      jm1=jml+ipj                                                       lcsp-073
      jm=jm1+1                                                          lcsp-074
      if (m3.gt.jm1) go to 3                                            lcsp-075
      do 2 j=m3,jm1                                                     lcsp-076
      xj=dfloat(j)                                                      lcsp-077
      a2=a2+1.d0                                                        lcsp-078
      a(6,j)=0.d0                                                       lcsp-079
      if (a1.ne.0.d0) a(6,j)=a1/(a2*a2-a2)                              lcsp-080
      a(5,j)=dsqrt((x1+xj)*(x2+xj)*(x3+xj)*(x4+xj))/(a2*(2.d0*a2+1.d0)) lcsp-081
    2 a(7,j+1)=a(5,j)*(a2+a2+1.d0)/(a2+a2-1.d0)                         lcsp-082
    3 if (m3.gt.jm) go to 29                                            lcsp-083
      do 4 j=m3,jm                                                      lcsp-084
      a(1,j)=0.d0                                                       lcsp-085
      a(2,j)=0.d0                                                       lcsp-086
      a(3,j)=0.d0                                                       lcsp-087
      if (j.gt.ipj) go to 4                                             lcsp-088
      a(1,j)=f(1,j,i)                                                   lcsp-089
      a(2,j)=f(2,j,i)                                                   lcsp-090
    4 a(4,j)=0.d0                                                       lcsp-091
      if (.not.ls) go to 24                                             lcsp-092
c coulomb amplitude                                                     lcsp-093
      ns1=ipi(2,1)-1                                                    lcsp-094
      ns2=ipi(3,1)-1                                                    lcsp-095
      nsm=iabs(ns1-ns2)-jmin                                            lcsp-096
      nsp=ns1+ns2-jmin                                                  lcsp-097
      xs3=dfloat(ns1+ns2+2)                                             lcsp-098
      xs4=dfloat(ns1-ns2)                                               lcsp-099
      nst=nsp/2+1                                                       lcsp-100
      jmx=jmt+nst                                                       lcsp-101
      jmy=jmx+2                                                         lcsp-102
      if (lo(18)) jmy=jmy+2*nl(1)                                       lcsp-103
      if (jmy.gt.id) call memo('lcsp',id,jmy,2)                         lcsp-104
      do 5 j=1,nst                                                      lcsp-105
    5 ax(jmt+j)=1.d0                                                    lcsp-106
c reduced rotation matrix element                                       lcsp-107
      do 9 i1=1,2                                                       lcsp-108
      ms1=2*mf(2*i1-1,i)-ns1-2                                          lcsp-109
      ms2=ns2-2*mf(2*i1,i)+2                                            lcsp-110
      msp=iabs(ms1+ms2)-jmin                                            lcsp-111
      nsq=max0(nsm,msp)/2+1                                             lcsp-112
      xs=ms1+ms2                                                        lcsp-113
      at(i1)=1.d0                                                       lcsp-114
      if (nsq.eq.1) go to 7                                             lcsp-115
      do 6 j=2,nsq                                                      lcsp-116
    6 ax(jmt+j-1)=0.d0                                                  lcsp-117
    7 if (nsq.eq.nst) go to 9                                           lcsp-118
      ns=nsq+1                                                          lcsp-119
      a2=0.d0                                                           lcsp-120
      a1=1.d0                                                           lcsp-121
      b2=0.d0                                                           lcsp-122
      do 8 k=ns,nst                                                     lcsp-123
      a3=a2                                                             lcsp-124
      a2=a1                                                             lcsp-125
      b1=b2                                                             lcsp-126
      xj=dfloat(2*k+jmin-2)                                             lcsp-127
      b2=dsqrt((xj**2-xs**2)*(xs3**2-xj**2)*(xj**2-xs4**2)/(xj**2-1.d0))lcsp-128
     1/(2.d0*xj)                                                        lcsp-129
      b3=dfloat(ms1-ms2)                                                lcsp-130
      if (xj.ne.2.d0) b3=b3-xs*xs3*xs4/(xj*(xj-2.d0))                   lcsp-131
      a1=(a2*b3-a3*b1)/b2                                               lcsp-132
      ax(jmt+k)=ax(jmt+k)*a1                                            lcsp-133
    8 at(i1)=at(i1)+a1**2                                               lcsp-134
    9 continue                                                          lcsp-135
      ijx=nl(1)                                                         lcsp-136
      a3=1.d0                                                           lcsp-137
      jp=ipj                                                            lcsp-138
c multiplication by (1-cos), (1-cos**2) or their squares                lcsp-139
   10 do 12 ij=1,ijx                                                    lcsp-140
      a1=0.d0                                                           lcsp-141
      b1=0.d0                                                           lcsp-142
      do 11 j=m3,jp                                                     lcsp-143
      a2=a1                                                             lcsp-144
      b2=b1                                                             lcsp-145
      a1=a(1,j)                                                         lcsp-146
      b1=a(2,j)                                                         lcsp-147
      a(1,j)=a1-a3*(a(7,j)*a2+a(6,j)*a1+a(5,j)*a(1,j+1))                lcsp-148
   11 a(2,j)=b1-a3*(a(7,j)*b2+a(6,j)*b1+a(5,j)*a(2,j+1))                lcsp-149
      jp=jp+1                                                           lcsp-150
      a(1,jp)=-a3*a1*a(6,jp)                                            lcsp-151
   12 a(2,jp)=-a3*b1*a(6,jp)                                            lcsp-152
      a3=-a3                                                            lcsp-153
      if (lo(18).and.a3.lt.0.d0) go to 10                               lcsp-154
c initialisation of coulomb phase shifts                                lcsp-155
      c1=dsqrt(at(1)*at(2))                                             lcsp-156
      if (ax(jmx).lt.0.d0) c1=-c1                                       lcsp-157
      c2=dfloat(ijx)                                                    lcsp-158
      c3=2.d0**(ijx-1)                                                  lcsp-159
      do 23 ik=1,2                                                      lcsp-160
      nx=0                                                              lcsp-161
      nst1=nst                                                          lcsp-162
      do 13 j=1,nst                                                     lcsp-163
      a1=2.d0*ax(jmt+j)/c1*dfloat(1-mod(j+ik,2))                        lcsp-164
      if (a1.ne.0.d0) nx=nx+1                                           lcsp-165
   13 a(3,j)=a1                                                         lcsp-166
      if (nx.eq.0) go to 23                                             lcsp-167
      ax(jmx+1)=-c2*c3*wv(5,1)/(c2*c2+wv(5,1)**2)                       lcsp-168
      ax(jmx+2)=-c3*wv(5,1)**2/(c2*c2+wv(5,1)**2)                       lcsp-169
      if (lo(118)) go to 15                                             lcsp-170
      ax(jmx+1)=4.d0*c3*ax(jmx+1)                                       lcsp-171
      ax(jmx+2)=4.d0*c3*ax(jmx+2)                                       lcsp-172
      do 14 j=1,ijx                                                     lcsp-173
      a2=dfloat(j)*(dfloat(j+ijx)**2+wv(5,1)**2)                        lcsp-174
      a1=-dfloat(ijx-j+1)*(dfloat(ijx+j)*dfloat(ijx+j-1)+wv(5,1)**2)/a2 lcsp-175
      b1=dfloat(ijx-j+1)*wv(5,1)/a2                                     lcsp-176
      ax(jmx+2*j+1)=ax(jmx+2*j-1)*a1-ax(jmx+2*j)*b1                     lcsp-177
   14 ax(jmx+2*j+2)=ax(jmx+2*j-1)*b1+ax(jmx+2*j)*a1                     lcsp-178
   15 i1=3                                                              lcsp-179
      do 21 l=1,jm                                                      lcsp-180
      b1=2*l-1                                                          lcsp-181
c coulomb phase shift                                                   lcsp-182
      a1=ax(jmx+1)                                                      lcsp-183
      a2=ax(jmx+2)                                                      lcsp-184
      if (lo(118)) go to 17                                             lcsp-185
      do 16 j=1,ijx                                                     lcsp-186
      a1=a1+ax(jmx+2*j+1)                                               lcsp-187
   16 a2=a2+ax(jmx+2*j+2)                                               lcsp-188
   17 do 18 j=1,nst1                                                    lcsp-189
      if (lo(18).and.mod(l+ik,2).eq.1) go to 18                         lcsp-190
      a(1,j)=a(1,j)+a1*a(i1,j)*b1                                       lcsp-191
      a(2,j)=a(2,j)+a2*a(i1,j)*b1                                       lcsp-192
   18 continue                                                          lcsp-193
      i2=7-i1                                                           lcsp-194
      if (l.eq.jm) go to 21                                             lcsp-195
c product of rotation matrix elements by next pl                        lcsp-196
      b2=-(b1-1.d0)/(b1+1.d0)                                           lcsp-197
      b3=2.d0*b1/(b1+1.d0)                                              lcsp-198
      a1=0.d0                                                           lcsp-199
      do 19 j=m3,nst1                                                   lcsp-200
      a2=a1                                                             lcsp-201
      a1=a(i1,j)                                                        lcsp-202
      a(i2,j)=b2*a(i2,j)+(a(7,j)*a2+a(6,j)*a1+a(5,j)*a(i1,j+1))*b3      lcsp-203
      if (dabs(a(i2,j)).lt.1.d-10) a(i2,j)=0.d0                         lcsp-204
   19 continue                                                          lcsp-205
      if (nst1.ne.jm) a(i2,nst1+1)=a(7,nst1+1)*a1*b3                    lcsp-206
      nst1=min0(nst1+1,jm)                                              lcsp-207
      a1=(b1+1.d0)*wv(5,1)                                              lcsp-208
      b2=2.d0*c2                                                        lcsp-209
      a3=.25d0*(b1+1.d0+b2)**2+wv(5,1)**2                               lcsp-210
      a2=.25d0*(b1+1.d0-b2)*(b1+1.d0+b2)-wv(5,1)**2                     lcsp-211
      b3=(ax(jmx+1)*a2-ax(jmx+2)*a1)/a3                                 lcsp-212
      ax(jmx+2)=(ax(jmx+1)*a1+ax(jmx+2)*a2)/a3                          lcsp-213
      ax(jmx+1)=b3                                                      lcsp-214
      if (lo(118)) go to 21                                             lcsp-215
      do 20 j=1,ijx                                                     lcsp-216
      b2=b2+2.d0                                                        lcsp-217
      a3=.25d0*(b1+1.d0+b2)**2+wv(5,1)**2                               lcsp-218
      a2=.25d0*(b1+1.d0-b2)*(b1+1.d0+b2)-wv(5,1)**2                     lcsp-219
      b3=(ax(jmx+2*j+1)*a2-ax(jmx+2*j+2)*a1)/a3                         lcsp-220
      ax(jmx+2*j+2)=(ax(jmx+2*j+1)*a1+ax(jmx+2*j+2)*a2)/a3              lcsp-221
   20 ax(jmx+2*j+1)=b3                                                  lcsp-222
   21 i1=i2                                                             lcsp-223
      do 22 j=m3,jm                                                     lcsp-224
      a(3,j)=0.d0                                                       lcsp-225
   22 a(4,j)=0.d0                                                       lcsp-226
   23 continue                                                          lcsp-227
   24 b3=jmin+2*m3-1                                                    lcsp-228
      i1=1                                                              lcsp-229
      i2=3                                                              lcsp-230
c coefficient of other pl                                               lcsp-231
      do 28 l=1,jml                                                     lcsp-232
      a3=0.d0                                                           lcsp-233
      c1=b3                                                             lcsp-234
      if (lo(18).and.mod(l,2).ne.1) go to 26                            lcsp-235
      do 25 j=m3,ipj                                                    lcsp-236
      a3=a3+(f(1,j,i)*a(i1,j)+f(2,j,i)*a(i1+1,j))/c1                    lcsp-237
   25 c1=c1+2.d0                                                        lcsp-238
      if (mf(8,i).ne.0.) a3=a3+a3                                       lcsp-239
      ax(l)=ax(l)+a3*xz                                                 lcsp-240
   26 if (l.eq.jml) go to 28                                            lcsp-241
      c1=dfloat(l)                                                      lcsp-242
      c2=-(c1-1.d0)/c1                                                  lcsp-243
      c3=(2.d0*c1-1.d0)/c1                                              lcsp-244
      i1=i2                                                             lcsp-245
      i2=4-i1                                                           lcsp-246
      a1=0.d0                                                           lcsp-247
      b1=0.d0                                                           lcsp-248
      do 27 j=m3,jm1                                                    lcsp-249
      a2=a1                                                             lcsp-250
      b2=b1                                                             lcsp-251
      a1=a(i2,j)                                                        lcsp-252
      b1=a(i2+1,j)                                                      lcsp-253
      a(i1,j)=c2*a(i1,j)+(a(7,j)*a2+a(6,j)*a1+a(5,j)*a(i2,j+1))*c3      lcsp-254
   27 a(i1+1,j)=c2*a(i1+1,j)+(a(7,j)*b2+a(6,j)*b1+a(5,j)*a(i2+1,j+1))*c3lcsp-255
      a(i1,jm)=a(7,jm)*a1*c3                                            lcsp-256
      a(i1+1,jm)=a(7,jm)*b1*c3                                          lcsp-257
   28 continue                                                          lcsp-258
   29 continue                                                          lcsp-259
      write (65,1002) jk,jml                                            lcsp-260
      if (ls) write (mw,1003) jk,ijx,jml                                lcsp-261
      if (.not.ls) write (mw,1004) jk,jml                               lcsp-262
      do 30 ll=1,jml,5                                                  lcsp-263
      l=ll-1                                                            lcsp-264
      lm=min0(jml,ll+4)                                                 lcsp-265
   30 write (mw,1005) l,(ax(m),m=ll,lm)                                 lcsp-266
      do 31 ll=1,jml                                                    lcsp-267
      l=ll-1                                                            lcsp-268
      if (ls) write (65,1006) jk,l,ax(ll),ijx                           lcsp-269
      if (.not.ls) write (65,1007) jk,l,ax(ll)                          lcsp-270
   31 continue                                                          lcsp-271
   32 if (lo(181)) go to 35                                             lcsp-272
      write (65,1008) jk,ipk                                            lcsp-273
      write (mw,1009) jk,ipk                                            lcsp-274
      do 33 ll=1,ipk,5                                                  lcsp-275
      l=2*ll-2                                                          lcsp-276
      lm=min0(ipk,ll+4)                                                 lcsp-277
   33 write (mw,1005) l,(fcn(m,jk),m=ll,lm)                             lcsp-278
      do 34 ll=1,ipk                                                    lcsp-279
      l=2*ll-2                                                          lcsp-280
   34 write (65,1010) jk,l,fcn(ll,jk)                                   lcsp-281
   35 continue                                                          lcsp-282
      return                                                            lcsp-283
 1000 format ('<legendre>',f10.2,f10.5,f10.2,2i5)                       lcsp-284
 1001 format ('1 coefficients of legendre polynomials describing the crolcsp-285
     1ss-sections')                                                     lcsp-286
 1002 format (2i5,' coupled level, number of values')                   lcsp-287
 1003 format (/' direct interaction for level',i2,' multiplied by (1-coslcsp-288
     1(theta))**(',i2,' )',i4,' coefficients'/4x,'l',8x,'c(l)',14x,'c(l+lcsp-289
     21)',13x,'c(l+2)',13x,'c(l+3)',13x,'c(l+4)')                       lcsp-290
 1004 format (/' direct interaction for level',i2,',',i4,' coefficients'lcsp-291
     1/4x,'l',8x,'c(l)',14x,'c(l+1)',13x,'c(l+2)',13x,'c(l+3)',13x,'c(l+lcsp-292
     24)')                                                              lcsp-293
 1005 format (i5,1p,5d19.10)                                            lcsp-294
 1006 format (2i5,1p,d20.10,5x,'*(1-cos(theta)**(',i2,' )')             lcsp-295
 1007 format (2i5,1p,d20.10)                                            lcsp-296
 1008 format (2i5,' uncoupled level, number of values')                 lcsp-297
 1009 format (/' compound nucleus for level',i2,',',i4,' coefficients (olcsp-298
     1nly even ones are given)'/4x,'l',8x,'c(l)',14x,'c(l+2)',13x,'c(l+4lcsp-299
     2)',13x,'c(l+6)',13x,'c(l+8)')                                     lcsp-300
 1010 format (2i5,1p,d20.10,5x,'compound nucleus')                      lcsp-301
      end                                                               lcsp-302
c 29/02/04                                                      ecis03  resu-000
      subroutine resu(ipi,sr,tx,jmax,kmax,ncoll,ncols,mf,cm,mfm,fm,ipj,iresu-001
     1pk,donn,ncolr,nco,coe,wv,wvm,fcn,noi,xd,jmin,nrz,njc,res,am,      resu-002
     2ex,the,dxx,spg,cmb,xz,nzz,lo)                                     resu-003
c computes cross-sections and polarisations - compare to experimental   resu-004
c results -   obtains experimental normalisations and partial chi2      resu-005
c input variables: ipi(j,i):parity of the nuclear states (+/-) for j=1, resu-006
c                           multiplicity of particle and target j=2,3,  resu-007
c                           first/last ampl. and observable for each    resu-008
c                           level for j=6 to 9. (see calx)              resu-009
c                  sr:      helicity scattering coefficients            resu-010
c                  tx:      inelastic cross-sections in millibarns      resu-011
c                           followed by hauser-feshbach coefficients    resu-012
c                  jmax:    maximum number of channel spins             resu-013
c                  kmax:    maximum number of l for compound nucleus    resu-014
c                  ncoll:   number of coupled channels                  resu-015
c                  ncols:   number of channels with angular distributionresu-016
c                  mf,cm:   tables of helicity, description of observa- resu-017
c                           bles ... etc     see deph and obse          resu-018
c                  mfm,fm:  description of experimental data   see lecd resu-019
c                  ipj:     number of channel spins used                resu-020
c                  ipk:     number of l for compound nucleus            resu-021
c                  donn:    experimental data:angle, value, exper. errorresu-022
c                           ,ang. width, ang. error and calculated errorresu-023
c                  ncolr:   number of experimental angular distributionsresu-024
c                  nco,coe: indications for observables     see obse    resu-025
c                  wv(i,j): wave number and coulomb parameter           resu-026
c                  wvm:     same as wv for the continuum                resu-027
c                  fcn:     compound nucleus coefficients               resu-028
c                  ncont:   number of continua for compound nucleus     resu-029
c                  noi:     starting and final addresses for continua   resu-030
c                  xd:      energy step for the continua                resu-031
c                  jmin:    twice minimum channel spin                  resu-032
c                  nrz:     length of sr+tx to be saved for minimum chi2resu-033
c                  njc:     first dimension of working array ex         resu-034
c                  cmb:     nuclear mass divided by h bar               resu-035
c                  xz:      conversion factor to millibarns             resu-036
c                  nzz:     total length of working field,returns space resu-037
c                           used. (single precision)                    resu-038
c                  lo(8)    is true for relativistic kinematics         resu-039
c                  lo(31)   is true for experimental data               resu-040
c                  lo(32)   is true for automatic search                resu-041
c                  lo(33)   is true for symmetrised chi2                resu-042
c                  lo(59)   is true to print results on files 58 and 59 resu-043
c                  lo(64)   is true to print results on files 64 and 66 resu-044
c                  lo(66)   is true for results at equidistant angles   resu-045
c                  lo(67)   is true for no plot of experimental data    resu-046
c                  lo(68)   is true for no plot of equidistant c.-s.    resu-047
c                  lo(69)   is true for no plot of equidistant polar.   resu-048
c                  lo(74)   is true to print intermediate elapsed time  resu-049
c                  lo(81)   is true for compound nucleus                resu-050
c                  lo(84)   is true for uncoupled levels                resu-051
c                  lo(85)   is true for fission                         resu-052
c                  lo(86)   is true for gamma emission                  resu-053
c                  lo(91)   is true for angles in the laboratory system resu-054
c                  lo(216)  is true for no output                       resu-055
c                  lo(218)  is true for last results                    resu-056
c                  lo(226)  is true for some observables in the lab. sy.resu-057
c output variables:res:     difference between experimental and calcula-resu-058
c                           ted value divided by error (function of fiteresu-059
c in common /dchi/ chi2:    (calculated in resu)                        resu-060
c                  chi2m:   smaller previous chi2                       resu-061
c in common /ncomp/nsp:     number of uncoupled states for comp. nucleusresu-062
c                  ndp:     address of fission and gamma results        resu-063
c working space:   am:      for general purposes                        resu-064
c                  ex:      for observables                             resu-065
c                  the,dxx,spg  for plots                               resu-066
c informations are also in labelled common /titr/ title: head of output resu-067
c   in common /angl/                                                    resu-068
c        theta1,theta2,dtheta,dthe for calculation at equidistant anglesresu-069
c   in common /sjmm/ jmm:   save ipj,ipk for minimum chi2               resu-070
c   in common /ncjl/ ncj:   for elimination of factors 1/(1-x*cos(theta)resu-071
c the common /resc/ is used to transfer informations to scat            resu-072
c    see description in scat                                            resu-073
c internal logical lt(3):                                               resu-074
c          lt(1) is .true. for cross-section in millibarns              resu-075
c          lt(2) is .true. for symmetrised chi2, cross-section and      resu-076
c                normalisation error                                    resu-077
c          lt(3) is .true. for graph of polarisation                    resu-078
c          lkt is .false. for angle in the laboratory system            resu-079
c***********************************************************************resu-080
      implicit real*8 (a-h,o-z)                                         resu-081
      logical lo(250),lt(3),lkt                                         resu-082
      dimension ipi(11,1),sr(2,jmax,1),tx(2),mfm(14,ncolr),fm(7,ncolr),mresu-083
     1f(10,1),donn(6,1),nco(1),coe(1),wv(18,1),wvm(18,1),fcn(kmax,1),noiresu-084
     2(2,1),xd(3,1),res(1),am(1),ex(njc,4),the(1),dxx(1),spg(1),zx(3),zyresu-085
     3(3),sp(6)                                                         resu-086
      character*1 sigm(2)                                               resu-087
      character*4 lg(10),title,cm(10,1)                                 resu-088
      common /titr/ title(18)                                           resu-089
      common /angl/ theta1,theta2,dtheta,dthe                           resu-090
      common /ncjl/ ncj,nl(3)                                           resu-091
      common /sjmm/ jmm(2)                                              resu-092
      common /resc/ excn,xa,xb,jn1,jn2,ntt,mtt,mt2,mt3,mt4,nout,nix,nfx,resu-093
     1klt,lkt                                                           resu-094
      common /dchi/ chi2,chi2m,yy(3)                                    resu-095
      common /ncomp/ nsp(3),nrd(2),ncont,ncoj,ncons,nie,ncolx,ndp,ndq,acresu-096
     1n(20)                                                             resu-097
      common /inout/ mr,mw,ms                                           resu-098
      data sigm,lg,i3,i4,i5,i7,lt /'+','-',' com','poun','d nu','cleu','resu-099
     1s ',2*'    ','   d','irec','t ',4*0,3*.false./                    resu-100
      nesp=0                                                            resu-101
      mt3=ipi(2,1)                                                      resu-102
      mt4=ipi(3,1)                                                      resu-103
      if (.not.lo(218)) go to 2                                         resu-104
c copy the scattering coefficients obtained for minimum chi2            resu-105
      ipj=jmm(1)                                                        resu-106
      ipk=jmm(2)                                                        resu-107
      do 1 i=1,nrz                                                      resu-108
    1 sr(i,1,1)=sr(i+nrz,1,1)                                           resu-109
    2 if (lo(131)) go to 29                                             resu-110
c calculation at experimental angles                                    resu-111
      klt=1                                                             resu-112
      chi2=0.d0                                                         resu-113
      nout=0                                                            resu-114
      if (lo(64)) write (64,1000) wv(1,1),wv(12,1),wv(2,1),ipi(4,1),ncolresu-115
     1r                                                                 resu-116
      ki=ipi(9,ncoll)                                                   resu-117
      ji=1                                                              resu-118
      ka=0                                                              resu-119
c pseudo loop on the angular distributions                              resu-120
    3 aa=0.d0                                                           resu-121
      bb=0.d0                                                           resu-122
      cc=0.d0                                                           resu-123
      nix=ki+ji                                                         resu-124
      nfx=nix                                                           resu-125
      lt(1)=mf(2,nix).eq.0                                              resu-126
      lt(2)=lo(33).and.((iabs(mf(2,nix)).le.1.or.mf(2,nix).eq.19).and.fmresu-127
     1(5,ji).eq.0.d0)                                                   resu-128
      jim=ji                                                            resu-129
      jin=ji                                                            resu-130
    4 j1=mfm(2,ji)                                                      resu-131
      j2=mfm(3,ji)                                                      resu-132
      lkt=mfm(4,ji).ne.1                                                resu-133
      if (j2.ge.j1) go to 5                                             resu-134
      ji=ji+1                                                           resu-135
      go to 4                                                           resu-136
    5 jif=ji                                                            resu-137
      j=j1                                                              resu-138
c pseudo loop on the experimental data                                  resu-139
    6 donn(6,j)=donn(3,j)                                               resu-140
      kc=1                                                              resu-141
      theta=donn(1,j)                                                   resu-142
    7 ji=jim                                                            resu-143
      zx(kc)=0.d0                                                       resu-144
      zy(kc)=0.d0                                                       resu-145
      if (mf(2,ki+ji).ne.19) go to 63                                   resu-146
c data are total cross sections                                         resu-147
      i=idint(donn(1,j)*1.000001d0)                                     resu-148
      if (i.gt.ncolx-ncont) go to 8                                     resu-149
      if (i.eq.-1) zx(1)=tx(1)                                          resu-150
      if (i.eq.0) zx(1)=tx(1)-tx(2)                                     resu-151
      if (i.eq.0.and.ncoll.ne.ncolx) zx(1)=zx(1)-tx(ncoll+2)            resu-152
      if (i.le.0) go to 18                                              resu-153
      k=max0(i,1)+1+ncoll                                               resu-154
      zx(1)=0.d0                                                        resu-155
      if (ncoll.ne.ncolx) zx(1)=tx(ncoll+i+1)                           resu-156
      if (i.le.ncoll) zx(1)=zx(1)+tx(i+1)                               resu-157
      go to 18                                                          resu-158
    8 if (i.gt.ncolx) go to 10                                          resu-159
      ik=ncoll+ncolx-ncont+1                                            resu-160
      ii=i+ncont-ncolx                                                  resu-161
      ij=noi(1,ii)                                                      resu-162
      ji=noi(2,ii)                                                      resu-163
      zx(1)=0.d0                                                        resu-164
      if (ij.gt.ji) go to 18                                            resu-165
      do 9 ii=ij,ji                                                     resu-166
    9 zx(1)=zx(1)+tx(ik+ii)                                             resu-167
      go to 18                                                          resu-168
   10 zx(1)=tx(ndp+i-ncolx)                                             resu-169
      go to 18                                                          resu-170
   11 if (lt(1)) ex(2,kc)=1.d0                                          resu-171
      zx(kc)=(zx(kc)*zy(kc)+ex(2,kc)*ex(1,kc))/(zy(kc)+ex(1,kc))        resu-172
      zy(kc)=zy(kc)+ex(1,kc)                                            resu-173
      if (ji.eq.jif) go to 12                                           resu-174
      ji=ji+1                                                           resu-175
      go to 63                                                          resu-176
   12 if (lt(1)) zx(kc)=zx(kc)*zy(kc)                                   resu-177
      go to ( 13 , 14 , 15 ),kc                                         resu-178
   13 if (donn(4,j).eq.0.d0) go to 18                                   resu-179
      kc=2                                                              resu-180
      theta=donn(1,j)-donn(4,j)                                         resu-181
      go to 7                                                           resu-182
   14 kc=3                                                              resu-183
      theta=donn(1,j)+donn(4,j)                                         resu-184
      go to 7                                                           resu-185
   15 if (lt(1)) go to 16                                               resu-186
      zx(1)=(zx(1)*zy(1)+zx(2)*zy(2)+zx(3)*zy(3))/(zy(1)+zy(2)+zy(3))   resu-187
      go to 17                                                          resu-188
   16 zx(1)=(zx(1)+zx(2)+zx(3))/3.d0                                    resu-189
   17 if (donn(5,j).ne.0.d0) donn(6,j)=dsqrt(donn(3,j)*donn(3,j)+((zx(2)resu-190
     1-zx(3))*donn(2,j)*donn(5,j)/(2.d0*donn(4,j)*zx(1)))**2)           resu-191
   18 res(j)=zx(1)                                                      resu-192
      if (lt(2)) donn(6,j)=donn(6,j)*dsqrt(fm(4,ji)*res(j)/donn(2,j))   resu-193
      xc=donn(6,j)**2/fm(3,ji)                                          resu-194
      aa=aa+res(j)**2/xc                                                resu-195
      bb=bb+res(j)*donn(2,j)/xc                                         resu-196
      cc=cc+donn(2,j)**2/xc                                             resu-197
      j=j+1                                                             resu-198
c end of the pseudo loop on experimental data                           resu-199
      if (j.le.j2) go to 6                                              resu-200
c computation of normalisation and chi2                                 resu-201
      if (fm(5,ji).eq.0.d0) go to 21                                    resu-202
      xa=fm(3,ji)/fm(5,ji)**2                                           resu-203
      aa=aa+xa                                                          resu-204
      xb=fm(4,ji)                                                       resu-205
      bb=bb+xa*xb                                                       resu-206
      cc=cc+xa*xb*xb                                                    resu-207
      if (ji.eq.ncolr) go to 19                                         resu-208
      if (fm(4,ji).ne.fm(4,ji+1).or.fm(5,ji).ne.fm(5,ji+1)) go to 19    resu-209
      if ((2*iabs(mf(2,nix))-3)*(2*iabs(mf(2,nix+1))-3).lt.0) go to 19  resu-210
      ji=ji+1                                                           resu-211
      jim=ji                                                            resu-212
      go to 4                                                           resu-213
   19 if (lt(2)) go to 20                                               resu-214
      fm(6,ji)=bb/aa                                                    resu-215
      go to 22                                                          resu-216
   20 fm(6,ji)=dsqrt(cc/aa)                                             resu-217
      go to 22                                                          resu-218
   21 fm(6,ji)=fm(4,ji)                                                 resu-219
   22 do 27 jj=jin,ji                                                   resu-220
      nix=ki+jj                                                         resu-221
      j1=mfm(2,jj)                                                      resu-222
      j2=mfm(3,jj)                                                      resu-223
      j3=j2-j1+1                                                        resu-224
      if (lo(64)) write (64,1001) (mf(j,nix),j=1,2),j3,(cm(j,nix),j=6,10resu-225
     1)                                                                 resu-226
      if (j3.le.0) go to 27                                             resu-227
      if (jj.ne.ji) fm(6,jj)=fm(6,ji)                                   resu-228
      if (lo(216)) go to 23                                             resu-229
c output of the calculated and the experimental values                  resu-230
      m=0                                                               resu-231
      write (mw,1002) title                                             resu-232
      if (mf(2,nix).ne.19) write (mw,1003) mfm(1,jj)                    resu-233
      write (mw,1004) (cm(j,nix),j=6,10)                                resu-234
   23 a1=fm(6,jj)                                                       resu-235
      a6=dsqrt(fm(3,jj))                                                resu-236
      aa=0.d0                                                           resu-237
      if (fm(5,jj).eq.0.d0) go to 24                                    resu-238
      a2=(a1-fm(4,jj))/fm(5,jj)                                         resu-239
      aa=a2**2                                                          resu-240
      res(j2+1)=a2*a6                                                   resu-241
      chi2=chi2+res(j2+1)**2                                            resu-242
   24 do 26 j=j1,j2                                                     resu-243
      a2=donn(2,j)/a1                                                   resu-244
      a3=donn(6,j)/a1                                                   resu-245
      a4=((res(j)-a2)/a3)**2                                            resu-246
      if (lo(216)) go to 25                                             resu-247
      m=m+1                                                             resu-248
      a5=donn(3,j)/a1                                                   resu-249
      the(m)=donn(1,j)                                                  resu-250
      dxx(m)=a2                                                         resu-251
      spg(m)=res(j)                                                     resu-252
      write (mw,1005) donn(1,j),res(j),a2,a5,a3,a4                      resu-253
      if (lo(64)) write (64,1005) donn(1,j),res(j),a2,a5,a3,a4          resu-254
   25 aa=aa+a4                                                          resu-255
      res(j)=(res(j)-a2)*a6/a3                                          resu-256
   26 chi2=chi2+res(j)**2                                               resu-257
      fm(7,jj)=aa                                                       resu-258
      if (lo(216)) go to 27                                             resu-259
      write (mw,1006) (fm(j,jj),j=3,7)                                  resu-260
      if (mf(1,nix).eq.19) go to 27                                     resu-261
      if (lo(74)) call hora                                             resu-262
      if (lo(67)) go to 27                                              resu-263
      lt(3)=.not.(lt(1).or.mf(2,nix).eq.1.or.mf(2,nix).eq.19)           resu-264
      call gral(the,spg,dxx,m,mf(1,nix),cm(1,nix),1,lt(3),.false.)      resu-265
   27 continue                                                          resu-266
      ji=ji+1                                                           resu-267
c end of the pseudo loop on angular distributions                       resu-268
      if (ji.le.ncolr) go to 3                                          resu-269
      if (.not.lo(216)) write (mw,1007) chi2                            resu-270
      if (chi2.gt.chi2m.or.lo(132)) go to 29                            resu-271
      jmm(1)=ipj                                                        resu-272
      jmm(2)=ipk                                                        resu-273
      chi2m=chi2                                                        resu-274
c if the chi2 decreased, save the scattering coefficients               resu-275
      do 28 i=1,nrz                                                     resu-276
   28 sr(i+nrz,1,1)=sr(i,1,1)                                           resu-277
   29 if (lo(216)) go to 62                                             resu-278
      lkt=lo(191)                                                       resu-279
      if (lo(66).and.lo(181).and.lo(159)) go to 62                      resu-280
c computation at equidistant angles                                     resu-281
      write (mw,1002) title                                             resu-282
      jg=idint((theta2-theta1)/dtheta+1.5d0)                            resu-283
      if (lo(64)) write (66,1008) wv(1,1),wv(12,1),wv(2,1),ipi(4,1),ncolresu-284
     1s                                                                 resu-285
      if (lo(159)) go to 30                                             resu-286
      nd=1                                                              resu-287
      if (wv(5,1).eq.0.d0) nd=3                                         resu-288
      write (58,1009) wv(1,1),wv(12,1),wv(2,1),ipi(4,1),nd              resu-289
      if (ncols.ne.1) write (59,1010) wv(1,1),wv(12,1),wv(2,1),ipi(4,1),resu-290
     1ncols-1                                                           resu-291
   30 if (wv(5,1).ne.0.d0) go to 31                                     resu-292
      write (mw,1011) tx(1)                                             resu-293
      if (lo(59)) write (58,1012) tx(1)                                 resu-294
   31 rx=tx(1)-tx(2)                                                    resu-295
      if (lo(59)) write (58,1012) rx                                    resu-296
      if (lo(81)) go to 32                                              resu-297
      write (mw,1013) rx                                                resu-298
      go to 42                                                          resu-299
c compound nucleus results                                              resu-300
   32 write (mw,1014) rx                                                resu-301
      if (lo(59)) write (58,1012) rx                                    resu-302
      ndp=2*ncoll+nsp(1)+1                                              resu-303
      rx=rx-tx(ncoll+2)                                                 resu-304
      write (mw,1015) rx                                                resu-305
      if (lo(85)) write (mw,1016) tx(ndp+1)                             resu-306
      if (lo(86)) write (mw,1017) tx(ndp+2)                             resu-307
      rx=tx(ndp+1)+tx(ndp+2)                                            resu-308
      write (mw,1018)                                                   resu-309
      ry=0.d0                                                           resu-310
      do 33 i=1,ncoll                                                   resu-311
      ii=ipi(1,i)+1                                                     resu-312
      sp2=0.5d0*dfloat(ipi(3,i)-1)                                      resu-313
      ry=ry+tx(ncoll+i+1)                                               resu-314
   33 write (mw,1019) i,sp2,sigm(ii),wv(3,i),tx(ncoll+i+1)              resu-315
      write (mw,1020) ry                                                resu-316
      rx=rx+ry                                                          resu-317
      if (lo(184)) go to 41                                             resu-318
      if (ncoll.eq.ncols) go to 35                                      resu-319
      write (mw,1021)                                                   resu-320
      ry=0.d0                                                           resu-321
      n1=ncoll+1                                                        resu-322
      do 34 i=n1,ncols                                                  resu-323
      ii=ipi(1,i)+1                                                     resu-324
      sp2=0.5d0*dfloat(ipi(3,i)-1)                                      resu-325
      ry=ry+tx(ncoll+i+1)                                               resu-326
   34 write (mw,1019) i,sp2,sigm(ii),wv(3,i),tx(ncoll+i+1)              resu-327
      write (mw,1020) ry                                                resu-328
      rx=rx+ry                                                          resu-329
   35 nsp1=nsp(3)                                                       resu-330
      if (ncont.ne.0) nsp1=nsp1-nie                                     resu-331
      if (nsp1.lt.1) go to 37                                           resu-332
      write (mw,1022)                                                   resu-333
      ry=0.d0                                                           resu-334
      do 36 i=1,nsp1                                                    resu-335
      j=i+ncols                                                         resu-336
      ii=ipi(1,j)+1                                                     resu-337
      sp2=0.5d0*dfloat(ipi(3,j)-1)                                      resu-338
      ry=ry+tx(ncoll+j+1)                                               resu-339
   36 write (mw,1019) j,sp2,sigm(ii),wv(3,j),tx(ncoll+j+1)              resu-340
      write (mw,1020) ry                                                resu-341
      rx=rx+ry                                                          resu-342
   37 if (ncont.eq.0) go to 41                                          resu-343
      ik=ncoll+ncolx-ncont+1                                            resu-344
      do 40 i=1,ncont                                                   resu-345
      ij=noi(1,i)                                                       resu-346
      ji=noi(2,i)                                                       resu-347
      ry=0.d0                                                           resu-348
      if (ij.gt.ji) go to 40                                            resu-349
      do 38 ii=ij,ji                                                    resu-350
   38 ry=ry+tx(ik+ii)                                                   resu-351
      write (mw,1023) i,ry                                              resu-352
      rx=rx+ry                                                          resu-353
      do 39 ii=ij,ji                                                    resu-354
      ry=tx(ik+ii)/xd(2,ii)                                             resu-355
   39 write (mw,1024) ii,wvm(3,ii),xd(2,ii),tx(ik+ii),ry                resu-356
   40 continue                                                          resu-357
   41 write (mw,1025) rx                                                resu-358
      write (mw,1002) title                                             resu-359
   42 iniv=1                                                            resu-360
      sp2=0.5d0*dfloat(ipi(3,iniv)-1)                                   resu-361
      write (mw,1026) sp2,sigm(ipi(1,iniv)+1)                           resu-362
      nout=0                                                            resu-363
      klt=2                                                             resu-364
c pseudo do loop on levels                                              resu-365
   43 if (wv(3,iniv).gt.0.d0) go to 44                                  resu-366
      write (mw,1027) iniv                                              resu-367
      if (lo(64)) write (66,1028) iniv,sp2,sigm(ipi(1,iniv)+1)          resu-368
      go to 57                                                          resu-369
   44 rx=tx(iniv+1)                                                     resu-370
      if (lo(81)) rx=rx+tx(ncoll+iniv+1)                                resu-371
      if (iniv.eq.1) go to 45                                           resu-372
      write (mw,1002) title                                             resu-373
      write (mw,1029) iniv,sp2,sigm(ipi(1,iniv)+1)                      resu-374
      write (mw,1030) rx                                                resu-375
      go to 46                                                          resu-376
   45 if (wv(5,1).ne.0.d0) go to 47                                     resu-377
      write (mw,1031) rx                                                resu-378
   46 if (lo(81)) write (mw,1032) tx(iniv+1)                            resu-379
      if (lo(159)) go to 47                                             resu-380
      if (iniv.eq.1) write (58,1012) rx                                 resu-381
      if (iniv.ne.1) write (59,1033) rx,iniv-1                          resu-382
   47 if (lo(81)) write (mw,1034) tx(ncoll+iniv+1)                      resu-383
      if (lo(66)) go to 62                                              resu-384
      if (jg.le.0) go to 57                                             resu-385
      thetb=theta1                                                      resu-386
      ij=0                                                              resu-387
      ii=1                                                              resu-388
c pseudo do loop on angles                                              resu-389
   48 the(ii)=thetb                                                     resu-390
      theta=thetb                                                       resu-391
      kc=1                                                              resu-392
      go to 64                                                          resu-393
   49 dxx(ii)=ex(i5,1)                                                  resu-394
      if (lo(81)) go to 50                                              resu-395
      i1=min0(i3,7)                                                     resu-396
      write (mw,1035) thetb,(ex(k,1),k=2,i1)                            resu-397
      go to 51                                                          resu-398
   50 i1=min0(i3,5)                                                     resu-399
      if (i1.lt.3) go to 52                                             resu-400
      write (mw,1035) thetb,ex(2,1),ex(i3+1,1),ex(i4,1),(ex(k,1),k=3,i1)resu-401
   51 if (i1.ge.i3) go to 53                                            resu-402
      i2=i1+1                                                           resu-403
      i1=min0(i1+5,i3)                                                  resu-404
      write (mw,1036) (ex(k,1),k=i2,i1)                                 resu-405
      go to 51                                                          resu-406
   52 write (mw,1035) thetb,ex(2,1),ex(i3+1,1),ex(i4,1)                 resu-407
   53 if (lo(164)) go to 54                                             resu-408
      write (66,1037) (mf(2,nix+k-2),theta,ex(k,1),(cm(l,nix+k-2),l=6,10resu-409
     1),k=2,i3)                                                         resu-410
      if (lo(81)) write (66,1038) theta,ex(i3+1,1),(lg(k),k=1,5),theta,eresu-411
     1x(i4,1),(lg(k),k=6,10)                                            resu-412
   54 if (i7.le.0) go to 56                                             resu-413
      do 55 k=1,i7                                                      resu-414
      ij=ij+1                                                           resu-415
   55 spg(ij)=ex(k+i5,1)                                                resu-416
   56 thetb=thetb+dtheta                                                resu-417
      ii=ii+1                                                           resu-418
c end of the pseudo do loop on angles                                   resu-419
      if (ii.le.jg) go to 48                                            resu-420
      if (lo(168)) call gral(the,dxx,dxx,jg,mf(1,nfx-i7),cm(1,nfx-i7),1,resu-421
     1.false.,.true.)                                                   resu-422
      if (lo(169).and.i7.gt.0) call gral(the,spg,dxx,jg,mf(1,nix+i5-1),cresu-423
     1m(1,nix+i5-1),i7,.true.,.true.)                                   resu-424
      if (lo(74)) call hora                                             resu-425
   57 iniv=iniv+1                                                       resu-426
      sp2=0.5d0*dfloat(ipi(3,iniv)-1)                                   resu-427
c end of the pseudo do loop on levels                                   resu-428
      if (iniv.le.ncoll) go to 43                                       resu-429
      if (lo(181)) go to 62                                             resu-430
      jn2=ncoll                                                         resu-431
      klt=3                                                             resu-432
   58 jn1=jn2+1                                                         resu-433
      jn2=min0(jn1+5,ncols)                                             resu-434
      is=jn1-1                                                          resu-435
      if (jn1.gt.jn2) go to 62                                          resu-436
      do 59 i=jn1,jn2                                                   resu-437
   59 sp(i-is)=0.5d0*dfloat(ipi(3,i)-1)                                 resu-438
      write (mw,1002) title                                             resu-439
      write (mw,1039) jn1,jn2,(i,sp(i-is),sigm(ipi(1,i)+1),i=jn1,jn2)   resu-440
      thetb=theta1                                                      resu-441
      go to 61                                                          resu-442
   60 write (mw,1040) thetb,(ex(i-is,1),i=jn1,jn2)                      resu-443
      thetb=thetb+dtheta                                                resu-444
   61 theta=thetb                                                       resu-445
      kc=1                                                              resu-446
      if (thetb.le.theta2) go to 71                                     resu-447
      go to 58                                                          resu-448
   62 nzz=2*nesp                                                        resu-449
      return                                                            resu-450
c for experimental data                                                 resu-451
   63 if (ji.eq.ka) go to 71                                            resu-452
      iniv=mfm(1,ji)                                                    resu-453
      ka=ji                                                             resu-454
      go to 65                                                          resu-455
c for equidistant angles                                                resu-456
   64 if (iniv.eq.nout) go to 71                                        resu-457
   65 nout=iniv                                                         resu-458
c change of level                                                       resu-459
      jn1=ipi(6,nout)                                                   resu-460
      jn2=ipi(7,nout)                                                   resu-461
      mt1=ipi(2,nout)                                                   resu-462
      mt2=ipi(3,nout)                                                   resu-463
      ntt=jn2+1-jn1                                                     resu-464
      mtt=mt1*mt2*mt3*mt4                                               resu-465
      m2=1+2*mtt                                                        resu-466
      m3=m2+2*ntt                                                       resu-467
      m4=m3+ipj+ncj                                                     resu-468
      if (lo(226)) m4=max0(m4,6*mtt)                                    resu-469
      nesp=max0(nesp,m4)                                                resu-470
      if (2*m4.gt.nzz) call memo('resu',nzz,2*m4,2)                     resu-471
      if (lkt) go to 67                                                 resu-472
      if (lo(8)) go to 66                                               resu-473
      xa=1.d0                                                           resu-474
      xb=wv(4,1)*wv(1,nout)/(wv(4,nout)*wv(2,1))                        resu-475
      go to 67                                                          resu-476
   66 xa=dsqrt(1.d0+(wv(4,1)/(cmb*wv(2,1)))**2)                         resu-477
      xb=dsqrt(wv(1,nout)**2+(wv(4,nout)/cmb)**2)*wv(4,1)/(wv(4,nout)*wvresu-478
     1(2,1))                                                            resu-479
   67 if (klt.ne.2) go to 71                                            resu-480
c for equidistant angles                                                resu-481
      nix=ipi(8,iniv)                                                   resu-482
      nfx=ipi(9,iniv)                                                   resu-483
      i4=2+nfx-nix                                                      resu-484
      i3=i4                                                             resu-485
      i5=2                                                              resu-486
      i8=i4-1                                                           resu-487
      if (i4.gt.2.and.mf(2,nix+1).eq.1) i5=3                            resu-488
      i7=i4-i5                                                          resu-489
      if (lo(81)) go to 68                                              resu-490
      ngx=min0(nfx,nix+5)                                               resu-491
      write (mw,1041) ((cm(l,k),l=6,10),k=nix,ngx)                      resu-492
      go to 70                                                          resu-493
   68 i4=i4+2                                                           resu-494
      i8=i8+2                                                           resu-495
      ngx=min0(nfx,nix+3)                                               resu-496
      njx=nix+1                                                         resu-497
      if (ngx.ge.njx) go to 69                                          resu-498
      write (mw,1041) (cm(l,nix),l=6,10),lg                             resu-499
      go to 70                                                          resu-500
   69 write (mw,1041) (cm(l,nix),l=6,10),lg,((cm(l,k),l=6,10),k=njx,ngx)resu-501
   70 if (lo(64)) write (66,1042) iniv,sp2,sigm(ipi(1,iniv)+1),i8,jg    resu-502
      if (ngx.eq.nfx) go to 71                                          resu-503
      njx=ngx+1                                                         resu-504
      ngx=min0(nfx,njx+4)                                               resu-505
      write (mw,1043) ((cm(l,k),l=6,10),k=njx,ngx)                      resu-506
      if (ngx.lt.nfx) go to 70                                          resu-507
   71 call scat(sr,mf,jmax,kmax,theta,fcn,ipj,ipk,cmb,nco,coe,ipi,mt1,amresu-508
     1,am(m2),am(m3),ex(1,kc),wv,ncj,jmin,xz,lo)                        resu-509
      go to ( 11 , 72 , 73 ) , klt                                      resu-510
   72 if (lo(181)) go to 73                                             resu-511
      ex(i4-1,kc)=excn                                                  resu-512
      ex(i4,kc)=ex(2,kc)-excn                                           resu-513
   73 if (dthe.eq.0.d0) go to ( 49 , 49 , 60 ) , klt                    resu-514
      go to ( 74 , 75 , 76 ),kc                                         resu-515
   74 kc=2                                                              resu-516
      theta=thetb-dthe                                                  resu-517
      go to 71                                                          resu-518
   75 kc=3                                                              resu-519
      theta=thetb+dthe                                                  resu-520
      go to 71                                                          resu-521
   76 if (klt.eq.3) go to 79                                            resu-522
      aa=ex(1,1)+ex(1,2)+ex(1,3)                                        resu-523
      do 78 k=2,i4                                                      resu-524
      if ((k.gt.i5).and.(k.le.i3)) go to 77                             resu-525
      ex(k,1)=(ex(k,1)+ex(k,2)+ex(k,3))/3.d0                            resu-526
      go to 78                                                          resu-527
   77 ex(k,1)=(ex(k,1)*ex(1,1)+ex(k,2)*ex(1,2)+ex(k,3)*ex(1,3))/aa      resu-528
   78 continue                                                          resu-529
      go to 49                                                          resu-530
   79 do 80 k=jn1,jn2                                                   resu-531
   80 ex(k-is,1)=(ex(k-is,1)+ex(k-is,2)+ex(k-is,3))/3.d0                resu-532
      go to 60                                                          resu-533
 1000 format ('<exp.dat.>',f10.2,f10.5,f10.2,2i5)                       resu-534
 1001 format (3i5,5a4)                                                  resu-535
 1002 format ('1',5x,18a4//)                                            resu-536
 1003 format (//30x,'**********   state',i5,'    **********'//)         resu-537
 1004 format (//42x,5a4//10x,'angle',10x,'calc. val.',11x,'exp. val.',10resu-538
     1x,'exp. error',10x,'cor. error',13x,'chi2'/)                      resu-539
 1005 format (6x,f10.3,5d20.5)                                          resu-540
 1006 format (//' weight in the chi2',8x,d15.5/' experimental normalisatresu-541
     1ion',d15.5/' normalisation error',7x,d15.5/' calculated normalisatresu-542
     2ion',2x,d15.5//' ***** chi2 =',d15.6,'   *****'/)                 resu-543
 1007 format (/' ************ chi2 **********',d20.10//)                resu-544
 1008 format ('<ang.dis.>',f10.2,f10.5,f10.2,2i5)                       resu-545
 1009 format ('<cross-s.>',f10.2,f10.5,f10.2,2i5)                       resu-546
 1010 format ('<ine.c.s.>',f10.2,f10.5,f10.2,2i5)                       resu-547
 1011 format (6x,'==> total cross section =',f14.6,' millibarns')       resu-548
 1012 format (d12.5)                                                    resu-549
 1013 format (' total reaction cross section =',f14.6,' millibarns')    resu-550
 1014 format (' total reaction cross section =',f14.6,' millibarns',11x,resu-551
     1'( including compound elastic )')                                 resu-552
 1015 format (' total direct reaction cross section =',f14.6,' millibarnresu-553
     1s',4x,'( without compound elastic )')                             resu-554
 1016 format (8x,'fission cross section =',f14.6,' millibarns')         resu-555
 1017 format (6x,'gamma ray cross section =',f14.6,' millibarns')       resu-556
 1018 format (/'  compound cross section for scattering to coupled levelresu-557
     1s'/'  ======================================================='//' resu-558
     2  level     spin       energy       cross section'/)              resu-559
 1019 format (i5,f9.1,a1,'   at',f10.5,' mev',f14.5)                    resu-560
 1020 format (/' sum of compound contributions',f14.6,' millibarns')    resu-561
 1021 format (/'  compound cross section for scattering to uncoupled levresu-562
     1els with angular distribution'/'  ================================resu-563
     2==================================================='//'   level   resu-564
     3  spin       energy       cross section'/)                        resu-565
 1022 format (/'  compound cross section for scattering to levels withouresu-566
     1t angular distribution'/'  =======================================resu-567
     2====================================='//'   level     spin       eresu-568
     3nergy       cross section'/)                                      resu-569
 1023 format (/' continuum',i4/' total compound reaction cross section =resu-570
     1',f14.6,' millibarns'//8x,' energy     step     contribution  valuresu-571
     2e (millibarns/mev)'/)                                             resu-572
 1024 format (2x,i3,2f10.5,2f15.5)                                      resu-573
 1025 format (/' total sum of compound contributions',f14.6,' millibarnsresu-574
     1')                                                                resu-575
 1026 format (/' elastic scattering on the target state of spin =',f5.1,resu-576
     1a1)                                                               resu-577
 1027 format (//' closed channel for the target state',i3)              resu-578
 1028 format (i5,f5.1,a1,3x,'0',5x,'closed channel')                    resu-579
 1029 format (/' inelastic scattering to the target state',i3,'  spin ='resu-580
     1,f5.1,a1)                                                         resu-581
 1030 format (/6x,'inelastic cross section =',f14.6,' millibarns')      resu-582
 1031 format (/'  total elastic cross section =',f14.6,' millibarns')   resu-583
 1032 format (9x,'direct cross section =',f14.6,' millibarns')          resu-584
 1033 format (d12.5,i3)                                                 resu-585
 1034 format (7x,'compound cross section =',f14.6,' millibarns')        resu-586
 1035 format (1x,f10.3,d16.5,2x,5f18.7)                                 resu-587
 1036 format (29x,5f18.7)                                               resu-588
 1037 format (i3,2d12.5,5x,4a4,a2)                                      resu-589
 1038 format (' -4',2d12.5,5x,4a4,a2/' -5',2d12.5,5x,4a4,a2)            resu-590
 1039 format (/' angular distribution of compound scattering on levels',resu-591
     1i3,' to',i3//6x,'angle',6(i6,'-level',f5.1,a1))                   resu-592
 1040 format (1x,f10.3,6f18.7)                                          resu-593
 1041 format (/6x,'angle ',6(4a4,a2))                                   resu-594
 1042 format (i5,f5.1,a1,i4,i5)                                         resu-595
 1043 format (30x,5(4a4,a2))                                            resu-596
      end                                                               resu-597
c 29/02/04                                                      ecis03  scat-000
      subroutine scat(fr,mf,jmax,kmax,theta,fcn,ipj,ipk,cmb,nco,coe,ipi,scat-001
     1mt1,ab,a,b,ex,wv,ncj,jmin,xz,lo)                                  scat-002
c computation of observables                                            scat-003
c input variables: fr:    scattering coeff. in the helicity formalism   scat-004
c                  mf:    tables of helicity,description of observables,scat-005
c                         .... etc   see deph and obse                  scat-006
c                  jmax:  dimension for fr                              scat-007
c                  kmax:  dimension for fcn                             scat-008
c                  theta: scattering angle                              scat-009
c                  fcn:   compound nucleus coefficients                 scat-010
c                  ipj:   number of j values used for scattering        scat-011
c                  ipk:   number of l values used for compound nucleus  scat-012
c                  cmb:   atomic mass unit divided by hbar              scat-013
c                  nco,coe:   loops and coeff. for observables  see obsescat-014
c                  ipi:   multiplicities for particle and target nucleusscat-015
c                  mt1:   multiplicity of the outgoing particle         scat-016
c                         second dimension of the working space ab      scat-017
c                  wv:    masses, energies, etc..    see calx           scat-018
c                  ncj:   number of factorisations of 1/(1-x*cos(theta))scat-019
c                  jmin:  twice minimum of the total spin               scat-020
c                  xz:    conversion factor to millibarns               scat-021
c                  lo:    logical controls                              scat-022
c output variables:ex:    differ. cross-section followed by observables scat-023
c working space:   ab:    amplitudes in the c. m. or the lab. system    scat-024
c                  a:     for independent amplitudes                    scat-025
c                  b:     to store the rotation matrix elements         scat-026
c other input by common /resc/                                          scat-027
c                  excn:   compound-nucleus cross-section               scat-028
c                  xa,xb:  constants for change to laboratory system    scat-029
c                  jn1,jn2:first and last amplitude in:the table        scat-030
c                  ntt:    number of independent amplitudes             scat-031
c                  mtt:    total number of amplitudes                   scat-032
c                  mt2:    multiplicity of the residual target          scat-033
c                  mt3:    multiplicity of the incident particle        scat-034
c                  mt4:    multiplicity of the initial target           scat-035
c                  nout:   nuclear state considered                     scat-036
c                  nix,nfx:first and last observable in the table       scat-037
c                  klt:    1 for experimental data                      scat-038
c                          2 for equidistant angles                     scat-039
c                          3 for pure compound nucleus                  scat-040
c                  lkt:    .true. for center of mass system             scat-041
c***********************************************************************scat-042
      implicit real*8 (a-h,o-z)                                         scat-043
      logical lo(250),ltt(6),lxy,lkt                                    scat-044
      dimension fr(2,jmax,1),mf(10,8),nco(20,1),coe(1),ipi(11,1),ab(2,mtscat-045
     11,1),a(2,1),b(2),ex(2),wv(18,1),mo(18),fcn(kmax,1)                scat-046
      equivalence (mo(1),mi1),(mo(2),mp1),(mo(3),n1),(mo(4),l1),(mo(5),mscat-047
     1i2),(mo(6),mp2),(mo(7),n2),(mo(8),l2),(mo(9),mi3),(mo(10),mp3),(moscat-048
     2(11),n3),(mo(12),l3),(mo(13),mi4),(mo(14),mp4),(mo(15),n4),(mo(16)scat-049
     3,l4),(mo(17),jq),(mo(18),jp)                                      scat-050
      common /resc/ excn,xa,xb,jn1,jn2,ntt,mtt,mt2,mt3,mt4,nout,nix,nfx,scat-051
     1klt,lkt                                                           scat-052
      thet=1.74532925d-02*theta                                         scat-053
      if (klt.eq.3) go to 56                                            scat-054
c for experimental data or equidistant angles                           scat-055
      w6=dcos(thet)                                                     scat-056
      w7=dsin(thet)                                                     scat-057
      if (lkt) go to 1                                                  scat-058
      xc=(xa**2-xb**2)*w7**2+w6**2                                      scat-059
      if (xc.gt.0.d0) xc=dsqrt(xc)                                      scat-060
      a3=xc*w6-xa*xb*w7**2                                              scat-061
      w7=w7*(xb*w6+xc*xa)                                               scat-062
      w6=a3                                                             scat-063
    1 if (lo(181)) go to 3                                              scat-064
c compound nucleus contribution                                         scat-065
      excn=fcn(1,nout)                                                  scat-066
      if (ipk.eq.1) go to 3                                             scat-067
      u1=0.d0                                                           scat-068
      u2=1.d0                                                           scat-069
      do 2 j=2,ipk                                                      scat-070
      u1=(dfloat(4*j-7)*u2*w6-dfloat(2*j-4)*u1)/dfloat(2*j-3)           scat-071
      u2=(dfloat(4*j-5)*u1*w6-dfloat(2*j-3)*u2)/dfloat(2*j-2)           scat-072
    2 excn=excn+u2*fcn(j,nout)*dfloat(4*j-3)                            scat-073
c direct interaction contribution                                       scat-074
    3 w3=1.d0                                                           scat-075
      x2=dsqrt(.5d0*(1.d0+w6))                                          scat-076
      x3=dsqrt(.5d0*(1.d0-w6))                                          scat-077
      do 4 i=1,ntt                                                      scat-078
      a(1,i)=0.d0                                                       scat-079
    4 a(2,i)=0.d0                                                       scat-080
      if (nout.ne.1) go to 7                                            scat-081
c computation of coulomb amplitudes for the elastic channel             scat-082
      if (wv(5,1).eq.0.d0.or.x3.lt.1.d-20) go to 7                      scat-083
      w2=2.d0*wv(5,1)*dlog(x3)                                          scat-084
      w3=-0.5d0*wv(5,1)/(x3*x3)                                         scat-085
      w4=w3*dcos(w2)                                                    scat-086
      w5=-w3*dsin(w2)                                                   scat-087
      w3=w3**2                                                          scat-088
      if (lo(118)) go to 5                                              scat-089
c symmetrisation between projectile and target                          scat-090
      fs=dfloat(2*mod(ipi(2,1),2)-1)                                    scat-091
      y2=2.d0*wv(5,1)*dlog(x2)                                          scat-092
      y1=-0.5d0*wv(5,1)/(x2*x2)                                         scat-093
      y4=y1*dcos(y2)                                                    scat-094
      y5=-y1*dsin(y2)                                                   scat-095
      w3=w4**2+w5**2+y4**2+y5**2+2.d0*fs*(w4*y4+w5*y5)/dfloat(ipi(2,1)) scat-096
c transformation of the coulomb amplitudes to the helicity formalism    scat-097
    5 do 6 i=1,ntt                                                      scat-098
      m5=ipi(2,1)-1                                                     scat-099
      m6=ipi(3,1)-1                                                     scat-100
      m1=2*mf(1,i)-1-ipi(2,1)                                           scat-101
      m2=ipi(3,1)-2*mf(2,i)+1                                           scat-102
      m3=2*mf(3,i)-1-ipi(2,1)                                           scat-103
      m4=ipi(3,1)-2*mf(4,i)+1                                           scat-104
      call emro(m5,m3,m1,w6,x2,x3,b,1)                                  scat-105
      call emro(m6,m4,m2,w6,x2,x3,b(2),1)                               scat-106
      w1=b(1)*b(2)                                                      scat-107
      a(1,i)=w4*w1                                                      scat-108
      a(2,i)=w5*w1                                                      scat-109
      if (lo(118)) go to 6                                              scat-110
      call emro(m5,m3,m2,w6,x2,x3,b,1)                                  scat-111
      call emro(m6,m4,m1,w6,x2,x3,b(2),1)                               scat-112
      y1=b(1)*b(2)*fs                                                   scat-113
      a(1,i)=a(1,i)+y4*y1                                               scat-114
      a(2,i)=a(2,i)+y5*y1                                               scat-115
    6 continue                                                          scat-116
      w3=w3/wv(4,1)**2                                                  scat-117
c computation of the nuclear amplitudes                                 scat-118
    7 do 13 i=jn1,jn2                                                   scat-119
      ij=i-jn1+1                                                        scat-120
      w5=1.d0                                                           scat-121
      jn=ipj                                                            scat-122
      if (lo(141)) go to 9                                              scat-123
c factorisation of 1/(1-x*cos(theta)) with x after the scat. coeff.     scat-124
      do 8 j=1,ncj                                                      scat-125
      jn=jn+1                                                           scat-126
    8 w5=w5/(1.d0-fr(1,jn,i)*w6)                                        scat-127
    9 if (mf(6,i).eq.99999) go to 10                                    scat-128
      call emro(jmin,mf(5,i),mf(6,i),w6,x2,x3,b,jn)                     scat-129
      w1=w5                                                             scat-130
      go to 11                                                          scat-131
c rotation matrix elements are the same as for the last amplitude       scat-132
   10 w1=w5*dfloat(mf(10,i))                                            scat-133
   11 do 12 j=1,ipj                                                     scat-134
      a(1,ij)=a(1,ij)+fr(1,j,i)*w1*b(j)                                 scat-135
   12 a(2,ij)=a(2,ij)+fr(2,j,i)*w1*b(j)                                 scat-136
c construction of the total amplitude matrix                            scat-137
      k1=mf(7,i)                                                        scat-138
      ab(1,k1,1)=a(1,ij)                                                scat-139
      ab(2,k1,1)=a(2,ij)                                                scat-140
      if (mf(8,i).eq.0) go to 13                                        scat-141
      k1=mf(8,i)                                                        scat-142
      w1=dfloat(mf(9,i))                                                scat-143
      ab(1,k1,1)=w1*a(1,ij)                                             scat-144
      ab(2,k1,1)=w1*a(2,ij)                                             scat-145
   13 continue                                                          scat-146
c cross-section                                                         scat-147
      dz=0.d0                                                           scat-148
      if (lo(81)) dz=excn/xz                                            scat-149
      do 14 i1=1,mtt                                                    scat-150
   14 dz=dz+ab(1,i1,1)*ab(1,i1,1)+ab(2,i1,1)*ab(2,i1,1)                 scat-151
      ex(1)=dz*xz                                                       scat-152
      lx1=0                                                             scat-153
      lx2=0                                                             scat-154
      jex=1                                                             scat-155
c loop on the observables                                               scat-156
      do 54 iex=nix,nfx                                                 scat-157
      jex=jex+1                                                         scat-158
      if (mf(2,iex).gt.1) go to 21                                      scat-159
      if (mf(2,iex)) 17 , 15 , 16                                       scat-160
c cross section                                                         scat-161
   15 ex(jex)=ex(1)                                                     scat-162
      go to 54                                                          scat-163
c cross section divided by rutherford's cross-section                   scat-164
   16 ex(jex)=ex(1)/(10.d0*w3)                                          scat-165
      go to 54                                                          scat-166
   17 ex(jex)=0.d0                                                      scat-167
      if (mf(2,iex).eq.-3) go to 19                                     scat-168
      mtp=mt1*mt2*mt4                                                   scat-169
c vector analysing power for spin 1/2 or 1                              scat-170
      do 18 i1=1,mtp                                                    scat-171
      i2=i1+mtp                                                         scat-172
   18 ex(jex)=ex(jex)+ab(2,i2,1)*ab(1,i1,1)-ab(1,i2,1)*ab(2,i1,1)       scat-173
      ex(jex)=2.d0*ex(jex)*xz/ex(1)                                     scat-174
      if (mt3.eq.3) ex(jex)=1.22474487d0*ex(jex)                        scat-175
      go to 54                                                          scat-176
c vector polarisation for spin 1/2 or 1                                 scat-177
   19 do 20 i1=1,mtt,mt1                                                scat-178
   20 ex(jex)=ex(jex)+ab(1,i1+1,1)*ab(2,i1,1)-ab(2,i1+1,1)*ab(1,i1,1)   scat-179
      ex(jex)=2.d0*ex(jex)*xz/ex(1)                                     scat-180
      if (mt1.eq.3) ex(jex)=1.22474487d0*ex(jex)                        scat-181
      go to 54                                                          scat-182
c all the other observables                                             scat-183
   21 ex(jex)=0.d0                                                      scat-184
      k1=mf(3,iex)                                                      scat-185
      k2=mf(4,iex)                                                      scat-186
c loop on the components of the description of the observable           scat-187
      do 53 ii=k1,k2                                                    scat-188
      ix=1                                                              scat-189
      ixy=1                                                             scat-190
      ixx=ixy+mt2*mt3*mt4                                               scat-191
      do 22 i=1,18                                                      scat-192
   22 mo(i)=nco(i,ii)                                                   scat-193
      do 23 ij=1,6                                                      scat-194
      ltt(ij)=mod(jq,2).eq.1                                            scat-195
   23 jq=jq/2                                                           scat-196
c computation of the angle for a change of frame                        scat-197
      if (mod(jp,1000).eq.0) go to 46                                   scat-198
      lxy=.true.                                                        scat-199
      if (lx1.eq.mod(jp,1000)) go to 45                                 scat-200
      lx1=mod(jp,1000)                                                  scat-201
      lx2=0                                                             scat-202
      n=mt1                                                             scat-203
      if (lx1.eq.1) go to 26                                            scat-204
      go to 25                                                          scat-205
   24 if (jp/1000.eq.0) go to 46                                        scat-206
      lxy=.false.                                                       scat-207
      if (jp/1000.eq.lx2) go to 45                                      scat-208
      lx2=jp/1000                                                       scat-209
      n=mt2                                                             scat-210
      if (lx2.eq.1) go to 27                                            scat-211
   25 if (dabs(w7).lt.1.d-5.or.n.eq.1) go to 43                         scat-212
      w1=w6                                                             scat-213
      w2=-w7                                                            scat-214
      go to 31                                                          scat-215
c transformation to the laboratory system for the particle              scat-216
   26 w1=wv(1,nout)                                                     scat-217
      go to 28                                                          scat-218
c transformation to the laboratory system for the target                scat-219
   27 w1=-wv(2,nout)                                                    scat-220
   28 if (n.eq.1) go to 43                                              scat-221
      if (lo(108)) go to 29                                             scat-222
      w1=wv(4,nout)/(cmb*w1)                                            scat-223
      w2=cmb*wv(2,1)/wv(4,1)                                            scat-224
      w3=datan(-w7/(w6*dsqrt(w1*w1+1.d0)+w1*dsqrt(w2*w2+1.d0)))         scat-225
      go to 30                                                          scat-226
   29 w3=datan(-w7/(wv(4,nout)*wv(2,1)/(wv(4,1)*w1)+w6))                scat-227
   30 if (dabs(w3).lt.1.d-5.or.n.eq.1) go to 43                         scat-228
      w1=dcos(w3)                                                       scat-229
      w2=dsin(w3)                                                       scat-230
   31 do 32 i=1,mtt                                                     scat-231
      ab(1,i,ixx)=0.d0                                                  scat-232
   32 ab(2,i,ixx)=0.d0                                                  scat-233
      w3=dsqrt(.5d0*(1.d0-w1))                                          scat-234
      w5=1.d0                                                           scat-235
      do 33 i=2,n                                                       scat-236
   33 w5=-w5*w3                                                         scat-237
      if (dabs(w5).lt.1.d-30) go to 43                                  scat-238
      w4=0.d0                                                           scat-239
      w8=.5d0*dfloat(n-1)                                               scat-240
      mty=mt3*mt4                                                       scat-241
      x3=-w8                                                            scat-242
c transformation of the amplitude matrix                                scat-243
      do 42 i=1,n                                                       scat-244
      if (i.eq.1) go to 34                                              scat-245
      w3=w4                                                             scat-246
      if (i.ne.2) w3=w3*dsqrt(dfloat((i-2)*(n+2-i)))                    scat-247
      w4=w5                                                             scat-248
      w5=(2.d0*(x3*w1-w8)*w4/w2-w3)/dsqrt(dfloat((i-1)*(n+1-i)))        scat-249
      x3=x3+1.d0                                                        scat-250
   34 x2=0.d0                                                           scat-251
      x5=w5                                                             scat-252
      x4=w8                                                             scat-253
      do 41 j=i,n                                                       scat-254
      if (j.eq.i) go to 35                                              scat-255
      x1=x2                                                             scat-256
      if (j.ne.i+1) x1=x1*dsqrt(dfloat((j-i-1)*(n+1-j+i)))              scat-257
      x2=x5                                                             scat-258
      x5=(2.d0*(x3-x4*w1)*x2/w2-x1)/dsqrt(dfloat((j-i)*(n+i-j)))        scat-259
      x4=x4-1.d0                                                        scat-260
   35 x=x5                                                              scat-261
      l=1+j-i                                                           scat-262
      m=n+1-i                                                           scat-263
      do 40 k=1,2                                                       scat-264
      do 39 i1=1,mty                                                    scat-265
      if (lxy) go to 37                                                 scat-266
      ixi=ixx+(i1-1)*mt2+l-1                                            scat-267
      ixj=ixy+(i1-1)*mt2+m-1                                            scat-268
      do 36 i4=1,mt1                                                    scat-269
      ab(1,i4,ixi)=ab(1,i4,ixi)+x*ab(1,i4,ixj)                          scat-270
   36 ab(2,i4,ixi)=ab(2,i4,ixi)+x*ab(2,i4,ixj)                          scat-271
      go to 39                                                          scat-272
   37 ixi=mt1*(ixx+(i1-1)*mt2-1)+l                                      scat-273
      ixj=mt1*(ixy+(i1-1)*mt2-1)+m                                      scat-274
      do 38 i4=1,mt2                                                    scat-275
      ab(1,ixi,i4)=ab(1,ixi,i4)+x*ab(1,ixj,i4)                          scat-276
   38 ab(2,ixi,i4)=ab(2,ixi,i4)+x*ab(2,ixj,i4)                          scat-277
   39 continue                                                          scat-278
      if (j.eq.n) go to 41                                              scat-279
      ml=l                                                              scat-280
      l=m                                                               scat-281
      m=ml                                                              scat-282
      if (mod(j+n,2).ne.0) x=-x                                         scat-283
   40 continue                                                          scat-284
   41 continue                                                          scat-285
   42 continue                                                          scat-286
      go to 45                                                          scat-287
   43 do 44 i=1,mtt                                                     scat-288
      ab(1,i,ixx)=ab(1,i,ixy)                                           scat-289
   44 ab(2,i,ixx)=ab(2,i,ixy)                                           scat-290
   45 ix=ix+1                                                           scat-291
      ixy=ixx                                                           scat-292
      ixx=ixy+mt2*mt3*mt4                                               scat-293
      if (lxy) go to 24                                                 scat-294
   46 if (ltt(5)) go to 52                                              scat-295
      x=0.d0                                                            scat-296
c the four do loops                                                     scat-297
      do 51 i1=mi1,mp1                                                  scat-298
      j1=i1-n1                                                          scat-299
      x1=coe(10*ii)                                                     scat-300
      if (ltt(1)) x1=coe(10*ii)*coe(i1+l1)                              scat-301
      do 50 i2=mi2,mp2                                                  scat-302
      j2=i2-n2                                                          scat-303
      x2=x1                                                             scat-304
      if (ltt(2)) x2=x1*coe(l2-i2)                                      scat-305
      do 49 i3=mi3,mp3                                                  scat-306
      j3=i3-n3                                                          scat-307
      x3=x2                                                             scat-308
      if (ltt(3)) x3=x2*coe(i3+l3)                                      scat-309
      do 48 i4=mi4,mp4                                                  scat-310
      j4=i4-n4                                                          scat-311
      x4=x3                                                             scat-312
      iij=i4+mt2*(j2-1+mt4*(j1-1+mt3*(ix-1)))                           scat-313
      iii=j4+mt2*(i2-1+mt4*(i1-1+mt3*(ix-1)))                           scat-314
      if (ltt(4)) x4=x3*coe(l4-i4)                                      scat-315
      if (ltt(6)) go to 47                                              scat-316
      x=x+(ab(1,i3,iij)*ab(1,j3,iii)+ab(2,i3,iij)*ab(2,j3,iii))*x4      scat-317
      go to 48                                                          scat-318
   47 x=x+(ab(2,i3,iij)*ab(1,j3,iii)-ab(1,i3,iij)*ab(2,j3,iii))*x4      scat-319
   48 continue                                                          scat-320
   49 continue                                                          scat-321
   50 continue                                                          scat-322
   51 continue                                                          scat-323
      go to 53                                                          scat-324
   52 x=coe(10*ii)*dz                                                   scat-325
   53 ex(jex)=ex(jex)+x                                                 scat-326
      ex(jex)=ex(jex)/dz                                                scat-327
   54 continue                                                          scat-328
      if (lkt) go to 55                                                 scat-329
      xc=dsqrt((xa*w6+xb)**2+w7**2)**3/dabs(xa+xb*w6)                   scat-330
      ex(1)=ex(1)*xc                                                    scat-331
   55 if (klt.eq.1.or.lkt) return                                       scat-332
      ex(2)=ex(2)*xc                                                    scat-333
      if (lo(81)) excn=excn*xc                                          scat-334
      return                                                            scat-335
c pure compound nucleus for levels jn1 to jn2                           scat-336
   56 is=jn1-1                                                          scat-337
      do 63 iv=jn1,jn2                                                  scat-338
      ex(iv-is)=fcn(1,iv)                                               scat-339
      if (ipk.eq.1) go to 62                                            scat-340
      if (lkt) go to 59                                                 scat-341
      if (lo(8)) go to 57                                               scat-342
      xa=1.d0                                                           scat-343
      xb=wv(4,1)*wv(1,iv)/(wv(4,iv)*wv(2,1))                            scat-344
      go to 58                                                          scat-345
   57 xa=dsqrt(1.d0+(wv(4,1)/(cmb*wv(2,1)))**2)                         scat-346
      xb=dsqrt(wv(1,iv)**2+(wv(4,iv)/cmb)**2)*wv(4,1)/(wv(4,iv)*wv(2,1))scat-347
   58 w6=dcos(thet)                                                     scat-348
      w7=dsin(thet)                                                     scat-349
      xc=(xa**2-xb**2)*w7**2+w6**2                                      scat-350
      if (xc.gt.0.d0) xc=dsqrt(xc)                                      scat-351
      w6=xc*w6-xa*xb*w7**2                                              scat-352
      go to 60                                                          scat-353
   59 w6=dcos(thet)                                                     scat-354
   60 u1=0.d0                                                           scat-355
      u2=1.d0                                                           scat-356
      do 61 j=2,ipk                                                     scat-357
      u1=(dfloat(4*j-7)*u2*w6-dfloat(2*j-4)*u1)/dfloat(2*j-3)           scat-358
      u2=(dfloat(4*j-5)*u1*w6-dfloat(2*j-3)*u2)/dfloat(2*j-2)           scat-359
   61 ex(iv-is)=ex(iv-is)+u2*fcn(j,iv)*dfloat(4*j-3)                    scat-360
   62 if (.not.lkt) ex(iv-is)=ex(iv-is)*dsqrt((xa*w6+xb)**2+1.d0-w6**2)*scat-361
     1*3/dabs(xa+xb*w6)                                                 scat-362
   63 continue                                                          scat-363
      return                                                            scat-364
      end                                                               scat-365
c 29/02/04                                                      ecis03  gral-000
      subroutine gral(tgr,grr,frr,mtheta,mf,cm,id1,lt1,lt2)             gral-001
c plots of cross-section and polarisations with or without exper. data  gral-002
c input variables: tgr(i):    angles for i=1,mtheta                     gral-003
c                  grr(j,i):  calc. values for j=1,id1 and i=1,mtheta   gral-004
c                  frr(i):    exper. values for i=1,mtheta              gral-005
c                  mtheta:    number of angles                          gral-006
c                  mf:        description of data    see obse           gral-007
c                  id1:       number of different polarisations         gral-008
c                  lt1:       .true. for polarisation,                  gral-009
c                             .false. for cross section                 gral-010
c                  lt2:       .true. if there are no experimental data  gral-011
c mf(i,j) is a title for i=6,10                                         gral-012
c mf(5,j) is the number of power of 10 in a line for cross sections     gral-013
c  and must be 1 to plot a polarisation (always between -1 and 1)       gral-014
c***********************************************************************gral-015
      implicit real*8 (a-h,o-z)                                         gral-016
      logical lt1,lt2                                                   gral-017
      dimension tgr(mtheta),grr(id1,mtheta),mf(10,1),frr(mtheta)        gral-018
      character*1 vgr(112),gra(17)                                      gral-019
      character*4 cm(10,1)                                              gral-020
      common /inout/ mr,mw,ms                                           gral-021
      data gra /'+','*',',',':','-','1','2','3','4','5','6','7','8','9',gral-022
     1'0',' ','.'/                                                      gral-023
      if (lt1) go to 14                                                 gral-024
c cross sections                                                        gral-025
      if ((mf(5,1).le.0).or.(mf(5,1).gt.50)) return                     gral-026
      na2=100/mf(5,1)                                                   gral-027
      aa2=dfloat(na2)                                                   gral-028
      write (mw,1000)                                                   gral-029
      write (mw,1001) gra(1),(cm(j,1),j=6,10)                           gral-030
      if (.not.lt2) write (mw,1002)                                     gral-031
      aa3=aa2*dfloat((mf(5,1)+1)/2)                                     gral-032
      aa1=aa2/dlog(10.d0)                                               gral-033
      na1=101-mf(5,1)*na2                                               gral-034
      a5=101.5d0                                                        gral-035
      do 1 i=1,112                                                      gral-036
    1 vgr(i)=gra(16)                                                    gral-037
      do 2 i=na1,112,na2                                                gral-038
    2 vgr(i)=gra(6)                                                     gral-039
      write (mw,1003) vgr                                               gral-040
      do 3 i=1,112                                                      gral-041
    3 vgr(i)=gra(17)                                                    gral-042
      do 4 i=na1,112,na2                                                gral-043
    4 vgr(i)=gra(2)                                                     gral-044
      write (mw,1003) vgr                                               gral-045
      do 11 i=1,mtheta                                                  gral-046
      do 5 j=2,111                                                      gral-047
    5 vgr(j)=gra(16)                                                    gral-048
      do 6 j=na1,111,na2                                                gral-049
    6 vgr(j)=gra(17)                                                    gral-050
      if (grr(1,i).lt.0.d0) go to 27                                    gral-051
      a4=aa1*dlog(grr(1,i))+a5                                          gral-052
      ng=0                                                              gral-053
    7 if (ng.gt.20) go to 28                                            gral-054
      ng=ng+1                                                           gral-055
      if (a4.gt.2.d0) go to 8                                           gral-056
      a4=a4+aa3                                                         gral-057
      a5=a5+aa3                                                         gral-058
      write (mw,1004)                                                   gral-059
      go to 7                                                           gral-060
    8 if (a4.lt.112.d0) go to 9                                         gral-061
      a4=a4-aa3                                                         gral-062
      a5=a5-aa3                                                         gral-063
      write (mw,1005)                                                   gral-064
      go to 8                                                           gral-065
    9 l=idint(a4)                                                       gral-066
      vgr(l)=gra(1)                                                     gral-067
      if (lt2) go to 10                                                 gral-068
c experimental data                                                     gral-069
      if (frr(i).lt.0.d0) go to 29                                      gral-070
      l=idint(aa1*dlog(frr(i))+a5)                                      gral-071
      if (l.gt.1.and.l.lt.112) vgr(l)=gra(2)                            gral-072
   10 write (mw,1006) tgr(i),vgr                                        gral-073
   11 continue                                                          gral-074
      do 12 i=1,112                                                     gral-075
   12 vgr(i)=gra(17)                                                    gral-076
      do 13 i=na1,112,na2                                               gral-077
   13 vgr(i)=gra(2)                                                     gral-078
      write (mw,1003) vgr                                               gral-079
      return                                                            gral-080
c polarisation                                                          gral-081
   14 if (lt2) go to 15                                                 gral-082
      write (mw,1000)                                                   gral-083
      write (mw,1001) gra(1),(cm(j,1),j=6,10)                           gral-084
      write (mw,1002)                                                   gral-085
      go to 17                                                          gral-086
   15 nk=0                                                              gral-087
      do 16 k=1,id1                                                     gral-088
      if (mf(5,k).ne.1) go to 16                                        gral-089
      kn=mod(nk,15)+1                                                   gral-090
      nk=nk+1                                                           gral-091
      if (nk.eq.1) write (mw,1000)                                      gral-092
      write (mw,1001) gra(kn),(cm(j,k),j=6,10)                          gral-093
   16 continue                                                          gral-094
      if (nk.eq.0) return                                               gral-095
   17 write (mw,1007)                                                   gral-096
      do 18 i=1,112                                                     gral-097
   18 vgr(i)=gra(16)                                                    gral-098
      do 19 i=1,103                                                     gral-099
   19 vgr(i)=gra(17)                                                    gral-100
      do 20 i=2,102,10                                                  gral-101
   20 vgr(i)=gra(2)                                                     gral-102
      write (mw,1003) vgr                                               gral-103
      do 24 i=1,mtheta                                                  gral-104
      do 21 m=2,102                                                     gral-105
   21 vgr(m)=gra(16)                                                    gral-106
      vgr(52)=gra(17)                                                   gral-107
      nk=0                                                              gral-108
      do 22 k=1,id1                                                     gral-109
      if (mf(5,k).ne.1) go to 22                                        gral-110
      nk=mod(nk,15)+1                                                   gral-111
      m=idint(50.d0*grr(k,i)+52.5d0)                                    gral-112
      if (m.gt.1.and.m.le.102) vgr(m)=gra(nk)                           gral-113
   22 continue                                                          gral-114
      if (lt2) go to 23                                                 gral-115
      m=idint(50.d0*frr(i)+52.5d0)                                      gral-116
      if (m.gt.1.and.m.le.102) vgr(m)=gra(2)                            gral-117
   23 write (mw,1006) tgr(i),vgr                                        gral-118
   24 continue                                                          gral-119
      do 25 i=1,103                                                     gral-120
   25 vgr(i)=gra(17)                                                    gral-121
      do 26 i=2,102,10                                                  gral-122
   26 vgr(i)=gra(2)                                                     gral-123
      write (mw,1003) vgr                                               gral-124
      return                                                            gral-125
   27 write (mw,1008) i,grr(1,i)                                        gral-126
      go to 30                                                          gral-127
   28 write (mw,1009) i,grr(1,i)                                        gral-128
      go to 30                                                          gral-129
   29 write (mw,1010) i,frr(i)                                          gral-130
   30 write (mw,1011)                                                   gral-131
      return                                                            gral-132
 1000 format ('1')                                                      gral-133
 1001 format (45x,a1,4x,5a4/)                                           gral-134
 1002 format (45x,'+    calculated value'/45x,'*    experimental value'/gral-135
     1)                                                                 gral-136
 1003 format (7x,112a1)                                                 gral-137
 1004 format (40(' -*'))                                                gral-138
 1005 format (40(' *-'))                                                gral-139
 1006 format (f7.2,112a1)                                               gral-140
 1007 format (//6x,' -1',7x,' -.8',6x,' -.6',6x,' -.4',6x,' -.2',7x,' 0'gral-141
     1,8x,' .2',7x,' .4',7x,' .6',7x,' .8',7x,' 1')                     gral-142
 1008 format (' for the',i4,'th line, calculated value =',d15.8)        gral-143
 1009 format (' for the',i4,'th line, more than 20 translations. calculagral-144
     1ted value =',d15.8)                                               gral-145
 1010 format (' for the',i4,'th line, experimental value =',d15.8)      gral-146
 1011 format (//' **** graph canceled ****')                            gral-147
      end                                                               gral-148
c 29/02/04                                                      ecis03  emro-000
      subroutine emro(ia,i1,i2,x1,x2,x3,res,nx)                         emro-001
c  with ia=2*a, i1=2*f1 and i2=2*f2, calculates the nx                  emro-002
c            a          a+1                     a+n-1                   emro-003
c           r (theta), r (theta) ............. r (theta)                emro-004
c            f1,f2      f1,f2                   f1,f2                   emro-005
c in the array res                                                      emro-006
c it uses the recurrence relation obtained from                         emro-007
c                      j                   j'                           emro-008
c        cos(theta) * r (theta)  = sum  r (theta)                       emro-009
c                      f1,f2       on j'   f1,f2                        emro-010
c theta is given by x1=cos(theta),x2=cos(0.5*theta),x3=sin(0.5*theta)   emro-011
c***********************************************************************emro-012
      implicit real*8 (o-z)                                             emro-013
      dimension res(nx)                                                 emro-014
      nr=1                                                              emro-015
      ja=ia                                                             emro-016
      m1=iabs(i1+i2)/2                                                  emro-017
      m2=iabs(i1-i2)/2                                                  emro-018
      mj=m1+m2                                                          emro-019
      nj=mj                                                             emro-020
    1 if (mj.le.ja) go to 2                                             emro-021
      res(nr)=0.d0                                                      emro-022
      nr=nr+1                                                           emro-023
      if (nr.gt.nx) return                                              emro-024
      ja=ja+2                                                           emro-025
      go to 1                                                           emro-026
    2 s1=0.d0                                                           emro-027
      s2=0.d0                                                           emro-028
      s3=1.d0                                                           emro-029
      if (mj.eq.0) go to 11                                             emro-030
c the magnetic quantum numbers are not both zeros                       emro-031
      if (m1.eq.m2) go to 8                                             emro-032
c no magnetic quantum number is zero                                    emro-033
      if (m2.eq.0) go to 4                                              emro-034
      do 3 i=1,m2                                                       emro-035
    3 s3=s3*x3*dsqrt(dfloat(m1+i)/dfloat(i))                            emro-036
    4 if (m1.eq.0) go to 6                                              emro-037
      do 5 m=1,m1                                                       emro-038
    5 s3=s3*x2                                                          emro-039
    6 if ((i1.gt.i2).and.(2*(m2/2).ne.m2)) s3=-s3                       emro-040
      kx=1                                                              emro-041
      x4=0.d0                                                           emro-042
      z1=dfloat(m1)                                                     emro-043
      z2=dfloat(m2)                                                     emro-044
      sl=(z1-z2)/dfloat(nj+2)                                           emro-045
    7 if (ja.le.nj) go to 13                                            emro-046
c recurrence                                                            emro-047
      nj=nj+2                                                           emro-048
      s2=s3                                                             emro-049
      z1=z1+1.d0                                                        emro-050
      z2=z2+1.d0                                                        emro-051
      mj=mj+1                                                           emro-052
      x4=x4+1.d0                                                        emro-053
      y2=dsqrt(z1*z2*x4*dfloat(mj))                                     emro-054
      sj=dfloat(nj)                                                     emro-055
      s3=(sj-1.d0)*sj*((x1-sl)*s2-s1)/(2.d0*y2)                         emro-056
      s1=2.d0*y2*s2/((sj+1.d0)*sj)                                      emro-057
      sl=sl*(sj-2.d0)/(sj+2.d0)                                         emro-058
      go to 7                                                           emro-059
c a magnetic quantum number is zero                                     emro-060
    8 do 9 i=1,m1                                                       emro-061
    9 s3=s3*x3*x2*dsqrt(dfloat(m1+i)/dfloat(i))                         emro-062
      kx=2                                                              emro-063
      if (i1.gt.i2.and.(2*(m2/2).ne.m2)) s3=-s3                         emro-064
      x4=0.d0                                                           emro-065
   10 if (ja.le.nj) go to 13                                            emro-066
c recurrence                                                            emro-067
      nj=nj+2                                                           emro-068
      s2=s3                                                             emro-069
      mj=mj+1                                                           emro-070
      x4=x4+1.d0                                                        emro-071
      y2=dsqrt(x4*dfloat(mj))                                           emro-072
      s3=(dfloat(nj-1)*x1*s2-s1)/y2                                     emro-073
      s1=y2*s2                                                          emro-074
      go to 10                                                          emro-075
c the magnetic quantum numbers are both zeros                           emro-076
   11 kx=3                                                              emro-077
   12 if (ja.le.nj) go to 13                                            emro-078
c recurrence                                                            emro-079
      nj=nj+2                                                           emro-080
      sj=dfloat(nj/2)                                                   emro-081
      s2=s3                                                             emro-082
      s3=((2.d0*sj-1.d0)*x1*s2-s1)/sj                                   emro-083
      s1=s2*sj                                                          emro-084
      go to 12                                                          emro-085
c storage                                                               emro-086
   13 res(nr)=s3                                                        emro-087
      nr=nr+1                                                           emro-088
      if (nr.gt.nx) return                                              emro-089
      ja=ja+2                                                           emro-090
      go to ( 7 , 10 , 12 ),kx                                          emro-091
      end                                                               emro-092
c 18/04/04                                                      ecis03  vari-000
      subroutine vari(kf,nw,dw,lo)                                      vari-001
c it assigns the values of the variable parameters and                  vari-002
c  prints the output during the search.                                 vari-003
c  kf=1 before the call to the search subroutines                       vari-004
c    at the first call(ke=0) defines the variables in search            vari-005
c    at any call, print chi2 and variables                              vari-006
c  kf=0 after the call to the search subroutines                        vari-007
c    at any call sets parameters to their value for next evaluation     vari-008
c    at the last call(ke/=0) print errors and parameters                vari-009
c input values: ke:         return code of search                       vari-010
c               nise,nrec:  indications on parameters in search, number vari-011
c               npot,npp:   optical model parameters and their number   vari-012
c               nbeta,nbet: deformations and their number               vari-013
c               npaa,nva:   nuclear parameters and their number         vari-014
c               nt:         nuclear matrix elements and their number    vari-015
c               nscn:       level density description for comp. nucleus vari-016
c               nres,ntot:  difference between exp. and calc. values andvari-017
c                               their number                            vari-018
c               ntgx,ncolr: descr. of exp. distr. and their number      vari-019
c               niw,nrc:    integer, floating points results of search  vari-020
c                                  (see fite)                           vari-021
c               nxx:        variables in search                         vari-022
c               nwv,nipp:   masses, spins, ....   see calx              vari-023
c               nivy:       table of form factors  (see redm)           vari-024
c               lo:        logical controls                             vari-025
c by common /ncomp/ ncont: number of continuum for compound nucleus     vari-026
c                   ncons: number of level densities needed             vari-027
c                   az(i): spin-orbit parametrisation for i-1 to 6      vari-028
c                          hauser feshbach parameters for j=7 to 11     vari-029
c                          giant dipole resonance for i=12 to 16        vari-030
c by common /dchi/  : current and minimum chi-square                    vari-031
c                                                                       vari-032
c parameters in search are given by nw(2-mod(i,2),nise+i/2)=index(i)    vari-033
c starting at nw(1,nise) for i=1 to nrec:                               vari-034
c   positive value: parameter defined by index(i)                       vari-035
c   negative value -l: parameters defined by index(j) for j=l+1 to      vari-036
c     j=l+index(l) are defined as the same variable                     vari-037
c      1-1000      optical model,folding parameters                     vari-038
c   1001-2000      deformations for a given potential   - lx(1)=.true.  vari-039
c   2001-3000      deformations for a given multipole   - lx(1)=.true.  vari-040
c   3001-4000      individual deformation               - lx(1)=.true.  vari-041
c   4001-5000      nuclear model parameter              - lo(211)=.true.vari-042
c   5001-6000      nuclear matrix element               - lx(2)=.true.  vari-043
c   6001-7000      spin-orbit and c. n. parametrisation                 vari-044
c                  spin-orbit parametrisation           - lx(3)=.true.  vari-045
c                  bz1, bz2, bz3, bz4, bz5      - lo(212)=lx(4)=.true.  vari-046
c                  tgo, bn, fnug, egd, ggd      - lo(212)=lx(5)=.true.  vari-047
c   for gamma      sa, ux, tau, sg, e0, ex      - lo(212)=lx(6)=.true.  vari-048
c   for continuum  sa, ux, tau, sg, e0, ex      - lo(214)=lx(7)=.true.  vari-049
c                  gamma transmission factors           - lx(8)=.true.  vari-050
c                  fission tr. coef., degree of freedom - lx(9)=.true.  vari-051
c   7001-8000      dispersion relations parametrisation - lo(213)=.true.vari-052
c  10001-99999     external optical model (parameters above 1000)       vari-053
c it stops the calculation for an index of parameter out of range       vari-054
c***********************************************************************vari-055
      implicit real*8 (a-h,o-z)                                         vari-056
      logical lo(250),lx(9)                                             vari-057
      dimension r0(8),nw(2,1),dw(1)                                     vari-058
      common /decou/ njit,nipp,npaa,nwv,niph,nscn,npar,nniv,nfis,ngam,npvari-059
     1ot,nbeta,nfm,ntgx,ndonn,nrc,niw,nde,nise,nnvi,nnwi,ncc,mcc,nxa,namvari-060
     21,nfac,nfam,npad,nfg,nxg,nsm,nres,nxx,nt,nivq,nivy,nivz,ncoi,mipi,vari-061
     3nxd,mwv,nixt,nty,ntx,nry,nrco,nrdo,nvc1,nvc2,nnc,ncx,idmt,ncoll,njvari-062
     4max,iterm,npp,jdm,jit,nsec,lmd,mcm(2),ncols,ncolt,kmax,kmin,nva,nbvari-063
     5et,nbt1,lmx,lmax1,nlt,ism,iqm,iqmax,ms1,ms2,nct(6),kba,kab,kbc,kccvari-064
     6,njc,jtx,jth,ncolr,nrec,ntot,nfa,lmax2,ke,itemm,nplace,kxt,nrz,ntzvari-065
     7,lmax3,ipm,ipk,bjm,eiter,aconv,conj,h,nspin                       vari-066
      common /ncomp/ nsp(3),nfiss,nrd,ncont,ncj,ncons,nco(4),acn(2),az(1vari-067
     18)                                                                vari-068
      common /dchi/ chi2,chi2m,yy(3)                                    vari-069
      common /inout/ mr,mw,ms                                           vari-070
c transfer between variables and parameters                             vari-071
      if (kf.eq.1.and.ke.ne.0) go to 34                                 vari-072
      do 1 i=211,214                                                    vari-073
    1 lo(i)=.false.                                                     vari-074
      do 2 i=1,9                                                        vari-075
    2 lx(i)=.false.                                                     vari-076
      do 33 i=1,nrec                                                    vari-077
      j=nw(2-mod(i,2),nise+(i-1)/2)                                     vari-078
      jj=iabs(j)                                                        vari-079
      if (j.ne.jj) go to 3                                              vari-080
      j1=i                                                              vari-081
      j2=i                                                              vari-082
      go to 4                                                           vari-083
    3 j1=jj+1                                                           vari-084
      j2=j1+nw(2-mod(jj,2),nise+(jj-1)/2)-1                             vari-085
    4 do 32 k=j1,j2                                                     vari-086
      j=nw(2-mod(k,2),nise+(k-1)/2)                                     vari-087
      if ((j.gt.1000).and.(j.le.10000)) go to 9                         vari-088
c optical model and folding parameters                                  vari-089
      if (j.gt.10000) j=j-9000                                          vari-090
      if (lo(7)) go to 5                                                vari-091
      if (j.gt.34*npp.or.mod(j,34).eq.19) go to 65                      vari-092
      go to 7                                                           vari-093
c external optical parameters                                           vari-094
    5 i1=nw(1,npot)-1                                                   vari-095
      do 6 l=1,i1                                                       vari-096
      if (j.ge.nw(1,npot+l).and.j.le.nw(2,npot+l)) go to 7              vari-097
    6 continue                                                          vari-098
      go to 65                                                          vari-099
    7 if (kf.ne.0) go to 8                                              vari-100
      if (k.eq.j1) rap=dw(nxx+i-1)/dw(npot+j-1)                         vari-101
      dw(npot+j-1)=rap*dw(npot+j-1)                                     vari-102
      go to 32                                                          vari-103
    8 dw(nxx+i-1)=dw(npot+j-1)                                          vari-104
      go to 33                                                          vari-105
    9 j=j-1000                                                          vari-106
      if (j.gt.1000) go to 14                                           vari-107
      if (j.gt.6) go to 65                                              vari-108
c  deformations for a given potential                                   vari-109
      lx(1)=.true.                                                      vari-110
      do 10 k1=1,nbet                                                   vari-111
      if (lo(1).and.lo(3).and.nw(2,nbeta+9*k1-1).ne.0) go to 10         vari-112
      if (dw(nbeta+9*k1+j-10).ne.0.d0) go to 11                         vari-113
   10 continue                                                          vari-114
      write (mw,1000) i,nw(2-mod(k,2),nise+(k-1)/2),j                   vari-115
      go to 66                                                          vari-116
   11 if (kf.eq.0) go to 12                                             vari-117
      dw(nxx+i-1)=dw(nbeta+9*k1+j-10)                                   vari-118
      go to 33                                                          vari-119
   12 if (k.eq.j1) rap=dw(nxx+i-1)/dw(nbeta+9*k1+j-10)                  vari-120
      do 13 l=k1,nbet                                                   vari-121
      if (lo(1).and.lo(3).and.nw(2,nbeta+9*k1-1).ne.0) go to 13         vari-122
      dw(nbeta+9*l+j-10)=dw(nbeta+9*l+j-10)*rap                         vari-123
   13 continue                                                          vari-124
      go to 32                                                          vari-125
   14 j=j-1000                                                          vari-126
      if (j.gt.1000) go to 19                                           vari-127
c deformations for a given multipole                                    vari-128
      if (j.gt.nbet) go to 65                                           vari-129
      lx(1)=.true.                                                      vari-130
      do 15 k1=1,8                                                      vari-131
      if (dw(nbeta+9*j+k1-10).ne.0.d0) go to 16                         vari-132
   15 continue                                                          vari-133
      write (mw,1001) i,nw(2-mod(k,2),nise+(k-1)/2),j                   vari-134
      go to 66                                                          vari-135
   16 if (kf.eq.0) go to 17                                             vari-136
      dw(nxx+i-1)=dw(nbeta+9*j+k1-10)                                   vari-137
      go to 33                                                          vari-138
   17 if (k.eq.j1) rap=dw(nxx+i-1)/dw(nbeta+9*j+k1-10)                  vari-139
      do 18 l=k1,8                                                      vari-140
   18 dw(nbeta+9*j+l-10)=dw(nbeta+9*j+l-10)*rap                         vari-141
      go to 32                                                          vari-142
   19 j=j-1000                                                          vari-143
      if (j.gt.1000) go to 20                                           vari-144
c individual deformations                                               vari-145
      if ((j.gt.10*nbet).or.(mod(j,10).gt.8)) go to 65                  vari-146
      lx(1)=.true.                                                      vari-147
      jk=nbeta+j-1-(j-10)/10                                            vari-148
      go to 30                                                          vari-149
   20 j=j-1000                                                          vari-150
      if (j.gt.1000) go to 21                                           vari-151
c  nuclear parameters                                                   vari-152
      if (j.gt.nva) go to 65                                            vari-153
      lo(211)=.true.                                                    vari-154
      jk=npaa+j-1                                                       vari-155
      go to 30                                                          vari-156
   21 j=j-1000                                                          vari-157
      if (j.gt.1000) go to 22                                           vari-158
c  nuclear matrix elements                                              vari-159
      if (3*j.gt.nivq-nt) go to 65                                      vari-160
      lx(2)=.true.                                                      vari-161
      jk=nt+3*j-1                                                       vari-162
      go to 30                                                          vari-163
   22 j=j-1000                                                          vari-164
      if (j.gt.1000) go to 28                                           vari-165
c  spin-orbit and h. f. parametrisation                                 vari-166
      if (j.gt.16+6*ncons+nrd+nfiss) go to 65                           vari-167
      if (lo(181).and.j.gt.6) go to 65                                  vari-168
      if (j.gt.16) go to 25                                             vari-169
      if (lo(104).and.j.le.6) go to 65                                  vari-170
      lx(3)=lx(3).or.(j.le.6)                                           vari-171
      if (lx(3).and.lo(104)) go to 65                                   vari-172
      if (j.le.6) go to 23                                              vari-173
      lx(4)=lx(4).or.(j.le.11)                                          vari-174
      lx(5)=lx(5).or.(j.gt.11)                                          vari-175
      if (lo(181)) go to 65                                             vari-176
      if (lo(82).and.j.gt.9) go to 65                                   vari-177
      if (lo(186).and.j.gt.11) go to 65                                 vari-178
      if (lo(82)) go to 23                                              vari-179
      if (j.ne.9.and.j.le.11.and.lo(87)) go to 65                       vari-180
      if (lo(87)) go to 23                                              vari-181
      if (j.eq.7) go to 65                                              vari-182
      if (az(8).ne.0.d0.and.j.gt.8.and.j.le.11) go to 65                vari-183
      if (az(8).eq.0.d0.and.j.eq.8) go to 65                            vari-184
   23 if (kf.ne.0) go to 24                                             vari-185
      if (k.eq.j1) rap=dw(nxx+i-1)/az(j)                                vari-186
      az(j)=rap*az(j)                                                   vari-187
      go to 32                                                          vari-188
   24 dw(nxx+i-1)=az(j)                                                 vari-189
      go to 33                                                          vari-190
   25 j=j-16+(j-17)/6                                                   vari-191
      if (j.gt.7*ncons) go to 26                                        vari-192
      if (j.le.7*(ncons-ncont)) lx(6)=.true.                            vari-193
      if (j.gt.7*(ncons-ncont)) lx(7)=.true.                            vari-194
      jk=nscn+j-1                                                       vari-195
      go to 30                                                          vari-196
   26 j=j-7*ncons                                                       vari-197
      if (j.gt.nrd) go to 27                                            vari-198
      lx(8)=.true.                                                      vari-199
      jk=ngam+j-1                                                       vari-200
      go to 30                                                          vari-201
   27 j=j-nrd                                                           vari-202
      lx(9)=.true.                                                      vari-203
      jk=nfis+j-1                                                       vari-204
      go to 30                                                          vari-205
   28 j=j-1000                                                          vari-206
      if (j.gt.12*npp) go to 65                                         vari-207
      jn=j/12                                                           vari-208
      jj=j-12*jn                                                        vari-209
      if ((jj.lt.6).or.(jj.eq.12)) go to 29                             vari-210
      if ((nw(1,nipp+15*jn+1).eq.0).and.(j.le.8)) go to 65              vari-211
      if ((nw(2,nipp+15*jn+1).eq.0).and.(j.gt.8)) go to 65              vari-212
   29 jk=nipp+2+jj+3*jn                                                 vari-213
      lo(213)=.true.                                                    vari-214
   30 if (kf.eq.0) go to 31                                             vari-215
      dw(nxx+i-1)=dw(jk)                                                vari-216
      go to 33                                                          vari-217
   31 if (k.eq.j1) rap=dw(nxx+i-1)/dw(jk)                               vari-218
      dw(jk)=rap*dw(jk)                                                 vari-219
   32 continue                                                          vari-220
   33 continue                                                          vari-221
      lo(212)=lx(4).or.lx(5).or.lx(6)                                   vari-222
      lo(214)=lx(7)                                                     vari-223
   34 if (kf.eq.0) go to 36                                             vari-224
      write (mw,1002) nw(1,niw+1),nw(2,niw),chi2,(yy(i),i=1,3)          vari-225
      write (mw,1003)                                                   vari-226
      do 35 i=1,ncolr                                                   vari-227
      if (dw(ntgx+7*i-1).ne.0.d0) write (mw,1004) i,(dw(ntgx+7*i+j-8),j=vari-228
     13,7)                                                              vari-229
   35 continue                                                          vari-230
      write (mw,1005) (i,dw(nxx+i-1),i=1,nrec)                          vari-231
      if (lo(178)) write (mw,1006) (i,dw(nres+i-1),i=1,ntot)            vari-232
      return                                                            vari-233
   36 if (ke.eq.1) return                                               vari-234
      write (mw,1007) nw(1,niw+1),nw(2,niw),chi2,ke,yy(1)               vari-235
      if (ke*(ke-3).ne.0.or.dw(nrc).le.0.d0) go to 38                   vari-236
      write (mw,1008) nw(2,niw+1),yy(3),(dw(nrc+i-1),i=1,nrec)          vari-237
      write (mw,1009) (dw(nrc+nrec+i-1),i=1,nrec)                       vari-238
      write (mw,1010)                                                   vari-239
      l=2*nrec+nrc-1                                                    vari-240
      do 37 i=1,nrec                                                    vari-241
      k=l+1                                                             vari-242
      l=l+i                                                             vari-243
   37 write (mw,1011) (dw(j),j=k,l)                                     vari-244
      go to 39                                                          vari-245
   38 write (mw,1012)                                                   vari-246
   39 if (ke.eq.0) write (mw,1013)                                      vari-247
      if (ke.eq.2) write (mw,1014)                                      vari-248
      if (ke.eq.3) write (mw,1015)                                      vari-249
      if (ke.eq.4) write (mw,1016)                                      vari-250
      if (ke.eq.5) write (mw,1017) nw(2,niw+1)                          vari-251
      if (ke.eq.6) write (mw,1018) nw(1,niw+1),nw(2,niw+1)              vari-252
      if (ke.eq.7) write (mw,1019) ntot,nrec                            vari-253
c end of the search                                                     vari-254
      lo(216)=.false.                                                   vari-255
      lo(218)=.true.                                                    vari-256
      if (lo(76)) go to 41                                              vari-257
      do 40 i=51,65                                                     vari-258
      lo(i)=lo(i+185)                                                   vari-259
   40 lo(i+100)=.not.lo(i)                                              vari-260
   41 lo(220)=lo(153).and.lo(155).and.lo(156).and.lo(157).and.lo(158).anvari-261
     1d.lo(160).and.lo(162).and.lo(164)                                 vari-262
      if (lo(41)) lo(220)=lo(220).and.lo(165)                           vari-263
      lo(219)=lo(220).and.lo(151).and.lo(164).and.lo(165)               vari-264
      lo(220)=chi2.eq.chi2m.and.lo(220)                                 vari-265
c output of final parameters                                            vari-266
      write (mw,1020) (lo(j),j=1,100)                                   vari-267
      if (lo(7)) go to 44                                               vari-268
      npo=npot-1                                                        vari-269
      do 43 j=1,npp                                                     vari-270
      ij=iabs(nw(1,nipp+15*j-15))                                       vari-271
      am3=dw(nwv+18*ij-17)**.33333333333333d0                           vari-272
      if (lo(16)) am3=am3+dw(nwv+18*ij-18)**.33333333333333d0           vari-273
      write (mw,1021) j,am3                                             vari-274
      do 42 i=1,8                                                       vari-275
   42 r0(i)=dw(npo+3*i-1)/am3                                           vari-276
      write (mw,1022) (dw(npo+3*i-2),dw(npo+3*i-1),r0(i),dw(npo+3*i),i=1vari-277
     1,8),dw(npo+25)                                                    vari-278
      if (lo(17)) write (mw,1023) (dw(npo+i),i=26,34)                   vari-279
   43 npo=npo+1                                                         vari-280
      go to 56                                                          vari-281
   44 nvma=nw(1,npot)                                                   vari-282
      write (mw,1024)                                                   vari-283
   45 if (nvma.ge.nw(1,npot+1)) go to 55                                vari-284
      i1=nw(1,nvma+npot-1)                                              vari-285
      iv=nw(2,nvma+npot-1)                                              vari-286
      if (iv.eq.16) go to 54                                            vari-287
      it1=mod(i1-1,8)+1                                                 vari-288
      j1=(i1-1)/8                                                       vari-289
      i2=nw(1,npot+i1-7)                                                vari-290
      i3=nw(2,npot+i1-7)                                                vari-291
      if (iv.ge.0) go to 46                                             vari-292
      write (mw,1025) it1,j1,i2,i3,(dw(npot+i-1),i=i2,i3)               vari-293
      go to 54                                                          vari-294
   46 if (iv.lt.9) go to 47                                             vari-295
      write (mw,1026) it1,j1,iv,i2,i3,(dw(npot+i-1),i=i2,i3)            vari-296
      go to 54                                                          vari-297
   47 if (iv.gt.6) go to 53                                             vari-298
      write (mw,1027) it1,j1,iv,i2,i3,(dw(npot+i-1),i=i2,i3)            vari-299
      nst=nw(1,npot+nvma+1)                                             vari-300
      if (nst.gt.0) go to 50                                            vari-301
      k=iabs(nst)                                                       vari-302
      ex=dw(nwv+18*k-17)**.33333333333333d0                             vari-303
      ey=ex                                                             vari-304
      if (lo(16)) ex=ex+dw(nwv+18*k-18)**.33333333333333d0              vari-305
      ey=ey/ex                                                          vari-306
      ex=dw(npot+i2)/ex                                                 vari-307
      ez=dw(npot+i2-1)                                                  vari-308
      if (lo(116).or.j1.le.npp) go to 49                                vari-309
      ityz=iv                                                           vari-310
      if (ityz.ge.5) ityz=ityz-4                                        vari-311
      ityw=1                                                            vari-312
      if (it1.le.6) go to 48                                            vari-313
      iti=7*(j1-npp)                                                    vari-314
      ityw=ityw*nw(2-mod(iti,2),nivy+(iti-1)/2)                         vari-315
   48 if (lo(6)) ityw=ityw-1                                            vari-316
      if (ityz.gt.1) ez=ez/ey**((ityz-1)*ityw)                          vari-317
   49 write (mw,1028) ez,ex                                             vari-318
   50 if ((iv.ne.5).and.(iv.ne.6)) go to 54                             vari-319
      write (mw,1029) i2,i3,(dw(npot+i-1),i=i2,i3)                      vari-320
      if (nst.gt.0) go to 54                                            vari-321
      write (mw,1030)                                                   vari-322
      nmb=0                                                             vari-323
   51 nma=i2                                                            vari-324
      i4=i2+7                                                           vari-325
      do 52 i=i2,i4                                                     vari-326
      nmb=nmb+1                                                         vari-327
      j=i-nma                                                           vari-328
      if (it1.lt.7) j=0                                                 vari-329
      if (lo(106)) j=j+1                                                vari-330
   52 r0(nmb)=dw(npot+i-1)/ey**j                                        vari-331
      write (mw,1011) (r0(i),i=1,nmb)                                   vari-332
      i2=i2+8                                                           vari-333
      if (i2.le.i3) go to 51                                            vari-334
      go to 54                                                          vari-335
   53 write (mw,1027) it1,j1,iv,i2,i3,(dw(npot+i-1),i=i2,i3)            vari-336
   54 nvma=i3+1                                                         vari-337
      go to 45                                                          vari-338
   55 nvmb=nw(2,npot+1)                                                 vari-339
      if (nvma.lt.nvmb) write (mw,1031) (dw(npot+i-1),i=nvma,nvmb)      vari-340
   56 if (.not.lx(1)) go to 64                                          vari-341
      write (mw,1032) (i,nw(1,nbeta+9*i-1),nw(2,nbeta+9*i-1),(dw(nbeta+9vari-342
     1*i+j-10),j=1,8),i=1,nbet)                                         vari-343
      if (lo(116)) go to 64                                             vari-344
      dm=dw(nwv+1)**.33333333333333d0/(dw(nwv)**.33333333333333d0+dw(nwvvari-345
     1+1)**.33333333333333d0)                                           vari-346
      write (mw,1033)                                                   vari-347
      do 63 i=1,nbet                                                    vari-348
      k1=0                                                              vari-349
      k2=0                                                              vari-350
      if (lo(3)) go to 58                                               vari-351
   57 k1=1                                                              vari-352
      k2=nw(1,nbeta+9*i-1)                                              vari-353
      go to 60                                                          vari-354
   58 if (lo(1)) go to 59                                               vari-355
      k1=i-1                                                            vari-356
      k2=k1*nw(1,nbeta+9*i-1)                                           vari-357
      go to 60                                                          vari-358
   59 if (nw(2,nbeta+9*i-1).eq.0) go to 57                              vari-359
   60 if (lo(106)) go to 61                                             vari-360
      k2=k2-k1                                                          vari-361
      k1=0                                                              vari-362
   61 do 62 j=1,6                                                       vari-363
   62 r0(j)=dw(nbeta+9*i+j-10)/dm**k1                                   vari-364
      r0(7)=dw(nbeta+9*i-3)/dm**k2                                      vari-365
      r0(8)=dw(nbeta+9*i-2)/dm**k2                                      vari-366
   63 write (mw,1034) i,nw(1,nbeta+9*i-1),nw(2,nbeta+9*i-1),r0          vari-367
   64 if (lo(211)) write (mw,1035) (dw(npaa+j-1),i=1,nva)               vari-368
      if (lx(2)) write (mw,1036) (dw(i+2),i=nt,nivq,3)                  vari-369
      if (lx(3)) write (mw,1037) (az(i),i=1,6)                          vari-370
      if (lx(4)) write (mw,1038) (az(i),i=7,11)                         vari-371
      if (lx(5)) write (mw,1039) (az(i),i=12,16)                        vari-372
      if (lx(6)) write (mw,1040) (i,(dw(nscn+7*i+j-8),j=1,7),i=1,1)     vari-373
      if (lx(7)) write (mw,1040) (i,(dw(nscn+7*i+j-8),j=1,7),i=1+ncons-nvari-374
     1cont,ncons)                                                       vari-375
      if (lx(8)) write (mw,1041) (i,dw(ngam+i-1),i=1,nrd)               vari-376
      if (lx(9)) write (mw,1042) (i,(dw(nfis+2*i+j-3),j=1,2),i=1,nfiss) vari-377
      if (lo(213)) write (mw,1043) (i,(dw(nipp+15*i+j-16),j=4,16),i=1,npvari-378
     1p)                                                                vari-379
      return                                                            vari-380
   65 write (mw,1044) i,nw(2-mod(k,2),nise+(k-1)/2),j                   vari-381
   66 write (mw,1045)                                                   vari-382
      stop                                                              vari-383
 1000 format (' the variable',i3,' cannot be used because ',i5,'  is a vvari-384
     1ariation of the deformations of potential',i3,' which are zero')  vari-385
 1001 format (' the variable',i3,' cannot be used because ',i5,'  is a vvari-386
     1ariation for a given multipole',i3,' and they are zero')          vari-387
 1002 format (/' run',i4,'   max =',i4,'   ***** chi2 =',d18.10,' *****'vari-388
     1,5x,'w(1) =',f10.2,5x,'w(2) =',f5.2,5x,'w(3) =',f10.5)            vari-389
 1003 format (/21x,'weight',12x,'exp. norm.',10x,'err. norm.',10x,'calc.vari-390
     1 norm.',12x,'chi2')                                               vari-391
 1004 format (5x,i5,1p,5d20.6)                                          vari-392
 1005 format (/' *** variables'//(6(1x,i3,1p,d16.6)))                   vari-393
 1006 format (/' *** functions'//(6(1x,i3,1p,d16.6)))                   vari-394
 1007 format (/' run',i4,'   max =',i4,'   ***** chi2 =',d18.10,' *****'vari-395
     1,5x,'ke =',i2,5x,'w(1) =',f12.4)                                  vari-396
 1008 format (//' standard errors (variance at best fit equal to degree vari-397
     1of freedom:',i6,'.renormalisation factor',d15.6,' )'/(1p,8d15.6)) vari-398
 1009 format (/' error enhancements (multi/single variable error)'/(1p,8vari-399
     1d15.6))                                                           vari-400
 1010 format (/' error correlation matrix')                             vari-401
 1011 format (1p,8d15.6)                                                vari-402
 1012 format (//' no information on errors')                            vari-403
 1013 format (//' search ended without errors')                         vari-404
 1014 format (//' search interrupted by user')                          vari-405
 1015 format (//' search ended by number of evaluations')               vari-406
 1016 format (//' search ended for rounding errors')                    vari-407
 1017 format (//' search ended because the functions do not depend on thvari-408
     1e variable',i6)                                                   vari-409
 1018 format (//' search ended because variables',2i6,' are useless in pvari-410
     1reparatory calls')                                                vari-411
 1019 format (//' search ended because the number of parameters',i4,' isvari-412
     1 larger than the number of data',i4)                              vari-413
 1020 format ('1'/' ******* final results *******'//' **** first controlvari-414
     1 card ****',2x,'1 ',9(' 1'),' 2 ',9(' 2'),' 3 ',9(' 3'),' 4 ',9(' vari-415
     24'),' 5'/11x,5('  1 2 3 4 5 6 7 8 9 0')/11x,5(1x,10l2)//' *** secovari-416
     3nd control card ****',2x,'1 ',9(' 1'),' 2 ',9(' 2'),' 3 ',9(' 3'),vari-417
     4' 4 ',9(' 4'),' 5'/11x,5('  1 2 3 4 5 6 7 8 9 0')/11x,5(1x,10l2)/)vari-418
 1021 format (/' optical potentials  **',i3,' **     reduced radius multvari-419
     1iplied by  ',d15.6/)                                              vari-420
 1022 format (' volume real potential',11x,'depth',f12.6,' mev  radius',vari-421
     1f10.6,' fermi (reduced',f9.6,')  diffuseness',f9.6,' fermi'/' voluvari-422
     2me imaginary potential',6x,'depth',f12.6,' mev  radius',f10.6,' fevari-423
     3rmi (reduced',f9.6,')  diffuseness',f9.6,' fermi'/' surface real pvari-424
     4otential',10x,'depth',f12.6,' mev  radius',f10.6,' fermi (reduced'vari-425
     5,f9.6,')  diffuseness',f9.6,' fermi'/' surface imaginary potentialvari-426
     6',5x,'depth',f12.6,' mev  radius',f10.6,' fermi (reduced',f9.6,') vari-427
     7 diffuseness',f9.6,' fermi'/' real spin-orbit potential',7x,'depthvari-428
     8',f12.6,' mev  radius',f10.6,' fermi (reduced',f9.6,')  diffusenesvari-429
     9s',f9.6,' fermi'/' imaginary spin-orbit potential  depth',f12.6,' vari-430
     amev  radius',f10.6,' fermi (reduced',f9.6,')  diffuseness',f9.6,' vari-431
     bfermi'/' coulomb potential  product of charges',f12.6,6x,'radius',vari-432
     ff10.6,' fermi (reduced',f9.6,')  diffuseness',f9.6,' fermi'/' spinvari-433
     d-orbit coulomb potential    depth',f12.6,6x,'radius',f10.6,' fermivari-434
     e (reduced',f9.6,')  diffuseness',f9.6,' fermi'/14x,'third charge pvari-435
     farameter',f9.6)                                                   vari-436
 1023 format (/' *** folding model ***'/' real part',10x,'v =',f10.4,6x,vari-437
     1'r =',f10.4,6x,'a =',f10.4/' imaginary part',6x,'v =', f10.4,6x,'rvari-438
     2 =',f10.4,6x,'a =',f10.4/' coulomb part',7x,'v =',f10.4,6x,'r =',fvari-439
     310.4,6x,'a =',f10.4)                                              vari-440
 1024 format (/' **** external potential parameters ****'/)             vari-441
 1025 format (' (',i1,',',i2,') given by points with the parameters fromvari-442
     1',i4,' to',i4/1p,2d15.6/(1p,8d15.6))                              vari-443
 1026 format (' (',i1,',',i2,') type',i3,' from',i4,' to',i4/1p,2d15.6/(vari-444
     11p,8d15.6))                                                       vari-445
 1027 format (' (',i1,',',i2,') type',i3,' from',i4,' to',i4,4x,6d14.6/(vari-446
     17x,8d14.6))                                                       vari-447
 1028 format (' values read:',f12.6,3x,f9.6)                            vari-448
 1029 format (' deformations: parameters from',i4,' to ',i4,10x,4d18.6/(vari-449
     152x,4d18.6))                                                      vari-450
 1030 format (' deformations read:')                                    vari-451
 1031 format (' folding parameters:',3f10.5/(20x,3f10.5))               vari-452
 1032 format (/' beta(i,j) for  l   k',9x,'v',9x,'w',8x,'vs',8x,'ws',7x,vari-453
     1'vso',7x,'wso',6x,'coul s.o. coul'/(5x,i5,5x,i2,2x,i2,2x,8f10.5)) vari-454
 1033 format (/10x,'without heavy ion correction'/)                     vari-455
 1034 format (5x,i5,5x,i2,2x,i2,2x,8f10.5)                              vari-456
 1035 format (/' *** nuclear variables ***'//(1x,6f20.6))               vari-457
 1036 format (/' *** nuclear matrix elements ***'//(1x,6f20.6))         vari-458
 1037 format (/' *** spin-orbit parametrisation ***'//1x,6f20.6/)       vari-459
 1038 format (/' *** hauser-feshbach corrections ***'//1x,5f20.6/)      vari-460
 1039 format (/' *** giant dipole resonance param. ***'//1x,5f20.6/)    vari-461
 1040 format (/' *** density of states ***'//(1x,i3,'  sa:',d13.6,6x,'uxvari-462
     1:',d13.6,5x,'tau:',d13.6,6x,'sg:',d13.6/28x,'e0:',d13.6,6x,'ex:',dvari-463
     213.6,7x,'z:',f5.0))                                               vari-464
 1041 format (/' *** gamma transmission coefficients ***'//(1x,4(i5,f20.vari-465
     16)))                                                              vari-466
 1042 format (/' *** fission data ***'//(1x,2(i5,2f20.6)))              vari-467
 1043 format (/' *** dispersion relation parameters ***'//(' potential',vari-468
     1i5/1x,6f20.6/1x,6f20.6/1x,f20.6))                                 vari-469
 1044 format (' variable',i3,' defined by',i5,i4,' cannot be used')     vari-470
 1045 format (/' in vari  ...  stop')                                   vari-471
      end                                                               vari-472c 29/02/04                                                      ecis03  eval-000
      subroutine eval(nw,dw,cm,lo)                                      eval-001
c this subroutine changes some parameters to do a new calculation.      eval-002
c the values read here are absolute changes ( nex=0 ),                  eval-003
c relative changes ( nex>0 ) or percentages ( nex<0 ).                  eval-004
c if the laboratory energy is changed, coulomb functions and reduced    eval-005
c nuclear matrix elements are recalculated even if they are not modifiedeval-006
c if nuclear parameters are changed, reduced nuclear matrix elements areeval-007
c calculated again. in all the others cases, the computation restarts   eval-008
c with the computation of potentials.                                   eval-009
c indexes for parameters are the ones used in search (see vari)         eval-010
c however 0 means energy in the laboratory system.                      eval-011
c input variables:nwv,nipp:   description of levels (see calx)          eval-012
c                 npot,npp:   optical model and folding and their numbereval-013
c                 nbeta,nbet: deformations and their number             eval-014
c                 nvaa,nva:   nuclear parameters:their number is nva    eval-015
c                 nt,(nivq-nt)/3: reduced nuclear matrix elements,numbereval-016
c                 nscn:       description of level densities            eval-017
c                 niw:        maximum number of runs for a search       eval-018
c                 nivy:       table of form factors  (see redm)         eval-019
c                 lo: logical controls,returns lo(215)=.true. if energy eval-020
c in common /dchi/yy:       first step size of search in yy(1)          eval-021
c working space:  from ncx: for input                                   eval-022
c common /ncomp/nfiss: number of fission transmission coefficients      eval-023
c               nrd:   number of gamma transmission coefficients        eval-024
c               ncons: number of level densities needed                 eval-025
c               ncolx: total number of levels without discretisation    eval-026
c               az(i): spin-orbit parametrisation for i-1 to 6          eval-027
c                      hauser feshbach parameters for j=7 to 11         eval-028
c                      giant dipole resonance description for i=12 to 16eval-029
c meaning of index and logical returned:                                eval-030
c      1-1000      optical model,folding parameters                     eval-031
c   1001-2000      deformations for a given potential                   eval-032
c   2001-3000      deformations for a given multipole                   eval-033
c   3001-4000      individual deformation                               eval-034
c   4001-5000      nuclear model parameter              - lo(211)=.true.eval-035
c   5001-6000      nuclear matrix element                               eval-036
c   9001-7000      spin-orbit and c. n. parametrisation                 eval-037
c                  spin-orbit parametrisation                           eval-038
c                  bz1, bz2, bz3, bz4, bz5              - lo(212)=.true.eval-039
c                  tgo, bn, fnug, egd, ggd              - lo(212)=.true.eval-040
c                  sa, ux, tau, sg, e0, ex for gamma    - lo(212)=.true.eval-041
c                  sa, ux, tau, sg, e0, ex for continuum- lo(214)=.true.eval-042
c                  gamma transmission factors                           eval-043
c                  fission tr. coef., degree of freedom                 eval-044
c   7001-8000      dispersion relations parametrisation - lo(213)=.true.eval-045
c  10001-99999     external optical model (parameters above 1000)       eval-046
c it stops the calculation for an index of parameter out of range       eval-047
c working space: ind,x equivalent by call                               eval-048
c***********************************************************************eval-049
      implicit real*8 (a-h,o-z)                                         eval-050
      logical lo(250),lx                                                eval-051
      dimension dw(1000),nw(2,1000)                                     eval-052
      character*4 aa(2),title                                           eval-053
      character*8 bb(2,2)                                               eval-054
      common /decou/ njit,nipp,npaa,nwv,niph,nscn,npar,nniv,nfis,ngam,npeval-055
     1ot,nbeta,nfm,ntgx,ndonn,nrc,niw,nde,nise,nnvi,nnwi,ncc,mcc,nxa,nameval-056
     21,nfac,nfam,npad,nfg,nxg,nsm,nres,nxx,nt,nivq,nivy,nivz,ncoi,mipi,eval-057
     3nxd,mwv,nixt,nty,ntx,nry,nrco,nrdo,nvc1,nvc2,nnc,ncx,idmt,ncoll,njeval-058
     4max,iterm,npp,jdm,jit,nsec,lmd,mcm(2),ncols,ncolt,kmax,kmin,nva,nbeval-059
     5et,nbt1,lmx,lmax1,nlt,ism,iqm,iqmax,ms1,ms2,nct(6),kba,kab,kbc,kcceval-060
     6,njc,jtx,jth,ncolr,nrec,ntot,nfa,lmax2,ke,itemm,nplace,kxt,nrz,ntzeval-061
     7,lmax3,ipm,ipk,bjm,eiter,aconv,conj,h,nspin                       eval-062
      common /titr/ title(18)                                           eval-063
      common /ncomp/ nsp(3),nfiss,nrd,ncont,ncj,ncons,nco,ncolx,nr(2),aceval-064
     1(2),az(18)                                                        eval-065
      common /dchi/ chi2,chi2m,yy(3)                                    eval-066
      common /inout/ mr,mw,ms                                           eval-067
      data aa /' new','last'/                                           eval-068
      data bb /'increase','s )     ','new valu','es )    '/             eval-069
      nvat=34*npp                                                       eval-070
      lo(37)=.false.                                                    eval-071
      lx=.false.                                                        eval-072
      read (mr,1000) lo(37),lx,nin,nex,yy(1)                            eval-073
      lo(137)=.not.lo(37)                                               eval-074
      if (lx) read (mr,1001) title                                      eval-075
      nx=min0(1,max0(nex,-1))+2                                         eval-076
      i1=1                                                              eval-077
      i2=1                                                              eval-078
      if (lo(137)) i1=2                                                 eval-079
      if (nx.eq.2) i2=2                                                 eval-080
      write (mw,1002) aa(i1),nin,bb(1,i2),bb(2,i2)                      eval-081
      if (nx.eq.1) write (mw,1003)                                      eval-082
      do 1 i=211,220                                                    eval-083
    1 lo(i)=.false.                                                     eval-084
      if (ncx+2*nin.gt.idmt) call memo('eval',idmt,ncx+2*nin,1)         eval-085
      read (mr,1004) (nw(1,2*i+ncx-2),i=1,nin)                          eval-086
      read (mr,1005) (dw(2*i+ncx-1),i=1,nin)                            eval-087
      do 49 i=1,nin                                                     eval-088
      nw(1,2*i+ncx-2)=max0(0,nw(1,2*i+ncx-2))                           eval-089
      j=mod(nw(1,2*i+ncx-2),1000)                                       eval-090
      ik=(nw(1,2*i+ncx-2)+1999)/1000                                    eval-091
      ey=dw(2*i+ncx-1)                                                  eval-092
      if (ik.ne.1) go to 8                                              eval-093
c energy in the laboratory system                                       eval-094
      lo(215)=.true.                                                    eval-095
      dw(nwv+11)=ey                                                     eval-096
      ex=dw(nwv+2)                                                      eval-097
      if (nx.ne.2) go to 7                                              eval-098
    2 if (lo(8)) go to 3                                                eval-099
      dw(nwv+2)=ey*dw(nwv+1)/(dw(nwv)+dw(nwv+1))                        eval-100
      go to 4                                                           eval-101
c relativistic c.-m. energy ecm=sqrt((m1+m2)**2+2*m2*elab))-m1-m2       eval-102
    3 dw(nwv+2)=cm*(dsqrt((dw(nwv)+dw(nwv+1))**2+2.d0*dw(nwv+1)*ey/cm)-deval-103
     1w(nwv)-dw(nwv+1))                                                 eval-104
    4 write (mw,1006) i,j,ey,dw(2*i+ncx-1),dw(nwv+2),ex                 eval-105
      if (ncolx.eq.1) go to 49                                          eval-106
      do 6 j=2,ncolx                                                    eval-107
      dw(nwv+18*j-16)=dw(nwv+18*j-16)+dw(nwv+2)-ex                      eval-108
      if (lo(8)) go to 5                                                eval-109
      dw(nwv+18*j-7)=dw(nwv+18*j-16)*(dw(nwv+18*j-18)+dw(nwv+18*j-17))/deval-110
     1w(nwv+18*j-17)                                                    eval-111
      go to 6                                                           eval-112
    5 dw(nwv+18*j-7)=dw(nwv+18*j-16)*(dw(nwv+18*j-16)/(2.d0*cm)+dw(nwv+1eval-113
     18*j-18)+dw(nwv+18*j-17))/dw(nwv+18*j-17)                          eval-114
    6 continue                                                          eval-115
      go to 49                                                          eval-116
    7 if (nex.lt.0) ey=.01d0*ey*ex                                      eval-117
      ey=ex+ey                                                          eval-118
      go to ( 2 , 18 , 23 , 29 , 34 , 36 , 38 , 41 , 48 ),ik            eval-119
    8 if (ik.gt.11) go to 9                                             eval-120
      if (ik.gt.9) go to 51                                             eval-121
      go to ( 10 , 10 , 19 , 25 , 31 , 35 , 37 , 39 , 47 ),ik           eval-122
    9 ik=2                                                              eval-123
      j=nw(1,2*i+ncx-2)-9000                                            eval-124
   10 if (lo(7)) go to 12                                               eval-125
c optical model and folding parameters                                  eval-126
      n=1+mod(j-1,34)                                                   eval-127
      m=1+(j-1)/34                                                      eval-128
      k=iabs(nw(1,nipp+15*m-15))                                        eval-129
      if (mod(n,3).ne.2.or.n.gt.24) go to 11                            eval-130
      ex=dw(nwv+18*k-17)**.33333333333333d0                             eval-131
      if (lo(16)) ex=ex+dw(nwv+18*k-18)**.33333333333333d0              eval-132
      ey=ey*ex                                                          eval-133
   11 if (j.gt.nvat.or.n.eq.19) go to 51                                eval-134
      ex=dw(npot+j-1)                                                   eval-135
      if (nx.ne.2) go to 7                                              eval-136
      go to 18                                                          eval-137
c external optical parameters                                           eval-138
   12 i1=nw(1,npot)-2                                                   eval-139
      do 13 l=1,i1                                                      eval-140
      if (j.ge.nw(1,npot+l).and.j.le.nw(2,npot+l)) go to 14             eval-141
   13 continue                                                          eval-142
      go to 52                                                          eval-143
   14 ex=dw(npot+j-1)                                                   eval-144
      if (l.eq.1) go to 17                                              eval-145
      m=nw(1,npot+l)                                                    eval-146
      n=nw(2,npot+m-2)                                                  eval-147
      iv=nw(2,npot+n-1)                                                 eval-148
      if (iv.lt.1.or.iv.gt.6) go to 17                                  eval-149
      nst=nw(1,npot+n+1)                                                eval-150
      if (nst.gt.0) go to 17                                            eval-151
      it1=mod(nw(1,npot+n-1)-1,8)+1                                     eval-152
      j1=(nw(1,npot+n-1)-1)/8                                           eval-153
      j2=4                                                              eval-154
      if (it1.gt.6) j2=5                                                eval-155
      if (j-m.gt.1.and.j-m.lt.j2) go to 17                              eval-156
      k=iabs(nst)                                                       eval-157
      fx=dw(nwv+18*k-17)**.33333333333333d0                             eval-158
      fy=fx                                                             eval-159
      if (lo(16)) fx=fx+dw(nwv+18*k-18)**.33333333333333d0              eval-160
c transformation of depth and radius                                    eval-161
      if (j-m.eq.1) ey=ey*fx                                            eval-162
      fy=fy/fx                                                          eval-163
      if (j.gt.m+2) go to 16                                            eval-164
      if (lo(116).or.j1.le.npp.or.j.ne.m) go to 17                      eval-165
      ityz=iv                                                           eval-166
      if (ityz.ge.5) ityz=ityz-4                                        eval-167
      ityw=1                                                            eval-168
      if (it1.le.6) go to 15                                            eval-169
      iti=7*(j1-npp)                                                    eval-170
      ityw=ityw*nw(2-mod(iti,2),nivy+(iti-1)/2)                         eval-171
   15 if (lo(6)) ityw=ityw-1                                            eval-172
      if (ityz.gt.1) ey=ey*fy**((ityz-1)*ityw)                          eval-173
      go to 17                                                          eval-174
c transformation of deformations                                        eval-175
   16 j3=j-m-j2                                                         eval-176
      if (it1.lt.7) j3=0                                                eval-177
      if (lo(106)) j3=j3+1                                              eval-178
      ey=ey*fy**j3                                                      eval-179
   17 if (nx.ne.2) go to 7                                              eval-180
   18 if (lo(107)) write (mw,1007) i,j,n,m,ey,dw(2*i+ncx-1),dw(npot+j-1)eval-181
      if (lo(7)) write (mw,1008) i,j,ey,dw(2*i+ncx-1),dw(npot+j-1)      eval-182
      dw(npot+j-1)=ey                                                   eval-183
      go to 49                                                          eval-184
   19 if (j.gt.8) go to 51                                              eval-185
c deformations for a given potential                                    eval-186
      k2=j                                                              eval-187
      do 20 k1=1,nbet                                                   eval-188
      if (lo(1).and.lo(3).and.nw(2,nbeta+9*k1-1).ne.0) go to 20         eval-189
      if (dw(nbeta+k2+9*k1-10).ne.0.d0) go to 21                        eval-190
   20 continue                                                          eval-191
      write (mw,1009) i,nw(1,2*i+ncx-2),k2                              eval-192
      go to 53                                                          eval-193
   21 ey=ey/dw(nbeta+k2+9*k1-10)                                        eval-194
      k3=1                                                              eval-195
      if ((nx.ne.1).and.lo(16)) go to 32                                eval-196
   22 ex=1                                                              eval-197
      if (nx.ne.2) go to 7                                              eval-198
   23 write (mw,1010) i,nw(1,2*i+ncx-2),k2,k1,ey,dw(2*i+ncx-1)          eval-199
      do 24 l=k1,nbet                                                   eval-200
      if (lo(1).and.lo(3).and.nw(2,nbeta+9*k1-1).ne.0) go to 24         eval-201
      ex=dw(nbeta+k2+9*l-10)*ey                                         eval-202
      write (mw,1011) k2,l,ex,dw(nbeta+k2+9*l-10)                       eval-203
      dw(nbeta+k2+9*l-10)=ex                                            eval-204
   24 continue                                                          eval-205
      go to 49                                                          eval-206
c deformations for a given multipole                                    eval-207
   25 k1=j                                                              eval-208
      if (j.gt.nbet) go to 51                                           eval-209
      do 26 k2=1,8                                                      eval-210
      if (dw(nbeta+k2+9*k1-10).ne.0.d0) go to 27                        eval-211
   26 continue                                                          eval-212
      write (mw,1012) i,nw(1,2*i+ncx-2),k1                              eval-213
      go to 53                                                          eval-214
   27 ey=ey/dw(nbeta+k2+9*k1-10)                                        eval-215
      k3=2                                                              eval-216
      if ((nx.ne.1).and.lo(16)) go to 22                                eval-217
   28 ex=1                                                              eval-218
      if (nx.ne.2) go to 7                                              eval-219
   29 write (mw,1010) i,nw(1,2*i+ncx-2),k2,k1,ey,dw(2*i+ncx-1)          eval-220
      do 30 l=k2,8                                                      eval-221
      ex=dw(nbeta+l+9*k1-10)*ey                                         eval-222
      write (mw,1011) l,k1,ex,dw(nbeta+l+9*k1-10)                       eval-223
   30 dw(nbeta+l+9*k1-10)=ex                                            eval-224
      go to 49                                                          eval-225
c individual deformations                                               eval-226
   31 if (j.gt.10*nbet) go to 51                                        eval-227
      k1=1+(j-1)/10                                                     eval-228
      k2=1+mod(j-1,10)                                                  eval-229
      if (k2.gt.8) go to 51                                             eval-230
      k3=3                                                              eval-231
      if (lo(116)) go to 33                                             eval-232
c search of the corrections for heavy ions                              eval-233
   32 ex=dw(nwv+1)**.33333333333333d0/(dw(nwv+1)**.33333333333333d0+dw(neval-234
     1wv)**.33333333333333d0)                                           eval-235
      jk=1                                                              eval-236
      if (lo(101).and.lo(3)) jk=k1-1                                    eval-237
      k=jk                                                              eval-238
      if (k2.gt.6) k=k*nw(1,nbeta+9*k1-1)                               eval-239
      if (lo(6)) k=k-jk                                                 eval-240
      ey=ey*ex**k                                                       eval-241
      if (k3-2) 22 , 28 , 33                                            eval-242
   33 ex=dw(nbeta+k2+9*k1-10)                                           eval-243
      if (nx.ne.2) go to 7                                              eval-244
   34 write (mw,1013) i,nw(1,2*i+ncx-2),k2,k1,ey,dw(2*i+ncx-1),dw(nbeta+eval-245
     1k2+9*k1-10)                                                       eval-246
      dw(nbeta+k2+9*k1-10)=ey                                           eval-247
      go to 49                                                          eval-248
   35 if (j.gt.nva) go to 51                                            eval-249
      ex=dw(npaa+j-1)                                                   eval-250
      if (nx.ne.2) go to 7                                              eval-251
   36 write (mw,1014) i,nw(1,2*i+ncx-2),j,ey,dw(2*i+ncx-1),dw(npaa+j-1) eval-252
      dw(npaa+j-1)=ey                                                   eval-253
      go to 49                                                          eval-254
c  nuclear matrix elements                                              eval-255
   37 if (3*j.gt.nivq-nt) go to 51                                      eval-256
      ex=dw(nt+3*j-3)                                                   eval-257
      lo(211)=.true.                                                    eval-258
      if (nx.ne.2) go to 7                                              eval-259
   38 write (mw,1015) i,nw(1,2*i+ncx-2),j,ey,dw(2*i+ncx-1),dw(nt+3*j-3) eval-260
      dw(nt+3*j-3)=ey                                                   eval-261
      go to 49                                                          eval-262
c  spin-orbit and h. f. parametrisation                                 eval-263
   39 if (j.gt.6*ncons+16+2*nfiss+nrd) go to 51                         eval-264
      if (lo(181).and.j.gt.6) go to 51                                  eval-265
      if (j.gt.16) go to 45                                             eval-266
      if (lo(104).and.j.le.6) go to 51                                  eval-267
      if (j.le.6) go to 40                                              eval-268
      if (lo(181)) go to 51                                             eval-269
      if (lo(82).and.j.gt.9) go to 51                                   eval-270
      if (lo(186).and.j.gt.11) go to 51                                 eval-271
      if (lo(82)) go to 40                                              eval-272
      if (j.ne.9.and.j.le.11.and.lo(87)) go to 51                       eval-273
      if (lo(87)) go to 40                                              eval-274
      if (j.eq.7) go to 51                                              eval-275
      if (az(8).ne.0.d0.and.j.gt.8.and.j.le.11) go to 51                eval-276
      if (az(8).eq.0.d0.and.j.eq.8) go to 51                            eval-277
   40 ex=az(j)                                                          eval-278
      if (nx.ne.2) go to 7                                              eval-279
   41 if (j.gt.6) go to 42                                              eval-280
      write (mw,1016) i,nw(1,2*i+ncx-2),j,ey,dw(2*i+ncx-1),az(j)        eval-281
      go to 44                                                          eval-282
   42 if (j.gt.16) go to 46                                             eval-283
      lo(212)=.true.                                                    eval-284
      k=j-6                                                             eval-285
      if (k.gt.6) go to 43                                              eval-286
      write (mw,1017) i,nw(1,2*i+ncx-2),k,ey,dw(2*i+ncx-1),az(j)        eval-287
      go to 44                                                          eval-288
   43 k=j-5                                                             eval-289
      write (mw,1018) i,nw(1,2*i+ncx-2),k,ey,dw(2*i+ncx-1),az(j)        eval-290
   44 az(j)=ey                                                          eval-291
      go to 49                                                          eval-292
   45 jj=j-16+(j-16)/6                                                  eval-293
      ex=dw(nscn+jj-1)                                                  eval-294
      if (nx.ne.2) go to 7                                              eval-295
   46 k=1+(j-17)/ncons                                                  eval-296
      l=1+mod(j-17,ncons)                                               eval-297
      if (k.eq.ncons-ncont) lo(212)=.true.                              eval-298
      if (k.gt.ncons-ncont) lo(214)=.true.                              eval-299
      write (mw,1019) i,nw(1,2*i+ncx-2),l,k,ey,dw(2*i+ncx-1),dw(nscn+jj-eval-300
     11)                                                                eval-301
      dw(nscn+jj-1)=ey                                                  eval-302
      go to 49                                                          eval-303
   47 if (j.gt.12*npp) go to 51                                         eval-304
      k=(j-1)/12+1                                                      eval-305
      l=j-12*k+15                                                       eval-306
      if ((nw(1,nipp+15*k-14).eq.0).and.(l.le.11)) go to 51             eval-307
      if ((nw(2,nipp+15*k-14).eq.0).and.(l.gt.11)) go to 51             eval-308
      lo(213)=.true.                                                    eval-309
      ex=dw(nipp+15*k+l-16)                                             eval-310
      if (nx.ne.2) go to 7                                              eval-311
   48 continue                                                          eval-312
      write (mw,1020) i,nw(1,2*i+ncx-2),l,k,ey,dw(2*i+ncx-1),dw(nipp+15*eval-313
     1k+l-16)                                                           eval-314
      dw(nipp+15*k+l-16)=ey                                             eval-315
   49 continue                                                          eval-316
      if (lo(132)) return                                               eval-317
      chi2m=1.d35                                                       eval-318
      if (yy(1).eq.0.d0) yy(1)=20.d0                                    eval-319
      yy(3)=0.d0                                                        eval-320
      nw(2,niw)=nw(2,niw)-nw(1,niw+1)                                   eval-321
      nw(1,niw+1)=1                                                     eval-322
      write (mw,1021) nw(2,niw),yy(1)                                   eval-323
      if (nw(2,niw).le.0) go to 53                                      eval-324
      ii=51                                                             eval-325
      if (lo(76).or.lo(175)) ii=59                                      eval-326
      do 50 i=ii,65                                                     eval-327
      lo(i+185)=lo(i)                                                   eval-328
      lo(i)=.false.                                                     eval-329
   50 lo(i+100)=.true.                                                  eval-330
      lo(216)=.true.                                                    eval-331
      return                                                            eval-332
   51 write (mw,1022) i,nw(1,2*i+ncx-2),ik,j,dw(2*i+ncx-1)              eval-333
      go to 53                                                          eval-334
   52 if (j.gt.nw(2,npot+1)) go to 51                                   eval-335
      write (mw,1023) i,ey,j,(nw(1,npot+l),nw(2,npot+l),l=1,i1)         eval-336
   53 write (mw,1024)                                                   eval-337
      stop                                                              eval-338
 1000 format (2l1,i3,i5,f10.5)                                          eval-339
 1001 format (18a4)                                                     eval-340
 1002 format ('1',a4,' computation with',i4,'  new parameters',10x,'( ineval-341
     1put of ',2a8)                                                     eval-342
 1003 format (20x,'*** values given as percentages ***')                eval-343
 1004 format (14i5)                                                     eval-344
 1005 format (7f10.5)                                                   eval-345
 1006 format (2x,i2,' param.',i5,3x,'new lab. energy',d15.8,' (',d15.8,'eval-346
     1)',3x,'center of mass energy',d15.6,5x,'old value',d15.6)         eval-347
 1007 format (2x,i2,' param.',i5,3x,'value of v-optical(',i2,',',i2,') =eval-348
     1',d15.6,' (',d15.6,')',3x,'old value',d15.6)                      eval-349
 1008 format (2x,i2,' param.',i5,'th value of external potential =',d15.eval-350
     16,' (',d15.6,')',3x,'old value',d15.6)                            eval-351
 1009 format (' the variable',i3,' cannot be used because ',i5,'  is a veval-352
     1ariation of the deformations of potential',i3,' which are zero')  eval-353
 1010 format (2x,i2,' param.',i5,3x,'proportional to beta(',i2,',',i2,')eval-354
     1  with ratio',d15.6,' (',d15.6,')')                               eval-355
 1011 format (15x,'beta(',i2,',',i2,') =',d15.6,5x,'old value',d15.6)   eval-356
 1012 format (' the variable',i3,' cannot be used because ',i5,'  is a veval-357
     1ariation for a given multipole',i3,' and they are zero')          eval-358
 1013 format (2x,i2,' param.',i5,3x,'beta(',i2,',',i2,') =',d15.6,' (',eeval-359
     115.6,')',3x,'old value',d15.6)                                    eval-360
 1014 format (2x,i2,' param.',i5,3x,'var(',i2,') =',d15.6,' (',d15.6,')'eval-361
     1,3x,'old value',d15.6)                                            eval-362
 1015 format (2x,i2,' param.',i5,3x,'t(4,',i3,') =',d15.6,' (',d15.6,')'eval-363
     1,3x,'old value',d15.6)                                            eval-364
 1016 format (2x,i2,' param.',i5,3x,'az(',i1,') =',d15.6,' (',d15.6,')',eval-365
     13x,'old value',d15.6)                                             eval-366
 1017 format (2x,i2,' param.',i5,3x,'bz(',i1,') =',d15.6,' (',d15.6,')',eval-367
     13x,'old value',d15.6)                                             eval-368
 1018 format (2x,i2,' param.',i5,3x,'giant resonance(',i1,') =',d15.6,' eval-369
     1(',d15.6,')',3x,'old value',d15.6)                                eval-370
 1019 format (2x,i2,' param.',i5,3x,'scn(',i3,',',i3,') =',d15.6,' (',d1eval-371
     15.6,')',3x,'old value',d15.6)                                     eval-372
 1020 format (2x,i2,' param.',i5,3x,'pip(',i3,',',i3,') =',d15.6,' (',d1eval-373
     15.6,')',3x,'old value',d15.6)                                     eval-374
 1021 format (' new maximum number of runs:',i6,10x,'starting scale',f10eval-375
     1.2)                                                               eval-376
 1022 format (' variable',i3,' defined by',i5,' (',i2,i5,')',' with valueval-377
     1e ',d15.6,' cannot be used')                                      eval-378
 1023 format (' variable',i3,d15.6,' defined by',i5,' cannot be used foreval-379
     1 the parameter which are the integer values'/(4(5x,i6,' to',i6))) eval-380
 1024 format (/' in eval  ...  stop')                                   eval-381
      end                                                               eval-382
c 29/02/04                                                      ecis03  rest-000
      subroutine rest(kf,nw,dw,lo,idmx)                                 rest-001
c if kf=0                                                               rest-002
c it saves on tape ms all the data needed to re-start a                 rest-003
c search stopped by the number of evaluations (by time if lo(34)=.true.)rest-004
c it is called only if lo(35)=.true.                                    rest-005
c if kf.ne.0                                                            rest-006
c it reads on tape ms to re-start the search                            rest-007
c it is called only if lo(36)=.true.                                    rest-008
c ******** unless the main subroutine is changed, ms = 8 ***************rest-009
c***********************************************************************rest-010
      implicit real*8 (a-h,o-z)                                         rest-011
      logical lo(250)                                                   rest-012
      dimension dw(idmx),nw(2,idmx),t(18)                               rest-013
      character*4 t,title                                               rest-014
      common /titr/ title(18)                                           rest-015
      common /angl/ n1(8)                                               rest-016
      common /dcons/ n2(10)                                             rest-017
      common /dcont/ n0(8)                                              rest-018
      common /decou/ n3(115)                                            rest-019
      common /ncomp/ n4(52)                                             rest-020
      common /pote1/ n5(22)                                             rest-021
      common /pote2/ n6(12)                                             rest-022
      common /ncjl/ n7(4)                                               rest-023
      common /sjmm/ n8(2)                                               rest-024
      common /dchi/ n9(10)                                              rest-025
      common /inout/ mr,mw,ms                                           rest-026
      idmy=idmx                                                         rest-027
      rewind ms                                                         rest-028
      if (kf.ne.0) go to 1                                              rest-029
c writes commons first and w after                                      rest-030
      write (ms) idmx,lo,n1,n2,n3,n4,n5,n6,n7,n8,n9,n0,title            rest-031
c n3(46) is nrco,n3(98) is nplace,n3(52) is idmt                        rest-032
      i1=n3(46)                                                         rest-033
      write (mw,1000) ms,i1                                             rest-034
      write (ms) (dw(i),i=1,i1)                                         rest-035
      rewind ms                                                         rest-036
      return                                                            rest-037
c read commons,computes limits of w and read w                          rest-038
    1 read (ms) i,lo,n1,n2,n3,n4,n5,n6,n7,n8,n9,n0,t                    rest-039
      i1=n3(46)                                                         rest-040
      n3(52)=idmy                                                       rest-041
      write (mw,1001) title,t,n3(52)                                    rest-042
      if (n3(98).gt.n3(52)) call memo('rest',n3(52),n3(98),1)           rest-043
      read (ms) (dw(i),i=1,i1)                                          rest-044
      rewind ms                                                         rest-045
c reads on 5 if save has to be done again and the new number of eval.   rest-046
c any modification of the search can be read at this place if they      rest-047
c do not spoil the search                                               rest-048
      lo(35)=.false.                                                    rest-049
      read (mr,1002) lo(35),n,nsec,ech,rap                              rest-050
c n3(17) is niw, n3(92) is nrec                                         rest-051
      if (n.eq.0) n=n3(92)+2                                            rest-052
      lo(135)=.not.lo(35)                                               rest-053
      m=n3(17)                                                          rest-054
      nw(2,m)=nw(2,m)+n                                                 rest-055
      write (mw,1003) ms,i1                                             rest-056
      write (mw,1004) n,nw(2,m)                                         rest-057
      if (lo(35)) write (mw,1005) ms                                    rest-058
      if (lo(135)) write (mw,1006) ms                                   rest-059
      if (nsec.eq.0) go to 2                                            rest-060
      n3(43)=nsec                                                       rest-061
      write (mw,1007) nsec                                              rest-062
    2 n=n3(14)                                                          rest-063
      if (ech.lt.1.d0) go to 3                                          rest-064
      write (mw,1008) dw(n),ech                                         rest-065
      dw(n)=ech                                                         rest-066
    3 if (rap.lt.1.d0) go to 4                                          rest-067
      write (mw,1009) dw(n+1),rap                                       rest-068
      dw(n+1)=rap                                                       rest-069
    4 return                                                            rest-070
 1000 format (///15h output on tape,i3,24h of dw from dw(1) to dw(,i6,1hrest-071
     1)///)                                                             rest-072
 1001 format ('1'//1x,18a4//' restart of computation'//' last title : ''rest-073
     1''',18a4,''''''//' available working space',i8/)                  rest-074
 1002 format (l1,i4,i5,2f10.5)                                          rest-075
 1003 format (' input from tape',i3,' of dw from dw(1) to dw(',i6,')'//)rest-076
 1004 format (/' maximum number of evaluations increased by',i4,5x,'new rest-077
     1value',i6)                                                        rest-078
 1005 format (' save on tape',i3,' if necessary')                       rest-079
 1006 format (' no save on tape',i3)                                    rest-080
 1007 format (5x,i5,' hund of second spared at the end of the job')     rest-081
 1008 format (' change of ech from',f10.5,' to',f10.5)                  rest-082
 1009 format (' change of rap from',f10.5,' to',f10.5)                  rest-083
      end                                                               rest-084
c 29/02/04                                                      ecis03  fite-000
      subroutine fite(ke,m,n,f,x,e,w,nw,iz,wa)                          fite-001
c chi-square minimising subroutine written by g. schweimer in karlsruhe.fite-002
c simplified for the use of ecis (no gradient)                          fite-003
c solves the nonlinear least squares problem                            fite-004
c using a least squares interpolation between variables and functions   fite-005
c called subroutines: fit2 /.true./ (linear least squares problem)      fite-006
c                     fit2 /.false./(inversion of a(transposed)*a)      fite-007
c                     fit1(one dimensional minimum search)              fite-008
c calling sequence                                                      fite-009
c     ke=0                                                              fite-010
c     m=number of functions, m ge n                                     fite-011
c     n=number of variables, n ge 1                                     fite-012
c     do 1 i=1,n                                                        fite-013
c     x(i)=starting values of the variables                             fite-014
c   1 e(i)=absolute search accuracies for the variables                 fite-015
c     yy(1)=first step size in units of e(i)                            fite-016
c     yy(2)=half of the success multiplication factor for step size     fite-017
c         the step size is divided by 4 times its square after unsuccessfite-018
c     iz(1)=number of points to be remembered, if le n iz(1) = n+1      fite-019
c     iz(2)=maximum number of function evaluations, if 0 iz(2)=2*iz(1)  fite-020
c   2 chi2=0.                                                           fite-021
c     do 3 i=1,m                                                        fite-022
c     f(i)=function values at the point x                               fite-023
c   3 chi2=chi2+f(i)*f(i)                                               fite-024
c     call fite(ke,m,n,f,x,e,w,w,iz,wa,chi2)                            fite-025
c     if(ke.eq.1) go to 2                                               fite-026
c     yy(1)=step size  maximum change of a variable is 2*yy(1)          fite-027
c     yy(3)=error renormalisation factor when ke=0,2 or 3. (square root fite-028
c                of variance at best fit divided by degree of freedom)  fite-029
c         =changed x value in preparatory calls                         fite-030
c         =ratio step/distance of minimum after preparatory calls       fite-031
c              or 0. for random prediction                              fite-032
c     x=minimum point                                                   fite-033
c     f=functions at the minimum point                                  fite-034
c     ke=error code    ke=0: without errors                             fite-035
c                      ke=2: user interrupt                             fite-036
c                      ke=3: maximum number of function evaluations     fite-037
c                      ke=4: rounding errors                            fite-038
c                      ke=5: the functions do not depend on x(iz(4))    fite-039
c                      ke=6: useless variables in the preparatory calls,fite-040
c                            the labels of the variables are iz(3),iz(4)fite-041
c                      ke=7: m lt n                                     fite-042
c     w(i)=standard errors of the variables. (for a variance at best    fite-043
c                      fit equal to degree of freedom)                  fite-044
c     w(n+i)=error enhancements. (many/single variable result)          fite-045
c     w(n+n+i+(j*(j-1))/2)=error correlation between x(i) and x(j) i<j  fite-046
c     iz(3): number of function evaluations                             fite-047
c     iz(4): number of degrees of freedom if ke=0,2,3 or 4              fite-048
c            place of useless variable if ke=5 or 6                     fite-049
c            eventually indications for one dimensional search if ke=1  fite-050
c working field:  iz: length 4+k with k = iz(1)                         fite-051
c     w: length max(14+n+k*(m+n+1),(n*(n+5))/2)                         fite-052
c     nw: equivalent by call with w                                     fite-053
c     wa: length (m+1)*(n+1)+(n*(n+1))/2                                fite-054
c                  addresses in iz                                      fite-055
c                      4+l: labels of the quadratic sums                fite-056
c                  addresses in w during search                         fite-057
c                      1 to 14 ,eventually, indications for one dimen-  fite-058
c                            sionnal search.                            fite-059
c                      from max(15,n+1),k sets(functions+variables+chi2)fite-060
c                  addresses in w after the search  see above           fite-061
c                  addresses in wa                                      fite-062
c                      from 1 gradient or matrix a followed by central  fite-063
c                              functions                                fite-064
c                      from 1+m*(n+1)  central variables                fite-065
c                      from (n+1)*(m+1) matrix d                        fite-066
c the working fields iz and w contain all information to continue       fite-067
c the search. this allows a search within another search just changing  fite-068
c the working fields                                                    fite-069
c***********************************************************************fite-070
      implicit real*8 (a-h,o-z)                                         fite-071
      dimension f(m),x(n),e(n),w(20),iz(5),wa(1),nw(20)                 fite-072
      common /dchi/ chi2,chi2m,yy(3)                                    fite-073
      data eps /1.d-5/                                                  fite-074
      jd=(m+1)*(n+1)-1                                                  fite-075
      js=14+n                                                           fite-076
      lm=m+n+1                                                          fite-077
      k=iz(1)                                                           fite-078
      if (ke.ne.0) go to 2                                              fite-079
      if (m.lt.n) go to 39                                              fite-080
      iz(3)=1                                                           fite-081
      iz(4)=0                                                           fite-082
      do 1 l=1,k                                                        fite-083
      iz(l+4)=1+k-l                                                     fite-084
    1 w(js+lm*l)=7.d35                                                  fite-085
      if (yy(2).lt.1.d0) yy(2)=1.d0                                     fite-086
      ke=1                                                              fite-087
    2 jm=js+lm*iz(5)-lm                                                 fite-088
      j3=m*n                                                            fite-089
      kv=k                                                              fite-090
      if (chi2.le.0.d0) go to 38                                        fite-091
c row of matrix s to be replaced by new values                          fite-092
      l=iz(k+4)                                                         fite-093
      if (w(js+lm*l).eq.7.d35) kv=l-1                                   fite-094
      do 3 i=1,k                                                        fite-095
      j1=js+lm*iz(i+4)                                                  fite-096
      if (chi2.lt.w(j1)) go to 4                                        fite-097
    3 continue                                                          fite-098
c one dimensional search is necessary                                   fite-099
      go to 30                                                          fite-100
    4 if (i.gt.max0(n+1,kv)) go to 30                                   fite-101
c vector of labels of the quadratic sums                                fite-102
      if (kv.lt.k) kv=kv+1                                              fite-103
      i1=k+4                                                            fite-104
      i2=k-i                                                            fite-105
      if ((iz(3).gt.n+1).and.(i.ne.1)) yy(1)=yy(1)/(4.d0*yy(2)**3)      fite-106
      if (i2.eq.0) go to 6                                              fite-107
      do 5 j=1,i2                                                       fite-108
      i1=i1-1                                                           fite-109
    5 iz(i1+1)=iz(i1)                                                   fite-110
      iz(i1)=l                                                          fite-111
      jm=js+lm*iz(5)-lm                                                 fite-112
c new row                                                               fite-113
    6 j1=js+lm*(l-1)                                                    fite-114
      do 7 i=1,m                                                        fite-115
      j1=j1+1                                                           fite-116
    7 w(j1)=f(i)                                                        fite-117
      do 8 i=1,n                                                        fite-118
      j1=j1+1                                                           fite-119
    8 w(j1)=x(i)                                                        fite-120
      w(j1+1)=chi2                                                      fite-121
      if (iz(3).ge.iz(2)) go to 43                                      fite-122
      if (n.eq.1) go to 35                                              fite-123
      if (iz(3).gt.n+1) go to 13                                        fite-124
c preparatory function evaluations                                      fite-125
      mf=iz(3)                                                          fite-126
      if (mf.eq.1) go to 12                                             fite-127
c significance of the new variable                                      fite-128
      x(mf-1)=yy(3)                                                     fite-129
      s=0.d0                                                            fite-130
      do 9 i=1,m                                                        fite-131
      t=f(i)-w(js+i)                                                    fite-132
    9 s=s+t*t                                                           fite-133
      j=2                                                               fite-134
      if (s.lt.eps*eps*w(js+lm)) go to 41                               fite-135
      yy(3)=s                                                           fite-136
      w(mf-1)=dsqrt(yy(3))                                              fite-137
      if (mf.le.2) go to 12                                             fite-138
c independence of the new variable                                      fite-139
      do 11 j=3,mf                                                      fite-140
      i2=js+lm*(j-2)                                                    fite-141
      s=0.d0                                                            fite-142
      do 10 i=1,m                                                       fite-143
   10 s=s+(w(i2+i)-w(js+i))*(f(i)-w(js+i))                              fite-144
      if (dabs(w(mf-1)*w(j-2)-dabs(s)).lt.eps*dabs(s)) go to 40         fite-145
   11 continue                                                          fite-146
   12 if (mf.eq.n+1) go to 13                                           fite-147
      yy(3)=x(mf)                                                       fite-148
      x(mf)=x(mf)+yy(1)*e(mf)                                           fite-149
      go to 64                                                          fite-150
c end of preparatory function evaluations                               fite-151
c sum of inverses of the quadratic sums                                 fite-152
   13 s=0.d0                                                            fite-153
      do 14 l=1,kv                                                      fite-154
      t=w(js+lm*l)                                                      fite-155
   14 s=s+1.d0/(t*t)                                                    fite-156
      wja=1.d0/s                                                        fite-157
c centre of the variables and functions                                 fite-158
      i1=m+n                                                            fite-159
      do 16 i=1,i1                                                      fite-160
      j1=js                                                             fite-161
      s=0.d0                                                            fite-162
      do 15 l=1,kv                                                      fite-163
      t=w(j1+lm)                                                        fite-164
      s=s+w(j1+i)/(t*t)                                                 fite-165
   15 j1=j1+lm                                                          fite-166
   16 wa(j3+i)=s*wja                                                    fite-167
      if (ke.ne.1) go to 47                                             fite-168
c the linear approximation means that the difference with central value fite-169
c f(i,k)-f(i) = sum f(i,j)*(x(j,k)-x(j)) where f(i),x(j) are mean valuesfite-170
c and f(i,j) is the first derivative with respect to x(j).              fite-171
c using the matrix d(i,j) = weighted sum on (x(i,k)-x(i))*(x(j,k)-x(j)) fite-172
c and writing the change dx = d*y, the best fit is obtained for         fite-173
c ||f-a*y||=min(y) with a(i,j)=weighted sum(f(i,k)-f(i)*(x(j,k)-x(j))   fite-174
c matrix a                                                              fite-175
   17 j1=0                                                              fite-176
      do 19 i=1,n                                                       fite-177
      u=wa(j3+m+i)                                                      fite-178
      do 19 j=1,m                                                       fite-179
      j1=j1+1                                                           fite-180
      j2=js                                                             fite-181
      s=0.d0                                                            fite-182
      t=wa(j3+j)                                                        fite-183
      do 18 l=1,kv                                                      fite-184
      v=w(j2+lm)                                                        fite-185
      s=s+(w(j2+j)-t)*(w(j2+m+i)-u)/(v*v)                               fite-186
   18 j2=j2+lm                                                          fite-187
   19 wa(j1)=s*wja                                                      fite-188
      if (ke.ne.1) go to 50                                             fite-189
c linear least squares problem                                          fite-190
      call fit2(m,n,wa,x,nw,ir,.true.)                                  fite-191
      if (ir) 42 , 20 , 28                                              fite-192
c matrix d                                                              fite-193
   20 j1=jd                                                             fite-194
      ja=j3+m                                                           fite-195
      do 23 i=1,n                                                       fite-196
      t=wa(ja+i)                                                        fite-197
      do 22 j=1,i                                                       fite-198
      j1=j1+1                                                           fite-199
      j2=js+m                                                           fite-200
      s=0.d0                                                            fite-201
      u=wa(ja+j)                                                        fite-202
      do 21 l=1,kv                                                      fite-203
      v=w(j2+n+1)                                                       fite-204
      s=s+(w(j2+i)-t)*(w(j2+j)-u)/(v*v)                                 fite-205
   21 j2=j2+lm                                                          fite-206
   22 wa(j1)=s*wja                                                      fite-207
   23 continue                                                          fite-208
c new variables                                                         fite-209
      do 25 i=1,n                                                       fite-210
      i2=1                                                              fite-211
      j1=jd+(i*i-i)/2                                                   fite-212
      s=0.d0                                                            fite-213
      do 24 j=1,n                                                       fite-214
      j1=j1+i2                                                          fite-215
      if (j.ge.i) i2=j                                                  fite-216
   24 s=s+wa(j1)*x(j)                                                   fite-217
   25 wa(i)=wa(ja+i)-s                                                  fite-218
c test of convergence                                                   fite-219
      a=0.d0                                                            fite-220
      do 26 i=1,n                                                       fite-221
      w(i)=wa(i)-w(jm+m+i)                                              fite-222
   26 a=dmax1(a,dabs(w(i)/e(i)))                                        fite-223
      yy(1)=yy(1)*yy(2)                                                 fite-224
      if (a.lt.1.d0.or.yy(1).lt.1.d0) go to 38                          fite-225
      yy(3)=1.d0                                                        fite-226
c step size limitation                                                  fite-227
      if (a.gt.2.d0*yy(1)) yy(3)=2.d0*yy(1)/a                           fite-228
      do 27 i=1,n                                                       fite-229
   27 x(i)=w(jm+m+i)+yy(3)*w(i)                                         fite-230
      iz(4)=0                                                           fite-231
      yy(1)=a*yy(3)                                                     fite-232
      go to 64                                                          fite-233
c random prediction                                                     fite-234
   28 do 29 i=1,n                                                       fite-235
   29 x(i)=w(jm+m+i)+yy(1)*e(i)*dfloat(mod(iabs(nw(jm+i)),200)-100)/100.fite-236
     1d0                                                                fite-237
      yy(3)=0.d0                                                        fite-238
      go to 64                                                          fite-239
c one dimensional search                                                fite-240
   30 if (n.eq.1) go to 36                                              fite-241
      if (iz(3).ge.iz(2)) go to 43                                      fite-242
      if (iz(4).eq.2) go to 32                                          fite-243
      iz(4)=2                                                           fite-244
      do 31 i=1,n                                                       fite-245
   31 w(i+14)=x(i)-w(jm+m+i)                                            fite-246
      nw(1)=3                                                           fite-247
      nw(2)=20                                                          fite-248
      w(4)=0.5d0                                                        fite-249
      w(7)=0.d0                                                         fite-250
      w(8)=0.d0                                                         fite-251
      w(9)=0.d0                                                         fite-252
      w(10)=1.d0                                                        fite-253
      w(12)=w(jm+lm)                                                    fite-254
      w(13)=chi2                                                        fite-255
      go to 33                                                          fite-256
   32 w(5)=chi2                                                         fite-257
      call fit1(ke,nw,w(4))                                             fite-258
   33 do 34 i=1,n                                                       fite-259
   34 x(i)=w(jm+m+i)+w(4)*w(i+14)                                       fite-260
      if (ke.eq.3) ke=2                                                 fite-261
      if (ke.eq.2) go to 43                                             fite-262
      ke=1                                                              fite-263
      yy(3)=w(4)                                                        fite-264
      go to 64                                                          fite-265
c only one variable x                                                   fite-266
   35 if (iz(3).gt.1) go to 36                                          fite-267
      ke=0                                                              fite-268
      w(6)=yy(1)*e(1)                                                   fite-269
      w(7)=e(1)                                                         fite-270
      w(8)=0.d0                                                         fite-271
   36 nw(2)=iz(2)                                                       fite-272
      w(4)=x(1)                                                         fite-273
      w(5)=chi2                                                         fite-274
      call fit1(ke,nw,w(4))                                             fite-275
      iz(4)=2                                                           fite-276
      x(1)=w(4)                                                         fite-277
      if (ke.eq.1) go to 64                                             fite-278
      if (ke.gt.0) ke=ke+1                                              fite-279
      yy(3)=0.d0                                                        fite-280
      w(1)=0.d0                                                         fite-281
      do 37 j=1,m                                                       fite-282
   37 f(j)=w(jm+i)                                                      fite-283
      chi2=w(jm+lm)                                                     fite-284
      x(1)=w(jm+lm-1)                                                   fite-285
      if (nw(2).ne.0) go to 63                                          fite-286
      w(1)=dsqrt(dabs((w(9)-w(11))/((w(12)-w(13))/(w(9)-w(10))-(w(13)-w(fite-287
     114))/(w(10)-w(11)))))                                             fite-288
      w(2)=1.d0                                                         fite-289
      w(3)=1.d0                                                         fite-290
      go to 60                                                          fite-291
c end of search                                                         fite-292
   38 ke=0                                                              fite-293
      if (chi2.eq.0.d0.or.iz(2).lt.0) go to 64                          fite-294
      go to 44                                                          fite-295
c error code definition                                                 fite-296
   39 ke=ke+1                                                           fite-297
   40 ke=ke+1                                                           fite-298
   41 ke=ke+1                                                           fite-299
   42 ke=ke+1                                                           fite-300
   43 ke=ke+1                                                           fite-301
      ke=ke+1                                                           fite-302
c restore optimum values to x and f                                     fite-303
   44 do 45 i=1,m                                                       fite-304
   45 f(i)=w(jm+i)                                                      fite-305
      do 46 i=1,n                                                       fite-306
      x(i)=w(jm+m+i)                                                    fite-307
   46 w(i)=0.d0                                                         fite-308
      yy(3)=0.d0                                                        fite-309
      chi2=w(jm+lm)                                                     fite-310
      if (ke*(ke-3).ne.0.or.(ke.eq.3.and.((yy(3).eq.0.d0.and.iz(3).le.n)fite-311
     1))) go to 63                                                      fite-312
c computation of the errors of the variables - restore matrix g         fite-313
      kv=min0(k,iz(3))                                                  fite-314
      go to 13                                                          fite-315
c inverse of matrix d                                                   fite-316
   47 t=dsqrt(wja)                                                      fite-317
      j1=0                                                              fite-318
      do 49 i=1,n                                                       fite-319
      s=wa(j3+m+i)                                                      fite-320
      j2=js+i-lm+m                                                      fite-321
      do 48 l=1,kv                                                      fite-322
      j1=j1+1                                                           fite-323
   48 wa(j1)=t*(w(j2+l*lm)-s)/w(js+l*lm)                                fite-324
   49 continue                                                          fite-325
      call fit2(kv,n,wa,wa(jd+1),nw,ir,.false.)                         fite-326
      if (ir) 63 , 17 , 63                                              fite-327
c matrix g = a*inverse of d                                             fite-328
   50 do 54 l=1,m                                                       fite-329
      j1=l-m                                                            fite-330
      do 52 i=1,n                                                       fite-331
      i1=jd+(i*i-i)/2                                                   fite-332
      i2=1                                                              fite-333
      s=0.d0                                                            fite-334
      do 51 j=1,n                                                       fite-335
      i1=i1+i2                                                          fite-336
      if (j.ge.i) i2=j                                                  fite-337
   51 s=s+wa(i1)*wa(j1+j*m)                                             fite-338
   52 w(i)=s                                                            fite-339
      do 53 j=1,n                                                       fite-340
   53 wa(j1+j*m)=w(j)                                                   fite-341
   54 continue                                                          fite-342
c diagonal elements of g(t)*g                                           fite-343
      j1=0                                                              fite-344
      do 56 i=1,n                                                       fite-345
      s=0.d0                                                            fite-346
      do 55 l=1,m                                                       fite-347
      j1=j1+1                                                           fite-348
   55 s=s+wa(j1)*wa(j1)                                                 fite-349
   56 w(n+i)=dsqrt(s)                                                   fite-350
c standard errors and error correlations                                fite-351
      call fit2(m,n,wa,w(2*n+1),nw,ir,.false.)                          fite-352
      if (ir.ne.0) go to 63                                             fite-353
      do 57 i=1,n                                                       fite-354
      jdi=2*n+(i*i+i)/2                                                 fite-355
      w(i)=dsqrt(w(jdi))                                                fite-356
   57 w(n+i)=w(i)*w(n+i)                                                fite-357
      j1=2*n                                                            fite-358
      do 59 i=1,n                                                       fite-359
      do 58 j=1,i                                                       fite-360
      j1=j1+1                                                           fite-361
   58 w(j1)=w(j1)/(w(i)*w(j))                                           fite-362
   59 continue                                                          fite-363
c error renormalisation factor                                          fite-364
   60 s=0.d0                                                            fite-365
      do 61 i=1,m                                                       fite-366
   61 s=s+f(i)                                                          fite-367
      yy(3)=dsqrt(dabs(chi2-s*s/m)/max0(m-n-1,1))                       fite-368
      do 62 i=1,n                                                       fite-369
   62 w(i)=w(i)*yy(3)                                                   fite-370
   63 iz(4)=m-n-1                                                       fite-371
      if ((ke-5)*(ke-6).ne.0) go to 64                                  fite-372
      iz(3)=j-2                                                         fite-373
      iz(4)=mf-1                                                        fite-374
   64 if (ke.eq.1) iz(3)=iz(3)+1                                        fite-375
      return                                                            fite-376
      end                                                               fite-377
c 29/02/04                                                      ecis03  fit1-000
      subroutine fit1(ke,i,w)                                           fit1-001
c minimisation of a function f(x) of one variable x                     fit1-002
c calling sequence                                                      fit1-003
c    ke=0                                                               fit1-004
c    i(2)=maximum number of function evaluations                        fit1-005
c    w(1)=start value of x                                              fit1-006
c    w(3)=first step size                                               fit1-007
c    w(4)=absolute search accuracy                                      fit1-008
c    w(5)=relative search accuracy                                      fit1-009
c  1 w(2)=function value f(x) at x=w(1)                                 fit1-010
c    call fit1(ke,i,w)                                                  fit1-011
c    if(ke.eq.1) go to 1                                                fit1-012
c    xmin=w(1)                                                          fit1-013
c    fmin=w(2)                                                          fit1-014
c ke = error code: ke=0 no errors, ke=                                  fit1-015
c  2 maximum number of function evaluations                             fit1-016
c  3 rounding errors, probably because both w(4) and w(5) are too small fit1-017
c the working fields i and w have the length 3 and 11 respectively      fit1-018
c they contain all information for the continuation of the search       fit1-019
c therefore a search within another search can be done just changing    fit1-020
c the working fields                                                    fit1-021
c if 2 function values f1 and f2 are known for x = x1 and x2 respective fit1-022
c ly with x1 ne x2 enter the calling sequence after defining :          fit1-023
c ke = 1; i(1) = 3; w(6) = x1; w(7) = x2; w(9) = f1; w(10) = f2 and     fit1-024
c w(1) = users choice                                                   fit1-025
c working field variables:                                              fit1-026
c i(1): current number of function evaluations                          fit1-027
c i(2): maximum number of function evaluations                          fit1-028
c i(3): minimum pointer, the minimum function value is at w(7+i(3))     fit1-029
c w(1): current value of x                                              fit1-030
c w(2): user supplied function value                                    fit1-031
c w(3): first step size                                                 fit1-032
c w(4 and 5): search accuracies                                         fit1-033
c w(6, 7 and 8): x1, x2 and x3 with x1 < x2 < x3                        fit1-034
c w(9, 10 and 11): function values at x1, x2 and x3 respectively        fit1-035
c***********************************************************************fit1-036
      implicit real*8 (a-h,o-z)                                         fit1-037
      dimension i(3),w(11)                                              fit1-038
      if (ke.eq.1) go to 2                                              fit1-039
      ke=1                                                              fit1-040
      i(1)=1                                                            fit1-041
      i(3)=-1                                                           fit1-042
      w(6)=w(1)                                                         fit1-043
      w(9)=w(2)                                                         fit1-044
    1 w(1)=w(1)+w(3)                                                    fit1-045
      go to 11                                                          fit1-046
    2 if (i(1).gt.2) go to 3                                            fit1-047
      i(3)=0                                                            fit1-048
      w(7)=w(1)                                                         fit1-049
      w(10)=w(2)                                                        fit1-050
      if (w(2).le.w(9)) go to 1                                         fit1-051
      i(3)=-1                                                           fit1-052
      w(1)=w(6)-w(3)                                                    fit1-053
      go to 11                                                          fit1-054
    3 if (i(1).gt.3) go to 5                                            fit1-055
      w(8)=w(1)                                                         fit1-056
      w(11)=w(2)                                                        fit1-057
c ordering of the 3 first values of x: w(6) < w(7) < w(8)               fit1-058
      do 4 j=1,3                                                        fit1-059
      k=7-mod(j,2)                                                      fit1-060
      if (w(k).le.w(k+1)) go to 4                                       fit1-061
      w(1)=w(k)                                                         fit1-062
      w(k)=w(k+1)                                                       fit1-063
      w(k+1)=w(1)                                                       fit1-064
      k=k+3                                                             fit1-065
      w(1)=w(k)                                                         fit1-066
      w(k)=w(k+1)                                                       fit1-067
      w(k+1)=w(1)                                                       fit1-068
    4 continue                                                          fit1-069
      i(3)=0                                                            fit1-070
      if (w(9).lt.w(10).and.w(9).lt.w(11)) i(3)=-1                      fit1-071
      if (w(11).lt.w(10).and.w(11).lt.w(9)) i(3)=1                      fit1-072
      go to 9                                                           fit1-073
c sort in the new values of x and f                                     fit1-074
    5 if (i(3).eq.0) go to 6                                            fit1-075
      j=i(3)                                                            fit1-076
      w(7-j)=w(7)                                                       fit1-077
      w(10-j)=w(10)                                                     fit1-078
      if ((w(7+j)-w(1))*(w(1)-w(7)).gt.0.d0) go to 7                    fit1-079
      w(7)=w(7+j)                                                       fit1-080
      w(10)=w(10+j)                                                     fit1-081
      w(7+j)=w(1)                                                       fit1-082
      w(10+j)=w(2)                                                      fit1-083
      if (w(2).ge.w(10)) i(3)=0                                         fit1-084
      go to 9                                                           fit1-085
    6 j=-1                                                              fit1-086
      if (w(1).lt.w(7)) j=1                                             fit1-087
      if (w(2).gt.w(10)) go to 8                                        fit1-088
      w(7+j)=w(7)                                                       fit1-089
      w(10+j)=w(10)                                                     fit1-090
    7 w(7)=w(1)                                                         fit1-091
      w(10)=w(2)                                                        fit1-092
      i31=i(3)+10                                                       fit1-093
      if (w(2).le.w(i31)) i(3)=0                                        fit1-094
      go to 9                                                           fit1-095
    8 w(7-j)=w(1)                                                       fit1-096
      w(10-j)=w(2)                                                      fit1-097
    9 j=7+i(3)                                                          fit1-098
c error tests                                                           fit1-099
      if (w(6).eq.w(7).or.w(7).eq.w(8).or.(w(9).eq.w(10).and.w(10).eq.w(fit1-100
     111))) go to 14                                                    fit1-101
      if (i(1).ge.i(2)) go to 15                                        fit1-102
      if (i(3).eq.0) go to 10                                           fit1-103
c step size limitation                                                  fit1-104
      w(1)=w(j)+(2*i(3))*dabs(w(6)-w(8))                                fit1-105
      go to 11                                                          fit1-106
c prediction of the position of the minimum (parabolic approximation)   fit1-107
   10 w(1)=((w(9)-w(10))/(w(6)-w(7))-(w(10)-w(11))/(w(7)-w(8)))/(w(6)-w(fit1-108
     18))                                                               fit1-109
      w(1)=.5d0*(w(6)+w(8)+(w(11)-w(9))/(w(1)*(w(6)-w(8))))             fit1-110
c test of convergence                                                   fit1-111
      w(2)=dabs(w(1)-w(j))                                              fit1-112
      if (w(2).lt.dabs(w(4)).or.w(2).lt.dabs(w(5)*w(j))) go to 12       fit1-113
   11 i(1)=i(1)+1                                                       fit1-114
      return                                                            fit1-115
   12 ke=0                                                              fit1-116
   13 i37=i(3)+7                                                        fit1-117
      w(1)=w(i37)                                                       fit1-118
      i31=i(3)+10                                                       fit1-119
      w(2)=w(i31)                                                       fit1-120
      return                                                            fit1-121
   14 ke=ke+1                                                           fit1-122
   15 ke=ke+1                                                           fit1-123
      go to 13                                                          fit1-124
      end                                                               fit1-125
c 29/02/04                                                      ecis03  fit2-000
      subroutine fit2(m,n,a,d,ip,ir,llo)                                fit2-001
c if llo=.true. ex subroutine lilesq written by schweimer.              fit2-002
c  linear least squares problem ||b-a*d||=min(d)                        fit2-003
c  solved by householder transformations                                fit2-004
c input variables: m: number of rows of a and b                         fit2-005
c                  n: number of columns of a and rows of d              fit2-006
c                  a: m*n matrix followed by the vector b of m compo-   fit2-007
c                                  nents (destroyed)                    fit2-008
c output variables:d: vector of variables, the redundant variables are  fit2-009
c                    set to zero. the ||d||=min is not used because the fit2-010
c                    components of d are assumed to be not commensurablefit2-011
c                  ip: permutation vector of n components, it contains  fit2-012
c                    the column labels of matrix a ordered according    fit2-013
c                    their importance in reducing the euclidean norm    fit2-014
c                  a: the upper part contains the transformed input a   fit2-015
c                    a(2,1) contains the square of the euclidean norm   fit2-016
c                  ir: error code                                       fit2-017
c                    ir=0 no error                                      fit2-018
c                    ir=-1 all components of d are zero and may be      fit2-019
c                    redundant                                          fit2-020
c                    ir>0 the first ir components of ip contain the     fit2-021
c                    labels of the nonzero components of d, the remai-  fit2-022
c                    ning components of d are zero and may be redundant fit2-023
c  note: all arithmetic operations are performed in double precision,   fit2-024
c  an iterative improvement is impossible without saving a and b.       fit2-025
c  the round off error of ||b-a*d||**2 is approximately given by        fit2-026
c  ||b(initial)||**2 - ||b(transformed)||**2                            fit2-027
c                                                                       fit2-028
c if llo=.false. ex subroutine invata written by schweimer.             fit2-029
c  inversion of the product matrix a(transposed)*a                      fit2-030
c  the matrix a is reduced to an upper triangular matrix r by           fit2-031
c  householder transformations. the remaining computation is straight   fit2-032
c  forward.                                                             fit2-033
c input variables: n: number of columns of matrix a                     fit2-034
c                  m: number of rows of matrix a, m >= n > 0            fit2-035
c                  a: input matrix (destroyed)                          fit2-036
c output variables:  ir: error code                                     fit2-037
c                    ir=-1 rank of matrix a is zero                     fit2-038
c                    ir=0 no error, rank of matrix a is n               fit2-039
c                    ir>0 rank of matrix a is ir, the inverse of a(t)*a fit2-040
c                    is computed considering the ir columns of a indica-fit2-041
c                    ted by the first ir components of ip               fit2-042
c                  a: triangular matrix r, r=a(i,j) i<=j=1,n            fit2-043
c                  d: vector of length (n*(n+1))/2, it contains the     fit2-044
c                    upper triangular part of the inverse of a(t)*a     fit2-045
c                  ip: permutation vector of length n, its first ir     fit2-046
c                    components contain the labels of the useful        fit2-047
c                    columns of a, the last components contain the      fit2-048
c                    labels of the columns which are linear combinationsfit2-049
c                    of the first.                                      fit2-050
c***********************************************************************fit2-051
      implicit real*8 (a-h,o-z)                                         fit2-052
      logical llo                                                       fit2-053
      dimension a(m,n),d(n),ip(n)                                       fit2-054
      ir=0                                                              fit2-055
      n1=n                                                              fit2-056
      if (llo) n1=n+1                                                   fit2-057
      do 1 j=1,n                                                        fit2-058
    1 ip(j)=j                                                           fit2-059
c rotation loop                                                         fit2-060
      do 13 k=1,n                                                       fit2-061
c pivot element    column j which generates the largest new a(*,m) and  fit2-062
c and line i of the largest element of column j if llo=.true.           fit2-063
c column and line of largest element if llo=.false.                     fit2-064
      u=0.d0                                                            fit2-065
      do 7 j=k,n                                                        fit2-066
      c=0.d0                                                            fit2-067
      do 2 i=k,m                                                        fit2-068
      if (dabs(a(i,j)).le.dabs(c)) go to 2                              fit2-069
      l2=i                                                              fit2-070
      c=a(i,j)                                                          fit2-071
    2 continue                                                          fit2-072
      if (c.eq.0.d0) go to 7                                            fit2-073
      s=0.d0                                                            fit2-074
      if (llo) go to 4                                                  fit2-075
      if (dabs(c).lt.u) go to 7                                         fit2-076
      u=dabs(c)                                                         fit2-077
      do 3 i=k,m                                                        fit2-078
      v=a(i,j)/c                                                        fit2-079
    3 s=s+v*v                                                           fit2-080
      go to 6                                                           fit2-081
    4 t=0.d0                                                            fit2-082
      do 5 i=k,m                                                        fit2-083
      v=a(i,j)/c                                                        fit2-084
      s=s+v*v                                                           fit2-085
    5 t=t+v*a(i,n1)                                                     fit2-086
      if (u.ge.t*(t/s)) go to 7                                         fit2-087
      u=t*(t/s)                                                         fit2-088
    6 sig=c*dsqrt(s)                                                    fit2-089
      l=j                                                               fit2-090
      l1=l2                                                             fit2-091
    7 continue                                                          fit2-092
      if (u.eq.0.d0) go to 14                                           fit2-093
c permute columns of a(k)                                               fit2-094
      i=ip(l)                                                           fit2-095
      ip(l)=ip(k)                                                       fit2-096
      ip(k)=i                                                           fit2-097
      do 8 i=1,m                                                        fit2-098
      c=a(i,l)                                                          fit2-099
      a(i,l)=a(i,k)                                                     fit2-100
    8 a(i,k)=c                                                          fit2-101
c permute lines of a(k)                                                 fit2-102
      do 9 j=k,n1                                                       fit2-103
      c=a(k,j)                                                          fit2-104
      a(k,j)=a(l1,j)                                                    fit2-105
    9 a(l1,j)=c                                                         fit2-106
c rotation of the lower column fragment of a(k) and b(k)                fit2-107
      u=sig+a(k,k)                                                      fit2-108
      v=a(k,k)/sig                                                      fit2-109
      a(k,k)=-sig                                                       fit2-110
      l=k+1                                                             fit2-111
      if (l.gt.m) a(k,l)=-a(k,l)                                        fit2-112
      if (l.gt.n1.or.l.gt.m) go to 13                                   fit2-113
      do 12 j=l,n1                                                      fit2-114
      s=v*a(k,j)                                                        fit2-115
      do 10 i=l,m                                                       fit2-116
      t=a(i,k)/sig                                                      fit2-117
   10 s=s+t*a(i,j)                                                      fit2-118
      t=(a(k,j)+s)/u                                                    fit2-119
      a(k,j)=-s                                                         fit2-120
      do 11 i=l,m                                                       fit2-121
   11 a(i,j)=a(i,j)-t*a(i,k)                                            fit2-122
   12 continue                                                          fit2-123
   13 continue                                                          fit2-124
c end of rotation loop                                                  fit2-125
      k=n                                                               fit2-126
      go to 15                                                          fit2-127
   14 k=k-1                                                             fit2-128
      ir=k                                                              fit2-129
   15 if (llo) go to 22                                                 fit2-130
      if (k.eq.0) go to 29                                              fit2-131
c inverse of the triangular matrix r stored in d                        fit2-132
      do 18 j=1,k                                                       fit2-133
      d(j)=a(j,j)                                                       fit2-134
      a(j,j)=1.d0/d(j)                                                  fit2-135
      if (j.eq.1) go to 18                                              fit2-136
      i=j                                                               fit2-137
      do 17 l=2,j                                                       fit2-138
      i1=i                                                              fit2-139
      i=i-1                                                             fit2-140
      s=0.d0                                                            fit2-141
      do 16 l1=i1,j                                                     fit2-142
   16 s=s+a(i,l1)*a(j,l1)                                               fit2-143
   17 a(j,i)=-s/d(i)                                                    fit2-144
   18 continue                                                          fit2-145
c inverse of the product matrix                                         fit2-146
      do 21 j=1,k                                                       fit2-147
      do 20 i=1,j                                                       fit2-148
      l=max0(ip(j),ip(i))                                               fit2-149
      ij=ip(i)+ip(j)+(l*(l-3))/2                                        fit2-150
      s=0.d0                                                            fit2-151
      do 19 l1=j,k                                                      fit2-152
   19 s=s+a(l1,i)*a(l1,j)                                               fit2-153
   20 d(ij)=s                                                           fit2-154
   21 continue                                                          fit2-155
      go to 30                                                          fit2-156
c square of the euclidean norm                                          fit2-157
   22 s=0.d0                                                            fit2-158
      l=k+1                                                             fit2-159
      if (k.eq.m) go to 24                                              fit2-160
      do 23 i=l,m                                                       fit2-161
   23 s=s+a(i,n1)*a(i,n1)                                               fit2-162
   24 a(2,1)=s                                                          fit2-163
      if (k.eq.n) go to 26                                              fit2-164
c components of d which do not reduce the euclidean norm                fit2-165
      do 25 j=l,n                                                       fit2-166
      ij=ip(j)                                                          fit2-167
   25 d(ij)=0.d0                                                        fit2-168
      if (k.eq.0) go to 29                                              fit2-169
c computation of d                                                      fit2-170
   26 ij=ip(k)                                                          fit2-171
      d(ij)=a(k,n1)/a(k,k)                                              fit2-172
      if (k.eq.1) go to 30                                              fit2-173
      do 28 j=2,k                                                       fit2-174
      l=k+2-j                                                           fit2-175
      s=a(l-1,n1)                                                       fit2-176
      do 27 i=l,k                                                       fit2-177
      ij=ip(i)                                                          fit2-178
   27 s=s-a(l-1,i)*d(ij)                                                fit2-179
      ij=ip(l-1)                                                        fit2-180
   28 d(ij)=s/a(l-1,l-1)                                                fit2-181
      go to 30                                                          fit2-182
c error code                                                            fit2-183
   29 ir=-1                                                             fit2-184
   30 return                                                            fit2-185
      end                                                               fit2-186
